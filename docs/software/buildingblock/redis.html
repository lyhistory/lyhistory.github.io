<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机基础教程</title>
    <meta name="description" content="软件开发教程，白帽黑客入门教程，区块链入门教程，物联网，大数据">
    
    
    <link rel="preload" href="/docs/assets/css/0.styles.89d6372f.css" as="style"><link rel="preload" href="/docs/assets/js/app.ed9871d1.js" as="script"><link rel="preload" href="/docs/assets/js/2.dc5756d7.js" as="script"><link rel="preload" href="/docs/assets/js/64.d847da89.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.9cded2fc.js"><link rel="prefetch" href="/docs/assets/js/100.8755e6f2.js"><link rel="prefetch" href="/docs/assets/js/101.4fdb227c.js"><link rel="prefetch" href="/docs/assets/js/102.7bb622b1.js"><link rel="prefetch" href="/docs/assets/js/103.59bab394.js"><link rel="prefetch" href="/docs/assets/js/104.b0745e5c.js"><link rel="prefetch" href="/docs/assets/js/105.dc6b1087.js"><link rel="prefetch" href="/docs/assets/js/106.aacca940.js"><link rel="prefetch" href="/docs/assets/js/107.5e5b857e.js"><link rel="prefetch" href="/docs/assets/js/108.f3c958da.js"><link rel="prefetch" href="/docs/assets/js/109.766f4524.js"><link rel="prefetch" href="/docs/assets/js/11.5a3135de.js"><link rel="prefetch" href="/docs/assets/js/110.cf176af0.js"><link rel="prefetch" href="/docs/assets/js/111.e6a687a1.js"><link rel="prefetch" href="/docs/assets/js/112.b31dca5c.js"><link rel="prefetch" href="/docs/assets/js/113.71ee64da.js"><link rel="prefetch" href="/docs/assets/js/114.0b3ca1e0.js"><link rel="prefetch" href="/docs/assets/js/115.c926b6b1.js"><link rel="prefetch" href="/docs/assets/js/116.30a9f01b.js"><link rel="prefetch" href="/docs/assets/js/117.9a775b8f.js"><link rel="prefetch" href="/docs/assets/js/118.028070bb.js"><link rel="prefetch" href="/docs/assets/js/119.fdf80099.js"><link rel="prefetch" href="/docs/assets/js/12.781b8cb9.js"><link rel="prefetch" href="/docs/assets/js/120.0b71e5a2.js"><link rel="prefetch" href="/docs/assets/js/121.ba8698a1.js"><link rel="prefetch" href="/docs/assets/js/122.91e7c3fa.js"><link rel="prefetch" href="/docs/assets/js/123.989331a8.js"><link rel="prefetch" href="/docs/assets/js/124.4caaace3.js"><link rel="prefetch" href="/docs/assets/js/125.73ca2ef9.js"><link rel="prefetch" href="/docs/assets/js/126.ca967af4.js"><link rel="prefetch" href="/docs/assets/js/127.741efd3d.js"><link rel="prefetch" href="/docs/assets/js/128.ba90db07.js"><link rel="prefetch" href="/docs/assets/js/129.b8cb3032.js"><link rel="prefetch" href="/docs/assets/js/13.365b99ce.js"><link rel="prefetch" href="/docs/assets/js/130.3f509ba0.js"><link rel="prefetch" href="/docs/assets/js/131.59306c20.js"><link rel="prefetch" href="/docs/assets/js/132.4b27a317.js"><link rel="prefetch" href="/docs/assets/js/133.36fd9a5a.js"><link rel="prefetch" href="/docs/assets/js/134.c3fe96fd.js"><link rel="prefetch" href="/docs/assets/js/135.3f88a54d.js"><link rel="prefetch" href="/docs/assets/js/136.3d4f86d5.js"><link rel="prefetch" href="/docs/assets/js/137.ce90989f.js"><link rel="prefetch" href="/docs/assets/js/138.c19000f0.js"><link rel="prefetch" href="/docs/assets/js/139.fce5d77f.js"><link rel="prefetch" href="/docs/assets/js/14.e9ffbbb6.js"><link rel="prefetch" href="/docs/assets/js/140.8143650b.js"><link rel="prefetch" href="/docs/assets/js/141.8a4079d5.js"><link rel="prefetch" href="/docs/assets/js/15.32932bc7.js"><link rel="prefetch" href="/docs/assets/js/16.7af51aef.js"><link rel="prefetch" href="/docs/assets/js/17.743f8ac5.js"><link rel="prefetch" href="/docs/assets/js/18.a3d4a221.js"><link rel="prefetch" href="/docs/assets/js/19.dc5ce867.js"><link rel="prefetch" href="/docs/assets/js/20.30de33f0.js"><link rel="prefetch" href="/docs/assets/js/21.d10bf049.js"><link rel="prefetch" href="/docs/assets/js/22.250ada0f.js"><link rel="prefetch" href="/docs/assets/js/23.67afe95e.js"><link rel="prefetch" href="/docs/assets/js/24.b66c1821.js"><link rel="prefetch" href="/docs/assets/js/25.e5420132.js"><link rel="prefetch" href="/docs/assets/js/26.070f37ba.js"><link rel="prefetch" href="/docs/assets/js/27.e206eb48.js"><link rel="prefetch" href="/docs/assets/js/28.16227b6f.js"><link rel="prefetch" href="/docs/assets/js/29.ae7df93c.js"><link rel="prefetch" href="/docs/assets/js/3.2f808942.js"><link rel="prefetch" href="/docs/assets/js/30.969f8035.js"><link rel="prefetch" href="/docs/assets/js/31.6fef88af.js"><link rel="prefetch" href="/docs/assets/js/32.020f2deb.js"><link rel="prefetch" href="/docs/assets/js/33.886f83dc.js"><link rel="prefetch" href="/docs/assets/js/34.6926f788.js"><link rel="prefetch" href="/docs/assets/js/35.6ef92582.js"><link rel="prefetch" href="/docs/assets/js/36.b35299f0.js"><link rel="prefetch" href="/docs/assets/js/37.37acb9ff.js"><link rel="prefetch" href="/docs/assets/js/38.0cb24e57.js"><link rel="prefetch" href="/docs/assets/js/39.1dfc9a7e.js"><link rel="prefetch" href="/docs/assets/js/4.7d1e56e0.js"><link rel="prefetch" href="/docs/assets/js/40.b64c700e.js"><link rel="prefetch" href="/docs/assets/js/41.8f20653f.js"><link rel="prefetch" href="/docs/assets/js/42.02d4dd31.js"><link rel="prefetch" href="/docs/assets/js/43.17db0b5b.js"><link rel="prefetch" href="/docs/assets/js/44.5270f830.js"><link rel="prefetch" href="/docs/assets/js/45.5d509736.js"><link rel="prefetch" href="/docs/assets/js/46.577da61d.js"><link rel="prefetch" href="/docs/assets/js/47.0c499be0.js"><link rel="prefetch" href="/docs/assets/js/48.f1f770c9.js"><link rel="prefetch" href="/docs/assets/js/49.f2f4c3a1.js"><link rel="prefetch" href="/docs/assets/js/5.8df5cec4.js"><link rel="prefetch" href="/docs/assets/js/50.2e63384d.js"><link rel="prefetch" href="/docs/assets/js/51.9bccbc53.js"><link rel="prefetch" href="/docs/assets/js/52.c24a7ca5.js"><link rel="prefetch" href="/docs/assets/js/53.11592d1d.js"><link rel="prefetch" href="/docs/assets/js/54.82819f46.js"><link rel="prefetch" href="/docs/assets/js/55.cc58bfc6.js"><link rel="prefetch" href="/docs/assets/js/56.23544eac.js"><link rel="prefetch" href="/docs/assets/js/57.d38e4b7c.js"><link rel="prefetch" href="/docs/assets/js/58.37b6a09c.js"><link rel="prefetch" href="/docs/assets/js/59.585cecb2.js"><link rel="prefetch" href="/docs/assets/js/6.b7868a34.js"><link rel="prefetch" href="/docs/assets/js/60.0909786e.js"><link rel="prefetch" href="/docs/assets/js/61.0f36c0a5.js"><link rel="prefetch" href="/docs/assets/js/62.68d9b711.js"><link rel="prefetch" href="/docs/assets/js/63.3fe73ce5.js"><link rel="prefetch" href="/docs/assets/js/65.5bc60c0d.js"><link rel="prefetch" href="/docs/assets/js/66.3abc9dcb.js"><link rel="prefetch" href="/docs/assets/js/67.5aea903a.js"><link rel="prefetch" href="/docs/assets/js/68.e9617c70.js"><link rel="prefetch" href="/docs/assets/js/69.064fe922.js"><link rel="prefetch" href="/docs/assets/js/7.0ad16c50.js"><link rel="prefetch" href="/docs/assets/js/70.ce3b45a9.js"><link rel="prefetch" href="/docs/assets/js/71.f9f75537.js"><link rel="prefetch" href="/docs/assets/js/72.ed2a7eee.js"><link rel="prefetch" href="/docs/assets/js/73.a8a717f3.js"><link rel="prefetch" href="/docs/assets/js/74.19ed7ae8.js"><link rel="prefetch" href="/docs/assets/js/75.6d3769b4.js"><link rel="prefetch" href="/docs/assets/js/76.5648cc6b.js"><link rel="prefetch" href="/docs/assets/js/77.66113c0b.js"><link rel="prefetch" href="/docs/assets/js/78.7a782bdd.js"><link rel="prefetch" href="/docs/assets/js/79.2b810535.js"><link rel="prefetch" href="/docs/assets/js/8.630ab12c.js"><link rel="prefetch" href="/docs/assets/js/80.6e6fa0bc.js"><link rel="prefetch" href="/docs/assets/js/81.99dd935d.js"><link rel="prefetch" href="/docs/assets/js/82.eac966f3.js"><link rel="prefetch" href="/docs/assets/js/83.f035111c.js"><link rel="prefetch" href="/docs/assets/js/84.4ea75ba4.js"><link rel="prefetch" href="/docs/assets/js/85.7eba901c.js"><link rel="prefetch" href="/docs/assets/js/86.6f2f8313.js"><link rel="prefetch" href="/docs/assets/js/87.cf24e44a.js"><link rel="prefetch" href="/docs/assets/js/88.ddf1bda5.js"><link rel="prefetch" href="/docs/assets/js/89.e93a28ef.js"><link rel="prefetch" href="/docs/assets/js/9.ba1a08a8.js"><link rel="prefetch" href="/docs/assets/js/90.3f873ebe.js"><link rel="prefetch" href="/docs/assets/js/91.0f2acd1c.js"><link rel="prefetch" href="/docs/assets/js/92.79b6de73.js"><link rel="prefetch" href="/docs/assets/js/93.d0d4233b.js"><link rel="prefetch" href="/docs/assets/js/94.c33f6583.js"><link rel="prefetch" href="/docs/assets/js/95.36da6d5c.js"><link rel="prefetch" href="/docs/assets/js/96.1f01a48a.js"><link rel="prefetch" href="/docs/assets/js/97.8224ff63.js"><link rel="prefetch" href="/docs/assets/js/98.91399f5c.js"><link rel="prefetch" href="/docs/assets/js/99.60dc7ff3.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.89d6372f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">计算机基础教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">机器指令</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">软件基础</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">白帽黑客</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">区块链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">机器指令</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">软件基础</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">白帽黑客</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">区块链</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/software/buildingblock/redis.html#install" class="sidebar-link">Install</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/redis.html#single-node" class="sidebar-link">Single node</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/redis.html#cluster-mode" class="sidebar-link">Cluster Mode</a></li></ul></li><li><a href="/docs/software/buildingblock/redis.html#集群管理" class="sidebar-link">集群管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/redis.html#basic-cmd-gui" class="sidebar-link">BASIC CMD&amp;GUI</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/redis.html#理论基础-theory" class="sidebar-link">理论基础 Theory</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/redis.html#自动方式管理" class="sidebar-link">自动方式管理</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/redis.html#手动方式管理-manual-way-not-recommend" class="sidebar-link">手动方式管理 Manual way (not recommend)</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/redis.html#overall-admin" class="sidebar-link">Overall Admin</a></li></ul></li><li><a href="/docs/software/buildingblock/redis.html#系统集成-integration" class="sidebar-link">系统集成 Integration</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/buildingblock/redis.html#troubleshooting" class="sidebar-link">Troubleshooting</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/buildingblock/redis.html#数据倾斜" class="sidebar-link">数据倾斜</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="/docs/software">回目录</a>  《分布式缓存redis》</p> <h2 id="install"><a href="#install" class="header-anchor">#</a> Install</h2> <p>https://redis.io/topics/quickstart
wget http://download.redis.io/redis-stable.tar.gz
tar xvzf redis-stable.tar.gz
cd redis-stable
make
make test
sudo cp src/redis-server /usr/local/bin/
sudo cp src/redis-cli /usr/local/bin/</p> <blockquote><p>Installing Redis more properly
Running Redis from the command line is fine just to hack a bit with it or for development. However at some point you'll have some actual application to run on a real server. For this kind of usage you have two different choices:</p> <ul><li>Run Redis using screen.</li> <li>Install Redis in your Linux box in a proper way using an init script, so that after a restart everything will start again properly.
A proper install using an init script is strongly suggested. The following instructions can be used to perform a proper installation using the init script shipped with Redis 2.4 in a Debian or Ubuntu based distribution.</li></ul> <p>We assume you already copied redis-server and redis-cli executables under /usr/local/bin.</p> <ul><li>Create a directory in which to store your Redis config files and your data:
sudo mkdir /etc/redis
sudo mkdir /var/redis</li> <li>Copy the init script that you'll find in the Redis distribution under the utils directory into /etc/init.d. We suggest calling it with the name of the port where you are running this instance of Redis. For example:
sudo cp utils/redis_init_script /etc/init.d/redis_6379</li> <li>Edit the init script.
sudo vi /etc/init.d/redis_6379
...
https://redis.io/topics/quickstart</li></ul></blockquote> <h3 id="single-node"><a href="#single-node" class="header-anchor">#</a> Single node</h3> <p>redis-server
Or start with config
redis-server redis.conf</p> <h3 id="cluster-mode"><a href="#cluster-mode" class="header-anchor">#</a> Cluster Mode</h3> <p>Redis cluster tutorial https://redis.io/topics/cluster-tutorial
Config:</p> <div class="language- extra-class"><pre class="language-text"><code>daemonize yes  #后台运行模式
logfile “redis_6379_log”
pidfile /home/web/redis/var/run/redis_6379.pid  #修改pid文件
dir /home/web/redis/data/ #指定本地数据库存放目录
port 6379  #端口
dbfilename dump_6379.rdb #数据文件
appendfilename &quot;appendonly_6379.aof&quot;
cluster-enabled yes #打开注释，启动cluster模式
cluster-config-file nodes-6379.conf #打开注释，启动cluster模式
# Cluster node timeout is the amount of milliseconds a node must be unreachable
# for it to be considered in failure state.
# Most other internal time limits are multiple of the node timeout.
cluster-node-timeout 15000 #打开注释，启动cluster模式
</code></pre></div><p>参考最低配置：https://redis.io/topics/cluster-tutorial
<em>Note that the minimal cluster that works as expected requires to contain at least three master nodes.</em></p> <p>redis-server conf/redis6379.conf
redis-server conf/redis6380.conf
redis-server conf/redis6381.conf
redis-cli --cluster create <HOSTIP1>:6379 <HOSTIP1>:6380 <HOSTIP1>:6381 <br> <HOSTIP2>:6379 <HOSTIP2>:6380 <HOSTIP2>:6381 <br> <HOSTIP3>:6379 <HOSTIP3>:6380 <HOSTIP3>:6381 <br>
--cluster-replicas 2</HOSTIP3></HOSTIP3></HOSTIP3></HOSTIP2></HOSTIP2></HOSTIP2></HOSTIP1></HOSTIP1></HOSTIP1></p> <p>控制脚本：</p> <div class="language- extra-class"><pre class="language-text"><code>REDIS_HOME=/opt/redis-5.0.5
pushd ${REDIS_HOME} &amp;&gt;/dev/null

while [ &quot;${1:0:1}&quot; == &quot;-&quot; ]; do
  case $1 in
    --start)
      echo &quot;Starting redis nodes...&quot;
      redis-server conf/redis6379.conf
      redis-server conf/redis6380.conf
      redis-server conf/redis6381.conf
      ;;
    --kill)
      echo &quot;Stopping redis nodes...&quot;
      redis-cli -p 6379 shutdown
      redis-cli -p 6380 shutdown
      redis-cli -p 6381 shutdown
          ;;
    *)
      echo &quot;usage: --start|--kill&quot;
      exit 1
      ;;
  esac
  shift
done

</code></pre></div><h2 id="集群管理"><a href="#集群管理" class="header-anchor">#</a> 集群管理</h2> <h3 id="basic-cmd-gui"><a href="#basic-cmd-gui" class="header-anchor">#</a> BASIC CMD&amp;GUI</h3> <p>https://redis.io/topics/rediscli</p> <div class="language- extra-class"><pre class="language-text"><code>redis-cli --cluster help
redis-cli -c -h &lt;HOSTIP&gt; -p &lt;PORT&gt;
	cluster help
	cluster info
	cluster nodes
	cluster slots
	replicate NODEID
	cluster failover (on slave node)
		keys * (Check empty)
		flushdb/flushall (on master nodes)
		cluster reset(soft/hard, chang slave to an empty ‘standalone’ master)
		Slaveof no one (change slave to master, cannot execute in cluster mode)
	Slave host port (change slave to replicate another master, cannot execute in cluster mode)
	
redis-cli --cluster check &lt;HOSTIP&gt;:&lt;PORT&gt;

redis-cli --cluster fix &lt;HOSTIP&gt;:&lt;PORT&gt;
redis-cli -h &lt;HOSTIP&gt; -p &lt;PORT&gt; cluster meet &lt;TARGETHOSTIP&gt; &lt;TARGETPORT&gt;
redis-cli cluster forget &lt;NODEID&gt; (cannot perform on itself or it’s slave)
redis-cli --cluster del-node &lt;HOSTIP&gt;:&lt;PORT&gt; &lt;NODEID&gt;
#add-node默认是empty master，也可以加参数指定为slave ()
redis-cli --cluster add-node &lt;HOSTIP&gt;:&lt;PORT&gt; &lt;ANOTHER HOSTIP&gt;:&lt;PORT&gt; --cluster-slave --cluster-master-id &lt;NODEID&gt;

redis-cli -p 7002 shutdown
redis-cli -p 7002 debug segfault

redis-cli --cluster reshard &lt;ANYHOSTIP&gt;:&lt;ANYPORT&gt; --cluster-yes
redis-cli --cluster rebalance --cluster-threshold 1 &lt;ANYHOSTIP&gt;:&lt;ANYPORT&gt;

More:
Database
https://stackoverflow.com/questions/50534492/redis-how-to-get-current-database-name
https://redis.io/commands/client-list

client list
redis-cli INFO|grep db
redis-cli INFO|grep db|wc -l
redis-cli INFO keyspace

redis implement stored procedure 
https://redis.io/commands/eval

</code></pre></div><p>** GUI:
use colon as separator https://redisdesktop.com/
Dbeaver support nosql but only for enterprise edition
Optionally we can choose fastoredis https://fastoredis.com/anonim_users_downloads</p> <h3 id="理论基础-theory"><a href="#理论基础-theory" class="header-anchor">#</a> 理论基础 Theory</h3> <p>学习redis源码过程笔记、问题记录，通过代码阅读熟悉分布式NOSQL数据库redis cluster集群功能、主从复制，节点扩容、槽位迁移、failover故障切换、一致性选举完整分析，对理解redis源码很有帮助  https://github.com/daniel416/Reading-and-comprehense-redis/</p> <p>https://redis.io/topics/cluster-spec</p> <p>An introduction to Redis data types and abstractions https://redis.io/topics/data-types-intro</p> <p>**TCP PORTS:
Every Redis Cluster node requires two TCP connections open. The normal Redis TCP port used to serve clients, for example 6379, plus the port obtained by adding 10000 to the data port, so 16379 in the example.</p> <p>**DATA SHARDING:
16384 slots, hash slot ,why ? https://cloud.tencent.com/developer/article/1042654
16384这个数字也不是作者随意指定的，Redis集群内部使用位图（bit map）来标志一个slot是否被占用，为了减少集群之间信息交换的大小，信息的大小被固定为2048字节
2048 bytes = 2^11 * 8 bit= 2^14 bit= 16384
14 out of 16 CRC16 output bits are used (this is why there is a modulo 16384 operation in the formula above).</p> <p>Hash tag and multiple key operations
this{foo}key and another{foo}key are guaranteed to be in the same hash slot, and can be used together in a command with multiple keys as arguments
redis集群不支持模糊匹配partial match，想要模糊匹配只能对一个个server或database操作，不可以整体cluster操作，不过hash tag可以潜在解决这个问题</p> <p>**ConfigEpoch and current epoch
This mechanism in Redis Cluster is called last failover wins.
When a slave fails over its master, it obtains a configuration epoch which is guaranteed to be greater than the one of its master (and more generally greater than any other configuration epoch generated previously). For example node B, which is a slave of A, may failover B with configuration epoch of 4. It will start to send heartbeat packets (the first time mass-broadcasting cluster-wide) and because of the following second rule, receivers will update their hash slot tables</p> <p>The same happens during reshardings. When a node importing a hash slot completes the import operation, its configuration epoch is incremented to make sure the change will be propagated throughout the cluster.</p> <blockquote><p>Practical example of configuration epoch usefulness during partitions
This section illustrates how the epoch concept is used to make the slave promotion process more resistant to partitions.</p></blockquote> <blockquote><ul><li>A master is no longer reachable indefinitely. The master has three slaves A, B, C.</li> <li>Slave A wins the election and is promoted to master.</li> <li>A network partition makes A not available for the majority of the cluster.</li> <li>Slave B wins the election and is promoted as master.</li> <li>A partition makes B not available for the majority of the cluster.</li> <li>The previous partition is fixed, and A is available again.
At this point B is down and A is available again with a role of master (actually UPDATE messages would reconfigure it promptly, but here we assume all UPDATE messages were lost). At the same time, slave C will try to get elected in order to fail over B. This is what happens:</li></ul></blockquote> <blockquote><p>1.C will try to get elected and will succeed, since for the majority of masters its master is actually down. It will obtain a new incremental configEpoch.
2.A will not be able to claim to be the master for its hash slots, because the other nodes already have the same hash slots associated with a higher configuration epoch (the one of B) compared to the one published by A.
3.So, all the nodes will upgrade their table to assign the hash slots to C, and the cluster will continue its operations.
https://redis.io/topics/cluster-spec</p></blockquote> <p>**CONSISTENCY GUARANTEE:
Redis Cluster is not able to guarantee strong consistency. In practical terms this means that under certain conditions it is possible that Redis Cluster will lose writes that were acknowledged by the system to the client.
Tradeoff between Synchronous write and Performance</p> <p>Redis Sentinel vs Redis Cluster:
https://redislabs.com/redis-features/high-availability</p> <h3 id="自动方式管理"><a href="#自动方式管理" class="header-anchor">#</a> 自动方式管理</h3> <p>1.Replicas migration</p> <blockquote><h1 id="cluster-replicas-are-able-to-migrate-to-orphaned-masters-that-are-masters"><a href="#cluster-replicas-are-able-to-migrate-to-orphaned-masters-that-are-masters" class="header-anchor">#</a> Cluster replicas are able to migrate to orphaned masters, that are masters</h1> <h1 id="that-are-left-without-working-replicas-this-improves-the-cluster-ability"><a href="#that-are-left-without-working-replicas-this-improves-the-cluster-ability" class="header-anchor">#</a> that are left without working replicas. This improves the cluster ability</h1> <h1 id="to-resist-to-failures-as-otherwise-an-orphaned-master-can-t-be-failed-over"><a href="#to-resist-to-failures-as-otherwise-an-orphaned-master-can-t-be-failed-over" class="header-anchor">#</a> to resist to failures as otherwise an orphaned master can't be failed over</h1> <h1 id="in-case-of-failure-if-it-has-no-working-replicas"><a href="#in-case-of-failure-if-it-has-no-working-replicas" class="header-anchor">#</a> in case of failure if it has no working replicas.</h1> <h1 id=""><a href="#" class="header-anchor">#</a></h1> <h1 id="replicas-migrate-to-orphaned-masters-only-if-there-are-still-at-least-a"><a href="#replicas-migrate-to-orphaned-masters-only-if-there-are-still-at-least-a" class="header-anchor">#</a> Replicas migrate to orphaned masters only if there are still at least a</h1> <h1 id="given-number-of-other-working-replicas-for-their-old-master-this-number"><a href="#given-number-of-other-working-replicas-for-their-old-master-this-number" class="header-anchor">#</a> given number of other working replicas for their old master. This number</h1> <h1 id="is-the-migration-barrier-a-migration-barrier-of-1-means-that-a-replica"><a href="#is-the-migration-barrier-a-migration-barrier-of-1-means-that-a-replica" class="header-anchor">#</a> is the &quot;migration barrier&quot;. A migration barrier of 1 means that a replica</h1> <h1 id="will-migrate-only-if-there-is-at-least-1-other-working-replica-for-its-master"><a href="#will-migrate-only-if-there-is-at-least-1-other-working-replica-for-its-master" class="header-anchor">#</a> will migrate only if there is at least 1 other working replica for its master</h1> <h1 id="and-so-forth-it-usually-reflects-the-number-of-replicas-you-want-for-every"><a href="#and-so-forth-it-usually-reflects-the-number-of-replicas-you-want-for-every" class="header-anchor">#</a> and so forth. It usually reflects the number of replicas you want for every</h1> <h1 id="master-in-your-cluster"><a href="#master-in-your-cluster" class="header-anchor">#</a> master in your cluster.</h1> <h1 id="-2"><a href="#-2" class="header-anchor">#</a></h1> <h1 id="default-is-1-replicas-migrate-only-if-their-masters-remain-with-at-least"><a href="#default-is-1-replicas-migrate-only-if-their-masters-remain-with-at-least" class="header-anchor">#</a> Default is 1 (replicas migrate only if their masters remain with at least</h1> <h1 id="one-replica-to-disable-migration-just-set-it-to-a-very-large-value"><a href="#one-replica-to-disable-migration-just-set-it-to-a-very-large-value" class="header-anchor">#</a> one replica). To disable migration just set it to a very large value.</h1> <h1 id="a-value-of-0-can-be-set-but-is-useful-only-for-debugging-and-dangerous"><a href="#a-value-of-0-can-be-set-but-is-useful-only-for-debugging-and-dangerous" class="header-anchor">#</a> A value of 0 can be set but is useful only for debugging and dangerous</h1> <h1 id="in-production"><a href="#in-production" class="header-anchor">#</a> in production.</h1> <h1 id="-3"><a href="#-3" class="header-anchor">#</a></h1> <h1 id="cluster-migration-barrier-1"><a href="#cluster-migration-barrier-1" class="header-anchor">#</a> cluster-migration-barrier 1</h1></blockquote> <p>2.consider use failover whenever make changes to master nodes</p> <ol><li>Remove master node (one option is reshard the data to the other master nodes and then remove, An alternative to remove a master node is to perform a manual failover of it over one of its slaves and remove the node after it turned into a slave of the new master.)</li> <li>Before shutdown</li> <li>Upgrade master node (failover to its slave node first before upgrading, upgrade when it becomes a slave node)</li></ol> <p>Use failover rather than manual allocate replica using “REPLICATE <NODEID>”</NODEID></p> <blockquote><p>1.The replica tells the master to stop processing queries from clients.
2.The master replies to the replica with the current replication offset.
3.The replica waits for the replication offset to match on its side, to make sure it processed all the data from the master before it continues.
4.The replica starts a failover, obtains a new configuration epoch from the majority of the masters, and broadcasts the new configuration.
5.The old master receives the configuration update: unblocks its clients and starts replying with redirection messages so that they'll continue the chat with the new master.
https://redis.io/commands/cluster-failover</p></blockquote> <p>3.migration between clusters
--cluster import</p> <h3 id="手动方式管理-manual-way-not-recommend"><a href="#手动方式管理-manual-way-not-recommend" class="header-anchor">#</a> 手动方式管理 Manual way (not recommend)</h3> <p>如果主从都是在集群模式下（cluster-enable=yes），那么是无法使用非集群模式的命令，比如slaveof/replicaof
** 1.del-node/add-node
del-node如果是slave十分不推荐，因为启动时依然会记得其他节点，虽然可以forget大部分节点，但是无法forget它的master，所以再add-node会有问题，所以此时只能采用meet
Del-node如果是master，首先要将master做reshard转移到其他master nodes，然后将其对应的slave nodes全部replicate其他的master nodes，以防重启master后，slave nodes仍然记得该master node</p> <p>redis-cli --cluster del-node <HOSTIP>:<PORT><NODEID>
Redis-server conf/redis6379.conf
add-node默认是master，也可以加参数指定为slave
redis-cli --cluster add-node <NEW HOSTIP="">:<PORT><ANY EXIST="" HOSTIP="">:<PORT> --cluster-slave --cluster-master-id</PORT></ANY></PORT></NEW></NODEID></PORT></HOSTIP></p> <p>** 2.slaveof/replicaof注意再cluster集群模式下，是不可以手动分配的，可以更改slave配置，cluster-enabled=no然后再尝试
Slaveof no one (change slave to master)
Slave host port (change slave to replicate another master)</p> <p>** 3.reset and meet
After reset, node become a standalone master node, and then execute meet
$redis-cli -p 6379
127.0.0.1:6379&gt; flushall
127.0.0.1:6379&gt; cluster reset
127.0.0.1:6379&gt; exit
redis-cli -h <HOSTIP> -p <PORT> cluster meet <TARGETHOSTIP><TARGETPORT></TARGETPORT></TARGETHOSTIP></PORT></HOSTIP></p> <p>** 4. Final step: reshard or rebalance
redis-cli --cluster reshard <HOSTIP>:<PORT> --cluster-yes
redis-cli --cluster rebalance --cluster-threshold 1 <HOSTIP>:<PORT></PORT></HOSTIP></PORT></HOSTIP></p> <p>** 5. allocate slave for master
cluster replicate <NODEID></NODEID></p> <p>the other failed attempt:
~~
redis-cli --cluster del-node <HOSTIP>:<PORT><NODEID>
redis-cli cluster forget <NODEID>
redis-cli --cluster add-node <HOSTIP>:<PORT><ANY EXIST="" HOSTIP="">:<PORT> --cluster-slave --cluster-master-id <MASTER NODEID="">
https://www.jianshu.com/p/ff173ae6e478
Failed because cannot forget itself and it’s master!
~~</MASTER></PORT></ANY></PORT></HOSTIP></NODEID></NODEID></PORT></HOSTIP></p> <h3 id="overall-admin"><a href="#overall-admin" class="header-anchor">#</a> Overall Admin</h3> <p>Read https://redis.io/topics/admin
http://antirez.com/news/96</p> <blockquote><p>Securing Redis
1.Make sure the port Redis uses to listen for connections (by default 6379 and additionally 16379 if you run Redis in cluster mode, plus 26379 for Sentinel) is firewalled, so that it is not possible to contact Redis from the outside world.
2.Use a configuration file where the bind directive is set in order to guarantee that Redis listens on only the network interfaces you are using. For example only the loopback interface (127.0.0.1) if you are accessing Redis just locally from the same computer, and so forth.
3.Use the requirepass option in order to add an additional layer of security so that clients will require to authenticate using the AUTH command.
4.Use spiped or another SSL tunneling software in order to encrypt traffic between Redis servers and Redis clients if your environment requires encryption.</p></blockquote> <blockquote><p>Disabling of specific commands
It is possible to disable commands in Redis or to rename them into an unguessable name, so that normal clients are limited to a specified set of commands.
For instance, a virtualized server provider may offer a managed Redis instance service. In this context, normal users should probably not be able to call the Redis CONFIG command to alter the configuration of the instance, but the systems that provide and remove instances should be able to do so.
In this case, it is possible to either rename or completely shadow commands from the command table. This feature is available as a statement that can be used inside the redis.conf configuration file. For example:
rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52
In the above example, the CONFIG command was renamed into an unguessable name. It is also possible to completely disable it (or any other command) by renaming it to the empty string, like in the following example:
rename-command CONFIG &quot;&quot;
https://redis.io/topics/security</p></blockquote> <p>**Upgrade
If you are using Redis Sentinel or Redis Cluster, the simplest way in order to upgrade to newer versions, is to upgrade a slave after the other, then perform a manual fail-over in order to promote one of the upgraded replicas as master, and finally promote the last slave.</p> <p>**Monitor
redis-cli memory doctor
redis-cli latency doctor</p> <p>Monitor:
https://redis.io/commands/MONITOR</p> <h2 id="系统集成-integration"><a href="#系统集成-integration" class="header-anchor">#</a> 系统集成 Integration</h2> <p>**StackExchange.Redis
Driver for .net: StackExchange.Redis 1.2https://github.com/StackExchange/StackExchange.Redis
for partial matching
Where are KEYS, SCAN, FLUSHDB etc? https://github.com/StackExchange/StackExchange.Redis/blob/41f427bb5ed8c23d0992a1411d0c92667b133d8e/docs/KeysScan.md</p> <p>**Python
pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org redis-py-cluster
from rediscluster import StrictRedisCluster
rc = StrictRedisCluster(startup_nodes=redis_nodes, decode_responses=True)</p> <blockquote><blockquote><blockquote><p>rc.smembers(&quot;bitcoin:stg_testnet:1514360&quot;)
set([u'812853c7fe8bfa3f7d625895b3270245861f974f6ff19f8ce21317b5378be41e'])
https://github.com/Grokzen/redis-py-cluster/blob/unstable/tests/test_commands.py</p></blockquote></blockquote></blockquote> <p>**Spring boot integration
Spring-Data-Redis 解析 https://juejin.im/post/5bac97606fb9a05cd8492e48</p> <p>spring.redis.database=5</p> <h1 id="redis服务器地址"><a href="#redis服务器地址" class="header-anchor">#</a> Redis服务器地址</h1> <p>spring.redis.host=127.0.0.1</p> <h1 id="redis服务器连接端口"><a href="#redis服务器连接端口" class="header-anchor">#</a> Redis服务器连接端口</h1> <p>spring.redis.port=6379</p> <h2 id="troubleshooting"><a href="#troubleshooting" class="header-anchor">#</a> Troubleshooting</h2> <p>1.org.springframework.data.redis.RedisSystemException: Redis exception; nested exception is io.lettuce.core.RedisException: io.lettuce.core.RedisConnectionException: DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: 1) Just disable protected mode sending the command 'CONFIG SET protected-mode no' from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. 2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to 'no', and then restarting the server. 3) If you started the server manually just for testing, restart it with the '--protected-mode no' option. 4) Setup a bind address or an authentication password. NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside.</p> <p>SOLUTION: redis-server redis.conf</p> <p>2.&quot;Unable to connect to Redis; nested exception is io.lettuce.core.RedisException: Cannot retrieve initial cluster partitions from initial URIs [RedisURI [host='192.168.56.101', port=6379]]&quot;,
telnet result:</p> <p>SOLUTION:
CONFIG SET protected-mode no
CONFIG REWRITE</p> <p>3.ERR Protocol error: invalid bulk length</p> <p>https://github.com/xetorthio/jedis/issues/1034
https://stackoverflow.com/questions/6752894/predis-protocol-error-invalid-bulk-length</p> <p>4.Timeout issue
Line 15222: 2018-05-16 18:23:43,536 [32] DEBUG LaxinoV2Plugin - [Debug      ]Exception :
Timeout performing GET USERREPORT:SSSLZ:LZ:20658216:2bc1af86-d47c-45b8-b552-2d0b1f2078e5, inst: 1, mgr: ExecuteSelect, err: never, queue: 4750554, qu: 0, qs: 4750554, qc: 0, wr: 0, wq: 0, in: 65536, ar: 0,
clientName: TW-SSS-UGS, serverEndpoint: 10.22.103.166:6379, keyHashSlot: 5897, IOCP: (Busy=0,Free=1000,Min=2,Max=1000), WORKER: (Busy=1,Free=32766,Min=2,Max=32767),
Local-CPU: 37.95% (Please take a look at this article for some common client-side issues that can cause timeouts:</p> <p>https://github.com/StackExchange/StackExchange.Redis/tree/master/Docs/Timeouts.md</p> <p>5.[ERR] Node XXXX:6379 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0</p> <p>$redis-cli -p 6379
127.0.0.1:6379&gt; flushall
OK
127.0.0.1:6379&gt; cluster reset
OK
127.0.0.1:6379&gt; exit</p> <ol start="6"><li>issue raised by above ‘cluster rest’, the node become a standalone node, forgot other nodes!!!!</li></ol> <p>redis-cli --cluster help
redis-cli --cluster add-node <HOSTIP>:<PORT><ANY EXIST="" HOSTIP="">:<PORT> --cluster-slave
Redis [ERR] Nodes don’t agree about configuration!
https://hzkeung.com/2018/02/25/redis-trib-check
redis-cli --cluster check <HOSTIP>:<PORT>
redis-cli -h <ANY EXIST="" HOSTIP=""> -p <PORT> cluster meet <HOSTIP><PORT></PORT></HOSTIP></PORT></ANY></PORT></HOSTIP></PORT></ANY></PORT></HOSTIP></p> <ol start="7"><li>promote slave node to master</li></ol> <p>simply delete it and then meet or re-add it</p> <p>redis-cli --cluster del-node <HOSTIP>:<PORT><NODEID></NODEID></PORT></HOSTIP></p> <blockquote><blockquote><blockquote><p>Removing node xxxx from cluster xxxxx:6379
Sending CLUSTER FORGET messages to the cluster...
SHUTDOWN the node.
redis-cli -h <ANY EXIST="" HOSTIP=""> -p 6379 cluster meet <NEW HOSTIP=""><PORT>
redis-cli --cluster add-node <NEW HOSTIP="">:<PORT><ANY EXIST="" HOSTIP="">:<PORT>
redis-cli --cluster rebalance <NEW HOSTIP="">:<PORT></PORT></NEW></PORT></ANY></PORT></NEW></PORT></NEW></ANY></p></blockquote></blockquote></blockquote> <ol start="8"><li>failed delete node</li></ol> <p>Solv: meet then delete
$redis-cli --cluster del-node <HOSTIP>:<PORT><NODEID></NODEID></PORT></HOSTIP></p> <blockquote><blockquote><blockquote><p>Removing node XXXXXXX from cluster XXXXX:6379
Sending CLUSTER FORGET messages to the cluster...
Node XXXXX:6381 replied with error:
ERR Unknown node XXXXXXXX</p></blockquote></blockquote></blockquote> <p>redis-cli -h <ANY EXIST="" HOSTIP=""> -p <PORT> cluster meet <HOSTIP><PORT></PORT></HOSTIP></PORT></ANY></p> <h2 id="数据倾斜"><a href="#数据倾斜" class="header-anchor">#</a> 数据倾斜</h2> <p>big key</p> <p>Scanning for big keys
redis-cli --bigkeys</p> <p>https://programming.vip/docs/ali-yun-redis-big-key-search-tool.html</p> <hr> <p>todo:</p> <p>单线程，考虑是否原子操作</p> <p>Get 判断</p> <p>（时间窗口）</p> <p>Set （多线程覆盖）</p> <p>Setnx</p> <p>谈谈Redis的SETNX https://huoding.com/2015/09/14/463</p> <p>https://redis.io/commands/setnx</p> <p>https://github.com/StackExchange/StackExchange.Redis/blob/86b983496d3307903ce9bc2a3c7f207de42a0dea/StackExchange.Redis/StackExchange/Redis/RedisDatabase.cs</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.ed9871d1.js" defer></script><script src="/docs/assets/js/2.dc5756d7.js" defer></script><script src="/docs/assets/js/64.d847da89.js" defer></script>
  </body>
</html>
