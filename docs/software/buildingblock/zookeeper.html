<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机基础教程</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9742852210287449" crossorigin="anonymous"></script>
    <script>
			(function() { // DON'T EDIT BELOW THIS LINE
			
			})();
		 </script>
    <meta name="description" content="软件开发教程，白帽黑客入门教程，区块链入门教程，物联网，大数据">
    
    <link rel="preload" href="/docs/assets/css/0.styles.4f35daf1.css" as="style"><link rel="preload" href="/docs/assets/js/app.35d28ebb.js" as="script"><link rel="preload" href="/docs/assets/js/2.19baf9f4.js" as="script"><link rel="preload" href="/docs/assets/js/146.6e32a725.js" as="script"><link rel="preload" href="/docs/assets/js/11.0d0890d4.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.f3208242.js"><link rel="prefetch" href="/docs/assets/js/100.e7a20dcd.js"><link rel="prefetch" href="/docs/assets/js/101.e50ffc91.js"><link rel="prefetch" href="/docs/assets/js/102.84426b7d.js"><link rel="prefetch" href="/docs/assets/js/103.6720f7c4.js"><link rel="prefetch" href="/docs/assets/js/104.ab2835c2.js"><link rel="prefetch" href="/docs/assets/js/105.56974dea.js"><link rel="prefetch" href="/docs/assets/js/106.57b9aff0.js"><link rel="prefetch" href="/docs/assets/js/107.340abe41.js"><link rel="prefetch" href="/docs/assets/js/108.7efcd522.js"><link rel="prefetch" href="/docs/assets/js/109.89782022.js"><link rel="prefetch" href="/docs/assets/js/110.9cec332d.js"><link rel="prefetch" href="/docs/assets/js/111.1b5f1773.js"><link rel="prefetch" href="/docs/assets/js/112.2fbcf783.js"><link rel="prefetch" href="/docs/assets/js/113.0ea34b38.js"><link rel="prefetch" href="/docs/assets/js/114.134e7856.js"><link rel="prefetch" href="/docs/assets/js/115.79c6aedb.js"><link rel="prefetch" href="/docs/assets/js/116.a82613aa.js"><link rel="prefetch" href="/docs/assets/js/117.b0267a32.js"><link rel="prefetch" href="/docs/assets/js/118.cb45df91.js"><link rel="prefetch" href="/docs/assets/js/119.f04c509f.js"><link rel="prefetch" href="/docs/assets/js/12.eec9a325.js"><link rel="prefetch" href="/docs/assets/js/120.8c35d034.js"><link rel="prefetch" href="/docs/assets/js/121.2f831063.js"><link rel="prefetch" href="/docs/assets/js/122.ed5c3d6d.js"><link rel="prefetch" href="/docs/assets/js/123.9c5d5a37.js"><link rel="prefetch" href="/docs/assets/js/124.486db7de.js"><link rel="prefetch" href="/docs/assets/js/125.a90119b6.js"><link rel="prefetch" href="/docs/assets/js/126.c4d9a3ab.js"><link rel="prefetch" href="/docs/assets/js/127.02a60141.js"><link rel="prefetch" href="/docs/assets/js/128.5695adba.js"><link rel="prefetch" href="/docs/assets/js/129.9b2c6b5b.js"><link rel="prefetch" href="/docs/assets/js/13.db96c782.js"><link rel="prefetch" href="/docs/assets/js/130.98074048.js"><link rel="prefetch" href="/docs/assets/js/131.e957246b.js"><link rel="prefetch" href="/docs/assets/js/132.be39cc06.js"><link rel="prefetch" href="/docs/assets/js/133.a06284c3.js"><link rel="prefetch" href="/docs/assets/js/134.57f90411.js"><link rel="prefetch" href="/docs/assets/js/135.39a30713.js"><link rel="prefetch" href="/docs/assets/js/136.0e8bed72.js"><link rel="prefetch" href="/docs/assets/js/137.8a81b762.js"><link rel="prefetch" href="/docs/assets/js/138.a9a7ad73.js"><link rel="prefetch" href="/docs/assets/js/139.798ba1f1.js"><link rel="prefetch" href="/docs/assets/js/14.e6cc47db.js"><link rel="prefetch" href="/docs/assets/js/140.118c9541.js"><link rel="prefetch" href="/docs/assets/js/141.04fa5d9f.js"><link rel="prefetch" href="/docs/assets/js/142.b58458b3.js"><link rel="prefetch" href="/docs/assets/js/143.18925256.js"><link rel="prefetch" href="/docs/assets/js/144.98e54985.js"><link rel="prefetch" href="/docs/assets/js/145.179b9f0f.js"><link rel="prefetch" href="/docs/assets/js/147.58578758.js"><link rel="prefetch" href="/docs/assets/js/148.40e1375e.js"><link rel="prefetch" href="/docs/assets/js/149.f13b7946.js"><link rel="prefetch" href="/docs/assets/js/15.1cb9e1ea.js"><link rel="prefetch" href="/docs/assets/js/150.14fa9df5.js"><link rel="prefetch" href="/docs/assets/js/151.5f6e0c3e.js"><link rel="prefetch" href="/docs/assets/js/152.b24cef80.js"><link rel="prefetch" href="/docs/assets/js/153.0c975eba.js"><link rel="prefetch" href="/docs/assets/js/154.dcfa6e92.js"><link rel="prefetch" href="/docs/assets/js/155.dc8549d7.js"><link rel="prefetch" href="/docs/assets/js/156.435af163.js"><link rel="prefetch" href="/docs/assets/js/157.727b398e.js"><link rel="prefetch" href="/docs/assets/js/158.2e9df3b7.js"><link rel="prefetch" href="/docs/assets/js/159.3fbd022a.js"><link rel="prefetch" href="/docs/assets/js/16.363b25ef.js"><link rel="prefetch" href="/docs/assets/js/160.d701a326.js"><link rel="prefetch" href="/docs/assets/js/161.eb957c93.js"><link rel="prefetch" href="/docs/assets/js/162.045b16e2.js"><link rel="prefetch" href="/docs/assets/js/163.71c34321.js"><link rel="prefetch" href="/docs/assets/js/164.afb60a88.js"><link rel="prefetch" href="/docs/assets/js/165.b743a10e.js"><link rel="prefetch" href="/docs/assets/js/166.c8aae4db.js"><link rel="prefetch" href="/docs/assets/js/167.708ecc4f.js"><link rel="prefetch" href="/docs/assets/js/168.c98eaa78.js"><link rel="prefetch" href="/docs/assets/js/169.99b326f2.js"><link rel="prefetch" href="/docs/assets/js/17.4aee462d.js"><link rel="prefetch" href="/docs/assets/js/170.b793e49d.js"><link rel="prefetch" href="/docs/assets/js/171.1c83f884.js"><link rel="prefetch" href="/docs/assets/js/172.dc477aa4.js"><link rel="prefetch" href="/docs/assets/js/173.41a72cfd.js"><link rel="prefetch" href="/docs/assets/js/174.339d5aba.js"><link rel="prefetch" href="/docs/assets/js/175.1d279966.js"><link rel="prefetch" href="/docs/assets/js/176.141813bd.js"><link rel="prefetch" href="/docs/assets/js/177.731302c8.js"><link rel="prefetch" href="/docs/assets/js/178.09267f0e.js"><link rel="prefetch" href="/docs/assets/js/179.9c7435c3.js"><link rel="prefetch" href="/docs/assets/js/18.7260a392.js"><link rel="prefetch" href="/docs/assets/js/180.9e8a392d.js"><link rel="prefetch" href="/docs/assets/js/181.2b44683c.js"><link rel="prefetch" href="/docs/assets/js/182.279365ee.js"><link rel="prefetch" href="/docs/assets/js/183.def8a70a.js"><link rel="prefetch" href="/docs/assets/js/184.dfece2b6.js"><link rel="prefetch" href="/docs/assets/js/185.336f5a7a.js"><link rel="prefetch" href="/docs/assets/js/186.df53a744.js"><link rel="prefetch" href="/docs/assets/js/187.2806155d.js"><link rel="prefetch" href="/docs/assets/js/188.9a296177.js"><link rel="prefetch" href="/docs/assets/js/189.23f2b146.js"><link rel="prefetch" href="/docs/assets/js/19.7c9d9761.js"><link rel="prefetch" href="/docs/assets/js/190.716c38a7.js"><link rel="prefetch" href="/docs/assets/js/191.ae835a5f.js"><link rel="prefetch" href="/docs/assets/js/192.d3569935.js"><link rel="prefetch" href="/docs/assets/js/193.7d7a4218.js"><link rel="prefetch" href="/docs/assets/js/194.40d61b3a.js"><link rel="prefetch" href="/docs/assets/js/195.6ac02597.js"><link rel="prefetch" href="/docs/assets/js/196.959aec11.js"><link rel="prefetch" href="/docs/assets/js/197.f46c27b9.js"><link rel="prefetch" href="/docs/assets/js/198.38d7927a.js"><link rel="prefetch" href="/docs/assets/js/199.b618ce87.js"><link rel="prefetch" href="/docs/assets/js/20.a50d2d67.js"><link rel="prefetch" href="/docs/assets/js/200.54fade2a.js"><link rel="prefetch" href="/docs/assets/js/201.62c67cdf.js"><link rel="prefetch" href="/docs/assets/js/202.3748488b.js"><link rel="prefetch" href="/docs/assets/js/203.77bc411d.js"><link rel="prefetch" href="/docs/assets/js/204.79dece2d.js"><link rel="prefetch" href="/docs/assets/js/205.bfe28ade.js"><link rel="prefetch" href="/docs/assets/js/206.3e1eb3cb.js"><link rel="prefetch" href="/docs/assets/js/207.f29df739.js"><link rel="prefetch" href="/docs/assets/js/208.8cd2e59e.js"><link rel="prefetch" href="/docs/assets/js/209.00ca9438.js"><link rel="prefetch" href="/docs/assets/js/21.291d9e4a.js"><link rel="prefetch" href="/docs/assets/js/210.ada6ab17.js"><link rel="prefetch" href="/docs/assets/js/211.6ed7c967.js"><link rel="prefetch" href="/docs/assets/js/212.bf764b81.js"><link rel="prefetch" href="/docs/assets/js/213.9ca4d7fe.js"><link rel="prefetch" href="/docs/assets/js/214.a3be8328.js"><link rel="prefetch" href="/docs/assets/js/215.cadc9e97.js"><link rel="prefetch" href="/docs/assets/js/216.60ce611c.js"><link rel="prefetch" href="/docs/assets/js/217.6cf5822a.js"><link rel="prefetch" href="/docs/assets/js/218.eb9e3e3d.js"><link rel="prefetch" href="/docs/assets/js/219.6f65f273.js"><link rel="prefetch" href="/docs/assets/js/22.0c23143d.js"><link rel="prefetch" href="/docs/assets/js/220.0c604cce.js"><link rel="prefetch" href="/docs/assets/js/221.16f21f45.js"><link rel="prefetch" href="/docs/assets/js/222.0a0fe378.js"><link rel="prefetch" href="/docs/assets/js/223.1dfe4906.js"><link rel="prefetch" href="/docs/assets/js/224.3c09176a.js"><link rel="prefetch" href="/docs/assets/js/225.41b6099e.js"><link rel="prefetch" href="/docs/assets/js/226.7be1bbf4.js"><link rel="prefetch" href="/docs/assets/js/227.0dc8fdba.js"><link rel="prefetch" href="/docs/assets/js/228.428058b1.js"><link rel="prefetch" href="/docs/assets/js/229.0cb43236.js"><link rel="prefetch" href="/docs/assets/js/23.e9f8ae3a.js"><link rel="prefetch" href="/docs/assets/js/230.509a5e2a.js"><link rel="prefetch" href="/docs/assets/js/231.9e4fe80a.js"><link rel="prefetch" href="/docs/assets/js/232.978dca80.js"><link rel="prefetch" href="/docs/assets/js/233.86c2c434.js"><link rel="prefetch" href="/docs/assets/js/234.55298147.js"><link rel="prefetch" href="/docs/assets/js/235.f5f20a18.js"><link rel="prefetch" href="/docs/assets/js/236.b9c55290.js"><link rel="prefetch" href="/docs/assets/js/237.ffdb1533.js"><link rel="prefetch" href="/docs/assets/js/238.cfd4ebcd.js"><link rel="prefetch" href="/docs/assets/js/239.0018e850.js"><link rel="prefetch" href="/docs/assets/js/24.db8d0b57.js"><link rel="prefetch" href="/docs/assets/js/240.4df9de9b.js"><link rel="prefetch" href="/docs/assets/js/241.a257a784.js"><link rel="prefetch" href="/docs/assets/js/242.a1d2a94c.js"><link rel="prefetch" href="/docs/assets/js/243.b3ac1fe0.js"><link rel="prefetch" href="/docs/assets/js/244.ae7ba8ad.js"><link rel="prefetch" href="/docs/assets/js/245.7f176243.js"><link rel="prefetch" href="/docs/assets/js/246.14e6b425.js"><link rel="prefetch" href="/docs/assets/js/247.16fa045b.js"><link rel="prefetch" href="/docs/assets/js/248.f67747a5.js"><link rel="prefetch" href="/docs/assets/js/249.050c758c.js"><link rel="prefetch" href="/docs/assets/js/25.b0e12ada.js"><link rel="prefetch" href="/docs/assets/js/250.789909de.js"><link rel="prefetch" href="/docs/assets/js/251.312fb104.js"><link rel="prefetch" href="/docs/assets/js/252.304aeabf.js"><link rel="prefetch" href="/docs/assets/js/253.e0ee39da.js"><link rel="prefetch" href="/docs/assets/js/254.c55da4ff.js"><link rel="prefetch" href="/docs/assets/js/255.07134c7d.js"><link rel="prefetch" href="/docs/assets/js/256.392b2e6e.js"><link rel="prefetch" href="/docs/assets/js/257.3c43a492.js"><link rel="prefetch" href="/docs/assets/js/258.db2c4c21.js"><link rel="prefetch" href="/docs/assets/js/259.db47c2b2.js"><link rel="prefetch" href="/docs/assets/js/26.f3b529ff.js"><link rel="prefetch" href="/docs/assets/js/260.0505993f.js"><link rel="prefetch" href="/docs/assets/js/27.80415652.js"><link rel="prefetch" href="/docs/assets/js/28.20e6447e.js"><link rel="prefetch" href="/docs/assets/js/29.5b144f3f.js"><link rel="prefetch" href="/docs/assets/js/3.6d6c4f92.js"><link rel="prefetch" href="/docs/assets/js/30.74f60145.js"><link rel="prefetch" href="/docs/assets/js/31.b9744236.js"><link rel="prefetch" href="/docs/assets/js/32.f6f855d4.js"><link rel="prefetch" href="/docs/assets/js/33.f14851ee.js"><link rel="prefetch" href="/docs/assets/js/34.8f16aa1d.js"><link rel="prefetch" href="/docs/assets/js/35.c06a5f71.js"><link rel="prefetch" href="/docs/assets/js/36.c82a2970.js"><link rel="prefetch" href="/docs/assets/js/37.df38faca.js"><link rel="prefetch" href="/docs/assets/js/38.4ee72438.js"><link rel="prefetch" href="/docs/assets/js/39.c8129e76.js"><link rel="prefetch" href="/docs/assets/js/4.a2bfcb97.js"><link rel="prefetch" href="/docs/assets/js/40.8e0b1211.js"><link rel="prefetch" href="/docs/assets/js/41.f6d5b97f.js"><link rel="prefetch" href="/docs/assets/js/42.33e28aa9.js"><link rel="prefetch" href="/docs/assets/js/43.ff696be5.js"><link rel="prefetch" href="/docs/assets/js/44.9c5b46d1.js"><link rel="prefetch" href="/docs/assets/js/45.843b314d.js"><link rel="prefetch" href="/docs/assets/js/46.f7a387a8.js"><link rel="prefetch" href="/docs/assets/js/47.3ac03529.js"><link rel="prefetch" href="/docs/assets/js/48.de186744.js"><link rel="prefetch" href="/docs/assets/js/49.42b654a4.js"><link rel="prefetch" href="/docs/assets/js/5.7c6ccbcd.js"><link rel="prefetch" href="/docs/assets/js/50.ad9d8779.js"><link rel="prefetch" href="/docs/assets/js/51.a24e64b1.js"><link rel="prefetch" href="/docs/assets/js/52.aa66f065.js"><link rel="prefetch" href="/docs/assets/js/53.f411c20d.js"><link rel="prefetch" href="/docs/assets/js/54.2264b4da.js"><link rel="prefetch" href="/docs/assets/js/55.1713da20.js"><link rel="prefetch" href="/docs/assets/js/56.cf20b79a.js"><link rel="prefetch" href="/docs/assets/js/57.dfd9c55d.js"><link rel="prefetch" href="/docs/assets/js/58.d1238dee.js"><link rel="prefetch" href="/docs/assets/js/59.5ba47a09.js"><link rel="prefetch" href="/docs/assets/js/6.199ebd26.js"><link rel="prefetch" href="/docs/assets/js/60.36dd0ff3.js"><link rel="prefetch" href="/docs/assets/js/61.6a334c57.js"><link rel="prefetch" href="/docs/assets/js/62.945553d9.js"><link rel="prefetch" href="/docs/assets/js/63.246937e5.js"><link rel="prefetch" href="/docs/assets/js/64.bda1897e.js"><link rel="prefetch" href="/docs/assets/js/65.008da63e.js"><link rel="prefetch" href="/docs/assets/js/66.8d1b420f.js"><link rel="prefetch" href="/docs/assets/js/67.b9c8b675.js"><link rel="prefetch" href="/docs/assets/js/68.5cd2b0d5.js"><link rel="prefetch" href="/docs/assets/js/69.9779a150.js"><link rel="prefetch" href="/docs/assets/js/7.1915a31b.js"><link rel="prefetch" href="/docs/assets/js/70.19fd0ff4.js"><link rel="prefetch" href="/docs/assets/js/71.ab6c9fc9.js"><link rel="prefetch" href="/docs/assets/js/72.11a087a5.js"><link rel="prefetch" href="/docs/assets/js/73.b856b02c.js"><link rel="prefetch" href="/docs/assets/js/74.76b26dd8.js"><link rel="prefetch" href="/docs/assets/js/75.4336989c.js"><link rel="prefetch" href="/docs/assets/js/76.40de1ac4.js"><link rel="prefetch" href="/docs/assets/js/77.3ed6ce6f.js"><link rel="prefetch" href="/docs/assets/js/78.2658e5ed.js"><link rel="prefetch" href="/docs/assets/js/79.fa44a306.js"><link rel="prefetch" href="/docs/assets/js/8.7e265787.js"><link rel="prefetch" href="/docs/assets/js/80.05af9300.js"><link rel="prefetch" href="/docs/assets/js/81.3251f0e1.js"><link rel="prefetch" href="/docs/assets/js/82.d9beba3d.js"><link rel="prefetch" href="/docs/assets/js/83.cf00253f.js"><link rel="prefetch" href="/docs/assets/js/84.9429343b.js"><link rel="prefetch" href="/docs/assets/js/85.574008ea.js"><link rel="prefetch" href="/docs/assets/js/86.63036782.js"><link rel="prefetch" href="/docs/assets/js/87.efda5b14.js"><link rel="prefetch" href="/docs/assets/js/88.a5efe1a7.js"><link rel="prefetch" href="/docs/assets/js/89.29545ab2.js"><link rel="prefetch" href="/docs/assets/js/9.08b2bf1a.js"><link rel="prefetch" href="/docs/assets/js/90.5dfeff2f.js"><link rel="prefetch" href="/docs/assets/js/91.feeb23d2.js"><link rel="prefetch" href="/docs/assets/js/92.81502e4e.js"><link rel="prefetch" href="/docs/assets/js/93.95504409.js"><link rel="prefetch" href="/docs/assets/js/94.44da2c86.js"><link rel="prefetch" href="/docs/assets/js/95.12eb98cd.js"><link rel="prefetch" href="/docs/assets/js/96.1aadc336.js"><link rel="prefetch" href="/docs/assets/js/97.5fac36ff.js"><link rel="prefetch" href="/docs/assets/js/98.b1d8290c.js"><link rel="prefetch" href="/docs/assets/js/99.2cde20d4.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.4f35daf1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">计算机基础教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/software/buildingblock/zookeeper.html#quickstart" class="sidebar-link">QuickStart:</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#install-usage" class="sidebar-link">Install &amp; usage</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#编译源码" class="sidebar-link">编译源码</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#管理脚本" class="sidebar-link">管理脚本</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#自动启动" class="sidebar-link">自动启动</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#admin" class="sidebar-link">admin</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#things-to-avoid" class="sidebar-link">Things to Avoid</a></li></ul></li><li><a href="/docs/software/buildingblock/zookeeper.html#工具-日志排查" class="sidebar-link">工具/日志排查</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#application-log" class="sidebar-link">Application Log</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#data-log" class="sidebar-link">Data Log</a></li></ul></li><li><a href="/docs/software/buildingblock/zookeeper.html#开发-programming" class="sidebar-link">开发 programming</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/buildingblock/zookeeper.html#原理解读" class="sidebar-link">原理解读</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/buildingblock/zookeeper.html#源码解读" class="sidebar-link">源码解读</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#server端代码" class="sidebar-link">server端代码</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#zookeeper-client端代码" class="sidebar-link">Zookeeper client端代码</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#curator-api封装代码" class="sidebar-link">Curator api封装代码</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#curator-leader-election代码解析" class="sidebar-link" style="padding-left:3rem;">curator leader election代码解析</a></li><li class="sidebar-sub-header"><a href="/docs/software/buildingblock/zookeeper.html#pathchildrencache解析-zookeeper推拉消息" class="sidebar-link" style="padding-left:3rem;">PathChildrenCache解析： zookeeper推拉消息</a></li></ul></li><li><a href="/docs/software/buildingblock/zookeeper.html#深入解读" class="sidebar-link">深入解读</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="/docs/software">回目录</a>  《分布式框架zookeeper》</p> <h2 id="quickstart"><a href="#quickstart" class="header-anchor">#</a> QuickStart:</h2> <h3 id="install-usage"><a href="#install-usage" class="header-anchor">#</a> Install &amp; usage</h3> <p>https://cwiki.apache.org/confluence/display/ZOOKEEPER/Index
https://zookeeper.apache.org/doc/current/index.html</p> <p>https://docs.confluent.io/platform/current/zookeeper/deployment.html</p> <div class="language- extra-class"><pre class="language-text"><code>tar zxvf zookeeper-3.4.8.tar.gz 

mkdir -p /opt/dependency/zookeeper-3.4.8/zkdata
mkdir -p /opt/dependency/zookeeper-3.4.8/logs 


集群配置：
This example is for a 3 node ensemble：

# The number of milliseconds of each tick                      
tickTime=2000                                                  
# The number of ticks that the initial                         
# synchronization phase can take                               
initLimit=10                                                   
# The number of ticks that can pass between                    
# sending a request and getting an acknowledgement             
syncLimit=5                                                    
# the directory where the snapshot is stored.                  
# do not use /tmp for storage, /tmp here is just               
# example sakes.                                               
dataDir=/opt/dependency/zookeeper-3.4.8/zkdata           
dataLogDir=/opt/dependency/zookeeper-3.4.8/logs          
# the port at which the clients will connect                   
clientPort=2181                                                
server.1=1.1.1.1:2888:3888                               
server.2=1.1.1.2:2888:3888                               
server.3=1.1.1.3:2888:3888                               
SERVER_JVMFLAGS=-Xmx1024m'       

然后在各个节点上分别写入 1 2 3等到myid：
$ echo &quot;1&quot; &gt; /zookeeper/zkdata/myid

好像还有个 zookeeper_server.pid?
</code></pre></div><p>？Failed to start and no log
Resolved: yum install glibc.i686</p> <div class="language- extra-class"><pre class="language-text"><code>./bin/zkServer.sh start-foreground
</code></pre></div><p>https://zookeeper.apache.org/doc/r3.3.3/zookeeperStarted.html</p> <div class="language- extra-class"><pre class="language-text"><code>bin/zkCli.sh -server 127.0.0.1:2181
[zk: localhost:2181(CONNECTED) 0] help
[zk: localhost:2181(CONNECTED) 0] ls /
[zk: localhost:2181(CONNECTED) 0] get /test
[zk: localhost:2181(CONNECTED) 0] ls /test mywatcher
[zk: localhost:2181(CONNECTED) 0] delete /test
[zk: localhost:2181(CONNECTED) 0] rmr /test	
[zk: localhost:2181(CONNECTED) 0] stat /brokers/topics/T-MEMBER
</code></pre></div><h3 id="编译源码"><a href="#编译源码" class="header-anchor">#</a> 编译源码</h3> <p>https://www.cnblogs.com/MangoCai/p/10846187.html</p> <p>安装ant，设置%ANT_HOME%\bin
Copy ivy.jar到ant lib
根节点 ant eclipse
Eclipse导入普通java project，修改build path jdk和compliance
通过VerGen.java生成Info.java（/org/apache/zookeeper/version）
<img src="/docs/docs_image/software/zookeeper/zookeeper01.png" alt="">
Copy到VerGen.java的上一层package里面</p> <p>然后两种方式生成jar，
命令行和eclipse导出
根目录下执行
ant jar compile-test
或者
<img src="/docs/docs_image/software/zookeeper/zookeeper02.png" alt=""></p> <p>Copy conf/zoo.cfg修改
dataDir=C:\Workspace\Repository\zookeeper-release-3.5.6\dataDir</p> <p>把jar放到根目录下，
运行
<code>/bin/zkServer.cmd /bin/zkCli.cmd</code></p> <h3 id="管理脚本"><a href="#管理脚本" class="header-anchor">#</a> 管理脚本</h3> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">readonly</span> <span class="token assign-left variable">PROGNAME</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $0<span class="token variable">)</span></span>
<span class="token builtin class-name">readonly</span> <span class="token assign-left variable">PROGDIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>readlink -m <span class="token punctuation">$(</span>dirname $0<span class="token punctuation">)</span><span class="token variable">)</span></span>

<span class="token comment"># source env</span>
<span class="token assign-left variable">L_INVOCATION_DIR</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>&quot;</span>
<span class="token assign-left variable">L_CMD_DIR</span><span class="token operator">=</span><span class="token string">&quot;/opt/scripts&quot;</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${L_INVOCATION_DIR}</span>&quot;</span> <span class="token operator">!=</span> <span class="token string">&quot;<span class="token variable">${L_CMD_DIR}</span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token function">pushd</span> <span class="token variable">${L_CMD_DIR}</span> <span class="token operator">&amp;&gt;</span> /dev/null
<span class="token keyword">fi</span>

<span class="token comment">#source ../set_env.sh</span>

<span class="token comment">#--------------- Function Definition ---------------#</span>
<span class="token function-name function">showUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;Usage:&quot;</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">$0</span> zookeeper start|kill&quot;</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;&quot;</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;--start or -b:  Start zookeeper&quot;</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;--kill or -k:   Stop zookeeper&quot;</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;--status or -s: Check zookeeper status&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">#---------------  Main ---------------#</span>

<span class="token comment"># Parse arguments</span>
<span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">${1<span class="token operator">:</span>0<span class="token operator">:</span>1}</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;-&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>
    --start<span class="token punctuation">)</span>
      <span class="token assign-left variable">L_FLAG</span><span class="token operator">=</span><span class="token string">&quot;B&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    -b<span class="token punctuation">)</span>
      <span class="token assign-left variable">L_FLAG</span><span class="token operator">=</span><span class="token string">&quot;B&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    --status<span class="token punctuation">)</span>
      <span class="token assign-left variable">L_FLAG</span><span class="token operator">=</span><span class="token string">&quot;S&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    -s<span class="token punctuation">)</span>
      <span class="token assign-left variable">L_FLAG</span><span class="token operator">=</span><span class="token string">&quot;S&quot;</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
        --kill<span class="token punctuation">)</span>
      <span class="token assign-left variable">L_FLAG</span><span class="token operator">=</span><span class="token string">&quot;K&quot;</span>
          <span class="token punctuation">;</span><span class="token punctuation">;</span>
        -k<span class="token punctuation">)</span>
      <span class="token assign-left variable">L_FLAG</span><span class="token operator">=</span><span class="token string">&quot;K&quot;</span>
          <span class="token punctuation">;</span><span class="token punctuation">;</span>
        --kafka<span class="token punctuation">)</span>
      <span class="token assign-left variable">L_FLAG</span><span class="token operator">=</span><span class="token string">&quot;KAFKA&quot;</span>
          <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
      <span class="token builtin class-name">echo</span> <span class="token string">&quot;Unknown option: <span class="token variable">$1</span>&quot;</span>
          <span class="token builtin class-name">echo</span> <span class="token string">&quot;&quot;</span>
      showUsage
          <span class="token builtin class-name">echo</span> <span class="token string">&quot;&quot;</span>
      <span class="token builtin class-name">exit</span> <span class="token number">1</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
  <span class="token builtin class-name">shift</span>
<span class="token keyword">done</span>

<span class="token assign-left variable">L_RETURN_FLAG</span><span class="token operator">=</span><span class="token number">0</span> <span class="token comment"># 0 for success while 99 for failure</span>

<span class="token assign-left variable">BIN_HOME</span><span class="token operator">=</span>/opt/zookeeper-3.4.8/bin

<span class="token function">pushd</span> <span class="token variable">${BIN_HOME}</span> <span class="token operator">&amp;&gt;</span>/dev/null

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$L_FLAG</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;B&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Starting zookeeper service...&quot;</span>
        ./zkServer.sh start
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$L_FLAG</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;K&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Stopping zookeeper service...&quot;</span>
        ./zkServer.sh stop
<span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token string">&quot;<span class="token variable">$L_FLAG</span>&quot;</span> <span class="token operator">==</span> <span class="token string">&quot;KAFKA&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        ./zkCli.sh <span class="token function">ls</span> /brokers/ids
<span class="token keyword">else</span>
        <span class="token builtin class-name">echo</span> <span class="token string">&quot;Checking zookeeper status...&quot;</span>
        ./zkServer.sh status
<span class="token keyword">fi</span>

<span class="token builtin class-name">exit</span> <span class="token variable">$L_RETURN_FLAG</span>
</code></pre></div><h3 id="自动启动"><a href="#自动启动" class="header-anchor">#</a> 自动启动</h3> <div class="language- extra-class"><pre class="language-text"><code>[Unit]
Description=The Zookeeper Daemon
Wants=syslog.target
Requires=network.target
After=network.target

[Service]
Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/jdk/bin
Type=forking
User=root
ExecStart=/bin/zkCli.sh start

[Install]
WantedBy=multi-user.target
</code></pre></div><h3 id="admin"><a href="#admin" class="header-anchor">#</a> admin</h3> <p><strong>New in 3.5.0:</strong> The following        options are used to configure the <a href="https://zookeeper.apache.org/doc/r3.5.4-beta/zookeeperAdmin.html#sc_adminserver" target="_blank" rel="noopener noreferrer">AdminServer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <ul><li><p>admin.enableServer</p> <p>(Java system property: <strong>zookeeper.admin.enableServer</strong>) Set to &quot;false&quot; to disable the AdminServer.  By default the              AdminServer is enabled.</p></li> <li><p>admin.serverAddress</p> <p>(Java system property: <strong>zookeeper.admin.serverAddress</strong>) The address the embedded Jetty server listens on. Defaults to 0.0.0.0.</p></li> <li><p>admin.serverPort</p> <p>(Java system property: <strong>zookeeper.admin.serverPort</strong>) The port the embedded Jetty server listens on.  Defaults to 8080.</p></li> <li><p>admin.idleTimeout</p> <p>(Java system property: <strong>zookeeper.admin.idleTimeout</strong>) Set the maximum idle time in milliseconds that a connection can wait                           before sending or receiving data. Defaults to 30000 ms.</p></li> <li><p>admin.commandURL</p> <p>(Java system property: <strong>zookeeper.admin.commandURL</strong>) The URL for listing and issuing commands relative to the              root URL.  Defaults to &quot;/commands&quot;.</p></li></ul> <h3 id="things-to-avoid"><a href="#things-to-avoid" class="header-anchor">#</a> Things to Avoid</h3> <p>Here are some common problems you can avoid by configuring      ZooKeeper correctly:</p> <ul><li><p>inconsistent lists of servers</p> <p>The list of ZooKeeper servers used by the clients must match            the list of ZooKeeper servers that each ZooKeeper server has.            Things work okay if the client list is a subset of the real list,            but things will really act strange if clients have a list of            ZooKeeper servers that are in different ZooKeeper clusters. Also,            the server lists in each Zookeeper server configuration file            should be consistent with one another.</p></li> <li><p>incorrect placement of transaction log</p> <p>The most performance critical part of ZooKeeper is the            transaction log. ZooKeeper syncs transactions to media before it            returns a response. A dedicated transaction log device is key to            consistent good performance. Putting the log on a busy device will            adversely effect performance. If you only have one storage device,            put trace files on NFS and increase the snapshotCount; it doesn't            eliminate the problem, but it should mitigate it.</p></li> <li><p>incorrect Java heap size</p> <p>You should take special care to set your Java max heap size            correctly. In particular, you should not create a situation in            which ZooKeeper swaps to disk. The disk is death to ZooKeeper.            Everything is ordered, so if processing one request swaps the            disk, all other queued requests will probably do the same. the            disk. DON'T SWAP. Be conservative in your estimates: if you have 4G of RAM, do            not set the Java max heap size to 6G or even 4G. For example, it            is more likely you would use a 3G heap for a 4G machine, as the            operating system and the cache also need memory. The best and only            recommend practice for estimating the heap size your system needs            is to run load tests, and then make sure you are well below the            usage limit that would cause the system to swap.</p></li> <li><p>Publicly accessible deployment</p> <p>​              A ZooKeeper ensemble is expected to operate in a trusted computing environment.              It is thus recommended to deploy ZooKeeper behind a firewall.</p></li></ul> <h2 id="工具-日志排查"><a href="#工具-日志排查" class="header-anchor">#</a> 工具/日志排查</h2> <p>./bin/zkServer.sh start-foreground</p> <p>https://zookeeper.apache.org/doc/r3.3.2/zookeeperAdmin.html</p> <p>工具集合：</p> <p>https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md</p> <h3 id="application-log"><a href="#application-log" class="header-anchor">#</a> Application Log</h3> <div class="language- extra-class"><pre class="language-text"><code>zkServer.sh start的log默认是在：
/bin/zookeeper.out

使用/conf/log4j.properties 设置为 zookeeper.log
https://stackoverflow.com/questions/28691341/zookeeper-log-file-not-created-inside-logs-directory
https://stackoverflow.com/questions/26612908/why-does-zookeeper-not-use-my-log4j-properties-file-log-directory

实例：
发现某个节点
netstat -anp|grep :2181 以及
netstat -anp|grep :2888 （ensemble节点互通端口）
出现大量的time_wait tcp连接，来自于各个节点，
最后通过查看
tail -f /bin/zookeeper.out 发现：
2021-04-06 20:58:23,958 [myid:1] - WARN  [QuorumPeer[myid=1]/0.0.0.0:2181:Follower@89] - Exception when following the leader
java.io.IOException: Permission denied                                                                       
        at java.io.UnixFileSystem.createFileExclusively(Native Method)                
        at java.io.File.createNewFile(File.java:1012) 
        at org.apache.zookeeper.server.quorum.Learner.syncWithLeader(Learner.java:436)                   
        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:82)
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:846)                      
2021-04-06 20:58:23,959 [myid:1] - INFO  [QuorumPeer[myid=1]/0.0.0.0:2181:Follower@166] - shutdown called    java.lang.Exception: shutdown Follower  
		at org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)                   
        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:850) 
2021-04-06 20:58:23,959 [myid:1] - INFO  [QuorumPeer[myid=1]/0.0.0.0:2181:FollowerZooKeeperServer@140] - Shutting down
然后通过permission denied判断是权限问题，因为启动的时候是用的普通user，发现
find zookeeper/ -group root
发现了zkdata下面的文件都是root的，修改权限即可
https://stackoverflow.com/questions/54087210/kafka-create-too-many-time-wait-tcp-connection/66969946#66969946
其他类似案例：https://www.cnblogs.com/duanxz/p/3768454.html
</code></pre></div><h3 id="data-log"><a href="#data-log" class="header-anchor">#</a> Data Log</h3> <p>https://stackoverflow.com/questions/17894808/how-do-one-read-the-zookeeper-transaction-log</p> <div class="language- extra-class"><pre class="language-text"><code>--- 3.6 之前版本
具体log4j版本可以在zookeeper目录下/lib里面去看

java -cp /zookeeper-3.4.8/zookeeper-3.4.8.jar:lib/log4j-1.2.16.jar:lib/slf4j-log4j12-1.6.1.jar:lib/slf4j-api-1.6.1.jar org.apache.zookeeper.server.LogFormatter /zookeeper-3.4.8/logs/version-2/log.100000001 &gt;  /home/test/zookeeper


--- 3.6后版本
For transaction log:
bin/zkTxnLogToolkit.sh --dump /datalog/version-2/log.f3aa6 
For snapshots:
./zkSnapShotToolkit.sh -d /data/zkdata/version-2/snapshot.fa01000186d
</code></pre></div><p>Admin
https://zookeeper.apache.org/doc/current/zookeeperAdmin.html</p> <p>troubleshooting
https://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting</p> <p>somoktest latency
https://cwiki.apache.org/confluence/display/ZOOKEEPER/ServiceLatencyOverview</p> <p>Jmx
https://zookeeper.apache.org/doc/current/zookeeperJMX.html#</p> <div class="language- extra-class"><pre class="language-text"><code>vim bin/zkServer.sh
找到ZOODAMIN=&quot;&quot;  添加 -Djava.rmi.server.hostname=$JMXHOSTNAME

到conf下面添加java.env:
JMXHOSTNAME=''
JMXPORT=2182
</code></pre></div><p>?Failed to resolve hostname, malformed url
edit /etc/hosts,add 127.0.0.1 <hostname></hostname></p> <p>jconsole
Four letter words
https://zookeeper.apache.org/doc/r3.4.13/zookeeperAdmin.html#sc_zkCommands</p> <div class="language- extra-class"><pre class="language-text"><code>echo dump | nc localhost 2181
</code></pre></div><p>Baseline
https://cwiki.apache.org/confluence/display/ZOOKEEPER/ServiceLatencyOverview</p> <h2 id="开发-programming"><a href="#开发-programming" class="header-anchor">#</a> 开发 programming</h2> <p>https://cwiki.apache.org/confluence/display/ZOOKEEPER/ErrorHandling
https://zookeeper.apache.org/doc/current/zookeeperProgrammers.html</p> <h2 id="原理解读"><a href="#原理解读" class="header-anchor">#</a> 原理解读</h2> <p><img src="/docs/docs_image/software/zookeeper/zookeeper03.png" alt=""> <img src="/docs/docs_image/software/zookeeper/zookeeper04.png" alt=""> <img src="/docs/docs_image/software/zookeeper/zookeeper05.png" alt="">
Semaphores
Queues
Leader election
Group membership
Barriers
Configuration</p> <p>ZooKeeper has a built-in sanity check of 1M, to prevent it from being used as a large data store, but in general it is used to store much smaller pieces of data.
zxid (ZooKeeper Transaction Id). Each update will have a unique zxid
分布式协调，通过观察者模式，rpc通知客户端节点变化，默认的客户端有：
自带的zkCli.sh以及org.apache.zookeeper 客户端lib jar包
还有curator高级开发API
zookeeper事件触发是通过推拉的方式，先通知watcher客户端节点变动，然后客户端再去pull下来新增或变化的节点信息；
Watcher机制/观察者模式
https://www.jianshu.com/p/4c071e963f18</p> <h2 id="源码解读"><a href="#源码解读" class="header-anchor">#</a> 源码解读</h2> <p>Apache ZooKeeper Watcher 机制源码解释 https://www.ibm.com/developerworks/cn/opensource/os-cn-apache-zookeeper-watcher/index.html
Zookeeper源码分析之客户端源码解密 https://www.jianshu.com/p/06e859181cc0
Zookeeper源码分析之curator客户端 https://www.jianshu.com/p/bc5e24e4f614</p> <p><img src="/docs/docs_image/software/zookeeper/zookeeper10.png" alt=""></p> <h3 id="server端代码"><a href="#server端代码" class="header-anchor">#</a> server端代码</h3> <p>server下面的FinalRequestProcessor是终极请求处理类，所有server收到的请求最终都是流向这里，下面看看如果triggerWatcher的流程：
<img src="/docs/docs_image/software/zookeeper/zookeeper11.png" alt="">
然后进去看watcher 的process</p> <p>可以看到zookeeper server“调用客户端”的watch通知是通过跟客户端的socket连接直接返回response，然后客户端收到请求后会反序列化调用自己实现的watch接口方法
zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java
这里的NIOServerCnxn间接继承自Watcherzookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/ServerCnxn.java
public abstract class ServerCnxn implements Stats, Watcher {
记住这里的ServerCnxn，后面会讲解client端对应的ClientCnxn</p> <h3 id="zookeeper-client端代码"><a href="#zookeeper-client端代码" class="header-anchor">#</a> Zookeeper client端代码</h3> <p>Client由三个主要模块组成：Zookeeper, WatcherManager, ClientCnxn
Zookeeper是ZK Client端的接口，
WatcherManager，管理ZK Client绑定的所有Watcher。
ClientCnxn是管理所有网络IO的模块，所有和ZK Server交互的信息和数据都经过这个模块</p> <p>zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeper.java
clientWatchManager用于存储管理客户端连过来的watcher</p> <p>首先是zookeeper server自带的cli工具：
zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeperMain.java</p> <p>然后是zookeeper client端代码：
客户端收到消息后，会调用 ClientCnxn 的 SendThread.readResponse 方法来进行统一处理，如果响应头 replyHdr 中标识的 Xid 为 02，表示是 ping，如果为-4，表示是验证包，如果是-1，表示这是一个通知类型的响应，然后进行反序列化、处理 chrootPath、还原 WatchedEvent、回调 Watcher 等步骤，其中回调 Watcher 步骤将 WacthedEvent 对象交给 EventThread 线程，在下一个轮询周期中进行 Watcher 回调；
补充：ClientCnxnSocket会读取socket连接，发现connected信息也将交由SendThread的onconnected处理
zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java</p> <p>SendThread 接收到服务端的通知事件后，会通过调用 EventThread 类的 queueEvent 方法将事件传给 EventThread 线程，queueEvent 方法根据该通知事件，从 ZKWatchManager 中取出所有相关的 Watcher
客户端在识别出事件类型 EventType 之后，会从相应的 Watcher 存储中删除对应的 Watcher，获取到相关的 Watcher 之后，会将其放入 waitingEvents 队列，该队列从字面上就能理解是一个待处理队列，线程的 run 方法会不断对该该队列进行处理，这就是一种异步处理思维的实现</p> <h3 id="curator-api封装代码"><a href="#curator-api封装代码" class="header-anchor">#</a> Curator api封装代码</h3> <p>七张图彻底讲清楚ZooKeeper分布式锁的实现原理
https://juejin.im/post/5c01532ef265da61362232ed
Zookeeper使用之curator
https://leokongwq.github.io/2018/06/17/zookeeper-curator.html
Curator分布式锁
https://blog.csdn.net/xuefeng0707/article/details/80588855
Zookeeper Curator 事件监听 - 秒懂
https://www.cnblogs.com/crazymakercircle/p/10228385.html</p> <h4 id="curator-leader-election代码解析"><a href="#curator-leader-election代码解析" class="header-anchor">#</a> curator leader election代码解析</h4> <p><img src="/docs/docs_image/software/zookeeper/curator01.png" alt="">
图示上半部分为跟zookeeper断线之后的逻辑，</p> <p>断线处理很简单，LeaderSelectorListener继承了ConnectionStateListener，
然后这个listener注册到了CuratorFrameworkImpl维护的listener容器，
当断线时回调这个listener wrapper，wrapper再回调statechange，然后可以在statechange里面抛出异常从而触发
leaderSelector.interruptLeadership，其内部就是获取“执行takeleadership的doWorkLoop所在的线程executorService”这个task，然后调用其cancel（boolean java.util.concurrent.Future.cancel(boolean mayInterruptIfRunning)）方法中断操作</p> <p>额外指出，从架构设计上欣赏的curator的监听器管理，CuratorFrameworkImpl将这些ConnectionStateListener交由ConnectionStateManager来统一管理，当监测到状态变化，
ConnectionStateManager调用注册好的listener的StateChange来通知变化，这是典型的一个抽象出来的状态机管理实现；</p> <p>下半部分是选举的分布式锁机制，主要的逻辑基石就是zookeeper保证了sequence ephemeral节点的生成，然后后一个节点监听前一个节点，只有前一个节点删除后才会通过watcher去唤醒后面一个等待的节点</p> <p>curator封装的InterProcessMutex注释：
/**
* A re-entrant mutex that works across JVMs. Uses Zookeeper to hold the lock. All processes in all JVMs that
* use the same lock path will achieve an inter-process critical section. Further, this mutex is
* &quot;fair&quot; - each user will get the mutex in the order requested (from ZK's point of view)
*/
public class InterProcessMutex implements InterProcessLock, Revocable<InterProcessMutex>
所谓跨JMS mutex实际上就是：</InterProcessMutex></p> <ol><li>首先还是要考虑同一个application，即同一个jvm进程中多线程的竞争问题，所以引入了大量的synchronized方法和synchronized(this)方法块，</li> <li>跨JVMs主要就是利用了StandardLockInternalsDriver的getsTheLock，利用ephemeral sequential先获取当前leader下面注册了多少child，然后当前的node就去pathToWatch前面一个node（children.get(ourIndex - maxLeases)，maxLeases=1）</li></ol> <h4 id="pathchildrencache解析-zookeeper推拉消息"><a href="#pathchildrencache解析-zookeeper推拉消息" class="header-anchor">#</a> PathChildrenCache解析： zookeeper推拉消息</h4> <p>如果我们直接使用zookeeper client开发，只能自定义各种watcher，然后向zookeeper也就是zookeeper client端接口注册，然后最终注册到zookeeper服务端，
然后服务端的变化通知watcher，由于watcher是一次性的，所以每次getChildren或getData时都要设置参数项watcher为true，才可以继续监听zknode变化。</p> <p>而使用Curator封装好的NodeCache PathChildrenCache等类，我们只需要创建实现一个继承了curator相关listener接口的listener，即可实现‘实时’监听zknode变化，不需要再写繁杂的watcher代码；</p> <p>看看封装好的这个PathChildrenCache，
<img src="/docs/docs_image/software/zookeeper/curator02.png" alt=""></p> <p>我们自定义了listener，并向PathChildrenCache提供的listenerContainer注册，然后启动start</p> <p>启动后，实际上PathChildrenCache并没有将我们自定义的listener注册到curatorFramework client（实际类为CuratorFrameworkImpl），而是自己注册了一个自己的ConnectionStateListener，
不过这个主要是管理跟zookeeper服务端的连接情况，
然后OfferOperation会调用refresh(),
先向curatorFramework注册一个childWatcher，然后第一次比如节点创建后回调callback方法processResult调用processChildren，然后调用getDataAndStat，
这里又会注册一个dataWatcher，
当然这两个watcher都是最终是层层转接注册到前面说的zookeeper服务端的，下面我们就先看看到底是怎么层层转到zookeeper client接口的；</p> <p>上面说了watcher的注册，watcher的作用就是接收zookeeper服务端zknode节点及数据变化，接收的参数WatchedEvent，只是会知道变化的类型：
public enum EventType {
None (-1),
NodeCreated (1),
NodeDeleted (2),
NodeDataChanged (3),
NodeChildrenChanged (4);
然后具体变化还要主动去拉取，
所以粗略的逻辑是，curatorFramework把收到的watcher注册请求都注册给zookeeper，zookeeper服务端通知客户端watcher，然后curator在PathChildrenCache的watcher再去拉取数据；</p> <p>这两个watcher注册的地方都是创建者模式builder pattern的fluent API流畅连写：
client.getChildren().usingWatcher(childrenWatcher).inBackground(callback).forPath(path);
client.getData().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);</p> <p>下面就以dataWatcher这个来说明：</p> <p>注意这里的getData()是调用的curatorFramework的，所以实际是拿到dataBuilder，对应的实现类是getDataBuilderImpl，然后最后是落脚在forPath，实际就是调用了
getDataBuilderImpl的forPath方法，我们就看下这个的forPath方法：</p> <p>可以看到，有前台和后台执行两种模式，前台执行很直接，调用zookeeper的getdata，
继续看后台执行的模式，而后台跑则调用curatorFramework的processBackgroundOperation：
此时CuratorEvent==null，则isInitialExecution==true,所以只会调用performBackgroundOperation，然后最终是调用接口BackgroundOperation.performBackgroundOperation,
即最终调用回该接口的引用getDataBuilderImpl的performBackgroundOperation，</p> <div class="language- extra-class"><pre class="language-text"><code> if ( watching.isWatched() )
{
	client.getZooKeeper().getData(operationAndData.getData(), true, callback, backgrounding.getContext());
}
else
{
	client.getZooKeeper().getData(operationAndData.getData(), watching.getWatcher(), callback, backgrounding.getContext());
}
</code></pre></div><p>真香，可以看到最终肯定还是调用zookeeper client的getdata，然后注意到其定义的callback里面组装了一个CuratorEvent</p> <div class="language- extra-class"><pre class="language-text"><code>CuratorEvent event = new CuratorEventImpl(client, CuratorEventType.GET_DATA, rc, path, null, ctx, stat, data, null, null, null);
                    client.processBackgroundOperation(operationAndData, event);
</code></pre></div><p>然后看到其callback里面再次调用curatorFramework的processBackgroundOperation，这一次event！=null了，所以走到下面的</p> <div class="language- extra-class"><pre class="language-text"><code>if ( operationAndData.getCallback() != null )
{
	sendToBackgroundCallback(operationAndData, event);
	break;
}

processEvent(event);
</code></pre></div><p>这个callback是啥，回过头查一下就知道这个是一开始在PathChildrenCache里面注册的:</p> <div class="language- extra-class"><pre class="language-text"><code>void getDataAndStat(final String fullPath) throws Exception
    {
        BackgroundCallback callback = new BackgroundCallback()
        {
            @Override
            public void processResult(CuratorFramework client, CuratorEvent event) throws Exception
            {
                applyNewData(fullPath, event.getResultCode(), event.getStat(), cacheData ? event.getData() : null);
            }
        };

        if ( USE_EXISTS &amp;&amp; !cacheData )
        {
            client.checkExists().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);
        }
        else
        {
            // always use getData() instead of exists() to avoid leaving unneeded watchers which is a type of resource leak
            if ( dataIsCompressed &amp;&amp; cacheData )
            {
                client.getData().decompressed().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);
            }
            else
            {
                client.getData().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);
            }
        }
    }
</code></pre></div><p>回到前面，所以整个意思是调用zookeeper client接口获取的data要封装成curatorEvent再调用回PathChildrenCache的callback，callback调用applyNewData：</p> <div class="language- extra-class"><pre class="language-text"><code>if ( previousData == null ) // i.e. new
{
	offerOperation(new EventOperation(this, new PathChildrenCacheEvent(PathChildrenCacheEvent.Type.CHILD_ADDED, data)));
}
else if ( previousData.getStat().getVersion() != stat.getVersion() )
{
	offerOperation(new EventOperation(this, new PathChildrenCacheEvent(PathChildrenCacheEvent.Type.CHILD_UPDATED, data)));
}
</code></pre></div><p>可以看到这里封装了PathChidrenCacheEvent，再最终回调一开始开头注册好的监听方法
listener.childEvent(client, event);
然后看到前面CuratorFramework还调用了processEvent，继续查到里面是调用CuratorListener，
我们事先并没有注册任何CuratorListener，而是调用的PathChildrenCacheListener，所以这个processEvent这里没有起到任何作用；</p> <h2 id="深入解读"><a href="#深入解读" class="header-anchor">#</a> 深入解读</h2> <p>https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZooKeeperPresentations
Sometimes developers mistakenly assume one other guarantee that ZooKeeper does not in fact make. This is: * Simultaneously Consistent Cross-Client Views* : ZooKeeper does not guarantee that at every instance in time, two different clients will have identical views of ZooKeeper data. Due to factors like network delays, one client may perform an update before another client gets notified of the change. Consider the scenario of two clients, A and B. If client A sets the value of a znode /a from 0 to 1, then tells client B to read /a, client B may read the old value of 0, depending on which server it is connected to. If it is important that Client A and Client B read the same value, Client B should should call the sync() method from the ZooKeeper API method before it performs its read. So, ZooKeeper by itself doesn't guarantee that changes occur synchronously across all servers, but ZooKeeper primitives can be used to construct higher level functions that provide useful client synchronization. (For more information, see the ZooKeeper Recipes. [tbd:..]).</p> <p>CAP理论，zookeeper是CP模型，保证<a href="https://stackoverflow.com/questions/37399722/why-is-this-output-wrong-sequential-consistency" target="_blank" rel="noopener noreferrer">sequential consistency<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，
比eventual consistency强一些，但是不是strong consistency，因为我们前面说了，zookeeper是采用推拉模式，
所以每个客户端看的的view都可能由于网络的原因不一样，
<a href="https://stackoverflow.com/questions/35387774/is-zookeeper-always-consistent-in-terms-of-cap-theorem" target="_blank" rel="noopener noreferrer">Zookeeper is not A, and can't drop P. So it's called CP apparently. In terms of CAP theorem, &quot;C&quot; actually means linearizability.But, Zookeeper has Sequential Consistency - Updates from a client will be applied in the order that they were sent.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>然后又由于zookeeper是基于CP模型，所以有人提出：
zookeeper 的 CP 模型不适合注册中心
https://segmentfault.com/a/1190000021356988</p> <p>丢失watcher的原因：</p> <p>//连续修改会‘丢失’nodeChanged event的原因是，每次获取到nodechanged之后curator的nodecache实际上还要再次重设watch，因为watch是一次性的；
//客户端set 111 , 服务端处理set
//客户端注册watch，服务端注册watch
//客户端set 222， 服务端处理set，服务端刚才的watch刚注册好
//客户端注册watch，服务端通知client端变化
//客户端set 333， 服务端处理set
//客户端收到变化通知打印，然后还要去服务端拉取，此时最新值是333
//但是实际上setDAta应该都是成功的，因为zookeeper是顺序处理
client.setData().forPath(nodePath, &quot;111&quot;.getBytes());
client.setData().forPath(nodePath, &quot;222&quot;.getBytes());</p> <p>所以要用对zookeeper还是要学习下其他产品，比如：
<a href="https://mp.weixin.qq.com/s?__biz=MzA4Nzc4MjI4MQ==&amp;mid=2652403267&amp;idx=1&amp;sn=9c79bde74e86cf10ac85ec7d4b53a4dc&amp;chksm=8bd8f0a5bcaf79b3026777f9d7a564df56ef5086b13f502410204592ad45022682fba326682f&amp;token=1143895172&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">kafka 中 zookeeper 具体是做什么的？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>ref：
https://www.cnblogs.com/duanxz/p/3783266.html</p> <p>Zookeeper集群&quot;脑裂&quot;问题 - 运维总结 https://www.cnblogs.com/kevingrace/p/12433503.html</p> <div id="disqus_thread"></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.35d28ebb.js" defer></script><script src="/docs/assets/js/2.19baf9f4.js" defer></script><script src="/docs/assets/js/146.6e32a725.js" defer></script><script src="/docs/assets/js/11.0d0890d4.js" defer></script>
  </body>
</html>
