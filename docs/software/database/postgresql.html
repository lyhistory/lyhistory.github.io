<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机基础教程</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9742852210287449" crossorigin="anonymous"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=AW-748196294"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());
		  
		  gtag('config', 'AW-748196294');
        </script>
    <script>
			(function() { // DON'T EDIT BELOW THIS LINE
			
			})();
		 </script>
    <meta name="description" content="软件开发教程，白帽黑客入门教程，区块链入门教程，物联网，大数据">
    
    <link rel="preload" href="/docs/assets/css/0.styles.4f35daf1.css" as="style"><link rel="preload" href="/docs/assets/js/app.ebea2df2.js" as="script"><link rel="preload" href="/docs/assets/js/2.d450803a.js" as="script"><link rel="preload" href="/docs/assets/js/207.234e9c3f.js" as="script"><link rel="preload" href="/docs/assets/js/7.be017326.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.6280ea0f.js"><link rel="prefetch" href="/docs/assets/js/100.114c422e.js"><link rel="prefetch" href="/docs/assets/js/101.85387231.js"><link rel="prefetch" href="/docs/assets/js/102.dde14206.js"><link rel="prefetch" href="/docs/assets/js/103.b70c6dcb.js"><link rel="prefetch" href="/docs/assets/js/104.ccb4a368.js"><link rel="prefetch" href="/docs/assets/js/105.15951c7c.js"><link rel="prefetch" href="/docs/assets/js/106.789416e4.js"><link rel="prefetch" href="/docs/assets/js/107.4f7c6a75.js"><link rel="prefetch" href="/docs/assets/js/108.f6ff7ef5.js"><link rel="prefetch" href="/docs/assets/js/109.72b6b3eb.js"><link rel="prefetch" href="/docs/assets/js/11.5d67fbd4.js"><link rel="prefetch" href="/docs/assets/js/110.fb8c7fe0.js"><link rel="prefetch" href="/docs/assets/js/111.1d200d72.js"><link rel="prefetch" href="/docs/assets/js/112.77f257d6.js"><link rel="prefetch" href="/docs/assets/js/113.5c79acb1.js"><link rel="prefetch" href="/docs/assets/js/114.0827935e.js"><link rel="prefetch" href="/docs/assets/js/115.7828b562.js"><link rel="prefetch" href="/docs/assets/js/116.fd423bfc.js"><link rel="prefetch" href="/docs/assets/js/117.e459d63c.js"><link rel="prefetch" href="/docs/assets/js/118.17713ca8.js"><link rel="prefetch" href="/docs/assets/js/119.9e6ea963.js"><link rel="prefetch" href="/docs/assets/js/12.afe0710b.js"><link rel="prefetch" href="/docs/assets/js/120.2562c161.js"><link rel="prefetch" href="/docs/assets/js/121.20883507.js"><link rel="prefetch" href="/docs/assets/js/122.bc4bee4e.js"><link rel="prefetch" href="/docs/assets/js/123.893edcb1.js"><link rel="prefetch" href="/docs/assets/js/124.62a5fce9.js"><link rel="prefetch" href="/docs/assets/js/125.3a085397.js"><link rel="prefetch" href="/docs/assets/js/126.ff6c6909.js"><link rel="prefetch" href="/docs/assets/js/127.c2c22d99.js"><link rel="prefetch" href="/docs/assets/js/128.f84d2da2.js"><link rel="prefetch" href="/docs/assets/js/129.289dba17.js"><link rel="prefetch" href="/docs/assets/js/13.0a356446.js"><link rel="prefetch" href="/docs/assets/js/130.53c551b0.js"><link rel="prefetch" href="/docs/assets/js/131.a1678fcb.js"><link rel="prefetch" href="/docs/assets/js/132.81044c13.js"><link rel="prefetch" href="/docs/assets/js/133.b796fccf.js"><link rel="prefetch" href="/docs/assets/js/134.625708a9.js"><link rel="prefetch" href="/docs/assets/js/135.9b544000.js"><link rel="prefetch" href="/docs/assets/js/136.953366b4.js"><link rel="prefetch" href="/docs/assets/js/137.90c35651.js"><link rel="prefetch" href="/docs/assets/js/138.b499a8f3.js"><link rel="prefetch" href="/docs/assets/js/139.b8e88be0.js"><link rel="prefetch" href="/docs/assets/js/14.f8cbf4a0.js"><link rel="prefetch" href="/docs/assets/js/140.124b5c38.js"><link rel="prefetch" href="/docs/assets/js/141.8f506b8b.js"><link rel="prefetch" href="/docs/assets/js/142.4e684ac5.js"><link rel="prefetch" href="/docs/assets/js/143.49537a82.js"><link rel="prefetch" href="/docs/assets/js/144.7ec30830.js"><link rel="prefetch" href="/docs/assets/js/145.cffa89ce.js"><link rel="prefetch" href="/docs/assets/js/146.750c8d41.js"><link rel="prefetch" href="/docs/assets/js/147.63df167b.js"><link rel="prefetch" href="/docs/assets/js/148.412c0bbf.js"><link rel="prefetch" href="/docs/assets/js/149.18de9d48.js"><link rel="prefetch" href="/docs/assets/js/15.e9c81397.js"><link rel="prefetch" href="/docs/assets/js/150.c4e68a5f.js"><link rel="prefetch" href="/docs/assets/js/151.e6811790.js"><link rel="prefetch" href="/docs/assets/js/152.f51c671d.js"><link rel="prefetch" href="/docs/assets/js/153.de68e114.js"><link rel="prefetch" href="/docs/assets/js/154.0882e91e.js"><link rel="prefetch" href="/docs/assets/js/155.463f64df.js"><link rel="prefetch" href="/docs/assets/js/156.d7f81ad3.js"><link rel="prefetch" href="/docs/assets/js/157.66971a48.js"><link rel="prefetch" href="/docs/assets/js/158.5fd3be2f.js"><link rel="prefetch" href="/docs/assets/js/159.508d6b2a.js"><link rel="prefetch" href="/docs/assets/js/16.fb5c862b.js"><link rel="prefetch" href="/docs/assets/js/160.54a2ad2f.js"><link rel="prefetch" href="/docs/assets/js/161.7af8280b.js"><link rel="prefetch" href="/docs/assets/js/162.8d53bab7.js"><link rel="prefetch" href="/docs/assets/js/163.d32a529a.js"><link rel="prefetch" href="/docs/assets/js/164.40db12b0.js"><link rel="prefetch" href="/docs/assets/js/165.210fd452.js"><link rel="prefetch" href="/docs/assets/js/166.20b60bc5.js"><link rel="prefetch" href="/docs/assets/js/167.95b45a5b.js"><link rel="prefetch" href="/docs/assets/js/168.4e32255f.js"><link rel="prefetch" href="/docs/assets/js/169.e6fb5ddb.js"><link rel="prefetch" href="/docs/assets/js/17.a0e98660.js"><link rel="prefetch" href="/docs/assets/js/170.088e6cac.js"><link rel="prefetch" href="/docs/assets/js/171.fb72dc40.js"><link rel="prefetch" href="/docs/assets/js/172.cdc0f5fa.js"><link rel="prefetch" href="/docs/assets/js/173.796e442c.js"><link rel="prefetch" href="/docs/assets/js/174.f32995c4.js"><link rel="prefetch" href="/docs/assets/js/175.a8a24427.js"><link rel="prefetch" href="/docs/assets/js/176.38282a71.js"><link rel="prefetch" href="/docs/assets/js/177.9bbd603f.js"><link rel="prefetch" href="/docs/assets/js/178.42cb4905.js"><link rel="prefetch" href="/docs/assets/js/179.cc67f1ba.js"><link rel="prefetch" href="/docs/assets/js/18.8619dac2.js"><link rel="prefetch" href="/docs/assets/js/180.fe1b639a.js"><link rel="prefetch" href="/docs/assets/js/181.523d2b03.js"><link rel="prefetch" href="/docs/assets/js/182.5953bed7.js"><link rel="prefetch" href="/docs/assets/js/183.62bd2476.js"><link rel="prefetch" href="/docs/assets/js/184.9974780e.js"><link rel="prefetch" href="/docs/assets/js/185.a6871a28.js"><link rel="prefetch" href="/docs/assets/js/186.1bbad12b.js"><link rel="prefetch" href="/docs/assets/js/187.dce1e436.js"><link rel="prefetch" href="/docs/assets/js/188.627d2282.js"><link rel="prefetch" href="/docs/assets/js/189.49b236c7.js"><link rel="prefetch" href="/docs/assets/js/19.55cd84cc.js"><link rel="prefetch" href="/docs/assets/js/190.67b57b9b.js"><link rel="prefetch" href="/docs/assets/js/191.f78fec46.js"><link rel="prefetch" href="/docs/assets/js/192.372b594a.js"><link rel="prefetch" href="/docs/assets/js/193.1f02ee3a.js"><link rel="prefetch" href="/docs/assets/js/194.6259ef54.js"><link rel="prefetch" href="/docs/assets/js/195.8ec4761a.js"><link rel="prefetch" href="/docs/assets/js/196.420d20de.js"><link rel="prefetch" href="/docs/assets/js/197.077c9006.js"><link rel="prefetch" href="/docs/assets/js/198.60da1f21.js"><link rel="prefetch" href="/docs/assets/js/199.601496f8.js"><link rel="prefetch" href="/docs/assets/js/20.a41fa94c.js"><link rel="prefetch" href="/docs/assets/js/200.56a4fedd.js"><link rel="prefetch" href="/docs/assets/js/201.f92c0826.js"><link rel="prefetch" href="/docs/assets/js/202.4133b5ce.js"><link rel="prefetch" href="/docs/assets/js/203.cd0ba8a0.js"><link rel="prefetch" href="/docs/assets/js/204.46d500a2.js"><link rel="prefetch" href="/docs/assets/js/205.8d7b92d8.js"><link rel="prefetch" href="/docs/assets/js/206.a8925824.js"><link rel="prefetch" href="/docs/assets/js/208.5173495f.js"><link rel="prefetch" href="/docs/assets/js/209.b7fef1c4.js"><link rel="prefetch" href="/docs/assets/js/21.2cfc3c34.js"><link rel="prefetch" href="/docs/assets/js/210.da5806a4.js"><link rel="prefetch" href="/docs/assets/js/211.8d6336a3.js"><link rel="prefetch" href="/docs/assets/js/212.4c20c849.js"><link rel="prefetch" href="/docs/assets/js/213.df508ee1.js"><link rel="prefetch" href="/docs/assets/js/214.a76f33db.js"><link rel="prefetch" href="/docs/assets/js/215.761dbab4.js"><link rel="prefetch" href="/docs/assets/js/216.43f11f6c.js"><link rel="prefetch" href="/docs/assets/js/217.9e380971.js"><link rel="prefetch" href="/docs/assets/js/218.05dd75e7.js"><link rel="prefetch" href="/docs/assets/js/219.0df78171.js"><link rel="prefetch" href="/docs/assets/js/22.54790dac.js"><link rel="prefetch" href="/docs/assets/js/220.2aebf46b.js"><link rel="prefetch" href="/docs/assets/js/221.13d7fa13.js"><link rel="prefetch" href="/docs/assets/js/222.7aeb50b1.js"><link rel="prefetch" href="/docs/assets/js/223.6e975196.js"><link rel="prefetch" href="/docs/assets/js/224.94ac8745.js"><link rel="prefetch" href="/docs/assets/js/225.43b5854b.js"><link rel="prefetch" href="/docs/assets/js/226.7206f16b.js"><link rel="prefetch" href="/docs/assets/js/227.6457bb60.js"><link rel="prefetch" href="/docs/assets/js/228.de7e8855.js"><link rel="prefetch" href="/docs/assets/js/229.89389d3b.js"><link rel="prefetch" href="/docs/assets/js/23.6d80b8e4.js"><link rel="prefetch" href="/docs/assets/js/230.ff6b3b47.js"><link rel="prefetch" href="/docs/assets/js/231.235238c1.js"><link rel="prefetch" href="/docs/assets/js/232.a40d0b6c.js"><link rel="prefetch" href="/docs/assets/js/233.c2fb1587.js"><link rel="prefetch" href="/docs/assets/js/234.a8bf1e5c.js"><link rel="prefetch" href="/docs/assets/js/235.ca130a3b.js"><link rel="prefetch" href="/docs/assets/js/236.809a3e49.js"><link rel="prefetch" href="/docs/assets/js/237.35c64171.js"><link rel="prefetch" href="/docs/assets/js/238.d5b1696e.js"><link rel="prefetch" href="/docs/assets/js/239.1d9a1d22.js"><link rel="prefetch" href="/docs/assets/js/24.c2bd927c.js"><link rel="prefetch" href="/docs/assets/js/240.d6141176.js"><link rel="prefetch" href="/docs/assets/js/241.06fd31ed.js"><link rel="prefetch" href="/docs/assets/js/242.a65db780.js"><link rel="prefetch" href="/docs/assets/js/243.f4ccfdef.js"><link rel="prefetch" href="/docs/assets/js/244.751b73ab.js"><link rel="prefetch" href="/docs/assets/js/245.0e4d915f.js"><link rel="prefetch" href="/docs/assets/js/246.449f9171.js"><link rel="prefetch" href="/docs/assets/js/247.6c6dca57.js"><link rel="prefetch" href="/docs/assets/js/248.9cc58d71.js"><link rel="prefetch" href="/docs/assets/js/249.52a5548a.js"><link rel="prefetch" href="/docs/assets/js/25.5fed7ab6.js"><link rel="prefetch" href="/docs/assets/js/250.17524a97.js"><link rel="prefetch" href="/docs/assets/js/251.a098be8f.js"><link rel="prefetch" href="/docs/assets/js/252.1a9691d6.js"><link rel="prefetch" href="/docs/assets/js/253.0eb6b703.js"><link rel="prefetch" href="/docs/assets/js/254.a8e1622e.js"><link rel="prefetch" href="/docs/assets/js/255.9e5e9947.js"><link rel="prefetch" href="/docs/assets/js/256.5997e141.js"><link rel="prefetch" href="/docs/assets/js/257.7ca7f68f.js"><link rel="prefetch" href="/docs/assets/js/258.cdb0f10b.js"><link rel="prefetch" href="/docs/assets/js/259.936c2038.js"><link rel="prefetch" href="/docs/assets/js/26.b0e8f585.js"><link rel="prefetch" href="/docs/assets/js/260.81c5b013.js"><link rel="prefetch" href="/docs/assets/js/261.1f3af62e.js"><link rel="prefetch" href="/docs/assets/js/262.ea99a3ac.js"><link rel="prefetch" href="/docs/assets/js/263.fab80f15.js"><link rel="prefetch" href="/docs/assets/js/264.39a050ce.js"><link rel="prefetch" href="/docs/assets/js/265.54b90472.js"><link rel="prefetch" href="/docs/assets/js/266.e2a0ee35.js"><link rel="prefetch" href="/docs/assets/js/267.e002959d.js"><link rel="prefetch" href="/docs/assets/js/268.a8aa8dea.js"><link rel="prefetch" href="/docs/assets/js/269.370b2abf.js"><link rel="prefetch" href="/docs/assets/js/27.6a33f241.js"><link rel="prefetch" href="/docs/assets/js/270.a9681333.js"><link rel="prefetch" href="/docs/assets/js/271.75e05fc1.js"><link rel="prefetch" href="/docs/assets/js/272.8f7b9e87.js"><link rel="prefetch" href="/docs/assets/js/273.3e7c796e.js"><link rel="prefetch" href="/docs/assets/js/274.7e5a3380.js"><link rel="prefetch" href="/docs/assets/js/275.0380c339.js"><link rel="prefetch" href="/docs/assets/js/276.23a45ec1.js"><link rel="prefetch" href="/docs/assets/js/277.c218b98f.js"><link rel="prefetch" href="/docs/assets/js/278.72eb2973.js"><link rel="prefetch" href="/docs/assets/js/279.687b52c9.js"><link rel="prefetch" href="/docs/assets/js/28.5f3966f0.js"><link rel="prefetch" href="/docs/assets/js/280.f2986a2e.js"><link rel="prefetch" href="/docs/assets/js/281.979d212a.js"><link rel="prefetch" href="/docs/assets/js/282.f5457661.js"><link rel="prefetch" href="/docs/assets/js/283.d9035ce2.js"><link rel="prefetch" href="/docs/assets/js/284.be0a812a.js"><link rel="prefetch" href="/docs/assets/js/285.0f43da65.js"><link rel="prefetch" href="/docs/assets/js/286.43a4a78c.js"><link rel="prefetch" href="/docs/assets/js/287.0c7de7cf.js"><link rel="prefetch" href="/docs/assets/js/288.445eed75.js"><link rel="prefetch" href="/docs/assets/js/289.00d9774e.js"><link rel="prefetch" href="/docs/assets/js/29.1e9768b3.js"><link rel="prefetch" href="/docs/assets/js/290.43848646.js"><link rel="prefetch" href="/docs/assets/js/291.328bac63.js"><link rel="prefetch" href="/docs/assets/js/292.9a36a595.js"><link rel="prefetch" href="/docs/assets/js/293.5846640b.js"><link rel="prefetch" href="/docs/assets/js/294.d2ec0a30.js"><link rel="prefetch" href="/docs/assets/js/295.b69d8bd7.js"><link rel="prefetch" href="/docs/assets/js/296.5aad07a8.js"><link rel="prefetch" href="/docs/assets/js/297.b1141cf6.js"><link rel="prefetch" href="/docs/assets/js/298.5ac52837.js"><link rel="prefetch" href="/docs/assets/js/299.bdda3a49.js"><link rel="prefetch" href="/docs/assets/js/3.ba9328b5.js"><link rel="prefetch" href="/docs/assets/js/30.0ad9d011.js"><link rel="prefetch" href="/docs/assets/js/300.f4599c89.js"><link rel="prefetch" href="/docs/assets/js/301.24f0daee.js"><link rel="prefetch" href="/docs/assets/js/302.e711db7a.js"><link rel="prefetch" href="/docs/assets/js/303.876d7a0c.js"><link rel="prefetch" href="/docs/assets/js/304.00098142.js"><link rel="prefetch" href="/docs/assets/js/305.a2e06892.js"><link rel="prefetch" href="/docs/assets/js/306.07bf597a.js"><link rel="prefetch" href="/docs/assets/js/307.bed7a628.js"><link rel="prefetch" href="/docs/assets/js/308.397461cf.js"><link rel="prefetch" href="/docs/assets/js/309.071684b7.js"><link rel="prefetch" href="/docs/assets/js/31.307ade37.js"><link rel="prefetch" href="/docs/assets/js/310.d3b8e19d.js"><link rel="prefetch" href="/docs/assets/js/311.c679498e.js"><link rel="prefetch" href="/docs/assets/js/312.f203b4ca.js"><link rel="prefetch" href="/docs/assets/js/313.02eca5e9.js"><link rel="prefetch" href="/docs/assets/js/314.7b131143.js"><link rel="prefetch" href="/docs/assets/js/315.c22397f3.js"><link rel="prefetch" href="/docs/assets/js/316.4bef67e0.js"><link rel="prefetch" href="/docs/assets/js/317.e817cc82.js"><link rel="prefetch" href="/docs/assets/js/318.0340a33a.js"><link rel="prefetch" href="/docs/assets/js/319.448ecc60.js"><link rel="prefetch" href="/docs/assets/js/32.a3c0405a.js"><link rel="prefetch" href="/docs/assets/js/320.9112f71d.js"><link rel="prefetch" href="/docs/assets/js/321.ebd6a5c5.js"><link rel="prefetch" href="/docs/assets/js/322.924886d4.js"><link rel="prefetch" href="/docs/assets/js/323.23df140b.js"><link rel="prefetch" href="/docs/assets/js/324.35854219.js"><link rel="prefetch" href="/docs/assets/js/325.25cd348b.js"><link rel="prefetch" href="/docs/assets/js/326.c4630f02.js"><link rel="prefetch" href="/docs/assets/js/327.b5240255.js"><link rel="prefetch" href="/docs/assets/js/328.87fa0c50.js"><link rel="prefetch" href="/docs/assets/js/329.d5f7e050.js"><link rel="prefetch" href="/docs/assets/js/33.47712313.js"><link rel="prefetch" href="/docs/assets/js/330.1d3519cc.js"><link rel="prefetch" href="/docs/assets/js/331.f5bd4346.js"><link rel="prefetch" href="/docs/assets/js/332.ce9edfad.js"><link rel="prefetch" href="/docs/assets/js/333.66aea726.js"><link rel="prefetch" href="/docs/assets/js/334.cc6ccd00.js"><link rel="prefetch" href="/docs/assets/js/335.3156d654.js"><link rel="prefetch" href="/docs/assets/js/336.fc137427.js"><link rel="prefetch" href="/docs/assets/js/337.0918bb4a.js"><link rel="prefetch" href="/docs/assets/js/338.74df6df9.js"><link rel="prefetch" href="/docs/assets/js/339.9fe1976d.js"><link rel="prefetch" href="/docs/assets/js/34.ce795261.js"><link rel="prefetch" href="/docs/assets/js/340.76db4c18.js"><link rel="prefetch" href="/docs/assets/js/341.7084cd23.js"><link rel="prefetch" href="/docs/assets/js/342.3fb647db.js"><link rel="prefetch" href="/docs/assets/js/343.27f42ba9.js"><link rel="prefetch" href="/docs/assets/js/344.694095a6.js"><link rel="prefetch" href="/docs/assets/js/345.00756b96.js"><link rel="prefetch" href="/docs/assets/js/346.0643b3b5.js"><link rel="prefetch" href="/docs/assets/js/347.b76f54a0.js"><link rel="prefetch" href="/docs/assets/js/348.bc2f6cde.js"><link rel="prefetch" href="/docs/assets/js/349.7f1b41b7.js"><link rel="prefetch" href="/docs/assets/js/35.b4ca4763.js"><link rel="prefetch" href="/docs/assets/js/350.43e046ee.js"><link rel="prefetch" href="/docs/assets/js/351.58804be0.js"><link rel="prefetch" href="/docs/assets/js/352.366d9706.js"><link rel="prefetch" href="/docs/assets/js/353.e52e0878.js"><link rel="prefetch" href="/docs/assets/js/354.1ba608a8.js"><link rel="prefetch" href="/docs/assets/js/355.34a993f9.js"><link rel="prefetch" href="/docs/assets/js/356.e9963059.js"><link rel="prefetch" href="/docs/assets/js/357.d68ea3a9.js"><link rel="prefetch" href="/docs/assets/js/358.114f5f02.js"><link rel="prefetch" href="/docs/assets/js/359.e5dddc38.js"><link rel="prefetch" href="/docs/assets/js/36.8e791008.js"><link rel="prefetch" href="/docs/assets/js/360.720cab8b.js"><link rel="prefetch" href="/docs/assets/js/361.0410b2c2.js"><link rel="prefetch" href="/docs/assets/js/362.1fc7094e.js"><link rel="prefetch" href="/docs/assets/js/363.d1988633.js"><link rel="prefetch" href="/docs/assets/js/364.6367f1d5.js"><link rel="prefetch" href="/docs/assets/js/365.41b51eb2.js"><link rel="prefetch" href="/docs/assets/js/366.b4db5c75.js"><link rel="prefetch" href="/docs/assets/js/367.1e898c77.js"><link rel="prefetch" href="/docs/assets/js/368.79f0a38b.js"><link rel="prefetch" href="/docs/assets/js/37.3bebbd80.js"><link rel="prefetch" href="/docs/assets/js/38.9fcd912f.js"><link rel="prefetch" href="/docs/assets/js/39.0a64d77a.js"><link rel="prefetch" href="/docs/assets/js/4.8108abc2.js"><link rel="prefetch" href="/docs/assets/js/40.fc266bae.js"><link rel="prefetch" href="/docs/assets/js/41.5ca018dc.js"><link rel="prefetch" href="/docs/assets/js/42.831dc71f.js"><link rel="prefetch" href="/docs/assets/js/43.62bdce03.js"><link rel="prefetch" href="/docs/assets/js/44.97fe4437.js"><link rel="prefetch" href="/docs/assets/js/45.0dbebe9e.js"><link rel="prefetch" href="/docs/assets/js/46.6901fc3e.js"><link rel="prefetch" href="/docs/assets/js/47.48417af1.js"><link rel="prefetch" href="/docs/assets/js/48.bfd2d337.js"><link rel="prefetch" href="/docs/assets/js/49.7bffafdb.js"><link rel="prefetch" href="/docs/assets/js/5.3f8add54.js"><link rel="prefetch" href="/docs/assets/js/50.8b825edb.js"><link rel="prefetch" href="/docs/assets/js/51.b8b580b5.js"><link rel="prefetch" href="/docs/assets/js/52.c345a05a.js"><link rel="prefetch" href="/docs/assets/js/53.bf953920.js"><link rel="prefetch" href="/docs/assets/js/54.c8083448.js"><link rel="prefetch" href="/docs/assets/js/55.fe79e0ef.js"><link rel="prefetch" href="/docs/assets/js/56.011d602c.js"><link rel="prefetch" href="/docs/assets/js/57.88899fc7.js"><link rel="prefetch" href="/docs/assets/js/58.2d157dba.js"><link rel="prefetch" href="/docs/assets/js/59.73790e3e.js"><link rel="prefetch" href="/docs/assets/js/6.504169c9.js"><link rel="prefetch" href="/docs/assets/js/60.f31ac716.js"><link rel="prefetch" href="/docs/assets/js/61.c4ae667f.js"><link rel="prefetch" href="/docs/assets/js/62.70e7dea0.js"><link rel="prefetch" href="/docs/assets/js/63.c82fd55d.js"><link rel="prefetch" href="/docs/assets/js/64.27dc1876.js"><link rel="prefetch" href="/docs/assets/js/65.2ef96808.js"><link rel="prefetch" href="/docs/assets/js/66.b601c078.js"><link rel="prefetch" href="/docs/assets/js/67.5ddcc27c.js"><link rel="prefetch" href="/docs/assets/js/68.c0a179f4.js"><link rel="prefetch" href="/docs/assets/js/69.85ec12b9.js"><link rel="prefetch" href="/docs/assets/js/70.340cd6f4.js"><link rel="prefetch" href="/docs/assets/js/71.71686ab3.js"><link rel="prefetch" href="/docs/assets/js/72.a0c091c1.js"><link rel="prefetch" href="/docs/assets/js/73.5f27e575.js"><link rel="prefetch" href="/docs/assets/js/74.7d652cbe.js"><link rel="prefetch" href="/docs/assets/js/75.dacec3db.js"><link rel="prefetch" href="/docs/assets/js/76.1a288b5c.js"><link rel="prefetch" href="/docs/assets/js/77.d259f14b.js"><link rel="prefetch" href="/docs/assets/js/78.a477dba5.js"><link rel="prefetch" href="/docs/assets/js/79.e35c7003.js"><link rel="prefetch" href="/docs/assets/js/8.1fe519c9.js"><link rel="prefetch" href="/docs/assets/js/80.963f1976.js"><link rel="prefetch" href="/docs/assets/js/81.fe81aa5f.js"><link rel="prefetch" href="/docs/assets/js/82.da35337c.js"><link rel="prefetch" href="/docs/assets/js/83.7192481a.js"><link rel="prefetch" href="/docs/assets/js/84.36cebe7f.js"><link rel="prefetch" href="/docs/assets/js/85.750ca8e6.js"><link rel="prefetch" href="/docs/assets/js/86.12512fcb.js"><link rel="prefetch" href="/docs/assets/js/87.8d01c56b.js"><link rel="prefetch" href="/docs/assets/js/88.cd7381aa.js"><link rel="prefetch" href="/docs/assets/js/89.46517986.js"><link rel="prefetch" href="/docs/assets/js/9.9e97935d.js"><link rel="prefetch" href="/docs/assets/js/90.27bda68d.js"><link rel="prefetch" href="/docs/assets/js/91.0f3bbb1e.js"><link rel="prefetch" href="/docs/assets/js/92.948b2141.js"><link rel="prefetch" href="/docs/assets/js/93.e87dcfae.js"><link rel="prefetch" href="/docs/assets/js/94.65eaa548.js"><link rel="prefetch" href="/docs/assets/js/95.3868c1ab.js"><link rel="prefetch" href="/docs/assets/js/96.e03b28a9.js"><link rel="prefetch" href="/docs/assets/js/97.96f62177.js"><link rel="prefetch" href="/docs/assets/js/98.5d154f6c.js"><link rel="prefetch" href="/docs/assets/js/99.008d87a3.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.4f35daf1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">计算机基础教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/software/database/postgresql.html#arichtecture" class="sidebar-link">Arichtecture</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/database/postgresql.html#_1-setup" class="sidebar-link">1. Setup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_1-1-install" class="sidebar-link">1.1 install</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#folder" class="sidebar-link" style="padding-left:3rem;">folder</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_1-2-client连接" class="sidebar-link">1.2 client连接</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#cli-psql" class="sidebar-link" style="padding-left:3rem;">CLI - psql</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#gui-client" class="sidebar-link" style="padding-left:3rem;">GUI Client</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#drivers" class="sidebar-link" style="padding-left:3rem;">Drivers</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_1-3-utilities" class="sidebar-link">1.3 Utilities</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_1-4-config" class="sidebar-link">1.4 Config</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#理解一下posgresql的用户概念" class="sidebar-link" style="padding-left:3rem;">理解一下posgresql的用户概念</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#开启远程连接" class="sidebar-link" style="padding-left:3rem;">开启远程连接：</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#更改pgdata位置" class="sidebar-link" style="padding-left:3rem;">更改PGDATA位置</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#extension" class="sidebar-link">Extension</a></li></ul></li><li><a href="/docs/software/database/postgresql.html#_2-syntax" class="sidebar-link">2. Syntax</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_2-1-basic" class="sidebar-link">2.1 Basic</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#system" class="sidebar-link" style="padding-left:3rem;">System</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#data-format" class="sidebar-link" style="padding-left:3rem;">Data Format</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#tables-and-views" class="sidebar-link" style="padding-left:3rem;">Tables and Views</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_2-2-crud" class="sidebar-link">2.2 CRUD</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#update-from-select-subquery" class="sidebar-link" style="padding-left:3rem;">update from select subquery</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#insert-or-update-if-exists" class="sidebar-link" style="padding-left:3rem;">insert or update if exists:</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#with-statement" class="sidebar-link" style="padding-left:3rem;">WITH Statement</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_2-3-functions-stored-procedure" class="sidebar-link">2.3 Functions &amp; Stored Procedure</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#generate-time-series" class="sidebar-link" style="padding-left:3rem;">generate time series</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#detect-fill-gaps" class="sidebar-link" style="padding-left:3rem;">detect &amp; fill gaps</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_2-4-trigger" class="sidebar-link">2.4 Trigger</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_2-5-子表继承" class="sidebar-link">2.5 子表继承</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_2-6-partition-分区" class="sidebar-link">2.6 Partition 分区</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#自动分区-继承分区" class="sidebar-link" style="padding-left:3rem;">自动分区-继承分区</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_2-7-advanced" class="sidebar-link">2.7 Advanced</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#index" class="sidebar-link" style="padding-left:3rem;">index</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#temp-table" class="sidebar-link" style="padding-left:3rem;">Temp table</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#sequence" class="sidebar-link" style="padding-left:3rem;">Sequence</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#customized-types" class="sidebar-link" style="padding-left:3rem;">Customized Types</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#analysis" class="sidebar-link" style="padding-left:3rem;">Analysis</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#dynamic-cursor" class="sidebar-link" style="padding-left:3rem;">Dynamic cursor</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#scheduler" class="sidebar-link" style="padding-left:3rem;">Scheduler</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#message-flow-protocol-flow" class="sidebar-link" style="padding-left:3rem;">Message Flow / Protocol Flow</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#lock" class="sidebar-link" style="padding-left:3rem;">Lock</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#system-table" class="sidebar-link">System Table</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#gaps-between-oracle-plsql-and-postgresql" class="sidebar-link">Gaps between Oracle PLSQL and PostgreSQL</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#oracle-keep-dense-rank-change-in-postgresql" class="sidebar-link" style="padding-left:3rem;">oracle keep dense_rank CHANGE in postgresql</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#oracle-is-record-is-table-change-in-postgresql" class="sidebar-link" style="padding-left:3rem;">oracle is record, is table CHANGE in postgresql</a></li></ul></li><li><a href="/docs/software/database/postgresql.html#_3-backup-and-restore" class="sidebar-link">3. Backup and Restore</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#full-backup-restore" class="sidebar-link">full backup restore</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#incremental-backup-restore" class="sidebar-link">incremental backup restore</a></li></ul></li><li><a href="/docs/software/database/postgresql.html#_4-high-availability" class="sidebar-link">4. High Availability</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_4-1-replication不同方案" class="sidebar-link">4.1 Replication不同方案：</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_4-2-具体方案1-warm-standby-or-log-shipping" class="sidebar-link">4.2 具体方案1：warm standby or log shipping</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_4-3-具体方案2-hot-standby" class="sidebar-link">4.3 具体方案2：hot standby</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_4-4-具体配置-温备-热备" class="sidebar-link">4.4 具体配置 温备/热备</a></li></ul></li><li><a href="/docs/software/database/postgresql.html#_5-integreation-drivers" class="sidebar-link">5. Integreation - Drivers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_5-1-java" class="sidebar-link">5.1 Java</a></li><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#_5-2-net-npgsql" class="sidebar-link">5.2 .NET npgsql</a></li></ul></li><li><a href="/docs/software/database/postgresql.html#_6-monitor" class="sidebar-link">6. Monitor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/database/postgresql.html#simple-way-use-postgres-exporter" class="sidebar-link">simple way: use postgres exporter</a></li></ul></li><li><a href="/docs/software/database/postgresql.html#troubleshooting" class="sidebar-link">Troubleshooting</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/database/postgresql.html#todo" class="sidebar-link">todo</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="/docs/software">回目录</a>  《postgresql实用基础》</p> <h2 id="arichtecture"><a href="#arichtecture" class="header-anchor">#</a> Arichtecture</h2> <p>https://medium.com/@hnasr/postgresql-process-architecture-f21e16459907#/
Postmaster</p> <h2 id="_1-setup"><a href="#_1-setup" class="header-anchor">#</a> 1. Setup</h2> <h3 id="_1-1-install"><a href="#_1-1-install" class="header-anchor">#</a> 1.1 install</h3> <table><thead><tr><th>postgresql-client</th> <th>libraries and client binaries</th></tr></thead> <tbody><tr><td>postgresql-server</td> <td>core database server</td></tr> <tr><td>postgresql-contrib</td> <td>additional supplied modules</td></tr> <tr><td>postgresql-devel</td> <td>libraries and headers for C language development</td></tr></tbody></table> <p>method1:</p> <div class="language- extra-class"><pre class="language-text"><code>sudo yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
sudo yum install -y postgresql12-server
sudo /usr/pgsql-12/bin/postgresql-12-setup initdb
sudo systemctl enable postgresql-12
sudo systemctl start postgresql-12
</code></pre></div><p>method2:</p> <div class="language- extra-class"><pre class="language-text"><code>download:
https://www.postgresql.org/download/linux/redhat/
https://yum.postgresql.org/rpmchart/
https://download.postgresql.org/pub/repos/yum/12/redhat/rhel-7.6-x86_64/

postgresql12-libs-12.7-1PGDG.rhel7.x86_64.rpm 
postgresql12-contrib-12.7-1PGDG.rhel7.x86_64.rpm
postgresql12-12.7-1PGDG.rhel7.x86_64.rpm 
postgresql12-server-12.7-1PGDG.rhel7.x86_64.rpm

yum install ./postgresql12-libs-12.7-1PGDG.rhel7.x86_64.rpm 
yum install ./postgresql12-12.7-1PGDG.rhel7.x86_64.rpm 
yum install ./postgresql12-contrib-12.7-1PGDG.rhel7.x86_64.rpm -y
yum install ./postgresql12-server-12.7-1PGDG.rhel7.x86_64.rpm -y
</code></pre></div><h4 id="folder"><a href="#folder" class="header-anchor">#</a> folder</h4> <p>vim /var/lib/pgsql/12/data/postgresql.conf
vim /var/lib/pgsql/12/data/pg_hba.conf</p> <div class="language- extra-class"><pre class="language-text"><code>$ locate bin/postgres
$ /usr/pgsql-12/bin/postgres -V
postgres (PostgreSQL) 12.7
</code></pre></div><p>定位配置：</p> <div class="language- extra-class"><pre class="language-text"><code>psql
# show config_file; 
# show data_directroy;
</code></pre></div><p>systemctl status postgresql-12.servcie
systemctl edit postgresql-12
sudo vim /usr/lib/systemd/system/postgresql-12.service</p> <p>PostgreSQL 修改数据存储路径:</p> <ul><li>method 1:
https://zhuanlan.zhihu.com/p/671203356</li> <li>method 2:
https://blog.csdn.net/aikudexiaohai/article/details/129692013</li></ul> <h3 id="_1-2-client连接"><a href="#_1-2-client连接" class="header-anchor">#</a> 1.2 client连接</h3> <h4 id="cli-psql"><a href="#cli-psql" class="header-anchor">#</a> CLI - psql</h4> <div class="language- extra-class"><pre class="language-text"><code>su - postgres
进入bash，输入
#psql
就进入到plsql命令窗口，执行\l就可以看到所有db
为啥默认角色:postgres呢，执行：
\du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 _gvm      |                                                            | {dba}
 dba       | Superuser, No inheritance, Cannot login                    | {}
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}

可以创建更多角色
sudo -u postgres createuser owning_user
sudo -u postgres createdb -O owning_user dbname
</code></pre></div><p>常用命令：</p> <div class="language- extra-class"><pre class="language-text"><code>\l \list
\c [DATABASE]
\d
\d TABLE_NAME
\du 查看用户权限

\dx 查看插件
SELECT * FROM pg_extension;

--format output
\x on

解锁 unlock
dbname=# select pid from pg_locks l join pg_class t on l.relation = t.oid where t.relname = 'tablename';
dbname=# SELECT pg_cancel_backend(the id);
SELECT pg_terminate_backend(3567);
select * from pg_stat_activity where pid=3567;

\copy (query) to result.csv csv header

</code></pre></div><h4 id="gui-client"><a href="#gui-client" class="header-anchor">#</a> GUI Client</h4> <ul><li><p>Offical: Pgadmin 4    https://www.pgadmin.org/download/</p></li> <li><p>Pgadmin3 LTS by BigSQL (don’t support 11g)</p></li> <li><p>DBeaver
<strong>offline install</strong>
settings:
class name: org.postgresql.Driver
template: jdbc:postgresql://{host}:{port}/{database}
libraries: <a href="https://jdbc.postgresql.org/" target="_blank" rel="noopener noreferrer">add postgres drivers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <strong>show all databases</strong>
On the connection, right-click -&gt; <code>Edit connection</code> -&gt; <code>Connection settings</code> -&gt; on the tabbed panel, select <code>PostgreSQL</code>, check the box <code>Show all databases</code>.</p> <p><strong>How do you view PostgreSQL messages (such as RAISE NOTICE) in DBeaver?</strong>
you can use Ctrl+Shif+O or the button Show server output console on the left side of the script window.</p></li></ul> <h4 id="drivers"><a href="#drivers" class="header-anchor">#</a> Drivers</h4> <ul><li>C# 连接 PostgreSQL --- Npgsql</li></ul> <h3 id="_1-3-utilities"><a href="#_1-3-utilities" class="header-anchor">#</a> 1.3 Utilities</h3> <ul><li>pg_ctl
pg_ctl status
<a href="https://seydikorurer.wordpress.com/2021/04/08/pg_ctl-start-stop-vs-systemctl-start-stop-postgresql-service/" target="_blank" rel="noopener noreferrer">pg_ctl start/stop vs systemctl start/stop postgresql.service<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>pg_dump</li></ul> <div class="language- extra-class"><pre class="language-text"><code>pg_dump -s dbName &gt; db_schema_dump.sql


# dump users
pg_dumpall --globals-only  --file=globals.sql

gzip -dc filename.bak.gz | psql -U postgres

</code></pre></div><ul><li><p>pg_basebackup 备份恢复
https://www.cnblogs.com/cqdba/p/15920508.html</p></li> <li><p>pgbench 官方压测</p></li></ul> <h3 id="_1-4-config"><a href="#_1-4-config" class="header-anchor">#</a> 1.4 Config</h3> <h4 id="理解一下posgresql的用户概念"><a href="#理解一下posgresql的用户概念" class="header-anchor">#</a> 理解一下posgresql的用户概念</h4> <p>the <code>postgres</code> PostgreSQL user account already exists and is configured to be accessible via <code>peer</code> authentication for unix sockets in <code>pg_hba.conf</code></p> <p>https://www.liquidweb.com/kb/what-is-the-default-password-for-postgresql/</p> <p>本机如果直接通过plsql连接，可以修改local用户(默认用户postgres)：</p> <p>https://www.hostinger.com/tutorials/how-to-install-postgresql-on-centos-7/</p> <div class="language- extra-class"><pre class="language-text"><code>psql -d template1 -c &quot;ALTER USER postgres WITH PASSWORD 'NewPassword';&quot;
</code></pre></div><p>https://stackoverflow.com/questions/18664074/getting-error-peer-authentication-failed-for-user-postgres-when-trying-to-ge</p> <h4 id="开启远程连接"><a href="#开启远程连接" class="header-anchor">#</a> 开启远程连接：</h4> <p>https://blog.csdn.net/zhangzeyuaaa/article/details/77941039</p> <div class="language- extra-class"><pre class="language-text"><code>step 1：开启监听：

vim /var/lib/pgsql/12/data/postgresql.conf

listen_addresses = '*'          # what IP address(es) to listen on;

step 2：修改访问规则, md5方式：

vim /var/lib/pgsql/12/data/pg_hba.conf 

host    all             all             0.0.0.0/0            md5

step 3：md5方式需要设置密码然后再重启：
su - postgres
$ psql -U postgres -p 5432
postgres=# \password postgres

systemctl restart  postgresql-12


https://stackoverflow.com/questions/6405127/how-do-i-specify-a-password-to-psql-non-interactively
PGPASSWORD=postgres psql --host IP --port 5432 -U postgres -d DBNAME -c &quot;query;&quot;
PGPASSWORD=postgres psql --host IP --port 5432 -U postgres -d DBNAME -f file.sql
</code></pre></div><h4 id="更改pgdata位置"><a href="#更改pgdata位置" class="header-anchor">#</a> 更改PGDATA位置</h4> <div class="language- extra-class"><pre class="language-text"><code># systemctl status postgresql-12.service
● postgresql-12.service - PostgreSQL 12 database server
   Loaded: loaded (/usr/lib/systemd/system/postgresql-12.service;

vi /usr/lib/systemd/system/postgresql-12.service 
# Location of database directory
Environment=PGDATA=/var/lib/pgsql/12/data/

mkdir pg_data_base
#careful, it's parent folder
rsync -av /var/lib/pgsql/12 pg_data_base/

mv /var/lib/pgsql/12/data /var/lib/pgsql/12/data-bk

vi /usr/lib/systemd/system/postgresql-12.service 
[Service]
Environment=PGDATA=/apex/data/pg_data_base/12/data/

systemctl daemon-reload
systemctl start postgresql-12.service


sudo -u postgres psql
SHOW data_directory;
</code></pre></div><h3 id="extension"><a href="#extension" class="header-anchor">#</a> Extension</h3> <p>dblink vs postgres_fdw</p> <h2 id="_2-syntax"><a href="#_2-syntax" class="header-anchor">#</a> 2. Syntax</h2> <p>Assign null or empty ‘’ to numberic,  to_number(‘’) throw exception, use if else instead
Bigint default value is NULL not 0</p> <h3 id="_2-1-basic"><a href="#_2-1-basic" class="header-anchor">#</a> 2.1 Basic</h3> <p>https://www.tutorialspoint.com/postgresql/index.htm</p> <p>https://www.postgresql.org/docs/10/app-psql.html</p> <p>表空间</p> <div class="language- extra-class"><pre class="language-text"><code>postgres=# select * from pg_tablespace;
 oid  |  spcname   | spcowner | spcacl | spcoptions
------+------------+----------+--------+------------
 1663 | pg_default |       10 |        |
 1664 | pg_global  |       10 |        |
(2 rows)
</code></pre></div><h4 id="system"><a href="#system" class="header-anchor">#</a> System</h4> <div class="language- extra-class"><pre class="language-text"><code>Oracle rownum / now(), sysdate	
postgresql: limit / now(), CURRENT_DATE

NULL and empty string:

Assign null or empty ‘’ to numberic,  to_number(‘’) throw exception, use if else instead
Bigint default value is NULL not 0
Oracle NVL()
PGSQL coalesce()

Returning into:

https://stackoverflow.com/questions/7191902/cannot-select-from-update-returning-clause-in-postgres
Oracle: SQL%ROWCOUNT
PG: GET DIAGNOSTICS integer_var = ROW_COUNT;
</code></pre></div><h4 id="data-format"><a href="#data-format" class="header-anchor">#</a> Data Format</h4> <p><strong>varchar to numeric</strong></p> <div class="language- extra-class"><pre class="language-text"><code>'12.01'::numeric
</code></pre></div><p><strong>Date</strong></p> <div class="language- extra-class"><pre class="language-text"><code>规范数据：
SELECT to_char('20230308 1:1:1.1'::timestamp, 'yyyymmdd HH24:MI:SS:MS'); =》 20230308 01:01:01:100
但是注意：  SELECT to_timestamp('20230308 1:1:1.1', 'yyyymmdd HH24:MI:SS:MS'); =》2023-03-08 01:01:01.100 带- 并不是我们想要的格式

select timestamp'20211227';
select to_timestamp('2021-12-24 05:00:00','yyyy-mm-dd hh24:mi:ss');
select cast(current_date-interval '4 day'+interval '5 hour' as text)::timestamp
'2013-08-20 14:52:49'::timestamp

to_timestamp('20/8/2013 14:52:49', 'DD/MM/YYYY hh24:mi:ss')
to_timestamp('20/8/2013 14:52:49', 'DD/MM/YYYY hh24:mi:ss')::timestamp
to_timestamp('20/8/2013 14:52:49', 'DD/MM/YYYY hh24:mi:ss') AT TIME ZONE 'UTC'

select to_timestamp(epoch_column)::date;

select to_char(current_date-1,'yyyymmdd');
select TO_CHAR(current_date+interval '5 hour','yyyy-mm-dd hh24:mi:ss')
select TO_CHAR(current_date+interval '5 hour'+'4 minute','yyyy-mm-dd hh24:mi:ss')
select to_char(current_date - interval '1' month, 'YYYYMM');

select extract(epoch FROM cast(current_date-interval '5 day'+interval '19 hour'+interval '1 minute' as text)::timestamp AT TIME ZONE 'SGT')::int

CURRENT_TIMESTAMP in milliseconds:
SELECT (extract(epoch from now())*1000)::bigint;

SELECT * FROM your-table
WHERE EXTRACT(MINUTE FROM begin_time) = '45'
</code></pre></div><p>ORACLE VS POSTGRES</p> <div class="language- extra-class"><pre class="language-text"><code>Oracle to_char(param)
postgresql 	to_char(parma1, ‘999’)

**Concat**
Character string connector (||) will fail in postgresql when there is ‘’ or null
concat()
Format	v_sql := format($$select * from table where col1=%s$$,’test’)

**Datetime**
Oracle to_date(str, ‘yyyy-mm-dd hh24:mi:ss’)
Postgresql to_timestamp(str, ‘yyyy-mm-dd hh24:mi:ss’)
select extract (day from timestamp '2011-01-01 01:01:01' - timestamp '2001-01-01 01:01:01');

 
</code></pre></div><p>https://www.postgresql.org/docs/9.1/functions-formatting.html</p> <p>https://www.postgresql.org/docs/9.1/static/functions-datetime.html</p> <p>https://thebuild.com/blog/2018/08/07/does-anyone-really-know-what-time-it-is/</p> <p>https://www.postgresql.org/docs/9.2/functions-datetime.html</p> <h4 id="tables-and-views"><a href="#tables-and-views" class="header-anchor">#</a> Tables and Views</h4> <p>The new query must generate the same columns that were generated by the existing view query (that is, the same column names in the same order and with the same data types) (...)</p> <h3 id="_2-2-crud"><a href="#_2-2-crud" class="header-anchor">#</a> 2.2 CRUD</h3> <h4 id="update-from-select-subquery"><a href="#update-from-select-subquery" class="header-anchor">#</a> update from select subquery</h4> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">UPDATE</span> <span class="token keyword">dummy</span>
<span class="token keyword">SET</span> customer<span class="token operator">=</span>subquery<span class="token punctuation">.</span>customer<span class="token punctuation">,</span>
    address<span class="token operator">=</span>subquery<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    partn<span class="token operator">=</span>subquery<span class="token punctuation">.</span>partn
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> address_id<span class="token punctuation">,</span> customer<span class="token punctuation">,</span> address<span class="token punctuation">,</span> partn
      <span class="token keyword">FROM</span>  <span class="token comment">/* big hairy SQL */</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> subquery
<span class="token keyword">WHERE</span> <span class="token keyword">dummy</span><span class="token punctuation">.</span>address_id<span class="token operator">=</span>subquery<span class="token punctuation">.</span>address_id<span class="token punctuation">;</span>

<span class="token operator">OR</span>

<span class="token keyword">WITH</span> subquery <span class="token keyword">AS</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> address_id<span class="token punctuation">,</span> customer<span class="token punctuation">,</span> address<span class="token punctuation">,</span> partn
    <span class="token keyword">FROM</span>  <span class="token comment">/* big hairy SQL */</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span>
<span class="token keyword">UPDATE</span> <span class="token keyword">dummy</span>
<span class="token keyword">SET</span> customer <span class="token operator">=</span> subquery<span class="token punctuation">.</span>customer<span class="token punctuation">,</span>
    address  <span class="token operator">=</span> subquery<span class="token punctuation">.</span>address<span class="token punctuation">,</span>
    partn    <span class="token operator">=</span> subquery<span class="token punctuation">.</span>partn
<span class="token keyword">FROM</span> subquery
<span class="token keyword">WHERE</span> <span class="token keyword">dummy</span><span class="token punctuation">.</span>address_id <span class="token operator">=</span> subquery<span class="token punctuation">.</span>address_id<span class="token punctuation">;</span>
</code></pre></div><h4 id="insert-or-update-if-exists"><a href="#insert-or-update-if-exists" class="header-anchor">#</a> insert or update if exists:</h4> <p>最简单的思路：</p> <div class="language- extra-class"><pre class="language-text"><code>if exists (select * from table where ...) then
	update
else
	insert
end if;
</code></pre></div><p>如果是基于primary key或index可以用 insert on conflict或者upsert：</p> <p>https://stackoverflow.com/questions/1109061/insert-on-duplicate-update-in-postgresql/1109198#1109198</p> <div class="language- extra-class"><pre class="language-text"><code>Oracle merge into
Pgsql insert into
https://www.postgresql.org/docs/9.5/static/sql-insert.html
insert into table1 as t1(col1,col2, col3)
select col1, col2,col3
from ( select col1,col2, max(col3) as col3
 from table2
 where col3 &gt;= date'2012-01-01'
 and col3 &lt;date'2013-01-01'
 and col1 is not null
 and col2 is not null
 group by col1, col2 ) a
on conflict(col1, col2) do
update set col3 = excluded.col3,
   	 col2 = case when excluded.col2 is null then t1.col2 else excluded.col2 end

</code></pre></div><p>For update</p> <h4 id="with-statement"><a href="#with-statement" class="header-anchor">#</a> WITH Statement</h4> <p><code>WITH</code> provides a way to write auxiliary statements for use in a larger query.</p> <div class="language- extra-class"><pre class="language-text"><code>WITH moved_rows AS (
		DELETE FROM t_bticoin_index
		WHERE index_time/1000&lt;=
		extract(epoch FROM cast(current_date-interval '7 day' as text)::timestamp AT TIME ZONE 'SGT')::int
		RETURNING index_name,index_value,index_time,server_time
	)
	INSERT INTO t_bticoin_index_hist
	SELECT * FROM moved_rows;
</code></pre></div><h3 id="_2-3-functions-stored-procedure"><a href="#_2-3-functions-stored-procedure" class="header-anchor">#</a> 2.3 Functions &amp; Stored Procedure</h3> <div class="language- extra-class"><pre class="language-text"><code>if condition_1 then
  statement_1;
elsif condition_2 then
  statement_2
...
elsif condition_n then
  statement_n;
else
  else-statement;
end if;
</code></pre></div><p>Use the right type, character to numeric
v_product := to_number(p_walletcode);</p> <p>Dont use FROM DUAL in procedrue</p> <p>Json</p> <p>Json array
https://stackoverflow.com/questions/24006291/postgresql-return-result-set-as-json-array/24006432</p> <p>PostgreSQL Error Codes:
array_length(array[1,2,3], 1) https://www.postgresql.org/docs/9.1/static/functions-array.html</p> <p><strong>Transaction</strong></p> <p>Cursor:
https://www.postgresql.org/docs/11/static/sql-call.html</p> <p>cannot commit while a subtransaction is active to_json</p> <p>https://hashrocket.com/blog/posts/faster-json-generation-with-postgresql
select row_to_json(t) from ( select id, text from words ) t</p> <p><strong>Functions</strong></p> <p>Perform function
https://stackoverflow.com/questions/18315633/calling-functions-with-exec-instead-of-select</p> <p><strong>Dynamic sql</strong>
https://stackoverflow.com/questions/12780275/dynamic-sql-query-in-postgres
execute immediate v_sql into v_count;</p> <p><strong>Cursor and fetch</strong>
https://www.postgresql.org/docs/9.3/static/sql-fetch.html
https://www.postgresql.org/docs/9.3/static/plpgsql-cursors.html
<img src="/docs/docs_image/software/postgresql/postgresql02.png" alt=""></p> <p><strong>Exception handling</strong>
https://www.postgresql.org/docs/8.2/static/plpgsql-statements.html
No data found
Select into strict</p> <div class="language- extra-class"><pre class="language-text"><code>SELECT * INTO myrec FROM emp WHERE empname = myname;
IF NOT FOUND THEN
	RAISE EXCEPTION 'employee % not found', myname;
END IF;
</code></pre></div><p>If the STRICT option is specified, the query must return exactly one row or a run-time error will be reported, either NO_DATA_FOUND (no rows) or TOO_MANY_ROWS (more than one row). You can use an exception block if you wish to catch the error, for example:</p> <div class="language- extra-class"><pre class="language-text"><code>BEGIN
    SELECT * INTO STRICT myrec FROM emp WHERE empname = myname;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE EXCEPTION 'employee % not found', myname;
        WHEN TOO_MANY_ROWS THEN
            RAISE EXCEPTION 'employee % not unique', myname;
END;
</code></pre></div><h4 id="generate-time-series"><a href="#generate-time-series" class="header-anchor">#</a> generate time series</h4> <p>https://www.postgresql.org/docs/9.1/functions-srf.html</p> <div class="language- extra-class"><pre class="language-text"><code>select 'btc',null,extract(epoch FROM index_time::timestamp AT TIME ZONE 'SGT')::int,(extract(epoch from now())*1000)::bigint
			from generate_series(cast(current_date-interval '1 day'+interval '19 hour'+interval '1 minute' as text)::timestamp AT TIME ZONE 'SGT', 
				cast(current_date+interval '5 hour' as text)::timestamp AT TIME ZONE 'SGT', 
				interval '1 minutes') as s(index_time)
			where index_time not in (select to_timestamp(index_time/1000) from t_bticoin_index_test)
			
查找缺失数据			
SELECT *
FROM generate_series('2022-01-14 12:00:00','2022-01-25 11:19:00', 
				interval '1 minutes') as s(index_time)		
where index_time not in (select to_timestamp(index_time/1000) from t_bticoin_index  where index_time/1000&gt;=
	extract(epoch FROM cast('2022-01-14 12:00:00' as text)::timestamp AT TIME ZONE 'SGT')::int);
</code></pre></div><h4 id="detect-fill-gaps"><a href="#detect-fill-gaps" class="header-anchor">#</a> detect &amp; fill gaps</h4> <div class="language-sql extra-class"><pre class="language-sql"><code>https:<span class="token comment">//www.jianshu.com/p/890137e60597</span>

    <span class="token keyword">update</span> temp_table
			<span class="token keyword">set</span> index_value<span class="token operator">=</span>t2<span class="token punctuation">.</span>index_value
			<span class="token keyword">from</span> <span class="token punctuation">(</span>
                <span class="token keyword">with</span> x <span class="token keyword">as</span> <span class="token punctuation">(</span>
                    <span class="token keyword">select</span>
                    index_time<span class="token punctuation">,</span>index_value<span class="token punctuation">,</span>
                    lead<span class="token punctuation">(</span>index_time<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>index_time<span class="token punctuation">)</span> <span class="token keyword">over</span><span class="token punctuation">(</span><span class="token keyword">order</span> <span class="token keyword">by</span> index_time<span class="token punctuation">)</span> <span class="token keyword">as</span> index_time1
                    <span class="token keyword">from</span>
                    <span class="token punctuation">(</span>
                        <span class="token keyword">select</span> index_time<span class="token punctuation">,</span>index_value
                        <span class="token keyword">from</span> temp_table
                        <span class="token keyword">where</span> index_value <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
                    <span class="token punctuation">)</span> o
                <span class="token punctuation">)</span>
                <span class="token keyword">select</span>
                    index_time<span class="token punctuation">,</span>index_value<span class="token punctuation">,</span>to_timestamp<span class="token punctuation">(</span>index_time<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span>
                    <span class="token keyword">from</span>
                    <span class="token punctuation">(</span>
                        <span class="token keyword">select</span> temp_table<span class="token punctuation">.</span>index_time<span class="token punctuation">,</span>x<span class="token punctuation">.</span>index_value
                        <span class="token keyword">from</span> temp_table<span class="token punctuation">,</span>x
                        <span class="token keyword">where</span> temp_table<span class="token punctuation">.</span>index_value <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token operator">and</span> <span class="token punctuation">(</span>temp_table<span class="token punctuation">.</span>index_time <span class="token operator">between</span> x<span class="token punctuation">.</span>index_time <span class="token operator">and</span> x<span class="token punctuation">.</span>index_time1<span class="token punctuation">)</span>

                        <span class="token keyword">union</span> <span class="token keyword">all</span>

                        <span class="token keyword">select</span> index_time<span class="token punctuation">,</span>index_value
                        <span class="token keyword">from</span> temp_table
                        <span class="token keyword">where</span> index_value <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>
                    <span class="token punctuation">)</span> t1
                    <span class="token keyword">order</span> <span class="token keyword">by</span>  index_time
            <span class="token punctuation">)</span><span class="token keyword">as</span> t2
			<span class="token keyword">where</span> temp_table<span class="token punctuation">.</span>index_time<span class="token operator">=</span>t2<span class="token punctuation">.</span>index_time<span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-4-trigger"><a href="#_2-4-trigger" class="header-anchor">#</a> 2.4 Trigger</h3> <p>A trigger function is created with the CREATE FUNCTION command, declaring it as a function with no arguments and a return type of trigger (for data change triggers) or event_trigger (for database event triggers). Special local variables named TG_something are automatically defined</p> <p>A trigger function must return either NULL or a record/row value having exactly the structure of the table the trigger was fired for.</p> <p>Example 1:
Row-level triggers fired BEFORE can return null to signal the trigger manager to skip the rest of the operation for this row (i.e., subsequent triggers are not fired, and the INSERT/UPDATE/DELETE does not occur for this row)</p> <p>This example trigger ensures that any insert, update or delete of a row in the emp table is recorded (i.e., audited) in the emp_audit table. The current time and user name are stamped into the row, together with the type of operation performed on it.</p> <div class="language- extra-class"><pre class="language-text"><code>CREATE TABLE emp (
    empname           text NOT NULL,
    salary            integer
);

CREATE TABLE emp_audit(
    operation         char(1)   NOT NULL,
    stamp             timestamp NOT NULL,
    userid            text      NOT NULL,
    empname           text      NOT NULL,
    salary integer
);

CREATE OR REPLACE FUNCTION process_emp_audit() RETURNS TRIGGER AS $emp_audit$
    BEGIN
        --
        -- Create a row in emp_audit to reflect the operation performed on emp,
        -- making use of the special variable TG_OP to work out the operation.
        --
        IF (TG_OP = 'DELETE') THEN
            INSERT INTO emp_audit SELECT 'D', now(), user, OLD.*;
        ELSIF (TG_OP = 'UPDATE') THEN
            INSERT INTO emp_audit SELECT 'U', now(), user, NEW.*;
        ELSIF (TG_OP = 'INSERT') THEN
            INSERT INTO emp_audit SELECT 'I', now(), user, NEW.*;
        END IF;
        RETURN NULL; -- result is ignored since this is an AFTER trigger
    END;
$emp_audit$ LANGUAGE plpgsql;

CREATE TRIGGER emp_audit
AFTER INSERT OR UPDATE OR DELETE ON emp
    FOR EACH ROW EXECUTE FUNCTION process_emp_audit();
</code></pre></div><p>Example 2:</p> <p>If a nonnull value is returned then the operation proceeds with that row value. Returning a row value different from the original value of NEW alters the row that will be inserted or updated. Thus, if the trigger function wants the triggering action to succeed normally without altering the row value, NEW (or a value equal thereto) has to be returned. To alter the row to be stored, it is possible to replace single values directly in NEW and return the modified NEW, or to build a complete new record/row to return. In the case of a before-trigger on DELETE, the returned value has no direct effect, but it has to be nonnull to allow the trigger action to proceed. Note that NEW is null in DELETE triggers, so returning that is usually not sensible. The usual idiom in DELETE triggers is to return OLD.</p> <p>This example trigger ensures that any time a row is inserted or updated in the table, the current user name and time are stamped into the row. And it checks that an employee's name is given and that the salary is a positive value.</p> <div class="language- extra-class"><pre class="language-text"><code>CREATE TABLE emp (
    empname text,
    salary integer,
    last_date timestamp,
    last_user text
);

CREATE FUNCTION emp_stamp() RETURNS trigger AS $emp_stamp$
    BEGIN
        -- Check that empname and salary are given
        IF NEW.empname IS NULL THEN
            RAISE EXCEPTION 'empname cannot be null';
        END IF;
        IF NEW.salary IS NULL THEN
            RAISE EXCEPTION '% cannot have null salary', NEW.empname;
        END IF;

        -- Who works for us when they must pay for it?
        IF NEW.salary &lt; 0 THEN
            RAISE EXCEPTION '% cannot have a negative salary', NEW.empname;
        END IF;

        -- Remember who changed the payroll when
        NEW.last_date := current_timestamp;
        NEW.last_user := current_user;
        RETURN NEW;
    END;
$emp_stamp$ LANGUAGE plpgsql;

CREATE TRIGGER emp_stamp BEFORE INSERT OR UPDATE ON emp
    FOR EACH ROW EXECUTE FUNCTION emp_stamp();
</code></pre></div><h3 id="_2-5-子表继承"><a href="#_2-5-子表继承" class="header-anchor">#</a> 2.5 子表继承</h3> <p>SELECT，UPDATE和DELETE--支持这个&quot;ONLY&quot;符号</p> <p>Similarly an inheritance link can be removed from a child using the NO INHERIT variant of ALTER TABLE. Dynamically adding and removing inheritance links like this can be useful when the inheritance relationship is being used for table partitioning (see Section 5.9)[https://www.postgresql.org/docs/12/ddl-partitioning.html].</p> <h3 id="_2-6-partition-分区"><a href="#_2-6-partition-分区" class="header-anchor">#</a> 2.6 Partition 分区</h3> <p>Inheritance Partitioning VS postgresl12 原生 built-in Declarative  Partitioning
https://www.postgresql.org/docs/12/ddl-partitioning.html#DDL-PARTITIONING-USING-INHERITANCE
https://www.postgresql.org/docs/12/ddl-partitioning.html#DDL-PARTITIONING-DECLARATIVE</p> <div class="language- extra-class"><pre class="language-text"><code>PARTITIONING-DECLARATIVE:
ALTER TABLE measurement DETACH PARTITION measurement_y2006m02;

PARTITIONING-USING-INHERITANCE:
ALTER TABLE measurement_y2006m02 NO INHERIT measurement;
</code></pre></div><p>注意，如果创建分区比如 measurement_y2006m02 之前插入的数据是在 父表 measurement里面，查询可以使用 ONLY 关键字</p> <p>https://www.postgresql.org/docs/current/plpgsql-trigger.html</p> <p>https://www.postgresql.org/docs/10/ddl-partitioning.html</p> <p>在 PostgreSQL 中，当使用 INHERITS 关键字创建一个表来继承另一个表时，子表会继承父表的列结构（但不包括约束、索引、外键等），并且你可以为子表添加自己的约束。但是，由于 INHERITS 不会自动继承约束，你需要在子表上显式地重新声明这些约束。</p> <p>然而，对于主键（PRIMARY KEY），情况有点特殊。PostgreSQL 不允许直接在子表上设置与父表相同列的主键约束，因为主键约束本质上是一个唯一约束加上一个非空约束，并且 PostgreSQL 不允许在不同的表上设置跨表的主键约束。但是，你可以通过 UNIQUE 约束和 NOT NULL 约束来模拟主键的行为。</p> <p>不过，在大多数情况下，如果父表已经有一个主键，并且子表想要使用相同的列作为唯一标识符，那么你可以简单地在子表上设置一个 UNIQUE 约束（尽管这不是严格意义上的主键，因为它不会被自动用作外键引用的目标）。但是，由于你已经知道 id 是自增的，并且父表已经将其作为主键，因此在子表中保持 id 的唯一性（并且不为空）是合理的。</p> <p>下面是一个例子，展示如何创建一个名为 employees2024 的子表，它继承自 employees 表，并且尝试模拟与 employees 表相同的 PRIMARY KEY、CHECK 和 UNIQUE 约束（注意，PRIMARY KEY 约束在子表中被模拟为 UNIQUE NOT NULL）：</p> <p>sql
CREATE TABLE employees2024 (
CHECK (id &gt;= (SELECT MAX(id) FROM employees) + 1)  -- 这是一个可选的CHECK约束，用于确保子表的id不会与父表冲突（但通常不推荐这样做，因为更好的做法是使用序列或生成器）
) INHERITS (employees);</p> <p>-- 由于我们不能直接继承主键约束，我们在这里添加一个UNIQUE约束来模拟主键的行为
-- 注意：这通常不是必需的，因为子表会继承id列，并且由于id是自增的，它自然会在子表中保持唯一
ALTER TABLE employees2024 ADD CONSTRAINT employees2024_pkey UNIQUE (id);</p> <p>-- 如果父表的CHECK和UNIQUE约束对于子表来说也是必要的，你通常不需要再次添加它们，
-- 因为子表已经继承了这些列的定义，并且可以在需要时依赖父表的约束。
-- 但是，如果你想要为子表添加额外的CHECK约束，你可以这样做：
ALTER TABLE employees2024 ADD CONSTRAINT employees2024_age_check CHECK (age &gt;= 20);  -- 例如，只接受20岁及以上的员工</p> <p>-- 注意：由于email在父表中已经是UNIQUE的，并且子表继承了email列，
-- 因此你不需要（也不能）在子表上再次添加UNIQUE约束到email列，
-- 因为这将违反UNIQUE约束的定义（即不能有重复的值）。
-- 但是，如果你想要对子表的email应用更严格的规则（尽管这通常不是必需的），
-- 你可能需要考虑使用触发器或更复杂的逻辑。</p> <p>然而，请注意以下几点：</p> <p>我添加了一个可选的 CHECK 约束来确保 employees2024 表的 id 不会与 employees 表的 id 冲突。然而，这通常不是一个好主意，因为更好的做法是使用序列或某种形式的ID生成器来确保ID的唯一性和连续性。</p> <p>我为 id 列添加了一个 UNIQUE 约束来模拟主键的行为。但是，请注意，这实际上是不必要的，因为 id 列在父表中已经是主键，并且子表会继承这个列。在大多数情况下，你可以依赖父表的主键约束来确保 id 的唯一性。</p> <p>对于 email 列，由于它在父表中已经是 UNIQUE 的，因此你不需要（也不能）在子表上再次添加 UNIQUE 约束。</p> <p>如果你想要为子表添加额外的 CHECK 约束，你可以像上面那样做。但是，请确保这些约束与父表的约束不冲突，并且它们对于子表来说是有意义的。</p> <h4 id="自动分区-继承分区"><a href="#自动分区-继承分区" class="header-anchor">#</a> 自动分区-继承分区</h4> <div class="language- extra-class"><pre class="language-text"><code>CREATE OR REPLACE FUNCTION public.pg_auto_insert_TABLE()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
declare
	partition_column_name	text ;
	strSQL	text;
	curMM	varchar(6);
	isExist	boolean;
	startTime	text;
	endTime	text;
begin
	partition_column_name := TG_ARGV[0];

	EXECUTE 'SELECT $1.'||partition_column_name INTO strSQL USING NEW;
	raise info 'strSQL:%',strSQL;
	curMM := to_char(to_timestamp(strSQL::BIGINT/1000), 'YYYYMM'); 
	raise info 'curMM:%',curMM;

	select count(*) INTO isExist from pg_class where relname = (TG_RELNAME||'_'||curMM);

    IF ( isExist = false ) THEN  
        startTime := curMM||'01 00:00:00.000';
        endTime := to_char(startTime::timestamp + interval '1 month', 'YYYY-MM-DD HH24:MI:SS.MS');
        strSQL := 'CREATE TABLE IF NOT EXISTS '||TG_RELNAME||'_'||curMM||
                  ' ( CHECK('||partition_column_name||'&gt;='''|| (extract(epoch FROM startTime::timestamp AT TIME ZONE 'SGT')*1000)::bigint ||''' AND '
                             ||partition_column_name||'&lt; '''|| (extract(epoch FROM endTime::timestamp AT TIME ZONE 'SGT')*1000)::bigint ||''' )
                          ) INHERITS ('||TG_RELNAME||') ;';  
        EXECUTE strSQL;

		strSQL := 'CREATE INDEX idx_time_'||curMM||' ON '
						  ||TG_RELNAME||'_'||curMM||' ('||partition_column_name||');';
		EXECUTE strSQL;
	
    END IF;

 	strSQL := 'INSERT INTO '||TG_RELNAME||'_'||curMM||' SELECT $1.*';
    EXECUTE strSQL USING NEW;
	RETURN NULL;
END;
$function$
;

CREATE TRIGGER insert_TABLE
BEFORE INSERT
ON t_TABLE
FOR EACH ROW
EXECUTE PROCEDURE pg_auto_insert_TABLE('index_time');

CREATE OR REPLACE FUNCTION public.pg_houseclean()
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
declare
result integer;
previous_month varchar;
strSql varchar;
begin
	select to_char(current_date - interval '1' month, 'YYYYMM') into previous_month;
	strSql :='ALTER TABLE t_TABLE_'||previous_month||' NO INHERIT t_TABLE;';
	raise info 'strSQL:%',strSql;
	EXECUTE strSql;
	select 100 into result;
	RETURN result;
END;
$function$
;

</code></pre></div><h3 id="_2-7-advanced"><a href="#_2-7-advanced" class="header-anchor">#</a> 2.7 Advanced</h3> <h4 id="index"><a href="#index" class="header-anchor">#</a> index</h4> <p>注意，跟mysql不同，postgresql的索引是schema级别的，不是table级别的，所以虽然是
create index IDX_NAME on TABLE(COLUMN) IDX_NAME也不能重复！
Indexes and tables (and views, and sequences, and...) are stored in the pg_class catalog, and they're unique per schema due to a unique key on it</p> <div class="language- extra-class"><pre class="language-text"><code>select * from pg_class c join pg_namespace ns on c.relnamespace = ns.oid where c.relname='idx_time_202204';
</code></pre></div><p>https://stackoverflow.com/questions/27306539/at-what-level-do-postgres-index-names-need-to-be-unique</p> <p>https://stackoverflow.com/questions/61408317/creating-multicolumn-indexes-in-postgresql#/</p> <h4 id="temp-table"><a href="#temp-table" class="header-anchor">#</a> Temp table</h4> <p>https://github.com/yallie/pg_global_temp_tables
<img src="/docs/docs_image/software/postgresql/postgresql03.png" alt=""></p> <p>https://stackoverflow.com/questions/41178844/are-temporary-tables-in-postgresql-visible-over-all-client-sessions</p> <h4 id="sequence"><a href="#sequence" class="header-anchor">#</a> Sequence</h4> <p>https://www.postgresql.org/docs/8.2/static/functions-sequence.html</p> <h4 id="customized-types"><a href="#customized-types" class="header-anchor">#</a> Customized Types</h4> <p>https://www.postgresql.org/docs/9.6/static/sql-createtype.html</p> <p>CREATE TYPE “XYZ” AS TABLE OF VARCHAR2(104) in postgresql https://stackoverflow.com/questions/24017175/create-type-xyz-as-table-of-varchar2104-in-postgresql</p> <p>Array[] as input
https://www.postgresql.org/docs/9.1/static/arrays.html
https://stackoverflow.com/questions/570393/postgres-integer-arrays-as-parameters</p> <p>https://stackoverflow.com/questions/3660787/how-to-list-custom-types-using-postgres-information-schema</p> <div class="language- extra-class"><pre class="language-text"><code>Oracle bulk collect into
Pgsql Offset 
/*CREATE TYPE t_my AS (
    col1    numeric(16,6),
    col2    numeric,
    col3 bpchar(36)
    );*/
    
do $$DECLARE   
c cursor(os int) for select * from table limit 5 offset os;
r record;
v_name varchar(100)[];
recs t_my[];
BEGIN

    select array (select row(0, col, 'aaa') from table1 limit 5 offset 10 ) into recs;
    --v_games:= array_to_string(v_name,',');
    raise notice '%', recs[1].col1;
END
$$;
</code></pre></div><h4 id="analysis"><a href="#analysis" class="header-anchor">#</a> Analysis</h4> <p>Window function
https://www.postgresql.org/docs/11/static/tutorial-window.html
https://gist.github.com/dialogbox/454380d6a68344556350bb8dbf1d64e5</p> <div class="language- extra-class"><pre class="language-text"><code>select  col1, col2, min(col3)  points
 from (select t1.col1, t1.col2,
        	first_value(col3) over w as col3  
        	from table1  t1
        	where t1.date &gt;= to_date('2018-01-01','yyyy-mm-dd')
        	and t1.date&lt;to_date('2018-07-01','yyyy-mm-dd')
        	window w AS(
   			 partition by col1,col2
   			 order by date desc
   		 )      	 
) t group by col1, col2
order by 1,2;
</code></pre></div><h4 id="dynamic-cursor"><a href="#dynamic-cursor" class="header-anchor">#</a> Dynamic cursor</h4> <div class="language- extra-class"><pre class="language-text"><code>In sp pg_test:
	INOUT results refcursor)
	results := 'cur';
_query_:=’select * from table’;
perform pg_dyncursor('cur', _query_);
Then in plsql:
	Begin
		Call pg_test();
	End;
FETCH ALL IN cur;
close cur;

CREATE OR REPLACE FUNCTION pg_dyncursor(cursor_name text, query text)
	RETURNS void
	LANGUAGE plpgsql
AS $function$
DECLARE
BEGIN 
	EXECUTE 'DECLARE' || quote_ident(cursor_name) || ' CURSOR WITH HOLD FOR ' || query;
END 
$function$
</code></pre></div><h4 id="scheduler"><a href="#scheduler" class="header-anchor">#</a> Scheduler</h4> <p>https://github.com/citusdata/pg_cron
https://crontab.guru/</p> <p>SELECT cron.schedule('0 2 * * *', $$TODO$$);
<img src="/docs/docs_image/software/postgresql/postgresql04.png" alt="">
https://www.pgadmin.org/docs/pgadmin3/1.22/pgagent.html</p> <h4 id="message-flow-protocol-flow"><a href="#message-flow-protocol-flow" class="header-anchor">#</a> Message Flow / Protocol Flow</h4> <p>https://www.postgresql.org/docs/11/static/protocol-flow.html
Simple query:
Recommended practice is to code frontends in a state-machine style that will accept any message type at any time that it could make sense, rather than wiring in assumptions about the exact sequence of messages
Extended query:</p> <h4 id="lock"><a href="#lock" class="header-anchor">#</a> Lock</h4> <p>https://www.postgresql.org/docs/current/explicit-locking.html</p> <ul><li>Table-Level Locks</li> <li>Row-Level Locks</li> <li>Page-Level Locks</li> <li>Deadlocks</li> <li>Advisory Locks</li></ul> <h3 id="system-table"><a href="#system-table" class="header-anchor">#</a> System Table</h3> <ul><li>db: postgres<div class="language- extra-class"><pre class="language-text"><code>  select * FROM information_schema.triggers

      SELECT pg_terminate_backend(pg_stat_activity.pid)
  FROM pg_stat_activity
  WHERE pg_stat_activity.datname = 'TARGET_DB' -- ← change this to your DB
  AND pid &lt;&gt; pg_backend_pid();
</code></pre></div></li> <li>db: template0</li> <li>db: template1</li></ul> <h3 id="gaps-between-oracle-plsql-and-postgresql"><a href="#gaps-between-oracle-plsql-and-postgresql" class="header-anchor">#</a> Gaps between Oracle PLSQL and PostgreSQL</h3> <p>https://github.com/digoal/blog/blob/master/201607/20160714_01.md</p> <p>https://wiki.postgresql.org/wiki/Oracle_to_Postgres_Conversion</p> <h4 id="oracle-keep-dense-rank-change-in-postgresql"><a href="#oracle-keep-dense-rank-change-in-postgresql" class="header-anchor">#</a> oracle keep dense_rank CHANGE in postgresql</h4> <p>https://www.eversql.com/rank-vs-dense_rank-vs-row_number-in-postgresql/</p> <h4 id="oracle-is-record-is-table-change-in-postgresql"><a href="#oracle-is-record-is-table-change-in-postgresql" class="header-anchor">#</a> oracle is record, is table CHANGE in postgresql</h4> <div class="language- extra-class"><pre class="language-text"><code>type rec_tk is record(
	tkno VARCHAR2(100),
	cg_zdj number(12, 0) := 0,
	cg_jsf number(12, 0) := 0
);
type tklist is table of rec_tk index by binary_integer;
</code></pre></div><p>修改为</p> <div class="language- extra-class"><pre class="language-text"><code>create type rec_tk as(
tkno VARCHAR(100),
cg_zdj numeric(12,0),
cg_jsf numeric(12,0)
);

#函数外执行创建类型的SQL
create type rec_cjr as(
cjrid varchar(30),
tk rec_tk[]
);
#函数内对table的使用修改为数组的使用，数组的下标从1开始
p_cjrs rec_cjr[];
</code></pre></div><h2 id="_3-backup-and-restore"><a href="#_3-backup-and-restore" class="header-anchor">#</a> 3. Backup and Restore</h2> <h3 id="full-backup-restore"><a href="#full-backup-restore" class="header-anchor">#</a> full backup restore</h3> <p>make sure all connections to db disconnected or systemctl restart</p> <p>pg_dump -Fc dbname &gt; outfile
psql dbname &lt; infile</p> <p>pg_dump dbname | gzip &gt; filename.gz
createdb dbname
gunzip -c filename.gz | psql dbname
pg_restore -d dbname /path-to-backup</p> <h3 id="incremental-backup-restore"><a href="#incremental-backup-restore" class="header-anchor">#</a> incremental backup restore</h3> <p><a href="https://www.postgresql.org/docs/current/continuous-archiving.html#/" target="_blank" rel="noopener noreferrer">Continuous Archiving and Point-in-Time Recovery (PITR) <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-continuous-archiving-and-perform-point-in-time-recovery-with-postgresql-12-on-ubuntu-20-04#/" target="_blank" rel="noopener noreferrer">How To Set Up Continuous Archiving and Perform Point-In-Time-Recovery with PostgreSQL 12 on Ubuntu 20.04<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_4-high-availability"><a href="#_4-high-availability" class="header-anchor">#</a> 4. High Availability</h2> <blockquote><p>Database servers can work together to allow a second server to take over quickly if the primary server fails (high availability), or to allow several computers to serve the same data (load balancing). Ideally, database servers could work together seamlessly. Web servers serving static web pages can be combined quite easily by merely load-balancing web requests to multiple machines. In fact, read-only database servers can be combined relatively easily too. Unfortunately, most database servers have a read/write mix of requests, and read/write servers are much harder to combine. This is because though read-only data needs to be placed on each server only once, a write to any server has to be propagated to all servers so that future read requests to those servers return consistent results.</p> <p>This synchronization problem is the fundamental difficulty for servers working together. Because there is no single solution that eliminates the impact of the sync problem for all use cases, there are multiple solutions. Each solution addresses this problem in a different way, and minimizes its impact for a specific workload.</p> <p>https://www.postgresql.org/docs/current/high-availability.html</p></blockquote> <h3 id="_4-1-replication不同方案"><a href="#_4-1-replication不同方案" class="header-anchor">#</a> 4.1 Replication不同方案：</h3> <p>https://www.postgresql.org/docs/current/different-replication-solutions.html</p> <ul><li>Shared Disk Failover：</li></ul> <p>​	Shared hardware functionality is common in network storage devices.</p> <ul><li>File System (Block Device) Replication</li></ul> <p>A modified version of shared hardware functionality</p> <p>DRBD is a popular file system replication solution for Linux.</p> <ul><li>Write-Ahead Log Shipping</li></ul> <p>A standby server can be implemented using file-based log shipping (<a href="https://www.postgresql.org/docs/current/warm-standby.html" target="_blank" rel="noopener noreferrer">Section 26.2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>) or streaming replication (see <a href="https://www.postgresql.org/docs/current/warm-standby.html#STREAMING-REPLICATION" target="_blank" rel="noopener noreferrer">Section 26.2.5<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>), or a combination of both. For information on hot standby, see <a href="https://www.postgresql.org/docs/current/hot-standby.html" target="_blank" rel="noopener noreferrer">Section 26.5<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <ul><li>Logical Replication</li></ul> <p>Allows a database server to send a stream of data modifications to another server.  <a href="https://www.postgresql.org/docs/current/logical-replication.html" target="_blank" rel="noopener noreferrer">Chapter 30<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.(<a href="https://www.postgresql.org/docs/current/logicaldecoding.html" target="_blank" rel="noopener noreferrer">Chapter 48<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>Trigger-Based Master-Standby Replication</li></ul> <p>The standby can answer read-only queries while the master server is running. The standby server is ideal for data warehouse queries.Slony-I is an example of this type of replication, with per-table granularity, and support for multiple standby servers. Because it updates the standby server asynchronously (in batches), there is possible data loss during fail over.</p> <ul><li>Statement-Based Replication Middleware</li></ul> <p>ach server operates independently. Read-write queries must be sent to all servers, so that every server receives any changes. But read-only queries can be sent to just one server, allowing the read workload to be distributed among them.Care must also be taken that all transactions either commit or abort on all servers, perhaps using two-phase commit (<a href="https://www.postgresql.org/docs/current/sql-prepare-transaction.html" target="_blank" rel="noopener noreferrer">PREPARE TRANSACTION<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://www.postgresql.org/docs/current/sql-commit-prepared.html" target="_blank" rel="noopener noreferrer">COMMIT PREPARED<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>). Pgpool-II and Continuent Tungsten are examples of this type of replication.</p> <ul><li>Asynchronous Multimaster Replication</li></ul> <p>each server works independently, and periodically communicates with the other servers to identify conflicting transactions. The conflicts can be resolved by users or conflict resolution rules. Bucardo is an example of this type of replication.</p> <ul><li>Synchronous Multimaster Replication</li></ul> <p>PostgreSQL does not offer this type of replication</p> <ul><li><p>Commercial Solutions</p></li> <li><p>Data Partitioning</p></li></ul> <p>Data partitioning splits tables into data sets. Each set can be modified by only one server. For example, data can be partitioned by offices, e.g., London and Paris,</p> <ul><li>Multiple-Server Parallel Query Execution</li></ul> <p>Many of the above solutions allow multiple servers to handle multiple queries, but none allow a single query to use multiple servers to complete faster. This solution allows multiple servers to work concurrently on a single query. It is usually accomplished by splitting the data among servers and having each server execute its part of the query and return results to a central server where they are combined and returned to the user.</p> <h3 id="_4-2-具体方案1-warm-standby-or-log-shipping"><a href="#_4-2-具体方案1-warm-standby-or-log-shipping" class="header-anchor">#</a> 4.2 具体方案1：warm standby or log shipping</h3> <p><a href="https://www.postgresql.org/docs/current/warm-standby.html" target="_blank" rel="noopener noreferrer">Log-Shipping Standby Servers #<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://medium.com/@PinkOwl/postgresql-and-me-log-shipping-replication-6bc945757822#/" target="_blank" rel="noopener noreferrer">PostgreSQL and SRE : Log Shipping Replication.<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>The primary server operates in continuous archiving mode, while each standby server operates in continuous recovery mode, reading the WAL(write ahead logging) files from the primary(Directly moving WAL records from one database server to another is typically described as log shipping).</p> <h3 id="_4-3-具体方案2-hot-standby"><a href="#_4-3-具体方案2-hot-standby" class="header-anchor">#</a> 4.3 具体方案2：hot standby</h3> <p>https://www.postgresql.org/docs/current/hot-standby.html</p> <h3 id="_4-4-具体配置-温备-热备"><a href="#_4-4-具体配置-温备-热备" class="header-anchor">#</a> 4.4 具体配置 温备/热备</h3> <p>http://www.mamicode.com/info-detail-2466322.html</p> <h2 id="_5-integreation-drivers"><a href="#_5-integreation-drivers" class="header-anchor">#</a> 5. Integreation - Drivers</h2> <p>download: https://jdbc.postgresql.org/download.html</p> <h3 id="_5-1-java"><a href="#_5-1-java" class="header-anchor">#</a> 5.1 Java</h3> <div class="language- extra-class"><pre class="language-text"><code>pom.xml:
&lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
        &lt;/dependency&gt;
        
application.yml:       
spring:
  ##Druid DataSource数据库访问配置
  datasource:
    #is-dynamic-datasource: true
    type: com.alibaba.druid.pool.DruidDataSource
    url: jdbc:postgresql://HOST:5432/test
    username: postgres
    password: postgres
    driver-class-name: org.postgresql.Driver
    druid:
      #连接池配置
      #初始化时建立物理连接的个数
      initialSize: 1
      #最小连接池数量
      minIdle: 0
      #最大连接池数量
      maxActive: 5
      #获取连接时最大等待时间，单位毫秒。配置了maxWait之后，缺省启用公平锁，并发效率会有所下降，
      #如果需要可以通过配置useUnfairLock属性为true使用非公平锁。
      maxWait: 60000
      #配置相隔多久进行一次检测(检测可以关闭的空闲连接),此处设置为1分钟检测一次。
      timeBetweenEvictionRunsMillis: 60000
      #一个连接在池中最小生存的时间(ms),此处设置为半小时。
      minEvictableIdleTimeMillis: 1800000
      #一个连接在池中最大生存的时间(ms),此处设置为7天。
      maxEvictableIdleTimeMillis: 25200000
      #用来检测连接是否有效的sql; 如果validationQuery为null，testOnBorrow、testOnReturn、testWhileIdle都不会启作用。
      validationQuery: SELECT 1 FROM DUAL
      #检测连接是否有效的超时时间,默认-1(单位:秒).
      validationQueryTimeout: 5
      #建议配置为true，不影响性能，并且保证安全性，申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，
      #执行validationQuery检测连接是否有效。
      testWhileIdle: true
      #申请连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。
      testOnBorrow: false
      #归还连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能
      testOnReturn: false
      #是否缓存preparedStatement，也就是PSCache;PSCache对支持游标的数据库性能提升巨大，比如说oracle;
      #在mysql5.5以下的版本中没有PSCache功能，建议关闭掉。
      poolPreparedStatements: true
      #打开PSCache，并且指定每个连接上PSCache的大小
      maxPoolPreparedStatementPerConnectionSize: 20
      sharePreparedStatements: false
      # 通过connectProperties属性来打开mergeSql功能；慢SQL记录
      #connectionProperties: druid.stat.mergeSql=true;druid.stat.logSlowSql=true;druid.stat.slowSqlMillis=5000
      # 配置监控统计拦截的filters，去掉后监控界面sql无法统计，'wall'用于防火墙
      filters: stat,wall,log4j2
      #要启用PSCache，必须配置大于0，当大于0时，poolPreparedStatements自动触发修改为true。
      #在Druid中，不会存在Oracle下PSCache占用内存过多的问题，可以把这个数值配置大一些，比如说100
      #此处默认为-1
      maxOpenPreparedStatements: 10
      #合并多个DruidDataSource的监控数据
      useGlobalDataSourceStat: true
      
      
@Service(&quot;jdbcService&quot;)
public class JdbcServiceImpl implements JdbcService{
    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    public DataSource dataSource;
    
    @Autowired
    JdbcTemplate jdbcTemplate;

    private Connection connection;

    public Connection getConnection() {
        try {
            if (connection == null || connection.isClosed()) {
                connection = initConnection();
            }
        } catch (SQLException e) {
            logger.error(&quot;Initialize connection failed: {}&quot;, e.getMessage(), e);
        }
        return connection;
    }

    public Connection initConnection(){
        Connection conn = null;
        try {
            conn = dataSource.getConnection();
            conn.setAutoCommit(false);
        } catch (SQLException e) {
            logger.error(&quot;Initialize connection failed: {}&quot;, e.getMessage(), e);
        }
        return conn;
    }


    @Override
    public void savetList(List&lt;Test&gt; list) {
        String sql = &quot;insert into t_table(col1,col2) select ?,?,?,? where not exists (select col1 from t_table where col1=?)&quot;;
        jdbcTemplate.batchUpdate(sql, list, 10000, new ParameterizedPreparedStatementSetter&lt;Test&gt;() {
            @Override
            public void setValues(java.sql.PreparedStatement ps, Test ac) throws SQLException {
                ps.setString(1, ac.getName());
                ps.setBigDecimal(2, ac.getValue());
            }
        });
    }

    @Override
    public void callPgFunction() {
        final SimpleJdbcCall jdbcCall = new SimpleJdbcCall(jdbcTemplate).withFunctionName(&quot;pg_calc_rate&quot;);
        final Map&lt;String, Object&gt; result = jdbcCall.execute();

        logger.info(&quot;jdbcCall result: {}&quot;,result.get(&quot;returnvalue&quot;));
    }

pg_calc_rate:

CREATE OR REPLACE FUNCTION public.pg_calc_rate()
	RETURNS integer
	LANGUAGE plpgsql
AS $$
declare
	v_condition integer := -100;
	v_product t_fundingrate.product%type := 'BTCP';
	v_session t_fundingrate.&quot;session&quot;%type := 'T+1';
	v_trade_date t_fundingrate.trade_date%type := to_char(current_date-1,'yyyymmdd');
	v_rate_type t_fundingrate.rate_type%type;
	v_funding_rate t_fundingrate.funding_rate%type;
	v_benchmark_price t_fundingrate.benchmark_price%type;
	result integer;
begin
	
	if not exists (select * from t_askbidprice where price_time/1000&gt;=extract(epoch FROM cast(current_date-interval '1 day'+interval '19 hour'+interval '1 minute' as text)::timestamp AT TIME ZONE 'SGT')::int
    and price_time/1000&lt;=extract(epoch FROM cast(current_date+interval '5 hour' as text)::timestamp AT TIME ZONE 'SGT')::int) then
		raise info 'Not exists impactmid data between [%,%]',cast(current_date-interval '1 day'+interval '19 hour'+interval '1 minute' as text)::timestamp,cast(current_date+interval '5 hour' as text)::timestamp;
		v_condition := -200;
	elsif not exists (select * from t_bticoin_index where index_time/1000&gt;=extract(epoch FROM cast(current_date-interval '1 day'+interval '19 hour'+interval '1 minute' as text)::timestamp AT TIME ZONE 'SGT')::int) then
		raise info 'Not exists bticoin_index data &gt;= %',cast(current_date-interval '1 day'+interval '19 hour'+interval '1 minute' as text)::timestamp;
    	v_condition := -100;
	elsif not exists (select * from t_bticoin_index where index_time/1000&gt;=extract(epoch FROM cast(current_date+interval '5 hour' as text)::timestamp AT TIME ZONE 'SGT')::int) then
    	raise info 'Not exists bticoin_index data &gt;= %',cast(current_date+interval '5 hour' as text)::timestamp;
    	raise info 'To generate Tentative funding rate';
    	v_condition := 0;
    	v_rate_type := 'Tentative'; 
    else
		raise info 'To generate Confirmed funding rate';
		v_condition := 100;
		v_rate_type := 'Confirmed';
	end if;

	if v_condition &gt;= 0 then
		
		select funding_rate,benchmark_price
		into v_funding_rate,v_benchmark_price
		from(
			select 
			avg((GREATEST(0::decimal,t2.impact_bid_price-t1.index_value)-GREATEST(0::decimal,t1.index_value-t2.impact_ask_price))/t1.index_value) as funding_rate,
			avg(t1.index_value) as benchmark_price
			from t_bticoin_index t1 
			inner join t_askbidprice t2 on t1.index_name=t2.product and t1.index_time=t2.price_time
			where t1.index_time/1000&lt;=
			extract(epoch FROM cast(current_date+interval '5 hour' as text)::timestamp AT TIME ZONE 'SGT')::int
			and t1.index_time/1000&gt;=
			extract(epoch FROM cast(current_date-interval '1 day'+interval '19 hour'+interval '1 minute' as text)::timestamp AT TIME ZONE 'SGT')::int
			group by t1.index_name
		) t;
		
		if exists (select * from t_fundingrate where product=v_product and &quot;session&quot;=v_session and trade_date=v_trade_date) then
			raise info 'Update exists record product=%,session=%,trade_date=%',v_product,v_session,v_trade_date;
			update t_fundingrate set funding_rate=v_funding_rate,remark=v_rate_type,rate_type=v_rate_type,publish_time=(extract(epoch from now())*1000)::bigint,benchmark_price=v_benchmark_price
			where product=v_product and &quot;session&quot;=v_session and trade_date=v_trade_date;
		else
			raise info 'Insert new record';
			insert into t_fundingrate
			(product, &quot;session&quot;, trade_date, funding_rate, remark, rate_type, publish_time, benchmark_price, currency)
				select v_product,v_session,v_trade_date, v_funding_rate,
				v_rate_type,v_rate_type,(extract(epoch from now())*1000)::bigint,v_benchmark_price,'USD';
		end if;
		
	end if;
	select v_condition into result;
    RETURN result;
END;
$$
;


</code></pre></div><h3 id="_5-2-net-npgsql"><a href="#_5-2-net-npgsql" class="header-anchor">#</a> 5.2 .NET npgsql</h3> <p>https://github.com/npgsql</p> <p><strong>about composite array</strong>
Normal Array</p> <p>Array of Composite Type (custom type)
Feature added in 4.0
http://www.npgsql.org/doc/release-notes/4.0.html
https://github.com/npgsql/npgsql/blob/fc1e183103ac6246bcb5d7ceacbf509e18248583/test/Npgsql.Tests/Types/CompositeTests.cs
https://github.com/npgsql/npgsql/commit/fc1e183103ac6246bcb5d7ceacbf509e18248583</p> <p>Composite
https://github.com/npgsql/npgsql/issues/1678</p> <p>Why do I get “Invalid attempt to call HasRows when reader is closed” with an open connection? https://stackoverflow.com/questions/13968342/why-do-i-get-invalid-attempt-to-call-hasrows-when-reader-is-closed-with-an-ope</p> <p><strong>about inout parameters in stored procedure</strong>
这个问题是我测试当时最新版本的postgresql并且用了最新的npgsql driver的时候遇到一个问题，
就是存储过程的inout参数拿不到返回结果，经过研究发现奇怪的行为：
1.通过更改npgsql的代码采用simple query这种不安全的协议就可以拿到结果；
2.但是用ngpsql自身默认的extend协议就拿不到；
后来跟ngpsql作者沟通，npgsql作者又跟pgsql的团队沟通，证明确实是pgsql的一个bug，沟通见下面我提的ticket：
INOUT parameters from Procedure
https://github.com/npgsql/npgsql/issues/2078
https://github.com/npgsql/npgsql/issues/2006</p> <p>下面是我思考并研究的大致过程，
大致思路就是我发现用某些pgsql客户端调用这种存储过程有返回，有些没有返回，比如pgadmin有返回，dbeaver没有返回，
所以就抓包pgadmin，对比通过npgsql调用的包，最后发现pgadmin是用simple query方式调用，
所以最终修改了npgsql驱动让其支持simple query，因为本身simple query就不安全，所以我没有给出代码，
当然如果有人感兴趣可以联系我</p> <p>Test Scripts</p> <div class="language- extra-class"><pre class="language-text"><code>call pg_test('9cc4afef-aab7-4c35-bdcd-a9f3d0152eb4','');

begin
call pg_test2('9cc4afef-aab7-4c35-bdcd-a9f3d0152eb4','');
fetch all in cur;
commit;
end

-- PROCEDURE: sgc2.pg_test(character varying, text)

-- DROP PROCEDURE sgc2.pg_test(character varying, text);

CREATE OR REPLACE PROCEDUREpg_test(
	userid character varying,
	INOUT results text)
LANGUAGE 'plpgsql'

AS $BODY$
DECLARE

BEGIN
	
	select cast(999 as decimal) as result;

END;
$BODY$;
</code></pre></div><p>c# code:</p> <div class="language- extra-class"><pre class="language-text"><code>public string Execute2(string spName, IEnumerable&lt;NpgsqlParameter&gt; parameters)
       {
           string result;
           try
           {
               using (var conn = new NpgsqlConnection(_connectionString))
               {
                   conn.Open();
                   List&lt;NpgsqlParameter&gt; _params = parameters.ToList();
                   using (var cmd = conn.CreateCommand())
                   {
                       _params.Add(new NpgsqlParameter(&quot;&quot;, &quot;&quot;)); // Add empty string for refcursor param
                       cmd.CommandText = BuildQuery(spName, _params);
                       //cmd.Parameters.Add(new NpgsqlParameter() { ParameterName = &quot;results&quot;, Direction = ParameterDirection.InputOutput, Value = &quot;&quot; });
                       var res = cmd.ExecuteScalar();
                       result = res?.ToString();
                  
                   }
                   //string sql = &quot;select pg_test3('9cc4afef-aab7-4c35-bdcd-a9f3d0152eb4');&quot;;
                   //var cmd2 = new NpgsqlCommand(sql, conn);
                   //var result2 = cmd2.ExecuteScalar();
                   //var test = JsonConvert.DeserializeObject&lt;ResultModel&gt;(result);
                   conn.Close();
               }
           }
           catch (Exception e)
           {
               _log.Exception(e);
               throw;
           }
           return result;
       }

</code></pre></div><p>debug output:
Check from Immediate window
System.Text.Encoding.Default.GetString(Buffer)</p> <p><img src="/docs/docs_image/software/postgresql/postgresql05.png" alt=""></p> <p>然后用wireshark抓包请求call sp之后的返回
<img src="/docs/docs_image/software/postgresql/postgresql06.png" alt=""></p> <p>Failed idea: Compare with SP which has return value(refcursor)
Not what I want!
<img src="/docs/docs_image/software/postgresql/postgresql07.png" alt=""></p> <p>Idea: compare with pgadmin4, because pgadmin4 works!
<img src="/docs/docs_image/software/postgresql/postgresql08.png" alt=""></p> <p>改源码 simple query
<img src="/docs/docs_image/software/postgresql/postgresql09.png" alt="">
有返回，离成功近了</p> <p>但是npg抛错
<img src="/docs/docs_image/software/postgresql/postgresql10.png" alt=""></p> <p>Idea: Compare with simple function( and procedure) to observer the result
<img src="/docs/docs_image/software/postgresql/postgresql11.png" alt=""></p> <p>最终
<img src="/docs/docs_image/software/postgresql/postgresql12.png" alt=""></p> <p>Nuget
Update-Package –reinstall
https://docs.microsoft.com/en-us/nuget/consume-packages/reinstalling-and-updating-packages</p> <p>Simple query
https://www.postgresql.org/docs/10/static/protocol-flow.html#id-1.10.5.7.4
Message flow
https://www.postgresql.org/docs/10/static/protocol-flow.html</p> <p>Explain
https://www.postgresql.org/docs/9.5/static/sql-explain.html</p> <p>Refer
https://www.asciitable.com</p> <h2 id="_6-monitor"><a href="#_6-monitor" class="header-anchor">#</a> 6. Monitor</h2> <h3 id="simple-way-use-postgres-exporter"><a href="#simple-way-use-postgres-exporter" class="header-anchor">#</a> simple way: use postgres exporter</h3> <p>https://github.com/prometheus-community/postgres_exporter#/</p> <div class="language- extra-class"><pre class="language-text"><code>nohup sudo -u postgres DATA_SOURCE_NAME=&quot;user=postgres host=/var/run/postgresql/ sslmode=disable&quot; ./postgres_exporter &amp;
</code></pre></div><h2 id="troubleshooting"><a href="#troubleshooting" class="header-anchor">#</a> Troubleshooting</h2> <p>删除“重复”的function或stored procedure，比如：bpchar和varchar：
<img src="/docs/docs_image/software/postgresql/postgresql01.png" alt=""></p> <p>psql: error: FATAL: Ident authentication failed
To configure IDENT authentication, add entries to the /etc/postgresql/12/main/pg_ident.conf file. There are detailed comments in the file to guide you.</p> <p>?# can't start postgres</p> <p>postmaster[22235]: 2024-05-25 14:48:24.000 +08 [22235] FATAL:  data directory &quot;/test/data&quot; has invalid permissions
postmaster[22235]: 2024-05-25 14:48:24.000 +08 [22235] DETAIL:  Permissions should be u=rwx (0700) or u=rwx,g=rx (0750).</p> <h2 id="todo"><a href="#todo" class="header-anchor">#</a> todo</h2> <div class="language- extra-class"><pre class="language-text"><code>CREATE OR REPLACE FUNCTION public.pg_calc_nightsession_funding_rate()
 RETURNS integer
 LANGUAGE plpgsql
AS $function$
declare
	v_condition integer := -100;
	v_nightsession_flag boolean := false;
	v_from_timestamp integer;
	v_to_timestamp integer;
	v_total_points_count integer;
	v_instrument t_fundingrate.instrument%type := 'BTCP';
	v_session t_fundingrate.&quot;session&quot;%type := 'T';
	v_trade_date t_fundingrate.trade_date%type := to_char(current_date,'yyyymmdd');
	v_rate_type t_fundingrate.rate_type%type;
	v_funding_rate t_fundingrate.funding_rate%type;
	v_benchmark_price t_fundingrate.benchmark_price%type;
	result integer;
begin
	if CURRENT_TIMESTAMP&gt;=cast(current_date+interval '19 hour'+interval '1 minute' as text)::timestamp then
		v_nightsession_flag := true;
	end if;
	
	if v_nightsession_flag then
		v_from_timestamp := extract(epoch from cast(current_date+interval '19 hour'+interval '1 minute' as text)::timestamp AT TIME ZONE 'SGT')::int;
		v_to_timestamp := extract(epoch from now())::int;
	else
		v_from_timestamp := extract(epoch from cast(current_date-interval '1 day'+interval '19 hour'+interval '1 minute' as text)::timestamp AT TIME ZONE 'SGT')::int;
		v_to_timestamp := extract(epoch from cast(current_date+interval '5 hour' as text)::timestamp AT TIME ZONE 'SGT')::int;
	end if;

	if extract(dow from current_date)::int = 5 and v_nightsession_flag then
		v_trade_date := to_char(current_date+3,'yyyymmdd');
		raise info 'Next trading date is %',v_trade_date;
	elsif extract(dow from current_date)::int = 6 then
		v_trade_date := to_char(current_date+2,'yyyymmdd');
		raise info 'Next trading date is %',v_trade_date;
	end if;
	
	if not exists (select * from t_impactmid where price_time/1000&gt;=v_from_timestamp and price_time/1000&lt;=v_to_timestamp) then
		raise info 'Not exists impactmid data between [%,%]',v_from_timestamp,v_to_timestamp;
		v_condition := -200;
	elsif not exists (select * from t_bticoin_index where index_time/1000&gt;=v_from_timestamp) then
		raise info 'Not exists bticoin_index data &gt;= %',v_from_timestamp;
    	v_condition := -100;
	elsif v_nightsession_flag or not exists (select * from t_bticoin_index where index_time/1000&gt;=v_to_timestamp) then
    	raise info 'To generate Tentative funding rate';
    	v_condition := 0;
    	v_rate_type := 'Tentative'; 
    else
    	select count(1) into v_total_points_count from t_bticoin_index 
		where extract(second from to_timestamp(index_time/1000)) = '00' 
			and index_time/1000&lt;=v_to_timestamp
			and index_time/1000&gt;=v_from_timestamp;
    	if v_total_points_count &lt;= 300 then
			raise info 'bticoin_index data is less than 50 percent';
			v_condition := -300;
		else
			raise info 'To generate Confirmed funding rate';
			v_condition := 100;
			v_rate_type := 'Confirmed';
		end if;
	end if;

	if v_condition &gt;= 0 then
		
		select funding_rate,benchmark_price
		into v_funding_rate,v_benchmark_price
		from(
			select 
			avg((GREATEST(0::decimal,t2.impact_bid_price-t1.index_value)-GREATEST(0::decimal,t1.index_value-t2.impact_ask_price))/t1.index_value) as funding_rate,
			avg(t1.index_value) as benchmark_price
			from t_bticoin_index t1 
			inner join t_impactmid t2 on t1.index_name=t2.instrument and t1.index_time=t2.price_time
			where t1.index_time/1000&lt;=v_to_timestamp and t1.index_time/1000&gt;=v_from_timestamp
			group by t1.index_name
		) t;
		
		if exists (select * from t_fundingrate where instrument=v_instrument and &quot;session&quot;=v_session and trade_date=v_trade_date) then
			raise info 'Update exists record instrument=%,session=%,trade_date=%',v_instrument,v_session,v_trade_date;
			update t_fundingrate set funding_rate=v_funding_rate,remark=v_rate_type,rate_type=v_rate_type,publish_time=(extract(epoch from now())*1000)::bigint,benchmark_price=v_benchmark_price
			where instrument=v_instrument and &quot;session&quot;=v_session and trade_date=v_trade_date;
		else
			raise info 'Insert new record';
			insert into t_fundingrate
			(instrument, &quot;session&quot;, trade_date, funding_rate, remark, rate_type, publish_time, benchmark_price, currency)
				select v_instrument,v_session,v_trade_date, v_funding_rate,
				v_rate_type,v_rate_type,(extract(epoch from now())*1000)::bigint,v_benchmark_price,'USD';
		end if;
		
	end if;
	select v_condition into result;
    RETURN result;
END;
$function$
;

</code></pre></div><p>refer:</p> <p>https://www.tutorialspoint.com/postgresql/index.htm
https://serverfault.com/questions/110154/whats-the-default-superuser-username-password-for-postgres-after-a-new-install</p> <p>https://serverfault.com/questions/110154/whats-the-default-superuser-username-password-for-postgres-after-a-new-install</p> <p>10个使用POSTGRESQL 需要避免的错误
https://mp.weixin.qq.com/s/DD27oiNL7_qNzgHN6S0XJw</p> <div id="disqus_thread"></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.ebea2df2.js" defer></script><script src="/docs/assets/js/2.d450803a.js" defer></script><script src="/docs/assets/js/207.234e9c3f.js" defer></script><script src="/docs/assets/js/7.be017326.js" defer></script>
  </body>
</html>
