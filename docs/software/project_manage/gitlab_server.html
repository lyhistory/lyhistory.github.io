<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机基础教程</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9742852210287449" crossorigin="anonymous"></script>
    <script>
			(function() { // DON'T EDIT BELOW THIS LINE
			
			})();
		 </script>
    <meta name="description" content="软件开发教程，白帽黑客入门教程，区块链入门教程，物联网，大数据">
    
    <link rel="preload" href="/docs/assets/css/0.styles.229beafb.css" as="style"><link rel="preload" href="/docs/assets/js/app.ab354e0d.js" as="script"><link rel="preload" href="/docs/assets/js/2.19baf9f4.js" as="script"><link rel="preload" href="/docs/assets/js/248.7deda9d9.js" as="script"><link rel="preload" href="/docs/assets/js/11.0d0890d4.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.544f9778.js"><link rel="prefetch" href="/docs/assets/js/100.03a3f4ed.js"><link rel="prefetch" href="/docs/assets/js/101.f0a89778.js"><link rel="prefetch" href="/docs/assets/js/102.9103bdfa.js"><link rel="prefetch" href="/docs/assets/js/103.f71a976b.js"><link rel="prefetch" href="/docs/assets/js/104.0d29647b.js"><link rel="prefetch" href="/docs/assets/js/105.304c852d.js"><link rel="prefetch" href="/docs/assets/js/106.a737ec10.js"><link rel="prefetch" href="/docs/assets/js/107.832a7270.js"><link rel="prefetch" href="/docs/assets/js/108.98b689b3.js"><link rel="prefetch" href="/docs/assets/js/109.6fccacee.js"><link rel="prefetch" href="/docs/assets/js/110.563bb137.js"><link rel="prefetch" href="/docs/assets/js/111.9c77f708.js"><link rel="prefetch" href="/docs/assets/js/112.9039c2de.js"><link rel="prefetch" href="/docs/assets/js/113.c3ed30ee.js"><link rel="prefetch" href="/docs/assets/js/114.00712d1f.js"><link rel="prefetch" href="/docs/assets/js/115.30d6dd0f.js"><link rel="prefetch" href="/docs/assets/js/116.7a9aedd0.js"><link rel="prefetch" href="/docs/assets/js/117.43d8c699.js"><link rel="prefetch" href="/docs/assets/js/118.84461f6f.js"><link rel="prefetch" href="/docs/assets/js/119.db965497.js"><link rel="prefetch" href="/docs/assets/js/12.eec9a325.js"><link rel="prefetch" href="/docs/assets/js/120.2b3a2fb7.js"><link rel="prefetch" href="/docs/assets/js/121.f069dd68.js"><link rel="prefetch" href="/docs/assets/js/122.b74254bd.js"><link rel="prefetch" href="/docs/assets/js/123.06c38829.js"><link rel="prefetch" href="/docs/assets/js/124.3ed93386.js"><link rel="prefetch" href="/docs/assets/js/125.86e280f8.js"><link rel="prefetch" href="/docs/assets/js/126.84f38ee3.js"><link rel="prefetch" href="/docs/assets/js/127.b7f61fcb.js"><link rel="prefetch" href="/docs/assets/js/128.816ac85e.js"><link rel="prefetch" href="/docs/assets/js/129.b25d36eb.js"><link rel="prefetch" href="/docs/assets/js/13.db96c782.js"><link rel="prefetch" href="/docs/assets/js/130.03e724c6.js"><link rel="prefetch" href="/docs/assets/js/131.7491a0d4.js"><link rel="prefetch" href="/docs/assets/js/132.011846a5.js"><link rel="prefetch" href="/docs/assets/js/133.3e0a5511.js"><link rel="prefetch" href="/docs/assets/js/134.87b9d928.js"><link rel="prefetch" href="/docs/assets/js/135.d3223ddf.js"><link rel="prefetch" href="/docs/assets/js/136.b3602998.js"><link rel="prefetch" href="/docs/assets/js/137.cace7ca0.js"><link rel="prefetch" href="/docs/assets/js/138.525aa3a3.js"><link rel="prefetch" href="/docs/assets/js/139.56f4e03e.js"><link rel="prefetch" href="/docs/assets/js/14.e6cc47db.js"><link rel="prefetch" href="/docs/assets/js/140.531cad92.js"><link rel="prefetch" href="/docs/assets/js/141.05741e04.js"><link rel="prefetch" href="/docs/assets/js/142.4b120200.js"><link rel="prefetch" href="/docs/assets/js/143.755c6a6e.js"><link rel="prefetch" href="/docs/assets/js/144.0482de25.js"><link rel="prefetch" href="/docs/assets/js/145.2e81bbe9.js"><link rel="prefetch" href="/docs/assets/js/146.c5f86257.js"><link rel="prefetch" href="/docs/assets/js/147.46ebb116.js"><link rel="prefetch" href="/docs/assets/js/148.12da1cd0.js"><link rel="prefetch" href="/docs/assets/js/149.41763d39.js"><link rel="prefetch" href="/docs/assets/js/15.2b294b69.js"><link rel="prefetch" href="/docs/assets/js/150.5a75afe8.js"><link rel="prefetch" href="/docs/assets/js/151.1f7f14bf.js"><link rel="prefetch" href="/docs/assets/js/152.0269a87d.js"><link rel="prefetch" href="/docs/assets/js/153.eea1b576.js"><link rel="prefetch" href="/docs/assets/js/154.330f4ddf.js"><link rel="prefetch" href="/docs/assets/js/155.6ee9e269.js"><link rel="prefetch" href="/docs/assets/js/156.a7b5f28e.js"><link rel="prefetch" href="/docs/assets/js/157.f92c54a7.js"><link rel="prefetch" href="/docs/assets/js/158.ba3961f6.js"><link rel="prefetch" href="/docs/assets/js/159.ca91f780.js"><link rel="prefetch" href="/docs/assets/js/16.363b25ef.js"><link rel="prefetch" href="/docs/assets/js/160.a7d9c2a9.js"><link rel="prefetch" href="/docs/assets/js/161.8460bc90.js"><link rel="prefetch" href="/docs/assets/js/162.74b1d5e8.js"><link rel="prefetch" href="/docs/assets/js/163.810514fb.js"><link rel="prefetch" href="/docs/assets/js/164.11c0883d.js"><link rel="prefetch" href="/docs/assets/js/165.61e36fff.js"><link rel="prefetch" href="/docs/assets/js/166.15668d2d.js"><link rel="prefetch" href="/docs/assets/js/167.cba9dc3a.js"><link rel="prefetch" href="/docs/assets/js/168.00393f66.js"><link rel="prefetch" href="/docs/assets/js/169.487e9faa.js"><link rel="prefetch" href="/docs/assets/js/17.4aee462d.js"><link rel="prefetch" href="/docs/assets/js/170.03319f09.js"><link rel="prefetch" href="/docs/assets/js/171.eefcc2f4.js"><link rel="prefetch" href="/docs/assets/js/172.d0879072.js"><link rel="prefetch" href="/docs/assets/js/173.a8a4cc2f.js"><link rel="prefetch" href="/docs/assets/js/174.bee5e15a.js"><link rel="prefetch" href="/docs/assets/js/175.25b3fdeb.js"><link rel="prefetch" href="/docs/assets/js/176.7db08715.js"><link rel="prefetch" href="/docs/assets/js/177.a655656e.js"><link rel="prefetch" href="/docs/assets/js/178.1e31a2ab.js"><link rel="prefetch" href="/docs/assets/js/179.058f4d25.js"><link rel="prefetch" href="/docs/assets/js/18.e594987e.js"><link rel="prefetch" href="/docs/assets/js/180.37a6ece9.js"><link rel="prefetch" href="/docs/assets/js/181.ab5a6791.js"><link rel="prefetch" href="/docs/assets/js/182.2badad08.js"><link rel="prefetch" href="/docs/assets/js/183.32b3bc9b.js"><link rel="prefetch" href="/docs/assets/js/184.ac3efa21.js"><link rel="prefetch" href="/docs/assets/js/185.c0f1abf2.js"><link rel="prefetch" href="/docs/assets/js/186.389e2566.js"><link rel="prefetch" href="/docs/assets/js/187.8c20c74b.js"><link rel="prefetch" href="/docs/assets/js/188.7129869d.js"><link rel="prefetch" href="/docs/assets/js/189.1839c02a.js"><link rel="prefetch" href="/docs/assets/js/19.1e72894c.js"><link rel="prefetch" href="/docs/assets/js/190.72c23005.js"><link rel="prefetch" href="/docs/assets/js/191.d3a6d3e3.js"><link rel="prefetch" href="/docs/assets/js/192.4cba59af.js"><link rel="prefetch" href="/docs/assets/js/193.bed46c2d.js"><link rel="prefetch" href="/docs/assets/js/194.51d2484e.js"><link rel="prefetch" href="/docs/assets/js/195.b44fe6d2.js"><link rel="prefetch" href="/docs/assets/js/196.b9ff5f03.js"><link rel="prefetch" href="/docs/assets/js/197.f1b43a16.js"><link rel="prefetch" href="/docs/assets/js/198.c4637880.js"><link rel="prefetch" href="/docs/assets/js/199.10af4f21.js"><link rel="prefetch" href="/docs/assets/js/20.42217007.js"><link rel="prefetch" href="/docs/assets/js/200.08e5a208.js"><link rel="prefetch" href="/docs/assets/js/201.bb5caa99.js"><link rel="prefetch" href="/docs/assets/js/202.b8c612f2.js"><link rel="prefetch" href="/docs/assets/js/203.3f5a2a8b.js"><link rel="prefetch" href="/docs/assets/js/204.3c3eef65.js"><link rel="prefetch" href="/docs/assets/js/205.1d7534d4.js"><link rel="prefetch" href="/docs/assets/js/206.1562ea2e.js"><link rel="prefetch" href="/docs/assets/js/207.994ca815.js"><link rel="prefetch" href="/docs/assets/js/208.eca5285d.js"><link rel="prefetch" href="/docs/assets/js/209.7d09e86b.js"><link rel="prefetch" href="/docs/assets/js/21.3b03538c.js"><link rel="prefetch" href="/docs/assets/js/210.3a75aa48.js"><link rel="prefetch" href="/docs/assets/js/211.3b087663.js"><link rel="prefetch" href="/docs/assets/js/212.0717eaee.js"><link rel="prefetch" href="/docs/assets/js/213.4585c392.js"><link rel="prefetch" href="/docs/assets/js/214.d8a4686e.js"><link rel="prefetch" href="/docs/assets/js/215.dfde4794.js"><link rel="prefetch" href="/docs/assets/js/216.c17c8167.js"><link rel="prefetch" href="/docs/assets/js/217.795cb040.js"><link rel="prefetch" href="/docs/assets/js/218.317cfe49.js"><link rel="prefetch" href="/docs/assets/js/219.347017fa.js"><link rel="prefetch" href="/docs/assets/js/22.6f660d16.js"><link rel="prefetch" href="/docs/assets/js/220.9d47b0bb.js"><link rel="prefetch" href="/docs/assets/js/221.ab1d6f6f.js"><link rel="prefetch" href="/docs/assets/js/222.fdd9c70e.js"><link rel="prefetch" href="/docs/assets/js/223.1d9c35ca.js"><link rel="prefetch" href="/docs/assets/js/224.7c2e4636.js"><link rel="prefetch" href="/docs/assets/js/225.229d7dc2.js"><link rel="prefetch" href="/docs/assets/js/226.50e5a740.js"><link rel="prefetch" href="/docs/assets/js/227.02990811.js"><link rel="prefetch" href="/docs/assets/js/228.a047fc9f.js"><link rel="prefetch" href="/docs/assets/js/229.12217dff.js"><link rel="prefetch" href="/docs/assets/js/23.8e35944a.js"><link rel="prefetch" href="/docs/assets/js/230.ea1ca2b7.js"><link rel="prefetch" href="/docs/assets/js/231.aac6a2d3.js"><link rel="prefetch" href="/docs/assets/js/232.58bef0c5.js"><link rel="prefetch" href="/docs/assets/js/233.e9568b2f.js"><link rel="prefetch" href="/docs/assets/js/234.28478fbe.js"><link rel="prefetch" href="/docs/assets/js/235.77cae8bf.js"><link rel="prefetch" href="/docs/assets/js/236.212054e3.js"><link rel="prefetch" href="/docs/assets/js/237.4c259c9e.js"><link rel="prefetch" href="/docs/assets/js/238.d98ce1ff.js"><link rel="prefetch" href="/docs/assets/js/239.b3fb3485.js"><link rel="prefetch" href="/docs/assets/js/24.b95986d3.js"><link rel="prefetch" href="/docs/assets/js/240.22e2c729.js"><link rel="prefetch" href="/docs/assets/js/241.8fffe296.js"><link rel="prefetch" href="/docs/assets/js/242.f259b551.js"><link rel="prefetch" href="/docs/assets/js/243.a41b2e60.js"><link rel="prefetch" href="/docs/assets/js/244.239365ce.js"><link rel="prefetch" href="/docs/assets/js/245.d03a2f1f.js"><link rel="prefetch" href="/docs/assets/js/246.ad4bac44.js"><link rel="prefetch" href="/docs/assets/js/247.a281f672.js"><link rel="prefetch" href="/docs/assets/js/249.f179bfca.js"><link rel="prefetch" href="/docs/assets/js/25.b7e0ea71.js"><link rel="prefetch" href="/docs/assets/js/250.fc4de8e6.js"><link rel="prefetch" href="/docs/assets/js/251.0e44f430.js"><link rel="prefetch" href="/docs/assets/js/252.0f1cd4c6.js"><link rel="prefetch" href="/docs/assets/js/253.614ba28b.js"><link rel="prefetch" href="/docs/assets/js/254.ee62425c.js"><link rel="prefetch" href="/docs/assets/js/255.bc2a3f59.js"><link rel="prefetch" href="/docs/assets/js/256.5ad6986c.js"><link rel="prefetch" href="/docs/assets/js/257.0d57494a.js"><link rel="prefetch" href="/docs/assets/js/258.bfb7b1fe.js"><link rel="prefetch" href="/docs/assets/js/259.d096ed6e.js"><link rel="prefetch" href="/docs/assets/js/26.eae5142a.js"><link rel="prefetch" href="/docs/assets/js/260.b5fbc04a.js"><link rel="prefetch" href="/docs/assets/js/261.cfffcbe2.js"><link rel="prefetch" href="/docs/assets/js/262.1920110e.js"><link rel="prefetch" href="/docs/assets/js/263.ad76d688.js"><link rel="prefetch" href="/docs/assets/js/264.b836fd33.js"><link rel="prefetch" href="/docs/assets/js/265.621a51c9.js"><link rel="prefetch" href="/docs/assets/js/27.6c579ad7.js"><link rel="prefetch" href="/docs/assets/js/28.93a82256.js"><link rel="prefetch" href="/docs/assets/js/29.2b785e76.js"><link rel="prefetch" href="/docs/assets/js/3.c9f8b081.js"><link rel="prefetch" href="/docs/assets/js/30.3b5b0cca.js"><link rel="prefetch" href="/docs/assets/js/31.90abc299.js"><link rel="prefetch" href="/docs/assets/js/32.7a1549b3.js"><link rel="prefetch" href="/docs/assets/js/33.9c3b3235.js"><link rel="prefetch" href="/docs/assets/js/34.b3a516a7.js"><link rel="prefetch" href="/docs/assets/js/35.c06a5f71.js"><link rel="prefetch" href="/docs/assets/js/36.66db0a7a.js"><link rel="prefetch" href="/docs/assets/js/37.65e9178d.js"><link rel="prefetch" href="/docs/assets/js/38.1d011454.js"><link rel="prefetch" href="/docs/assets/js/39.633d7280.js"><link rel="prefetch" href="/docs/assets/js/4.00ac3130.js"><link rel="prefetch" href="/docs/assets/js/40.c4f77b7b.js"><link rel="prefetch" href="/docs/assets/js/41.cfb9a6fc.js"><link rel="prefetch" href="/docs/assets/js/42.c7728c3d.js"><link rel="prefetch" href="/docs/assets/js/43.ff696be5.js"><link rel="prefetch" href="/docs/assets/js/44.35f89a71.js"><link rel="prefetch" href="/docs/assets/js/45.83123d27.js"><link rel="prefetch" href="/docs/assets/js/46.825db740.js"><link rel="prefetch" href="/docs/assets/js/47.f25234ae.js"><link rel="prefetch" href="/docs/assets/js/48.57845dae.js"><link rel="prefetch" href="/docs/assets/js/49.a48c254d.js"><link rel="prefetch" href="/docs/assets/js/5.ea98df20.js"><link rel="prefetch" href="/docs/assets/js/50.64af53e2.js"><link rel="prefetch" href="/docs/assets/js/51.fd408724.js"><link rel="prefetch" href="/docs/assets/js/52.0127444e.js"><link rel="prefetch" href="/docs/assets/js/53.0e21ce33.js"><link rel="prefetch" href="/docs/assets/js/54.cb5aa1f2.js"><link rel="prefetch" href="/docs/assets/js/55.1713da20.js"><link rel="prefetch" href="/docs/assets/js/56.387e160a.js"><link rel="prefetch" href="/docs/assets/js/57.dfd9c55d.js"><link rel="prefetch" href="/docs/assets/js/58.e4d772a0.js"><link rel="prefetch" href="/docs/assets/js/59.c21264a8.js"><link rel="prefetch" href="/docs/assets/js/6.58c39db4.js"><link rel="prefetch" href="/docs/assets/js/60.b92f1b4b.js"><link rel="prefetch" href="/docs/assets/js/61.69c1cb21.js"><link rel="prefetch" href="/docs/assets/js/62.945553d9.js"><link rel="prefetch" href="/docs/assets/js/63.246937e5.js"><link rel="prefetch" href="/docs/assets/js/64.4da43aee.js"><link rel="prefetch" href="/docs/assets/js/65.f76a856e.js"><link rel="prefetch" href="/docs/assets/js/66.b38074c0.js"><link rel="prefetch" href="/docs/assets/js/67.1c219050.js"><link rel="prefetch" href="/docs/assets/js/68.8445d452.js"><link rel="prefetch" href="/docs/assets/js/69.30e94191.js"><link rel="prefetch" href="/docs/assets/js/7.15215cfb.js"><link rel="prefetch" href="/docs/assets/js/70.3ae9c36e.js"><link rel="prefetch" href="/docs/assets/js/71.01c78635.js"><link rel="prefetch" href="/docs/assets/js/72.79964c74.js"><link rel="prefetch" href="/docs/assets/js/73.30a36344.js"><link rel="prefetch" href="/docs/assets/js/74.f2589087.js"><link rel="prefetch" href="/docs/assets/js/75.a3246dfc.js"><link rel="prefetch" href="/docs/assets/js/76.c92d1875.js"><link rel="prefetch" href="/docs/assets/js/77.075d93f5.js"><link rel="prefetch" href="/docs/assets/js/78.a6d19de0.js"><link rel="prefetch" href="/docs/assets/js/79.08fad40c.js"><link rel="prefetch" href="/docs/assets/js/8.f48a39b0.js"><link rel="prefetch" href="/docs/assets/js/80.ecf9d836.js"><link rel="prefetch" href="/docs/assets/js/81.9a8e0ff8.js"><link rel="prefetch" href="/docs/assets/js/82.4b1abe3f.js"><link rel="prefetch" href="/docs/assets/js/83.bee5f9d0.js"><link rel="prefetch" href="/docs/assets/js/84.9429343b.js"><link rel="prefetch" href="/docs/assets/js/85.8777f4a2.js"><link rel="prefetch" href="/docs/assets/js/86.c89e1310.js"><link rel="prefetch" href="/docs/assets/js/87.b119f8a9.js"><link rel="prefetch" href="/docs/assets/js/88.a5efe1a7.js"><link rel="prefetch" href="/docs/assets/js/89.d64fbf68.js"><link rel="prefetch" href="/docs/assets/js/9.d2c64cad.js"><link rel="prefetch" href="/docs/assets/js/90.1a38cdb0.js"><link rel="prefetch" href="/docs/assets/js/91.ab2179f6.js"><link rel="prefetch" href="/docs/assets/js/92.566b75b3.js"><link rel="prefetch" href="/docs/assets/js/93.139bdc62.js"><link rel="prefetch" href="/docs/assets/js/94.d3946bfe.js"><link rel="prefetch" href="/docs/assets/js/95.12eb98cd.js"><link rel="prefetch" href="/docs/assets/js/96.011e223b.js"><link rel="prefetch" href="/docs/assets/js/97.f0f090f5.js"><link rel="prefetch" href="/docs/assets/js/98.58c5e3a8.js"><link rel="prefetch" href="/docs/assets/js/99.53735ce4.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.229beafb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">计算机基础教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/software/project_manage/gitlab_server.html#_1-architecture" class="sidebar-link">1. Architecture</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#components" class="sidebar-link">Components</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_1-1-http-https-over-nginx" class="sidebar-link">1.1 http/https over nginx:</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_1-2-ssh-over-gitlab-shell" class="sidebar-link">1.2 ssh over gitlab-shell</a></li></ul></li><li><a href="/docs/software/project_manage/gitlab_server.html#_2-install-安装-手动-omnibus版本" class="sidebar-link">2. Install 安装(手动)(Omnibus版本)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-1-硬件准备" class="sidebar-link">2.1 硬件准备</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-2-dependency" class="sidebar-link">2.2 dependency</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-3-rpm安装" class="sidebar-link">2.3 rpm安装</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-configuration" class="sidebar-link">2.4 Configuration</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-1-前端gitlab-server-url和api" class="sidebar-link" style="padding-left:3rem;">2.4.1 前端gitlab-server url和api</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-2-监控grafana" class="sidebar-link" style="padding-left:3rem;">2.4.2 监控grafana</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-3-邮箱" class="sidebar-link" style="padding-left:3rem;">2.4.3 邮箱</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-4-postgresql" class="sidebar-link" style="padding-left:3rem;">2.4.4 postgresql</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-5-gitaly" class="sidebar-link" style="padding-left:3rem;">2.4.5 gitaly</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-6-日志logrotate" class="sidebar-link" style="padding-left:3rem;">2.4.6 日志logrotate</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-4-7-ssl-ssh" class="sidebar-link" style="padding-left:3rem;">2.4.7 SSL &amp; SSH</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-5-商业版" class="sidebar-link">2.5 商业版</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_2-6-替换内置服务" class="sidebar-link">2.6 替换内置服务</a></li></ul></li><li><a href="/docs/software/project_manage/gitlab_server.html#_3-high-availability" class="sidebar-link">3. High Availability</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_3-1-gitlay-cluster" class="sidebar-link">3.1 gitlay cluster</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_3-1-1-postgresql-server" class="sidebar-link" style="padding-left:3rem;">3.1.1 postgresql server:</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_3-1-2-gitaly-nodes" class="sidebar-link" style="padding-left:3rem;">3.1.2 Gitaly Nodes</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_3-1-3-测试连通性-健康检查" class="sidebar-link" style="padding-left:3rem;">3.1.3 测试连通性|健康检查</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_3-2-gitrail-server-multi-nodes" class="sidebar-link">3.2 gitrail-server multi-nodes</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#官方方案" class="sidebar-link" style="padding-left:3rem;">官方方案</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#备份方案" class="sidebar-link" style="padding-left:3rem;">备份方案</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_3-3-postgresql-replication" class="sidebar-link">3.3 Postgresql Replication</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#_3-4-ha-roles" class="sidebar-link">3.4 ？？HA Roles</a></li></ul></li><li><a href="/docs/software/project_manage/gitlab_server.html#_4-maintenance-维护" class="sidebar-link">4. Maintenance 维护</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#数据管理" class="sidebar-link">数据管理</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#gitlab-server-workhorse" class="sidebar-link" style="padding-left:3rem;">gitlab server(workhorse)</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#gitlab-rails-dbconsole" class="sidebar-link" style="padding-left:4rem;">gitlab-rails dbconsole</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#gitlab-rails-console-users-and-products" class="sidebar-link" style="padding-left:4rem;">gitlab-rails console &gt;&gt; users and products</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#praefect-database" class="sidebar-link" style="padding-left:3rem;">praefect database</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#gitaly-repository" class="sidebar-link" style="padding-left:3rem;">gitaly repository</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#migration-迁移" class="sidebar-link">Migration 迁移</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#配置备份-backup-and-restore-omnibus-gitlab-configuration" class="sidebar-link" style="padding-left:3rem;">配置备份 Backup and restore Omnibus GitLab configuration</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#creating-an-application-backup" class="sidebar-link" style="padding-left:3rem;">Creating an application backup</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#restore" class="sidebar-link" style="padding-left:3rem;">Restore:</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#服务升级-upgrade-policy-卸载" class="sidebar-link">服务升级(upgrade policy)+卸载</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#主要规则" class="sidebar-link" style="padding-left:3rem;">主要规则</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#升级" class="sidebar-link" style="padding-left:3rem;">升级</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#升级后检查" class="sidebar-link" style="padding-left:3rem;">升级后检查</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#坑" class="sidebar-link" style="padding-left:3rem;">坑</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#升级例子" class="sidebar-link" style="padding-left:3rem;">升级例子</a></li></ul></li><li><a href="/docs/software/project_manage/gitlab_server.html#_5-cicd" class="sidebar-link">5. CICD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#key-concepts" class="sidebar-link">Key Concepts</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#install-and-config-gitlab-runner" class="sidebar-link">install and config gitlab runner</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#案例-create-react-app" class="sidebar-link">案例：Create-react-app</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#案例-maven-template-standard-core-lifecycle" class="sidebar-link">案例：Maven template(standard core lifecycle)</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#案例-maven-auto-release-non-lifecycle-tools-use-maven-release-plugin" class="sidebar-link">案例：Maven auto release(non-lifecycle, tools: use maven-release-plugin)</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#初始版本-buggy" class="sidebar-link" style="padding-left:3rem;">初始版本(buggy)：</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#问题修复" class="sidebar-link" style="padding-left:3rem;">问题修复：</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#release-prepare" class="sidebar-link" style="padding-left:4rem;">Release Prepare</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#release-peform" class="sidebar-link" style="padding-left:4rem;">Release Peform</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#最终版本" class="sidebar-link" style="padding-left:3rem;">最终版本</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#http-with-password" class="sidebar-link" style="padding-left:4rem;">http with password</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#ssh-paswordless" class="sidebar-link" style="padding-left:4rem;">ssh paswordless</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#官方方案-gitlab-release-tool" class="sidebar-link" style="padding-left:3rem;">官方方案：Gitlab release tool</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#案例-自动生成merge-request" class="sidebar-link">案例：自动生成merge request</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#案例-gitlab-pages" class="sidebar-link">案例 gitlab pages</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#troubshooting" class="sidebar-link">troubshooting</a></li></ul></li><li><a href="/docs/software/project_manage/gitlab_server.html#_6-troubleshooting" class="sidebar-link">6. Troubleshooting</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#创建project以及浏览已有project出现500" class="sidebar-link">创建project以及浏览已有project出现500</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#repository-migration问题" class="sidebar-link">repository migration问题</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#push失败问题" class="sidebar-link">push失败问题</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#git-client排查" class="sidebar-link" style="padding-left:3rem;">git client排查：</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#server端排查" class="sidebar-link" style="padding-left:3rem;">server端排查：</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#最终重现" class="sidebar-link" style="padding-left:3rem;">最终重现</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#版本升级后出现500无法访问project" class="sidebar-link">版本升级后出现500无法访问project</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#malformed-configuration-json-file-found-at-opt-gitlab-embedded-nodes-xxxx-json" class="sidebar-link">Malformed configuration JSON file found at /opt/gitlab/embedded/nodes/XXXX.json</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#gitlab-backup备份定时任务失败" class="sidebar-link">gitlab-backup备份定时任务失败</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#磁盘用尽" class="sidebar-link">磁盘用尽</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#web访问404-500-503-pull-timeout" class="sidebar-link">web访问404/500/503, pull timeout</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#观察" class="sidebar-link" style="padding-left:3rem;">观察</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#开始排查" class="sidebar-link" style="padding-left:3rem;">开始排查：</a></li></ul></li><li><a href="/docs/software/project_manage/gitlab_server.html#appendix" class="sidebar-link">Appendix</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#gitlab-ctl" class="sidebar-link">gitlab-ctl</a></li><li class="sidebar-sub-header"><a href="/docs/software/project_manage/gitlab_server.html#gitlab-rails" class="sidebar-link">gitlab-rails</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="/docs/software">回目录</a>  《Gitlab Server》</p> <h2 id="_1-architecture"><a href="#_1-architecture" class="header-anchor">#</a> 1. Architecture</h2> <p>https://docs.gitlab.com/ee/development/architecture.html</p> <p>https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/#service-architecture</p> <p><img src="/docs/docs_image/software/project_manage/git/gitlab01.png" alt=""></p> <h3 id="components"><a href="#components" class="header-anchor">#</a> Components</h3> <p>https://docs.gitlab.com/ee/development/architecture.html#component-details</p> <ul><li><p>Access Layer 接入层</p> <ul><li>Nginx：静态 web 服务器</li> <li>gitlab-shell：负责处理ssh请求,用于处理 Git 命令和修改 authorized keys 列表</li></ul></li> <li><p>Middleware Layer 中间层</p> <ul><li>gitlab-workhorse: 负责处理http/https请求,轻量级的反向代理服务器, gitlab workhorse对于本地静态文件请求（例如浏览器请求的html、js、css文件）会自己处理掉，对于纯git操作请求会转发给gitaly，对于其他动态请求会转发给unicorn处理</li> <li>unicorn：An HTTP server for Rack applications，GitLab Rails 应用是托管在这个服务器上面的，相当于java里面的tomcat，是一个开源项目
unicorn就是gitlab的主server程序，它会调用其他各个组件完成复杂的动态请求处理
https://blog.csdn.net/gg_18826075157/java/article/details/107117595</li> <li>logrotate：日志文件管理工具</li> <li>sidekiq：用于在后台执行队列任务（异步执行）</li></ul></li> <li><p>存储层：</p> <ul><li>PostgreSQL：类似于mysql，存储业务数据，比如有哪些项目组，某个项目组下有哪些项目，某项目下哪些人有权限等等</li> <li>redis：用于缓存热点数据以及存储异步任务，sidekiq这组件会定期拉取分发异步任务给worker执行</li> <li>gitaly：存储底层代码文件，提供rpc接口对外提供git操作服务</li></ul></li> <li><p>其他（显示层等）</p> <ul><li>gitlab pages</li> <li>*-exporter+grafana+prometheus: 监控</li></ul></li></ul> <div class="language- extra-class"><pre class="language-text"><code>sudo gitlab-ctl status
run: alertmanager: (pid 16828) 499486s; run: log: (pid 10270) 584166s
run: gitaly: (pid 15594) 499829s; run: log: (pid 9538) 584281s
run: gitlab-exporter: (pid 15618) 499829s; run: log: (pid 10090) 584184s
run: gitlab-workhorse: (pid 15624) 499828s; run: log: (pid 9929) 584207s
run: grafana: (pid 17718) 498697s; run: log: (pid 10420) 584117s
run: logrotate: (pid 9004) 2937s; run: log: (pid 10015) 584196s
run: nginx: (pid 15677) 499827s; run: log: (pid 9980) 584200s
run: node-exporter: (pid 15689) 499827s; run: log: (pid 10050) 584190s
run: postgres-exporter: (pid 15696) 499826s; run: log: (pid 10299) 584160s
run: postgresql: (pid 15789) 499823s; run: log: (pid 9636) 584274s
run: prometheus: (pid 15805) 499823s; run: log: (pid 10224) 584170s
run: puma: (pid 16874) 499480s; run: log: (pid 9832) 584220s
run: redis: (pid 15829) 499822s; run: log: (pid 9405) 584287s
run: redis-exporter: (pid 15834) 499822s; run: log: (pid 10179) 584178s
run: sidekiq: (pid 16818) 499486s; run: log: (pid 9864) 584214s

[root@vm-cicd-v02 liuyue]# netstat -anp|grep &quot;15789&quot;
unix  2      [ ACC ]     STREAM     LISTENING     1264397  15789/postgres       /var/opt/gitlab/postgresql/.s.PGSQL.5432

一个是Active Internet connections，称为有源TCP连接，其中&quot;Recv-Q&quot;和&quot;Send-Q&quot;指%0A的是接收队列和发送队列。这些数字一般都应该是0。如果不是则表示软件包正在队列中堆积。这种情况只能在非常少的情况见到。

另一个是Active UNIX domain sockets，称为有源Unix域套接口(和网络套接字一样，但是只能用于本机通信，性能可以提高一倍)。
Proto显示连接使用的协议,RefCnt表示连接到本套接口上的进程号,Types显示套接口的类型,State显示套接口当前的状态,Path表示连接到套接口的其它进程使用的路径名。
https://blog.csdn.net/u012598668/java/article/details/40080245
</code></pre></div><h3 id="_1-1-http-https-over-nginx"><a href="#_1-1-http-https-over-nginx" class="header-anchor">#</a> 1.1 http/https over nginx:</h3> <p>git request: http://X.X.X.133:8088/root/test-gitaly-cluster.git</p> <p>user/admin dashboard request: http://X.X.X.133:8088/root/test-gitaly-cluster</p> <p>grafana request: http://X.X.X.133:8088/-/grafana/?orgId=1</p> <p>sudo vim /var/opt/gitlab/nginx/conf/nginx.conf</p> <div class="language- extra-class"><pre class="language-text"><code>upstream gitlab-workhorse {
    server unix:/var/opt/gitlab/gitlab-workhorse/socket;
  }

  include /var/opt/gitlab/nginx/conf/gitlab-http.conf;
</code></pre></div><p>这个upstream名字是gitlab-workhorse，对应是转发到的地方，这里可以看到是一个unix socket；</p> <p>再来看include的这个配置文件：</p> <p>sudo vim /var/opt/gitlab/nginx/conf/gitlab-http.conf</p> <p>8088是我们在/etc/gitlab/gitlab.rb中reconfigure的外部访问端口，</p> <p>可以看到proxy_pass将路由匹配到了<code>http://&lt;upstream name&gt;</code>也就是<code>http://gitlab-workhorse</code></p> <div class="language- extra-class"><pre class="language-text"><code>server {
  listen *:8088;


  server_name X.X.X.134;
  
location / {
    proxy_cache off;
    proxy_pass  http://gitlab-workhorse;
  }

  location /assets {
    proxy_cache gitlab;
    proxy_pass  http://gitlab-workhorse;
  }
  
 location ~ ^/(404|500|502)(-custom)?\.html$ {//特别匹配这么几个错误页面
    root /opt/gitlab/embedded/service/gitlab-rails/public;
    internal; //限制为内部用户
  }
  
 location ~ (.git/git-receive-pack$|.git/info/refs?service=git-receive-pack$|.git/gitlab-lfs/objects|.git/info/lfs/objects/batch$) {
    proxy_cache off;
    proxy_pass http://gitlab-workhorse;
    proxy_request_buffering off;
  }
  location /-/grafana/ {
    proxy_pass http://localhost:3000/;
  }
</code></pre></div><p>可以看到不管是什么请求（除了grafana和那几个特定的静态页面）都是转给gitlab-workhorse来处理，</p> <p>https://juejin.im/post/5cf680f86fb9a07ed5248cda</p> <p>最后再来查查gitlab-workhorse，如下可以看到是监听的正是前面upstream转发的那个/var/opt/gitlab/gitlab-workhorse/socket</p> <p>然后authBackend对应8080端口，这个可以参考</p> <blockquote><div class="language- extra-class"><pre class="language-text"><code>https://gitlab.com/gitlab-org/gitlab-workhorse/blob/master/README.md

-authBackend string
   Authentication/authorization backend (default &quot;http://localhost:8080&quot;)
</code></pre></div></blockquote> <p>估计应该是API接口</p> <p>documentRoot前端的对应目录是/opt/gitlab/embedded/service/gitlab-rails/public</p> <div class="language- extra-class"><pre class="language-text"><code>[root@vm-cicd-v01 liuyue]# ps -lef | grep &quot;rail&quot;
4 S root      5033 22189  0  80   0 - 28203 pipe_w 14:52 pts/1    00:00:00 grep --color=auto rail
4 S git       6848  6504  0  80   0 - 166286 ep_pol Jun29 ?       00:10:55 /opt/gitlab/embedded/bin/gitlab-workhorse -listenNetwork unix -listenUmask 0 -listenAddr /var/opt/gitlab/gitlab-workhorse/socket -authBackend http://localhost:8080 -authSocket /var/opt/gitlab/gitlab-rails/sockets/gitlab.socket -documentRoot /opt/gitlab/embedded/service/gitlab-rails/public -pprofListenAddr  -prometheusListenAddr localhost:9229 -secretPath /opt/gitlab/embedded/service/gitlab-rails/.gitlab_workhorse_secret -logFormat json -config config.toml
4 S git       7038  6502  0  80   0 - 257481 poll_s Jun29 ?       00:09:25 puma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]
4 S git       7056  6503  0  80   0 - 32362 poll_s Jun29 ?        00:00:23 ruby /opt/gitlab/embedded/service/gitlab-rails/bin/sidekiq-cluster -e production -r /opt/gitlab/embedded/service/gitlab-rails -m 50 --timeout 25 *
</code></pre></div><p>8080这个端口是哪个服务呢</p> <p>根据 https://docs.gitlab.com/ee/development/architecture.html 架构图，可以看到8080是指向unicorn</p> <p>但是查一下，可以看到是puma：</p> <div class="language- extra-class"><pre class="language-text"><code>netstat -anp|grep :8080
tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      7038/puma 4.3.3.git

ps -lef|grep &quot;puma&quot;
4 S root      6502  6498  0  80   0 -  1058 poll_s Jun29 ?        00:00:00 runsv puma
4 S root      6517  6502  0  80   0 -  1094 poll_s Jun29 ?        00:00:00 svlogd -tt /var/log/gitlab/puma
4 S git       6845  6508  4  80   0 - 173898 poll_s Jun29 ?       15:54:47 puma 4.3.3.gitlab.2 (tcp://localhost:9168) [gitlab-exporter]
4 S git       7038  6502  0  80   0 - 257481 poll_s Jun29 ?       00:09:26 puma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]
</code></pre></div><p>https://docs.gitlab.com/ee/administration/operations/unicorn.html#unicorn</p> <blockquote><p><strong>Note:</strong> Starting with GitLab 13.0, Puma is the default web server used in GitLab all-in-one package based installations as well as GitLab Helm chart deployments.</p> <p>GitLab uses <a href="https://yhbt.net/unicorn/" target="_blank" rel="noopener noreferrer">Unicorn<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, a pre-forking Ruby web server, to handle web requests (web browsers and Git HTTP clients). Unicorn is a daemon written in Ruby and C that can load and run a Ruby on Rails application; in our case the Rails application is GitLab Community Edition or GitLab Enterprise Edition.</p></blockquote> <p>unicorn是一个开源项目，当unicorn不再满足需求时才引入了puma和workhorse</p> <p>https://juejin.im/post/5cf6832c51882520724c84ff</p> <h3 id="_1-2-ssh-over-gitlab-shell"><a href="#_1-2-ssh-over-gitlab-shell" class="header-anchor">#</a> 1.2 ssh over gitlab-shell</h3> <p>git@X.X.X.133:root/test-gitaly-cluster.git</p> <p>注意安装gitlab后，会创建很多用户</p> <div class="language- extra-class"><pre class="language-text"><code>vim /etc/passwd
gitlab-www:x:996:993::/var/opt/gitlab/nginx:/bin/false
git:x:995:992::/var/opt/gitlab:/bin/sh
gitlab-redis:x:994:991::/var/opt/gitlab/redis:/bin/false
gitlab-psql:x:993:990::/var/opt/gitlab/postgresql:/bin/sh
gitlab-prometheus:x:992:989::/var/opt/gitlab/prometheus:/bin/sh
</code></pre></div><p>注意到git用户的home是/var/opt/gitlab，然后从/var/opt/gitlab/gitlab-shell/config.yml可以获取到配置</p> <p>auth_file: /var/opt/gitlab/.ssh/authorized_keys，打开可以看到</p> <p><code>command=&quot;/opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell key-1&quot;</code></p> <p>原理就是一句话：ssh可以执行命令 https://research.kudelskisecurity.com/2013/05/14/restrict-ssh-logins-to-a-single-command/</p> <p>http://williamherry.com/blog/2015/07/19/from-git-push-to-commit-show-on-page/</p> <p>https://juejin.im/post/5cf686b85188253cec305fa7</p> <p>my internal sharing talk:</p> <div class="language- extra-class"><pre class="language-text"><code>I'll give a overview about what we have and how git server works
I believe everyone should be already familiar with git,
Git is a distributed version-control system for tracking changes in source code during software development.
it enables us to collaborate more effiently especially when working remotely on the software project,

//and by integrating with other automation tools like jenkins and others, you can have the ability to Continuous Integration and Continuous Deployment;
actually for some of the git server implementations like gitlab, we notice that it already has built in CICD Solutions, 
but we haven't expolore that portion yet, today we'll only cover the basic usage;

although most of us are familiar with git, but probably limited to the git client, whether it's git commands or gui tools, 
now let's talk about how git server side looks like;

at the start, we set up a standalone git lab server, you can see it is comprised of a lot services, some of the non important services are not listed here;
when the users make a git pull or push through http or ssh, it will go to nginx or gitlab shell respectively, if the git request goes through http request, 
gitlab workhorse will redirect it to unicorn, other request like access to the dashboard or grafana monitor will handled by workhorse itself,
intially there is only unicorn, and then gitlab introduced workhorse to share the load of unicorn, 
unicorn is an open source project, it's a web server in ruby, analogy to tomcat in java;

redis is for cache, postgresql is for the application data storing, sidekiq is for backgroud job, it may be related to the CICD futionality;

the most crital system is gitaly, it's for the git repository storage

as we have very limited internal users, for the high availability concerns, the first thing we need to do is make sure there is no single point of failure
for the gitaly storage, based on the documentation, we come out with this gitaly cluster;

it has a praefect as router between gitlab server and gitaly nodes;
</code></pre></div><h2 id="_2-install-安装-手动-omnibus版本"><a href="#_2-install-安装-手动-omnibus版本" class="header-anchor">#</a> 2. Install 安装(手动)(Omnibus版本)</h2> <p>https://docs.gitlab.com/omnibus/README.html#installation-and-configuration-using-omnibus-package</p> <p>https://git-scm.com/book/en/v2/Git-on-the-Server-GitLab</p> <p>GitLab FOSS is a read-only mirror of GitLab, with all proprietary code removed. This project was previously used to host GitLab Community Edition, but all development has now moved to https://gitlab.com/gitlab-org/gitlab.</p> <p>differences between Omnibus and source installations
https://gitlab.com/gitlab-org/gitlab-foss/-/issues/15412
Omnibus uses gitlab-ctlfor managing the services and can do so separately. On source, if you want to restart and use our service file, you need to restart all the components</p> <p>ce版本源码：
https://gitlab.com/gitlab-org/gitlab-foss/-/tree/master
https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</p> <p>官方安装文档：https://about.gitlab.com/install/#centos-7</p> <p>下面采用离线安装 https://docs.gitlab.com/omnibus/manual_install.html
https://docs.gitlab.com/ee/topics/offline/</p> <h3 id="_2-1-硬件准备"><a href="#_2-1-硬件准备" class="header-anchor">#</a> 2.1 硬件准备</h3> <p>一台Praefect Server（存储空间可以给最低没关系）和三台gitaly server（git高可用的核心服务器，要求high CPU, high memory, fast storage）</p> <p>挂载磁盘大小需要注意，因为gitlab会写入一些数据到 /var/opt/gitlab，所以如果/var单独挂载需要注意</p> <h3 id="_2-2-dependency"><a href="#_2-2-dependency" class="header-anchor">#</a> 2.2 dependency</h3> <div class="language- extra-class"><pre class="language-text"><code># open HTTP, HTTPS and SSH access in the system firewall.

sudo yum install -y curl policycoreutils-python openssh-server
sudo systemctl enable sshd
sudo systemctl start sshd
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo systemctl reload firewalld

# install Postfix to send notification emails.
# If you want to use another solution to send emails please skip this step and configure an external SMTP server after GitLab has been installed.
# 此处我已经忽略，奇怪的是我并没有安装，但是后面却发现postfix不知何时已经运行了，估计是gitlab自己搞的
sudo yum install postfix
sudo systemctl enable postfix
sudo systemctl start postfix
</code></pre></div><h3 id="_2-3-rpm安装"><a href="#_2-3-rpm安装" class="header-anchor">#</a> 2.3 rpm安装</h3> <div class="language- extra-class"><pre class="language-text"><code># GitLab Community Edition
# Debian/Ubuntu
dpkg -i gitlab-ce-&lt;version&gt;.deb

# CentOS/RHEL
rpm -Uvh gitlab-ce-&lt;version&gt;.rpm

下载 
https://packages.gitlab.com/gitlab/
https://packages.gitlab.com/gitlab/gitlab-ce

sudo mv gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm /opt/

rpm -ivh gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm 

for firstime install use -i or -U, for upgrade use -U

总结：
cd /opt/
rpm -ivh gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm 
vim /etc/gitlab/gitlab.rb (change external_url=&quot;http://X.X.X.133:8088&quot;)
sudo gitlab-ctl reconfigure
firewall-cmd --zone=public --add-port=8088/tcp --permanent
firewall-cmd --reload

after all this:
access from your browser
http://X.X.X.133:8088

it will ask for changing password, default username: admin@example.com

</code></pre></div><p>启动：</p> <p>sudo gitlab-ctl reconfigure</p> <p>安装后路径：</p> <p>/var/opt/gitlab/</p> <p>/var/opt/gitlab/nginx/conf/gitlab-http.conf</p> <p>log路径：也是排查错误的路径</p> <p>/var/log/gitlab/</p> <p>单机版gitlab可以执行<code>gitlab-rake gitlab:check</code>即可全面单机检测</p> <p>单个检查：</p> <div class="language- extra-class"><pre class="language-text"><code>gitlab:gitlab_shell:check
gitlab:gitaly:check
gitlab:sidekiq:check
gitlab:incoming_email:check
gitlab:ldap:check
gitlab:app:check
</code></pre></div><h3 id="_2-4-configuration"><a href="#_2-4-configuration" class="header-anchor">#</a> 2.4 Configuration</h3> <p>https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</p> <h4 id="_2-4-1-前端gitlab-server-url和api"><a href="#_2-4-1-前端gitlab-server-url和api" class="header-anchor">#</a> 2.4.1 前端gitlab-server url和api</h4> <p>/etc/gitlab/gitlab.rb</p> <p>​	change external_url=&quot;http://X.X.X.133:8088&quot; 这个端口会写入到/var/opt/gitlab/nginx/conf/gitlab-http.conf</p> <p>sudo gitlab-ctl reconfigure</p> <p>注意，刚开始我用了8080，<s>刚好跟内置的nginx冲突</s>，是跟gitlab-puma-worker冲突，</p> <div class="language- extra-class"><pre class="language-text"><code>sudo netstat -anp|grep :8080

sudo ps -lef|grep 18251

puma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]

</code></pre></div><p>所以访问出现502 Whoops, GitLab is taking too much time to respond.</p> <p>只需要换一个端口即可，端口也要开通：</p> <div class="language- extra-class"><pre class="language-text"><code>firewall-cmd --zone=public --add-port=8088/tcp --permanent
firewall-cmd --reload
firewall-cmd --list-all
firewall-cmd --list-ports
</code></pre></div><p><strong>这个reconfigure会将配置进行“分发”，所以后面所有修改配置都要注意优先修改gitlab.rb，而不是直接改具体各个服务的配置：</strong></p> <p>比如端口和ip赋值给：</p> <p>/var/opt/gitlab/nginx/conf/gitlab-http.conf（模板/opt/gitlab/embedded/conf/nginx.conf ?）</p> <p>/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml（模板：/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml.exmaple）</p> <p>说回到 前端http://X.X.X.133:8088</p> <p>默认用户名root/ admin@example.com 可以从log中获取：</p> <p>sudo grep -nr &quot;admin&quot; /var/log/gitlab/</p> <p>​	/var/log/gitlab/gitlab-rails/application.log</p> <p>监控前端（从nginx配置获取）：</p> <p>X.X.X.134:8088/-/grafana/login</p> <p>注意这个8088也将会是Gitaly集群的internal_api_url</p> <p>/opt/gitlab/embedded/service/gitlab-shell/config.yml</p> <p><s>注意此处要手动修改gitlab_url，不知为何reconfigure没有生效到这里</s> 应该不需要修改，默认就是8080，对应puma-worker的端口</p> <p>auth_key?</p> <h4 id="_2-4-2-监控grafana"><a href="#_2-4-2-监控grafana" class="header-anchor">#</a> 2.4.2 监控grafana</h4> <p>第一种基本登录</p> <p>​	grafana['disable_login_form'] = false</p> <p>​	gitlab-ctl set-grafana-password</p> <p>第二种方法：通过gitlab server第三方登录</p> <p>首先login配置</p> <p>X.X.X.134:8088/-/grafana/login</p> <p>http://X.X.X.134:8088/oauth/authorize?access_type=online&amp;client_id=a797f89033dee951dac900905d7b447191f743bcd9afa3a970be4a6864ee0661&amp;redirect_uri=http%3A%2F%2FX.X.X.134%3A8088%2F-%2Fgrafana%2Flogin%2Fgitlab&amp;response_type=code&amp;scope=api&amp;state=o2t3bzD7ek3TPoIPHqDVaLc_HSInTqdBK9IlS2dHhnc%3D</p> <p>?# gitlab The redirect URI included is not valid.</p> <p>https://grafana.com/docs/grafana/latest/auth/gitlab/</p> <p>配置：</p> <p>回到gitlab前端的管理员area， Applications-&gt;Add</p> <p>callback url: http://X.X.X.134:8088/-/grafana/login/gitlab</p> <p>将clientid和secret配置到：/var/opt/gitlab/grafana/grafana.ini</p> <div class="language- extra-class"><pre class="language-text"><code>[auth.gitlab]
client_id
client_secret
root_url = http://X.X.X.134:8088/-/grafana
auth_url = http://X.X.X.134:8088/oauth/authorize
token_url = http://X.X.X.134:8088/oauth/token
api_url = http://X.X.X.134:8088/api/v4
</code></pre></div><p>gitlab-ctl restart grafana</p> <p><strong>监控其他节点</strong></p> <p>这个是在安装了Gitaly cluster之后的配置</p> <p>9090 prometheus</p> <p>9100 node_exporter</p> <p>这两个都是可以看到metrics:</p> <p>curl 127.0.0.1:9090/metrics -s | head</p> <p>curl 127.0.0.1:9100/metrics -s | head</p> <p>应该只有prometheus自带UI:</p> <p>http://X.X.X.133:9090/graph</p> <p>但是浏览器无法打开，netstat发现9090只监听本地端口，所以要修改</p> <p>grep :9090 /var/opt/* -r</p> <p>找到/var/opt/gitlab/prometheus/prometheus.yml和/var/opt/gitlab/gitlab-rails/etc/gitlab.yml</p> <p>但是还是建议去/etc/gitlab/gitlab.rb里面去修改：</p> <p>prometheus['listen_address'] = 'localhost:9090'</p> <p>最后可以打开了prometheus ui，</p> <p>测试dashboard：Gitaly，先修改variable</p> <div class="language- extra-class"><pre class="language-text"><code>label_values(up{job=&quot;gitaly&quot;}, instance)
改成
label_values(gitlab_build_info{job=&quot;praefect-gitaly&quot;}, instance)
果然可以看到其他三个instance
</code></pre></div><p>然后继续修改dashboard页面内部的metrics，比如Gitaly的cpu查询一下，</p> <p>rate(process_cpu_seconds_total{job=&quot;gitaly&quot;}[1m])</p> <p>发现只有一条localhost记录，再来查查node exporter配置：</p> <p>grep :9100 /var/opt/* -r
/var/opt/gitlab/prometheus/prometheus.yml:    - localhost:9100</p> <div class="language- extra-class"><pre class="language-text"><code>- job_name: node
  static_configs:
  - targets:
    - localhost:9100
</code></pre></div><p>果然这个是问题所在，并没有去监听Gitaly cluster 上面的9100</p> <p>但是正确的做法仍然是不要直接修改，应该去修改/etc/gitlab/gitlab.rb</p> <p>突然想到我们在创建gitaly cluster的时候其实修改过，刚好在这个prometheus.yml里面验证下：</p> <div class="language- extra-class"><pre class="language-text"><code>- job_name: praefect-gitaly
  static_configs:
  - targets:
    - X.X.X.136:9236
    - X.X.X.137:9236
    - X.X.X.138:9236
</code></pre></div><p>果然是有，我们依样画葫芦，可以同样修改上面的node</p> <div class="language- extra-class"><pre class="language-text"><code> {                                          
   'job_name' =&gt; 'praefect-gitaly-nodes',   
   'static_configs' =&gt; [                    
     'targets' =&gt; [                         
       'X.X.X.136:9100', # gitaly-1    
       'X.X.X.137:9100', # gitaly-2    
       'X.X.X.138:9100', # gitaly-3    
     ]                                      
   ]                                        
 }                                          
</code></pre></div><p>但是还不够，还要确认Gitaly的9100端口对gitlab server可见，但是发现实际上Gitaly上面并没有开启9100端口，意思是node_exporter并没有启动，怀疑是gitlab程序会默认根据gitaly['enable'] = true来disable掉node_exporter,所以我尝试主动去开启node_exporter:</p> <div class="language- extra-class"><pre class="language-text"><code>################################################################################
## Prometheus Node Exporter
##! Docs: https://docs.gitlab.com/ee/administration/monitoring/prometheus/node_exporter.html
################################################################################

node_exporter['enable'] = true
# node_exporter['home'] = '/var/opt/gitlab/node-exporter'
# node_exporter['log_directory'] = '/var/log/gitlab/node-exporter'
# node_exporter['flags'] = {
#   'collector.textfile.directory' =&gt; &quot;/var/opt/gitlab/node-exporter/textfile_collector&quot;
# }
# node_exporter['env_directory'] = '/opt/gitlab/etc/node-exporter/env'
# node_exporter['env'] = {
#   'SSL_CERT_DIR' =&gt; &quot;/opt/gitlab/embedded/ssl/certs/&quot;
# }

##! Advanced settings. Should be changed only if absolutely needed.
node_exporter['listen_address'] = '0.0.0.0:9100'
</code></pre></div><p>刚好同时将node_exporter监听也改掉</p> <p>firewall-cmd --zone=public --add-port=9100/tcp --permanent</p> <p>firewall-cmd --reload</p> <p>回到gitlab-server，在http://X.X.X.133:9090/graph</p> <p>rate(process_cpu_seconds_total{job=&quot;praefect-gitaly-nodes&quot;}[1m])</p> <p>果然看到了三个instance的metrics（注意重启服务后要多等一会）</p> <p>最后试着保存dashboard，居然弹出错误“ Cannot save provisioned dashboard&quot;</p> <p>https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards</p> <p>vim /var/opt/gitlab/grafana/provisioning/dashboards/gitlab_dashboards.yml</p> <div class="language- extra-class"><pre class="language-text"><code>---
apiVersion: 1
providers:
- name: GitLab Omnibus
  orgId: 1
  folder: GitLab Omnibus
  type: file
  disableDeletion: true
  updateIntervalSeconds: 600
  options:
    path: &quot;/opt/gitlab/embedded/service/grafana-dashboards&quot;
</code></pre></div><p>继而找到</p> <p>vim /opt/gitlab/embedded/service/grafana-dashboards/gitaly.json</p> <h4 id="_2-4-3-邮箱"><a href="#_2-4-3-邮箱" class="header-anchor">#</a> 2.4.3 邮箱</h4> <p>前面跳过了邮箱配置，这里采用external mail server gmail，但是奇怪的是postfix自动运行</p> <p>https://docs.gitlab.com/omnibus/settings/smtp.html</p> <p><strong>Use smtp instead of sendmail/postfix.</strong></p> <p>注意要更改gitlab_rails['smtp_设置，不要改错</p> <p>测试：</p> <div class="language- extra-class"><pre class="language-text"><code>Look at the ActionMailer `delivery_method` to make sure it matches what you intended. If you configured SMTP, it should say `:smtp`. If you’re using Sendmail, it should say `:sendmail`:

ActionMailer::Base.delivery_method

gitlab-rails console
Notify.test_email('lyhistory@gmail.com', 'test gitlab', 'test').deliver_now
ActionMailer::Base.smtp_settings

</code></pre></div><h4 id="_2-4-4-postgresql"><a href="#_2-4-4-postgresql" class="header-anchor">#</a> 2.4.4 postgresql</h4> <p>https://docs.gitlab.com/omnibus/settings/database.html#connecting-to-the-bundled-postgresql-database</p> <p>https://docs.gitlab.com/ee/administration/troubleshooting/postgresql.html#postgresql</p> <p>/var/opt/gitlab/postgresql/data/postgresql.conf</p> <div class="language- extra-class"><pre class="language-text"><code>sudo gitlab-rails dbconsole

sudo gitlab-psql -d gitlabhq_production
</code></pre></div><p>plsql cmds</p> <p>https://www.postgresql.org/docs/12/app-psql.html</p> <p>注意下面这种方式是无法连接的，因为gitlab本机内部不是用tcp协议，而是用Unix域套接口</p> <p>/opt/gitlab/embedded/bin/psql -U postgres -d gitlabhq_production -h &lt;POSTGRESQL_SERVER_ADDRESS&gt;</p> <h4 id="_2-4-5-gitaly"><a href="#_2-4-5-gitaly" class="header-anchor">#</a> 2.4.5 gitaly</h4> <p>vim /var/opt/gitlab/gitaly/config.toml</p> <p>可以清晰的看到 /var/opt/gitlab/git-data/repositories 这个就是git最终存储的位置</p> <div class="language- extra-class"><pre class="language-text"><code>socket_path = '/var/opt/gitlab/gitaly/gitaly.socket'

internal_socket_dir = '/var/opt/gitlab/gitaly/internal_sockets'
bin_dir = '/opt/gitlab/embedded/bin'

# Optional: export metrics via Prometheus
prometheus_listen_addr = 'localhost:9236'

[[storage]]
name = 'defau://www.postgresql.org/docs/12/app-psql.htmlt'
path = '/var/opt/gitlab/git-data/repositories'

[logging]
format = 'json'
dir = '/var/log/gitlab/gitaly'

[auth]

[git]

[gitaly-ruby]
dir = &quot;/opt/gitlab/embedded/service/gitaly-ruby&quot;
rugged_git_config_search_path = &quot;/opt/gitlab/embedded/etc&quot;

[gitlab-shell]
dir = &quot;/opt/gitlab/embedded/service/gitlab-shell&quot;
gitlab_url = 'http://127.0.0.1:8080'
</code></pre></div><h4 id="_2-4-6-日志logrotate"><a href="#_2-4-6-日志logrotate" class="header-anchor">#</a> 2.4.6 日志logrotate</h4> <p>/var/opt/gitlab/logrotate/logrotate.conf</p> <div class="language- extra-class"><pre class="language-text"><code>include /var/opt/gitlab/logrotate/logrotate.d/nginx
include /var/opt/gitlab/logrotate/logrotate.d/puma
include /var/opt/gitlab/logrotate/logrotate.d/actioncable
include /var/opt/gitlab/logrotate/logrotate.d/unicorn
include /var/opt/gitlab/logrotate/logrotate.d/gitlab-rails
include /var/opt/gitlab/logrotate/logrotate.d/gitlab-shell
include /var/opt/gitlab/logrotate/logrotate.d/gitlab-workhorse
include /var/opt/gitlab/logrotate/logrotate.d/gitlab-pages
</code></pre></div><h4 id="_2-4-7-ssl-ssh"><a href="#_2-4-7-ssl-ssh" class="header-anchor">#</a> 2.4.7 SSL &amp; SSH</h4> <p>https://docs.gitlab.com/omnibus/settings/ssl.html</p> <p>刚开始想用let's ecrypt，发现</p> <p>https://certbot.eff.org/lets-encrypt/centosrhel7-nginx</p> <p>这自动更新得联网啊，而且我连个域名都没有，直接是ip访问</p> <p>还是用自签吧，但是又发现有坑：<a href="https://docs.gitlab.com/ee/administration/troubleshooting/ssl.html#unable-to-perform-git-operations-due-to-an-internal-or-self-signed-certificate" target="_blank" rel="noopener noreferrer">Unable to perform Git operations due to an internal or self-signed certificate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>大概意思是，自签没问题，但是git客户端无法验证自签证书，要么得一个个git客户端安装一遍，要么disable ssl verify，总归是坑</p> <p>ssh</p> <p>https://docs.gitlab.com/ee/gitlab-basics/create-your-ssh-keys.html#create-and-add-your-ssh-key-pair</p> <div class="language- extra-class"><pre class="language-text"><code>ssh-keygen -t ed25519 -C &quot;&lt;comment&gt;&quot;
</code></pre></div><h3 id="_2-5-商业版"><a href="#_2-5-商业版" class="header-anchor">#</a> 2.5 商业版</h3> <p>[https://docs.gitlab.com/ee/user/admin_area/license.html#:~:text=Add%20your%20license%20at%20install,and%20filename%20for%20the%20license.](https://docs.gitlab.com/ee/user/admin_area/license.html#:~:text=Add your license at install,and filename for the license.)</p> <p>https://packages.gitlab.com/gitlab/gitlab-ee</p> <h3 id="_2-6-替换内置服务"><a href="#_2-6-替换内置服务" class="header-anchor">#</a> 2.6 替换内置服务</h3> <p>！！强烈不建议，因为会影响后续升级！！</p> <p>nginx</p> <p>jianshu.com/p/123778a515ca</p> <p>grafana</p> <p>postgresql</p> <p>反向代理</p> <p>https://cloud.tencent.com/developer/article/1437220</p> <p>配置排查参考：blog.csdn.net/weixin_43748870/article/details/86178042</p> <h2 id="_3-high-availability"><a href="#_3-high-availability" class="header-anchor">#</a> 3. High Availability</h2> <p>总体上说，</p> <ul><li><p>CE版本</p> <p>结合gitlab服务端架构，随便搜一下可以看到都是抄来抄去的同类文章https://www.cnblogs.com/wangshuyang/p/10946099.html</p> <p>网上大多建议装两个单机版（all in one），前面用Virtual IP或floating IP，然后两个单机通过NFS共享磁盘，由于NFS即将被移除，其他思路就是DRBD或者rsync整个磁盘同步，所以这个方案实际是主备（冷备），每次只是开一个机器，当挂掉之后，可以启动备用</p> <p>https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-web-servers-with-keepalived-and-floating-ips-on-ubuntu-14-04</p></li> <li><p>EE版本</p> <p>采用主主（热备）</p> <p>切分成两大部分，gitlab-server和Gitaly cluster，Gitaly cluster本身就是集群模式，gitlab-server需要借助load Balancer搞成ha，比如借助haproxy，然后多个gitlab-server节点之间共享Application database和Gitaly cluster；</p> <p>gitlab-sever跟Gitaly cluster之间是通过Praefect连接，Praefect本身只是路由，所以可以做成多节点，加一个loadBalancer；</p> <p>注意loadBalancer本身也是可以做成多节点的，参考haproxy的文章；</p></li></ul> <blockquote><p>gitlab内部可以做给个部分的ha，比如</p> <ol><li><a href="https://docs.gitlab.com/ee/administration/postgresql/replication_and_failover.html" target="_blank" rel="noopener noreferrer">Configure the database<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.gitlab.com/ee/administration/high_availability/redis.html" target="_blank" rel="noopener noreferrer">Configure Redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.gitlab.com/ee/administration/high_availability/nfs.html" target="_blank" rel="noopener noreferrer">Configure NFS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.gitlab.com/ee/administration/high_availability/gitlab.html" target="_blank" rel="noopener noreferrer">Configure the GitLab application servers<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <p>不过需要注意的是，NFS在新版已经deprecated并且会被删除</p> <p>high_availability['mountpoint']</p> <p>https://docs.gitlab.com/ee/administration/high_availability/gitlab.html</p> <p>https://docs.gitlab.com/ee/administration/high_availability/nfs.html</p> <p><strong>Caution:</strong> From GitLab 13.0, using NFS for Git repositories is deprecated. In GitLab 14.0, support for NFS for Git repositories is scheduled to be removed. Upgrade to <a href="https://docs.gitlab.com/ee/administration/gitaly/praefect.html" target="_blank" rel="noopener noreferrer">Gitaly Cluster<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as soon as possible.</p> <p>可以看到官方已经不推荐了</p></blockquote> <h3 id="_3-1-gitlay-cluster"><a href="#_3-1-gitlay-cluster" class="header-anchor">#</a> 3.1 gitlay cluster</h3> <p>https://docs.gitlab.com/ee/administration/gitaly/praefect.html</p> <ul><li>1 load balancer</li> <li>1 PostgreSQL server (PostgreSQL 11 or newer)</li> <li>3 Praefect nodes</li> <li>3 Gitaly nodes (1 primary, 2 secondary)</li></ul> <h4 id="_3-1-1-postgresql-server"><a href="#_3-1-1-postgresql-server" class="header-anchor">#</a> 3.1.1 postgresql server:</h4> <p>https://www.postgresql.org/download/linux/redhat/</p> <p>https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-libs.html</p> <p>find direct rpm download:</p> <p>https://yum.postgresql.org/rpmchart/</p> <ul><li><a href="https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12.html" target="_blank" rel="noopener noreferrer">postgresql12<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - PostgreSQL client programs and libraries</li> <li><a href="https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-contrib.html" target="_blank" rel="noopener noreferrer">postgresql12-contrib<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - Contributed source and binaries distributed with PostgreSQL</li> <li><a href="https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-libs.html" target="_blank" rel="noopener noreferrer">postgresql12-libs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - The shared libraries required for any PostgreSQL clients</li> <li><a href="https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-server.html" target="_blank" rel="noopener noreferrer">postgresql12-server<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> - The programs needed to create and run a PostgreSQL server</li></ul> <div class="language- extra-class"><pre class="language-text"><code> ## 安装postgresql：：
 
 40  cd /opt/
   43  sudo mkdir postgresql
   44  mv ~/postgresql12-* postgresql/
   45  sudo mv ~/postgresql12-* postgresql/
   47  cd postgresql/
   50  sudo yum localinstall postgresql12-libs-12.3-5PGDG.rhel7.x86_64.rpm
   52  sudo yum localinstall postgresql12-12.3-5PGDG.rhel7.x86_64.rpm
   53  sudo yum localinstall postgresql12-server-12.3-5PGDG.rhel7.x86_64.rpm
   54  sudo yum localinstall postgresql12-contrib-12.3-5PGDG.rhel7.x86_64.rpm
   55  ll /usr/
   56  /usr/pgsql-12/bin/postgresql-12-setup initdb
   57  sudo /usr/pgsql-12/bin/postgresql-12-setup initdb
   58  sudo systemctl enable postgresql-12
   59  sudo systemctl start postgresql-12
   
   [liuyue@vm-cicd-v02 ~]$ sudo ps -lef|grep &quot;postgre&quot;
4 S postgres   987     1  0  80   0 - 99348 poll_s 16:59 ?        00:00:00 /usr/pgsql-12/bin/postmaster -D /var/lib/pgsql/12/data/
1 S postgres   989   987  0  80   0 - 62944 ep_pol 16:59 ?        00:00:00 postgres: logger
1 S postgres   991   987  0  80   0 - 99348 ep_pol 16:59 ?        00:00:00 postgres: checkpointer
1 S postgres   992   987  0  80   0 - 99381 ep_pol 16:59 ?        00:00:00 postgres: background writer
1 S postgres   993   987  0  80   0 - 99348 ep_pol 16:59 ?        00:00:00 postgres: walwriter
1 S postgres   994   987  0  80   0 - 99486 ep_pol 16:59 ?        00:00:00 postgres: autovacuum launcher
1 S postgres   995   987  0  80   0 - 62943 ep_pol 16:59 ?        00:00:00 postgres: stats collector
1 S postgres   996   987  0  80   0 - 99486 ep_pol 16:59 ?        00:00:00 postgres: logical replication launcher

</code></pre></div><p>下一步 为Praefect创建数据库</p> <div class="language- extra-class"><pre class="language-text"><code>刚开始想着从Praefect服务器直接连过来，发现失败

# the database template1 is used because it is created by default on all PostgreSQL servers.
/opt/gitlab/embedded/bin/psql -U postgres -d template1 -h POSTGRESQL_SERVER_ADDRESS

</code></pre></div><p>登录失败！ 需要修改监听端口和登录的方式，具体参考《database/postgresql》的设置说明</p> <p>另外如果有防火墙还要开端口</p> <p>firewall-cmd --permanent --add-port=5432/tcp</p> <p>firewall-cmd --reload</p> <div class="language- extra-class"><pre class="language-text"><code>su - postgres

psql
create user gitlabuser password 'gitlab';
CREATE ROLE praefect WITH LOGIN CREATEDB PASSWORD 'PRAEFECT_SQL_PASSWORD';
ALTER ROLE praefect with PASSWORD 'test';
然后再从Praefect服务器用新创建的用户连过来
/opt/gitlab/embedded/bin/psql -U praefect -d template1 -h X.X.X.134

&gt; CREATE DATABASE praefect_production WITH ENCODING=UTF8;
 By creating the database while connected as the praefect user, we are confident they have access.


template1=&gt; \du
                                   List of roles
 Role name |                         Attributes                         | Member of
-----------+------------------------------------------------------------+-----------
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
 praefect  | Create DB                                                  | {}
 
template1=&gt; CREATE DATABASE praefect_production WITH ENCODING=UTF8;
CREATE DATABASE
template1=&gt; \l
                                       List of databases
        Name         |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges
---------------------+----------+----------+-------------+-------------+-----------------------
 postgres            | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 praefect_production | praefect | UTF8     | en_US.UTF-8 | en_US.UTF-8 |
 template0           | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
                     |          |          |             |             | postgres=CTc/postgres
 template1           | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
                     |          |          |             |             | postgres=CTc/postgres
(4 rows)
template1-&gt; use tempalte1
template1-&gt; \dt
Did not find any relations.
template1-&gt; use template0
template1-&gt; \dt
Did not find any relations.
template1-&gt; use postgres
template1-&gt; \dt
Did not find any relations.
template1-&gt; use praefect_production
template1-&gt; \dt
Did not find any relations.

!!!
我发现后面我连了Praefect过来，同样全部为空，难道一台Praefect并没有用到这个db？？？
!!!
我错了，跟mysql语法不同！！！ Postgresql是用 \c praefect_production; 切换数据库！！！

/opt/gitlab/embedded/bin/psql -U praefect -d praefect_production -h &lt;POSTGRESQL_SERVER_ADDRESS&gt;

# create database gitlabdb with owner gitlab;
# alter database gitlabdb set search_path to sgc2,public;
# alter user gitlab set search_path to sgc2,public;

# create schema sgc2backup;
# create user arch password 'gitlab';
# alter user arch set search_path to sgc2backup;
# alter schema sgc2backup owner to arch;

# grant connect on database gitlabdb to arch;
# grant usage, create on schema sgc2backup to arch;

# GRANT USAGE ON SCHEMA sgc2backup TO gitlab;
# grant select on all tables in schema sgc2backup to gitlab;
# revoke insert,update,delete on all tables in schema sgc2backup from gitlab;

# GRANT USAGE ON SCHEMA sgc2 TO arch;
# grant select on all tables in schema sgc2 to arch;
# revoke insert,update,delete on all tables in schema sgc2 from arch;

</code></pre></div><p>卸载：</p> <div class="language- extra-class"><pre class="language-text"><code>rpm -e postgresql-server	
rpm -e postgresql-contrib	
rpm -e postgresql	
rpm -e postgresql-libs
</code></pre></div><h4 id="_3-1-2-gitaly-nodes"><a href="#_3-1-2-gitaly-nodes" class="header-anchor">#</a> 3.1.2 Gitaly Nodes</h4> <p>这次采用了yum localinstall 没有采用rpm -ivh 不知道后续再用rpm -uvh升级是否有问题</p> <div class="language- extra-class"><pre class="language-text"><code>Installing:.......

Thank you for installing GitLab!
GitLab was unable to detect a valid hostname for your instance.
Please configure a URL for your GitLab instance by setting `external_url`
configuration in /etc/gitlab/gitlab.rb file.
Then, you can start your GitLab instance by running the following command:
  sudo gitlab-ctl reconfigure

For a comprehensive list of configuration options please see the Omnibus GitLab readme
https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md
.....                                                                                             8/8

Installed:
  gitlab-ce.x86_64 0:13.0.7-ce.0.el7

Dependency Installed:
  audit-libs-python.x86_64 0:2.8.5-4.el7     checkpolicy.x86_64 0:2.5-8.el7        libcgroup.x86_64 0:0.41-21.el7     libsemanage-python.x86_64 0:2.5-14.el7     policycoreutils-python.x86_64 0:2.5-34.el7
  python-IPy.noarch 0:0.75-6.el7             setools-libs.x86_64 0:3.3.8-4.el7

Complete!
</code></pre></div><p>gitaly['listen_addr'] = '0.0.0.0:8075'</p> <p>gitaly['auth_token'] = 'PRAEFECT_INTERNAL_TOKEN'	对应 praefect</p> <div class="language- extra-class"><pre class="language-text"><code>praefect['virtual_storages'] = {
  'storage-1' =&gt; {
    'gitaly-1' =&gt; {
      'address' =&gt; 'tcp://GITALY_HOST:8075',
      'token'   =&gt; 'PRAEFECT_INTERNAL_TOKEN',
      'primary' =&gt; true
    },
    'gitaly-2' =&gt; {
      'address' =&gt; 'tcp://GITALY_HOST:8075',
      'token'   =&gt; 'PRAEFECT_INTERNAL_TOKEN'
    },
    'gitaly-3' =&gt; {
      'address' =&gt; 'tcp://GITALY_HOST:8075',
      'token'   =&gt; 'PRAEFECT_INTERNAL_TOKEN'
    }
  }
}
</code></pre></div><p>下面这两个是git push需要回调的</p> <p>gitlab_shell['secret_token'] = 'GITLAB_SHELL_SECRET_TOKEN' 这个是对应gitlab server配置的同样的token</p> <p># Don't forget to copy <code>/etc/gitlab/gitlab-secrets.json</code> from Gitaly client to Gitaly server. （？这句话是因为什么，是不是跟gitlab_shell['secret_token'] 不同的验证方式，公私钥验证？）</p> <p>gitlab_rails['internal_api_url'] = 'X.X.X.133:8088' 对应gitlab server API，</p> <p>internal_api_url 会在gitlab-ctl reconfigure的时候被赋值到/opt/gitlab/embedded/service/gitlab-shell/config.yml以及</p> <p>/var/opt/gitlab/gitlab-shell/config.yml，注意我发现gitlab server上的这个配置文件内容却是8080端口，可能对外统一都是8088，然后对内是8080</p> <div class="language- extra-class"><pre class="language-text"><code># Url to gitlab instance. Used for api calls. May but need not end with a slash.
gitlab_url: &quot;http://127.0.0.1:8080&quot;
</code></pre></div><p>就是对应的gitlab server上面的puma web服务（unicorn）</p> <h4 id="_3-1-3-测试连通性-健康检查"><a href="#_3-1-3-测试连通性-健康检查" class="header-anchor">#</a> 3.1.3 测试连通性|健康检查</h4> <p>单机版gitlab可以执行<code>gitlab-rake gitlab:check</code>即可全面单机检测</p> <p>但是对于我们的HA方案，即gitlab server-&gt;praefect-&gt;gitaly分开部署，则需要执行：</p> <div class="language- extra-class"><pre class="language-text"><code>postgresql server open port 5432 to praefect server;
​	on praefect server: sudo -u git /opt/gitlab/embedded/bin/praefect -config /var/opt/gitlab/praefect/config.toml sql-ping
/opt/gitlab/embedded/bin/psql -U praefect -d template1 -h X.X.X.134

praefect server open port 2305 and 9652 to gitlab server;
​	on gitlab server: gitlab-rake gitlab:gitaly:check
 sudo gitlab-rake gitlab:check SANITIZE=true

gitlab server open api 8080? to gitaly server;
​	on gitaly nodes: 
/opt/gitlab/embedded/service/gitlab-shell/bin/check -config /opt/gitlab/embedded/service/gitlab-shell/config.yml
or
/opt/gitlab/embedded/bin/gitaly-hooks check /var/opt/gitlab/gitaly/config.toml


gitaly server open 9236 to gitlab server;	

gitaly server open 8075 to praefect server; 
​	on praefect server: sudo /opt/gitlab/embedded/bin/praefect -config /var/opt/gitlab/praefect/config.toml dial-nodes

prometheus_listen_addr
Praefect的9652 和 Gitaly的9236：
grafana打开explorer，输入gitlab_build_info 结果中可以看到localhost的gitlab server，Praefect，以及三个Gitaly，如果看不到，就说明端口没有开启或者防火墙挡住
</code></pre></div><p>通信TOKEN</p> <p>可以用<code>tool: openssl rand -base64 32</code> 生成</p> <div class="language- extra-class"><pre class="language-text"><code>GITLAB_SHELL_SECRET_TOKEN: this is used by Git hooks to make callback HTTP API requests to GitLab when accepting a Git push. This secret is shared with GitLab Shell for legacy reasons.

PRAEFECT_EXTERNAL_TOKEN: repositories hosted on your Praefect cluster can only be accessed by Gitaly clients that carry this token.

PRAEFECT_INTERNAL_TOKEN: this token is used for replication traffic inside your Praefect cluster. This is distinct from PRAEFECT_EXTERNAL_TOKEN because Gitaly clients must not be able to access internal nodes of the Praefect cluster directly; that could lead to data loss.

PRAEFECT_SQL_PASSWORD: this password is used by Praefect to connect to PostgreSQL.

--------------------------------------------------------------------
--- gitlab server:
--------------------------------------------------------------------
git_data_dirs({
  &quot;default&quot; =&gt; {
    &quot;gitaly_address&quot; =&gt; &quot;tcp://&lt;PRAEFECT IP&gt;:2305&quot;,
    &quot;gitaly_token&quot; =&gt; 'PRAEFECT_EXTERNAL_TOKEN'
  }
})

gitlab_shell['secret_token'] = 'GITLAB_SHELL_SECRET_TOKEN'

--------------------------------------------------------------------
--- praefect:
--------------------------------------------------------------------
praefect['auth_token'] = 'PRAEFECT_EXTERNAL_TOKEN'


praefect['database_host'] = '&lt;TRACKING POSTGRESQL DATABASE IP&gt;'
praefect['database_port'] = 5432
praefect['database_user'] = 'praefect'
praefect['database_password'] = 'PRAEFECT_SQL_PASSWORD'
praefect['database_dbname'] = 'praefect_production'

# Name of storage hash must match storage name in git_data_dirs on GitLab
# server ('praefect') and in git_data_dirs on Gitaly nodes ('gitaly-1')
praefect['virtual_storages'] = {
  'default' =&gt; {
    'gitaly-1' =&gt; {
      'address' =&gt; 'tcp://&lt;GITALY VM1 IP&gt;:8075',
      'token'   =&gt; 'PRAEFECT_INTERNAL_TOKEN',
    },
    'gitaly-2' =&gt; {
      'address' =&gt; 'tcp://&lt;GITALY VM2 IP&gt;:8075',
      'token'   =&gt; 'PRAEFECT_INTERNAL_TOKEN'
    },
    'gitaly-3' =&gt; {
      'address' =&gt; 'tcp://&lt;GITALY VM3 IP&gt;:8075',
      'token'   =&gt; 'PRAEFECT_INTERNAL_TOKEN'
    }
  }
}
--------------------------------------------------------------------
--- gitaly:
--------------------------------------------------------------------
gitaly['auth_token'] = 'PRAEFECT_INTERNAL_TOKEN'

gitlab_shell['secret_token'] = 'GITLAB_SHELL_SECRET_TOKEN'
</code></pre></div><h3 id="_3-2-gitrail-server-multi-nodes"><a href="#_3-2-gitrail-server-multi-nodes" class="header-anchor">#</a> 3.2 gitrail-server multi-nodes</h3> <h4 id="官方方案"><a href="#官方方案" class="header-anchor">#</a> 官方方案</h4> <p>https://docs.gitlab.com/ee/administration/geo/replication/multiple_servers.html#geo-for-multiple-nodes-premium-only</p> <p>然后我顺着找到这个https://docs.gitlab.com/ee/administration/reference_architectures/index.html#traffic-load-balancer-starter-only</p> <blockquote><p>This requires separating out GitLab into multiple application nodes with an added <a href="https://docs.gitlab.com/ee/administration/high_availability/load_balancer.html" target="_blank" rel="noopener noreferrer">load balancer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The load balancer will distribute traffic across GitLab application nodes. Meanwhile, each application node connects to a shared file server and database systems on the back end. This way, if one of the application servers fails, the workflow is not interrupted. <a href="https://www.haproxy.org/" target="_blank" rel="noopener noreferrer">HAProxy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is recommended as the load balancer.</p> <p>Supported tiers: <a href="https://about.gitlab.com/pricing/" target="_blank" rel="noopener noreferrer">GitLab Starter, Premium, and Ultimate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>可以看到这个是要付费后才支持的，主要就是如何配置share db；</p> <p>还有几个疑问：redis不需要分离吗？ session存储在哪里，如何share？有几种可能：
1.load Balancer可以有策略让一个用户整个session期间只连接固定一个Application server，所以不会有session共享问题
2.session写到了db，按这里文档所说分离share db即可
3.session写到redis，分离share redis即可（但是文档此处没有提redis）
4.session写到Application memory，这个解决只能用方法1</p> <p>https://docs.gitlab.com/ee/administration/high_availability/load_balancer.html#load-balancer-for-multi-node-gitlab</p> <p>这个是在gitlab scope之外，采用外部的负载均衡，</p> <p>跟gitlab沟通的结果发现，他们故意这种搞，就是为了卖他们的premium account所带的技术支持服务，</p> <p>当然我推测了下，上面说的 shared file server应该是指Gitaly nodes，那么database system是指postgresql，然后我从gitlab server的config里面看到</p> <div class="language- extra-class"><pre class="language-text"><code>### GitLab database settings
###! Docs: https://docs.gitlab.com/omnibus/settings/database.html
###! **Only needed if you use an external database.**
# gitlab_rails['db_adapter'] = &quot;postgresql&quot;
# gitlab_rails['db_encoding'] = &quot;unicode&quot;
# gitlab_rails['db_collation'] = nil
# gitlab_rails['db_database'] = &quot;gitlabhq_production&quot;
# gitlab_rails['db_pool'] = 1
# gitlab_rails['db_username'] = &quot;gitlab&quot;
# gitlab_rails['db_password'] = nil
# gitlab_rails['db_host'] = nil
# gitlab_rails['db_port'] = 5432
# gitlab_rails['db_socket'] = nil
# gitlab_rails['db_sslmode'] = nil
# gitlab_rails['db_sslcompression'] = 0
# gitlab_rails['db_sslrootcert'] = nil
# gitlab_rails['db_sslcert'] = nil
# gitlab_rails['db_sslkey'] = nil
# gitlab_rails['db_prepared_statements'] = false
# gitlab_rails['db_statements_limit'] = 1000


### GitLab Redis settings
###! Connect to your own Redis instance
###! Docs: https://docs.gitlab.com/omnibus/settings/redis.html

#### Redis TCP connection
# gitlab_rails['redis_host'] = &quot;127.0.0.1&quot;
# gitlab_rails['redis_port'] = 6379
# gitlab_rails['redis_ssl'] = false
# gitlab_rails['redis_password'] = nil
# gitlab_rails['redis_database'] = 0
# gitlab_rails['redis_enable_client'] = true
</code></pre></div><p>所以推测只需要按照如下文档建立一个外部db即可</p> <p>https://docs.gitlab.com/omnibus/settings/database.html</p> <p>https://docs.gitlab.com/omnibus/settings/database.html#using-a-non-packaged-postgresql-database-management-server</p> <p>https://docs.gitlab.com/ee/install/requirements.html#database</p> <p>但是还有个问题，redis是不是也要剥离到外部？从配置文件看确实可以，但是这些弄下来需要的机器实在不少，而且也是难以维护，所3以我没有尝试；</p> <h4 id="备份方案"><a href="#备份方案" class="header-anchor">#</a> 备份方案</h4> <p>method 1： back &amp; restore</p> <p>https://docs.gitlab.com/ee/raketasks/backup_restore.html</p> <p>https://docs.gitlab.com/omnibus/settings/backups.html</p> <div class="language- extra-class"><pre class="language-text"><code>uninstall...
install same version as the source machine
systemctl start gitlab-runsvdir
sudo gitlab-ctl reconfigure
sudo gitlab-ctl start
from source:
sudo scp root@X.X.X.133:/var/opt/gitlab/backups/1600046306_2020_09_14_13.3.0-ee_gitlab_backup.tar /var/opt/gitlab/backups/
sudo chown git.git /var/opt/gitlab/backups/1600046306_2020_09_14_13.3.0-ee_gitlab_backup.tar

sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop puma
sudo gitlab-ctl stop sidekiq
# Verify
sudo gitlab-ctl status

# This command will overwrite the contents of your GitLab database! 
sudo gitlab-backup restore BACKUP=/var/opt/gitlab/backups/1600046306_2020_09_14_13.3.0-ee_gitlab_backup.tar
The backup file 1600046306_2020_09_14_13.3.0-ee_gitlab_backup_gitlab_backup.tar does not exist!

sudo gitlab-backup restore 不加参数居然是可以工作的，所以/var/opt/gitlab/backups下面只放一个tar

restore `/etc/gitlab/gitlab-secrets.json`
sudo scp root@X.X.X.133:/etc/gitlab/config_backup/gitlab_config_1598345534_2020_08_25.tar /etc/gitlab/
sudo mv /etc/gitlab /etc/gitlab.$(date +%s)
sudo tar -xf gitlab_config_1598345534_2020_08_25.tar -C /
tar: Removing leading `/' from member names 这句话不知道什么意思

vim /etc/gitlab/gitlab.rb 修改external_url
sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
注意执行上面一句的时候要等一会才开始执行下面的检查，否则会抛很多错误
sudo gitlab-rake gitlab:check SANITIZE=true
  
开放相应的端口，并进行连通性检测
gitlab server open api 8080? to gitaly server;

修改Gitaly nodes的internal_api_url
</code></pre></div><p>method 2：rsync</p> <p>安装rsync实现自动增量同步到远端</p> <p>参考《linux/rsync》</p> <p>https://www.jianshu.com/p/bc45631aa561</p> <div class="language- extra-class"><pre class="language-text"><code>------------------------------------------------
--- 服务器端
------------------------------------------------
yum install rsync

vim /etc/rsyncd.conf
​```
# /etc/rsyncd: configuration file for rsync daemon mode

# See rsyncd.conf man page for more options.

# configuration example:

uid = root
gid = root
use chroot = no
#port = 973
# max connections = 4
pid file = /var/run/rsyncd.pid
log file = /var/rsync/rsyncd.log
secrets file = /etc/rsync.password
# exclude = lost+found/
# transfer logging = yes
# timeout = 900
# ignore nonreadable = yes
# dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2

# [ftp]
#        path = /home/ftp
#        comment = ftp export area
[gitlab_path1]
comment = &quot;/opt/gitlab&quot;
path = /opt/gitlab
auth users = root, rsync_backup
read only = yes 
list = yes 
hosts allow = &lt;DEST IP&gt;
hosts deny = *
[gitlab_path2]
comment = &quot;/var/opt/gitlab&quot;
path = /var/opt/gitlab
auth users = root, rsync_backup
read only = yes
list = yes 
hosts allow = &lt;DEST IP&gt;
hosts deny = *
[gitlab_path3]
comment = &quot;/etc/gitlab&quot;
path = /etc/gitlab
auth users = root, rsync_backup
read only = yes 
list = yes 
hosts allow = &lt;DEST IP&gt;
hosts deny = *
[gitlab_path4]
comment = &quot;/var/log/gitlab&quot;
path = /var/log/gitlab
auth users = root, rsync_backup
read only = yes 
list = yes 
hosts allow = &lt;DEST IP&gt;
hosts deny = *
[gitlab_path5]
comment = &quot;/run/gitlab&quot;
path = /run/gitlab
auth users = root, rsync_backup
read only = yes 
list = yes 
hosts allow = &lt;DEST IP&gt;
hosts deny = *
​```

echo &quot;rsync_backup:1&quot; &gt;/etc/rsync.password  
chmod 600 /etc/rsync.password

firewall-cmd --permanent --add-port=873/tcp
firewall-cmd --reload

------------------------------------------------
--- 客户端
------------------------------------------------
yum install rsync

echo &quot;1&quot; &gt;/etc/rsync.password  
chmod 600 /etc/rsync.password

vim /opt/gitlab_rsync.sh

rsync -avz --delete rsync_backup@&lt;SOURCE IP&gt;::gitlab_path1 /opt/gitlab --password-file=/etc/rsync.password &gt;/dev/null 2&gt;&amp;1
rsync -avz --delete rsync_backup@&lt;SOURCE IP&gt;::gitlab_path2 /var/opt/gitlab --password-file=/etc/rsync.password &gt;/dev/null 2&gt;&amp;1
rsync -avz --delete rsync_backup@&lt;SOURCE IP&gt;::gitlab_path3 /etc/gitlab --password-file=/etc/rsync.password &gt;/dev/null 2&gt;&amp;1
rsync -avz --delete rsync_backup@&lt;SOURCE IP&gt;::gitlab_path4 /var/log/gitlab --password-file=/etc/rsync.password &gt;/dev/null 2&gt;&amp;1
rsync -avz --delete rsync_backup@&lt;SOURCE IP&gt;::gitlab_path5 /run/gitlab --password-file=/etc/rsync.password &gt;/dev/null 2&gt;&amp;1

chmod 755 /opt/gitlab_rsync.sh

echo &quot;00 3 * * * root /opt/gitlab_rsync.sh&quot; &gt;&gt; /etc/crontab

</code></pre></div><h3 id="_3-3-postgresql-replication"><a href="#_3-3-postgresql-replication" class="header-anchor">#</a> 3.3 Postgresql Replication</h3> <p>GEO 这个不需要https://docs.gitlab.com/ee/administration/geo/replication/index.html</p> <p>需要的是gitlab-server Application Database和Praefect tracking database</p> <h3 id="_3-4-ha-roles"><a href="#_3-4-ha-roles" class="header-anchor">#</a> 3.4 ？？HA Roles</h3> <p>https://docs.gitlab.com/omnibus/roles/README.html#</p> <p>The majority of the following roles will only work on a GitLab Enterprise Edition, meaning a gitlab-ee Omnibus package. It will be mentioned next to each role.</p> <p>没太搞懂，直接通过配置多个节点？ee才可以用</p> <p>redis roles</p> <p>https://docs.gitlab.com/omnibus/roles/README.html#redis-server-roles</p> <h2 id="_4-maintenance-维护"><a href="#_4-maintenance-维护" class="header-anchor">#</a> 4. Maintenance 维护</h2> <p>https://docs.gitlab.com/omnibus/maintenance/README.html</p> <h3 id="数据管理"><a href="#数据管理" class="header-anchor">#</a> 数据管理</h3> <h4 id="gitlab-server-workhorse"><a href="#gitlab-server-workhorse" class="header-anchor">#</a> gitlab server(workhorse)</h4> <h5 id="gitlab-rails-dbconsole"><a href="#gitlab-rails-dbconsole" class="header-anchor">#</a> gitlab-rails dbconsole</h5> <p>gitlabhq_production=&gt;\dt</p> <h5 id="gitlab-rails-console-users-and-products"><a href="#gitlab-rails-console-users-and-products" class="header-anchor">#</a> gitlab-rails console &gt;&gt; users and products</h5> <p>https://docs.gitlab.com/ee/administration/troubleshooting/navigating_gitlab_via_rails_console.html</p> <p>密码默认8位</p> <div class="language- extra-class"><pre class="language-text"><code>user=User.where(username: 'test1').first
user.password
user.password='12345678'
user.password_confirmation='12345678'
user.save
Enqueued ActionMailer::DeliveryJob (Job ID: 1fd0a22c-6908-45bd-b0b1-35f4da4aad25) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, #&lt;GlobalID:0x00007fd3a9a03370 @uri=#&lt;URI::GID gid://gitlab/User/2&gt;&gt;
=&gt; true
</code></pre></div><p>Access control</p> <p>https://docs.gitlab.com/ee/security/README.html#securing-your-gitlab-installation</p> <h4 id="praefect-database"><a href="#praefect-database" class="header-anchor">#</a> praefect database</h4> <div class="language- extra-class"><pre class="language-text"><code>su - postgres
-bash-4.2$ psql
postgres-# \c praefect_production;
praefect_production-# \dt
</code></pre></div><h4 id="gitaly-repository"><a href="#gitaly-repository" class="header-anchor">#</a> gitaly repository</h4> <p>ls /var/opt/gitlab/git-data/repositories</p> <h3 id="migration-迁移"><a href="#migration-迁移" class="header-anchor">#</a> Migration 迁移</h3> <p>https://about.gitlab.com/handbook/customer-success/playbooks/server-migrations.html</p> <p>https://docs.gitlab.com/omnibus/settings/backups.html</p> <h4 id="配置备份-backup-and-restore-omnibus-gitlab-configuration"><a href="#配置备份-backup-and-restore-omnibus-gitlab-configuration" class="header-anchor">#</a> 配置备份 Backup and restore Omnibus GitLab configuration</h4> <p>It is recommended to keep a copy of <code>/etc/gitlab</code>, or at least of <code>/etc/gitlab/gitlab-secrets.json</code>, in a safe place. If you ever need to restore a GitLab application backup you need to also restore <code>gitlab-secrets.json</code>. If you do not, GitLab users who are using two-factor authentication will lose access to your GitLab server and ‘secure variables’ stored in GitLab CI will be lost.</p> <p>Your machines SSH host keys are stored in a separate location at <code>/etc/ssh/</code>. Be sure to also <a href="https://superuser.com/questions/532040/copy-ssh-keys-from-one-server-to-another-server/532079#532079" target="_blank" rel="noopener noreferrer">backup and restore those keys<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to avoid man-in-the-middle attack warnings if you have to perform a full machine restore.</p> <p>do not store your GitLab application backups (Git repositories, SQL data) in the same place as your configuration backup (<code>/etc/gitlab</code>). The <code>gitlab-secrets.json</code> file (and possibly also the <code>gitlab.rb</code> file) contain database encryption keys to protect sensitive data in the SQL database:</p> <ul><li>GitLab two-factor authentication (2FA) user secrets (‘QR codes’)</li> <li>GitLab CI ‘secure variables’</li></ul> <div class="language- extra-class"><pre class="language-text"><code>MANUAL BACKUP:
`gitlab-ctl backup-etc`
Configuration backup archive complete: /etc/gitlab/config_backup/gitlab_config_1598345534_2020_08_25.tar

AUTO BACKUP:
sudo crontab -e -u root
schedule the backup to run every morning after a weekday, Tuesday (day 2) through Saturday (day 6):
15 04 * * 2-6  gitlab-ctl backup-etc &amp;&amp; cd /etc/gitlab/config_backup &amp;&amp; cp $(ls -t | head -n1) /secret/gitlab/backups/

注意要设置好Limit backup lifetime for local files (prune old backups)
否则会磁盘写满
## Limit backup lifetime to 7 days - 604800 seconds
gitlab_rails['backup_keep_time'] = 604800

RESTORE:
# Rename the existing /etc/gitlab, if any
sudo mv /etc/gitlab /etc/gitlab.$(date +%s)
# Change the example timestamp below for your configuration backup
sudo tar -xf gitlab_config_1487687824_2017_02_21.tar -C /
sudo gitlab-ctl reconfigure
</code></pre></div><h4 id="creating-an-application-backup"><a href="#creating-an-application-backup" class="header-anchor">#</a> Creating an application backup</h4> <p>https://docs.gitlab.com/ee/raketasks/backup_restore.html</p> <p>GitLab provides a simple command line interface to back up your whole instance. It backs up your:</p> <ul><li>Database</li> <li>Attachments</li> <li>Git repositories data</li> <li>CI/CD job output logs</li> <li>CI/CD job artifacts</li> <li>LFS objects</li> <li>Container Registry images</li> <li>GitLab Pages content</li></ul> <p>The <a href="https://docs.gitlab.com/ee/raketasks/backup_restore.html#back-up-gitlab" target="_blank" rel="noopener noreferrer">backup Rake task<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> GitLab provides does <strong>not</strong> store your configuration files. The primary reason for this is that your database contains encrypted information for two-factor authentication, the CI/CD ‘secure variables’, and so on. Storing encrypted information along with its key in the same place defeats the purpose of using encryption in the first place.</p> <p><strong>prerequisites：</strong></p> <p>sudo yum install rsync</p> <p><strong>START</strong></p> <div class="language- extra-class"><pre class="language-text"><code>#手动
sudo gitlab-backup create GZIP_RSYNCABLE=yes 
Creating backup archive: 1599013473_2020_09_02_13.3.0-ee_gitlab_backup.tar ... done
Uploading backup archive to remote storage  ... skipped
Deleting tmp directories ... done
done
done
done
done
done
done
done
Deleting old backups ... skipping
Warning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data
and are not included in this backup. You will need these files to restore a backup.
Please back them up manually.
Backup task is done.

/var/opt/gitlab/backups/1599013473_2020_09_02_13.3.0-ee_gitlab_backup.tar

#自动
sudo su -
crontab -e
0 2 * * * /opt/gitlab/bin/gitlab-backup create GZIP_RSYNCABLE=yes CRON=1
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>##STRATEGY:
default streaming strategy:
sudo gitlab-backup create

sudo gitlab-backup create STRATEGY=copy

To make sure the generated archive is intelligently transferable by rsync, the GZIP_RSYNCABLE=yes option can be set. This will set the --rsyncable option to gzip：
sudo gitlab-backup GZIP_RSYNCABLE=yes

##STORE:
Backup create will store a tar file in `/var/opt/gitlab/backups`.

If you want to store your GitLab backups in a different directory, add the following setting to `/etc/gitlab/gitlab.rb` and run `sudo gitlab-ctl reconfigure`:
gitlab_rails['backup_path'] = '/mnt/backups'

##SKIP:
db (database)
uploads (attachments)
repositories (Git repositories data)
builds (CI job output logs)
artifacts (CI job artifacts)
lfs (LFS objects)
registry (Container Registry images)
pages (Pages content)

sudo gitlab-backup create SKIP=db,uploads

In some cases (for example, if the backup is picked up by other backup software) creating a .tar file might be wasted effort or even directly harmful, so you can skip this step by adding tar to the SKIP environment variable:
sudo gitlab-backup create SKIP=tar

##UPLOAD:

Upload to Remote: Specifying a custom directory for backups:
sudo gitlab-backup create DIRECTORY=daily
sudo gitlab-backup create DIRECTORY=weekly

Upload to Local mounted shares:
gitlab_rails['backup_upload_connection'] = {
  :provider =&gt; 'Local',
  :local_root =&gt; '/mnt/backups'
}

# The directory inside the mounted folder to copy backups to
# Use '.' to store them in the root directory
gitlab_rails['backup_upload_remote_directory'] = 'gitlab_backups'

##PERMISSION:
gitlab_rails['backup_archive_permissions'] = 0644 # Makes the backup archives world-readable


## Limit backup lifetime to 7 days - 604800 seconds
gitlab_rails['backup_keep_time'] = 604800

</code></pre></div><p>Daily Backup:</p> <div class="language- extra-class"><pre class="language-text"><code>sudo su -
crontab -e

to schedule the backup for everyday at 2 AM:
0 2 * * * /opt/gitlab/bin/gitlab-backup create CRON=1
</code></pre></div><h4 id="restore"><a href="#restore" class="header-anchor">#</a> Restore:</h4> <p><strong>prerequisites</strong></p> <p>!!You can only restore a backup to <strong>exactly the same version and type (CE/EE)</strong> of GitLab that you created it on, for example CE 9.1.0!!</p> <p>need to restore <code>/etc/gitlab/gitlab-secrets.json</code>This file contains the database encryption key, <a href="https://docs.gitlab.com/ee/ci/variables/README.html#gitlab-cicd-environment-variables" target="_blank" rel="noopener noreferrer">CI/CD variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and variables used for <a href="https://docs.gitlab.com/ee/user/profile/account/two_factor_authentication.html" target="_blank" rel="noopener noreferrer">two-factor authentication<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. If you fail to restore this encryption key file along with the application data backup, users with two-factor authentication enabled and GitLab Runners will lose access to your GitLab server.</p> <ul><li>You have run <code>sudo gitlab-ctl reconfigure</code> at least once.</li> <li>GitLab is running. If not, start it using <code>sudo gitlab-ctl start</code>.</li></ul> <p><strong>Note:</strong> There is currently a <a href="https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/3470" target="_blank" rel="noopener noreferrer">known issue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for restore not working with <code>pgbouncer</code>. In order to workaround the issue, the Rails node will need to bypass <code>pgbouncer</code> and connect directly to the primary database node. This can be done by setting <code>gitlab_rails['db_host']</code> and <code>gitlab_rails['port']</code> to connect to the primary database node and <a href="https://docs.gitlab.com/ee/administration/restart_gitlab.html#omnibus-gitlab-reconfigure" target="_blank" rel="noopener noreferrer">reconfiguring GitLab<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p><strong>START:</strong></p> <p>make sure your backup tar file is in the backup directory described in the <code>gitlab.rb</code> configuration <code>gitlab_rails['backup_path']</code>. The default is <code>/var/opt/gitlab/backups</code>. It needs to be owned by the <code>git</code> user.</p> <div class="language- extra-class"><pre class="language-text"><code>sudo cp 11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar /var/opt/gitlab/backups/
sudo chown git.git /var/opt/gitlab/backups/11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar
</code></pre></div><p>Stop the processes that are connected to the database. Leave the rest of GitLab running:</p> <div class="language- extra-class"><pre class="language-text"><code>sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop puma
sudo gitlab-ctl stop sidekiq
# Verify
sudo gitlab-ctl status
</code></pre></div><p>Restore the backup, specifying the timestamp of the backup you wish to restore:</p> <div class="language- extra-class"><pre class="language-text"><code># This command will overwrite the contents of your GitLab database! 
sudo gitlab-backup restore BACKUP=11493107454_2018_04_25_10.6.4-ce
</code></pre></div><p>Next, restore <code>/etc/gitlab/gitlab-secrets.json</code> if necessary as mentioned above.</p> <p>Reconfigure, restart and check GitLab:</p> <div class="language- extra-class"><pre class="language-text"><code>sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
sudo gitlab-rake gitlab:check SANITIZE=true
</code></pre></div><h3 id="服务升级-upgrade-policy-卸载"><a href="#服务升级-upgrade-policy-卸载" class="header-anchor">#</a> 服务升级(upgrade policy)+卸载</h3> <h4 id="主要规则"><a href="#主要规则" class="header-anchor">#</a> 主要规则</h4> <p>Although you can generally upgrade through multiple GitLab versions in one go, sometimes this can cause issues.</p> <p><strong>升级到 minor version</strong></p> <p><a href="https://docs.gitlab.com/ee/update/#upgrade-paths" target="_blank" rel="noopener noreferrer">upgrade path<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>When not explicitly specified, upgrade GitLab to the latest available patch release rather than the first patch release, for example 13.8.8 instead of 13.8.0. This includes versions you must stop at on the upgrade path as there may be fixes for issues relating to the upgrade process. Specifically around a major version, crucial database schema and migration patches are included in the latest patch releases.</p> <p><strong>升级到 major version</strong>
Upgrading the major version requires more attention. Backward-incompatible changes and migrations are reserved for major versions. Follow the directions carefully as we cannot guarantee that upgrading between major versions is seamless.</p> <p>A major upgrade requires the following steps:</p> <ul><li>Start by identifying a supported upgrade path. This is essential for a successful major version upgrade.</li> <li>Upgrade to the latest minor version of the preceding major version.</li> <li>Upgrade to the “dot zero” release of the next major version (X.0.Z).</li> <li>Optional. Follow the upgrade path, and proceed with upgrading to newer releases of that major version.</li></ul> <p>关于upgrade path，gitlab不保证每次升级都是100%成功的：</p> <p>Find where your version sits in the upgrade path below, and upgrade GitLab accordingly, while also consulting the <a href="https://docs.gitlab.com/ee/update/README.html#version-specific-upgrading-instructions" target="_blank" rel="noopener noreferrer">version-specific upgrade instructions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>” 例如参考Troubleshooting中的“版本升级后出现500无法访问project”</p> <h4 id="升级"><a href="#升级" class="header-anchor">#</a> 升级</h4> <p>https://docs.gitlab.com/ee/update/package/index.html</p> <ol><li>执行 background_migration
When upgrading to a new major version, remember to first <a href="https://docs.gitlab.com/ee/update/background_migrations.html" target="_blank" rel="noopener noreferrer">check for background migrations<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ol> <div class="language- extra-class"><pre class="language-text"><code>sudo gitlab-rails runner -e production 'puts Gitlab::BackgroundMigration.remaining'
sudo gitlab-rails runner -e production 'puts Gitlab::Database::BackgroundMigration::BatchedMigration.queued.count'
For GitLab 14.0-14.9:
sudo gitlab-rails runner -e production 'puts Gitlab::Database::BackgroundMigration::BatchedMigration.failed.count'
For GitLab 14.10 and later:
sudo gitlab-rails runner -e production 'puts Gitlab::Database::BackgroundMigration::BatchedMigration.with_status(:failed).count'
</code></pre></div><p>On the top bar, select Main menu &gt; Admin.
On the left sidebar, select Monitoring &gt; Background Migrations.</p> <ol start="2"><li>按照确定的Upgrade path开始安装</li></ol> <p>The GitLab database is backed up before installing a newer GitLab version. You may skip this automatic database backup by creating an empty file at /etc/gitlab/skip-auto-backup</p> <div class="language- extra-class"><pre class="language-text"><code>rpm -Uvh &lt;package_name&gt; 

#Upgrade complete! If your GitLab server is misbehaving try running
sudo gitlab-ctl restart

</code></pre></div><h4 id="升级后检查"><a href="#升级后检查" class="header-anchor">#</a> 升级后检查</h4> <p><strong>健康检查:</strong></p> <div class="language- extra-class"><pre class="language-text"><code>sudo gitlab-ctl status
sudo gitlab-rake gitlab:check SANITIZE=true

gitlab-rake gitlab:check | grep no
gitlab-rake db:migrate:status | grep down
</code></pre></div><p><strong>查看版本号：</strong></p> <p>https://docs.gitlab.com/omnibus/package-information/
Once the Omnibus GitLab package is installed, all versions of the bundled libraries are located in /opt/gitlab/version-manifest.txt.</p> <div class="language- extra-class"><pre class="language-text"><code>gitlab server上可以执行： 
gitlab-rake gitlab:env:info

Praefect和Gitaly上面不可以，可以通过：
yum list installed|grep &quot;gitlab&quot;
或
cat /opt/gitlab/version-manifest.txt
</code></pre></div><h4 id="坑"><a href="#坑" class="header-anchor">#</a> 坑</h4> <p>这里有关于升级的policy：</p> <p>要注意：大小版本、ce还是ee及安装方法</p> <p>https://docs.gitlab.com/ee/update/</p> <p>比如如果是手动rpm package安装，参考：</p> <p>https://docs.gitlab.com/omnibus/update</p> <p>对于集群有个坑：Praefect和Gitaly升级都没问题，但是对于gitlab server，如果是在停止状态下升级，会出现错误，因为gitlab server升级时会进行自动备份，服务都停了就无法备份了，所以要<code>sudo touch /etc/gitlab/skip-auto-backup</code>关掉自动backup即可</p> <p>其他如下：</p> <p>gitlab-ctl stop的坑：如果刚好你还在某个console里面，stop虽然显示全部down，但是ps -e|grep gitlab以及ps -e|grep postgres还是会看到一堆服务，</p> <p><s>所以退出正在使用的所有gitlab console，再一次执行gitlab-ctl stop，实在不行进行kill -9或者gitlab-ctl kill <service></service></s></p> <p>如果是卸载还需要关闭一个服务：</p> <div class="language- extra-class"><pre class="language-text"><code>systemctl disable gitlab-runsvdir
systemctl stop gitlab-runsvdir
</code></pre></div><p>注意:升级之后,之前的备份就会失效,意思是无法用之前的backup restore,只能降级,所以升级之后建立尽快做备份</p> <div class="language- extra-class"><pre class="language-text"><code>(optional)
gitlab-ctl cleanse

/root/gitlab-cleanse-2020-08-20T16:28/config_backup

1、停止gitlab
gitlab-ctl stop
2、卸载gitlab（注意这里写的是gitlab-ce）
rpm -e gitlab-ce
#systemctl disable gitlab-runsvdir (如果不想重装)
systemctl stop gitlab-runsvdir
3、查看gitlab进程
ps -lef | grep gitlab
4、杀掉第一个进程（就是带有好多.............的进程）
 kill -9 18777
杀掉后，在ps aux | grep gitlab确认一遍，还有没有gitlab的进程
5、删除所有包含gitlab文件
find / -name gitlab | xargs rm -rf
yum localinstall gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm
scp root@X.X.X.136:/etc/gitlab/gitlab.rb /etc/gitlab/
vim /etc/gitlab/gitlab.rb
# ruby_block[wait for praefect service socket] action run
systemctl start gitlab-runsvdir
gitlab-ctl reconfigure
</code></pre></div><h4 id="升级例子"><a href="#升级例子" class="header-anchor">#</a> 升级例子</h4> <p>gitlab 13.8.8 升级到 14.3.6</p> <div class="language- extra-class"><pre class="language-text"><code>1.
sudo gitlab-rails runner -e production 'puts Gitlab::BackgroundMigration.remaining'
rpm -Uvh gitlab-ee-13.8.8-ce.0.el7.x86_64.rpm
gitlab-rake gitlab:env:info
gitlab-rake gitlab:check | grep no
gitlab-rake db:migrate:status | grep down
sudo gitlab-ctl restart
check dashboard

2.
sudo gitlab-rails runner -e production 'puts Gitlab::BackgroundMigration.remaining'
rpm -Uvh gitlab-ee-13.12.15-ce.0.el7.x86_64.rpm
gitlab-rake gitlab:env:info
gitlab-rake gitlab:check | grep no
gitlab-rake db:migrate:status | grep down
sudo gitlab-ctl restart
check dashboard

3.
sudo gitlab-rails runner -e production 'puts Gitlab::BackgroundMigration.remaining'
rpm -Uvh gitlab-ee-14.0.12-ce.0.el7.x86_64.rpm
gitlab-rake gitlab:env:info
gitlab-rake gitlab:check | grep no
gitlab-rake db:migrate:status | grep down
sudo gitlab-ctl restart
check dashboard

4.
sudo gitlab-rails runner -e production 'puts Gitlab::BackgroundMigration.remaining'
sudo gitlab-rails runner -e production 'puts Gitlab::Database::BackgroundMigration::BatchedMigration.queued.count'
sudo gitlab-rails runner -e production 'puts Gitlab::Database::BackgroundMigration::BatchedMigration.failed.count'
rpm -Uvh gitlab-ee-14.3.6-ce.0.el7.x86_64.rpm
gitlab-rake gitlab:env:info
gitlab-rake gitlab:check | grep no
gitlab-rake db:migrate:status | grep down
sudo gitlab-ctl restart
check dashboard

</code></pre></div><h2 id="_5-cicd"><a href="#_5-cicd" class="header-anchor">#</a> 5. CICD</h2> <p>https://docs.gitlab.com/ee/ci/README.html</p> <p>https://docs.gitlab.com/ee/ci/variables/</p> <h3 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h3> <p>CICD 典型workflow</p> <p><img src="/docs/docs_image/software/project_manage/git/gitlab_workflow_example.png" alt=""></p> <p><img src="/docs/docs_image/software/project_manage/git/gitlab_workflow_example_extended.png" alt=""></p> <ol><li>Verify:
<ul><li>Automatically build and test your application with Continuous Integration.</li> <li>Analyze your source code quality with <a href="https://docs.gitlab.com/ee/user/project/merge_requests/code_quality.html" target="_blank" rel="noopener noreferrer">GitLab Code Quality<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Determine the browser performance impact of code changes with <a href="https://docs.gitlab.com/ee/user/project/merge_requests/browser_performance_testing.html" target="_blank" rel="noopener noreferrer">Browser Performance Testing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Determine the server performance impact of code changes with <a href="https://docs.gitlab.com/ee/user/project/merge_requests/load_performance_testing.html" target="_blank" rel="noopener noreferrer">Load Performance Testing<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Perform a series of tests, such as <a href="https://docs.gitlab.com/ee/user/application_security/container_scanning/index.html" target="_blank" rel="noopener noreferrer">Container Scanning<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> , <a href="https://docs.gitlab.com/ee/user/application_security/dependency_scanning/index.html" target="_blank" rel="noopener noreferrer">Dependency Scanning<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> , and <a href="https://docs.gitlab.com/ee/ci/unit_test_reports.html" target="_blank" rel="noopener noreferrer">Unit tests<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Deploy your changes with <a href="https://docs.gitlab.com/ee/ci/review_apps/index.html" target="_blank" rel="noopener noreferrer">Review Apps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to preview the app changes on every branch.</li></ul></li> <li>Package:
<ul><li>Store Docker images with the <a href="https://docs.gitlab.com/ee/user/packages/container_registry/index.html" target="_blank" rel="noopener noreferrer">Container Registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Store packages with the <a href="https://docs.gitlab.com/ee/user/packages/package_registry/index.html" target="_blank" rel="noopener noreferrer">Package Registry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul></li> <li>Release:
<ul><li>Continuous Deployment, automatically deploying your app to production.</li> <li>Continuous Delivery, manually click to deploy your app to production.</li> <li>Deploy static websites with <a href="https://docs.gitlab.com/ee/user/project/pages/index.html" target="_blank" rel="noopener noreferrer">GitLab Pages<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Ship features to only a portion of your pods and let a percentage of your user base to visit the temporarily deployed feature with <a href="https://docs.gitlab.com/ee/user/project/canary_deployments.html" target="_blank" rel="noopener noreferrer">Canary Deployments<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Deploy your features behind <a href="https://docs.gitlab.com/ee/operations/feature_flags.html" target="_blank" rel="noopener noreferrer">Feature Flags<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Add release notes to any Git tag with <a href="https://docs.gitlab.com/ee/user/project/releases/index.html" target="_blank" rel="noopener noreferrer">GitLab Releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>View of the current health and status of each CI environment running on Kubernetes with <a href="https://docs.gitlab.com/ee/user/project/deploy_boards.html" target="_blank" rel="noopener noreferrer">Deploy Boards<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Deploy your application to a production environment in a Kubernetes cluster with <a href="https://docs.gitlab.com/ee/topics/autodevops/stages.html#auto-deploy" target="_blank" rel="noopener noreferrer">Auto Deploy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul></li></ol> <p>With GitLab CI/CD you can also:</p> <ul><li>Easily set up your app’s entire lifecycle with <a href="https://docs.gitlab.com/ee/topics/autodevops/index.html" target="_blank" rel="noopener noreferrer">Auto DevOps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Deploy your app to different <a href="https://docs.gitlab.com/ee/ci/environments/index.html" target="_blank" rel="noopener noreferrer">environments<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Install your own <a href="https://docs.gitlab.com/runner/" target="_blank" rel="noopener noreferrer">GitLab Runner<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><a href="https://docs.gitlab.com/ee/ci/pipelines/schedules.html" target="_blank" rel="noopener noreferrer">Schedule pipelines<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Check for app vulnerabilities with <a href="https://docs.gitlab.com/ee/user/application_security/index.html" target="_blank" rel="noopener noreferrer">Security Test reports<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <h3 id="key-concepts"><a href="#key-concepts" class="header-anchor">#</a> Key Concepts</h3> <p><strong>.gitlab-ci.yml</strong>
GitLab CI/CD is configured by a file called .gitlab-ci.yml placed at the repository’s root.
This file creates a pipeline, which runs for changes to the code in the repository. Pipelines consist of one or more stages that run in order and can each contain one or more jobs that run in parallel. These jobs (or scripts) get executed by the GitLab Runner agent.</p> <p>.gitlab-ci.yml模板：
https://gitlab.com/gitlab-org/gitlab-foss/tree/master/lib/gitlab/ci/templates</p> <p>pre-defined variables
https://docs.gitlab.com/ee/ci/variables/predefined_variables.html</p> <p><strong>ci_settings.xml</strong>
serves as Maven’s settings.xml file
https://docs.gitlab.com/ee/user/packages/maven_repository/</p> <p><strong>Pipeline</strong></p> <p>https://docs.gitlab.com/ee/ci/pipelines/pipeline_architectures.html</p> <p>编写.gitlab-ci.yml时可以通过visualize查看pipeline</p> <p><strong>Runner&amp;executor</strong>
下面即将配置的gitlab-runner</p> <h3 id="install-and-config-gitlab-runner"><a href="#install-and-config-gitlab-runner" class="header-anchor">#</a> install and config gitlab runner</h3> <p>https://docs.gitlab.com/runner/</p> <p>https://docs.gitlab.com/runner/executors/README.html</p> <p>STEP 1: INSTALL
Install it on a server separate than where GitLab is installed
https://docs.gitlab.com/runner/install/index.html</p> <p>/etc/gitlab-runner/config.toml</p> <p>STEP 2: REGISTER
一台runner可以注册多个executor</p> <p>https://docs.gitlab.com/runner/register/</p> <div class="language- extra-class"><pre class="language-text"><code>sudo gitlab-runner register
Enter your GitLab instance URL (also known as the gitlab-ci coordinator URL). 如果是self host就是register token旁边的url即本地的gitlab server url，如果是gitlab则是https://gitlab.com
Enter the token you obtained to register the runner. 
  //For a shared runner, have an administrator go to the GitLab Admin Area and click Overview &gt; Runners
  //For a group runner, go to Settings &gt; CI/CD and expand the Runners section
  //For a project-specific runner, go to Settings &gt; CI/CD and expand the Runners section
Enter a description for the runner. You can change this value later in the GitLab user interface.
Enter the tags associated with the runner, separated by commas. You can change this value later in the GitLab user interface.
Enter any optional maintenance note for the runner.
Provide the runner executor. (https://docs.gitlab.com/runner/executors/index.html)
If you entered docker as your executor, you are asked for the default image to be used for projects that do not define one in .gitlab-ci.yml.

one line:
sudo gitlab-runner register \
  --non-interactive \
  --url &quot;https://gitlab.com/&quot; \
  --registration-token &quot;PROJECT_REGISTRATION_TOKEN&quot; \
  --executor &quot;docker&quot; \
  --docker-image alpine:latest \
  --description &quot;docker-runner&quot; \
  --maintenance-note &quot;Free-form maintainer notes about this runner&quot; \
  --tag-list &quot;docker,aws&quot; \
  --run-untagged=&quot;true&quot; \
  --locked=&quot;false&quot; \
  --access-level=&quot;not_protected&quot;
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>
After a runner is configured and available for your project, your CI/CD jobs can use the runner.

Specify the name of the runner or its tags in your .gitlab-ci.yml file. Then, when you commit to your repository, the pipeline runs, and the runner’s executor processes the commands.

/home/gitlab-runner/builds/

</code></pre></div><p>Advance config:
https://docs.gitlab.com/runner/configuration/advanced-configuration.html
GitLab Runner does not require a restart when you change most options. This includes parameters in the [[runners]] section and most parameters in the global section, except for listen_address.</p> <p>issues:
This job is stuck because the project doesn't have any runners online assigned to it.Go to project CI settings</p> <p>Run untagged jobs
Indicates whether this runner can pick jobs without tags</p> <p>troubleshoot gitlab-runner:
https://docs.gitlab.com/runner/faq/</p> <h3 id="案例-create-react-app"><a href="#案例-create-react-app" class="header-anchor">#</a> 案例：Create-react-app</h3> <p>https://dev.to/christianmontero/gitlab-ci-cd-example-with-a-dockerized-reactjs-app-1cda</p> <p>https://medium.com/recraftrelic/automating-reactjs-app-deployment-using-gitlab-12e0bf92461b</p> <div class="language- extra-class"><pre class="language-text"><code>image: node:latest
# This folder is cached between builds
# http://docs.gitlab.com/ee/ci/yaml/README.html#cache
cache:
  paths:
    - node_modules/

stages:
  - build
  - deploy

build:dev:
  stage: build
  image: node:latest
  script: 
    - echo &quot;Start building App for dev&quot;
    - npm install --force
    - npm run build
    - echo &quot;Build successfully!&quot;
  artifacts:
    expire_in: 1 hour
    paths:
      - build
  only:
    - /^dev_.*$/

deploy:dev:
  stage: deploy
  needs: ['build:dev']
  when: manual
  script: 
    - echo &quot;Start deploying App for dev&quot;
    - FOLDER=`date +&quot;%y%m%d&quot;`
    - INSATLL_TARGET_DIR=/opt/html/$FOLDER
    - ssh -q root@HOST &quot;mkdir -p $INSATLL_TARGET_DIR&quot;
    - scp -rp ./build/* root@HOST:${INSATLL_TARGET_DIR}/;
    - ssh -q root@HOST &quot;cd $INSATLL_TARGET_DIR/.. &amp;&amp; ln -nsf $FOLDER current&quot;
    - echo &quot;Deploy successfully!&quot;
  only:
    - /^dev_.*$/
</code></pre></div><p>注意 script中的scp和ssh需要在gitlab-runner机器上设置到远程机器的免密登录：</p> <div class="language- extra-class"><pre class="language-text"><code>su - gitlab-runner
ssh-keygen -t rsa
ssh-copy-id -i id_rsa root@TargetHost
</code></pre></div><h3 id="案例-maven-template-standard-core-lifecycle"><a href="#案例-maven-template-standard-core-lifecycle" class="header-anchor">#</a> 案例：Maven template(standard core lifecycle)</h3> <p>https://gitlab.com/gitlab-org/gitlab-foss/-/blob/master/lib/gitlab/ci/templates/Maven.gitlab-ci.yml</p> <div class="language- extra-class"><pre class="language-text"><code># Build JAVA applications using Apache Maven (http://maven.apache.org)
# For docker image tags see https://hub.docker.com/_/maven/
#
# For general lifecycle information see https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html

# This template will build and test your projects
# * Caches downloaded dependencies and plugins between invocation.
# * Verify but don't deploy merge requests.
# * Deploy built artifacts from master branch only.

variables:
  # This will suppress any download for dependencies and plugins or upload messages which would clutter the console log.
  # `showDateTime` will show the passed time in milliseconds. You need to specify `--batch-mode` to make this work.
  MAVEN_OPTS: &quot;-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true&quot;
  # As of Maven 3.3.0 instead of this you may define these options in `.mvn/maven.config` so the same config is used
  # when running from the command line.
  # `installAtEnd` and `deployAtEnd` are only effective with recent version of the corresponding plugins.
  MAVEN_CLI_OPTS: &quot;--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true&quot;

# This template uses jdk8 for verifying and deploying images
image: maven:3.3.9-jdk-8

# Cache downloaded dependencies and plugins between builds.
# To keep cache across branches add 'key: &quot;$CI_JOB_NAME&quot;'
cache:
  paths:
    - .m2/repository

# For merge requests do not `deploy` but only run `verify`.
# See https://maven.apache.org/guides/introduction/introduction-to-the-lifecycle.html
.verify: &amp;verify
  stage: test
  script:
    - 'mvn $MAVEN_CLI_OPTS verify'
  except:
    - master

# Verify merge requests using JDK8
verify:jdk8:
  &lt;&lt;: *verify

# To deploy packages from CI, create a ci_settings.xml file
# For deploying packages to GitLab's Maven Repository: See https://docs.gitlab.com/ee/user/project/packages/maven_repository.html#creating-maven-packages-with-gitlab-cicd for more details.
# Please note: The GitLab Maven Repository is currently only available in GitLab Premium / Ultimate.
# For `master` branch run `mvn deploy` automatically.
deploy:jdk8:
  stage: deploy
  script:
    - if [ ! -f ci_settings.xml ];
        then echo &quot;CI settings missing\! If deploying to GitLab Maven Repository, please see https://docs.gitlab.com/ee/user/project/packages/maven_repository.html#creating-maven-packages-with-gitlab-cicd for instructions.&quot;;
      fi
    - 'mvn $MAVEN_CLI_OPTS deploy -s ci_settings.xml'
  only:
    - master
</code></pre></div><h3 id="案例-maven-auto-release-non-lifecycle-tools-use-maven-release-plugin"><a href="#案例-maven-auto-release-non-lifecycle-tools-use-maven-release-plugin" class="header-anchor">#</a> 案例：Maven auto release(non-lifecycle, tools: use maven-release-plugin)</h3> <h4 id="初始版本-buggy"><a href="#初始版本-buggy" class="header-anchor">#</a> 初始版本(buggy)：</h4> <div class="language- extra-class"><pre class="language-text"><code>.gitlab-ci.yml:
image: maven:3.3.9-jdk-8

cache:
  paths:
    - .m2/repository

stages:
  - build
  - release

build:stag:
  stage: build
  script:
    - echo &quot;test1&quot;
    - POM_VERSION=$(mvn -q -Dexec.executable=&quot;echo&quot; -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.6.0:exec)
    - echo &quot;Package for stag $POM_VERSION&quot;
    - mvn package
    - TARGET_DIR=&quot;$HOME/packages/$POM_VERSION&quot;
    - echo &quot;Package successfully!&quot;
    - mkdir -p ${TARGET_DIR}
    - echo &quot;shipping artifacts to ${TARGET_DIR}&quot;;
    - cp ${CI_PROJECT_DIR}/target/test-spring-redis*.jar ${TARGET_DIR};

release:stag:
  stage: release
  needs: ['build:stag']
  when: manual
  script: 
    - echo &quot;Prepare release for stag&quot;
    - TD=`date +&quot;%Y%m%d&quot;`
    - ReleaseVersion=0.0.2
    - NextVersion=0.0.3
    - mvn clean -DskipTests -Darguments=-DskipTests release:prepare -e -DreleaseVersion=$ReleaseVersion -DdevelopmentVersion=$NextVersion-SNAPSHOT -Dtag=&quot;$TD-$ReleaseVersion&quot; -DscmDevelopmentCommitComment=&quot;prepare for next development iteration $NextVersion-SNAPSHOT&quot;
    - echo &quot;Prepare release successfully!&quot;
    - if [ ! -f ci_settings.xml ];
        then echo &quot;CI settings missing\! If deploying to GitLab Maven Repository, please see https://docs.gitlab.com/ee/user/project/packages/maven_repository.html#creating-maven-packages-with-gitlab-cicd for instructions.&quot;;
      fi
    - if [ $? == 0 ]
      then
        echo &quot;Perform release for stag&quot;
        mvn release:perform -e -Darguments=&quot;-Dmaven.javadoc.skip=true -Dmaven.test.skip=true&quot; -s ci_settings.xml
        echo &quot;Perform release successfully!&quot;
      else
        echo &quot;Rollback release for stag&quot;
        mvn release:rollback
        echo &quot;Rollback release successfully!&quot;
      fi
      
      
pom.xml:
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
	&lt;groupId&gt;com.lyhistory.redis&lt;/groupId&gt;
	&lt;artifactId&gt;test-spring-redis&lt;/artifactId&gt;
	&lt;version&gt;0.0.9-SNAPSHOT&lt;/version&gt;

	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.2.6.RELEASE&lt;/version&gt;
	&lt;/parent&gt;
	&lt;dependencies&gt;
		&lt;!-- &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; 
			&lt;version&gt;2.4.3&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;/dependency&gt; --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
			&lt;!-- &lt;version&gt;2.4.3&lt;/version&gt; --&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;
          &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.platform&lt;/groupId&gt;
            &lt;artifactId&gt;junit-platform-runner&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.kstyrc&lt;/groupId&gt;
            &lt;artifactId&gt;embedded-redis&lt;/artifactId&gt;
            &lt;version&gt;0.6&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;redis.clients&lt;/groupId&gt;
            &lt;artifactId&gt;jedis&lt;/artifactId&gt;
            &lt;type&gt;jar&lt;/type&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
            &lt;version&gt;1.2.71&lt;/version&gt;
        &lt;/dependency&gt;
	&lt;/dependencies&gt;
	
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;!-- JDK level --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;nonFilteredFileExtensions&gt;
                        &lt;nonFilteredFileExtension&gt;dll&lt;/nonFilteredFileExtension&gt;
                        &lt;nonFilteredFileExtension&gt;so&lt;/nonFilteredFileExtension&gt;
                    &lt;/nonFilteredFileExtensions&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

            &lt;!-- 更新: mvn versions:set -DnewVersion=1.0.4-SNAPSHOT versions:update-child-modules
                回滚: mvn versions:revert 提交: mvn versions:commit --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
                &lt;artifactId&gt;versions-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.7&lt;/version&gt;
            &lt;/plugin&gt;
			&lt;plugin&gt;
			   &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
			   &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
        &lt;/plugins&gt;

    &lt;/build&gt;
    &lt;!-- 配置远程发布到私服,mvn deploy --&gt;
    &lt;distributionManagement&gt;
        &lt;repository&gt;
            &lt;id&gt;nexus&lt;/id&gt;
            &lt;name&gt;Nexus Release Repository&lt;/name&gt;
            &lt;url&gt;http://NEXUS_IP:18081/repository/maven-releases/&lt;/url&gt;
        &lt;/repository&gt;
        &lt;snapshotRepository&gt;
            &lt;id&gt;nexus&lt;/id&gt;
            &lt;name&gt;Nexus Snapshot Repository&lt;/name&gt;
            &lt;url&gt;http://NEXUS_IP:18081/repository/maven-snapshots/&lt;/url&gt;
        &lt;/snapshotRepository&gt;
    &lt;/distributionManagement&gt;
    &lt;scm&gt;
        &lt;connection&gt;scm:git:http://GITLAB_IP/testci.git&lt;/connection&gt;
        &lt;developerConnection&gt;scm:git:http://GITLAB_IP/testci.git&lt;/developerConnection&gt;
        &lt;url&gt;http://GITLAB_IP/testci&lt;/url&gt;
        &lt;tag&gt;20211029-0.0.2&lt;/tag&gt;
    &lt;/scm&gt;

&lt;/project&gt;

ci_settings.xml:
&lt;settings&gt;
  &lt;servers&gt;
    &lt;server&gt;
      &lt;id&gt;nexus&lt;/id&gt;
      &lt;username&gt;admin&lt;/username&gt;
      &lt;password&gt;admin&lt;/password&gt;
    &lt;/server&gt;
	&lt;!--
	&lt;server&gt;
      &lt;id&gt;origin&lt;/id&gt;
      &lt;username&gt;yue.liu&lt;/username&gt;
      &lt;password&gt;test@123456&lt;/password&gt;
    &lt;/server&gt;
	--&gt;
  &lt;/servers&gt;
  &lt;mirrors&gt;
    &lt;mirror&gt;
      &lt;id&gt;CN&lt;/id&gt;
      &lt;name&gt;Aliyun Nexus&lt;/name&gt;
      &lt;url&gt;http://NEXUS_IP:18081/repository/aliyun-repo/&lt;/url&gt;
      &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;
    &lt;/mirror&gt;
    &lt;mirror&gt;
      &lt;id&gt;mavenCentral&lt;/id&gt;
      &lt;name&gt;Maven Central&lt;/name&gt;
      &lt;url&gt;http://NEXUS_IP:18081/repository/maven-central/&lt;/url&gt;
      &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;
    &lt;/mirror&gt;
  &lt;/mirrors&gt;
  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;nexus&lt;/id&gt;
      &lt;!--Enable snapshots for the built in central repo to direct --&gt;
      &lt;!--all requests to nexus via the mirror --&gt;
      &lt;repositories&gt;
        &lt;repository&gt;
          &lt;id&gt;central&lt;/id&gt;
          &lt;url&gt;http://central&lt;/url&gt;
          &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;/releases&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;/snapshots&gt;
        &lt;/repository&gt;
      &lt;/repositories&gt;
      &lt;pluginRepositories&gt;
        &lt;pluginRepository&gt;
          &lt;id&gt;central&lt;/id&gt;
          &lt;url&gt;http://central&lt;/url&gt;
          &lt;releases&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;/releases&gt;
          &lt;snapshots&gt;
            &lt;enabled&gt;true&lt;/enabled&gt;
          &lt;/snapshots&gt;
        &lt;/pluginRepository&gt;
      &lt;/pluginRepositories&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
  &lt;activeProfiles&gt;
    &lt;!--make the profile active all the time --&gt;
    &lt;activeProfile&gt;nexus&lt;/activeProfile&gt;
  &lt;/activeProfiles&gt;
&lt;/settings&gt;
</code></pre></div><h4 id="问题修复"><a href="#问题修复" class="header-anchor">#</a> 问题修复：</h4> <p>首先先总结下问题修复之后的整个逻辑：
要知道的是，cicd pipeline执行的过程是我们配置的gitlab-runner agent机器上执行这个ci脚本，大概是首先gitlab会默认在gitlabrunner机器上根据对应的git在builds路径下：env.CI_PROJECT_DIR=/home/gitlab-runner/builds/Mtn6kdk-/0/testci 创建这个testci目录，然后再通过env.CI_REPOSITORY_URL=http://gitlab-ci-token:[MASKED]@GITLAB_IP/testci.git 这个临时的？token来clone gitlab服务器上的git代码</p> <div class="language- extra-class"><pre class="language-text"><code>[]#git remote -v
origin  http://gitlab-ci-token:mX2W8nN6WsMnzA_kWp1p@GITLAB_IP/testci.git (fetch)
origin  http://gitlab-ci-token:mX2W8nN6WsMnzA_kWp1p@GITLAB_IP/testci.git (push)
[]#git status
HEAD detached at d8ae1db
nothing to commit, working tree clean
env.GITLAB_USER_EMAIL=yue.liu@gitlab.com
env.GITLAB_USER_LOGIN=yue.liu

env.CI_SERVER_HOST=GITLAB_IP
env.CI_API_V4_URL=http://GITLAB_IP/api/v4
env.CI_SERVER_URL=http://GITLAB_IP
env.CI_PIPELINE_URL=http://GITLAB_IP/testci/-/pipelines/823
env.CI_PROJECT_URL=http://GITLAB_IP/testci

env.CI_REPOSITORY_URL=http://gitlab-ci-token:[MASKED]@GITLAB_IP/testci.git
env.CI_JOB_URL=http://GITLAB_IP/testci/-/jobs/2422
</code></pre></div><h5 id="release-prepare"><a href="#release-prepare" class="header-anchor">#</a> Release Prepare</h5> <div class="language- extra-class"><pre class="language-text"><code>?????????????????????????????????????????????????????????????????????????????????????????
??? mvn clean -DskipTests -Darguments=-DskipTests release:prepare -e -DreleaseVersion=$ReleaseVersion -DdevelopmentVersion=$NextVersion-SNAPSHOT -Dtag=&quot;$TD-$ReleaseVersion&quot; -DscmDevelopmentCommitComment=&quot;prepare for next development iteration $NextVersion-SNAPSHOT&quot;
?????????????????????????????????????????????????????????????????????????????????????????
刚开始看到这几个帖子：
https://forum.gitlab.com/t/getting-mvn-release-to-work-with-gitlab-ci/4904/2
https://forum.gitlab.com/t/getting-mvn-release-to-work-with-gitlab-ci/4904
https://forum.gitlab.com/t/git-push-from-inside-a-gitlab-runner/30554/5
https://gitlab.com/gitlab-examples/ssh-private-key/
https://www.tutorialspoint.com/gitlab/gitlab_ssh_key_setup.htm
https://docs.gitlab.com/ee/ssh/
https://docs.gitlab.com/ee/ci/ssh_keys/#verifying-the-ssh-host-keys
https://docs.gitlab.com/ee/user/project/deploy_keys/index.html
然后盲目的就想用ssh key的方式来搞，结果本地创建完id_rsa id_rsa.pub后，发现gitlab runner机器上~/.ssh下面有了，所以就直接在gitlab settings页面 cicd设置	SSH_PRIVATE_KEY，但是并没有在repo配置上id_rsa.pub
结果当然是出错：
[INFO] Executing: /bin/sh -c cd /home/gitlab-runner/builds/Mtn6kdk-/0/testci &amp;&amp; git push http://GITLAB_IP/test.git refs/heads/master:refs/heads/master
[INFO] Working directory: /home/gitlab-runner/builds/Mtn6kdk-/0/testci
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  6.786 s
[INFO] Finished at: 2021-10-28T10:08:09+08:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:prepare (default-cli) on project test-spring-redis: Unable to commit files
[ERROR] Provider message:
[ERROR] The git-push command failed.
[ERROR] Command output:
[ERROR] fatal: could not read Username for 'http://X.X.X.160': No such device or address
[ERROR] 
[ERROR] -&gt; [Help 1]
org.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:prepare (default-cli) on project test-spring-redis: Unable to commit files
Provider message:
The git-push command failed.
Command output:
fatal: could not read Username for 'http://X.X.X.160': No such device or address

后来才注意到官方有步骤（还没有测试，后面会尝试，即使使用ssh，应该也需要提供username和email）：
https://docs.gitlab.com/ee/ci/ssh_keys/
GitLab currently doesn’t have built-in support for managing SSH keys in a build environment (where the GitLab Runner runs).
SSH keys when using the Shell executor
If you are using the Shell executor and not Docker, it is easier to set up an SSH key.

You can generate the SSH key from the machine that GitLab Runner is installed on, and use that key for all projects that are run on this machine.

First, log in to the server that runs your jobs.

Then, from the terminal, log in as the gitlab-runner user:

sudo su - gitlab-runner

Generate the SSH key pair as described in the instructions to generate an SSH key. Do not add a passphrase to the SSH key, or the before_script will prompt for it.

As a final step, add the public key from the one you created earlier to the services that you want to have an access to from within the build environment. If you are accessing a private GitLab repository you must add it as a deploy key.

After generating the key, try to sign in to the remote server to accept the fingerprint:

ssh example.com

For accessing repositories on GitLab.com, you would use git@gitlab.com

接着我没有回到正常思路，而是之间登录gitlab runner机器，在env.CI_PROJECT_DIR=/home/gitlab-runner/builds/Mtn6kdk-/0/testci目录下一顿操作，具体就是改了remote origin，以及设置config user和email，
然后再执行cicd，估计是因为我的改动通过了某些步骤，但是又遇到一个问题：
[INFO] Executing: /bin/sh -c cd /home/gitlab-runner/builds/Mtn6kdk-/0/testci &amp;&amp; git commit --verbose -F /tmp/maven-scm-1715089266.commit pom.xml
[INFO] Working directory: /home/gitlab-runner/builds/Mtn6kdk-/0/testci
[INFO] Executing: /bin/sh -c cd /home/gitlab-runner/builds/Mtn6kdk-/0/testci &amp;&amp; git symbolic-ref HEAD
[INFO] Working directory: /home/gitlab-runner/builds/Mtn6kdk-/0/testci
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  6.383 s
[INFO] Finished at: 2021-10-26T09:45:23+08:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:prepare (default-cli) on project test-spring-redis: An error is occurred in the checkin process: Exception while executing SCM command.: Detecting the current branch failed: fatal: ref HEAD is not a symbolic ref -&gt; [Help 1]
org.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:prepare (default-cli) on project test-spring-redis: An error is occurred in the checkin process: Exception while executing SCM command.

查了下，是说gitlab runner worked on detached header，需要checkout 到master，所以
在mvn release prepare之前加了 git checkout master
然后这个错误没有了，仍然是无法通过release prepare push changes，

接着切换了思路，为什么非要ssh，我就用username password不行吗？
所以我
- git remote set-url origin http://yue.liu:test@123456@$CI_SERVER_HOST/workspace/testci.git
发现错误提示是，无法解析123456@$CI_SERVER_HOST/workspace/testci.git
原来密码中包含了@，git当成了后面的那个ip之前的@解析了，所以改成url encode
- git remote set-url origin http://yue.liu:test%40123456@$CI_SERVER_HOST/workspace/testci.git
仍然不成功，
[INFO] Executing: /bin/sh -c cd /home/gitlab-runner/builds/Mtn6kdk-/0/testci &amp;&amp; git commit --verbose -F /tmp/maven-scm-81988903.commit pom.xml
[INFO] Working directory: /home/gitlab-runner/builds/Mtn6kdk-/0/testci
[INFO] Executing: /bin/sh -c cd /home/gitlab-runner/builds/Mtn6kdk-/0/testci &amp;&amp; git symbolic-ref HEAD
[INFO] Working directory: /home/gitlab-runner/builds/Mtn6kdk-/0/testci
[INFO] Executing: /bin/sh -c cd /home/gitlab-runner/builds/Mtn6kdk-/0/testci &amp;&amp; git push http://yue.liu:********@GITLAB_IP/testci.git refs/heads/master:refs/heads/master
[INFO] Working directory: /home/gitlab-runner/builds/Mtn6kdk-/0/testci
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  6.707 s
[INFO] Finished at: 2021-10-29T08:59:46+08:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:prepare (default-cli) on project test-spring-redis: Unable to commit files
[ERROR] Provider message:
[ERROR] The git-push command failed.
[ERROR] Command output:
[ERROR] remote: HTTP Basic: Access denied
[ERROR] fatal: Authentication failed for 'http://GITLAB_IP/testci.git/'
[ERROR] -&gt; [Help 1]
org.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:prepare (default-cli) on project test-spring-redis: Unable to commit files
Provider message:
The git-push command failed.
Command output:
remote: HTTP Basic: Access denied
fatal: Authentication failed for 'http://GITLAB_IP/testci.git/'
    at org.apache.maven.lifecycle.internal.MojoExecutor.execute (MojoExecutor.java:215)

然后又试着改了这个：
&lt;scm&gt;
        &lt;connection&gt;scm:git:http://yue.liu:test%40123456@GITLAB_IP/testci.git&lt;/connection&gt;
        &lt;developerConnection&gt;scm:git:http://yue.liu:test%40123456@GITLAB_IP/testci.git
        &lt;/developerConnection&gt;
        &lt;url&gt;http://GITLAB_IP/testci&lt;/url&gt;
        &lt;tag&gt;20211018-0.0.1&lt;/tag&gt;
    &lt;/scm&gt;
还是不行！  
终于看到这个：
https://stackoverflow.com/questions/29120076/maven-and-gitlab-releaseprepare-uses-the-wrong-scm-url/69766718#69766718
改成origin：
&lt;scm&gt;
        &lt;connection&gt;scm:git:origin&lt;/connection&gt;
        &lt;developerConnection&gt;scm:git:origin&lt;/developerConnection&gt;
        &lt;url&gt;http://GITLAB_IP/testci&lt;/url&gt;
        &lt;tag&gt;20211018-0.0.1&lt;/tag&gt;
    &lt;/scm&gt;
release prepare成功！！！！	
</code></pre></div><h5 id="release-peform"><a href="#release-peform" class="header-anchor">#</a> Release Peform</h5> <div class="language- extra-class"><pre class="language-text"><code>?????????????????????????????????????????????????????????????????????????????????????????
???   - if [ $? == 0 ]
?????????????????????????????????????????????????????????????????????????????????????????
这段gitlab ci脚本里面的if statement写法不符合gitlab规范：
https://stackoverflow.com/questions/54761464/how-to-use-if-else-condition-on-gitlabci

?????????????????????????????????????????????????????????????????????????????????????????
??? mvn release:perform -e -Darguments=&quot;-Dmaven.javadoc.skip=true -Dmaven.test.skip=true&quot; -s ci_settings.xml
?????????????????????????????????????????????????????????????????????????????????????????

[INFO] Executing: /bin/sh -c cd /home/gitlab-runner/builds/Mtn6kdk-/0/testci/target &amp;&amp; git clone --branch 20211029-0.0.4 origin /home/gitlab-runner/builds/Mtn6kdk-/0/testci/target/checkout
[INFO] Working directory: /home/gitlab-runner/builds/Mtn6kdk-/0/testci/target
[ERROR] The git-clone command failed.
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  7.513 s
[INFO] Finished at: 2021-10-29T11:52:57+08:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:perform (default-cli) on project test-spring-redis: Unable to checkout from SCM
[ERROR] Provider message:
[ERROR] The git-clone command failed.
[ERROR] Command output:
[ERROR] fatal: repository 'origin' does not exist
[ERROR] -&gt; [Help 1]
org.apache.maven.lifecycle.LifecycleExecutionException: Failed to execute goal org.apache.maven.plugins:maven-release-plugin:2.5.3:perform (default-cli) on project test-spring-redis: Unable to checkout from SCM
Provider message:
The git-clone command failed.
Command output:
fatal: repository 'origin' does not exist

shit！prepare可以识别origin，这里居然不识别，手动测试了下，果然不识别，改成
mvn release:perform -DconnectionUrl='scm:git:http://yue.liu:test%40123456@GITLAB_IP/workspace/testci.git' 
还是不行！！！
最后想到是不是可以把用户名密码传给mvn，我真是太聪明了！
https://stackoverflow.com/questions/1255593/externalising-scm-credentials-with-maven
mvn release:perform -Dusername=[username] -Dpassword=[password] 
成功！！！！

</code></pre></div><h4 id="最终版本"><a href="#最终版本" class="header-anchor">#</a> 最终版本</h4> <div class="language- extra-class"><pre class="language-text"><code>pom.xml:
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
	&lt;groupId&gt;com.lyhistory.redis&lt;/groupId&gt;
	&lt;artifactId&gt;test-spring-redis&lt;/artifactId&gt;
	&lt;version&gt;0.0.9-SNAPSHOT&lt;/version&gt;

	&lt;parent&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
		&lt;version&gt;2.2.6.RELEASE&lt;/version&gt;
	&lt;/parent&gt;
	&lt;dependencies&gt;
		&lt;!-- &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt; 
			&lt;version&gt;2.4.3&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;/dependency&gt; --&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
			&lt;!-- &lt;version&gt;2.4.3&lt;/version&gt; --&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;
          &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-test&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.junit.platform&lt;/groupId&gt;
            &lt;artifactId&gt;junit-platform-runner&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.kstyrc&lt;/groupId&gt;
            &lt;artifactId&gt;embedded-redis&lt;/artifactId&gt;
            &lt;version&gt;0.6&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;redis.clients&lt;/groupId&gt;
            &lt;artifactId&gt;jedis&lt;/artifactId&gt;
            &lt;type&gt;jar&lt;/type&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;
            &lt;version&gt;1.2.71&lt;/version&gt;
        &lt;/dependency&gt;
	&lt;/dependencies&gt;
	
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;!-- JDK level --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                    &lt;encoding&gt;UTF-8&lt;/encoding&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;nonFilteredFileExtensions&gt;
                        &lt;nonFilteredFileExtension&gt;dll&lt;/nonFilteredFileExtension&gt;
                        &lt;nonFilteredFileExtension&gt;so&lt;/nonFilteredFileExtension&gt;
                    &lt;/nonFilteredFileExtensions&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;

            &lt;!-- 更新: mvn versions:set -DnewVersion=1.0.4-SNAPSHOT versions:update-child-modules
                回滚: mvn versions:revert 提交: mvn versions:commit --&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
                &lt;artifactId&gt;versions-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.7&lt;/version&gt;
            &lt;/plugin&gt;
			&lt;plugin&gt;
			   &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
			   &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;
			&lt;/plugin&gt;
        &lt;/plugins&gt;

    &lt;/build&gt;
    &lt;!-- 配置远程发布到私服,mvn deploy --&gt;
    &lt;distributionManagement&gt;
        &lt;repository&gt;
            &lt;id&gt;nexus&lt;/id&gt;
            &lt;name&gt;Nexus Release Repository&lt;/name&gt;
            &lt;url&gt;http://NEXUS_IP:18081/repository/maven-releases/&lt;/url&gt;
        &lt;/repository&gt;
        &lt;snapshotRepository&gt;
            &lt;id&gt;nexus&lt;/id&gt;
            &lt;name&gt;Nexus Snapshot Repository&lt;/name&gt;
            &lt;url&gt;http://NEXUS_IP:18081/repository/maven-snapshots/&lt;/url&gt;
        &lt;/snapshotRepository&gt;
    &lt;/distributionManagement&gt;
    &lt;scm&gt;
        &lt;connection&gt;scm:git:origin&lt;/connection&gt;
        &lt;developerConnection&gt;scm:git:origin&lt;/developerConnection&gt;
        &lt;url&gt;http://GITLAB_IP/testci&lt;/url&gt;
        &lt;tag&gt;20211029-0.0.2&lt;/tag&gt;
    &lt;/scm&gt;

&lt;/project&gt;
</code></pre></div><h5 id="http-with-password"><a href="#http-with-password" class="header-anchor">#</a> http with password</h5> <div class="language- extra-class"><pre class="language-text"><code>-----------------------------------------------------------------------------
--- 用户名密码
-----------------------------------------------------------------------------
.gitlab-ci.yml:
image: maven:3.3.9-jdk-8
  
cache:
  paths:
    - .m2/repository

stages:
  - build
  - release

build:stag:
  stage: build
  script:
    - echo &quot;test1&quot;
    - POM_VERSION=$(mvn -q -Dexec.executable=&quot;echo&quot; -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.6.0:exec)
    - echo &quot;Package for stag $POM_VERSION&quot;
    - mvn clean -DskipTests -Darguments=-DskipTests package
    - TARGET_DIR=&quot;$HOME/packages/$POM_VERSION&quot;
    - echo &quot;Package successfully!&quot;
    - mkdir -p ${TARGET_DIR}
    - echo &quot;shipping artifacts to ${TARGET_DIR}&quot;;
    - cp ${CI_PROJECT_DIR}/target/test-spring-redis*.jar ${TARGET_DIR};

release:stag:
  stage: release
  needs: ['build:stag']
  when: manual
  script:
    - echo &quot;add private key&quot;
    #- eval $(ssh-agent -s)
    #- ssh-add ~/.ssh/id_rsa
    - echo &quot;whoami:&quot;
    - whoami
    #- echo &quot;$SSH_PRIVATE_KEY&quot; | tr -d '\r' | ssh-add -
    #- echo -e &quot;Host *\n\tStrictHostKeyChecking no\n\n&quot; &gt;&gt; ~/.ssh/config
    #- chmod 600 ~/.ssh/config
    #- git config --global user.email &quot;gitlab-runner@gitlab.com&quot;
    #- git config --global user.name &quot;gitlab-runner&quot; 
    - git config --global user.email &quot;yue.liu@gitlab.com&quot;
    - git config --global user.name &quot;yue.liu&quot;    
    - echo &quot;Prepare release for stag&quot;
    - TD=`date +&quot;%Y%m%d&quot;`
    - ReleaseVersion=0.0.9
    - NextVersion=0.1.0
    - git checkout master &amp;&amp; git pull
    #- git remote set-url origin git@$CI_SERVER_HOST:workspace/testci.git
    - git remote set-url origin http://yue.liu:test%40123456@$CI_SERVER_HOST/workspace/testci.git
    - echo &quot;ReleaseVersion $ReleaseVersion $NextVersion-SNAPSHOT&quot;
    - mvn clean -DskipTests -Darguments=-DskipTests release:prepare -e -DreleaseVersion=$ReleaseVersion -DdevelopmentVersion=$NextVersion-SNAPSHOT -Dtag=&quot;$TD-$ReleaseVersion&quot; -DscmDevelopmentCommitComment=&quot;prepare for next development iteration $NextVersion-SNAPSHOT&quot; -X -B
    - echo &quot;Prepare release successfully!&quot;
    - if [ ! -f ci_settings.xml ];
        then echo &quot;CI settings missing\! If deploying to GitLab Maven Repository, please see https://docs.gitlab.com/ee/user/project/packages/maven_repository.html#creating-maven-packages-with-gitlab-cicd for instructions.&quot;;
      fi
    - &gt;
      if [ $? == 0 ]; then
        echo &quot;Perform release for stag&quot;
        #echo &quot;CI_RELEASE_PASSWORD=$CI_RELEASE_PASSWORD&quot;
        mvn release:perform -DconnectionUrl='scm:git:http://GITLAB_IP/workspace/testci.git' -Dusername=&quot;yue.liu&quot; -Dpassword=&quot;test@123456&quot; -e -Darguments=&quot;-Dmaven.javadoc.skip=true -Dmaven.test.skip=true&quot; -s ci_settings.xml -B
        echo &quot;Perform release successfully!&quot;
      else
        echo &quot;Rollback release for stag&quot;
        mvn release:rollback
        echo &quot;Rollback release successfully!&quot;
      fi
</code></pre></div><h5 id="ssh-paswordless"><a href="#ssh-paswordless" class="header-anchor">#</a> ssh paswordless</h5> <div class="language- extra-class"><pre class="language-text"><code>-----------------------------------------------------------------------------
--- ssh
-----------------------------------------------------------------------------      
配置ssh key：
https://docs.gitlab.com/ee/ci/ssh_keys/

&gt;&gt; SSH keys when using the Shell executor
If you are using the Shell executor and not Docker, it is easier to set up an SSH key.
You can generate the SSH key from the machine that GitLab Runner is installed on, and use that key for all projects that are run on this machine.

First, log in to the server that runs your jobs.
Then, from the terminal, log in as the gitlab-runner user:
sudo su - gitlab-runner

Generate the SSH key pair as described in the instructions to generate an SSH key. Do not add a passphrase to the SSH key, or the before_script will prompt for it.

As a final step, add the public key from the one you created earlier to the services that you want to have an access to from within the build environment. If you are accessing a private GitLab repository you must add it as a deploy key (Menu &gt; Projects &gt; Settings &gt; Repository &gt; Expand Deploy keyshttps://docs.gitlab.com/ee/user/project/deploy_keys/index.html).

After generating the key, try to sign in to the remote server to accept the fingerprint:
ssh example.com
For accessing repositories on GitLab.com, you would use git@gitlab.com

.gitlab_ci.yml:
image: maven:3.3.9-jdk-8
  
cache:
  paths:
    - .m2/repository

stages:
  - build
  - release

build:stag:
  stage: build
  script:
    - echo &quot;test1&quot;
    - POM_VERSION=$(mvn -q -Dexec.executable=&quot;echo&quot; -Dexec.args='${project.version}' --non-recursive org.codehaus.mojo:exec-maven-plugin:1.6.0:exec)
    - echo &quot;Package for stag $POM_VERSION&quot;
    - mvn clean -DskipTests -Darguments=-DskipTests package
    - TARGET_DIR=&quot;$HOME/packages/$POM_VERSION&quot;
    - echo &quot;Package successfully!&quot;
    - mkdir -p ${TARGET_DIR}
    - echo &quot;shipping artifacts to ${TARGET_DIR}&quot;;
    - cp ${CI_PROJECT_DIR}/target/test-spring-redis*.jar ${TARGET_DIR};

release:stag:
  stage: release
  needs: ['build:stag']
  when: manual
  script:
    - echo &quot;add private key&quot;
    - eval $(ssh-agent -s)
    - ssh-add ~/.ssh/id_rsa
    - cat ~/.ssh/id_rsa
    - echo &quot;whoami:&quot;
    - whoami
    - git config --global user.email &quot;yue.liu@gitlab.com&quot;
    - git config --global user.name &quot;yue.liu&quot;    
    - echo &quot;Prepare release for stag&quot;
    - TD=`date +&quot;%Y%m%d&quot;`
    - ReleaseVersion=0.1.1
    - NextVersion=0.1.2
    - git checkout master &amp;&amp; git pull
    - git remote set-url origin git@$CI_SERVER_HOST:testci.git
    - echo &quot;ReleaseVersion $ReleaseVersion $NextVersion-SNAPSHOT&quot;
    - mvn clean -DskipTests -Darguments=-DskipTests release:prepare -e -DreleaseVersion=$ReleaseVersion -DdevelopmentVersion=$NextVersion-SNAPSHOT -Dtag=&quot;$TD-$ReleaseVersion&quot; -DscmDevelopmentCommitComment=&quot;prepare for next development iteration $NextVersion-SNAPSHOT&quot; -X -B
    - echo &quot;Prepare release successfully!&quot;
    - if [ ! -f ci_settings.xml ];
        then echo &quot;CI settings missing\! If deploying to GitLab Maven Repository, please see https://docs.gitlab.com/ee/user/project/packages/maven_repository.html#creating-maven-packages-with-gitlab-cicd for instructions.&quot;;
      fi
    - &gt;
      if [ $? == 0 ]; then
        echo &quot;Perform release for stag&quot;
        echo &quot;CI_RELEASE_PASSWORD=$CI_RELEASE_PASSWORD&quot;
        mvn release:perform -DconnectionUrl='scm:git:git@GITLAB_IP:testci.git' -e -Darguments=&quot;-Dmaven.javadoc.skip=true -Dmaven.test.skip=true&quot; -s ci_settings.xml -B
        echo &quot;Perform release successfully!&quot;
      else
        echo &quot;Rollback release for stag&quot;
        mvn release:rollback
        echo &quot;Rollback release successfully!&quot;
      fi
</code></pre></div><h4 id="官方方案-gitlab-release-tool"><a href="#官方方案-gitlab-release-tool" class="header-anchor">#</a> 官方方案：Gitlab release tool</h4> <p>跟前面相比，限制是不能够更改pom文件为下一次release准备，只能打tag以及在gitlab项目页面上的release页面显示
https://docs.gitlab.com/ee/ci/yaml/index.html#release
https://docs.gitlab.com/ee/user/project/releases/index.html
In GitLab, a release enables you to create a snapshot of your project for your users, including installation packages and release notes. You can create a GitLab release on any branch. Creating a release also creates a Git tag to mark the release point in the source code.</p> <ul><li><p>Using a job in your CI/CD pipeline.
手动触发
git tag &quot;tag-name&quot; #触发job后，tag-name 会赋值给$CI_COMMIT_TAG</p> <div class="language- extra-class"><pre class="language-text"><code>release_job:
stage: release
image: registry.gitlab.com/gitlab-org/release-cli:latest
rules:
  - if: $CI_COMMIT_TAG                  # Run this job when a tag is created manually
script:
  - echo &quot;running release_job&quot;
release:
  name: 'Release $CI_COMMIT_TAG'
  description: 'Created using the release-cli $EXTRA_DESCRIPTION'  # $EXTRA_DESCRIPTION must be defined
  tag_name: '$CI_COMMIT_TAG'                                       # elsewhere in the pipeline.
  ref: '$CI_COMMIT_TAG'
  milestones:
    - 'm1'
    - 'm2'
    - 'm3'
  released_at: '2020-07-15T08:00:00Z'  # Optional, is auto generated if not defined, or can use a variable.
  assets: # Optional, multiple asset links
    links:
      - name: 'asset1'
        url: 'https://example.com/assets/1'
      - name: 'asset2'
        url: 'https://example.com/assets/2'
        filepath: '/pretty/url/1' # optional
        link_type: 'other' # optional
</code></pre></div><p>自动触发：merge代码到某个branch后自动触发，tag名字写在git repo的VERSION中</p> <div class="language- extra-class"><pre class="language-text"><code>prepare_job:
stage: prepare                                              # This stage must run before the release stage
rules:
  - if: $CI_COMMIT_TAG
    when: never                                             # Do not run this job when a tag is created manually
  - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH             # Run this job when commits are pushed or merged to the default branch
script:
  - echo &quot;EXTRA_DESCRIPTION=some message&quot; &gt;&gt; variables.env  # Generate the EXTRA_DESCRIPTION and TAG environment variables
  - echo &quot;TAG=v$(cat VERSION)&quot; &gt;&gt; variables.env             # and append to the variables.env file
artifacts:
  reports:
    dotenv: variables.env                                   # Use artifacts:reports:dotenv to expose the variables to other jobs

release_job:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: prepare_job
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
      when: never                                  # Do not run this job when a tag is created manually
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Run this job when commits are pushed or merged to the default branch
  script:
    - echo &quot;running release_job for $TAG&quot;
  release:
    name: 'Release $TAG'
    description: 'Created using the release-cli $EXTRA_DESCRIPTION'  # $EXTRA_DESCRIPTION and the $TAG
    tag_name: '$TAG'                                                 # variables must be defined elsewhere
    ref: '$CI_COMMIT_SHA'                                            # in the pipeline. For example, in the
    milestones:                                                      # prepare_job
      - 'm1'
      - 'm2'
      - 'm3'
    released_at: '2020-07-15T08:00:00Z'  # Optional, is auto generated if not defined, or can use a variable.
    assets:
      links:
        - name: 'asset1'
          url: 'https://example.com/assets/1'
        - name: 'asset2'
          url: 'https://example.com/assets/2'
          filepath: '/pretty/url/1' # optional
          link_type: 'other' # optional
</code></pre></div></li> <li><p>In the Releases page.</p></li> <li><p>In the Tags page.</p></li> <li><p>Using the Releases API.
https://docs.gitlab.com/ee/api/releases/index.html#create-a-release</p></li></ul> <h3 id="案例-自动生成merge-request"><a href="#案例-自动生成merge-request" class="header-anchor">#</a> 案例：自动生成merge request</h3> <p>https://about.gitlab.com/blog/2017/09/05/how-to-automatically-create-a-new-mr-on-gitlab-with-gitlab-ci/</p> <h3 id="案例-gitlab-pages"><a href="#案例-gitlab-pages" class="header-anchor">#</a> 案例 gitlab pages</h3> <p>https://docs.gitlab.com/ee/user/project/pages/getting_started/pages_from_scratch.html</p> <p>注意这里job的名字是特定的pages，而且不需要配置runner: GitLab executes it in the background and doesn’t use runner.</p> <h3 id="troubshooting"><a href="#troubshooting" class="header-anchor">#</a> troubshooting</h3> <p>?# remote: You are not allowed to download code from this project.</p> <p>https://docs.gitlab.com/ee/user/project/new_ci_build_permissions_model.html</p> <p>默认是 triggered by Administrator，不是push代码的用户，retry就可以了？</p> <p>?# npm: command not found</p> <p>根据runner所使用的具体executor，比如docker可以使用node image，如果是普通的vm，需要安装nodejs</p> <h2 id="_6-troubleshooting"><a href="#_6-troubleshooting" class="header-anchor">#</a> 6. Troubleshooting</h2> <p>常用工具</p> <div class="language- extra-class"><pre class="language-text"><code>gitlab-ctl tail
</code></pre></div><h3 id="创建project以及浏览已有project出现500"><a href="#创建project以及浏览已有project出现500" class="header-anchor">#</a> 创建project以及浏览已有project出现500</h3> <p>经过排查，放弃，重新安装，但是问题依旧，</p> <p>通过gitlab-ctl tail查log</p> <p>首先观察gitlab server log</p> <div class="language- extra-class"><pre class="language-text"><code>==&gt; /var/log/gitlab/gitlab-rails/production_json.log &lt;==
{&quot;method&quot;:&quot;POST&quot;,&quot;path&quot;:&quot;/projects&quot;,&quot;format&quot;:&quot;html&quot;,&quot;controller&quot;:&quot;ProjectsController&quot;,&quot;action&quot;:&quot;create&quot;,&quot;status&quot;:500,&quot;time&quot;:&quot;2020-08-21T06:41:34.153Z&quot;,&quot;params&quot;:[{&quot;key&quot;:&quot;utf8&quot;,&quot;value&quot;:&quot;✓&quot;},{&quot;key&quot;:&quot;authenticity_token&quot;,&quot;value&quot;:&quot;[FILTERED]&quot;},{&quot;key&quot;:&quot;project&quot;,&quot;value&quot;:{&quot;ci_cd_only&quot;:&quot;false&quot;,&quot;name&quot;:&quot;helloworld&quot;,&quot;namespace_id&quot;:&quot;1&quot;,&quot;path&quot;:&quot;helloworld&quot;,&quot;description&quot;:&quot;[FILTERED]&quot;,&quot;visibility_level&quot;:&quot;0&quot;}}],&quot;remote_ip&quot;:&quot;10.30.30.94&quot;,&quot;user_id&quot;:1,&quot;username&quot;:&quot;root&quot;,&quot;ua&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36&quot;,&quot;queue_duration_s&quot;:0.010634,&quot;correlation_id&quot;:&quot;s6jJ3TyP8a1&quot;,&quot;meta.user&quot;:&quot;root&quot;,&quot;meta.caller_id&quot;:&quot;ProjectsController#create&quot;,&quot;gitaly_calls&quot;:2,&quot;gitaly_duration_s&quot;:0.011436,&quot;redis_calls&quot;:14,&quot;redis_duration_s&quot;:0.003358,&quot;cpu_s&quot;:0.71,&quot;exception.class&quot;:&quot;ActionView::Template::Error&quot;,&quot;exception.message&quot;:&quot;7:permission denied&quot;,&quot;exception.backtrace&quot;:[&quot;lib/gitlab/gitaly_client.rb:192:in `execute'&quot;,&quot;lib/gitlab/gitaly_client.rb:170:in `block in call'&quot;,&quot;lib/gitlab/gitaly_client.rb:198:in `measure_timings'&quot;,&quot;lib/gitlab/gitaly_client.rb:169:in `call'&quot;,&quot;lib/gitlab/gitaly_client/ref_service.rb:42:in `default_branch_name'&quot;,&quot;lib/gitlab/git/repository.rb:90:in `root_ref'&quot;,&quot;app/models/repository.rb:509:in `root_ref'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:84:in `block (2 levels) in cache_method_asymmetrically'&quot;,&quot;lib/gitlab/repository_cache.rb:44:in `fetch_without_caching_false'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:179:in `block (2 levels) in cache_method_output_asymmetrically'&quot;,&quot;lib/gitlab/safe_request_store.rb:12:in `fetch'&quot;,&quot;lib/gitlab/repository_cache.rb:25:in `fetch'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:178:in `block in cache_method_output_asymmetrically'&quot;,&quot;lib/gitlab/utils/strong_memoize.rb:30:in `strong_memoize'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:192:in `block in memoize_method_output'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:201:in `no_repository_fallback'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:191:in `memoize_method_output'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:177:in `cache_method_output_asymmetrically'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:83:in `block in cache_method_asymmetrically'&quot;,&quot;app/models/repository.rb:646:in `head_commit'&quot;,&quot;app/models/repository.rb:657:in `tree'&quot;,&quot;app/models/repository.rb:1010:in `file_on_head'&quot;,&quot;app/models/repository.rb:561:in `block in avatar'&quot;,&quot;lib/gitlab/gitaly_client.rb:335:in `allow_n_plus_1_calls'&quot;,&quot;app/models/repository.rb:560:in `avatar'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:21:in `block (2 levels) in cache_method'&quot;,&quot;lib/gitlab/repository_cache.rb:25:in `fetch'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:152:in `block in cache_method_output'&quot;,&quot;lib/gitlab/utils/strong_memoize.rb:30:in `strong_memoize'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:192:in `block in memoize_method_output'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:201:in `no_repository_fallback'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:191:in `memoize_method_output'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:151:in `cache_method_output'&quot;,&quot;lib/gitlab/repository_cache_adapter.rb:20:in `block in cache_method'&quot;,&quot;app/models/project.rb:1308:in `avatar_in_git'&quot;,&quot;app/models/project.rb:1312:in `avatar_url'&quot;,&quot;app/models/concerns/avatarable.rb:24:in `avatar_url'&quot;,&quot;app/helpers/page_layout_helper.rb:52:in `page_image'&quot;,&quot;app/views/layouts/_head.html.haml:27&quot;,&quot;app/views/layouts/application.html.haml:6&quot;,&quot;app/controllers/application_controller.rb:132:in `render'&quot;,&quot;app/controllers/projects_controller.rb:68:in `create'&quot;,&quot;app/controllers/application_controller.rb:496:in `set_current_admin'&quot;,&quot;lib/gitlab/session.rb:11:in `with_session'&quot;,&quot;app/controllers/application_controller.rb:487:in `set_session_storage'&quot;,&quot;app/controllers/application_controller.rb:481:in `set_locale'&quot;,&quot;lib/gitlab/error_tracking.rb:48:in `with_context'&quot;,&quot;app/controllers/application_controller.rb:546:in `sentry_context'&quot;,&quot;app/controllers/application_controller.rb:474:in `block in set_current_context'&quot;,&quot;lib/gitlab/application_context.rb:52:in `block in use'&quot;,&quot;lib/gitlab/application_context.rb:52:in `use'&quot;,&quot;lib/gitlab/application_context.rb:20:in `with_context'&quot;,&quot;app/controllers/application_controller.rb:467:in `set_current_context'&quot;],&quot;db_duration_s&quot;:0.07781,&quot;view_duration_s&quot;:0.0,&quot;duration_s&quot;:0.77791}
</code></pre></div><p>可以看到gitaly-client的permission denied error</p> <p>然后从Praefect测试到Gitaly nodes的连通性</p> <div class="language- extra-class"><pre class="language-text"><code>2020/08/21 15:25:38 [tcp://X.X.X.137:8075]: checking health...
2020/08/21 15:25:38 [tcp://X.X.X.138:8075]: dialed successfully!
2020/08/21 15:25:38 [tcp://X.X.X.138:8075]: checking health...
2020/08/21 15:25:38 [tcp://X.X.X.136:8075]: dialed successfully!
2020/08/21 15:25:38 [tcp://X.X.X.136:8075]: checking health...
2020/08/21 15:25:38 [tcp://X.X.X.138:8075]: ERROR: unable to request health check: rpc error: code = PermissionDenied desc = permission denied
2020/08/21 15:25:38 [tcp://X.X.X.137:8075]: ERROR: unable to request health check: rpc error: code = PermissionDenied desc = permission denied
2020/08/21 15:25:38 [tcp://X.X.X.136:8075]: ERROR: unable to request health check: rpc error: code = PermissionDenied desc = permission denied
rpc error: code = PermissionDenied desc = permission denied
</code></pre></div><p>查到说不是shared secret就是clock drift问题 https://gitlab.com/gitlab-org/gitaly/-/issues/1762</p> <p>我确认了配置无误，所以应该是clock drift，</p> <p>通过ntp配置</p> <div class="language- extra-class"><pre class="language-text"><code>yum install ntp
vim /etc/ntp.conf
systemctl start ntpd
systemctl enable ntpd
</code></pre></div><p>同步之后再测试，终于可以了</p> <div class="language- extra-class"><pre class="language-text"><code>WARN[0000] ignoring configured election strategy as failover is disabled  election_strategy=local pid=6972
2020/08/21 17:02:07 [tcp://X.X.X.138:8075]: dialing...
2020/08/21 17:02:07 [tcp://X.X.X.136:8075]: dialing...
2020/08/21 17:02:07 [tcp://X.X.X.137:8075]: dialing...
2020/08/21 17:02:07 [tcp://X.X.X.138:8075]: dialed successfully!
2020/08/21 17:02:07 [tcp://X.X.X.138:8075]: checking health...
2020/08/21 17:02:07 [tcp://X.X.X.136:8075]: dialed successfully!
2020/08/21 17:02:07 [tcp://X.X.X.136:8075]: checking health...
[root@vm-cicd-proxy-v03 opt]# .101.137:8075]: dialed successfully!
</code></pre></div><p>然后从前端访问测试，发现创建的时候报错503 not available，这又是啥，结果测试从gitlab server到Praefect的连通性，发现Praefect不通，最后发现Praefect忘记启动了！</p> <div class="language- extra-class"><pre class="language-text"><code>[root@vm-cicd-v01 opt]# gitlab-rake gitlab:gitaly:check
Checking Gitaly ...

Gitaly: ... default ... OK

Checking Gitaly ... Finished
</code></pre></div><p>总结：</p> <p>一定要确保连通性！</p> <h3 id="repository-migration问题"><a href="#repository-migration问题" class="header-anchor">#</a> repository migration问题</h3> <p>由于安装Gitaly cluster之前已经创建了一个repository，所以需要migration，</p> <p>https://docs.gitlab.com/ee/administration/gitaly/praefect.html#migrating-existing-repositories-to-praefect</p> <div class="language- extra-class"><pre class="language-text"><code>curl --request POST --header &quot;Private-Token: &lt;your_access_token&gt;&quot; --header &quot;Content-Type: application/json&quot; \
--data '{&quot;destination_storage_name&quot;:&quot;praefect&quot;}' &quot;https://gitlab.example.com/api/v4/projects/123/repository_storage_moves&quot;
</code></pre></div><p>这个token如何获取呢？</p> <p>Admin头像-&gt;settings-&gt;Access Tokens，创建api权限获取token：测试</p> <p>http://X.X.X.133/api/v4/projects?access_token=5L74k2hxQrKYdKNNG8Ne</p> <p>api</p> <p>https://docs.gitlab.com/ee/api/README.html</p> <p>https://docs.gitlab.com/ee/api/api_resources.html</p> <p>https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html</p> <h3 id="push失败问题"><a href="#push失败问题" class="header-anchor">#</a> push失败问题</h3> <p>https://gitlab.com/gitlab-org/gitaly/-/issues/3327</p> <div class="language- extra-class"><pre class="language-text"><code>λ git push upstream someBranch
Enumerating objects: 40, done.
Counting objects: 100% (40/40), done.
Delta compression using up to 8 threads
Compressing objects: 100% (16/16), done.
Writing objects: 100% (26/26), 18.56 KiB | 1.33 MiB/s, done.
Total 26 (delta 6), reused 0 (delta 0)
remote:
remote: Create merge request for someBranch:
remote:
To http://****.git
   018fd712..ea76148f  someBranch -&gt; someBranch
这个成功了
λ git push origin master
Enumerating objects: 267, done.
Counting objects: 100% (229/229), done.
Delta compression using up to 8 threads
Compressing objects: 100% (63/63), done.
Writing objects: 100% (174/174), 49.63 KiB | 5.51 MiB/s, done.
Total 174 (delta 35), reused 162 (delta 24), pack-reused 0
remote: Resolving deltas: 100% (35/35), completed with 12 local objects.
这个就卡死在这里了
λ git fsck
Checking object directories: 100% (256/256), done.
Checking objects: 100% (29945/29945), done.
dangling blob 9706bd0d4e4b57714071d2f9cfb08461c0600fff
dangling blob 9052226fc23fa9e83043335ea5ec13bc2f724bdc
过了一天再执行就没有dangling blob了，所以这个应该没有什么关系
</code></pre></div><h4 id="git-client排查"><a href="#git-client排查" class="header-anchor">#</a> git client排查：</h4> <p>https://confluence.atlassian.com/bitbucketserverkb/git-push-fails-fatal-the-remote-end-hung-up-unexpectedly-779171796.html</p> <p>.git/config</p> <div class="language- extra-class"><pre class="language-text"><code>[core]
	repositoryformatversion = 0
	filemode = false
	bare = false
	logallrefupdates = true
	symlinks = false
	ignorecase = true
	packedGitLimit = 512m 
	packedGitWindowSize = 512m
[pack] 
	deltaCacheSize = 2047m 
	packSizeLimit = 2047m 
	windowMemory = 2047m	
[remote &quot;upstream&quot;]
	url = http://****.git
	fetch = +refs/heads/*:refs/remotes/upstream/*
[branch &quot;master&quot;]
	remote = upstream
	merge = refs/heads/master
[gui]
	wmstate = zoomed
	geometry = 1109x563+224+224 442 255
[branch &quot;someBranch&quot;]
	remote = upstream
	merge = refs/heads/someBranch
[remote &quot;origin&quot;]
	url = http://*****.git
	fetch = +refs/heads/*:refs/remotes/origin/*
</code></pre></div><h4 id="server端排查"><a href="#server端排查" class="header-anchor">#</a> server端排查：</h4> <p>nginx
https://docs.gitlab.com/omnibus/settings/nginx.html
client_max_body_size 200M;
proxy_read_timeout</p> <p>/var/log/gitlab/gitlab-workhorse/current</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;correlation_id&quot;:&quot;FiyLbvdSzA9&quot;,&quot;error&quot;:&quot;handleReceivePack: smarthttp.ReceivePack: rpc error: code = Unavailable desc = PostReceivePack: exit status 128&quot;,&quot;level&quot;:&quot;error&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;error&quot;,&quot;time&quot;:&quot;2020-11-25T15:36:17+08:00&quot;,&quot;uri&quot;:&quot;/test/git-receive-pack&quot;}
{&quot;correlation_id&quot;:&quot;FiyLbvdSzA9&quot;,&quot;duration_ms&quot;:932,&quot;host&quot;:&quot;X.X.X.160&quot;,&quot;level&quot;:&quot;info&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;access&quot;,&quot;proto&quot;:&quot;HTTP/1.1&quot;,&quot;referrer&quot;:&quot;&quot;,&quot;remote_addr&quot;:&quot;127.0.0.1:0&quot;,&quot;remote_ip&quot;:&quot;127.0.0.1&quot;,&quot;status&quot;:200,&quot;system&quot;:&quot;http&quot;,&quot;time&quot;:&quot;2020-11-25T15:36:17+08:00&quot;,&quot;uri&quot;:&quot;/test/git-receive-pack&quot;,&quot;user_agent&quot;:&quot;git/2.29.2.windows.2&quot;,&quot;written_bytes&quot;:779}
                                                                                                                                                             
{&quot;correlation_id&quot;:&quot;CRxXsx22P13&quot;,&quot;error&quot;:&quot;handleReceivePack: smarthttp.ReceivePack: rpc error: code = Internal desc = failed proxying to secondary: rpc error: code = Unavailable desc = PostReceivePack: exit status 128&quot;,&quot;level&quot;:&quot;error&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;error&quot;,&quot;time&quot;:&quot;2020-11-25T16:32:25+08:00&quot;,&quot;uri&quot;:&quot;/test/git-receive-pack&quot;}
{&quot;correlation_id&quot;:&quot;CRxXsx22P13&quot;,&quot;duration_ms&quot;:548,&quot;host&quot;:&quot;X.X.X.160&quot;,&quot;level&quot;:&quot;info&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;access&quot;,&quot;proto&quot;:&quot;HTTP/1.1&quot;,&quot;referrer&quot;:&quot;&quot;,&quot;remote_addr&quot;:&quot;127.0.0.1:0&quot;,&quot;remote_ip&quot;:&quot;127.0.0.1&quot;,&quot;status&quot;:200,&quot;system&quot;:&quot;http&quot;,&quot;time&quot;:&quot;2020-11-25T16:32:25+08:00&quot;,&quot;uri&quot;:&quot;/test/git-receive-pack&quot;,&quot;user_agent&quot;:&quot;git/2.29.2.windows.2&quot;,&quot;written_bytes&quot;:703}
</code></pre></div><p>/var/log/gitlab/gitaly/current 或者通过 gitlab-ctl tail gitaly</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;correlation_id&quot;:&quot;guaTaM5Wcq4&quot;,&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-workhorse&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;InfoRefsReceivePack&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.SmartHTTPService/InfoRefsReceivePack&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/...&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.SmartHTTPService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:46Z&quot;,&quot;grpc.time_ms&quot;:4.995,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished streaming call with code OK&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:39070&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:46.594Z&quot;}
{&quot;correlation_id&quot;:&quot;mqo8zmozsw6&quot;,&quot;diskcache&quot;:&quot;25dd57ac-cd11-46e1-9085-e7323e817a0d&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-web&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;regular&quot;,&quot;grpc.method&quot;:&quot;Cleanup&quot;,&quot;grpc.request.deadline&quot;:&quot;2020-11-26T01:22:57Z&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.RepositoryService/Cleanup&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.RepositoryService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;diskcache state change&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:39070&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.683Z&quot;}
{&quot;correlation_id&quot;:&quot;mqo8zmozsw6&quot;,&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-web&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;regular&quot;,&quot;grpc.method&quot;:&quot;Cleanup&quot;,&quot;grpc.request.deadline&quot;:&quot;2020-11-26T01:22:57Z&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.RepositoryService/Cleanup&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.RepositoryService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;grpc.time_ms&quot;:4.464,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished unary call with code OK&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:39070&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.683Z&quot;}
{&quot;correlation_id&quot;:&quot;mqo8zmozsw6&quot;,&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-web&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;regular&quot;,&quot;grpc.method&quot;:&quot;GetNewLFSPointers&quot;,&quot;grpc.request.deadline&quot;:&quot;2020-11-26T01:23:17Z&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.BlobService/GetNewLFSPointers&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.BlobService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;grpc.time_ms&quot;:10.164,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished streaming call with code OK&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:39070&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.777Z&quot;}
{&quot;correlation_id&quot;:&quot;BSJbCoB1SJ8&quot;,&quot;duration_ms&quot;:568,&quot;level&quot;:&quot;info&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;Finished HTTP request&quot;,&quot;status&quot;:200,&quot;time&quot;:&quot;2020-11-26T01:22:48.813Z&quot;,&quot;url&quot;:&quot;http://X.X.X.160/api/v4/internal/allowed&quot;}
{&quot;correlation_id&quot;:&quot;UxinibJuxD&quot;,&quot;duration_ms&quot;:45,&quot;level&quot;:&quot;info&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;Finished HTTP request&quot;,&quot;status&quot;:200,&quot;time&quot;:&quot;2020-11-26T01:22:48.859Z&quot;,&quot;url&quot;:&quot;http://X.X.X.160/api/v4/internal/pre_receive&quot;}
{&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;PreReceiveHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/PreReceiveHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;grpc.time_ms&quot;:616.497,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished streaming call with code OK&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.860Z&quot;}
{&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;UpdateHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/UpdateHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;grpc.time_ms&quot;:0.222,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished streaming call with code OK&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.877Z&quot;}

{&quot;error&quot;:&quot;error voting on transaction: error voting on transaction: transaction was aborted&quot;,&quot;grpc.code&quot;:&quot;Internal&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;ReferenceTransactionHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/ReferenceTransactionHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;grpc.time_ms&quot;:14.148,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;finished streaming call with code Internal&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.905Z&quot;}
{&quot;error&quot;:&quot;error voting on transaction: error voting on transaction: rpc error: code = Internal desc = subtransaction has failed&quot;,&quot;grpc.code&quot;:&quot;Internal&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;ReferenceTransactionHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/ReferenceTransactionHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;grpc.time_ms&quot;:1.25,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;finished streaming call with code Internal&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.919Z&quot;}
{&quot;correlation_id&quot;:&quot;CqyeiP2Iyc8&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-workhorse&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;PostReceivePack&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.SmartHTTPService/PostReceivePack&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.SmartHTTPService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;error executing git hookerror executing git hookfatal: ref updates aborted by hook\\n&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:39070&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.920Z&quot;}
{&quot;correlation_id&quot;:&quot;CqyeiP2Iyc8&quot;,&quot;diskcache&quot;:&quot;3764ffdd-944a-4977-b2ee-faa1360827ca&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-workhorse&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;PostReceivePack&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.SmartHTTPService/PostReceivePack&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/....&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-11&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/4f/c8/4fc82b26aecb47d2868c4efbe3581732a3e7cbcc6c2efb32062c08170a05eeb8.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-1&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.SmartHTTPService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T01:22:48Z&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;diskcache state change&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:39070&quot;,&quot;pid&quot;:6702,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T01:22:48.922Z&quot;}
</code></pre></div><p>log的时区不同？
https://docs.gitlab.com/ee/administration/timezone.html</p> <p>又尝试清缓存 通过rail console try to clear cache</p> <p>gitlab-rails console
https://docs.gitlab.com/ee/administration/troubleshooting/gitlab_rails_cheat_sheet.html</p> <div class="language- extra-class"><pre class="language-text"><code>p=Project.find_by(id:11)

irb(main):026:0&gt; pp p.statistics

irb(main):027:0&gt; p.statistics.refresh!

irb(main):028:0&gt; pp p.statistics

=&gt; #&lt;ProjectStatistics id: 10, project_id: 11, namespace_id: 12, commit_count: 1355, storage_size: 8074035, repository_size: 7990149, lfs_objects_size: 0, build_artifacts_size: 0, shared_runners_seconds: 0, shared_runners_seconds_last_reset: nil, packages_size: 0, wiki_size: 83886, snippets_size: 0, pipeline_artifacts_size: 0&gt;
irb(main):029:0&gt;
</code></pre></div><p>经过搜索最接近的是这里 https://gitlab.com/gitlab-org/gitaly/-/issues/3128 大概意思因为gitlab今年好像引入了Gitaly的新voting策略 所以看到不少类似问题，我们的不是primary failed vote，而是直接是vote error，因为我们的版本是13.4 他这里说是13.5做了一些关于voting的修正，这也许是为啥gitlab提醒我们 upgrade asap的原因</p> <h4 id="最终重现"><a href="#最终重现" class="header-anchor">#</a> 最终重现</h4> <p>回想过程，想起来是先推送的其他分支，然后才推送了master，重现成功，虽然git client端错误有点不同，不再卡死，而是报错：</p> <div class="language- extra-class"><pre class="language-text"><code>λ git push origin master
Total 0 (delta 0), reused 0 (delta 0), pack-reused 0
error: RPC failed; HTTP 500 curl 22 The requested URL returned error: 500
fatal: the remote end hung up unexpectedly
fatal: the remote end hung up unexpectedly
Everything up-to-date
</code></pre></div><p>但是服务器端是相同的错误</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;correlation_id&quot;:&quot;WurcwnEEsXa&quot;,&quot;error&quot;:&quot;handleReceivePack: smarthttp.ReceivePack: rpc error: code = Unavailable desc = PostReceivePack: exit status 128&quot;,&quot;level&quot;:&quot;error&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;error&quot;,&quot;time&quot;:&quot;2020-11-26T17:47:48+08:00&quot;,&quot;uri&quot;:&quot;/yue.liu/test-mgr.git/git-receive-pack&quot;}
{&quot;correlation_id&quot;:&quot;WurcwnEEsXa&quot;,&quot;duration_ms&quot;:534,&quot;host&quot;:&quot;X.X.X.160&quot;,&quot;level&quot;:&quot;info&quot;,&quot;method&quot;:&quot;POST&quot;,&quot;msg&quot;:&quot;access&quot;,&quot;proto&quot;:&quot;HTTP/1.1&quot;,&quot;referrer&quot;:&quot;&quot;,&quot;remote_addr&quot;:&quot;127.0.0.1:0&quot;,&quot;remote_ip&quot;:&quot;127.0.0.1&quot;,&quot;status&quot;:500,&quot;system&quot;:&quot;http&quot;,&quot;time&quot;:&quot;2020-11-26T17:47:48+08:00&quot;,&quot;uri&quot;:&quot;/yue.liu/test-mgr.git/git-receive-pack&quot;,&quot;user_agent&quot;:&quot;git/2.29.2.windows.2&quot;,&quot;written_bytes&quot;:0}

{&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;PreReceiveHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/PreReceiveHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;yue.liu/test-mgr&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-15&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:58Z&quot;,&quot;grpc.time_ms&quot;:236.395,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished streaming call with code OK&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:58.387Z&quot;}
{&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;UpdateHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/UpdateHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;yue.liu/test-mgr&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-15&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:58Z&quot;,&quot;grpc.time_ms&quot;:0.369,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished streaming call with code OK&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:58.410Z&quot;}
{&quot;error&quot;:&quot;error voting on transaction: error voting on transaction: transaction was aborted&quot;,&quot;grpc.code&quot;:&quot;Internal&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;ReferenceTransactionHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/ReferenceTransactionHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;yue.liu/test-mgr&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-15&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:58Z&quot;,&quot;grpc.time_ms&quot;:4.137,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;finished streaming call with code Internal&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:58.429Z&quot;}
{&quot;error&quot;:&quot;error voting on transaction: error voting on transaction: rpc error: code = Internal desc = subtransaction has failed&quot;,&quot;grpc.code&quot;:&quot;Internal&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;ReferenceTransactionHook&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.HookService/ReferenceTransactionHook&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;yue.liu/test-mgr&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-15&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.HookService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:58Z&quot;,&quot;grpc.time_ms&quot;:1.062,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;finished streaming call with code Internal&quot;,&quot;peer.address&quot;:&quot;@&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:58.444Z&quot;}
{&quot;correlation_id&quot;:&quot;WurcwnEEsXa&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-workhorse&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;PostReceivePack&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.SmartHTTPService/PostReceivePack&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;yue.liu/test-mgr&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-15&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.SmartHTTPService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:58Z&quot;,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;error executing git hookerror executing git hookfatal: ref updates aborted by hook\\n&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:54626&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:58.446Z&quot;}
{&quot;correlation_id&quot;:&quot;WurcwnEEsXa&quot;,&quot;diskcache&quot;:&quot;e0a52ce2-2bda-474f-8df5-5ca5537df98c&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-workhorse&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;PostReceivePack&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.SmartHTTPService/PostReceivePack&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;yue.liu/test-mgr&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-15&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.SmartHTTPService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:58Z&quot;,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;diskcache state change&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:54626&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:58.448Z&quot;}
{&quot;correlation_id&quot;:&quot;WurcwnEEsXa&quot;,&quot;error&quot;:&quot;rpc error: code = Canceled desc = rpc error: code = Unavailable desc = PostReceivePack: exit status 128&quot;,&quot;grpc.code&quot;:&quot;Canceled&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-workhorse&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;none&quot;,&quot;grpc.method&quot;:&quot;PostReceivePack&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.SmartHTTPService/PostReceivePack&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;yue.liu/test-mgr&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-15&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/e6/29/e629fa6598d732768f7c726b4b621285f9c3b85303900aa912017db7617d8bdb.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.SmartHTTPService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:58Z&quot;,&quot;grpc.time_ms&quot;:328.75,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished streaming call with code Canceled&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:54626&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:58.448Z&quot;}
{&quot;correlation_id&quot;:&quot;ldjgtuTb099&quot;,&quot;grpc.code&quot;:&quot;OK&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-web&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;regular&quot;,&quot;grpc.method&quot;:&quot;FindCommit&quot;,&quot;grpc.request.deadline&quot;:&quot;2020-11-26T09:48:28Z&quot;,&quot;grpc.request.fullMethod&quot;:&quot;/gitaly.CommitService/FindCommit&quot;,&quot;grpc.request.glProjectPath&quot;:&quot;test/...&quot;,&quot;grpc.request.glRepository&quot;:&quot;project-9&quot;,&quot;grpc.request.repoPath&quot;:&quot;@hashed/19/58/19581e27de7ced00ff1ce50b2047e7a567c76b1cbaebabe5ef03f7c3017bb5b7.git&quot;,&quot;grpc.request.repoStorage&quot;:&quot;gitaly-2&quot;,&quot;grpc.request.topLevelGroup&quot;:&quot;@hashed&quot;,&quot;grpc.service&quot;:&quot;gitaly.CommitService&quot;,&quot;grpc.start_time&quot;:&quot;2020-11-26T09:47:59Z&quot;,&quot;grpc.time_ms&quot;:6.662,&quot;level&quot;:&quot;info&quot;,&quot;msg&quot;:&quot;finished unary call with code OK&quot;,&quot;peer.address&quot;:&quot;X.X.X.162:54626&quot;,&quot;pid&quot;:6188,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2020-11-26T09:47:59.660Z&quot;}
</code></pre></div><h3 id="版本升级后出现500无法访问project"><a href="#版本升级后出现500无法访问project" class="header-anchor">#</a> 版本升级后出现500无法访问project</h3> <div class="language- extra-class"><pre class="language-text"><code>还是常规操作查看gitlab server日志，刚开始我是一个个日志去/var/log/gitlab里面看，结果没发现异常，然后又去到Praefect和Gitaly都没异常，说明从gitlab server到Praefect到Gitaly一路畅通，最后其实是我漏了gitlab server的一些日志，通过这个命令可以看全面：
gitlab-ctl tail
==&gt; /var/log/gitlab/nginx/gitlab_access.log &lt;==
10.30.30.94 - - [11/Dec/2020:11:15:26 +0800] &quot;GET /assets/favicon-7901bd695fb93edb07975966062049829afb56cf11511236e61bcf425070e36e.png HTTP/1.1&quot; 200 1611 &quot;http://X.X.X.133/dummyproject/dummy_project&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.67 Safari/537.36&quot; -

==&gt; /var/log/gitlab/puma/puma_stdout.log &lt;==
{&quot;timestamp&quot;:&quot;2020-12-11T03:15:27.086Z&quot;,&quot;pid&quot;:10524,&quot;message&quot;:&quot;PumaWorkerKiller: Consuming 7400.09765625 mb with master and 8 workers.&quot;}

==&gt; /var/log/gitlab/gitlab-rails/production.log &lt;==
Started GET &quot;/dummyproject/dummy_project&quot; for 10.30.30.94 at 2020-12-11 11:15:30 +0800
Processing by ProjectsController#show as HTML
  Parameters: {&quot;namespace_id&quot;=&gt;&quot;dummyproject&quot;, &quot;id&quot;=&gt;&quot;dummy_project&quot;}
Completed 500 Internal Server Error in 123ms (ActiveRecord: 11.4ms | Elasticsearch: 0.0ms | Allocations: 30989)

==&gt; /var/log/gitlab/gitlab-rails/production_json.log &lt;==
{&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;/dummyproject/dummy_project&quot;,&quot;format&quot;:&quot;html&quot;,&quot;controller&quot;:&quot;ProjectsController&quot;,&quot;action&quot;:&quot;show&quot;,&quot;status&quot;:500,&quot;time&quot;:&quot;2020-12-11T03:15:30.561Z&quot;,&quot;params&quot;:[{&quot;key&quot;:&quot;namespace_id&quot;,&quot;value&quot;:&quot;dummyproject&quot;},{&quot;key&quot;:&quot;id&quot;,&quot;value&quot;:&quot;dummy_project&quot;}],&quot;remote_ip&quot;:&quot;10.30.30.94&quot;,&quot;user_id&quot;:1,&quot;username&quot;:&quot;root&quot;,&quot;ua&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0&quot;,&quot;correlation_id&quot;:&quot;QlUs3cmwEw6&quot;,&quot;meta.user&quot;:&quot;root&quot;,&quot;meta.project&quot;:&quot;dummyproject/dummy_project&quot;,&quot;meta.root_namespace&quot;:&quot;dummyproject&quot;,&quot;meta.caller_id&quot;:&quot;ProjectsController#show&quot;,&quot;meta.feature_category&quot;:&quot;projects&quot;,&quot;gitaly_calls&quot;:2,&quot;gitaly_duration_s&quot;:0.015953,&quot;redis_calls&quot;:18,&quot;redis_duration_s&quot;:0.0048839999999999995,&quot;redis_read_bytes&quot;:2804,&quot;redis_write_bytes&quot;:2499,&quot;redis_cache_calls&quot;:17,&quot;redis_cache_duration_s&quot;:0.004227,&quot;redis_cache_read_bytes&quot;:2621,&quot;redis_cache_write_bytes&quot;:973,&quot;redis_shared_state_calls&quot;:1,&quot;redis_shared_state_duration_s&quot;:0.000657,&quot;redis_shared_state_read_bytes&quot;:183,&quot;redis_shared_state_write_bytes&quot;:1526,&quot;queue_duration_s&quot;:0.136449,&quot;cpu_s&quot;:0.26,&quot;exception.class&quot;:&quot;ActionView::Template::Error&quot;,&quot;exception.message&quot;:&quot;undefined method `change_reviewer_merge_request' for #&lt;NotificationSetting:0x00007f75ceb68438&gt;&quot;,&quot;exception.backtrace&quot;:[&quot;app/views/shared/notifications/_custom_notifications.html.haml:29:in `public_send'&quot;,&quot;app/views/shared/notifications/_custom_notifications.html.haml:29&quot;,&quot;app/views/shared/notifications/_custom_notifications.html.haml:25:in `each'&quot;,&quot;app/views/shared/notifications/_custom_notifications.html.haml:25:in `each_with_index'&quot;,&quot;app/views/shared/notifications/_custom_notifications.html.haml:25&quot;,&quot;app/views/shared/notifications/_custom_notifications.html.haml:14&quot;,&quot;app/views/shared/notifications/_new_button.html.haml:34&quot;,&quot;app/views/shared/notifications/_new_button.html.haml:33&quot;,&quot;app/views/shared/notifications/_new_button.html.haml:12&quot;,&quot;app/views/projects/_home_panel.html.haml:47&quot;,&quot;app/views/projects/show.html.haml:12&quot;,&quot;app/controllers/application_controller.rb:134:in `render'&quot;,&quot;app/controllers/application_controller.rb:548:in `block in allow_gitaly_ref_name_caching'&quot;,&quot;lib/gitlab/gitaly_client.rb:318:in `allow_ref_name_caching'&quot;,&quot;app/controllers/application_controller.rb:547:in `allow_gitaly_ref_name_caching'&quot;,&quot;ee/lib/gitlab/ip_address_state.rb:10:in `with'&quot;,&quot;ee/app/controllers/ee/application_controller.rb:44:in `set_current_ip_address'&quot;,&quot;app/controllers/application_controller.rb:493:in `set_current_admin'&quot;,&quot;lib/gitlab/session.rb:11:in `with_session'&quot;,&quot;app/controllers/application_controller.rb:484:in `set_session_storage'&quot;,&quot;lib/gitlab/i18n.rb:73:in `with_locale'&quot;,&quot;lib/gitlab/i18n.rb:79:in `with_user_locale'&quot;,&quot;app/controllers/application_controller.rb:478:in `set_locale'&quot;,&quot;lib/gitlab/error_tracking.rb:52:in `with_context'&quot;,&quot;app/controllers/application_controller.rb:543:in `sentry_context'&quot;,&quot;app/controllers/application_controller.rb:471:in `block in set_current_context'&quot;,&quot;lib/gitlab/application_context.rb:54:in `block in use'&quot;,&quot;lib/gitlab/application_context.rb:54:in `use'&quot;,&quot;lib/gitlab/application_context.rb:21:in `with_context'&quot;,&quot;app/controllers/application_controller.rb:463:in `set_current_context'&quot;,&quot;lib/gitlab/metrics/elasticsearch_rack_middleware.rb:16:in `call'&quot;,&quot;lib/gitlab/middleware/rails_queue_duration.rb:33:in `call'&quot;,&quot;lib/gitlab/metrics/rack_middleware.rb:16:in `block in call'&quot;,&quot;lib/gitlab/metrics/transaction.rb:61:in `run'&quot;,&quot;lib/gitlab/metrics/rack_middleware.rb:16:in `call'&quot;,&quot;lib/gitlab/request_profiler/middleware.rb:17:in `call'&quot;,&quot;lib/gitlab/jira/middleware.rb:19:in `call'&quot;,&quot;lib/gitlab/middleware/go.rb:20:in `call'&quot;,&quot;lib/gitlab/etag_caching/middleware.rb:13:in `call'&quot;,&quot;lib/gitlab/middleware/multipart.rb:218:in `call'&quot;,&quot;lib/gitlab/middleware/handle_null_bytes.rb:19:in `call'&quot;,&quot;lib/gitlab/middleware/read_only/controller.rb:51:in `call'&quot;,&quot;lib/gitlab/middleware/read_only.rb:18:in `call'&quot;,&quot;lib/gitlab/middleware/same_site_cookies.rb:27:in `call'&quot;,&quot;lib/gitlab/middleware/basic_health_check.rb:25:in `call'&quot;,&quot;lib/gitlab/middleware/handle_ip_spoof_attack_error.rb:25:in `call'&quot;,&quot;lib/gitlab/middleware/request_context.rb:23:in `call'&quot;,&quot;config/initializers/fix_local_cache_middleware.rb:9:in `call'&quot;,&quot;lib/gitlab/metrics/requests_rack_middleware.rb:49:in `call'&quot;,&quot;lib/gitlab/middleware/release_env.rb:12:in `call'&quot;],&quot;db_duration_s&quot;:0.01144,&quot;view_duration_s&quot;:0.0,&quot;duration_s&quot;:0.12355,&quot;db_count&quot;:26,&quot;db_write_count&quot;:0,&quot;db_cached_count&quot;:4}
==&gt; /var/log/gitlab/gitlab-rails/production.log &lt;==

ActionView::Template::Error (undefined method `change_reviewer_merge_request' for #&lt;NotificationSetting:0x00007f75ceb68438&gt;):
    26:                   - field_id = &quot;#{notifications_menu_identifier(&quot;modal&quot;, notification_setting)}_notification_setting[#{event}]&quot;
    27:                   .form-group
    28:                     .form-check{ class: (&quot;gl-mt-0&quot; if index == 0) }
    29:                       = check_box(&quot;notification_setting&quot;, event, id: field_id, class: &quot;js-custom-notification-event form-check-input&quot;, checked: notification_setting.public_send(event))
    30:                       %label.form-check-label{ for: field_id }
    31:                         %strong
    32:                           = notification_event_name(event)

app/views/shared/notifications/_custom_notifications.html.haml:29:in `public_send'
app/views/shared/notifications/_custom_notifications.html.haml:29
app/views/shared/notifications/_custom_notifications.html.haml:25:in `each'
app/views/shared/notifications/_custom_notifications.html.haml:25:in `each_with_index'
app/views/shared/notifications/_custom_notifications.html.haml:25
app/views/shared/notifications/_custom_notifications.html.haml:14
app/views/shared/notifications/_new_button.html.haml:34
app/views/shared/notifications/_new_button.html.haml:33
app/views/shared/notifications/_new_button.html.haml:12
app/views/projects/_home_panel.html.haml:47
app/views/projects/show.html.haml:12
app/controllers/application_controller.rb:134:in `render'
app/controllers/application_controller.rb:548:in `block in allow_gitaly_ref_name_caching'
lib/gitlab/gitaly_client.rb:318:in `allow_ref_name_caching'
app/controllers/application_controller.rb:547:in `allow_gitaly_ref_name_caching'
ee/lib/gitlab/ip_address_state.rb:10:in `with'
ee/app/controllers/ee/application_controller.rb:44:in `set_current_ip_address'
app/controllers/application_controller.rb:493:in `set_current_admin'
lib/gitlab/session.rb:11:in `with_session'
app/controllers/application_controller.rb:484:in `set_session_storage'
lib/gitlab/i18n.rb:73:in `with_locale'
lib/gitlab/i18n.rb:79:in `with_user_locale'
app/controllers/application_controller.rb:478:in `set_locale'
lib/gitlab/error_tracking.rb:52:in `with_context'
app/controllers/application_controller.rb:543:in `sentry_context'
app/controllers/application_controller.rb:471:in `block in set_current_context'
lib/gitlab/application_context.rb:54:in `block in use'
lib/gitlab/application_context.rb:54:in `use'
lib/gitlab/application_context.rb:21:in `with_context'
app/controllers/application_controller.rb:463:in `set_current_context'
lib/gitlab/metrics/elasticsearch_rack_middleware.rb:16:in `call'
lib/gitlab/middleware/rails_queue_duration.rb:33:in `call'
lib/gitlab/metrics/rack_middleware.rb:16:in `block in call'
lib/gitlab/metrics/transaction.rb:61:in `run'
lib/gitlab/metrics/rack_middleware.rb:16:in `call'
lib/gitlab/request_profiler/middleware.rb:17:in `call'
lib/gitlab/jira/middleware.rb:19:in `call'
lib/gitlab/middleware/go.rb:20:in `call'
lib/gitlab/etag_caching/middleware.rb:13:in `call'
lib/gitlab/middleware/multipart.rb:218:in `call'
lib/gitlab/middleware/handle_null_bytes.rb:19:in `call'
lib/gitlab/middleware/read_only/controller.rb:51:in `call'
lib/gitlab/middleware/read_only.rb:18:in `call'
lib/gitlab/middleware/same_site_cookies.rb:27:in `call'
lib/gitlab/middleware/basic_health_check.rb:25:in `call'
lib/gitlab/middleware/handle_ip_spoof_attack_error.rb:25:in `call'
lib/gitlab/middleware/request_context.rb:23:in `call'
config/initializers/fix_local_cache_middleware.rb:9:in `call'
lib/gitlab/metrics/requests_rack_middleware.rb:49:in `call'
lib/gitlab/middleware/release_env.rb:12:in `call'

==&gt; /var/log/gitlab/gitlab-workhorse/current &lt;==
{&quot;content_type&quot;:&quot;text/html; charset=utf-8&quot;,&quot;correlation_id&quot;:&quot;QlUs3cmwEw6&quot;,&quot;duration_ms&quot;:297,&quot;host&quot;:&quot;X.X.X.133&quot;,&quot;level&quot;:&quot;info&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;msg&quot;:&quot;access&quot;,&quot;proto&quot;:&quot;HTTP/1.1&quot;,&quot;referrer&quot;:&quot;http://X.X.X.133/&quot;,&quot;remote_addr&quot;:&quot;127.0.0.1:0&quot;,&quot;remote_ip&quot;:&quot;127.0.0.1&quot;,&quot;status&quot;:500,&quot;system&quot;:&quot;http&quot;,&quot;time&quot;:&quot;2020-12-11T11:15:30+08:00&quot;,&quot;uri&quot;:&quot;/dummyproject/dummy_project&quot;,&quot;user_agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0&quot;,&quot;written_bytes&quot;:2926}

很容易就发现：
ActionView::Template::Error (undefined method `change_reviewer_merge_request'这段，通过在gitlab.com 搜索后面的详情第一个error：“app/views/shared/notifications/_custom_notifications.html.haml:29:in `public_send'”
得到：
https://gitlab.com/gitlab-org/gitlab/-/issues/5752
然后根据提示检查db migration：

gitlab-rake db:migrate:status
发现很多down的
[root@vm-cicd-v01 opt]# gitlab-rake db:migrate:status|grep notification
   up     20190115054216  Add error notification sent to remote mirrors
   up     20190320174702  Add lets encrypt notification email to application settings
   up     20190327163904  Add notification email to notification settings
   up     20190606014128  Add last ci minutes notification at to namespaces
   up     20190621022810  Add last ci minutes usage notification level to namespaces
   up     20190930082942  Add new release to notification settings
   up     20191014123159  Add expire notification delivered to personal access tokens
   up     20191111165017  Add fixed pipeline to notification settings
   up     20200311192351  Add index on noteable type and noteable id to sent notifications
   up     20200717163656  Add moved project to notification settings
   up     20200729151021  Add after expiry notification delivered to personal access tokens
  down    20200909083339  Add change reviewer merge request to notification settings
  down    20200912152943  Rename admin notification email application setting
  down    20200912153218  Cleanup admin notification email application setting rename
  
gitlab-rails dbconsole
\d notification_settings
确实没有 change_reviewer_merge_request
然后 gitlab-rake db:migrate:status|grep notification_settings 会看到相关的脚本基本都down
修复很简单，执行
gitlab-rake db:migrate
	
</code></pre></div><h3 id="malformed-configuration-json-file-found-at-opt-gitlab-embedded-nodes-xxxx-json"><a href="#malformed-configuration-json-file-found-at-opt-gitlab-embedded-nodes-xxxx-json" class="header-anchor">#</a> Malformed configuration JSON file found at /opt/gitlab/embedded/nodes/XXXX.json</h3> <div class="language- extra-class"><pre class="language-text"><code># yum history info 21
Loaded plugins: product-id, search-disabled-repos, subscription-manager

This system is not registered with an entitlement server. You can use subscription-manager to register.

Transaction ID : 21
Begin time     : Wed Dec 23 10:30:02 2020
Begin rpmdb    : 428:92019b90dfb62522e2602a67ec8bb622df3d807c
End time       :            10:30:10 2020 (8 seconds)
End rpmdb      : 428:92019b90dfb62522e2602a67ec8bb622df3d807c
User           : root &lt;root&gt;
Return-Code    : Failure: 1
Command Line   : -d 2 -y install /opt/gitlab-ee-13.5.1-ee.0.el7.x86_64.rpm
Transaction performed with:
    Installed     rpm-4.11.3-43.el7.x86_64                    @APX
    Installed     subscription-manager-1.24.26-3.el7_8.x86_64 @APX
    Installed     yum-3.4.3-167.el7.noarch                    @APX
Packages Altered:
 ** Updated gitlab-ee-13.5.0-ee.0.el7.x86_64 @/gitlab-ee-13.5.0-ee.0.el7.x86_64
 ** Update            13.5.1-ee.0.el7.x86_64 ?
Scriptlet output:
   1 Malformed configuration JSON file found at /opt/gitlab/embedded/nodes/xxxxx.json.
   2 This usually happens when your last run of `gitlab-ctl reconfigure` didn't complete successfully.
   3 This file is used to check if any of the unsupported configurations are enabled,
   4 and hence require a working reconfigure before upgrading.
   5 Please run `sudo gitlab-ctl reconfigure` to fix it and try again.
   6 error: %pre(gitlab-ee-13.5.1-ee.0.el7.x86_64) scriptlet failed, exit status 1
</code></pre></div><ol><li>升级报错“Malformed configuration JSON file found at /opt/gitlab/embedded/nodes/XXX.json.”</li> <li>然后根据这个错误我看了下这个文件内只是一个简单的hostname，而且是正常Jason格式，根据 https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/4385 中有人提到删除该文件即可正常升级</li> <li>然后根据log提示 “Please run <code>sudo gitlab-ctl reconfigure</code> to fix it and try again”决定执行 reconfigure看看，结果仍然报错，不过错误信息是：“ruby_block[directory resource: /var/opt/gitlab/git-data/repositories] (/opt/gitlab/embedded/cookbooks/cache/cookbooks/package/resources/storage_directory.rb line 34) had an error: Mixlib::ShellOut::ShellCommandFailed: Failed asserting that mode permissions on &quot;/var/opt/gitlab/git-data/repositories&quot;”
4.根据第3的错误搜索，发现 https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/5743，确定是版本13.5.0自己的问题，说是升级到13.5.1就解决了</li> <li>所以，13.5.0的一个bug造成无法reconfigure，只能通过升级解决，但是升级又遇到所谓malformed json错误，提示reconfigure解决，deadlock！</li> <li>最终解决，采用别人提到的尝试删除/opt/gitlab/embedded/nodes/XXXX.json，再次升级成功！</li></ol> <h3 id="gitlab-backup备份定时任务失败"><a href="#gitlab-backup备份定时任务失败" class="header-anchor">#</a> gitlab-backup备份定时任务失败</h3> <p>通过查crontab的相关日志以及 /var/mail/root，发现是配置的目录没有权限</p> <p>但是实际上改目录已经chown给了git用户，最后发现是git对这个目录的父目录没有权限！</p> <h3 id="磁盘用尽"><a href="#磁盘用尽" class="header-anchor">#</a> 磁盘用尽</h3> <ol><li><p>备份文件忘记设置 keeping time，造成默认的/var用尽</p></li> <li><p>prometheus监控数据，每天大概1.28G 上下，retention貌似是2 weeks</p> <p>https://docs.gitlab.com/ee/operations/metrics/dashboards/#annotation-retention-policy</p> <div class="language- extra-class"><pre class="language-text"><code>(time() - prometheus_tsdb_lowest_timestamp_seconds) / 86400

http://XXXXX-/grafana/explore?orgId=1&amp;left=[&quot;now-1h&quot;,&quot;now&quot;,&quot;GitLab Omnibus&quot;,{&quot;expr&quot;:&quot;(time() - prometheus_tsdb_lowest_timestamp_seconds) %2F 86400&quot;},{&quot;mode&quot;:&quot;Metrics&quot;},{&quot;ui&quot;:[true,true,true,&quot;none&quot;]}]

可以看到结果是15，差不多就是2个礼拜多一天，所以/var尽量要大一些，至少50G以上

 ls -ltrh $(find /var/opt/gitlab/prometheus/data/wal/* -not -empty)
 
 https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/4166
 
 
最后发现可能是由于之前磁盘出现过问题，造成prometheus出错：
 tail -f /var/log/gitlab/prometheus/current
2021-02-09_05:00:02.10666 level=info ts=2021-02-09T05:00:02.106Z caller=head.go:804 component=tsdb msg=&quot;Head GC completed&quot; duration=57.012153ms
2021-02-09_05:00:02.10697 level=error ts=2021-02-09T05:00:02.106Z caller=db.go:685 component=tsdb msg=&quot;compaction failed&quot; err=&quot;reload blocks: head truncate failed: truncate chunks.HeadReadWriter: maxt of the files are not set&quot;
2021-02-09_07:00:01.99667 level=info ts=2021-02-09T07:00:01.995Z caller=compact.go:495 component=tsdb msg=&quot;write block&quot; mint=1612843200000 maxt=1612850400000 ulid=01EY2SDZ0QD07844YCTAQ8S55Z duration=1.332421074s

尝试使用prometheus api，发现admin api被gitlab禁用
https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-stats
$ curl -XPOST http://localhost:9090/api/v1/admin/tsdb/clean_tombstones

https://github.com/prometheus/prometheus/issues/7753
gitlab-ctl stop prometheus
Delete the chunks_head directory
gitlab-ctl start prometheus

</code></pre></div></li></ol> <h3 id="web访问404-500-503-pull-timeout"><a href="#web访问404-500-503-pull-timeout" class="header-anchor">#</a> web访问404/500/503, pull timeout</h3> <h4 id="观察"><a href="#观察" class="header-anchor">#</a> 观察</h4> <p>现象是repo无法pull，偶尔有个别repo可以pull，主要报错如下</p> <div class="language- extra-class"><pre class="language-text"><code>$ git pull
fatal: unable to access 'http://X.X.X.160/test.git/': Failed to connect to X.X.X.160 port 80: Timed out

$ git pull
error: RPC failed; HTTP 500 curl 22 The requested URL returned error: 500
fatal: expected flush after ref listing

$ git pull
fatal: the remote end hung up unexceptedly
</code></pre></div><p>另外通过web访问project，会不断出现404/500/503等页面，多次刷新才能渲染，而且渲染页面出现奇怪提示：</p> <p>首先是黄色warn：</p> <p><code>You won't be able to pull or push project code via SSH until you add an SSH key to your profile</code></p> <p>但是我跑到Admin Area-&gt;settings-&gt;Enabled Git Access Protocol 明明是Both SSH and HTTP(S)</p> <p>然后有时候渲染出来还有红色error：</p> <p><code>An error occurred while fetching folder content</code></p> <h4 id="开始排查"><a href="#开始排查" class="header-anchor">#</a> 开始排查：</h4> <p>首先从gitlab server入手，
gitlab-ctl tail
看到很多gitlab-runner日志
https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/3324
修改了 gitlab-runner机器上的 /etc/gitlab-runner/config.toml，将check_interval 从0（默认3秒）改成30秒</p> <p>没有什么影响，只是让其频率不要太高</p> <p>然后继续看到gitlab-server上很多 PermissionDenied</p> <div class="language- extra-class"><pre class="language-text"><code>vim /var/log/gitlab/gitlab-workhorse/current

{&quot;error&quot;:&quot;rpc error: code = PermissionDenied desc = permission denied&quot;,&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;:&quot;GetInfoRefsHandler: error copying gitaly response&quot;,&quot;time&quot;:&quot;2021-05-11T15:52:40+08:00&quot;}
{&quot;content_type&quot;:&quot;application/x-git-upload-pack-advertisement&quot;,&quot;correlation_id&quot;:&quot;ukeIGrLRj09&quot;,&quot;duration_ms&quot;:145,&quot;host&quot;:&quot;X.X.X.160&quot;,&quot;level&quot;:&quot;info&quot;,&quot;method&quot;:&quot;GET&quot;,&quot;msg&quot;:&quot;access&quot;,&quot;proto&quot;:&quot;HTTP/1.1&quot;,&quot;referrer&quot;:&quot;&quot;,&quot;remote_addr&quot;:&quot;127.0.0.1:0&quot;,&quot;remote_ip&quot;:&quot;127.0.0.1&quot;,&quot;status&quot;:200,&quot;system&quot;:&quot;http&quot;,&quot;time&quot;:&quot;2021-05-11T15:52:40+08:00&quot;,&quot;uri&quot;:&quot;/test.git/info/refs?service=git-upload-pack&quot;,&quot;user_agent&quot;:&quot;git/2.18.0.windows.1&quot;,&quot;written_bytes&quot;:23}

</code></pre></div><p>其实下一步应该自然去查下Praefect，不过还是先碰运气看看有没有exception</p> <div class="language- extra-class"><pre class="language-text"><code>
[root@vm-gitlab-v01 gitlab]# grep -r -l &quot;exception&quot; /var/log/gitlab/
/var/log/gitlab/gitlab-rails/production_json.log
/var/log/gitlab/gitlab-rails/exceptions_json.log
/var/log/gitlab/sidekiq/current

{&quot;method&quot;:&quot;GET&quot;,&quot;path&quot;:&quot;/frontend&quot;,&quot;format&quot;:&quot;html&quot;,&quot;controller&quot;:&quot;ProjectsController&quot;,&quot;action&quot;:&quot;show&quot;,&quot;status&quot;:500,&quot;time&quot;:&quot;2021-05-11T06:16:37.525Z&quot;,&quot;params&quot;:[{&quot;key&quot;:&quot;namespace_id&quot;,&quot;value&quot;:&quot;XXXX&quot;},{&quot;key&quot;:&quot;id&quot;,&quot;value&quot;:&quot;test-frontend&quot;}],&quot;remote_ip&quot;:&quot;172.16.200.106&quot;,&quot;user_id&quot;:5,&quot;username&quot;:&quot;yue.liu&quot;,&quot;ua&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36&quot;,&quot;correlation_id&quot;:&quot;SjP5M2qxjT2&quot;,&quot;meta.user&quot;:&quot;yue.liu&quot;,&quot;meta.project&quot;:&quot;frontend&quot;,&quot;meta.root_namespace&quot;:&quot;test&quot;,&quot;meta.caller_id&quot;:&quot;ProjectsController#show&quot;,&quot;meta.feature_category&quot;:&quot;projects&quot;,&quot;gitaly_calls&quot;:8,&quot;gitaly_duration_s&quot;:0.039444,&quot;redis_calls&quot;:26,&quot;redis_duration_s&quot;:0.008223,&quot;redis_read_bytes&quot;:3442,&quot;redis_write_bytes&quot;:3001,&quot;redis_cache_calls&quot;:25,&quot;redis_cache_duration_s&quot;:0.007496,&quot;redis_cache_read_bytes&quot;:3259,&quot;redis_cache_write_bytes&quot;:1471,&quot;redis_shared_state_calls&quot;:1,&quot;redis_shared_state_duration_s&quot;:0.000727,&quot;redis_shared_state_read_bytes&quot;:183,&quot;redis_shared_state_write_bytes&quot;:1530,&quot;queue_duration_s&quot;:0.004365,&quot;cpu_s&quot;:0.18,&quot;exception.class&quot;:&quot;ActionView::Template::Error&quot;,&quot;exception.message&quot;:&quot;7:permission denied. debug_error_string:{\&quot;created\&quot;:\&quot;@1620713797.523463298\&quot;,\&quot;description\&quot;:\&quot;Error received from peer ipv4:X.X.X.162:2305\&quot;,\&quot;file\&quot;:\&quot;src/core/lib/surface/call.cc\&quot;,\&quot;file_line\&quot;:1055,\&quot;grpc_message\&quot;:\&quot;permission denied\&quot;,\&quot;grpc_status\&quot;:7}&quot;,&quot;exception.backtrace&quot;:[],&quot;db_duration_s&quot;:0.02671,&quot;view_duration_s&quot;:0.0,&quot;duration_s&quot;:0.20744,&quot;db_count&quot;:45,&quot;db_write_count&quot;:0,&quot;db_cached_count&quot;:7}
</code></pre></div><p>既然 Error received from peer ipv4:X.X.X.162:2305，那就继续看看Praefect</p> <div class="language- extra-class"><pre class="language-text"><code>ssh root@PraefectServer

gitlab-ctl tail
==&gt; /var/log/gitlab/praefect/current &lt;==
{&quot;correlation_id&quot;:&quot;pFeuwxhtCj9&quot;,&quot;error&quot;:&quot;rpc error: code = PermissionDenied desc = permission denied&quot;,&quot;grpc.code&quot;:&quot;PermissionDenied&quot;,&quot;grpc.meta.auth_version&quot;:&quot;v2&quot;,&quot;grpc.meta.client_name&quot;:&quot;gitlab-web&quot;,&quot;grpc.meta.deadline_type&quot;:&quot;regular&quot;,&quot;grpc.method&quot;:&quot;FindCommit&quot;,&quot;grpc.request.deadline&quot;:&quot;2021-05-11T15:05:23+08:00&quot;,&quot;grpc.service&quot;:&quot;gitaly.CommitService&quot;,&quot;grpc.start_time&quot;:&quot;2021-05-11T15:04:54+08:00&quot;,&quot;grpc.time_ms&quot;:0.182,&quot;level&quot;:&quot;warning&quot;,&quot;msg&quot;:&quot;finished streaming call with code PermissionDenied&quot;,&quot;peer.address&quot;:&quot;X.X.X.160:39862&quot;,&quot;pid&quot;:30377,&quot;span.kind&quot;:&quot;server&quot;,&quot;system&quot;:&quot;grpc&quot;,&quot;time&quot;:&quot;2021-05-11T15:04:54.334Z&quot;}

</code></pre></div><p>虽然这里没有提gitaly，还是确认下</p> <div class="language- extra-class"><pre class="language-text"><code>ssh root@X.X.X.164
gitlab-ctl tail

==&gt; /var/log/gitlab/gitaly/gitaly_hooks.log &lt;==
time=&quot;2021-01-09T07:32:48Z&quot; level=fatal msg=&quot;error when receiving data for \&quot;reference-transaction\&quot;: rpc error: code = Internal desc = error voting on transaction: error voting on transaction: transaction was aborted&quot;
time=&quot;2021-01-09T07:33:24Z&quot; level=fatal msg=&quot;error when receiving data for \&quot;reference-transaction\&quot;: rpc error: code = Internal desc = error voting on transaction: error voting on transaction: transaction was aborted&quot;
time=&quot;2021-01-10T16:14:12Z&quot; level=fatal msg=&quot;error when receiving data for \&quot;reference-transaction\&quot;: stdin send error: EOF&quot;

==&gt; /var/log/gitlab/logrotate/state &lt;==

==&gt; /var/log/gitlab/logrotate/current &lt;==
2021-05-10_16:22:45.32977 error: error opening /var/log/gitlab/gitlab-shell//gitlab-shell.log: Permission denied

注意时间，前面的是很久之前的问题，直接忽略，然后最新的是这个文件的权限问题，
chown git:root /var/log/gitlab/gitlab-shell/gitlab-shell.log 
当然这里不是问题来源
</code></pre></div><p>最后根据最开始gitlab-server上的</p> <p><code>permission GetInfoRefsHandler: error copying gitaly response</code></p> <p>搜索到https://docs.gitlab.com/ee/administration/gitaly/ 的 Permission denied errors appearing in Gitaly or Praefect logs when accessing repositories 部分，可以基本上确定是 clock drift问题（因为我很确定没有更改过任何token配置以及用户名密码都是对的）</p> <p>马后炮：实际上，根据前面Praefect的日志信息：</p> <p><code>&quot;msg&quot;:&quot;finished streaming call with code PermissionDenied&quot;</code></p> <p>就也可以找到https://docs.gitlab.com/ee/administration/gitaly/ 上面的答案</p> <h2 id="appendix"><a href="#appendix" class="header-anchor">#</a> Appendix</h2> <p>防火墙状态：</p> <p>sudo firewall-cmd --list-all</p> <h3 id="gitlab-ctl"><a href="#gitlab-ctl" class="header-anchor">#</a> gitlab-ctl</h3> <div class="language- extra-class"><pre class="language-text"><code>[liuyue@vm-cicd-v02 ~]$ gitlab-ctl help
omnibus-ctl: command (subcommand)
check-config
  Check if there are any configuration in gitlab.rb that is removed in specified version
deploy-page
  Put up the deploy page
diff-config
  Compare the user configuration with package available configuration
get-redis-master
  Get connection details to Redis master
prometheus-upgrade
  Upgrade the Prometheus data to the latest supported version
remove-accounts
  Delete *all* users and groups used by this package
reset-grafana
  Reset Grafana instance to its initial state by removing the data directory
set-grafana-password
  Reset admin password for Grafana
upgrade
  Run migrations after a package upgrade
General Commands:
  cleanse
    Delete *all* gitlab data, and start from scratch.
  help
    Print this help message.
  reconfigure
    Reconfigure the application.
  show-config
    Show the configuration that would be generated by reconfigure.
  uninstall
    Kill all processes and uninstall the process supervisor (data will be preserved).
Service Management Commands:
  graceful-kill
    Attempt a graceful stop, then SIGKILL the entire process group.
  hup
    Send the services a HUP.
  int
    Send the services an INT.
  kill
    Send the services a KILL.
  once
    Start the services if they are down. Do not restart them if they stop.
  restart
    Stop the services if they are running, then start them again.
  service-list
    List all the services (enabled services appear with a *.)
  start
    Start services if they are down, and restart them if they stop.
  status
    Show the status of all the services.
  stop
    Stop the services, and do not restart them.
  tail
    Watch the service logs of all enabled services.
  term
    Send the services a TERM.
  usr1
    Send the services a USR1.
  usr2
    Send the services a USR2.
Backup Commands:
  backup-etc
    Backup GitLab configuration [accepts directory path]
Let's Encrypt Commands:
  renew-le-certs
    Renew the existing Let's Encrypt certificates
Database Commands:
  pg-password-md5
    Generate MD5 Hash of user password in PostgreSQL format
  pg-upgrade
    Upgrade the PostgreSQL DB to the latest supported version
  revert-pg-upgrade
    Run this to revert to the previous version of the database
  set-replication-password
    Set database replication password
Container Registry Commands:
  registry-garbage-collect
    Run Container Registry garbage collection.
</code></pre></div><h3 id="gitlab-rails"><a href="#gitlab-rails" class="header-anchor">#</a> gitlab-rails</h3> <div class="language- extra-class"><pre class="language-text"><code>[liuyue@vm-cicd-v02 opt]$ sudo gitlab-rails help
[sudo] password for liuyue:
The most common rails commands are:
 generate     Generate new code (short-cut alias: &quot;g&quot;)
 console      Start the Rails console (short-cut alias: &quot;c&quot;)
 server       Start the Rails server (short-cut alias: &quot;s&quot;)
 test         Run tests except system tests (short-cut alias: &quot;t&quot;)
 test:system  Run system tests
 dbconsole    Start a console for the database specified in config/database.yml
              (short-cut alias: &quot;db&quot;)

 new          Create a new Rails application. &quot;rails new my_app&quot; creates a
              new application called MyApp in &quot;./my_app&quot;


All commands can be run with -h (or --help) for more information.
In addition to those commands, there are:

--------------------------------------------------------------------------------
 GitLab:       13.0.7 (bcfbac449a7) FOSS
 GitLab Shell: 13.2.0
 PostgreSQL:   11.7
--------------------------------------------------------------------------------
  about
  acts_as_taggable_on_engine:install:migrations
  acts_as_taggable_on_engine:tag_names:collate_bin
  acts_as_taggable_on_engine:tag_names:collate_ci
  app:template
  app:update
  assets:clean[keep]
  assets:clobber
  assets:environment
  assets:precompile                                              
brakeman                                                       
cache:clear:redis                                              
cache_digests:dependencies                                     
cache_digests:nested_dependencies                              
ci:cleanup:builds                                              
clean                                                          
clobber                                                        
config_lint                                                    
credentials:edit                                               
credentials:show                                               
danger_local                                                   
db:create                                                      
db:drop                                                        
db:environment:set                                             
db:fixtures:load                                               
db:load_config                                                 
db:migrate                                                     
db:migrate:status                                              
db:obsolete_ignored_columns                                    
db:prepare                                                     
db:rollback                                                    
db:schema:cache:clear                                          
db:schema:cache:dump                                           
db:schema:dump                                                 
db:schema:load                                                 
db:seed                                                        
db:seed:replant                                                
db:seed_fu                                                     
db:setup                                                       
db:structure:dump                                              
db:structure:load                                              
db:system:change                                               
db:version                                                     
destroy                                                        
dev:cache                                                      
dev:load                                                       
dev:setup                                                      
downtime_check                                                 
encrypted:edit                                                 
encrypted:show                                                 
file_hooks:validate
  gemojione:aliases
  gemojione:install_assets
  gettext:add_language[language]
  gettext:find
  gettext:lint
  gettext:pack
  gettext:po_to_json
  gettext:regenerate
  gettext:store_model_attributes
  gitlab:app:check
  gitlab:artifacts:check
  gitlab:artifacts:migrate
  gitlab:assets:clean
  gitlab:assets:compile
  gitlab:assets:compile_webpack_if_needed
  gitlab:assets:fix_urls
  gitlab:assets:purge
  gitlab:assets:purge_modules
  gitlab:assets:vendor
  gitlab:backup:create
  gitlab:backup:restore
  gitlab:check
  gitlab:cleanup:block_removed_ldap_users
  gitlab:cleanup:moved
  gitlab:cleanup:orphan_job_artifact_files
  gitlab:cleanup:orphan_lfs_file_references
  gitlab:cleanup:orphan_lfs_files
  gitlab:cleanup:project_uploads
  gitlab:cleanup:remote_upload_files
  gitlab:cleanup:sessions:active_sessions_lookup_keys
  gitlab:db:clean_structure_sql
  gitlab:db:composite_primary_keys_add
  gitlab:db:composite_primary_keys_drop
  gitlab:db:configure
  gitlab:db:downtime_check[ref]
  gitlab:db:drop_tables
  gitlab:db:mark_migration_complete[version]
  gitlab:db:setup_ee
   gitlab:env:info
  gitlab:exclusive_lease:clear[scope]
  gitlab:features:enable_rugged
  gitlab:generate_sample_prometheus_data[environment_id]
  gitlab:git:fsck
  gitlab:gitaly:check
  gitlab:gitaly:install[dir,storage_path,repo]
  gitlab:gitlab_shell:check
  gitlab:import:all_users_to_all_groups
  gitlab:import:all_users_to_all_projects
  gitlab:import:repos[import_path]
  gitlab:import:user_to_groups[email]
  gitlab:import:user_to_projects[email]
  gitlab:import_export:bump_version
  gitlab:import_export:data
  gitlab:import_export:export[username,namespace_path,project_path,archive_path]
  gitlab:import_export:import[username,namespace_path,project_path,archive_path]
  gitlab:import_export:version
  gitlab:incoming_email:check
  gitlab:ldap:rename_provider[old_provider,new_provider]
  gitlab:lfs:check
  gitlab:lfs:migrate
  gitlab:orphans:check
  gitlab:orphans:check_namespaces
  gitlab:orphans:check_repositories
  gitlab:praefect:replicas[project_id]
  gitlab:seed:group_seed[subgroups_depth,username]
  gitlab:seed:issues[project_full_path,backfill_weeks,average_issues_per_week]
  gitlab:setup
  gitlab:shell:build_missing_projects
  gitlab:shell:install[repo]
  gitlab:shell:setup
  gitlab:sidekiq:check
  gitlab:snippets:list_non_migrated
  gitlab:snippets:migrate[ids]
  gitlab:snippets:migration_status
  gitlab:storage:hashed_attachments
  gitlab:storage:hashed_projects
  gitlab:storage:legacy_attachments
  gitlab:storage:legacy_projects
  gitlab:storage:list_hashed_attachments
  gitlab:storage:list_hashed_projects
   gitlab:storage:list_legacy_attachments
  gitlab:storage:list_legacy_projects
  gitlab:storage:migrate_to_hashed
  gitlab:storage:rollback_to_legacy
  gitlab:tcp_check[host,port]
  gitlab:test
  gitlab:two_factor:disable_for_all_users
  gitlab:two_factor:rotate_key:apply
  gitlab:two_factor:rotate_key:rollback
  gitlab:update_project_templates
  gitlab:update_templates
  gitlab:uploads:check
  gitlab:uploads:migrate:all
  gitlab:uploads:migrate[uploader_class,model_class,mounted_as]
  gitlab:uploads:migrate_to_local:all
  gitlab:uploads:migrate_to_local[uploader_class,model_class,mounted_as]
  gitlab:uploads:sanitize:remove_exif[start_id,stop_id,dry_run,sleep_time,uploader,since]
  gitlab:web_hook:add
  gitlab:web_hook:list
  gitlab:web_hook:rm
  gitlab:workhorse:install[dir,repo]
  gitlab:x509:update_signatures
  grape:path_helpers
  grape:routes
  hipchat:send[message]
  import:github[token,gitlab_username,project_path]
  initializers
  jira:generate_consumer_key
  jira:generate_public_cert
  log:clear
  metrics:setup_common_metrics
  middleware
  migrate_iids
  notes
  postgresql_md5_hash
  restart
  routes
  runner
  secret
  secrets:edit
  secrets:setup
  secrets:show
  setup
  stats
  test:db
  time:zones[country_or_offset]
  tmp:clear
  tmp:create
  tokens:reset_all_email
  tokens:reset_all_feed
  version
  webpack:compile
  yarn
  yarn:available
  yarn:check
  yarn:clobber
  yarn:install
  zeitwerk:check
</code></pre></div><div id="disqus_thread"></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.ab354e0d.js" defer></script><script src="/docs/assets/js/2.19baf9f4.js" defer></script><script src="/docs/assets/js/248.7deda9d9.js" defer></script><script src="/docs/assets/js/11.0d0890d4.js" defer></script>
  </body>
</html>
