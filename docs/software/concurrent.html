<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机基础教程</title>
    <meta name="description" content="软件开发教程，渗透测试入门教程，区块链入门教程，物联网，大数据">
    
    
    <link rel="preload" href="/docs/assets/css/0.styles.89d6372f.css" as="style"><link rel="preload" href="/docs/assets/js/app.29ff0b7c.js" as="script"><link rel="preload" href="/docs/assets/js/2.5d2fca3b.js" as="script"><link rel="preload" href="/docs/assets/js/16.02796dd1.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.a3d9f22d.js"><link rel="prefetch" href="/docs/assets/js/11.e0500c71.js"><link rel="prefetch" href="/docs/assets/js/12.c896a5d2.js"><link rel="prefetch" href="/docs/assets/js/13.a7da030f.js"><link rel="prefetch" href="/docs/assets/js/14.dfb8774d.js"><link rel="prefetch" href="/docs/assets/js/15.ba78e759.js"><link rel="prefetch" href="/docs/assets/js/17.b3642104.js"><link rel="prefetch" href="/docs/assets/js/18.c0a689f9.js"><link rel="prefetch" href="/docs/assets/js/19.ad88f0d8.js"><link rel="prefetch" href="/docs/assets/js/20.23f09e2f.js"><link rel="prefetch" href="/docs/assets/js/21.07751ec3.js"><link rel="prefetch" href="/docs/assets/js/22.a8c65525.js"><link rel="prefetch" href="/docs/assets/js/23.b96532cf.js"><link rel="prefetch" href="/docs/assets/js/24.93ef2325.js"><link rel="prefetch" href="/docs/assets/js/3.a282e63f.js"><link rel="prefetch" href="/docs/assets/js/4.6b1b1ab7.js"><link rel="prefetch" href="/docs/assets/js/5.15cc1684.js"><link rel="prefetch" href="/docs/assets/js/6.dc2d61b1.js"><link rel="prefetch" href="/docs/assets/js/7.2674f001.js"><link rel="prefetch" href="/docs/assets/js/8.162adf02.js"><link rel="prefetch" href="/docs/assets/js/9.2f2e60aa.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.89d6372f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">计算机基础教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">机器指令</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">软件基础</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">渗透测试</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">区块链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">机器指令</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">软件基础</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">渗透测试</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">区块链</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/software/concurrent.html#_1-数据库database-isolation" class="sidebar-link">1. 数据库Database Isolation</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/concurrent.html#_2-应用层面的高并发" class="sidebar-link">2. 应用层面的高并发</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="/docs/software">回目录</a>  《concurrent》</p> <p>concurrent control或者并发控制是关乎系统的consistency一致性，
最直接的想法是先来后到，但是先来后到也有问题，先来的可能做了一系列的读写操作，后到的就要一直等着吗，显然这种处理很粗暴，
所以对于单机系统来说，比如数据库，一般都是通过隔离水平isolation level来控制不同的粒度；
对于分布式系统来说，不同的产品的promise和guarantee也是不同的，比如zookeeper通过ZAP协议保证顺序一致性sequential consistency，但是zookeeper并不保证每个客户端看到的东西是一致的，
这个可以看我的zookeeper讲解，再比如kafka提供了exactly once的语义，意思是不会重复或丢失消息，但是也是取决于client的实现，实际项目中因为会涉及到跟其他产品比如数据库交互，
其实从业务角度或者项目角度是难以实现exactly once的，所以要分清产品本身（server端和client端）能做到什么，以及结合到实际项目中又是会如何；</p> <p>另外关于并发的一个误区：handle并发并不一定需要多线程，比如nodejs，redis都是单线程处理的，原理就算通过event loop</p> <h2 id="_1-数据库database-isolation"><a href="#_1-数据库database-isolation" class="header-anchor">#</a> 1. 数据库Database Isolation</h2> <p>Isolation (database systems) https://en.wikipedia.org/wiki/Isolation_(database_systems)#Read_committed</p> <p>幻读</p> <p>解决办法：整个区间加锁</p> <p><img src="/docs/docs_image/software/concurrent/concurrent_db01.png" alt=""></p> <p>不可重复读</p> <p>解决办法： 记录级别加锁 select for update</p> <p><img src="/docs/docs_image/software/concurrent/concurrent_db02.png" alt=""></p> <p>脏读取</p> <p>解决办法：commit之后才生效</p> <p><img src="/docs/docs_image/software/concurrent/concurrent_db03.png" alt=""></p> <p>Common scenarios</p> <ol><li>no matter what the db level lock settings, it’s better to add extra lock when doing transaction update</li></ol> <p><img src="/docs/docs_image/software/concurrent/concurrent_db04.png" alt=""></p> <ol start="2"><li>‘duplicate’ issue</li></ol> <p>这里只举例一个用户手快点了多次的情况（真实发生过），解决方法是不要在function或者存储过程中生成id，而是从外部传入；
不过如果发生另外一个极端情况，不同用户同一时刻注册相同用户名，则需要另想办法，因为这样的话id肯定不同，username又不是主键不会冲突，
所以要么从username生成id，比如hash运算，要么去掉username的概念，只允许手机号或者邮箱注册；</p> <p><img src="/docs/docs_image/software/concurrent/concurrent_db05.png" alt=""></p> <h2 id="_2-应用层面的高并发"><a href="#_2-应用层面的高并发" class="header-anchor">#</a> 2. 应用层面的高并发</h2> <p>采用FIFO排队方式来处理高并发，额外的好处：解耦了消息的生产者和消费者，生产者负责把消息放到队列尾部，消费者则从队列头拉取消息进行处理，
由于解耦了生产者和消费者，互相就不需要等待对方处理，所以是异步操作，生产者不需要等待消费者处理某条消息的结果；</p> <p>如果有同步需求怎么办，比如有些场景生产者还是要等待消费者处理结果才能进入下一步的，
这种完全可以拆解成消费者处理完之后将处理之后的结果放入另一个队列，然后生产者再作为消费者去消费这个队列即可，
然后可以对刚才这个过程做一个封装，将第二个队列的生产消费做成回调，就可以做成同步请求，比如类似：</p> <div class="language- extra-class"><pre class="language-text"><code>producer1.sendTransaction({from: '0x123...', data: '0x432...'})
.on('confirmation', function(confNumber, receipt){ //回调 })
.on('error', function(error){ ... })
.then(function(receipt){
});
</code></pre></div><p>java sdk默认提供了非线程安全的队列和线程安全的队列，实际项目多涉及到多线程，所以我们只说后者，线程安全队列又分为两类队列:</p> <ul><li><p>无界的队列
不用锁的队列：LinkedTransferQueue，ConcurrentLinkedQueue，由于无界，所以有内存溢出的风险</p></li> <li><p>有界队列
加锁的队列： ArrayBlockingQueue，LinkedBlockingQueue，但是有锁就有阻塞，所以性能会比较低</p></li></ul> <p>但是，
要处理高并发，肯定要考虑性能，有没有性能高即无锁non-blocking并且有界的队列呢，LMAX开发的Disruptor就是这么一个无锁高性能有界循环队列，</p> <p>“It ensures that any data is owned by only one thread for write access, therefore reducing write contention compared to other structures.”</p> <p>现在Disruptor已经成为很多交易所的基础框架一部分，<a href="https://github.com/LMAX-Exchange/disruptor/wiki/Performance-Results" target="_blank" rel="noopener noreferrer">性能对比参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
可以看到越来越多的框架集成了disruptor队列，比如log4j，storm，solr
https://mvnrepository.com/artifact/com.lmax/disruptor/3.2.1/usages
https://mvnrepository.com/artifact/com.lmax/disruptor/3.4.0/usages</p> <hr> <p>ref:</p> <p><a href="https://juejin.im/post/5b5f10d65188251ad06b78e3" target="_blank" rel="noopener noreferrer">你应该知道的高性能无锁队列Disruptor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.29ff0b7c.js" defer></script><script src="/docs/assets/js/2.5d2fca3b.js" defer></script><script src="/docs/assets/js/16.02796dd1.js" defer></script>
  </body>
</html>
