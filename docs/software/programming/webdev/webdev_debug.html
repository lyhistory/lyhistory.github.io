<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Basics | 计算机基础教程</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9742852210287449" crossorigin="anonymous"></script>
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=AW-748196294"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());
		  
		  gtag('config', 'AW-748196294');
        </script>
    <script>
			(function() { // DON'T EDIT BELOW THIS LINE
			
			})();
		 </script>
    <meta name="description" content="软件开发教程，白帽黑客入门教程，区块链入门教程，物联网，大数据">
    
    <link rel="preload" href="/docs/assets/css/0.styles.d4eb5ad8.css" as="style"><link rel="preload" href="/docs/assets/js/app.b1bf34a2.js" as="script"><link rel="preload" href="/docs/assets/js/2.4a937564.js" as="script"><link rel="preload" href="/docs/assets/js/366.fbea0b09.js" as="script"><link rel="preload" href="/docs/assets/js/8.3332a15d.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.d1e42af3.js"><link rel="prefetch" href="/docs/assets/js/100.185ec455.js"><link rel="prefetch" href="/docs/assets/js/101.12755cd2.js"><link rel="prefetch" href="/docs/assets/js/102.418ff6a0.js"><link rel="prefetch" href="/docs/assets/js/103.77ac07cd.js"><link rel="prefetch" href="/docs/assets/js/104.afd61ee2.js"><link rel="prefetch" href="/docs/assets/js/105.54726470.js"><link rel="prefetch" href="/docs/assets/js/106.50df33fb.js"><link rel="prefetch" href="/docs/assets/js/107.eba50c1a.js"><link rel="prefetch" href="/docs/assets/js/108.cadb4431.js"><link rel="prefetch" href="/docs/assets/js/109.7caef29b.js"><link rel="prefetch" href="/docs/assets/js/11.41c54743.js"><link rel="prefetch" href="/docs/assets/js/110.a3854711.js"><link rel="prefetch" href="/docs/assets/js/111.662b6dc7.js"><link rel="prefetch" href="/docs/assets/js/112.da30ea79.js"><link rel="prefetch" href="/docs/assets/js/113.50153a29.js"><link rel="prefetch" href="/docs/assets/js/114.ca67ed80.js"><link rel="prefetch" href="/docs/assets/js/115.c44cf017.js"><link rel="prefetch" href="/docs/assets/js/116.9936d6bb.js"><link rel="prefetch" href="/docs/assets/js/117.0b8cadf9.js"><link rel="prefetch" href="/docs/assets/js/118.a11573eb.js"><link rel="prefetch" href="/docs/assets/js/119.a165afc0.js"><link rel="prefetch" href="/docs/assets/js/12.5ff3d2c0.js"><link rel="prefetch" href="/docs/assets/js/120.a143fdcc.js"><link rel="prefetch" href="/docs/assets/js/121.342c67bc.js"><link rel="prefetch" href="/docs/assets/js/122.2dc476b4.js"><link rel="prefetch" href="/docs/assets/js/123.df3edd7a.js"><link rel="prefetch" href="/docs/assets/js/124.baa662de.js"><link rel="prefetch" href="/docs/assets/js/125.837999d3.js"><link rel="prefetch" href="/docs/assets/js/126.094afe4c.js"><link rel="prefetch" href="/docs/assets/js/127.b692e798.js"><link rel="prefetch" href="/docs/assets/js/128.8e4f9682.js"><link rel="prefetch" href="/docs/assets/js/129.2c1a32ae.js"><link rel="prefetch" href="/docs/assets/js/13.89bdd26d.js"><link rel="prefetch" href="/docs/assets/js/130.cb334463.js"><link rel="prefetch" href="/docs/assets/js/131.c2b2909d.js"><link rel="prefetch" href="/docs/assets/js/132.20b389c4.js"><link rel="prefetch" href="/docs/assets/js/133.b28f0c69.js"><link rel="prefetch" href="/docs/assets/js/134.97ce3845.js"><link rel="prefetch" href="/docs/assets/js/135.042718c4.js"><link rel="prefetch" href="/docs/assets/js/136.c4ed5bbd.js"><link rel="prefetch" href="/docs/assets/js/137.be76b29c.js"><link rel="prefetch" href="/docs/assets/js/138.902f803f.js"><link rel="prefetch" href="/docs/assets/js/139.d7fb60bf.js"><link rel="prefetch" href="/docs/assets/js/14.7d58f647.js"><link rel="prefetch" href="/docs/assets/js/140.3e32eb07.js"><link rel="prefetch" href="/docs/assets/js/141.153e663e.js"><link rel="prefetch" href="/docs/assets/js/142.189b7491.js"><link rel="prefetch" href="/docs/assets/js/143.23c787cc.js"><link rel="prefetch" href="/docs/assets/js/144.be75e713.js"><link rel="prefetch" href="/docs/assets/js/145.263baea3.js"><link rel="prefetch" href="/docs/assets/js/146.257c6dd2.js"><link rel="prefetch" href="/docs/assets/js/147.33586383.js"><link rel="prefetch" href="/docs/assets/js/148.cefc4da5.js"><link rel="prefetch" href="/docs/assets/js/149.661ead50.js"><link rel="prefetch" href="/docs/assets/js/15.abce9a2f.js"><link rel="prefetch" href="/docs/assets/js/150.e80da84b.js"><link rel="prefetch" href="/docs/assets/js/151.ef6efc34.js"><link rel="prefetch" href="/docs/assets/js/152.22f6ba25.js"><link rel="prefetch" href="/docs/assets/js/153.b4541894.js"><link rel="prefetch" href="/docs/assets/js/154.e778a072.js"><link rel="prefetch" href="/docs/assets/js/155.f18223c5.js"><link rel="prefetch" href="/docs/assets/js/156.4d8c9a65.js"><link rel="prefetch" href="/docs/assets/js/157.f3cf89fd.js"><link rel="prefetch" href="/docs/assets/js/158.68c62a9b.js"><link rel="prefetch" href="/docs/assets/js/159.a9779b77.js"><link rel="prefetch" href="/docs/assets/js/16.80197d60.js"><link rel="prefetch" href="/docs/assets/js/160.264c8898.js"><link rel="prefetch" href="/docs/assets/js/161.ff112ec2.js"><link rel="prefetch" href="/docs/assets/js/162.ff2b3dd2.js"><link rel="prefetch" href="/docs/assets/js/163.2e336713.js"><link rel="prefetch" href="/docs/assets/js/164.54c16ab8.js"><link rel="prefetch" href="/docs/assets/js/165.4365ce01.js"><link rel="prefetch" href="/docs/assets/js/166.736ab932.js"><link rel="prefetch" href="/docs/assets/js/167.f50178e6.js"><link rel="prefetch" href="/docs/assets/js/168.1695994b.js"><link rel="prefetch" href="/docs/assets/js/169.16ca550c.js"><link rel="prefetch" href="/docs/assets/js/17.dec1660c.js"><link rel="prefetch" href="/docs/assets/js/170.39da2ebe.js"><link rel="prefetch" href="/docs/assets/js/171.d16d2f65.js"><link rel="prefetch" href="/docs/assets/js/172.7dd4863c.js"><link rel="prefetch" href="/docs/assets/js/173.5bf0ac81.js"><link rel="prefetch" href="/docs/assets/js/174.7327d5b2.js"><link rel="prefetch" href="/docs/assets/js/175.9e9302b5.js"><link rel="prefetch" href="/docs/assets/js/176.37cee48d.js"><link rel="prefetch" href="/docs/assets/js/177.054542cf.js"><link rel="prefetch" href="/docs/assets/js/178.2a0c4478.js"><link rel="prefetch" href="/docs/assets/js/179.c775ffcc.js"><link rel="prefetch" href="/docs/assets/js/18.a986a350.js"><link rel="prefetch" href="/docs/assets/js/180.64c40261.js"><link rel="prefetch" href="/docs/assets/js/181.05b26b15.js"><link rel="prefetch" href="/docs/assets/js/182.be2d8fcc.js"><link rel="prefetch" href="/docs/assets/js/183.e4944ab3.js"><link rel="prefetch" href="/docs/assets/js/184.c68fb003.js"><link rel="prefetch" href="/docs/assets/js/185.676db306.js"><link rel="prefetch" href="/docs/assets/js/186.c618a573.js"><link rel="prefetch" href="/docs/assets/js/187.5d9d9fc8.js"><link rel="prefetch" href="/docs/assets/js/188.47e20952.js"><link rel="prefetch" href="/docs/assets/js/189.9ccabc3e.js"><link rel="prefetch" href="/docs/assets/js/19.35f1b06c.js"><link rel="prefetch" href="/docs/assets/js/190.bbb8188f.js"><link rel="prefetch" href="/docs/assets/js/191.798a36d1.js"><link rel="prefetch" href="/docs/assets/js/192.c0108936.js"><link rel="prefetch" href="/docs/assets/js/193.f180287d.js"><link rel="prefetch" href="/docs/assets/js/194.a592bb2f.js"><link rel="prefetch" href="/docs/assets/js/195.423b5158.js"><link rel="prefetch" href="/docs/assets/js/196.2d5523ac.js"><link rel="prefetch" href="/docs/assets/js/197.b0cb0a5c.js"><link rel="prefetch" href="/docs/assets/js/198.a2521425.js"><link rel="prefetch" href="/docs/assets/js/199.59633faf.js"><link rel="prefetch" href="/docs/assets/js/20.cf4e0f3e.js"><link rel="prefetch" href="/docs/assets/js/200.49850f3c.js"><link rel="prefetch" href="/docs/assets/js/201.557da22f.js"><link rel="prefetch" href="/docs/assets/js/202.9a892d1a.js"><link rel="prefetch" href="/docs/assets/js/203.b326bfc1.js"><link rel="prefetch" href="/docs/assets/js/204.c27a5233.js"><link rel="prefetch" href="/docs/assets/js/205.2371cbeb.js"><link rel="prefetch" href="/docs/assets/js/206.21bec72c.js"><link rel="prefetch" href="/docs/assets/js/207.1e0cd7dc.js"><link rel="prefetch" href="/docs/assets/js/208.ac7d626f.js"><link rel="prefetch" href="/docs/assets/js/209.35aad234.js"><link rel="prefetch" href="/docs/assets/js/21.5ab2cf7f.js"><link rel="prefetch" href="/docs/assets/js/210.b3702588.js"><link rel="prefetch" href="/docs/assets/js/211.8ed7cd1f.js"><link rel="prefetch" href="/docs/assets/js/212.5c289f2d.js"><link rel="prefetch" href="/docs/assets/js/213.e19dc017.js"><link rel="prefetch" href="/docs/assets/js/214.825bbef2.js"><link rel="prefetch" href="/docs/assets/js/215.bfd65f7e.js"><link rel="prefetch" href="/docs/assets/js/216.1cf75f9d.js"><link rel="prefetch" href="/docs/assets/js/217.5b0fda5a.js"><link rel="prefetch" href="/docs/assets/js/218.308b8d12.js"><link rel="prefetch" href="/docs/assets/js/219.aed51681.js"><link rel="prefetch" href="/docs/assets/js/22.c16a33e2.js"><link rel="prefetch" href="/docs/assets/js/220.503ffcf4.js"><link rel="prefetch" href="/docs/assets/js/221.43587250.js"><link rel="prefetch" href="/docs/assets/js/222.312c986f.js"><link rel="prefetch" href="/docs/assets/js/223.f81becc1.js"><link rel="prefetch" href="/docs/assets/js/224.29542885.js"><link rel="prefetch" href="/docs/assets/js/225.92e6b2d7.js"><link rel="prefetch" href="/docs/assets/js/226.41c01db8.js"><link rel="prefetch" href="/docs/assets/js/227.30884dce.js"><link rel="prefetch" href="/docs/assets/js/228.56f186b0.js"><link rel="prefetch" href="/docs/assets/js/229.1d4b547d.js"><link rel="prefetch" href="/docs/assets/js/23.19f40a5d.js"><link rel="prefetch" href="/docs/assets/js/230.73e24c9e.js"><link rel="prefetch" href="/docs/assets/js/231.6ce3abae.js"><link rel="prefetch" href="/docs/assets/js/232.d0769ddf.js"><link rel="prefetch" href="/docs/assets/js/233.61321307.js"><link rel="prefetch" href="/docs/assets/js/234.9d63aa79.js"><link rel="prefetch" href="/docs/assets/js/235.e373a300.js"><link rel="prefetch" href="/docs/assets/js/236.71671cae.js"><link rel="prefetch" href="/docs/assets/js/237.7bd4a115.js"><link rel="prefetch" href="/docs/assets/js/238.cf539a23.js"><link rel="prefetch" href="/docs/assets/js/239.97752df6.js"><link rel="prefetch" href="/docs/assets/js/24.4d3069fe.js"><link rel="prefetch" href="/docs/assets/js/240.2c54972d.js"><link rel="prefetch" href="/docs/assets/js/241.2afabc1c.js"><link rel="prefetch" href="/docs/assets/js/242.3d2a4fc0.js"><link rel="prefetch" href="/docs/assets/js/243.d6b11e72.js"><link rel="prefetch" href="/docs/assets/js/244.a7037abb.js"><link rel="prefetch" href="/docs/assets/js/245.e9c88222.js"><link rel="prefetch" href="/docs/assets/js/246.af585373.js"><link rel="prefetch" href="/docs/assets/js/247.51c0ffc4.js"><link rel="prefetch" href="/docs/assets/js/248.fd9cbb6c.js"><link rel="prefetch" href="/docs/assets/js/249.22d2e0b0.js"><link rel="prefetch" href="/docs/assets/js/25.21056638.js"><link rel="prefetch" href="/docs/assets/js/250.90b9c218.js"><link rel="prefetch" href="/docs/assets/js/251.0dcdee90.js"><link rel="prefetch" href="/docs/assets/js/252.2f00ded3.js"><link rel="prefetch" href="/docs/assets/js/253.eaf92331.js"><link rel="prefetch" href="/docs/assets/js/254.3b4c457a.js"><link rel="prefetch" href="/docs/assets/js/255.b13277d7.js"><link rel="prefetch" href="/docs/assets/js/256.a0e5ccd6.js"><link rel="prefetch" href="/docs/assets/js/257.c45210f6.js"><link rel="prefetch" href="/docs/assets/js/258.a057793e.js"><link rel="prefetch" href="/docs/assets/js/259.4daab500.js"><link rel="prefetch" href="/docs/assets/js/26.4439630f.js"><link rel="prefetch" href="/docs/assets/js/260.998ca341.js"><link rel="prefetch" href="/docs/assets/js/261.7b77ed6b.js"><link rel="prefetch" href="/docs/assets/js/262.e1d66e35.js"><link rel="prefetch" href="/docs/assets/js/263.be7884fa.js"><link rel="prefetch" href="/docs/assets/js/264.9cfa9624.js"><link rel="prefetch" href="/docs/assets/js/265.8a73d692.js"><link rel="prefetch" href="/docs/assets/js/266.29d87906.js"><link rel="prefetch" href="/docs/assets/js/267.03f5ec39.js"><link rel="prefetch" href="/docs/assets/js/268.dd1ae140.js"><link rel="prefetch" href="/docs/assets/js/269.4928a852.js"><link rel="prefetch" href="/docs/assets/js/27.8073d61f.js"><link rel="prefetch" href="/docs/assets/js/270.0af66dfa.js"><link rel="prefetch" href="/docs/assets/js/271.1d42d169.js"><link rel="prefetch" href="/docs/assets/js/272.5a8f15e0.js"><link rel="prefetch" href="/docs/assets/js/273.e67564e4.js"><link rel="prefetch" href="/docs/assets/js/274.3fb3fb1e.js"><link rel="prefetch" href="/docs/assets/js/275.9d215a44.js"><link rel="prefetch" href="/docs/assets/js/276.06802a22.js"><link rel="prefetch" href="/docs/assets/js/277.82e3ae0c.js"><link rel="prefetch" href="/docs/assets/js/278.0f421ebf.js"><link rel="prefetch" href="/docs/assets/js/279.abfecac5.js"><link rel="prefetch" href="/docs/assets/js/28.10c12b7b.js"><link rel="prefetch" href="/docs/assets/js/280.c83442dc.js"><link rel="prefetch" href="/docs/assets/js/281.8dbaf8fc.js"><link rel="prefetch" href="/docs/assets/js/282.1fda705d.js"><link rel="prefetch" href="/docs/assets/js/283.bf2071b9.js"><link rel="prefetch" href="/docs/assets/js/284.d6a71854.js"><link rel="prefetch" href="/docs/assets/js/285.3e9a36e0.js"><link rel="prefetch" href="/docs/assets/js/286.af6a1966.js"><link rel="prefetch" href="/docs/assets/js/287.86f5d226.js"><link rel="prefetch" href="/docs/assets/js/288.05a22a1c.js"><link rel="prefetch" href="/docs/assets/js/289.90efae5f.js"><link rel="prefetch" href="/docs/assets/js/29.c3fa61fc.js"><link rel="prefetch" href="/docs/assets/js/290.533ec4ca.js"><link rel="prefetch" href="/docs/assets/js/291.bf0808ef.js"><link rel="prefetch" href="/docs/assets/js/292.a4f763a8.js"><link rel="prefetch" href="/docs/assets/js/293.e95b5bbf.js"><link rel="prefetch" href="/docs/assets/js/294.7e5188b2.js"><link rel="prefetch" href="/docs/assets/js/295.aab49905.js"><link rel="prefetch" href="/docs/assets/js/296.004e5d55.js"><link rel="prefetch" href="/docs/assets/js/297.136a3c59.js"><link rel="prefetch" href="/docs/assets/js/298.0e8b70da.js"><link rel="prefetch" href="/docs/assets/js/299.e630d16d.js"><link rel="prefetch" href="/docs/assets/js/3.95af5bd2.js"><link rel="prefetch" href="/docs/assets/js/30.dcd572f8.js"><link rel="prefetch" href="/docs/assets/js/300.1af65494.js"><link rel="prefetch" href="/docs/assets/js/301.c9b9c725.js"><link rel="prefetch" href="/docs/assets/js/302.0de2d0ed.js"><link rel="prefetch" href="/docs/assets/js/303.c592130f.js"><link rel="prefetch" href="/docs/assets/js/304.1d54ea9a.js"><link rel="prefetch" href="/docs/assets/js/305.b2173548.js"><link rel="prefetch" href="/docs/assets/js/306.f038e30f.js"><link rel="prefetch" href="/docs/assets/js/307.b856e410.js"><link rel="prefetch" href="/docs/assets/js/308.d19d1b61.js"><link rel="prefetch" href="/docs/assets/js/309.ff43d897.js"><link rel="prefetch" href="/docs/assets/js/31.21f65554.js"><link rel="prefetch" href="/docs/assets/js/310.cb419561.js"><link rel="prefetch" href="/docs/assets/js/311.c4f0f0db.js"><link rel="prefetch" href="/docs/assets/js/312.753003d2.js"><link rel="prefetch" href="/docs/assets/js/313.9f593c32.js"><link rel="prefetch" href="/docs/assets/js/314.530f37fa.js"><link rel="prefetch" href="/docs/assets/js/315.427f50cb.js"><link rel="prefetch" href="/docs/assets/js/316.88d1003a.js"><link rel="prefetch" href="/docs/assets/js/317.fb97df77.js"><link rel="prefetch" href="/docs/assets/js/318.d6f4dada.js"><link rel="prefetch" href="/docs/assets/js/319.a4ec735b.js"><link rel="prefetch" href="/docs/assets/js/32.0afb307f.js"><link rel="prefetch" href="/docs/assets/js/320.7fb2dee1.js"><link rel="prefetch" href="/docs/assets/js/321.ec963236.js"><link rel="prefetch" href="/docs/assets/js/322.805b2185.js"><link rel="prefetch" href="/docs/assets/js/323.6d733d42.js"><link rel="prefetch" href="/docs/assets/js/324.ad69584d.js"><link rel="prefetch" href="/docs/assets/js/325.87440cae.js"><link rel="prefetch" href="/docs/assets/js/326.65655251.js"><link rel="prefetch" href="/docs/assets/js/327.37ce0117.js"><link rel="prefetch" href="/docs/assets/js/328.1cbf48e8.js"><link rel="prefetch" href="/docs/assets/js/329.adb2a9a8.js"><link rel="prefetch" href="/docs/assets/js/33.260f6baa.js"><link rel="prefetch" href="/docs/assets/js/330.eea3dfa3.js"><link rel="prefetch" href="/docs/assets/js/331.9038aca1.js"><link rel="prefetch" href="/docs/assets/js/332.6d9652f9.js"><link rel="prefetch" href="/docs/assets/js/333.98f84e1f.js"><link rel="prefetch" href="/docs/assets/js/334.ce9ce8ed.js"><link rel="prefetch" href="/docs/assets/js/335.415d458a.js"><link rel="prefetch" href="/docs/assets/js/336.238b371d.js"><link rel="prefetch" href="/docs/assets/js/337.d2ccc686.js"><link rel="prefetch" href="/docs/assets/js/338.294b2b2d.js"><link rel="prefetch" href="/docs/assets/js/339.d227608c.js"><link rel="prefetch" href="/docs/assets/js/34.dc73aa14.js"><link rel="prefetch" href="/docs/assets/js/340.ffbfa0c4.js"><link rel="prefetch" href="/docs/assets/js/341.0703f8a3.js"><link rel="prefetch" href="/docs/assets/js/342.4880584a.js"><link rel="prefetch" href="/docs/assets/js/343.5dc177a1.js"><link rel="prefetch" href="/docs/assets/js/344.edb7ed6c.js"><link rel="prefetch" href="/docs/assets/js/345.5a263270.js"><link rel="prefetch" href="/docs/assets/js/346.1c79819c.js"><link rel="prefetch" href="/docs/assets/js/347.7316cbb3.js"><link rel="prefetch" href="/docs/assets/js/348.f43d5b61.js"><link rel="prefetch" href="/docs/assets/js/349.aa3efaaf.js"><link rel="prefetch" href="/docs/assets/js/35.c5bfd085.js"><link rel="prefetch" href="/docs/assets/js/350.c1845bcc.js"><link rel="prefetch" href="/docs/assets/js/351.070150bd.js"><link rel="prefetch" href="/docs/assets/js/352.2ede8165.js"><link rel="prefetch" href="/docs/assets/js/353.5aab5b0d.js"><link rel="prefetch" href="/docs/assets/js/354.d6e8c42e.js"><link rel="prefetch" href="/docs/assets/js/355.36f6d8ec.js"><link rel="prefetch" href="/docs/assets/js/356.ce965997.js"><link rel="prefetch" href="/docs/assets/js/357.9c64432d.js"><link rel="prefetch" href="/docs/assets/js/358.aaf55e5f.js"><link rel="prefetch" href="/docs/assets/js/359.516a16cc.js"><link rel="prefetch" href="/docs/assets/js/36.13965ab7.js"><link rel="prefetch" href="/docs/assets/js/360.53ea66ff.js"><link rel="prefetch" href="/docs/assets/js/361.b607a879.js"><link rel="prefetch" href="/docs/assets/js/362.e173bca1.js"><link rel="prefetch" href="/docs/assets/js/363.dd1f89d3.js"><link rel="prefetch" href="/docs/assets/js/364.8e8db0c9.js"><link rel="prefetch" href="/docs/assets/js/365.a642e668.js"><link rel="prefetch" href="/docs/assets/js/367.1ed06b6a.js"><link rel="prefetch" href="/docs/assets/js/368.8c99abb4.js"><link rel="prefetch" href="/docs/assets/js/369.42b4ff1a.js"><link rel="prefetch" href="/docs/assets/js/37.52e121bb.js"><link rel="prefetch" href="/docs/assets/js/370.796bd734.js"><link rel="prefetch" href="/docs/assets/js/371.8316589f.js"><link rel="prefetch" href="/docs/assets/js/372.d721dc09.js"><link rel="prefetch" href="/docs/assets/js/373.bc6fba30.js"><link rel="prefetch" href="/docs/assets/js/374.e31dbce6.js"><link rel="prefetch" href="/docs/assets/js/375.aab167ec.js"><link rel="prefetch" href="/docs/assets/js/376.7c5b778d.js"><link rel="prefetch" href="/docs/assets/js/377.2747a438.js"><link rel="prefetch" href="/docs/assets/js/378.786875e0.js"><link rel="prefetch" href="/docs/assets/js/379.e922b675.js"><link rel="prefetch" href="/docs/assets/js/38.9d0bb6cc.js"><link rel="prefetch" href="/docs/assets/js/380.eee5ddd3.js"><link rel="prefetch" href="/docs/assets/js/381.2fc8f2b8.js"><link rel="prefetch" href="/docs/assets/js/382.c238e161.js"><link rel="prefetch" href="/docs/assets/js/383.5488e756.js"><link rel="prefetch" href="/docs/assets/js/384.679b35a1.js"><link rel="prefetch" href="/docs/assets/js/385.effa3f61.js"><link rel="prefetch" href="/docs/assets/js/386.87a50bec.js"><link rel="prefetch" href="/docs/assets/js/387.717c7386.js"><link rel="prefetch" href="/docs/assets/js/388.4f4c40c3.js"><link rel="prefetch" href="/docs/assets/js/389.ac77e394.js"><link rel="prefetch" href="/docs/assets/js/39.c8a3f0f1.js"><link rel="prefetch" href="/docs/assets/js/390.570552dc.js"><link rel="prefetch" href="/docs/assets/js/391.d3059f9f.js"><link rel="prefetch" href="/docs/assets/js/392.431ec61b.js"><link rel="prefetch" href="/docs/assets/js/393.550e8bad.js"><link rel="prefetch" href="/docs/assets/js/394.c364c526.js"><link rel="prefetch" href="/docs/assets/js/395.cb49e571.js"><link rel="prefetch" href="/docs/assets/js/396.e8c15b95.js"><link rel="prefetch" href="/docs/assets/js/397.a781d7db.js"><link rel="prefetch" href="/docs/assets/js/398.f43acd07.js"><link rel="prefetch" href="/docs/assets/js/4.86ff86f0.js"><link rel="prefetch" href="/docs/assets/js/40.67ba9756.js"><link rel="prefetch" href="/docs/assets/js/41.04fdd21c.js"><link rel="prefetch" href="/docs/assets/js/42.e58dc764.js"><link rel="prefetch" href="/docs/assets/js/43.0504ddb6.js"><link rel="prefetch" href="/docs/assets/js/44.95ef23dc.js"><link rel="prefetch" href="/docs/assets/js/45.701d0062.js"><link rel="prefetch" href="/docs/assets/js/46.480724bc.js"><link rel="prefetch" href="/docs/assets/js/47.9e0fff0a.js"><link rel="prefetch" href="/docs/assets/js/48.a9bb3783.js"><link rel="prefetch" href="/docs/assets/js/49.da98c4d5.js"><link rel="prefetch" href="/docs/assets/js/5.dfa4a989.js"><link rel="prefetch" href="/docs/assets/js/50.6c337137.js"><link rel="prefetch" href="/docs/assets/js/51.2548e620.js"><link rel="prefetch" href="/docs/assets/js/52.f5c059de.js"><link rel="prefetch" href="/docs/assets/js/53.43f6bfe2.js"><link rel="prefetch" href="/docs/assets/js/54.ddb0c1d0.js"><link rel="prefetch" href="/docs/assets/js/55.e1dfebff.js"><link rel="prefetch" href="/docs/assets/js/56.a940f529.js"><link rel="prefetch" href="/docs/assets/js/57.c05ec137.js"><link rel="prefetch" href="/docs/assets/js/58.2504f591.js"><link rel="prefetch" href="/docs/assets/js/59.3d3fa4df.js"><link rel="prefetch" href="/docs/assets/js/6.9a62797e.js"><link rel="prefetch" href="/docs/assets/js/60.5f61d524.js"><link rel="prefetch" href="/docs/assets/js/61.6cc20f14.js"><link rel="prefetch" href="/docs/assets/js/62.fdd9588c.js"><link rel="prefetch" href="/docs/assets/js/63.bc70fb6c.js"><link rel="prefetch" href="/docs/assets/js/64.aea5d235.js"><link rel="prefetch" href="/docs/assets/js/65.72752c72.js"><link rel="prefetch" href="/docs/assets/js/66.7bcf1545.js"><link rel="prefetch" href="/docs/assets/js/67.96b1301d.js"><link rel="prefetch" href="/docs/assets/js/68.8182c82f.js"><link rel="prefetch" href="/docs/assets/js/69.674011dc.js"><link rel="prefetch" href="/docs/assets/js/7.c85f1b98.js"><link rel="prefetch" href="/docs/assets/js/70.9cf23ebf.js"><link rel="prefetch" href="/docs/assets/js/71.2474ae7c.js"><link rel="prefetch" href="/docs/assets/js/72.ca7426ab.js"><link rel="prefetch" href="/docs/assets/js/73.17096933.js"><link rel="prefetch" href="/docs/assets/js/74.c81cd146.js"><link rel="prefetch" href="/docs/assets/js/75.5a3970b9.js"><link rel="prefetch" href="/docs/assets/js/76.d234f606.js"><link rel="prefetch" href="/docs/assets/js/77.ede69ccf.js"><link rel="prefetch" href="/docs/assets/js/78.2c3b04fc.js"><link rel="prefetch" href="/docs/assets/js/79.2f2e43ad.js"><link rel="prefetch" href="/docs/assets/js/80.217e6425.js"><link rel="prefetch" href="/docs/assets/js/81.64a0110c.js"><link rel="prefetch" href="/docs/assets/js/82.41b9e7c8.js"><link rel="prefetch" href="/docs/assets/js/83.ab7c3fa2.js"><link rel="prefetch" href="/docs/assets/js/84.4446666a.js"><link rel="prefetch" href="/docs/assets/js/85.d8f7cc0a.js"><link rel="prefetch" href="/docs/assets/js/86.8e78d819.js"><link rel="prefetch" href="/docs/assets/js/87.d9ff37ac.js"><link rel="prefetch" href="/docs/assets/js/88.02d4c108.js"><link rel="prefetch" href="/docs/assets/js/89.fda6d30e.js"><link rel="prefetch" href="/docs/assets/js/9.aad60b88.js"><link rel="prefetch" href="/docs/assets/js/90.36473ff3.js"><link rel="prefetch" href="/docs/assets/js/91.a61c667a.js"><link rel="prefetch" href="/docs/assets/js/92.05a895ac.js"><link rel="prefetch" href="/docs/assets/js/93.d2ca569e.js"><link rel="prefetch" href="/docs/assets/js/94.3a839556.js"><link rel="prefetch" href="/docs/assets/js/95.ac080d55.js"><link rel="prefetch" href="/docs/assets/js/96.1a18ee2f.js"><link rel="prefetch" href="/docs/assets/js/97.cace9a8a.js"><link rel="prefetch" href="/docs/assets/js/98.9b1f533f.js"><link rel="prefetch" href="/docs/assets/js/99.bfd6f083.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.d4eb5ad8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">计算机基础教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  机器指令
</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link router-link-active">
  软件基础
</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link">
  白帽黑客
</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">
  区块链
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Basics</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/software/programming/webdev/webdev_debug.html#basics" class="sidebar-link">Basics</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#ttfb" class="sidebar-link">TTFB</a></li></ul></li><li><a href="/docs/software/programming/webdev/webdev_debug.html#web容器" class="sidebar-link">web容器：</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/software/programming/webdev/webdev_debug.html#工具" class="sidebar-link">工具</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#html" class="sidebar-link">html</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#network" class="sidebar-link">network</a></li></ul></li><li><a href="/docs/software/programming/webdev/webdev_debug.html#troubleshooting" class="sidebar-link">Troubleshooting</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#dns-issues" class="sidebar-link">DNS issues</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#内部dns解析" class="sidebar-link" style="padding-left:3rem;">内部dns解析</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#http-proxy代理" class="sidebar-link" style="padding-left:3rem;">http proxy代理</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#windows上常见问题" class="sidebar-link" style="padding-left:3rem;">windows上常见问题</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#waf-issues" class="sidebar-link">Waf issues</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#performance-issue" class="sidebar-link">Performance issue</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#website-calling-another-api-server" class="sidebar-link" style="padding-left:3rem;">website calling another api server</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#_301-auto-redirect-x-redirect-by" class="sidebar-link">301 auto redirect - X-Redirect-By</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#auto-follow-redirection-3xx" class="sidebar-link">Auto follow redirection (3xx)</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#调查" class="sidebar-link" style="padding-left:3rem;">调查：</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#验证" class="sidebar-link" style="padding-left:3rem;">验证：</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#重现" class="sidebar-link" style="padding-left:3rem;">重现：</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#根源-root-cause" class="sidebar-link" style="padding-left:3rem;">根源 root cause：</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#wordpress-upload-failed-empty-response" class="sidebar-link">wordpress upload failed empty response</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#初步观察" class="sidebar-link" style="padding-left:3rem;">初步观察</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#firefox下面" class="sidebar-link" style="padding-left:4rem;">firefox下面：</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#chrome" class="sidebar-link" style="padding-left:4rem;">chrome：</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#问题梳理" class="sidebar-link" style="padding-left:3rem;">问题梳理</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#websocket-issues" class="sidebar-link">websocket issues</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#websocket-connection-issue" class="sidebar-link" style="padding-left:3rem;">websocket connection issue</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#websocket-301" class="sidebar-link" style="padding-left:3rem;">websocket 301</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#webscoket-failed-switch-protocol-lost-upgrade-header" class="sidebar-link" style="padding-left:3rem;">webscoket failed switch Protocol/lost upgrade header</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#nginx-location-proxy-pass-404" class="sidebar-link">nginx location proxy_pass 404</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#java-io-ioexception-connection-reset-by-peer" class="sidebar-link">java.io.IOException: Connection reset by peer</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#clientabortexception-broken-pipe" class="sidebar-link">ClientAbortException - Broken pipe</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#clientabortexception-connection-reset-by-peer" class="sidebar-link">ClientAbortException - Connection reset by peer</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#延伸-前面是服务端报错-还有客户端报错的场景-client-side-reset-by-peer" class="sidebar-link" style="padding-left:3rem;">延伸：前面是服务端报错，还有客户端报错的场景 client side reset by peer</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#延伸2-fix-server-reset-by-peer" class="sidebar-link" style="padding-left:3rem;">延伸2：fix server: reset by peer</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#请求大量数据时返回截断中断-net-err-incomplete-chunked-encoding" class="sidebar-link">请求大量数据时返回截断中断 net::ERRINCOMPLETECHUNKED_ENCODING</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#浏览器-》cdn-》waf地址池-》防火墙-只开放访问给waf地址池-》elb-elb-公网地址eip-nat-内网elb-ip-》源服务器-nginx反向代理-proxy-pass-to-upstream" class="sidebar-link" style="padding-left:3rem;">浏览器=》cdn=》waf地址池=》防火墙（只开放访问给waf地址池）=》elb(elb 公网地址eip=&gt;NAT=&gt;内网elb ip)=》源服务器(nginx反向代理-&gt;proxy_pass to upstream)，</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#浏览器-》源服务器-nginx反向代理-proxy-pass-to-upstream" class="sidebar-link" style="padding-left:3rem;">浏览器=》源服务器(nginx反向代理-&gt;proxy_pass to upstream)</a></li><li class="sidebar-sub-header"><a href="/docs/software/programming/webdev/webdev_debug.html#根源-root-cause-2" class="sidebar-link" style="padding-left:3rem;">根源 root cause</a></li></ul></li><li><a href="/docs/software/programming/webdev/webdev_debug.html#cors问题" class="sidebar-link">CORS问题</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="basics"><a href="#basics" class="header-anchor">#</a> Basics</h2> <h3 id="ttfb"><a href="#ttfb" class="header-anchor">#</a> TTFB</h3> <p>time to first byte
https://web.dev/ttfb/</p> <p><img src="/docs/docs_image/software/programming/web/network_request_phase.png" alt=""></p> <h2 id="web容器"><a href="#web容器" class="header-anchor">#</a> web容器：</h2> <p>tomcat</p> <p>apache</p> <p>iis</p> <p>nginx</p> <p>phpstudy</p> <h2 id="工具"><a href="#工具" class="header-anchor">#</a> 工具</h2> <h3 id="html"><a href="#html" class="header-anchor">#</a> html</h3> <p>inspect on disappering element，有些元素是鼠标mouse hover才显示，所以直接用开发者工具inspect是不行的，
需要在相关的parent上面右键设置一个Break on-&gt;subtree modifications</p> <h3 id="network"><a href="#network" class="header-anchor">#</a> network</h3> <p>network-&gt; right click on requests -&gt; Copy -&gt; Copy as Curl(bash)</p> <p>chrome:
chrome://net-export/
https://netlog-viewer.appspot.com/#sockets
https://chromium.googlesource.com/chromium/src/+/HEAD/net/docs/crash-course-in-net-internals.md
https://zhuanlan.zhihu.com/p/266622278</p> <p>firefox:
web developer tool-&gt;performance-&gt;recording
https://firefox-source-docs.mozilla.org/networking/http/logging.html
about:networking#logging</p> <p>When Mozilla’s built-in logging capabilities aren’t good enough, and you need a full-fledged packet tracing tool, two free products are <a href="https://www.wireshark.org/" target="_blank" rel="noopener noreferrer">Wireshark<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://github.com/jpr5/ngrep/" target="_blank" rel="noopener noreferrer">ngrep<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="troubleshooting"><a href="#troubleshooting" class="header-anchor">#</a> Troubleshooting</h2> <h3 id="dns-issues"><a href="#dns-issues" class="header-anchor">#</a> DNS issues</h3> <h4 id="内部dns解析"><a href="#内部dns解析" class="header-anchor">#</a> 内部dns解析</h4> <p>同事访问网站 A.COM 显示白页，通过google capture network traffic工具发现包括main.js在内的resource都出现
net_error=-118(ERR_CONNECTION_TIMED_OUT)
这些js和css无法加载造成白页问题，
然后注意到这些resource对应的域名是另一个子域名sub.A.COM,
所以nslookup一下，发现我们内网自己的dns解析器</p> <div class="language- extra-class"><pre class="language-text"><code>&gt;nslookup sub.A.COM
Server:  UnKnown
Address:  172.31.200.1

Non-authoritative answer:
DNS request timed out.
    timeout was 2 seconds.
Name:    XXX.global.cdnhwcuwd107.cn
Address:  62.0.58.94
Aliases:  sub.A.COM
          sub.A.COM.0c91a5b4.c.cdnhwc1.com
</code></pre></div><p>timeout并且解析到了一个不是我们所在地区的国家</p> <p>更换dns服务器即可</p> <h4 id="http-proxy代理"><a href="#http-proxy代理" class="header-anchor">#</a> http proxy代理</h4> <p>报错 connect 503 error</p> <p>telnet example.com 443 是通的，并且显示的ip是对的</p> <p>不过curl -v https://example.com 解析出来的ip却是不同的，
发现 /etc/profile 里面有 http_proxy设置</p> <h4 id="windows上常见问题"><a href="#windows上常见问题" class="header-anchor">#</a> windows上常见问题</h4> <p>代理软件自动设置了dns；
系统proxy没有清理干净；
浏览器插件（比如国内翻国外或者国外反向翻国内或者一些location伪造插件）；</p> <h3 id="waf-issues"><a href="#waf-issues" class="header-anchor">#</a> Waf issues</h3> <p>表现：公司内部访问公司网站随机被屏蔽</p> <p>原因：waf设置了频率过快会被屏蔽，但是问题是公司网站在云上，而公司的公网IP只有一个，所以所有人的访问被看作是同一个人的攻击</p> <p>解决：IP白名单</p> <h3 id="performance-issue"><a href="#performance-issue" class="header-anchor">#</a> Performance issue</h3> <h4 id="website-calling-another-api-server"><a href="#website-calling-another-api-server" class="header-anchor">#</a> website calling another api server</h4> <p>表现为：网站页面显示从api获取的数据很慢，内网访问ttfb半分钟，外网访问直接timeout</p> <p>分别从网站服务器和api服务器本身测试，不是网站服务器和api服务器之间的网络问题，确实是api服务器的问题：
time_starttransfer - time_appconnect is practically the same as Time To First Byte (TTFB)</p> <div class="language- extra-class"><pre class="language-text"><code>vim curl-format.txt
{\n
&quot;time_redirect&quot;: %{time_redirect},\n
&quot;time_namelookup&quot;: %{time_namelookup},\n
&quot;time_connect&quot;: %{time_connect},\n
&quot;time_appconnect&quot;: %{time_appconnect},\n
&quot;time_pretransfer&quot;: %{time_pretransfer},\n
&quot;time_starttransfer&quot;: %{time_starttransfer},\n
&quot;time_total&quot;: %{time_total},\n
&quot;size_request&quot;: %{size_request},\n
&quot;size_upload&quot;: %{size_upload},\n
&quot;size_download&quot;: %{size_download},\n
&quot;size_header&quot;: %{size_header}\n
}

    
curl -v -w &quot;@curl-format.txt&quot; -H &quot;Connection: close&quot; http://X.X.X.X/api/call
</code></pre></div><h3 id="_301-auto-redirect-x-redirect-by"><a href="#_301-auto-redirect-x-redirect-by" class="header-anchor">#</a> 301 auto redirect - X-Redirect-By</h3> <p>事件：dev.site.com 总是自动跳转到www.site.com</p> <p>初步整个服务器上grep -r -l &quot;www.site.com&quot; / 没有结果</p> <p>1.通过nslookup查看了cname，确定没有cname重定向</p> <p>2.查看了apache配置</p> <div class="language- extra-class"><pre class="language-text"><code>vim /etc/httpd/conf/httpd.conf 
vim /etc/httpd/conf.d/demo_http.conf 
vim /etc/httpd/conf.d/demo_https.conf
</code></pre></div><p>确定没有重定向，唯一的重定向是http里面有到https的重定向，不过测试的时候完全可以直接访问
https://dev.site.com 来排除http重定向的问题，依然自动跳转</p> <p>3.怀疑是代码问题，此站点使用的是WordPress代码，备份删除整站代码，创建 index.html: hello world，</p> <p>发现访问https://dev.site.com/index.html不跳转，访问https://dev.site.com依然跳转，</p> <p>刚开始我因此排除了是代码问题，其实301跳转有缓存，此时的跳转是</p> <p>后来才发现network里面这个301 Moved Permanently 是from disk cache！！！</p> <p>清理缓存后（或者浏览器开发者工具，直接勾选Disable cache更容易），再访问https://dev.site.com，发现response如下：</p> <div class="language- extra-class"><pre class="language-text"><code>
HTTP/1.1 301 Moved Permanently
Date: Thu, 28 Oct 2021 07:31:15 GMT
Server: Apache
X-Redirect-By: Polylang
Location: https://www.xxx.com/
X-Content-Type-Options: nosniff
X-XSS-Protection: 1; mode=block
Content-Length: 0
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=UTF-8

</code></pre></div><p>注意到X-Redirect-By: Polylang，就是这个鬼，wordpress一个插件，最后查明原因是，dev的db配置成了生产的，所以估计这个polylang就使用了生产的域名！</p> <h3 id="auto-follow-redirection-3xx"><a href="#auto-follow-redirection-3xx" class="header-anchor">#</a> Auto follow redirection (3xx)</h3> <p>起因：</p> <p>一个java程序使用spring web client RestTemplate 访问华为云上的elb url:
http://api.lyhistory.com/api/v1/testit/
，华为云上配置elb的策略是自动转到https即
https://api.lyhistory.com/api/v1/testit/</p> <p>程序报错：</p> <div class="language- extra-class"><pre class="language-text"><code>2022-10-14 18:45:58.891 ERROR 1540GG [scheduling-1] c.q.c.m.s.i.xxx : Failed to query xxx. Error:Could not extract response: no suitable HttpMessageConverter found for response type [class com.lyhistory.testmodel] and content type [text/html]

</code></pre></div><h4 id="调查"><a href="#调查" class="header-anchor">#</a> 调查：</h4> <div class="language- extra-class"><pre class="language-text"><code>
正常应该是返回json，而不是text/html

curl一下试试

curl --header &quot;Authorization: XXXXXX&quot; http://api.lyhistory.com/api/v1/testit/

返回  301 Moved Permanently

加上auto follow redirection：
curl -L --header &quot;Authorization: XXXXXX&quot; http://api.lyhistory.com/api/v1/testit/
则返回正常！


使用hackbar测试华为云看看chrome network的请求长啥样

get

1st request:
&gt;
GET /api/v1/testit/ HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.115 Safari/537.36

&lt;
HTTP/1.1 307 Internal Redirect
Location: https://api.lyhistory.com/api/v1/testit/
Cross-Origin-Resource-Policy: Cross-Origin
Non-Authoritative-Reason: HSTS


2nd request:
&gt;
GET /api/v1/testit/ HTTP/1.1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Connection: keep-alive
Host: api.lyhistory.com
If-None-Match: W/&quot;1ff-0SzbxxK5OAa9GvtZs8XPKShpiHo&quot;
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: cross-site
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.115 Safari/537.36
authorization: XXXXXX
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;102&quot;, &quot;Google Chrome&quot;;v=&quot;102&quot;
sec-ch-ua-mobile: ?0
sec-ch-ua-platform: &quot;Windows&quot;

&lt;
HTTP/1.1 200 OK
Date: Fri, 14 Oct 2022 10:37:49 GMT
Content-Type: application/json; charset=utf-8
Content-Length: 511
Connection: keep-alive
Access-Control-Allow-Origin: *
X-RateLimit-Limit: 360
X-RateLimit-Remaining: 359
X-RateLimit-Reset: 1665759419
Content-Security-Policy: default-src 'self';base-uri 'self';block-all-mixed-content;font-src 'self' https: data:;frame-ancestors 'self';img-src 'self' data:;object-src 'none';script-src 'self';script-src-attr 'none';style-src 'self' https: 'unsafe-inline';upgrade-insecure-requests
X-DNS-Prefetch-Control: off
Expect-CT: max-age=0
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=15552000; includeSubDomains
X-Download-Options: noopen
X-Content-Type-Options: nosniff
X-Permitted-Cross-Domain-Policies: none
Referrer-Policy: no-referrer
X-XSS-Protection: 0
ETag: W/&quot;1ff-gghi4jHEutMe/7viD10y38cnRdU&quot;
Server: elb

</code></pre></div><p>学习：HSTS 307 internal redirect:
The HTTP 307 Internal Redirect response is a variant of the 307 Temporary Redirect status code. It’s not defined by the HTTP standard and is just a local browser implementation.
302 to 307:https://rtfm.co.ua/en/http-redirects-post-and-get-requests-and-lost-data/
https://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/
https://kinsta.com/knowledgebase/307-redirect/#understanding-http-307-internal-redirect-for-httpsonly-sites
Spring的RestTemplate自动重定向，如何拿到重定向后的地址？ https://blog.csdn.net/m0_37657841/article/details/107391699</p> <p>看起来华为云elb http to https跳转没有问题，只要正常follow redirect就可以，看来我们的java程序RestTemplate应该是没有自动follow redirect所以得到了第一次返回的redirection的html响应结果，</p> <h4 id="验证"><a href="#验证" class="header-anchor">#</a> 验证：</h4> <div class="language- extra-class"><pre class="language-text"><code>刚开始使用
java -Djavax.net.debug=all jarfile 
但是奇怪并没有额外输出http connection的信息？

只好用strace抓一下
strace -o strace.out -s 4096 -e trace=network -f -p &lt;PID&gt;


11937 accept(30,  &lt;unfinished ...&gt;
11938 socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 38
11938 connect(38, {sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr(&quot;x.x.x.x&quot;)}, 16) = 0
11938 getsockname(38, {sa_family=AF_INET, sin_port=htons(42404), sin_addr=inet_addr(&quot;10.20.1.101&quot;)}, [16]) = 0
11938 setsockopt(38, SOL_TCP, TCP_NODELAY, [1], 4) = 0
11938 sendto(38, &quot;GET /api/v1/testit/ HTTP/1.1\r\nAccept: application/json, application/*+json\r\nAuthorization: XXXXXX\r\nUser-Agent: Java/1.8.0_40\r\nHost: api.lyhistory.com\r\nConnection: keep-alive\r\n\r\n&quot;, 215, 0, NULL, 0) = 215
11938 recvfrom(38, &quot;HTTP/1.1 301 Moved Permanently\r\nDate: Fri, 14 Oct 2022 01:40:00 GMT\r\nContent-Type: text/html\r\nContent-Length: 134\r\nConnection: keep-alive\r\nLocation: https://api.lyhistory.com:443/api/v1/testit/\r\nServer: elb\r\n\r\n&lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&quot;, 8192, 0, NULL, NULL) = 360
14483 +++ exited with 0 +++

果然是 301 Moved Permanently
</code></pre></div><h4 id="重现"><a href="#重现" class="header-anchor">#</a> 重现：</h4> <p>本地暂时没法访问云上资源，直接本地用nginx模拟：</p> <div class="language- extra-class"><pre class="language-text"><code>
server {
        listen       80;
        server_name  test.local;
        return 307 https://$host$request_uri;
    }
server {
		underscores_in_headers on;
		#listen       80;
        listen 443 ssl;
        server_name  test.local;

		add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains&quot; always;
		add_header Access-Control-Allow-Headers Authorization;
		
        ssl_certificate clear-selfsigned.crt;
        ssl_certificate_key clear-selfsigned.key;
		
        location /test{
			default_type application/json;
			return 200 '{&quot;success&quot;:&quot;true&quot;,&quot;error&quot;:&quot;hello world&quot;}';
		}
}

使用hackerbar对比一下华为云elb：
get http://test.local/test

1st request:
&gt;
GET /test HTTP/1.1
Host: test.local
Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
test: 111222333
authorization: B873PGZRZK4MVWGVKZ8HQHMTB92K

&lt;
HTTP/1.1 307 Temporary Redirect
Server: nginx/1.17.6
Date: Fri, 14 Oct 2022 10:33:54 GMT
Content-Type: text/html
Content-Length: 171
Connection: keep-alive
Location: https://test.local/test

2nd request:
&gt;
GET /test HTTP/1.1
Host: test.local
Connection: keep-alive
Pragma: no-cache
Cache-Control: no-cache
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: cross-site
Sec-Fetch-Mode: navigate
Sec-Fetch-Dest: document
sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;90&quot;, &quot;Google Chrome&quot;;v=&quot;90&quot;
sec-ch-ua-mobile: ?0
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9

&lt;
HTTP/1.1 200 OK
Server: nginx/1.17.6
Date: Fri, 14 Oct 2022 10:33:54 GMT
Content-Type: application/json
Content-Length: 40
Connection: keep-alive
Strict-Transport-Security: max-age=31536000; includeSubDomains
Access-Control-Allow-Headers: Authorization


</code></pre></div><p>然后本地启动java程序，可以重现出那个错误！</p> <p>但是调试过程，发现 RestTempate默认的factory本身就是默认 auto follow redirect</p> <div class="language- extra-class"><pre class="language-text"><code>public boolean getInstanceFollowRedirects() {
         return instanceFollowRedirects;
     }
instanceFollowRedirects=true
</code></pre></div><p>那为什么没有跳转呢，其实重现的时候，只要一步步调试就可以看到这个code
sun.net.www.protocol.http.HttpURLConnection</p> <div class="language- extra-class"><pre class="language-text"><code>if (!this.url.getProtocol().equalsIgnoreCase(var3.getProtocol())) {
/* 2625 */                      return false;
/*      */ 
/*      */                   }
</code></pre></div><p>对比了当前协议和跳转的协议，不同就直接返回！</p> <h4 id="根源-root-cause"><a href="#根源-root-cause" class="header-anchor">#</a> 根源 root cause：</h4> <p>&quot;After discussion among Java Networking engineers, it is felt that we shouldn't automatically follow redirect from one protocol to another, for instance, from http to https and vise versa, doing so may have serious security consequences. Thus the fix is to return the server responses for redirect. Check response code and Location header field value for redirect information. It's the application's responsibility to follow the redirect.&quot;
-- https://bugs.openjdk.org/browse/JDK-8190312
-- https://stackoverflow.com/questions/1884230/httpurlconnection-doesnt-follow-redirect-from-http-to-https</p> <p>调查中还发现nginx模拟的时候第二次请求的authorization header自动被抹掉了，debug Rest Template才发现这段代码
sun.net.www.protocol.http.HttpURLConnection</p> <div class="language- extra-class"><pre class="language-text"><code>if (!this.isUserProxyAuth) {
/* 1686 */                         this.requests.remove(&quot;Proxy-Authorization&quot;);
/*      */                      }
</code></pre></div><p>nginx redirect 跳转不能带原有的header（安全问题），只能走反向代理才可以
https://segmentfault.com/q/1010000011377374
https://www.reddit.com/r/nginx/comments/ox1vfb/missing_headers_after_redirect/</p> <h3 id="wordpress-upload-failed-empty-response"><a href="#wordpress-upload-failed-empty-response" class="header-anchor">#</a> wordpress upload failed empty response</h3> <p>描述：</p> <p>wordpress media上传，<strong>开发环境</strong>没有问题，<strong>生产production</strong>上却失败，大小3m也不是很大，</p> <p>/wp-admin/async-upload.php</p> <h4 id="初步观察"><a href="#初步观察" class="header-anchor">#</a> 初步观察</h4> <h5 id="firefox下面"><a href="#firefox下面" class="header-anchor">#</a> firefox下面：</h5> <p>Queued: 21.50 s	Started: 1.60 m	inDownloaded: 2.88 min
Request Timing
Blocked:
1.25 min
DNS Resolution:
0 ms
Connecting:
64 ms
TLS Setup:
69 ms
Sending:
1.27 min
Waiting:
0 ms
Receiving:
0 ms</p> <p>可以发现Blocked时间很长（后面才知道是因为经过waf过滤才导致的）
https://developer.mozilla.org/en-US/docs/Tools/Network_Monitor/request_details#Timings
Blocked解释：
Time spent in a queue waiting for a network connection.</p> <p>The browser imposes a limit on the number of simultaneous connections that can be made to a single server. In Firefox this defaults to 6, but can be changed using the network.http.max-persistent-connections-per-server preference. If all connections are in use, the browser can't download more resources until a connection is released.</p> <p>http://kb.mozillazine.org/Network.http.max-persistent-connections-per-server</p> <p>http://kb.mozillazine.org/Editing_configuration</p> <p>修改（先不要随便修改）：访问 about:config 搜索 Network.http.max-persistent-connections-per-server</p> <h5 id="chrome"><a href="#chrome" class="header-anchor">#</a> chrome：</h5> <p>跟firefox稍有不同，
首先在status一列可以看到 (failed) net::ERR_EMPTY_RESPONSE 在network timing里面看到 stalled</p> <p>搜索这两个关键词无果：</p> <p>https://stackoverflow.com/questions/66036116/wordpress-err-empty-response-on-long-content</p> <p>https://stackoverflow.com/questions/27740692/request-stalled-for-a-long-time-occasionally-in-chrome</p> <p>注意力回到timing解释</p> <p>https://developer.chrome.com/docs/devtools/network/reference/#timing-explanation</p> <p>Queueing. The browser queues requests when:
There are higher priority requests.
There are already six TCP connections open for this origin, which is the limit. Applies to HTTP/1.0 and HTTP/1.1 only.
The browser is briefly allocating space in the disk cache
Stalled. The request could be stalled for any of the reasons described in Queueing.
这里也提到了6个TCP连接的限制</p> <p>Firefox和chrome都可以在network列名上右键添加 Protocol，从而确认确实是HTTP1.1，然后chrome还可以添加 connection id</p> <p>下面这个解释很有帮助</p> <blockquote><p><em>Note 2: If a TCP handshake was needed for a HTTP request, you'll see an orange bar in the DevTools waterfall and, if you hover over it, you'll see &quot;Initial connection&quot; - this tells you how long the handshake took in milliseconds. TCP connections may be reused across tabs and windows so watch out -- you might see an ID for the first time but it may not have a TCP handshake! This likely because you visited the page previously and opened a connection with that host. It may also be because Chrome prefetched a resource from the host -- Chrome prefetches a favicon for example when you type an address in the bar.</em></p> <p>https://stackoverflow.com/questions/34184994/chrome-developer-tools-connection-id</p></blockquote> <p>下面可以排除前面 https://stackoverflow.com/questions/27740692/request-stalled-for-a-long-time-occasionally-in-chrome</p> <p>提到的 <strong>persistent TCP connection</strong>的原因</p> <p>chrome://net-export/</p> <p>https://netlog-viewer.appspot.com/#import</p> <div class="language- extra-class"><pre class="language-text"><code>t=35069 [st=    0] +REQUEST_ALIVE  [dt=34115]
                    --&gt; priority = &quot;MEDIUM&quot;
                    --&gt; traffic_annotation = 101845102
                    --&gt; url = &quot;https://www.xxx.com/wp-admin/async-upload.php&quot;
t=35069 [st=    0]    DELEGATE_INFO  [dt=108]
                      --&gt; delegate_blocked_by = &quot;Opening Files&quot;
t=35177 [st=  108]    NETWORK_DELEGATE_BEFORE_URL_REQUEST  [dt=0]
t=35177 [st=  108]   +URL_REQUEST_START_JOB  [dt=34006]
                      --&gt; initiator = &quot;https://www.xxx.com&quot;
                      --&gt; load_flags = 2 (BYPASS_CACHE)
                      --&gt; method = &quot;POST&quot;
                      --&gt; network_isolation_key = &quot;https://xxx.com https://xxx.com&quot;
                      --&gt; privacy_mode = &quot;disabled&quot;
                      --&gt; request_type = &quot;other&quot;
                      --&gt; site_for_cookies = &quot;SiteForCookies: {site=https://xxx.com; schemefully_same=true}&quot;
                      --&gt; upload_id = &quot;0&quot;
                      --&gt; url = &quot;https://www.xxx.com/wp-admin/async-upload.php&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      COOKIE_INCLUSION_STATUS
                        --&gt; operation = &quot;send&quot;
                        --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=35177 [st=  108]      NETWORK_DELEGATE_BEFORE_START_TRANSACTION  [dt=0]
t=35177 [st=  108]      HTTP_CACHE_GET_BACKEND  [dt=0]
建立连接HTTP_STREAM_JOB_CONTROLLER和HTTP_STREAM_JOB
t=35177 [st=  108]     +HTTP_STREAM_REQUEST  [dt=3]
t=35177 [st=  108]        HTTP_STREAM_JOB_CONTROLLER_BOUND
                          --&gt; source_dependency = 1174836 (HTTP_STREAM_JOB_CONTROLLER)
t=35180 [st=  111]        HTTP_STREAM_REQUEST_BOUND_TO_JOB
                          --&gt; source_dependency = 1174837 (HTTP_STREAM_JOB)
t=35180 [st=  111]     -HTTP_STREAM_REQUEST
t=35181 [st=  112]      UPLOAD_DATA_STREAM_INIT  [dt=0]
                        --&gt; is_chunked = false
                        --&gt; net_error = 0 (?)
                        --&gt; total_size = 3505027
t=35181 [st=  112]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=6769]
t=35181 [st=  112]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS
                          --&gt; POST /wp-admin/async-upload.php HTTP/1.1
                              Host: www.xxx.com
                              Connection: keep-alive
                              Content-Length: 3505027
                              Pragma: no-cache
                              Cache-Control: no-cache
                              sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;90&quot;, &quot;Google Chrome&quot;;v=&quot;90&quot;
                              sec-ch-ua-mobile: ?0
                              User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36
                              Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryZinpNBEkQJmJWpBq
                              Accept: */*
                              Origin: https://www.xxx.com
                              Sec-Fetch-Site: same-origin
                              Sec-Fetch-Mode: cors
                              Sec-Fetch-Dest: empty
                              Referer: https://www.xxx.com/wp-admin/upload.php
                              Accept-Encoding: gzip, deflate, br
                              Accept-Language: en-US,en;q=0.9
                              Cookie: [717 bytes were stripped]
t=35181 [st=  112]        HTTP_TRANSACTION_SEND_REQUEST_BODY
                          --&gt; did_merge = false
                          --&gt; is_chunked = false
                          --&gt; length = 3505027
开始上传                          
t=35181 [st=  112]        UPLOAD_DATA_STREAM_READ  [dt=0]
                          --&gt; current_position = 0
t=35182 [st=  113]        UPLOAD_DATA_STREAM_READ  [dt=0]
                          --&gt; current_position = 16384
..............
t=41949 [st= 6880]        UPLOAD_DATA_STREAM_READ  [dt=1]
                          --&gt; current_position = 3505027
上传失败 net_error = -100，但是注意此时current_position = 3505027===length = 3505027
耗时
t = 41950-35181=6769
st = 6881-112=6769
大概6秒
t=41950 [st= 6881]     -HTTP_TRANSACTION_SEND_REQUEST
t=41950 [st= 6881]     +HTTP_TRANSACTION_READ_HEADERS  [dt=10169]
t=41950 [st= 6881]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=10168]
                          --&gt; net_error = -100 (ERR_CONNECTION_CLOSED)
t=52118 [st=17049]        HTTP_TRANSACTION_RESTART_AFTER_ERROR
                          --&gt; net_error = -100 (ERR_CONNECTION_CLOSED)
chrome发起重试                          
t=52119 [st=17050]     -HTTP_TRANSACTION_READ_HEADERS
t=52119 [st=17050]     +HTTP_STREAM_REQUEST  [dt=399]
建立连接HTTP_STREAM_JOB_CONTROLLER和HTTP_STREAM_JOB
t=52119 [st=17050]        HTTP_STREAM_JOB_CONTROLLER_BOUND
                          --&gt; source_dependency = 1174847 (HTTP_STREAM_JOB_CONTROLLER)
t=52518 [st=17449]        HTTP_STREAM_REQUEST_BOUND_TO_JOB
                          --&gt; source_dependency = 1174848 (HTTP_STREAM_JOB)
t=52518 [st=17449]     -HTTP_STREAM_REQUEST
t=52518 [st=17449]      UPLOAD_DATA_STREAM_INIT  [dt=0]
                        --&gt; is_chunked = false
                        --&gt; net_error = 0 (?)
                        --&gt; total_size = 3505027
t=52518 [st=17449]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=6530]
t=52518 [st=17449]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS
                          --&gt; POST /wp-admin/async-upload.php HTTP/1.1
                              Host: www.xxx.com
                              Connection: keep-alive
                              Content-Length: 3505027
                              Pragma: no-cache
                              Cache-Control: no-cache
                              sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;90&quot;, &quot;Google Chrome&quot;;v=&quot;90&quot;
                              sec-ch-ua-mobile: ?0
                              User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36
                              Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryZinpNBEkQJmJWpBq
                              Accept: */*
                              Origin: https://www.xxx.com
                              Sec-Fetch-Site: same-origin
                              Sec-Fetch-Mode: cors
                              Sec-Fetch-Dest: empty
                              Referer: https://www.xxx.com/wp-admin/upload.php
                              Accept-Encoding: gzip, deflate, br
                              Accept-Language: en-US,en;q=0.9
                              Cookie: [717 bytes were stripped]
t=52518 [st=17449]        HTTP_TRANSACTION_SEND_REQUEST_BODY
                          --&gt; did_merge = false
                          --&gt; is_chunked = false
                          --&gt; length = 3505027
t=52518 [st=17449]        UPLOAD_DATA_STREAM_READ  [dt=0]
                          --&gt; current_position = 0
..............
又是上传完了但是另外一个错误 net_error = -324
t=59048 [st=23979]        UPLOAD_DATA_STREAM_READ  [dt=0]
                          --&gt; current_position = 3505027
t=59048 [st=23979]     -HTTP_TRANSACTION_SEND_REQUEST
t=59048 [st=23979]     +HTTP_TRANSACTION_READ_HEADERS  [dt=10135]
t=59048 [st=23979]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=10135]
                          --&gt; net_error = -324 (ERR_EMPTY_RESPONSE)
t=69183 [st=34114]     -HTTP_TRANSACTION_READ_HEADERS
                        --&gt; net_error = -324 (ERR_EMPTY_RESPONSE)
t=69183 [st=34114]   -URL_REQUEST_START_JOB
                      --&gt; net_error = -324 (ERR_EMPTY_RESPONSE)
t=69183 [st=34114]    URL_REQUEST_DELEGATE_RESPONSE_STARTED  [dt=0]
t=69184 [st=34115] -REQUEST_ALIVE
                    --&gt; net_error = -324 (ERR_EMPTY_RESPONSE)
                    
看下：HTTP_STREAM_JOB_CONTROLLER和HTTP_STREAM_JOB     
初次是
t=35177 [st=  108]        HTTP_STREAM_JOB_CONTROLLER_BOUND
                          --&gt; source_dependency = 1174836 (HTTP_STREAM_JOB_CONTROLLER)
t=35180 [st=  111]        HTTP_STREAM_REQUEST_BOUND_TO_JOB
                          --&gt; source_dependency = 1174837 (HTTP_STREAM_JOB)
1174836：
1174836: HTTP_STREAM_JOB_CONTROLLER
https://www.xxx.com/wp-admin/async-upload.php
Start Time: 2021-11-29 17:25:53.321

t=35177 [st=0] +HTTP_STREAM_JOB_CONTROLLER  [dt=4]
                --&gt; is_preconnect = false
                --&gt; url = &quot;https://www.xxx.com/wp-admin/async-upload.php&quot;
t=35177 [st=0]    HTTP_STREAM_JOB_CONTROLLER_BOUND
                  --&gt; source_dependency = 1174835 (URL_REQUEST)
t=35177 [st=0]   +PROXY_RESOLUTION_SERVICE  [dt=3]
t=35178 [st=1]     +HOST_RESOLVER_IMPL_REQUEST  [dt=0]
                    --&gt; allow_cached_response = true
                    --&gt; dns_query_type = 1
                    --&gt; host = &quot;www.xxx.com:0&quot;
                    --&gt; is_speculative = false
                    --&gt; network_isolation_key = &quot;null null&quot;
t=35178 [st=1]        HOST_RESOLVER_IMPL_CACHE_HIT
                      --&gt; addresses = [&quot;18.140.49.179&quot;,&quot;203.205.159.22&quot;,&quot;150.109.90.80&quot;,&quot;54.254.71.41&quot;,&quot;54.254.112.6&quot;,&quot;13.251.21.164&quot;]
                      --&gt; expiration = &quot;13282651581632397&quot;
t=35178 [st=1]        HOST_RESOLVER_IMPL_CACHE_HIT
                      --&gt; addresses = [&quot;18.140.49.179&quot;,&quot;203.205.159.22&quot;,&quot;150.109.90.80&quot;,&quot;54.254.71.41&quot;,&quot;54.254.112.6&quot;,&quot;13.251.21.164&quot;]
                      --&gt; expiration = &quot;13282651581632397&quot;
t=35178 [st=1]     -HOST_RESOLVER_IMPL_REQUEST
t=35180 [st=3]      PROXY_RESOLUTION_SERVICE_RESOLVED_PROXY_LIST
                    --&gt; pac_string = &quot;PROXY 172.16.101.100:8080&quot;
t=35180 [st=3]   -PROXY_RESOLUTION_SERVICE
t=35180 [st=3]    HTTP_STREAM_JOB_CONTROLLER_PROXY_SERVER_RESOLVED
                  --&gt; proxy_server = &quot;PROXY 172.16.101.100:8080&quot;
t=35180 [st=3]    HTTP_STREAM_REQUEST_STARTED_JOB
                  --&gt; source_dependency = 1174837 (HTTP_STREAM_JOB)
t=35181 [st=4] -HTTP_STREAM_JOB_CONTROLLER

1174837: HTTP_STREAM_JOB
https://www.xxx.com/
Start Time: 2021-11-29 17:25:53.324

t=35180 [st=0] +HTTP_STREAM_JOB  [dt=0]
                --&gt; expect_spdy = false
                --&gt; original_url = &quot;https://www.xxx.com/&quot;
                --&gt; priority = &quot;MEDIUM&quot;
                --&gt; source_dependency = 1174836 (HTTP_STREAM_JOB_CONTROLLER)
                --&gt; url = &quot;https://www.xxx.com/&quot;
                --&gt; using_quic = false
t=35180 [st=0]    HTTP_STREAM_JOB_WAITING  [dt=0]
                  --&gt; should_wait = false
t=35180 [st=0]   +HTTP_STREAM_JOB_INIT_CONNECTION  [dt=0]
t=35180 [st=0]      TCP_CLIENT_SOCKET_POOL_REQUESTED_SOCKET
                    --&gt; group_id = &quot;ssl/www.xxx.com:443&quot;
t=35180 [st=0]     +SOCKET_POOL  [dt=0]
t=35180 [st=0]        SOCKET_POOL_REUSED_AN_EXISTING_SOCKET	#重用persistent TCP connection，所以就排除了最初查到的原因
                      --&gt; idle_ms = 30348
t=35180 [st=0]        SOCKET_POOL_BOUND_TO_SOCKET
                      --&gt; source_dependency = 1174753 (SOCKET)	#注意这里的SOCKET 1174753就是对应的前面说的connectionID
t=35180 [st=0]     -SOCKET_POOL
t=35180 [st=0]   -HTTP_STREAM_JOB_INIT_CONNECTION
t=35180 [st=0]    HTTP_STREAM_REQUEST_PROTO
                  --&gt; proto = &quot;http/1.1&quot;
t=35180 [st=0]    HTTP_STREAM_JOB_BOUND_TO_REQUEST
                  --&gt; source_dependency = 1174835 (URL_REQUEST)
t=35180 [st=0] -HTTP_STREAM_JO
                          
</code></pre></div><p>对比，正常的上传</p> <div class="language- extra-class"><pre class="language-text"><code>1208145: URL_REQUEST
https://xxxx.com/wp-admin/async-upload.php
Start Time: 2021-11-30 14:27:56.488

t=5339 [st=   0] +REQUEST_ALIVE  [dt=1320]
                  --&gt; priority = &quot;MEDIUM&quot;
                  --&gt; traffic_annotation = 101845102
                  --&gt; url = &quot;https://xxxx.com/wp-admin/async-upload.php&quot;
t=5339 [st=   0]    DELEGATE_INFO  [dt=140]
                    --&gt; delegate_blocked_by = &quot;Opening Files&quot;
t=5479 [st= 140]    NETWORK_DELEGATE_BEFORE_URL_REQUEST  [dt=0]
t=5479 [st= 140]   +URL_REQUEST_START_JOB  [dt=1179]
                    --&gt; initiator = &quot;https://www.xxx.com&quot;
                    --&gt; load_flags = 2 (BYPASS_CACHE)
                    --&gt; method = &quot;POST&quot;
                    --&gt; network_isolation_key = &quot;https://xxx.com https://xxx.com&quot;
                    --&gt; privacy_mode = &quot;disabled&quot;
                    --&gt; request_type = &quot;other&quot;
                    --&gt; site_for_cookies = &quot;SiteForCookies: {site=https://xxx.com; schemefully_same=true}&quot;
                    --&gt; upload_id = &quot;0&quot;
                    --&gt; url = &quot;https://www.xxx.com/wp-admin/async-upload.php&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=5479 [st= 140]      NETWORK_DELEGATE_BEFORE_START_TRANSACTION  [dt=0]
t=5479 [st= 140]      HTTP_CACHE_GET_BACKEND  [dt=0]
t=5479 [st= 140]     +HTTP_STREAM_REQUEST  [dt=3]
t=5479 [st= 140]        HTTP_STREAM_JOB_CONTROLLER_BOUND
                        --&gt; source_dependency = 1208146 (HTTP_STREAM_JOB_CONTROLLER)
t=5482 [st= 143]        HTTP_STREAM_REQUEST_BOUND_TO_JOB
                        --&gt; source_dependency = 1208147 (HTTP_STREAM_JOB)
t=5482 [st= 143]     -HTTP_STREAM_REQUEST
t=5482 [st= 143]      UPLOAD_DATA_STREAM_INIT  [dt=0]
                      --&gt; is_chunked = false
                      --&gt; net_error = 0 (?)
                      --&gt; total_size = 4792
t=5482 [st= 143]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=1]
t=5482 [st= 143]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS
                        --&gt; POST /wp-admin/async-upload.php HTTP/1.1
                            Host: www.xxx.com
                            Connection: keep-alive
                            Content-Length: 4792
                            Pragma: no-cache
                            Cache-Control: no-cache
                            sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;90&quot;, &quot;Google Chrome&quot;;v=&quot;90&quot;
                            sec-ch-ua-mobile: ?0
                            User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36
                            Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryHCDeoH2gO9wCcNFe
                            Accept: */*
                            Origin: https://www.xxx.com
                            Sec-Fetch-Site: same-origin
                            Sec-Fetch-Mode: cors
                            Sec-Fetch-Dest: empty
                            Referer: https://www.xxx.com/wp-admin/upload.php
                            Accept-Encoding: gzip, deflate, br
                            Accept-Language: en-US,en;q=0.9
                            Cookie: [717 bytes were stripped]
t=5483 [st= 144]        HTTP_TRANSACTION_SEND_REQUEST_BODY
                        --&gt; did_merge = false
                        --&gt; is_chunked = false
                        --&gt; length = 4792
t=5483 [st= 144]        UPLOAD_DATA_STREAM_READ  [dt=0]
                        --&gt; current_position = 0
t=5483 [st= 144]        UPLOAD_DATA_STREAM_READ  [dt=0]
                        --&gt; current_position = 4792
t=5483 [st= 144]     -HTTP_TRANSACTION_SEND_REQUEST
t=5483 [st= 144]     +HTTP_TRANSACTION_READ_HEADERS  [dt=1175]
t=5483 [st= 144]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=1175]
t=6658 [st=1319]        HTTP_TRANSACTION_READ_RESPONSE_HEADERS
                        --&gt; HTTP/1.1 200 OK
                            Server: nginx
                            Date: Tue, 30 Nov 2021 06:27:57 GMT
                            Content-Type: text/plain; charset=UTF-8
                            Expires: Wed, 11 Jan 1984 05:00:00 GMT
                            X-Frame-Options: SAMEORIGIN
                            Referrer-Policy: strict-origin-when-cross-origin
                            X-Content-Type-Options: nosniff
                            X-WP-Upload-Attachment-ID: 3447
                            X-XSS-Protection: 1; mode=block
                            Strict-Transport-Security: max-age=31536000; includeSubDomains;
                            X-Cache-Lookup: Cache Miss
                            Content-Encoding: gzip
                            Cache-Control: must-revalidate, no-cache, max-age=0
                            Transfer-Encoding: chunked
                            X-NWS-LOG-UUID: 7691670333191889
                            Connection: keep-alive
                            X-Cache-Lookup: Cache Miss
t=6658 [st=1319]     -HTTP_TRANSACTION_READ_HEADERS
t=6658 [st=1319]      NETWORK_DELEGATE_HEADERS_RECEIVED  [dt=0]
t=6658 [st=1319]      URL_REQUEST_FILTERS_SET
                      --&gt; filters = &quot;GZIP&quot;
t=6658 [st=1319]   -URL_REQUEST_START_JOB
t=6658 [st=1319]    URL_REQUEST_DELEGATE_RESPONSE_STARTED  [dt=0]
t=6658 [st=1319]    HTTP_TRANSACTION_READ_BODY  [dt=0]
t=6658 [st=1319]    URL_REQUEST_JOB_BYTES_READ
                    --&gt; byte_count = 845
t=6658 [st=1319]    URL_REQUEST_JOB_FILTERED_BYTES_READ
                    --&gt; byte_count = 1868
t=6659 [st=1320]    HTTP_TRANSACTION_READ_BODY  [dt=0]
t=6659 [st=1320] -REQUEST_ALIVE
</code></pre></div><p>问题的核心在于为什么明明已经上传完成（current_position = 3505027===length = 3505027），但是</p> <p>HTTP_STREAM_PARSER_READ_HEADERS net_error = -100 (ERR_CONNECTION_CLOSED)</p> <p>为什么服务端会关掉？</p> <p>想起来再抓一下dev环境的netlog，发现dev上速度确实快一点，</p> <p>测试了  vim /etc/httpd/conf/httpd.conf	Timeout 以及 vim /etc/opt/rh/rh-php72/php.ini max_execution_time，把这些时间放到3秒都没有问题，前面测试3M文件上传大概6到10秒</p> <p>并且检查了 /.htaccess 都没有问题</p> <p>再查查其他timeout： 搜索apache httpd http connection closed timeout</p> <p>https://httpd.apache.org/docs/2.4/mod/core.html</p> <p>https://www.oreilly.com/library/view/http-the-definitive/1565925092/ch04s07.html</p> <p>换个关键词吧，毕竟是大文件引起的，测试小图标确实上传没问题，搜索 large file ERR_CONNECTION_CLOSED</p> <p>https://stackoverflow.com/questions/53736912/neterr-connection-reset-when-large-file-takes-longer-than-a-minute</p> <p>但是这个答案总感觉有点不太对</p> <div class="language-php extra-class"><pre class="language-php"><code>RequestReadTimeout header<span class="token operator">=</span><span class="token number">20</span><span class="token operator">-</span><span class="token number">40</span><span class="token punctuation">,</span> MinRate<span class="token operator">=</span><span class="token number">500</span> body<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">,</span> MinRate<span class="token operator">=</span><span class="token number">500</span>
https<span class="token punctuation">:</span><span class="token comment">//httpd.apache.org/docs/current/mod/mod_reqtimeout.html</span>
</code></pre></div><p>然后看到另外一个人的回答是因为 ProxyTimeout，回到netlog-viewer：</p> <p>https://netlog-viewer.appspot.com/#sockets</p> <table><thead><tr><th>Name</th> <th>Handed Out</th> <th>Idle</th> <th>Connecting</th> <th>Max</th> <th>Max Per Group</th> <th>Generation</th></tr></thead> <tbody><tr><td>direct:// (transport_socket_pool)</td> <td>0</td> <td><a href="https://netlog-viewer.appspot.com/#events&amp;q=id:1208669,1208667,1208111,1208329" target="_blank" rel="noopener noreferrer">4<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>0</td> <td>256</td> <td>6</td> <td>undefined</td></tr> <tr><td>172.16.101.100:8080 (http_proxy_socket_pool)</td> <td>1</td> <td><a href="https://netlog-viewer.appspot.com/#events&amp;q=id:1203134,1205602,1208691" target="_blank" rel="noopener noreferrer">3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>0</td> <td>32</td> <td>6</td> <td>undefined</td></tr> <tr><td>127.0.0.1:8888 (http_proxy_socket_pool)</td> <td>0</td> <td>0</td> <td>0</td> <td>32</td> <td>6</td> <td>undefined</td></tr></tbody></table> <table><thead><tr><th>direct:// (transport_socket_pool)</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>Name</td> <td>Pending</td> <td>Top Priority</td> <td>Active</td> <td>Idle</td> <td>Connect Jobs</td> <td>Backup Timer</td> <td>Stalled</td></tr> <tr><td>ssl/dev.xxx.com:443</td> <td>0</td> <td>-</td> <td>0</td> <td><a href="https://netlog-viewer.appspot.com/#events&amp;q=id:1208669,1208667" target="_blank" rel="noopener noreferrer">2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>0</td> <td>stopped</td> <td>false</td></tr> <tr><td>ssl/hrs.lyhistory.com:443</td> <td>0</td> <td>-</td> <td>0</td> <td><a href="https://netlog-viewer.appspot.com/#events&amp;q=id:1208111,1208329" target="_blank" rel="noopener noreferrer">2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>0</td> <td>stopped</td> <td>false</td></tr></tbody></table> <table><thead><tr><th>172.16.101.100:8080 (http_proxy_socket_pool)</th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th> <th></th></tr></thead> <tbody><tr><td>Name</td> <td>Pending</td> <td>Top Priority</td> <td>Active</td> <td>Idle</td> <td>Connect Jobs</td> <td>Backup Timer</td> <td>Stalled</td></tr> <tr><td>pm/ssl/sdk.split.io:443</td> <td>0</td> <td>-</td> <td>0</td> <td><a href="https://netlog-viewer.appspot.com/#events&amp;q=id:1203134" target="_blank" rel="noopener noreferrer">1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>0</td> <td>stopped</td> <td>false</td></tr> <tr><td>ssl/d27xxe7juh1us6.cloudfront.net:443</td> <td>0</td> <td>-</td> <td>0</td> <td><a href="https://netlog-viewer.appspot.com/#events&amp;q=id:1205602" target="_blank" rel="noopener noreferrer">1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>0</td> <td>stopped</td> <td>false</td></tr> <tr><td>ssl/www.xxx.com:443</td> <td>0</td> <td>-</td> <td>0</td> <td><a href="https://netlog-viewer.appspot.com/#events&amp;q=id:1208691" target="_blank" rel="noopener noreferrer">1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></td> <td>0</td> <td>stopped</td> <td>false</td></tr> <tr><td>ssl/www.google.com:443</td> <td>0</td> <td>-</td> <td>1</td> <td>0</td> <td>0</td> <td>stopped</td> <td>false</td></tr></tbody></table> <p>可以看到，dev.xxx.com是直接访问的，而www.xxx.com是通过proxy，所以是不是因为这个proxy的原因</p> <h4 id="问题梳理"><a href="#问题梳理" class="header-anchor">#</a> 问题梳理</h4> <p>首先，chrome使用了机器本身设定的proxy，我是公司电脑，连vpn访问网站会经过默认的 proxy server，就是前面的 172.16.101.100，</p> <p>firefox可以设定proxy，然后想起来最初使用firefox测试的时候，设置的是no-proxy，</p> <p>经过一番查找，firefox貌似没有类似chrome的net log viewer，只有个</p> <p>https://firefox-source-docs.mozilla.org/networking/http/logging.html
about:networking#logging</p> <p>然后发现web developer tool下面有个performance capture，用了下，发现</p> <div class="language- extra-class"><pre class="language-text"><code>Status:
Response received
URL:
https://www.xxx.com/wp-admin/async-upload.php
Priority:
Normal(0)
Thread:
Web Content (3/9)
URL:
https://www.xxx.com/wp-admin/upload.php (id: 42949673009)
Waiting for socket thread:
42,476ms
DNS request:
0.27ms
After DNS request:
1.2ms
TCP connection:
22,389ms
After TCP connection:
13ms
Establishing TLS session:
311ms
Waiting for HTTP request:
1,549ms
HTTP request and waiting for response:
14,964ms
HTTP response:
15,294ms
Waiting to transmit the response:
32ms
</code></pre></div><p>Response received显然是不对的，不过下面Waiting for socket thread:42,476ms和TCP connection:22,389ms加起来都超过一分钟了，在about:networking#dns可以看到www.xxx.com解析到了一堆ip，经过询问infra，同事说是waf public ip，所以原来是waf导致了tcp connection超时，</p> <p>怪不得跟chrome的时间有点不同，chrome至少可以看到在重用reuse tcp socket connection的时候是很快的，那么就自然要确认下，重新设置firefox auto detect proxy，即使用跟chrome一样的机器的proxy，结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>Status:
Response received
URL:
https://www.xxx.com/wp-admin/async-upload.php
Priority:
Normal(0)
Thread:
Web Content (1/8)
URL:
https://www.xxx.com/wp-admin/upload.php (id: 42949673012)
Waiting for socket thread:
44ms
HTTP request and waiting for response:
13,371ms
HTTP response:
15,701ms
Waiting to transmit the response:
4.3ms
</code></pre></div><p>先走了proxy，等待socket时间变短了，可能是reuse也不用重新建立tcp连接握手了，不过等待http reponse的时间很长，估计超时了（超过proxy服务器的timeout时长），至少这次跟chrome表现一样了；</p> <p>最后自然是重新设置no-proxy，绕过proxy然后绕过waf（设置hosts直接指向web服务器的ip），果然上传成功！</p> <div class="language- extra-class"><pre class="language-text"><code>Status:
Response received
URL:
https://www.xxx.com/wp-admin/async-upload.php
Priority:
Normal(0)
MIME type:
text/plain
Requested bytes:
2,259B
Thread:
Web Content (1/8)
URL:
https://www.xxx.com/wp-admin/upload.php (id: 42949673015)
Waiting for socket thread:
98ms
DNS request:
0.29ms
After DNS request:
1.3ms
TCP connection:
121ms
After TCP connection:
3.5ms
Establishing TLS session:
114ms
Waiting for HTTP request:
21ms
HTTP request and waiting for response:
18,930ms
HTTP response:
0.67ms
Waiting to transmit the response:
4.1ms
</code></pre></div><p>https://stackoverflow.com/questions/27740692/request-stalled-for-a-long-time-occasionally-in-chrome/70180892#70180892</p> <p>https://stackoverflow.com/questions/53736912/neterr-connection-reset-when-large-file-takes-longer-than-a-minute/70180666#70180666</p> <h3 id="websocket-issues"><a href="#websocket-issues" class="header-anchor">#</a> websocket issues</h3> <h4 id="websocket-connection-issue"><a href="#websocket-connection-issue" class="header-anchor">#</a> websocket connection issue</h4> <p>这次遇到的问题：</p> <p>firefox访问没有问题（浏览器连接服务器的nginx并转发到websocket端口），本地vscode debug（连接本地nginx，nginx转发到服务器上的websocket服务端）</p> <p>原因跟上面wordpress large file upload failed一样都是因为公司机器chrome使用了proxy</p> <p>通常websocket连接不成功大概率是client端或者服务端的问题，所以刚开始浪费了不少时间查看服务端的情况以及websocket client端代码，其实可以直接在dev tools里面执行代码片段进行调试</p> <div class="language- extra-class"><pre class="language-text"><code>// Create WebSocket connection.
const socket = new WebSocket('ws://localhost:8080');

// Connection opened
socket.addEventListener('open', function (event) {
    socket.send('Hello Server!'); // normally should be subscribe example send('{&quot;oper&quot;:&quot;subscribe&quot;,&quot;topic&quot;:&quot;TOPIC NAME&quot;}');
});

// Listen for messages
socket.addEventListener('message', function (event) {
    console.log('Message from server ', event.data);
});

</code></pre></div><p>观察到，chrome下偶尔成功，多数时间失败，上chrome终极大杀器 netlog viewer，
chrome://net-export
https://netlog-viewer.appspot.com
发现跟前面一样的原因；</p> <p>后来才有人反馈firefox可以，才意识到firefox默认proxy设置成了blank，chrome不使用插件的情况下默认是系统的proxy</p> <h4 id="websocket-301"><a href="#websocket-301" class="header-anchor">#</a> websocket 301</h4> <p>nginx config:</p> <div class="language- extra-class"><pre class="language-text"><code>  location /websocket/ {
            proxy_pass http://127.0.0.1:10001/websocket;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection &quot;Upgrade&quot;;
            proxy_set_header X-Real-IP $remote_addr;
                        proxy_read_timeout 600s;
        }

</code></pre></div><p>请求</p> <div class="language- extra-class"><pre class="language-text"><code>Request URL: ws://X.X.X.X/websocket
Request Method: GET

结果
&quot;GET /websocket HTTP/1.1&quot; 301 169 &quot;
</code></pre></div><p>测试：</p> <div class="language- extra-class"><pre class="language-text"><code># curl --include \
&gt;      --no-buffer \
&gt;      --header &quot;Connection: Upgrade&quot; \
&gt;      --header &quot;Upgrade: websocket&quot; \
&gt;      --header &quot;Host: example.com:80&quot; \
&gt;      --header &quot;Origin: http://X.X.X.X&quot; \
&gt;      --header &quot;Sec-WebSocket-Key: wRPCh4fPSMIpX7yMcpgABA==&quot; \
&gt;      --header &quot;Sec-WebSocket-Version: 13&quot; \
&gt;      &quot;http://X.X.X.X/websocket&quot;
HTTP/1.1 301 Moved Permanently
Server: nginx/1.22.0
Date: Mon, 12 Sep 2022 09:37:18 GMT
Content-Type: text/html
Content-Length: 169
Location: http://example.com/websocket/
Connection: keep-alive

&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.22.0&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;


[root@sghc1-prod-acs-app-v01 ~]# curl --include \
&gt;      --no-buffer \
&gt;      --header &quot;Connection: Upgrade&quot; \
&gt;      --header &quot;Upgrade: websocket&quot; \
&gt;      --header &quot;Host: example.com:80&quot; \
&gt;      --header &quot;Origin: http://X.X.X.X&quot; \
&gt;      --header &quot;Sec-WebSocket-Key: wRPCh4fPSMIpX7yMcpgABA==&quot; \
&gt;      --header &quot;Sec-WebSocket-Version: 13&quot; \
&gt;      &quot;http://X.X.X.X/websocket/&quot;
HTTP/1.1 101 Switching Protocols
Server: nginx/1.22.0
Date: Mon, 12 Sep 2022 09:36:48 GMT
Connection: upgrade
upgrade: websocket
sec-websocket-accept: NwKFJc0S/lPR4qpqWC7LzZ7CQj4=

▒l{&quot;code&quot;:0,&quot;message&quot;:&quot;welcome!&quot;,&quot;sessionId&quot;:&quot;1a1050ad-bbb6-4ccd-bfce-a84688e6017d&quot;,&quot;success&quot;:true}
</code></pre></div><p>区别就在最后的 ending slash /</p> <p>所以修改nginx配置</p> <div class="language- extra-class"><pre class="language-text"><code>location /websocket/ 
=&gt;
location /websocket
</code></pre></div><p>https://nginx.org/en/CHANGES-1.22</p> <div class="language- extra-class"><pre class="language-text"><code>    *) Bugfix: special characters were not escaped during automatic redirect
       with appended trailing slash.
</code></pre></div><h4 id="webscoket-failed-switch-protocol-lost-upgrade-header"><a href="#webscoket-failed-switch-protocol-lost-upgrade-header" class="header-anchor">#</a> webscoket failed switch Protocol/lost upgrade header</h4> <p><strong>描述：</strong></p> <p>华为云上配置：
浏览器/App =&gt; CDN或高防等代理 =&gt; Web应用防火墙 =&gt; 源站服务器</p> <p>websocket服务位于源站服务器，通过nginx反向代理，nginx配置 debug：</p> <div class="language- extra-class"><pre class="language-text"><code>location /test/wsPublicMessage {
    if ( $http_upgrade = '' ){
        add_header debug $http_x_forwarded_for;
        return 465;
        }
        proxy_pass http://XXX ;
        #proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;


curl -k https://xxx/test/wsPublicMessage -vv -H &quot;Sec-WebSocket-Version: 13&quot; -H &quot;Connection: Upgrade&quot; -H &quot;Upgrade: websocket&quot; -H &quot;Sec-WebSocket-Key: csoXmf407963ymLeVKMqDw==&quot;
</code></pre></div><p>发现从公网访问，到达nginx的时候 http_upgrade为空，
但是直接修改本地hosts文件域名指向源站服务器则没有问题，说明问题出在中间的CDN或高防等代理或者Web应用防火墙</p> <p><strong>调查：</strong>
修改域名的cname指向Web应用防火墙，绕过cdn，问题解决</p> <p><strong>原因：</strong>
华为云cdn服务限制：</p> <blockquote><p>域名服务范围为中国大陆境外或全球时：
支持HTTP、HTTPS协议；不支持其他协议，如FTP、TCP、UDP、WebSocket、WSS等协议。</p></blockquote> <h3 id="nginx-location-proxy-pass-404"><a href="#nginx-location-proxy-pass-404" class="header-anchor">#</a> nginx location proxy_pass 404</h3> <div class="language- extra-class"><pre class="language-text"><code>server {
		listen       80;
        location /test {
            proxy_pass http://127.0.0.1:10001;
            proxy_redirect    off;
            proxy_set_header  Host $host;
            proxy_set_header  X-real-ip $remote_addr;
            proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
        }
</code></pre></div><p>刚开始一直怀疑是nginx问题，结果发现10001对应的java服务挂了，开启debug模式发现问题：
java -Djavax.net.debug=all -jar teset.jar
原来是一个字体引起的
java: symbol lookup error: /lib64/libfontconfig.so.1: undefined symbol: FT_Get_Advance</p> <p>$ ll /usr/lib64/libfontconfig.so.1
lrwxrwxrwx. 1 root root 23 Jun 15 17:05 /usr/lib64/libfontconfig.so.1 -&gt; libfontconfig.so.1.11.1</p> <p>nm -D /usr/lib64/libfontconfig.so.1 | grep FT_Get_Advance</p> <p>$ nm -D /usr/lib64/libfontconfig.so.1 | grep FT_Get_Advance
U FT_Get_Advance</p> <p>第一次尝试：
mv /usr/lib64/libfreetype.so.6 /usr/lib64/libfreetype.so.6_renamed</p> <p>2022-06-17 19:50:55.845 ERROR 26353GG [io-10001-exec-2] c.q.f.w.a.CommonExceptionHandler : InternalException: Handler dispatch failed; nested exception is java.lang.UnsatisfiedLinkError: /opt/3rd-party/openjdk-8u312-b07/jre/lib/amd64/libfontmanager.so: libfreetype.so.6: cannot open shared object file: No such file or directory</p> <p>org.springframework.web.util.NestedServletException: Handler dispatch failed; nested exception is java.lang.UnsatisfiedLinkError: /opt/3rd-party/openjdk-8u312-b07/jre/lib/amd64/libfontmanager.so: libfreetype.so.6: cannot open shared object file: No such file or directory
at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1075)
at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:962)
at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006)
at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:898)
at javax.servlet.http.HttpServlet.service(HttpServlet.java:626)
at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)
at javax.servlet.http.HttpServlet.service(HttpServlet.java:733)</p> <p>第二次(solved)：
https://www.bookstack.cn/read/WeBASE-1.2.4-zh/96bb971c90544168.md</p> <div class="language- extra-class"><pre class="language-text"><code>yum -y install gcc
yum -y install gcc-c++
</code></pre></div><h3 id="java-io-ioexception-connection-reset-by-peer"><a href="#java-io-ioexception-connection-reset-by-peer" class="header-anchor">#</a> java.io.IOException: Connection reset by peer</h3> <p>client -&gt; load balance with public ip -&gt; internal firewall -&gt; cloud firewall &amp; enterprice router -&gt; 后端服务</p> <p>报错：</p> <div class="language- extra-class"><pre class="language-text"><code>2024-09-16 03:32:09.215 [32m INFO[m [35m4556GG[m [NioProcessor-2] [36mq.m.a.AcceptorIoHandler[m : MINA session created: local=/192.168.10.1:9890, class org.apache.mina.transport.socket.nio.NioSocketSession, remote=/192.168.10.79:12097
2024-09-16 03:32:09.216 [31mERROR[m [35m4556GG[m [NioProcessor-2] [36mq.m.AbstractIoHandler[m : Socket (/192.168.10.79:12097): java.io.IOException: Connection reset by peer

java.io.IOException: Connection reset by peer
	at sun.nio.ch.FileDispatcherImpl.read0(Native Method)
	at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)
	at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)
	at sun.nio.ch.IOUtil.read(IOUtil.java:197)
	at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:380)
	at org.apache.mina.transport.socket.nio.NioProcessor.read(NioProcessor.java:378)
	at org.apache.mina.transport.socket.nio.NioProcessor.read(NioProcessor.java:47)
	at org.apache.mina.core.polling.AbstractPollingIoProcessor.read(AbstractPollingIoProcessor.java:519)
	at org.apache.mina.core.polling.AbstractPollingIoProcessor.access$1200(AbstractPollingIoProcessor.java:68)
	at org.apache.mina.core.polling.AbstractPollingIoProcessor$Processor.process(AbstractPollingIoProcessor.java:1242)
	at org.apache.mina.core.polling.AbstractPollingIoProcessor$Processor.process(AbstractPollingIoProcessor.java:1231)
	at org.apache.mina.core.polling.AbstractPollingIoProcessor$Processor.run(AbstractPollingIoProcessor.java:683)
	at org.apache.mina.util.NamePreservingRunnable.run(NamePreservingRunnable.java:64)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
</code></pre></div><p>首先通过eclipse的dependency hierarchy查了下MINA 是我们用的quickfix的底层依赖，所以确认了报错的大概范围，然后连过来的这个ip 192.168.10.79 有时候是 load balance 有时候是 internal firewall，注意：cloud firewall &amp; enterprice router是二层设备，经过调查，发现实际上我们的load balancer和firewall都有定时对backend后端的这个端口进行tcp健康检查，这样就出现一个问题：为什么tcp检查会触发业务层的这个错误？</p> <p>按照简单的理解，我以为tcp检查并不会触发这里的后端也就是quickfix程序的反应，比如类似ping之类的，当然我是说类似tcp ping或telnet，但是进一步思考发现，实际上telnet的行为跟 quickfix client端没有多大区别，</p> <p>对于backend - quickfix server来说，不管是telnet还是 quickfix client,都是先3次握手(SYN, SYN-ACK, ACK)建立连接，然后接着client端可以发送tcp header + payload（为了讨论方便我省略了ip header mac header等），唯一的区别是，telnet的payload是纯文本的 raw message， 而 quickfix client的则是通过程序规范化的 quickfix header|message, backend 可能会给raw message请求一个greetings的响应，取决于这个quickfix server的实现，更可能的情况是对于非法的raw message，quickfix backend不予处理，可想而知，我们完全可以构造一个 raw message使其内容是合法的quickfix header|message，这样backend就会认为telnet client也是个合法的quickfix client</p> <p>In conclusion, your assessment is correct:</p> <ul><li>The initial connection process is the same regardless of client type.</li> <li>The difference lies in the payload structure.</li> <li>The QuickFIX server's response depends on whether the payload matches the expected FIX format. If you can construct a valid FIX message through telnet, the server would treat it as a legitimate QuickFIX client message.</li></ul> <p>然后再回看日志，这个错误确实是发生在三次握手之后socket/bind/listen/accept，NIO介入rec读取信息：</p> <p>NIO (Non-blocking I/O): The log indicates that the application is using Java NIO to handle socket connections. NIO can handle multiple connections using fewer threads than traditional blocking I/O. It becomes involved after the socket has been accepted and is ready to read or write data.This indicates that the server was trying to read data from the newly created session when it encountered the &quot;connection reset by peer&quot; exception. This typically means the server was attempting to process a message (or expecting to receive one) but found that the connection was no longer valid.</p> <p>还有一种场景 TCP-PING/SYN scan,这种端口检查的过程是：
the client sends a SYN packet, the server responds with a SYN-ACK, and then the client sends an RST packet instead of completing the handshake with an ACK. This interaction occurs in the initial connection establishment phase, before any application-level interaction takes place.
When the client sends an RST packet in response to a SYN-ACK (like in a SYN scan), it will typically lead to a &quot;Connection reset by peer&quot; error.
This exception can indeed manifest at the OS level, indicating that the connection was terminated unexpectedly. When the server tries to read from this socket, it will receive an error.
In the context of Java and frameworks like MINA, the &quot;Connection reset by peer&quot; error is translated into an IOException. This is a higher-level indication that the application was attempting to read from a connection that has been unexpectedly closed.
Therefore, while the underlying cause of the reset is at a lower level (like the OS or TCP stack), the application can catch this as an IOException.</p> <p>简言之，TCP-PING/SYN scan在三次握手中也可以通过 RST 触发 reset by peer错误，从而被 application抓到，只不过这种场景跟我们的stack trace对应不上，前面已经分析了我们这次碰到的明显是握手之后的情况。</p> <p>最后确认了确实是 tcp健康检查引起的问题：
<img src="/docs/docs_image/software/programming/web/tcp_health_check.png" alt=""></p> <p>没有采用syn scan是因为会引起<a href="/docs/software/network/layer4_tcp_protocol.html">半连接溢出</a></p> <h3 id="clientabortexception-broken-pipe"><a href="#clientabortexception-broken-pipe" class="header-anchor">#</a> ClientAbortException - Broken pipe</h3> <p>前端=》nginx=》后端服务</p> <div class="language- extra-class"><pre class="language-text"><code>后端异常：
org.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe

nginx日志：

10.34.100.15 - - [17/Aug/2022:20:39:05 +0800] &quot;POST /test HTTP/1.1&quot; 499 0 &quot;https://test.com/test&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36&quot;
10.34.100.15 - - [17/Aug/2022:20:39:06 +0800] &quot;POST /test HTTP/1.1&quot; 200 12176 &quot;https://test.com/test&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36&quot;

可以看到pattern是一直有两个同一个时间的日志，一个是 499 一个是200，499代表client端也就是浏览器关闭了请求，而服务端还在往buffer写返回，所以抛错
</code></pre></div><p>经调查发现前端页面渲染的两个组件内部有重复的api调用</p> <h3 id="clientabortexception-connection-reset-by-peer"><a href="#clientabortexception-connection-reset-by-peer" class="header-anchor">#</a> ClientAbortException - Connection reset by peer</h3> <p>frontend=&gt;nginx=&gt;java program</p> <p>这个是java program的报错，所以peer不是nginx就是frontend(browser);</p> <p>发现nginx里面有很多同一秒内的相同请求，并且都是200，只是size不太一样，好像出问题的size少了一些，大概推测是java program返回了200 ok，然后写response的时候client断了，所以没有写完；</p> <p>有人问我，会不会是突然用户关闭了tab或者浏览器呢，我的回答是浏览器没那么弱鸡：</p> <blockquote><p>modern browser should follow the standard http tcp protocol: 3 way handshake to establish connection and 4 way handshake to close the connection,
when user try to shutdown browser, it's the browser's responsibility to properly close the connections in the standard way, otherwise will cause the website servers lots of broken connections which is abnormal and irresponsible behavior
so most of the time the developers no need to worry about how browsers handle the connections when users close the tabs or switch between pages, but how the web pages  behave themselves is the developers responsibility to handle
如果我说错了请纠正我</p></blockquote> <p>https://blog.csdn.net/qq_28204635/article/details/124060991</p> <p>所以问题还是出在nginx里面日志发现的同一秒的重复请求，正常测试会发现，极短时间内重复请求，浏览器一般都会cancel掉前一次的请求，但是是不是偶尔浏览器处理的慢一点就导致请求已经在response的时候才中断；</p> <p>最后确实发现前端代码的问题，在切换内部菜单的时候，不可见的页面A并没有被销毁，A页面上的一个定时poll一直在跑，然后其他页面又可以增加页面A作为子页面，这种情况下，不可见的A和增加的子页面A同时在跑两个定时的poll请求</p> <p>TCP层面解释：
CLIENT&lt;-&gt;SERVER; CLIENT突然断掉连接，恢复后仍然收到SERVER端发来的之前的数据，此时CLIENT发出RST</p> <blockquote><p>It's fatal. The remote server has sent you a RST packet, which indicates an immediate dropping of the connection, rather than the usual handshake. This bypasses the normal half-closed state transition. I like this description:
&quot;Connection reset by peer&quot; is the TCP/IP equivalent of slamming the phone back on the hook. It's more polite than merely not replying, leaving one hanging. But it's not the FIN-ACK expected of the truly polite TCP/IP converseur.
To expand on BalusC's answer, any scenario where the sender continues to write after the peer has stopped reading and closed its socket will produce this exception, as will the peer closing while it still had unread data in its own socket receive buffer. In other words, an application protocol error. For example, if you write something to the peer that the peer doesn't understand, and then it closes its socket in protest, and you then continue to write, the peer's TCP stack will issue an RST, which results in this exception and message at the sender.</p></blockquote> <p><a href="https://datatracker.ietf.org/doc/html/rfc9293#name-reset-generation" target="_blank" rel="noopener noreferrer">官方解释 RFC9293 3.5.2. Reset Generation:<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>A TCP user or application can issue a reset on a connection at any time, though reset events are also generated by the protocol itself when various error conditions occur, as described below. The side of a connection issuing a reset should enter the TIME-WAIT state, as this generally helps to reduce the load on busy servers for reasons described in [70].</p> <p>As a general rule, reset (RST) is sent whenever a segment arrives that apparently is not intended for the current connection. A reset must not be sent if it is not clear that this is the case.</p> <p>There are three groups of states:</p> <ul><li>If the connection does not exist (CLOSED), then a reset is sent in response to any incoming segment except another reset. A SYN segment that does not match an existing connection is rejected by this means.</li></ul> <p>If the incoming segment has the ACK bit set, the reset takes its sequence number from the ACK field of the segment; otherwise, the reset has sequence number zero and the ACK field is set to the sum of the sequence number and segment length of the incoming segment. The connection remains in the CLOSED state.</p> <ul><li>If the connection is in any non-synchronized state (LISTEN, SYN-SENT, SYN-RECEIVED), and the incoming segment acknowledges something not yet sent (the segment carries an unacceptable ACK), or if an incoming segment has a security level or compartment (Appendix A.1) that does not exactly match the level and compartment requested for the connection, a reset is sent.</li></ul> <p>If the incoming segment has an ACK field, the reset takes its sequence number from the ACK field of the segment; otherwise, the reset has sequence number zero and the ACK field is set to the sum of the sequence number and segment length of the incoming segment. The connection remains in the same state.</p> <ul><li>If the connection is in a synchronized state (ESTABLISHED, FIN-WAIT-1, FIN-WAIT-2, CLOSE-WAIT, CLOSING, LAST-ACK, TIME-WAIT), any unacceptable segment (out-of-window sequence number or unacceptable acknowledgment number) must be responded to with an empty acknowledgment segment (without any user data) containing the current send sequence number and an acknowledgment indicating the next sequence number expected to be received, and the connection remains in the same state.</li></ul> <p>If an incoming segment has a security level or compartment that does not exactly match the level and compartment requested for the connection, a reset is sent and the connection goes to the CLOSED state. The reset takes its sequence number from the ACK field of the incoming segment.</p> <h4 id="延伸-前面是服务端报错-还有客户端报错的场景-client-side-reset-by-peer"><a href="#延伸-前面是服务端报错-还有客户端报错的场景-client-side-reset-by-peer" class="header-anchor">#</a> 延伸：前面是服务端报错，还有客户端报错的场景 client side reset by peer</h4> <p>HTTP 1.1 introduced the concept of persistent connections, enabling a client to reuse the same connection for multiple requests to a server. Instead of closing the connection immediately after receiving a response, the connection remains open, allowing subsequent requests to benefit from reduced latency and improved performance. This persistence is achieved by keeping the TCP connection alive.</p> <p>Connection Closure and Non-Idempotent Requests:
In certain scenarios, a server may close the persistent connection unexpectedly, resulting in errors for the client. It is important to understand that non-idempotent requests, such as POST and PATCH, should not be retried when the connection is closed.</p> <p>Idempotent requests are those that produce the same outcome regardless of how many times they are repeated. On the other hand, non-idempotent requests have the potential to cause side effects on the server with each execution. POST, for example, is commonly used to create new records, and multiple executions would result in the creation of multiple records.</p> <p>Handling Connection Closure:
When a connection is closed, the client cannot be certain whether the request was successfully executed by the server. Hence, according to RFC 7230, which defines the HTTP 1.1 protocol, it is considered unsafe for the client to automatically retry non-idempotent requests such as POST. The client should instead treat the connection closure as a definitive response from the server and proceed accordingly.</p> <p>A request method is considered &quot;idempotent&quot; if the intended effect on the server of multiple identical requests with that method is the same as the effect for a single request RFC 7230 4.2.2</p> <p>Automatic retrying of non-idempotent requests could lead to unintended consequences, such as duplicate records being created on the server. Since the client cannot be certain whether the original request was processed by the server before the connection was closed, retrying the request would violate the idempotent nature of the operation.</p> <p>My solution:</p> <p>Disable persistent connection on the client side
Reduce connection timeout on the client side to be less than server’s</p> <p>https://dev.to/thanhphuchuynh/understanding-connection-reset-by-peer-in-golang-a-troubleshooting-guide-41pf</p> <h4 id="延伸2-fix-server-reset-by-peer"><a href="#延伸2-fix-server-reset-by-peer" class="header-anchor">#</a> 延伸2：fix server: reset by peer</h4> <p>跟浏览器类似，这个也是 fix client的问题，</p> <p>fix client=&gt;ipsec=&gt;huawei elb load balancer=&gt;fix server</p> <p>刚好huawei elb有个连接监控图，其中并发连接数（concurrency connections）显示发生问题前后连接数最低为2，发生问题的几秒后连接数增长到3并迅速回到2，说明是有一个 fix client可能突然crash并restart了，造成之前的连接处于 half close状态，加上重连，所以瞬间出现3个连接，然后服务器端关闭了这个连接，所以回到两个连接的状态；</p> <h3 id="请求大量数据时返回截断中断-net-err-incomplete-chunked-encoding"><a href="#请求大量数据时返回截断中断-net-err-incomplete-chunked-encoding" class="header-anchor">#</a> 请求大量数据时返回截断中断 net::ERR_INCOMPLETE_CHUNKED_ENCODING</h3> <p>请求 size=100没问题
https://api.lyhistory.com/hismin?size=100&amp;datatype=7&amp;instrumentid=BTCP&amp;startday=20221020&amp;starttime=19:35</p> <p>请求 size=1000返回被截断
https://api.lyhistory.com/hismin?size=1000&amp;datatype=7&amp;instrumentid=BTCP&amp;startday=20221020&amp;starttime=19:35</p> <p>具体错误：</p> <ul><li>chrome显示：net::ERR_INCOMPLETE_CHUNKED_ENCODING</li> <li>firefox：SyntaxError: JSON.parse: end of data after property value in object at line 3606 column 23 of the JSON data</li></ul> <h4 id="浏览器-》cdn-》waf地址池-》防火墙-只开放访问给waf地址池-》elb-elb-公网地址eip-nat-内网elb-ip-》源服务器-nginx反向代理-proxy-pass-to-upstream"><a href="#浏览器-》cdn-》waf地址池-》防火墙-只开放访问给waf地址池-》elb-elb-公网地址eip-nat-内网elb-ip-》源服务器-nginx反向代理-proxy-pass-to-upstream" class="header-anchor">#</a> 浏览器=》cdn=》waf地址池=》防火墙（只开放访问给waf地址池）=》elb(elb 公网地址eip=&gt;NAT=&gt;内网elb ip)=》源服务器(nginx反向代理-&gt;proxy_pass to upstream)，</h4> <div class="language- extra-class"><pre class="language-text"><code>453138: URL_REQUEST
https://api.lyhistory.com/hismin?size=1000&amp;datatype=7&amp;instrumentid=BTCP&amp;startday=20221020&amp;starttime=19:35
Start Time: 2022-10-21 08:53:14.450

t=23755 [st=  0] +REQUEST_ALIVE  [dt=760]
                  --&gt; priority = &quot;HIGHEST&quot;
                  --&gt; traffic_annotation = 63171670
                  --&gt; url = &quot;https://api.lyhistory.com/hismin?size=1000&amp;datatype=7&amp;instrumentid=BTCP&amp;startday=20221020&amp;starttime=19:35&quot;
t=23755 [st=  0]    NETWORK_DELEGATE_BEFORE_URL_REQUEST  [dt=0]
t=23755 [st=  0]   +URL_REQUEST_START_JOB  [dt=759]
                    --&gt; initiator = &quot;chrome-extension://ginpbkfigcoaokgflihfhhmglmbchinc&quot;
                    --&gt; load_flags = 65794 (BYPASS_CACHE | CAN_USE_RESTRICTED_PREFETCH | MAIN_FRAME_DEPRECATED)
                    --&gt; method = &quot;GET&quot;
                    --&gt; network_isolation_key = &quot;https://lyhistory.com https://lyhistory.com&quot;
                    --&gt; privacy_mode = &quot;disabled&quot;
                    --&gt; request_type = &quot;main frame&quot;
                    --&gt; site_for_cookies = &quot;SiteForCookies: {site=https://lyhistory.com; schemefully_same=true}&quot;
                    --&gt; url = &quot;https://api.lyhistory.com/hismin?size=1000&amp;datatype=7&amp;instrumentid=BTCP&amp;startday=20221020&amp;starttime=19:35&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=23755 [st=  0]      COOKIE_INCLUSION_STATUS
                      --&gt; operation = &quot;send&quot;
                      --&gt; status = &quot;INCLUDE, DO_NOT_WARN&quot;
t=23755 [st=  0]      NETWORK_DELEGATE_BEFORE_START_TRANSACTION  [dt=6]
t=23761 [st=  6]      HTTP_CACHE_GET_BACKEND  [dt=0]
t=23761 [st=  6]      HTTP_CACHE_DOOM_ENTRY  [dt=0]
                      --&gt; net_error = -2 (ERR_FAILED)
t=23761 [st=  6]      HTTP_CACHE_CREATE_ENTRY  [dt=0]
t=23761 [st=  6]      HTTP_CACHE_ADD_TO_ENTRY  [dt=0]
t=23761 [st=  6]     +HTTP_STREAM_REQUEST  [dt=442]
t=23761 [st=  6]        HTTP_STREAM_JOB_CONTROLLER_BOUND
                        --&gt; source_dependency = 453146 (HTTP_STREAM_JOB_CONTROLLER)
t=24203 [st=448]        HTTP_STREAM_REQUEST_BOUND_TO_JOB
                        --&gt; source_dependency = 453147 (HTTP_STREAM_JOB)
t=24203 [st=448]     -HTTP_STREAM_REQUEST
t=24203 [st=448]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=0]
t=24203 [st=448]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS
                        --&gt; GET /hismin?size=1000&amp;datatype=7&amp;instrumentid=BTCP&amp;startday=20221020&amp;starttime=19:35 HTTP/1.1
                            Host: api.lyhistory.com
                            Connection: keep-alive
                            Pragma: no-cache
                            Cache-Control: no-cache
                            sec-ch-ua: &quot; Not A;Brand&quot;;v=&quot;99&quot;, &quot;Chromium&quot;;v=&quot;90&quot;, &quot;Google Chrome&quot;;v=&quot;90&quot;
                            sec-ch-ua-mobile: ?0
                            Upgrade-Insecure-Requests: 1
                            User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36
                            Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
                            Sec-Fetch-Site: cross-site
                            Sec-Fetch-Mode: navigate
                            Sec-Fetch-Dest: document
                            Accept-Encoding: gzip, deflate, br
                            Accept-Language: en-US,en;q=0.9
                            Cookie: [161 bytes were stripped]
t=24203 [st=448]     -HTTP_TRANSACTION_SEND_REQUEST
t=24203 [st=448]     +HTTP_TRANSACTION_READ_HEADERS  [dt=311]
t=24203 [st=448]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=311]
t=24514 [st=759]        HTTP_TRANSACTION_READ_RESPONSE_HEADERS
                        --&gt; HTTP/1.1 200 OK
                            Date: Fri, 21 Oct 2022 00:53:15 GMT
                            Content-Type: application/json; charset=utf-8
                            Transfer-Encoding: chunked
                            Connection: keep-alive
                            Server: CloudWAF
                            Content-Encoding: gzip
                            via: EA-SGP-EDGE1-CACHE5[90],EA-SGP-EDGE1-CACHE5[ovl,89],EA-MAS-cyberjaya-GLOBAL1-CACHE1[ovl,69]
t=24514 [st=759]     -HTTP_TRANSACTION_READ_HEADERS
t=24514 [st=759]      HTTP_CACHE_WRITE_INFO  [dt=0]
t=24514 [st=759]      HTTP_CACHE_WRITE_DATA  [dt=0]
t=24514 [st=759]      HTTP_CACHE_WRITE_INFO  [dt=0]
t=24514 [st=759]      NETWORK_DELEGATE_HEADERS_RECEIVED  [dt=0]
t=24514 [st=759]      URL_REQUEST_FILTERS_SET
                      --&gt; filters = &quot;GZIP&quot;
t=24514 [st=759]   -URL_REQUEST_START_JOB
t=24514 [st=759]    URL_REQUEST_DELEGATE_RESPONSE_STARTED  [dt=1]
t=24515 [st=760]    HTTP_TRANSACTION_READ_BODY  [dt=0]
t=24515 [st=760]    URL_REQUEST_JOB_BYTES_READ
                    --&gt; byte_count = 3086
t=24515 [st=760]    URL_REQUEST_JOB_FILTERED_BYTES_READ
                    --&gt; byte_count = 65536
t=24515 [st=760]    URL_REQUEST_JOB_FILTERED_BYTES_READ
                    --&gt; byte_count = 16211
t=24515 [st=760]    HTTP_TRANSACTION_READ_BODY  [dt=0]
                    --&gt; net_error = -355 (ERR_INCOMPLETE_CHUNKED_ENCODING)
t=24515 [st=760]    FAILED
                    --&gt; net_error = -355 (ERR_INCOMPLETE_CHUNKED_ENCODING)
t=24515 [st=760] -REQUEST_ALIVE
                  --&gt; net_error = -355 (ERR_INCOMPLETE_CHUNKED_ENCODING)
</code></pre></div><h4 id="浏览器-》源服务器-nginx反向代理-proxy-pass-to-upstream"><a href="#浏览器-》源服务器-nginx反向代理-proxy-pass-to-upstream" class="header-anchor">#</a> 浏览器=》源服务器(nginx反向代理-&gt;proxy_pass to upstream)</h4> <p>200 但是 chrome network status: (failed)net::ERR_CONTENT_LENGTH_MISMATCH</p> <p>curl测试：</p> <div class="language- extra-class"><pre class="language-text"><code>1curl: (18) transfer closed with 235509 bytes remaining to read
</code></pre></div><h4 id="根源-root-cause-2"><a href="#根源-root-cause-2" class="header-anchor">#</a> 根源 root cause</h4> <div class="language- extra-class"><pre class="language-text"><code>tail -f vi /usr/local/nginx/logs/error.log

2022/10/21 14:20:25 [crit] 15692#0: *357 open() &quot;/usr/local/nginx/proxy_temp/1/05/0000000051&quot; failed (13: Permission denied) while reading upstream, client: 172.31.252.99, server: api.lyhistory.com, request: &quot;POST /hismin HTTP/1.1&quot;, upstream: &quot;http://127.0.0.1:8085/hismin&quot;, host: &quot;172.31.252.69&quot;

# ps -ef|grep nginx
root     15690     1  0 Oct20 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx
nobody   15691 15690  0 Oct20 ?        00:00:00 nginx: worker process
nobody   15692 15690  0 Oct20 ?        00:00:00 nginx: worker process
nobody   15693 15690  0 Oct20 ?        00:00:00 nginx: worker process
nobody   15694 15690  0 Oct20 ?        00:00:00 nginx: worker process

发现master是root权限，worker是nobody，莫非是：
请求size=100的时候 master就可以搞定，1000的时候要拉worker过来干活结果发现没有权限
（从之前的请求可以看到response Content-Length: 317256, 317256/1024=309KB,肯定upstream返回的数据量是超过了nginx某些默认的缓冲区大小，所以要写入临时文件中）

实际proxy_temp nobody有权限
drwx------. 12 nobody root   96 Oct 21 15:08 proxy_temp

发现nobody没有/usr/local/nginx这个路径的权限
修复：chmod a+rx nginx

</code></pre></div><h2 id="cors问题"><a href="#cors问题" class="header-anchor">#</a> CORS问题</h2> <p>场景：
浏览器=》cdn=》waf=》elb=》源服务器（nginx=》后端程序）</p> <p>后端程序里面的Access-Control-Allow-Origin是允许了所有domain，现在需要做的是为了安全，不允许跨域访问，
但是因为后端程序维护人员不在，只好从nginx上动手，做法是nginx上直接 proxy_hide_header Access-Control-Allow-Origin; 移除这个头就好了，</p> <p>测试结果：
正常外网访问没问题：burpsuite返回没有ACAO头，chrome浏览器从其他域打开console执行：</p> <div class="language- extra-class"><pre class="language-text"><code>fetch(&quot;https://testurl&quot;, {
  &quot;headers&quot;: {
.................
  },
  &quot;referrer&quot;: &quot;https://www.google.com/&quot;,
  &quot;referrerPolicy&quot;: &quot;strict-origin-when-cross-origin&quot;,
  &quot;body&quot;: null,
  &quot;method&quot;: &quot;GET&quot;,
  &quot;mode&quot;: &quot;cors&quot;,
  &quot;credentials&quot;: &quot;include&quot;
});
</code></pre></div><p>也会正常显示preflight cors拦截的错误</p> <p>但是神奇的是从内网访问表现异常</p> <p>浏览器=》公司内网vpn=》elb=》源服务器（nginx=》后端程序）</p> <p>首先burp返回仍然一致没问题，但是从chrome console执行上述脚本，preflight+get通过200，而且测试任意origin访问任意网站全部通过，response ACAO返回的用于都是允许相应的origin，
不过通过chrome net log抓包会发现</p> <div class="language- extra-class"><pre class="language-text"><code>t= 9826 [st=  0] +CORS_REQUEST  [dt=611]
                  --&gt; cors_preflight_policy = &quot;consider_preflight&quot;
                  --&gt; headers = &quot;sec-ch-ua: \&quot;Chromium\&quot;;v=\&quot;128\&quot;, \&quot;Not;A=Brand\&quot;;v=\&quot;24\&quot;, \&quot;Google Chrome\&quot;;v=\&quot;128\&quot;\r\npragma: no-cache\r\naccept-language: en-US,en;q=0.9\r\nupgrade-insecure-requests: 1\r\nsec-ch-ua-mobile: ?0\r\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36\r\naccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\r\ncache-control: no-cache\r\npriority: u=0, i\r\nsec-ch-ua-platform: \&quot;Windows\&quot;\r\n\r\n&quot;
                  --&gt; is_revalidating = false
                  --&gt; method = &quot;GET&quot;
                  --&gt; url = &quot;https://qmcms.asiapacificex.com/mobile/data/webQuery?id=587&quot;
t= 9826 [st=  0]    CHECK_CORS_PREFLIGHT_REQUIRED
                    --&gt; preflight_required = true
                    --&gt; preflight_required_reason = &quot;disallowed_header&quot;
t= 9826 [st=  0]    CORS_PREFLIGHT_URL_REQUEST
                    --&gt; source_dependency = 299473 (URL_REQUEST)
t=10210 [st=384]    CORS_PREFLIGHT_RESULT
                    --&gt; access-control-allow-headers = &quot;accept,cache-control,pragma,priority,upgrade-insecure-requests&quot;
                    --&gt; access-control-allow-methods = &quot;*&quot;
......................................
t=10337 [st=511]       +HTTP_TRANSACTION_READ_HEADERS  [dt=98]
t=10337 [st=511]          HTTP_STREAM_PARSER_READ_HEADERS  [dt=98]
t=10435 [st=609]          HTTP_TRANSACTION_READ_RESPONSE_HEADERS
                          --&gt; HTTP/1.1 200
                              Date: Tue, 10 Sep 2024 02:03:21 GMT
                              Content-Type: application/json;charset=UTF-8
                              Transfer-Encoding: chunked
                              Connection: keep-alive
                              Vary: Origin
                              Vary: Access-Control-Request-Method
                              Vary: Access-Control-Request-Headers
                              Access-Control-Allow-Methods: GET,POST,OPTIONS,HEAD
                              Server: elb
</code></pre></div><p>preflight 莫名奇妙通过了，不过这哥get的response里面并没有ACAO，所以猜测是因为内网的这个vpn里面通过了preflight，浏览器在这种情况下产生bug，所以前端的network里面会自动带上ACAO的头</p> <div id="disqus_thread"></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.b1bf34a2.js" defer></script><script src="/docs/assets/js/2.4a937564.js" defer></script><script src="/docs/assets/js/366.fbea0b09.js" defer></script><script src="/docs/assets/js/8.3332a15d.js" defer></script>
  </body>
</html>
