(window.webpackJsonp=window.webpackJsonp||[]).push([[116],{315:function(t,a,e){"use strict";e.r(a);var s=e(0),i=Object(s.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[e("a",{attrs:{href:"/docs/software"}},[t._v("回目录")]),t._v("  《Gitlab Server》")]),t._v(" "),e("h2",{attrs:{id:"architecture"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#architecture"}},[t._v("#")]),t._v(" Architecture")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/ee/development/architecture.html")]),t._v(" "),e("p",[t._v("https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/#service-architecture")]),t._v(" "),e("p",[t._v("https://juejin.im/post/5cf67d355188255508118def")]),t._v(" "),e("p",[t._v("完整文档")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/omnibus/README.html#installation-and-configuration-using-omnibus-package")]),t._v(" "),e("p",[e("img",{attrs:{src:"/docs/docs_image/software/project_manage/git/gitlab01.png",alt:""}})]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('sudo gitlab-ctl status\nrun: alertmanager: (pid 16828) 499486s; run: log: (pid 10270) 584166s\nrun: gitaly: (pid 15594) 499829s; run: log: (pid 9538) 584281s\nrun: gitlab-exporter: (pid 15618) 499829s; run: log: (pid 10090) 584184s\nrun: gitlab-workhorse: (pid 15624) 499828s; run: log: (pid 9929) 584207s\nrun: grafana: (pid 17718) 498697s; run: log: (pid 10420) 584117s\nrun: logrotate: (pid 9004) 2937s; run: log: (pid 10015) 584196s\nrun: nginx: (pid 15677) 499827s; run: log: (pid 9980) 584200s\nrun: node-exporter: (pid 15689) 499827s; run: log: (pid 10050) 584190s\nrun: postgres-exporter: (pid 15696) 499826s; run: log: (pid 10299) 584160s\nrun: postgresql: (pid 15789) 499823s; run: log: (pid 9636) 584274s\nrun: prometheus: (pid 15805) 499823s; run: log: (pid 10224) 584170s\nrun: puma: (pid 16874) 499480s; run: log: (pid 9832) 584220s\nrun: redis: (pid 15829) 499822s; run: log: (pid 9405) 584287s\nrun: redis-exporter: (pid 15834) 499822s; run: log: (pid 10179) 584178s\nrun: sidekiq: (pid 16818) 499486s; run: log: (pid 9864) 584214s\n\n[root@sgkc2-cicd-v02 liuyue]# netstat -anp|grep "15789"\nunix  2      [ ACC ]     STREAM     LISTENING     1264397  15789/postgres       /var/opt/gitlab/postgresql/.s.PGSQL.5432\n\n一个是Active Internet connections，称为有源TCP连接，其中"Recv-Q"和"Send-Q"指%0A的是接收队列和发送队列。这些数字一般都应该是0。如果不是则表示软件包正在队列中堆积。这种情况只能在非常少的情况见到。\n\n另一个是Active UNIX domain sockets，称为有源Unix域套接口(和网络套接字一样，但是只能用于本机通信，性能可以提高一倍)。\nProto显示连接使用的协议,RefCnt表示连接到本套接口上的进程号,Types显示套接口的类型,State显示套接口当前的状态,Path表示连接到套接口的其它进程使用的路径名。\nhttps://blog.csdn.net/u012598668/java/article/details/40080245\n')])])]),e("p",[t._v("接入层")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("Nginx：静态 web 服务器")])]),t._v(" "),e("li",[e("p",[t._v("gitlab-shell：负责处理ssh请求,用于处理 Git 命令和修改 authorized keys 列表")])]),t._v(" "),e("li",[e("p",[t._v("gitlab-workhorse: 负责处理http/https请求,轻量级的反向代理服务器, gitlab workhorse对于本地静态文件请求（例如浏览器请求的html、js、css文件）会自己处理掉，对于纯git操作请求会转发给gitaly，对于其他动态请求会转发给unicorn处理")])]),t._v(" "),e("li",[e("p",[t._v("unicorn：An HTTP server for Rack applications，GitLab Rails 应用是托管在这个服务器上面的，相当于java里面的tomcat，是一个开源项目")]),t._v(" "),e("p",[t._v("unicorn就是gitlab的主server程序，它会调用其他各个组件完成复杂的动态请求处理\nhttps://blog.csdn.net/gg_18826075157/java/article/details/107117595")])]),t._v(" "),e("li",[e("p",[t._v("logrotate：日志文件管理工具")])]),t._v(" "),e("li",[e("p",[t._v("sidekiq：用于在后台执行队列任务（异步执行）")])])]),t._v(" "),e("p",[t._v("底层存储：")]),t._v(" "),e("ul",[e("li",[t._v("PostgreSQL：类似于mysql，存储业务数据，比如有哪些项目组，某个项目组下有哪些项目，某项目下哪些人有权限等等")]),t._v(" "),e("li",[t._v("redis：用于缓存热点数据以及存储异步任务，sidekiq这组件会定期拉取分发异步任务给worker执行")]),t._v(" "),e("li",[t._v("gitaly：存储底层代码文件，提供rpc接口对外提供git操作服务")])]),t._v(" "),e("p",[t._v("*-exporter+grafana+prometheus: 监控")]),t._v(" "),e("h3",{attrs:{id:"http-https-over-nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#http-https-over-nginx"}},[t._v("#")]),t._v(" http/https over nginx:")]),t._v(" "),e("p",[t._v("git request: http://172.26.101.133:8088/root/test-gitaly-cluster.git")]),t._v(" "),e("p",[t._v("user/admin dashboard request: http://172.26.101.133:8088/root/test-gitaly-cluster")]),t._v(" "),e("p",[t._v("grafana request: http://172.26.101.133:8088/-/grafana/?orgId=1")]),t._v(" "),e("p",[t._v("sudo vim /var/opt/gitlab/nginx/conf/nginx.conf")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("upstream gitlab-workhorse {\n    server unix:/var/opt/gitlab/gitlab-workhorse/socket;\n  }\n\n  include /var/opt/gitlab/nginx/conf/gitlab-http.conf;\n")])])]),e("p",[t._v("这个upstream名字是gitlab-workhorse，对应是转发到的地方，这里可以看到是一个unix socket；")]),t._v(" "),e("p",[t._v("再来看include的这个配置文件：")]),t._v(" "),e("p",[t._v("sudo vim /var/opt/gitlab/nginx/conf/gitlab-http.conf")]),t._v(" "),e("p",[t._v("8088是我们在/etc/gitlab/gitlab.rb中reconfigure的外部访问端口，")]),t._v(" "),e("p",[t._v("可以看到proxy_pass将路由匹配到了"),e("code",[t._v("http://<upstream name>")]),t._v("也就是"),e("code",[t._v("http://gitlab-workhorse")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("server {\n  listen *:8088;\n\n\n  server_name 172.26.101.134;\n  \nlocation / {\n    proxy_cache off;\n    proxy_pass  http://gitlab-workhorse;\n  }\n\n  location /assets {\n    proxy_cache gitlab;\n    proxy_pass  http://gitlab-workhorse;\n  }\n  \n location ~ ^/(404|500|502)(-custom)?\\.html$ {//特别匹配这么几个错误页面\n    root /opt/gitlab/embedded/service/gitlab-rails/public;\n    internal; //限制为内部用户\n  }\n  \n location ~ (.git/git-receive-pack$|.git/info/refs?service=git-receive-pack$|.git/gitlab-lfs/objects|.git/info/lfs/objects/batch$) {\n    proxy_cache off;\n    proxy_pass http://gitlab-workhorse;\n    proxy_request_buffering off;\n  }\n  location /-/grafana/ {\n    proxy_pass http://localhost:3000/;\n  }\n")])])]),e("p",[t._v("可以看到不管是什么请求（除了grafana和那几个特定的静态页面）都是转给gitlab-workhorse来处理，")]),t._v(" "),e("p",[t._v("https://juejin.im/post/5cf680f86fb9a07ed5248cda")]),t._v(" "),e("p",[t._v("最后再来查查gitlab-workhorse，如下可以看到是监听的正是前面upstream转发的那个/var/opt/gitlab/gitlab-workhorse/socket")]),t._v(" "),e("p",[t._v("然后authBackend对应8080端口，这个可以参考")]),t._v(" "),e("blockquote",[e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('https://gitlab.com/gitlab-org/gitlab-workhorse/blob/master/README.md\n\n-authBackend string\n   Authentication/authorization backend (default "http://localhost:8080")\n')])])])]),t._v(" "),e("p",[t._v("估计应该是API接口")]),t._v(" "),e("p",[t._v("documentRoot前端的对应目录是/opt/gitlab/embedded/service/gitlab-rails/public")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@sgkc2-cicd-v01 liuyue]# ps -lef | grep "rail"\n4 S root      5033 22189  0  80   0 - 28203 pipe_w 14:52 pts/1    00:00:00 grep --color=auto rail\n4 S git       6848  6504  0  80   0 - 166286 ep_pol Jun29 ?       00:10:55 /opt/gitlab/embedded/bin/gitlab-workhorse -listenNetwork unix -listenUmask 0 -listenAddr /var/opt/gitlab/gitlab-workhorse/socket -authBackend http://localhost:8080 -authSocket /var/opt/gitlab/gitlab-rails/sockets/gitlab.socket -documentRoot /opt/gitlab/embedded/service/gitlab-rails/public -pprofListenAddr  -prometheusListenAddr localhost:9229 -secretPath /opt/gitlab/embedded/service/gitlab-rails/.gitlab_workhorse_secret -logFormat json -config config.toml\n4 S git       7038  6502  0  80   0 - 257481 poll_s Jun29 ?       00:09:25 puma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]\n4 S git       7056  6503  0  80   0 - 32362 poll_s Jun29 ?        00:00:23 ruby /opt/gitlab/embedded/service/gitlab-rails/bin/sidekiq-cluster -e production -r /opt/gitlab/embedded/service/gitlab-rails -m 50 --timeout 25 *\n')])])]),e("p",[t._v("8080这个端口是哪个服务呢")]),t._v(" "),e("p",[t._v("根据 https://docs.gitlab.com/ee/development/architecture.html 架构图，可以看到8080是指向unicorn")]),t._v(" "),e("p",[t._v("但是查一下，可以看到是puma：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('netstat -anp|grep :8080\ntcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      7038/puma 4.3.3.git\n\nps -lef|grep "puma"\n4 S root      6502  6498  0  80   0 -  1058 poll_s Jun29 ?        00:00:00 runsv puma\n4 S root      6517  6502  0  80   0 -  1094 poll_s Jun29 ?        00:00:00 svlogd -tt /var/log/gitlab/puma\n4 S git       6845  6508  4  80   0 - 173898 poll_s Jun29 ?       15:54:47 puma 4.3.3.gitlab.2 (tcp://localhost:9168) [gitlab-exporter]\n4 S git       7038  6502  0  80   0 - 257481 poll_s Jun29 ?       00:09:26 puma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]\n')])])]),e("p",[t._v("https://docs.gitlab.com/ee/administration/operations/unicorn.html#unicorn")]),t._v(" "),e("blockquote",[e("p",[e("strong",[t._v("Note:")]),t._v(" Starting with GitLab 13.0, Puma is the default web server used in GitLab all-in-one package based installations as well as GitLab Helm chart deployments.")]),t._v(" "),e("p",[t._v("GitLab uses "),e("a",{attrs:{href:"https://yhbt.net/unicorn/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Unicorn"),e("OutboundLink")],1),t._v(", a pre-forking Ruby web server, to handle web requests (web browsers and Git HTTP clients). Unicorn is a daemon written in Ruby and C that can load and run a Ruby on Rails application; in our case the Rails application is GitLab Community Edition or GitLab Enterprise Edition.")])]),t._v(" "),e("p",[t._v("unicorn是一个开源项目，当unicorn不再满足需求时才引入了puma和workhorse")]),t._v(" "),e("p",[t._v("https://juejin.im/post/5cf6832c51882520724c84ff")]),t._v(" "),e("h3",{attrs:{id:"ssh-over-gitlab-shell"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssh-over-gitlab-shell"}},[t._v("#")]),t._v(" ssh over gitlab-shell")]),t._v(" "),e("p",[t._v("git@172.26.101.133:root/test-gitaly-cluster.git")]),t._v(" "),e("p",[t._v("注意安装gitlab后，会创建很多用户")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("vim /etc/passwd\ngitlab-www:x:996:993::/var/opt/gitlab/nginx:/bin/false\ngit:x:995:992::/var/opt/gitlab:/bin/sh\ngitlab-redis:x:994:991::/var/opt/gitlab/redis:/bin/false\ngitlab-psql:x:993:990::/var/opt/gitlab/postgresql:/bin/sh\ngitlab-prometheus:x:992:989::/var/opt/gitlab/prometheus:/bin/sh\n")])])]),e("p",[t._v("注意到git用户的home是/var/opt/gitlab，然后从/var/opt/gitlab/gitlab-shell/config.yml可以获取到配置")]),t._v(" "),e("p",[t._v("auth_file: /var/opt/gitlab/.ssh/authorized_keys，打开可以看到")]),t._v(" "),e("p",[e("code",[t._v('command="/opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell key-1"')])]),t._v(" "),e("p",[t._v("原理就是一句话：ssh可以执行命令 https://research.kudelskisecurity.com/2013/05/14/restrict-ssh-logins-to-a-single-command/")]),t._v(" "),e("p",[t._v("http://williamherry.com/blog/2015/07/19/from-git-push-to-commit-show-on-page/")]),t._v(" "),e("p",[t._v("https://juejin.im/post/5cf686b85188253cec305fa7")]),t._v(" "),e("p",[t._v("my internal sharing talk:")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("I'll give a overview about what we have and how git server works\nI believe everyone should be already familiar with git,\nGit is a distributed version-control system for tracking changes in source code during software development.\nit enables us to collaborate more effiently especially when working remotely on the software project,\n\n//and by integrating with other automation tools like jenkins and others, you can have the ability to Continuous Integration and Continuous Deployment;\nactually for some of the git server implementations like gitlab, we notice that it already has built in CICD Solutions, \nbut we haven't expolore that portion yet, today we'll only cover the basic usage;\n\nalthough most of us are familiar with git, but probably limited to the git client, whether it's git commands or gui tools, \nnow let's talk about how git server side looks like;\n\nat the start, we set up a standalone git lab server, you can see it is comprised of a lot services, some of the non important services are not listed here;\nwhen the users make a git pull or push through http or ssh, it will go to nginx or gitlab shell respectively, if the git request goes through http request, \ngitlab workhorse will redirect it to unicorn, other request like access to the dashboard or grafana monitor will handled by workhorse itself,\nintially there is only unicorn, and then gitlab introduced workhorse to share the load of unicorn, \nunicorn is an open source project, it's a web server in ruby, analogy to tomcat in java;\n\nredis is for cache, postgresql is for the application data storing, sidekiq is for backgroud job, it may be related to the CICD futionality;\n\nthe most crital system is gitaly, it's for the git repository storage\n\nas we have very limited internal users, for the high availability concerns, the first thing we need to do is make sure there is no single point of failure\nfor the gitaly storage, based on the documentation, we come out with this gitaly cluster;\n\nit has a praefect as router between gitlab server and gitaly nodes;\n")])])]),e("h2",{attrs:{id:"install-安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#install-安装"}},[t._v("#")]),t._v(" Install 安装")]),t._v(" "),e("p",[t._v("https://git-scm.com/book/en/v2/Git-on-the-Server-GitLab")]),t._v(" "),e("p",[t._v("ce版本源码：https://gitlab.com/gitlab-org/gitlab-foss/-/tree/master")]),t._v(" "),e("p",[t._v("官方安装文档：https://about.gitlab.com/install/#centos-7")]),t._v(" "),e("p",[t._v("下面采用离线安装 https://docs.gitlab.com/omnibus/manual_install.html")]),t._v(" "),e("h3",{attrs:{id:"dependency"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dependency"}},[t._v("#")]),t._v(" dependency")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# open HTTP, HTTPS and SSH access in the system firewall.\n\nsudo yum install -y curl policycoreutils-python openssh-server\nsudo systemctl enable sshd\nsudo systemctl start sshd\nsudo firewall-cmd --permanent --add-service=http\nsudo firewall-cmd --permanent --add-service=https\nsudo systemctl reload firewalld\n\n# install Postfix to send notification emails.\n# If you want to use another solution to send emails please skip this step and configure an external SMTP server after GitLab has been installed.\n# 此处我已经忽略，奇怪的是我并没有安装，但是后面却发现postfix不知何时已经运行了，估计是gitlab自己搞的\nsudo yum install postfix\nsudo systemctl enable postfix\nsudo systemctl start postfix\n")])])]),e("h3",{attrs:{id:"手动rpm安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#手动rpm安装"}},[t._v("#")]),t._v(" 手动rpm安装")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# GitLab Community Edition\n# Debian/Ubuntu\ndpkg -i gitlab-ce-<version>.deb\n\n# CentOS/RHEL\nrpm -Uvh gitlab-ce-<version>.rpm\n\n下载 https://packages.gitlab.com/gitlab/gitlab-ce\n\nsudo mv gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm /opt/\n\nrpm -ivh gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm \n\nfor firstime install use -i or -U, for upgrade use -U\n")])])]),e("p",[t._v("启动：")]),t._v(" "),e("p",[t._v("sudo gitlab-ctl reconfigure")]),t._v(" "),e("p",[t._v("安装后路径：")]),t._v(" "),e("p",[t._v("/var/opt/gitlab/")]),t._v(" "),e("p",[t._v("/var/opt/gitlab/nginx/conf/gitlab-http.conf")]),t._v(" "),e("p",[t._v("log路径：")]),t._v(" "),e("p",[t._v("/var/log/gitlab/")]),t._v(" "),e("h3",{attrs:{id:"configuration"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[t._v("#")]),t._v(" Configuration")]),t._v(" "),e("p",[t._v("https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md")]),t._v(" "),e("p",[t._v("/etc/gitlab/gitlab.rb")]),t._v(" "),e("p",[t._v('​\tchange external_url="http://172.26.101.133:8088"')]),t._v(" "),e("p",[t._v("sudo gitlab-ctl reconfigure")]),t._v(" "),e("p",[t._v("注意，刚开始我用了8080，"),e("s",[t._v("刚好跟内置的nginx冲突")]),t._v("，是跟gitlab-puma-worker冲突，")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("sudo netstat -anp|grep :8080\n\nsudo ps -lef|grep 18251\n\npuma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]\n\n")])])]),e("p",[t._v("所以访问出现502 Whoops, GitLab is taking too much time to respond.")]),t._v(" "),e("p",[t._v("只需要换一个端口即可，端口也要开通：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("firewall-cmd --zone=public --add-port=8088/tcp --permanent\nfirewall-cmd --reload\nfirewall-cmd --list-all\nfirewall-cmd --list-ports\n")])])]),e("p",[t._v("这个reconfigure会将配置进行“分发”：")]),t._v(" "),e("p",[t._v("比如端口和ip赋值给：")]),t._v(" "),e("p",[t._v("/var/opt/gitlab/nginx/conf/gitlab-http.conf（模板/opt/gitlab/embedded/conf/nginx.conf ?）")]),t._v(" "),e("p",[t._v("/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml（模板：/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml.exmaple）")]),t._v(" "),e("h4",{attrs:{id:"前端-dashboard-grafana"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前端-dashboard-grafana"}},[t._v("#")]),t._v(" 前端 dashboard & grafana")]),t._v(" "),e("p",[t._v("http://172.26.101.133:8088")]),t._v(" "),e("p",[t._v("默认用户名root/ admin@example.com 可以从log中获取：")]),t._v(" "),e("p",[t._v('sudo grep -nr "admin" /var/log/gitlab/')]),t._v(" "),e("p",[t._v("​\t/var/log/gitlab/gitlab-rails/application.log")]),t._v(" "),e("p",[t._v("监控前端（从nginx配置获取）：")]),t._v(" "),e("p",[t._v("172.26.101.134:8088/-/grafana/login")]),t._v(" "),e("p",[t._v("注意这个8088也将会是Gitaly集群的internal_api_url")]),t._v(" "),e("p",[t._v("/opt/gitlab/embedded/service/gitlab-shell/config.yml")]),t._v(" "),e("p",[e("s",[t._v("注意此处要手动修改gitlab_url，不知为何reconfigure没有生效到这里")]),t._v(" 应该不需要修改，默认就是8080，对应puma-worker的端口")]),t._v(" "),e("p",[t._v("auth_key?")]),t._v(" "),e("p",[t._v("grafana:")]),t._v(" "),e("p",[t._v("login")]),t._v(" "),e("p",[t._v("172.26.101.134:8088/-/grafana/login")]),t._v(" "),e("p",[t._v("http://172.26.101.134:8088/oauth/authorize?access_type=online&client_id=a797f89033dee951dac900905d7b447191f743bcd9afa3a970be4a6864ee0661&redirect_uri=http%3A%2F%2F172.26.101.134%3A8088%2F-%2Fgrafana%2Flogin%2Fgitlab&response_type=code&scope=api&state=o2t3bzD7ek3TPoIPHqDVaLc_HSInTqdBK9IlS2dHhnc%3D")]),t._v(" "),e("p",[t._v("?# gitlab The redirect URI included is not valid.")]),t._v(" "),e("p",[t._v("https://grafana.com/docs/grafana/latest/auth/gitlab/")]),t._v(" "),e("p",[t._v("login gitlab, Applications->Add")]),t._v(" "),e("p",[t._v("callback url: http://172.26.101.134:8088/-/grafana/login/gitlab")]),t._v(" "),e("p",[t._v("got to: /var/opt/gitlab/grafana/grafana.ini")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[auth.gitlab]\n\nclient_id\n\nclient_secret\n\nroot_url = http://172.26.101.134:8088/-/grafana\n\nauth_url = http://172.26.101.134:8088/oauth/authorize\n\ntoken_url = http://172.26.101.134:8088/oauth/token\n\napi_url = http://172.26.101.134:8088/api/v4\n")])])]),e("p",[t._v("gitlab-ctl restart grafana")]),t._v(" "),e("h4",{attrs:{id:"邮箱"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#邮箱"}},[t._v("#")]),t._v(" 邮箱")]),t._v(" "),e("p",[t._v("前面跳过了邮箱配置，这里采用external mail server gmail，但是奇怪的是postfix自动运行")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/omnibus/settings/smtp.html")]),t._v(" "),e("p",[e("strong",[t._v("Use smtp instead of sendmail/postfix.")])]),t._v(" "),e("p",[t._v("注意要更改gitlab_rails['smtp_设置，不要改错")]),t._v(" "),e("p",[t._v("测试：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("Look at the ActionMailer `delivery_method` to make sure it matches what you intended. If you configured SMTP, it should say `:smtp`. If you’re using Sendmail, it should say `:sendmail`:\n\nActionMailer::Base.delivery_method\n\ngitlab-rails console\nNotify.test_email('lyhistory@gmail.com', 'test gitlab', 'test').deliver_now\nActionMailer::Base.smtp_settings\n\n")])])]),e("h4",{attrs:{id:"postgresql"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#postgresql"}},[t._v("#")]),t._v(" postgresql")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/omnibus/settings/database.html#connecting-to-the-bundled-postgresql-database")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/ee/administration/troubleshooting/postgresql.html#postgresql")]),t._v(" "),e("p",[t._v("/var/opt/gitlab/postgresql/data/postgresql.conf")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("sudo gitlab-rails dbconsole\n\nsudo gitlab-psql -d gitlabhq_production\n")])])]),e("p",[t._v("plsql cmds")]),t._v(" "),e("p",[t._v("https://www.postgresql.org/docs/12/app-psql.html")]),t._v(" "),e("p",[t._v("注意下面这种方式是无法连接的，因为gitlab本机内部不是用tcp协议，而是用Unix域套接口")]),t._v(" "),e("p",[t._v("/opt/gitlab/embedded/bin/psql -U postgres -d gitlabhq_production -h <POSTGRESQL_SERVER_ADDRESS>")]),t._v(" "),e("h4",{attrs:{id:"gitaly"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gitaly"}},[t._v("#")]),t._v(" gitaly")]),t._v(" "),e("p",[t._v("vim /var/opt/gitlab/gitaly/config.toml")]),t._v(" "),e("p",[t._v("可以清晰的看到 /var/opt/gitlab/git-data/repositories 这个就是git最终存储的位置")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("socket_path = '/var/opt/gitlab/gitaly/gitaly.socket'\n\ninternal_socket_dir = '/var/opt/gitlab/gitaly/internal_sockets'\nbin_dir = '/opt/gitlab/embedded/bin'\n\n\n# Optional: export metrics via Prometheus\nprometheus_listen_addr = 'localhost:9236'\n\n\n[[storage]]\nname = 'defau://www.postgresql.org/docs/12/app-psql.htmlt'\npath = '/var/opt/gitlab/git-data/repositories'\n\n[logging]\nformat = 'json'\ndir = '/var/log/gitlab/gitaly'\n\n\n[auth]\n\n[git]\n\n\n[gitaly-ruby]\ndir = \"/opt/gitlab/embedded/service/gitaly-ruby\"\nrugged_git_config_search_path = \"/opt/gitlab/embedded/etc\"\n\n[gitlab-shell]\ndir = \"/opt/gitlab/embedded/service/gitlab-shell\"\ngitlab_url = 'http://127.0.0.1:8080'\n")])])]),e("h4",{attrs:{id:"日志logrotate"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#日志logrotate"}},[t._v("#")]),t._v(" 日志logrotate")]),t._v(" "),e("p",[t._v("/var/opt/gitlab/logrotate/logrotate.conf")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("include /var/opt/gitlab/logrotate/logrotate.d/nginx\ninclude /var/opt/gitlab/logrotate/logrotate.d/puma\ninclude /var/opt/gitlab/logrotate/logrotate.d/actioncable\ninclude /var/opt/gitlab/logrotate/logrotate.d/unicorn\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-rails\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-shell\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-workhorse\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-pages\n")])])]),e("h2",{attrs:{id:"maintenance-维护"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#maintenance-维护"}},[t._v("#")]),t._v(" Maintenance 维护")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/omnibus/maintenance/README.html")]),t._v(" "),e("h3",{attrs:{id:"停止服务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#停止服务"}},[t._v("#")]),t._v(" 停止服务")]),t._v(" "),e("p",[t._v("gitlab-ctl stop的坑：如果刚好你还在某个console里面，stop虽然显示全部down，但是ps -e|grep gitlab以及ps -e|grep postgres还是会看到一堆服务，")]),t._v(" "),e("p",[e("s",[t._v("所以退出正在使用的所有gitlab console，再一次执行gitlab-ctl stop，实在不行进行kill -9或者gitlab-ctl kill "),e("service")],1)]),t._v(" "),e("p",[t._v("最终发现还需要关闭一个服务：")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("systemctl disable gitlab-runsvdir\nsystemctl stop gitlab-runsvdir\n")])])]),e("h3",{attrs:{id:"升级-卸载"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级-卸载"}},[t._v("#")]),t._v(" 升级 卸载")]),t._v(" "),e("p",[t._v("1、停止gitlab\n"),e("code",[t._v("gitlab-ctl stop")])]),t._v(" "),e("p",[t._v("2、卸载gitlab（注意这里写的是gitlab-ce）\n"),e("code",[t._v("rpm -e gitlab-ce")])]),t._v(" "),e("p",[t._v("3、查看gitlab进程\n"),e("code",[t._v("ps aux | grep gitlab")])]),t._v(" "),e("p",[e("code",[t._v("ps -e | grep gitlab")])]),t._v(" "),e("p",[t._v("4、杀掉第一个进程（就是带有好多.............的进程）\n"),e("code",[t._v("kill -9 18777")])]),t._v(" "),e("p",[t._v("杀掉后，在ps aux | grep gitlab确认一遍，还有没有gitlab的进程")]),t._v(" "),e("p",[t._v("5、删除所有包含gitlab文件\n"),e("code",[t._v("find / -name gitlab | xargs rm -rf")])]),t._v(" "),e("h3",{attrs:{id:"gitlab-server-workhorse"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-server-workhorse"}},[t._v("#")]),t._v(" gitlab server(workhorse)")]),t._v(" "),e("p",[t._v("gitlab-rails console >> users and products")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/ee/administration/troubleshooting/navigating_gitlab_via_rails_console.html")]),t._v(" "),e("p",[t._v("密码默认8位")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("user=User.where(username: 'test1').first\nuser.password\nuser.password='12345678'\nuser.password_confirmation='12345678'\nuser.save\nEnqueued ActionMailer::DeliveryJob (Job ID: 1fd0a22c-6908-45bd-b0b1-35f4da4aad25) to Sidekiq(mailers) with arguments: \"DeviseMailer\", \"password_change\", \"deliver_now\", #<GlobalID:0x00007fd3a9a03370 @uri=#<URI::GID gid://gitlab/User/2>>\n=> true\n")])])]),e("p",[t._v("Access control")]),t._v(" "),e("p",[t._v("https://docs.gitlab.com/ee/security/README.html#securing-your-gitlab-installation")])])}),[],!1,null,null,null);a.default=i.exports}}]);