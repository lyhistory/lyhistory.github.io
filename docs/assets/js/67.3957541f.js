(window.webpackJsonp=window.webpackJsonp||[]).push([[67],{272:function(t,e,s){"use strict";s.r(e);var n=s(0),r=Object(n.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[s("a",{attrs:{href:"/docs/software"}},[t._v("回目录")]),t._v("  《postgresql实用基础》")]),t._v(" "),s("h2",{attrs:{id:"_1-setup"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-setup"}},[t._v("#")]),t._v(" 1. Setup")]),t._v(" "),s("p",[t._v("https://www.tutorialspoint.com/postgresql/index.htm\nhttps://serverfault.com/questions/110154/whats-the-default-superuser-username-password-for-postgres-after-a-new-install")]),t._v(" "),s("p",[t._v("Postgresql\nhttps://serverfault.com/questions/110154/whats-the-default-superuser-username-password-for-postgres-after-a-new-install")]),t._v(" "),s("p",[t._v("Server based database\nReplication")]),t._v(" "),s("p",[t._v("su - postgres\npsql")]),t._v(" "),s("p",[t._v("Client\nOffical: Pgadmin 4    https://www.pgadmin.org/download/\nPgadmin3 LTS by BigSQL (don’t support 11g)\nDBeaver (not good)")]),t._v(" "),s("p",[t._v("CLI\nC# 连接 PostgreSQL --- Npgsql的安装和使用 https://blog.csdn.net/chencglt/article/details/77706226")]),t._v(" "),s("p",[t._v("删除“重复”的function或stored procedure，比如：bpchar和varchar：\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql01.png",alt:""}})]),t._v(" "),s("h2",{attrs:{id:"_2-gaps-between-oracle-plsql-and-postgresql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-gaps-between-oracle-plsql-and-postgresql"}},[t._v("#")]),t._v(" 2. Gaps between Oracle PLSQL and PostgreSQL")]),t._v(" "),s("p",[t._v("https://github.com/digoal/blog/blob/master/201607/20160714_01.md")]),t._v(" "),s("p",[t._v("https://wiki.postgresql.org/wiki/Oracle_to_Postgres_Conversion")]),t._v(" "),s("h3",{attrs:{id:"_2-1-oracle-keep-dense-rank-change-in-postgresql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-oracle-keep-dense-rank-change-in-postgresql"}},[t._v("#")]),t._v(" 2.1 oracle keep dense_rank CHANGE in postgresql")]),t._v(" "),s("p",[t._v("https://www.eversql.com/rank-vs-dense_rank-vs-row_number-in-postgresql/")]),t._v(" "),s("h3",{attrs:{id:"_2-2-oracle-is-record-is-table-change-in-postgresql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-oracle-is-record-is-table-change-in-postgresql"}},[t._v("#")]),t._v(" 2.2 oracle is record, is table CHANGE in postgresql")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("type rec_tk is record(\n\ttkno VARCHAR2(100),\n\tcg_zdj number(12, 0) := 0,\n\tcg_jsf number(12, 0) := 0\n);\ntype tklist is table of rec_tk index by binary_integer;\n")])])]),s("p",[t._v("修改为")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("create type rec_tk as(\ntkno VARCHAR(100),\ncg_zdj numeric(12,0),\ncg_jsf numeric(12,0)\n);\n\n#函数外执行创建类型的SQL\ncreate type rec_cjr as(\ncjrid varchar(30),\ntk rec_tk[]\n);\n#函数内对table的使用修改为数组的使用，数组的下标从1开始\np_cjrs rec_cjr[];\n")])])]),s("h2",{attrs:{id:"_3-gramma"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-gramma"}},[t._v("#")]),t._v(" 3. Gramma")]),t._v(" "),s("p",[t._v("Assign null or empty ‘’ to numberic,  to_number(‘’) throw exception, use if else instead\nBigint default value is NULL not 0")]),t._v(" "),s("h3",{attrs:{id:"_3-1-basic"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-basic"}},[t._v("#")]),t._v(" 3.1 Basic")]),t._v(" "),s("p",[s("strong",[t._v("format")]),t._v(":\nhttps://www.postgresql.org/docs/7.4/static/functions-formatting.html\nOracle to_char(param)\npostgresql \tto_char(parma1, ‘999’)\nOracle to_date(str, ‘yyyy-mm-dd hh24:mi:ss’)\nPostgresql to_timestamp(str, ‘yyyy-mm-dd hh24:mi:ss’)\n"),s("strong",[t._v("Datetime")]),t._v("\nhttps://www.postgresql.org/docs/9.1/static/functions-datetime.html\nselect extract (day from timestamp '2011-01-01 01:01:01' - timestamp '2001-01-01 01:01:01');\n"),s("strong",[t._v("System")]),t._v("\nOracle rownum / now(), sysdate\t\npostgresql: limit / now(), CURRENT_DATE\nhttps://thebuild.com/blog/2018/08/07/does-anyone-really-know-what-time-it-is/\n"),s("strong",[t._v("Concat")]),t._v("\nCharacter string connector (||) will fail in postgresql when there is ‘’ or null\nconcat()\nFormat\tv_sql := format($$select * from table where col1=%s$$,’test’)\n"),s("strong",[t._v("NULL and empty string")]),t._v("\nAssign null or empty ‘’ to numberic,  to_number(‘’) throw exception, use if else instead\nBigint default value is NULL not 0\nOracle NVL()\nPGSQL coalesce()\n"),s("strong",[t._v("Returning into")]),t._v("\nhttps://stackoverflow.com/questions/7191902/cannot-select-from-update-returning-clause-in-postgres\nOracle: SQL%ROWCOUNT\nPG: GET DIAGNOSTICS integer_var = ROW_COUNT;")]),t._v(" "),s("p",[s("strong",[t._v("Tables and Views")]),t._v("\nThe new query must generate the same columns that were generated by the existing view query (that is, the same column names in the same order and with the same data types) (...)")]),t._v(" "),s("h3",{attrs:{id:"_3-2-crud"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-crud"}},[t._v("#")]),t._v(" 3.2 CRUD")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Oracle bulk collect into\nPgsql Offset \n/*CREATE TYPE t_my AS (\n    col1    numeric(16,6),\n    col2    numeric,\n    col3 bpchar(36)\n    );*/\n    \ndo $$DECLARE   \nc cursor(os int) for select * from table limit 5 offset os;\nr record;\nv_name varchar(100)[];\nrecs t_my[];\nBEGIN\n\n    select array (select row(0, col, 'aaa') from table1 limit 5 offset 10 ) into recs;\n    --v_games:= array_to_string(v_name,',');\n    raise notice '%', recs[1].col1;\nEND\n$$;\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("Oracle merge into\nPgsql insert into\nhttps://www.postgresql.org/docs/9.5/static/sql-insert.html\ninsert into table1 as t1(col1,col2, col3)\nselect col1, col2,col3\nfrom ( select col1,col2, max(col3) as col3\n from table2\n where col3 >= date'2012-01-01'\n and col3 <date'2013-01-01'\n and col1 is not null\n and col2 is not null\n group by col1, col2 ) a\non conflict(col1, col2) do\nupdate set col3 = excluded.col3,\n   \t col2 = case when excluded.col2 is null then t1.col2 else excluded.col2 end\n\n")])])]),s("p",[t._v("For update")]),t._v(" "),s("h3",{attrs:{id:"_3-3-functions-stored-procedure"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-functions-stored-procedure"}},[t._v("#")]),t._v(" 3.3 Functions & Stored Procedure")]),t._v(" "),s("p",[t._v("Use the right type, character to numeric\nv_product := to_number(p_walletcode);")]),t._v(" "),s("p",[t._v("Dont use FROM DUAL in procedrue")]),t._v(" "),s("p",[t._v("Json")]),t._v(" "),s("p",[t._v("Json array\nhttps://stackoverflow.com/questions/24006291/postgresql-return-result-set-as-json-array/24006432")]),t._v(" "),s("p",[t._v("PostgreSQL Error Codes:\narray_length(array[1,2,3], 1) https://www.postgresql.org/docs/9.1/static/functions-array.html")]),t._v(" "),s("p",[s("strong",[t._v("Transaction")])]),t._v(" "),s("p",[t._v("Cursor:\nhttps://www.postgresql.org/docs/11/static/sql-call.html")]),t._v(" "),s("p",[t._v("cannot commit while a subtransaction is active to_json")]),t._v(" "),s("p",[t._v("https://hashrocket.com/blog/posts/faster-json-generation-with-postgresql\nselect row_to_json(t) from ( select id, text from words ) t")]),t._v(" "),s("p",[s("strong",[t._v("Functions")])]),t._v(" "),s("p",[t._v("Perform function\nhttps://stackoverflow.com/questions/18315633/calling-functions-with-exec-instead-of-select")]),t._v(" "),s("p",[s("strong",[t._v("Dynamic sql")]),t._v("\nhttps://stackoverflow.com/questions/12780275/dynamic-sql-query-in-postgres\nexecute immediate v_sql into v_count;")]),t._v(" "),s("p",[s("strong",[t._v("Cursor and fetch")]),t._v("\nhttps://www.postgresql.org/docs/9.3/static/sql-fetch.html\nhttps://www.postgresql.org/docs/9.3/static/plpgsql-cursors.html\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql02.png",alt:""}})]),t._v(" "),s("p",[s("strong",[t._v("Exception handling")]),t._v("\nhttps://www.postgresql.org/docs/8.2/static/plpgsql-statements.html\nNo data found\nSelect into strict")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("SELECT * INTO myrec FROM emp WHERE empname = myname;\nIF NOT FOUND THEN\n\tRAISE EXCEPTION 'employee % not found', myname;\nEND IF;\n")])])]),s("p",[t._v("If the STRICT option is specified, the query must return exactly one row or a run-time error will be reported, either NO_DATA_FOUND (no rows) or TOO_MANY_ROWS (more than one row). You can use an exception block if you wish to catch the error, for example:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("BEGIN\n    SELECT * INTO STRICT myrec FROM emp WHERE empname = myname;\n    EXCEPTION\n        WHEN NO_DATA_FOUND THEN\n            RAISE EXCEPTION 'employee % not found', myname;\n        WHEN TOO_MANY_ROWS THEN\n            RAISE EXCEPTION 'employee % not unique', myname;\nEND;\n")])])]),s("h3",{attrs:{id:"_3-4-advanced"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-advanced"}},[t._v("#")]),t._v(" 3.4 Advanced")]),t._v(" "),s("p",[s("strong",[t._v("Temp table")]),t._v("\nhttps://github.com/yallie/pg_global_temp_tables\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql03.png",alt:""}})]),t._v(" "),s("p",[s("strong",[t._v("Sequence")]),t._v("\nhttps://www.postgresql.org/docs/8.2/static/functions-sequence.html")]),t._v(" "),s("p",[s("strong",[t._v("Customized Types")])]),t._v(" "),s("p",[t._v("https://www.postgresql.org/docs/9.6/static/sql-createtype.html")]),t._v(" "),s("p",[t._v("CREATE TYPE “XYZ” AS TABLE OF VARCHAR2(104) in postgresql https://stackoverflow.com/questions/24017175/create-type-xyz-as-table-of-varchar2104-in-postgresql")]),t._v(" "),s("p",[t._v("Array[] as input\nhttps://www.postgresql.org/docs/9.1/static/arrays.html\nhttps://stackoverflow.com/questions/570393/postgres-integer-arrays-as-parameters")]),t._v(" "),s("p",[t._v("https://stackoverflow.com/questions/3660787/how-to-list-custom-types-using-postgres-information-schema")]),t._v(" "),s("p",[s("strong",[t._v("Analysis")]),t._v("\nWindow function\nhttps://www.postgresql.org/docs/11/static/tutorial-window.html\nhttps://gist.github.com/dialogbox/454380d6a68344556350bb8dbf1d64e5")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("select  col1, col2, min(col3)  points\n from (select t1.col1, t1.col2,\n        \tfirst_value(col3) over w as col3  \n        \tfrom table1  t1\n        \twhere t1.date >= to_date('2018-01-01','yyyy-mm-dd')\n        \tand t1.date<to_date('2018-07-01','yyyy-mm-dd')\n        \twindow w AS(\n   \t\t\t partition by col1,col2\n   \t\t\t order by date desc\n   \t\t )      \t \n) t group by col1, col2\norder by 1,2;\n")])])]),s("p",[s("strong",[t._v("Dynamic cursor")])]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("In sp pg_test:\n\tINOUT results refcursor)\n\tresults := 'cur';\n_query_:=’select * from table’;\nperform pg_dyncursor('cur', _query_);\nThen in plsql:\n\tBegin\n\t\tCall pg_test();\n\tEnd;\nFETCH ALL IN cur;\nclose cur;\n\nCREATE OR REPLACE FUNCTION pg_dyncursor(cursor_name text, query text)\n\tRETURNS void\n\tLANGUAGE plpgsql\nAS $function$\nDECLARE\nBEGIN \n\tEXECUTE 'DECLARE' || quote_ident(cursor_name) || ' CURSOR WITH HOLD FOR ' || query;\nEND \n$function$\n")])])]),s("p",[s("strong",[t._v("Scheduler")])]),t._v(" "),s("p",[t._v("https://github.com/citusdata/pg_cron\nhttps://crontab.guru/")]),t._v(" "),s("p",[t._v("SELECT cron.schedule('0 2 * * *', $$TODO$$);\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql04.png",alt:""}}),t._v("\nhttps://www.pgadmin.org/docs/pgadmin3/1.22/pgagent.html")]),t._v(" "),s("p",[s("strong",[t._v("Message Flow / Protocol Flow")]),t._v("\nhttps://www.postgresql.org/docs/11/static/protocol-flow.html\nSimple query:\nRecommended practice is to code frontends in a state-machine style that will accept any message type at any time that it could make sense, rather than wiring in assumptions about the exact sequence of messages\nExtended query:")]),t._v(" "),s("h2",{attrs:{id:"_4-drivers"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-drivers"}},[t._v("#")]),t._v(" 4. Drivers")]),t._v(" "),s("h3",{attrs:{id:"_4-1-net-npgsql"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-net-npgsql"}},[t._v("#")]),t._v(" 4.1 .NET npgsql")]),t._v(" "),s("p",[t._v("https://github.com/npgsql")]),t._v(" "),s("p",[s("strong",[t._v("about composite array")]),t._v("\nNormal Array")]),t._v(" "),s("p",[t._v("Array of Composite Type (custom type)\nFeature added in 4.0\nhttp://www.npgsql.org/doc/release-notes/4.0.html\nhttps://github.com/npgsql/npgsql/blob/fc1e183103ac6246bcb5d7ceacbf509e18248583/test/Npgsql.Tests/Types/CompositeTests.cs\nhttps://github.com/npgsql/npgsql/commit/fc1e183103ac6246bcb5d7ceacbf509e18248583")]),t._v(" "),s("p",[t._v("Composite\nhttps://github.com/npgsql/npgsql/issues/1678")]),t._v(" "),s("p",[t._v("Why do I get “Invalid attempt to call HasRows when reader is closed” with an open connection? https://stackoverflow.com/questions/13968342/why-do-i-get-invalid-attempt-to-call-hasrows-when-reader-is-closed-with-an-ope")]),t._v(" "),s("p",[s("strong",[t._v("about inout parameters in stored procedure")]),t._v("\n这个问题是我测试当时最新版本的postgresql并且用了最新的npgsql driver的时候遇到一个问题，\n就是存储过程的inout参数拿不到返回结果，经过研究发现奇怪的行为：\n1.通过更改npgsql的代码采用simple query这种不安全的协议就可以拿到结果；\n2.但是用ngpsql自身默认的extend协议就拿不到；\n后来跟ngpsql作者沟通，npgsql作者又跟pgsql的团队沟通，证明确实是pgsql的一个bug，沟通见下面我提的ticket：\nINOUT parameters from Procedure\nhttps://github.com/npgsql/npgsql/issues/2078\nhttps://github.com/npgsql/npgsql/issues/2006")]),t._v(" "),s("p",[t._v("下面是我思考并研究的大致过程，\n大致思路就是我发现用某些pgsql客户端调用这种存储过程有返回，有些没有返回，比如pgadmin有返回，dbeaver没有返回，\n所以就抓包pgadmin，对比通过npgsql调用的包，最后发现pgadmin是用simple query方式调用，\n所以最终修改了npgsql驱动让其支持simple query，因为本身simple query就不安全，所以我没有给出代码，\n当然如果有人感兴趣可以联系我")]),t._v(" "),s("p",[t._v("Test Scripts")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("call pg_test('9cc4afef-aab7-4c35-bdcd-a9f3d0152eb4','');\n\nbegin\ncall pg_test2('9cc4afef-aab7-4c35-bdcd-a9f3d0152eb4','');\nfetch all in cur;\ncommit;\nend\n\n-- PROCEDURE: sgc2.pg_test(character varying, text)\n\n-- DROP PROCEDURE sgc2.pg_test(character varying, text);\n\nCREATE OR REPLACE PROCEDUREpg_test(\n\tuserid character varying,\n\tINOUT results text)\nLANGUAGE 'plpgsql'\n\nAS $BODY$\nDECLARE\n\nBEGIN\n\t\n\tselect cast(999 as decimal) as result;\n\nEND;\n$BODY$;\n")])])]),s("p",[t._v("c# code:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('public string Execute2(string spName, IEnumerable<NpgsqlParameter> parameters)\n       {\n           string result;\n           try\n           {\n               using (var conn = new NpgsqlConnection(_connectionString))\n               {\n                   conn.Open();\n                   List<NpgsqlParameter> _params = parameters.ToList();\n                   using (var cmd = conn.CreateCommand())\n                   {\n                       _params.Add(new NpgsqlParameter("", "")); // Add empty string for refcursor param\n                       cmd.CommandText = BuildQuery(spName, _params);\n                       //cmd.Parameters.Add(new NpgsqlParameter() { ParameterName = "results", Direction = ParameterDirection.InputOutput, Value = "" });\n                       var res = cmd.ExecuteScalar();\n                       result = res?.ToString();\n                  \n                   }\n                   //string sql = "select pg_test3(\'9cc4afef-aab7-4c35-bdcd-a9f3d0152eb4\');";\n                   //var cmd2 = new NpgsqlCommand(sql, conn);\n                   //var result2 = cmd2.ExecuteScalar();\n                   //var test = JsonConvert.DeserializeObject<ResultModel>(result);\n                   conn.Close();\n               }\n           }\n           catch (Exception e)\n           {\n               _log.Exception(e);\n               throw;\n           }\n           return result;\n       }\n\n')])])]),s("p",[t._v("debug output:\nCheck from Immediate window\nSystem.Text.Encoding.Default.GetString(Buffer)")]),t._v(" "),s("p",[s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql05.png",alt:""}})]),t._v(" "),s("p",[t._v("然后用wireshark抓包请求call sp之后的返回\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql06.png",alt:""}})]),t._v(" "),s("p",[t._v("Failed idea: Compare with SP which has return value(refcursor)\nNot what I want!\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql07.png",alt:""}})]),t._v(" "),s("p",[t._v("Idea: compare with pgadmin4, because pgadmin4 works!\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql08.png",alt:""}})]),t._v(" "),s("p",[t._v("改源码 simple query\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql09.png",alt:""}}),t._v("\n有返回，离成功近了")]),t._v(" "),s("p",[t._v("但是npg抛错\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql10.png",alt:""}})]),t._v(" "),s("p",[t._v("Idea: Compare with simple function( and procedure) to observer the result\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql11.png",alt:""}})]),t._v(" "),s("p",[t._v("最终\n"),s("img",{attrs:{src:"/docs/docs_image/software/postgresql/postgresql12.png",alt:""}})]),t._v(" "),s("p",[t._v("Nuget\nUpdate-Package –reinstall\nhttps://docs.microsoft.com/en-us/nuget/consume-packages/reinstalling-and-updating-packages")]),t._v(" "),s("p",[t._v("Simple query\nhttps://www.postgresql.org/docs/10/static/protocol-flow.html#id-1.10.5.7.4\nMessage flow\nhttps://www.postgresql.org/docs/10/static/protocol-flow.html")]),t._v(" "),s("p",[t._v("Explain\nhttps://www.postgresql.org/docs/9.5/static/sql-explain.html")]),t._v(" "),s("p",[t._v("Refer\nhttps://www.asciitable.com")])])}),[],!1,null,null,null);e.default=r.exports}}]);