(window.webpackJsonp=window.webpackJsonp||[]).push([[219],{649:function(e,t,a){"use strict";a.r(t);var r=a(65),n=Object(r.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[a("a",{attrs:{href:"/docs/software"}},[e._v("回目录")]),e._v("  《分布式框架zookeeper》")]),e._v(" "),a("h2",{attrs:{id:"quickstart"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#quickstart"}},[e._v("#")]),e._v(" QuickStart:")]),e._v(" "),a("h3",{attrs:{id:"install-usage"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install-usage"}},[e._v("#")]),e._v(" Install & usage")]),e._v(" "),a("p",[e._v("https://cwiki.apache.org/confluence/display/ZOOKEEPER/Index\nhttps://zookeeper.apache.org/doc/current/index.html")]),e._v(" "),a("p",[e._v("https://docs.confluent.io/platform/current/zookeeper/deployment.html")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('tar zxvf zookeeper-3.4.8.tar.gz \n\nmkdir -p /opt/dependency/zookeeper-3.4.8/zkdata\nmkdir -p /opt/dependency/zookeeper-3.4.8/logs \n\n\n集群配置：\nThis example is for a 3 node ensemble：\n\n# The number of milliseconds of each tick                      \ntickTime=2000                                                  \n# The number of ticks that the initial                         \n# synchronization phase can take                               \ninitLimit=10                                                   \n# The number of ticks that can pass between                    \n# sending a request and getting an acknowledgement             \nsyncLimit=5                                                    \n# the directory where the snapshot is stored.                  \n# do not use /tmp for storage, /tmp here is just               \n# example sakes.                                               \ndataDir=/opt/dependency/zookeeper-3.4.8/zkdata           \ndataLogDir=/opt/dependency/zookeeper-3.4.8/logs          \n# the port at which the clients will connect                   \nclientPort=2181                                                \nserver.1=1.1.1.1:2888:3888                               \nserver.2=1.1.1.2:2888:3888                               \nserver.3=1.1.1.3:2888:3888                               \nSERVER_JVMFLAGS=-Xmx1024m\'       \n\n然后在各个节点上分别写入 1 2 3等到myid：\n$ echo "1" > /zookeeper/zkdata/myid\n\n好像还有个 zookeeper_server.pid?\n')])])]),a("p",[e._v("？Failed to start and no log\nResolved: yum install glibc.i686")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("./bin/zkServer.sh start-foreground\n")])])]),a("p",[e._v("https://zookeeper.apache.org/doc/r3.3.3/zookeeperStarted.html")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("bin/zkCli.sh -server 127.0.0.1:2181\n[zk: localhost:2181(CONNECTED) 0] help\n[zk: localhost:2181(CONNECTED) 0] ls /\n[zk: localhost:2181(CONNECTED) 0] get /test\n[zk: localhost:2181(CONNECTED) 0] ls /test mywatcher\n[zk: localhost:2181(CONNECTED) 0] delete /test\n[zk: localhost:2181(CONNECTED) 0] rmr /test\t\n[zk: localhost:2181(CONNECTED) 0] stat /brokers/topics/T-MEMBER\n")])])]),a("h3",{attrs:{id:"编译源码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编译源码"}},[e._v("#")]),e._v(" 编译源码")]),e._v(" "),a("p",[e._v("https://www.cnblogs.com/MangoCai/p/10846187.html")]),e._v(" "),a("p",[e._v("安装ant，设置%ANT_HOME%\\bin\nCopy ivy.jar到ant lib\n根节点 ant eclipse\nEclipse导入普通java project，修改build path jdk和compliance\n通过VerGen.java生成Info.java（/org/apache/zookeeper/version）\n"),a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/zookeeper01.png",alt:""}}),e._v("\nCopy到VerGen.java的上一层package里面")]),e._v(" "),a("p",[e._v("然后两种方式生成jar，\n命令行和eclipse导出\n根目录下执行\nant jar compile-test\n或者\n"),a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/zookeeper02.png",alt:""}})]),e._v(" "),a("p",[e._v("Copy conf/zoo.cfg修改\ndataDir=C:\\Workspace\\Repository\\zookeeper-release-3.5.6\\dataDir")]),e._v(" "),a("p",[e._v("把jar放到根目录下，\n运行\n"),a("code",[e._v("/bin/zkServer.cmd /bin/zkCli.cmd")])]),e._v(" "),a("h3",{attrs:{id:"管理脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#管理脚本"}},[e._v("#")]),e._v(" 管理脚本")]),e._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("readonly")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("PROGNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("basename")]),e._v(" $0"),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("readonly")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("PROGDIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),e._v("readlink -m "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("$(")]),e._v("dirname $0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# source env")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_INVOCATION_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("pwd")]),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v(")")])]),e._v('"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_CMD_DIR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/opt/scripts"')]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${L_INVOCATION_DIR}")]),e._v('"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${L_CMD_DIR}")]),e._v('"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("then")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("pushd")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${L_CMD_DIR}")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&>")]),e._v(" /dev/null\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("fi")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#source ../set_env.sh")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#--------------- Function Definition ---------------#")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token function-name function"}},[e._v("showUsage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Usage:"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$0")]),e._v(' zookeeper start|kill"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('""')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"--start or -b:  Start zookeeper"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"--kill or -k:   Stop zookeeper"')]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"--status or -s: Check zookeeper status"')]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("#---------------  Main ---------------#")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Parse arguments")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("while")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${1"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("0"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("1}")]),e._v('"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("==")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"-"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("do")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("case")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$1")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("in")]),e._v("\n    --start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"B"')]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    -b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"B"')]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    --status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"S"')]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    -s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"S"')]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        --kill"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"K"')]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        -k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"K"')]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n        --kafka"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"KAFKA"')]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    *"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Unknown option: '),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$1")]),e._v('"')]),e._v("\n          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('""')]),e._v("\n      showUsage\n          "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('""')]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("exit")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1")]),e._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("esac")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("shift")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("done")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("L_RETURN_FLAG")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# 0 for success while 99 for failure")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e._v("BIN_HOME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("/opt/zookeeper-3.4.8/bin\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("pushd")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("${BIN_HOME}")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("&>")]),e._v("/dev/null\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$L_FLAG")]),e._v('"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("==")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"B"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("then")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Starting zookeeper service..."')]),e._v("\n        ./zkServer.sh start\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("elif")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$L_FLAG")]),e._v('"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("==")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"K"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("then")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Stopping zookeeper service..."')]),e._v("\n        ./zkServer.sh stop\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("elif")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$L_FLAG")]),e._v('"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("==")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"KAFKA"')]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("then")]),e._v("\n        ./zkCli.sh "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("ls")]),e._v(" /brokers/ids\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("else")]),e._v("\n        "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("echo")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Checking zookeeper status..."')]),e._v("\n        ./zkServer.sh status\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("fi")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("exit")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[e._v("$L_RETURN_FLAG")]),e._v("\n")])])]),a("h3",{attrs:{id:"自动启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#自动启动"}},[e._v("#")]),e._v(" 自动启动")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[Unit]\nDescription=The Zookeeper Daemon\nWants=syslog.target\nRequires=network.target\nAfter=network.target\n\n[Service]\nEnvironment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin:/jdk/bin\nType=forking\nUser=root\nExecStart=/bin/zkCli.sh start\n\n[Install]\nWantedBy=multi-user.target\n")])])]),a("h3",{attrs:{id:"admin"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#admin"}},[e._v("#")]),e._v(" admin")]),e._v(" "),a("p",[a("strong",[e._v("New in 3.5.0:")]),e._v(" The following        options are used to configure the "),a("a",{attrs:{href:"https://zookeeper.apache.org/doc/r3.5.4-beta/zookeeperAdmin.html#sc_adminserver",target:"_blank",rel:"noopener noreferrer"}},[e._v("AdminServer"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("admin.enableServer")]),e._v(" "),a("p",[e._v("(Java system property: "),a("strong",[e._v("zookeeper.admin.enableServer")]),e._v(') Set to "false" to disable the AdminServer.  By default the              AdminServer is enabled.')])]),e._v(" "),a("li",[a("p",[e._v("admin.serverAddress")]),e._v(" "),a("p",[e._v("(Java system property: "),a("strong",[e._v("zookeeper.admin.serverAddress")]),e._v(") The address the embedded Jetty server listens on. Defaults to 0.0.0.0.")])]),e._v(" "),a("li",[a("p",[e._v("admin.serverPort")]),e._v(" "),a("p",[e._v("(Java system property: "),a("strong",[e._v("zookeeper.admin.serverPort")]),e._v(") The port the embedded Jetty server listens on.  Defaults to 8080.")])]),e._v(" "),a("li",[a("p",[e._v("admin.idleTimeout")]),e._v(" "),a("p",[e._v("(Java system property: "),a("strong",[e._v("zookeeper.admin.idleTimeout")]),e._v(") Set the maximum idle time in milliseconds that a connection can wait                           before sending or receiving data. Defaults to 30000 ms.")])]),e._v(" "),a("li",[a("p",[e._v("admin.commandURL")]),e._v(" "),a("p",[e._v("(Java system property: "),a("strong",[e._v("zookeeper.admin.commandURL")]),e._v(') The URL for listing and issuing commands relative to the              root URL.  Defaults to "/commands".')])])]),e._v(" "),a("h3",{attrs:{id:"things-to-avoid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#things-to-avoid"}},[e._v("#")]),e._v(" Things to Avoid")]),e._v(" "),a("p",[e._v("Here are some common problems you can avoid by configuring      ZooKeeper correctly:")]),e._v(" "),a("ul",[a("li",[a("p",[e._v("inconsistent lists of servers")]),e._v(" "),a("p",[e._v("The list of ZooKeeper servers used by the clients must match            the list of ZooKeeper servers that each ZooKeeper server has.            Things work okay if the client list is a subset of the real list,            but things will really act strange if clients have a list of            ZooKeeper servers that are in different ZooKeeper clusters. Also,            the server lists in each Zookeeper server configuration file            should be consistent with one another.")])]),e._v(" "),a("li",[a("p",[e._v("incorrect placement of transaction log")]),e._v(" "),a("p",[e._v("The most performance critical part of ZooKeeper is the            transaction log. ZooKeeper syncs transactions to media before it            returns a response. A dedicated transaction log device is key to            consistent good performance. Putting the log on a busy device will            adversely effect performance. If you only have one storage device,            put trace files on NFS and increase the snapshotCount; it doesn't            eliminate the problem, but it should mitigate it.")])]),e._v(" "),a("li",[a("p",[e._v("incorrect Java heap size")]),e._v(" "),a("p",[e._v("You should take special care to set your Java max heap size            correctly. In particular, you should not create a situation in            which ZooKeeper swaps to disk. The disk is death to ZooKeeper.            Everything is ordered, so if processing one request swaps the            disk, all other queued requests will probably do the same. the            disk. DON'T SWAP. Be conservative in your estimates: if you have 4G of RAM, do            not set the Java max heap size to 6G or even 4G. For example, it            is more likely you would use a 3G heap for a 4G machine, as the            operating system and the cache also need memory. The best and only            recommend practice for estimating the heap size your system needs            is to run load tests, and then make sure you are well below the            usage limit that would cause the system to swap.")])]),e._v(" "),a("li",[a("p",[e._v("Publicly accessible deployment")]),e._v(" "),a("p",[e._v("​              A ZooKeeper ensemble is expected to operate in a trusted computing environment.              It is thus recommended to deploy ZooKeeper behind a firewall.")])])]),e._v(" "),a("h2",{attrs:{id:"工具-日志排查"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#工具-日志排查"}},[e._v("#")]),e._v(" 工具/日志排查")]),e._v(" "),a("p",[e._v("./bin/zkServer.sh start-foreground")]),e._v(" "),a("p",[e._v("https://zookeeper.apache.org/doc/r3.3.2/zookeeperAdmin.html")]),e._v(" "),a("p",[e._v("工具集合：")]),e._v(" "),a("p",[e._v("https://github.com/apache/zookeeper/blob/master/zookeeper-docs/src/main/resources/markdown/zookeeperTools.md")]),e._v(" "),a("h3",{attrs:{id:"application-log"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#application-log"}},[e._v("#")]),e._v(" Application Log")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("zkServer.sh start的log默认是在：\n/bin/zookeeper.out\n\n使用/conf/log4j.properties 设置为 zookeeper.log\nhttps://stackoverflow.com/questions/28691341/zookeeper-log-file-not-created-inside-logs-directory\nhttps://stackoverflow.com/questions/26612908/why-does-zookeeper-not-use-my-log4j-properties-file-log-directory\n\n实例：\n发现某个节点\nnetstat -anp|grep :2181 以及\nnetstat -anp|grep :2888 （ensemble节点互通端口）\n出现大量的time_wait tcp连接，来自于各个节点，\n最后通过查看\ntail -f /bin/zookeeper.out 发现：\n2021-04-06 20:58:23,958 [myid:1] - WARN  [QuorumPeer[myid=1]/0.0.0.0:2181:Follower@89] - Exception when following the leader\njava.io.IOException: Permission denied                                                                       \n        at java.io.UnixFileSystem.createFileExclusively(Native Method)                \n        at java.io.File.createNewFile(File.java:1012) \n        at org.apache.zookeeper.server.quorum.Learner.syncWithLeader(Learner.java:436)                   \n        at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:82)\n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:846)                      \n2021-04-06 20:58:23,959 [myid:1] - INFO  [QuorumPeer[myid=1]/0.0.0.0:2181:Follower@166] - shutdown called    java.lang.Exception: shutdown Follower  \n\t\tat org.apache.zookeeper.server.quorum.Follower.shutdown(Follower.java:166)                   \n        at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:850) \n2021-04-06 20:58:23,959 [myid:1] - INFO  [QuorumPeer[myid=1]/0.0.0.0:2181:FollowerZooKeeperServer@140] - Shutting down\n然后通过permission denied判断是权限问题，因为启动的时候是用的普通user，发现\nfind zookeeper/ -group root\n发现了zkdata下面的文件都是root的，修改权限即可\nhttps://stackoverflow.com/questions/54087210/kafka-create-too-many-time-wait-tcp-connection/66969946#66969946\n其他类似案例：https://www.cnblogs.com/duanxz/p/3768454.html\n")])])]),a("h3",{attrs:{id:"data-log"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#data-log"}},[e._v("#")]),e._v(" Data Log")]),e._v(" "),a("p",[e._v("https://stackoverflow.com/questions/17894808/how-do-one-read-the-zookeeper-transaction-log")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("--- 3.6 之前版本\n具体log4j版本可以在zookeeper目录下/lib里面去看\n\njava -cp /zookeeper-3.4.8/zookeeper-3.4.8.jar:lib/log4j-1.2.16.jar:lib/slf4j-log4j12-1.6.1.jar:lib/slf4j-api-1.6.1.jar org.apache.zookeeper.server.LogFormatter /zookeeper-3.4.8/logs/version-2/log.100000001 >  /home/test/zookeeper\n\n\n--- 3.6后版本\nFor transaction log:\nbin/zkTxnLogToolkit.sh --dump /datalog/version-2/log.f3aa6 \nFor snapshots:\n./zkSnapShotToolkit.sh -d /data/zkdata/version-2/snapshot.fa01000186d\n")])])]),a("p",[e._v("Admin\nhttps://zookeeper.apache.org/doc/current/zookeeperAdmin.html")]),e._v(" "),a("p",[e._v("troubleshooting\nhttps://cwiki.apache.org/confluence/display/ZOOKEEPER/Troubleshooting")]),e._v(" "),a("p",[e._v("somoktest latency\nhttps://cwiki.apache.org/confluence/display/ZOOKEEPER/ServiceLatencyOverview")]),e._v(" "),a("p",[e._v("Jmx\nhttps://zookeeper.apache.org/doc/current/zookeeperJMX.html#")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("vim bin/zkServer.sh\n找到ZOODAMIN=\"\"  添加 -Djava.rmi.server.hostname=$JMXHOSTNAME\n\n到conf下面添加java.env:\nJMXHOSTNAME=''\nJMXPORT=2182\n")])])]),a("p",[e._v("?Failed to resolve hostname, malformed url\nedit /etc/hosts,add 127.0.0.1 "),a("hostname")],1),e._v(" "),a("p",[e._v("jconsole\nFour letter words\nhttps://zookeeper.apache.org/doc/r3.4.13/zookeeperAdmin.html#sc_zkCommands")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("echo dump | nc localhost 2181\n")])])]),a("p",[e._v("Baseline\nhttps://cwiki.apache.org/confluence/display/ZOOKEEPER/ServiceLatencyOverview")]),e._v(" "),a("h2",{attrs:{id:"开发-programming"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开发-programming"}},[e._v("#")]),e._v(" 开发 programming")]),e._v(" "),a("p",[e._v("https://cwiki.apache.org/confluence/display/ZOOKEEPER/ErrorHandling\nhttps://zookeeper.apache.org/doc/current/zookeeperProgrammers.html")]),e._v(" "),a("h2",{attrs:{id:"原理解读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原理解读"}},[e._v("#")]),e._v(" 原理解读")]),e._v(" "),a("p",[a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/zookeeper03.png",alt:""}}),e._v(" "),a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/zookeeper04.png",alt:""}}),e._v(" "),a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/zookeeper05.png",alt:""}}),e._v("\nSemaphores\nQueues\nLeader election\nGroup membership\nBarriers\nConfiguration")]),e._v(" "),a("p",[e._v("ZooKeeper has a built-in sanity check of 1M, to prevent it from being used as a large data store, but in general it is used to store much smaller pieces of data.\nzxid (ZooKeeper Transaction Id). Each update will have a unique zxid\n分布式协调，通过观察者模式，rpc通知客户端节点变化，默认的客户端有：\n自带的zkCli.sh以及org.apache.zookeeper 客户端lib jar包\n还有curator高级开发API\nzookeeper事件触发是通过推拉的方式，先通知watcher客户端节点变动，然后客户端再去pull下来新增或变化的节点信息；\nWatcher机制/观察者模式\nhttps://www.jianshu.com/p/4c071e963f18")]),e._v(" "),a("h2",{attrs:{id:"源码解读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#源码解读"}},[e._v("#")]),e._v(" 源码解读")]),e._v(" "),a("p",[e._v("Apache ZooKeeper Watcher 机制源码解释 https://www.ibm.com/developerworks/cn/opensource/os-cn-apache-zookeeper-watcher/index.html\nZookeeper源码分析之客户端源码解密 https://www.jianshu.com/p/06e859181cc0\nZookeeper源码分析之curator客户端 https://www.jianshu.com/p/bc5e24e4f614")]),e._v(" "),a("p",[a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/zookeeper10.png",alt:""}})]),e._v(" "),a("h3",{attrs:{id:"server端代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#server端代码"}},[e._v("#")]),e._v(" server端代码")]),e._v(" "),a("p",[e._v("server下面的FinalRequestProcessor是终极请求处理类，所有server收到的请求最终都是流向这里，下面看看如果triggerWatcher的流程：\n"),a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/zookeeper11.png",alt:""}}),e._v("\n然后进去看watcher 的process")]),e._v(" "),a("p",[e._v("可以看到zookeeper server“调用客户端”的watch通知是通过跟客户端的socket连接直接返回response，然后客户端收到请求后会反序列化调用自己实现的watch接口方法\nzookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/NIOServerCnxn.java\n这里的NIOServerCnxn间接继承自Watcherzookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/ServerCnxn.java\npublic abstract class ServerCnxn implements Stats, Watcher {\n记住这里的ServerCnxn，后面会讲解client端对应的ClientCnxn")]),e._v(" "),a("h3",{attrs:{id:"zookeeper-client端代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#zookeeper-client端代码"}},[e._v("#")]),e._v(" Zookeeper client端代码")]),e._v(" "),a("p",[e._v("Client由三个主要模块组成：Zookeeper, WatcherManager, ClientCnxn\nZookeeper是ZK Client端的接口，\nWatcherManager，管理ZK Client绑定的所有Watcher。\nClientCnxn是管理所有网络IO的模块，所有和ZK Server交互的信息和数据都经过这个模块")]),e._v(" "),a("p",[e._v("zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeper.java\nclientWatchManager用于存储管理客户端连过来的watcher")]),e._v(" "),a("p",[e._v("首先是zookeeper server自带的cli工具：\nzookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeperMain.java")]),e._v(" "),a("p",[e._v("然后是zookeeper client端代码：\n客户端收到消息后，会调用 ClientCnxn 的 SendThread.readResponse 方法来进行统一处理，如果响应头 replyHdr 中标识的 Xid 为 02，表示是 ping，如果为-4，表示是验证包，如果是-1，表示这是一个通知类型的响应，然后进行反序列化、处理 chrootPath、还原 WatchedEvent、回调 Watcher 等步骤，其中回调 Watcher 步骤将 WacthedEvent 对象交给 EventThread 线程，在下一个轮询周期中进行 Watcher 回调；\n补充：ClientCnxnSocket会读取socket连接，发现connected信息也将交由SendThread的onconnected处理\nzookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java")]),e._v(" "),a("p",[e._v("SendThread 接收到服务端的通知事件后，会通过调用 EventThread 类的 queueEvent 方法将事件传给 EventThread 线程，queueEvent 方法根据该通知事件，从 ZKWatchManager 中取出所有相关的 Watcher\n客户端在识别出事件类型 EventType 之后，会从相应的 Watcher 存储中删除对应的 Watcher，获取到相关的 Watcher 之后，会将其放入 waitingEvents 队列，该队列从字面上就能理解是一个待处理队列，线程的 run 方法会不断对该该队列进行处理，这就是一种异步处理思维的实现")]),e._v(" "),a("h3",{attrs:{id:"curator-api封装代码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#curator-api封装代码"}},[e._v("#")]),e._v(" Curator api封装代码")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('import org.apache.curator.framework.CuratorFramework;\nimport org.apache.curator.framework.CuratorFrameworkFactory;\nimport org.apache.curator.framework.recipes.leader.LeaderSelector;\nimport org.apache.curator.framework.recipes.leader.LeaderSelectorListenerAdapter;\nimport org.apache.curator.retry.ExponentialBackoffRetry;\n\npublic class LeaderElectionExample {\n\n    private static final String ZK_CONNECTION_STRING = "localhost:2181";\n    private static final String LEADER_PATH = "/leader";\n\n    public static void main(String[] args) throws Exception {\n        CuratorFramework curatorFramework = CuratorFrameworkFactory.newClient(\n                ZK_CONNECTION_STRING,\n                new ExponentialBackoffRetry(1000, 3)\n        );\n        curatorFramework.start();\n\n        LeaderSelector leaderSelector = new LeaderSelector(curatorFramework, LEADER_PATH,\n                new LeaderSelectorListenerAdapter() {\n                    @Override\n                    public void takeLeadership(CuratorFramework curatorFramework) throws Exception {\n                        System.out.println("Node " + curatorFramework.getClientId() + " has become the leader.");\n                        // Implement logic for when this node becomes the leader\n                        Thread.sleep(3000); // Example: Perform leader activities\n                        System.out.println("Node " + curatorFramework.getClientId() + " is relinquishing leadership.");\n                    }\n\n                    @Override\n                    public void stateChanged(CuratorFramework curatorFramework, org.apache.curator.framework.state.ConnectionState connectionState) {\n                        if (connectionState == org.apache.curator.framework.state.ConnectionState.SUSPENDED) {\n                            System.out.println("Node " + curatorFramework.getClientId() + " lost connection to ZooKeeper");\n                        } else if (connectionState == org.apache.curator.framework.state.ConnectionState.RECONNECTED) {\n                            System.out.println("Node " + curatorFramework.getClientId() + " reconnected to ZooKeeper");\n                        } else if (connectionState == org.apache.curator.framework.state.ConnectionState.LOST) {\n                            System.out.println("Node " + curatorFramework.getClientId() + " lost connection and session with ZooKeeper");\n                            // Implement logic for handling loss of session, e.g., shutdown gracefully\n                        }\n                    }\n                });\n\n        leaderSelector.autoRequeue(); // Ensure requeueing of participants upon relinquishing leadership\n        leaderSelector.start();\n\n        // Example: Keep the application running indefinitely to observe leader changes\n        Thread.sleep(Long.MAX_VALUE);\n\n        leaderSelector.close();\n        curatorFramework.close();\n    }\n}\n\n')])])]),a("p",[e._v("七张图彻底讲清楚ZooKeeper分布式锁的实现原理\nhttps://juejin.im/post/5c01532ef265da61362232ed\nZookeeper使用之curator\nhttps://leokongwq.github.io/2018/06/17/zookeeper-curator.html\nCurator分布式锁\nhttps://blog.csdn.net/xuefeng0707/article/details/80588855\nZookeeper Curator 事件监听 - 秒懂\nhttps://www.cnblogs.com/crazymakercircle/p/10228385.html")]),e._v(" "),a("h4",{attrs:{id:"curator-leader-election代码解析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#curator-leader-election代码解析"}},[e._v("#")]),e._v(" curator leader election代码解析")]),e._v(" "),a("p",[a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/curator01.png",alt:""}}),e._v("\n图示上半部分为跟zookeeper断线之后的逻辑，")]),e._v(" "),a("p",[e._v("断线处理很简单，LeaderSelectorListener继承了ConnectionStateListener，\n然后这个listener注册到了CuratorFrameworkImpl维护的listener容器，\n当断线时回调这个listener wrapper，wrapper再回调statechange，然后可以在statechange里面抛出异常从而触发\nleaderSelector.interruptLeadership，其内部就是获取“执行takeleadership的doWorkLoop所在的线程executorService”这个task，然后调用其cancel（boolean java.util.concurrent.Future.cancel(boolean mayInterruptIfRunning)）方法中断操作")]),e._v(" "),a("p",[e._v("额外指出，从架构设计上欣赏的curator的监听器管理，CuratorFrameworkImpl将这些ConnectionStateListener交由ConnectionStateManager来统一管理，当监测到状态变化，\nConnectionStateManager调用注册好的listener的StateChange来通知变化，这是典型的一个抽象出来的状态机管理实现；")]),e._v(" "),a("p",[e._v("下半部分是选举的分布式锁机制，主要的逻辑基石就是zookeeper保证了sequence ephemeral节点的生成，然后后一个节点监听前一个节点，只有前一个节点删除后才会通过watcher去唤醒后面一个等待的节点")]),e._v(" "),a("p",[e._v('curator封装的InterProcessMutex注释：\n/**\n* A re-entrant mutex that works across JVMs. Uses Zookeeper to hold the lock. All processes in all JVMs that\n* use the same lock path will achieve an inter-process critical section. Further, this mutex is\n* "fair" - each user will get the mutex in the order requested (from ZK\'s point of view)\n*/\npublic class InterProcessMutex implements InterProcessLock, Revocable'),a("InterProcessMutex",[e._v("\n所谓跨JMS mutex实际上就是：")])],1),e._v(" "),a("ol",[a("li",[e._v("首先还是要考虑同一个application，即同一个jvm进程中多线程的竞争问题，所以引入了大量的synchronized方法和synchronized(this)方法块，")]),e._v(" "),a("li",[e._v("跨JVMs主要就是利用了StandardLockInternalsDriver的getsTheLock，利用ephemeral sequential先获取当前leader下面注册了多少child，然后当前的node就去pathToWatch前面一个node（children.get(ourIndex - maxLeases)，maxLeases=1）")])]),e._v(" "),a("h4",{attrs:{id:"pathchildrencache解析-zookeeper推拉消息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#pathchildrencache解析-zookeeper推拉消息"}},[e._v("#")]),e._v(" PathChildrenCache解析： zookeeper推拉消息")]),e._v(" "),a("p",[e._v("如果我们直接使用zookeeper client开发，只能自定义各种watcher，然后向zookeeper也就是zookeeper client端接口注册，然后最终注册到zookeeper服务端，\n然后服务端的变化通知watcher，由于watcher是一次性的，所以每次getChildren或getData时都要设置参数项watcher为true，才可以继续监听zknode变化。")]),e._v(" "),a("p",[e._v("而使用Curator封装好的NodeCache PathChildrenCache等类，我们只需要创建实现一个继承了curator相关listener接口的listener，即可实现‘实时’监听zknode变化，不需要再写繁杂的watcher代码；")]),e._v(" "),a("p",[e._v("看看封装好的这个PathChildrenCache，\n"),a("img",{attrs:{src:"/docs/docs_image/software/zookeeper/curator02.png",alt:""}})]),e._v(" "),a("p",[e._v("我们自定义了listener，并向PathChildrenCache提供的listenerContainer注册，然后启动start")]),e._v(" "),a("p",[e._v("启动后，实际上PathChildrenCache并没有将我们自定义的listener注册到curatorFramework client（实际类为CuratorFrameworkImpl），而是自己注册了一个自己的ConnectionStateListener，\n不过这个主要是管理跟zookeeper服务端的连接情况，\n然后OfferOperation会调用refresh(),\n先向curatorFramework注册一个childWatcher，然后第一次比如节点创建后回调callback方法processResult调用processChildren，然后调用getDataAndStat，\n这里又会注册一个dataWatcher，\n当然这两个watcher都是最终是层层转接注册到前面说的zookeeper服务端的，下面我们就先看看到底是怎么层层转到zookeeper client接口的；")]),e._v(" "),a("p",[e._v("上面说了watcher的注册，watcher的作用就是接收zookeeper服务端zknode节点及数据变化，接收的参数WatchedEvent，只是会知道变化的类型：\npublic enum EventType {\nNone (-1),\nNodeCreated (1),\nNodeDeleted (2),\nNodeDataChanged (3),\nNodeChildrenChanged (4);\n然后具体变化还要主动去拉取，\n所以粗略的逻辑是，curatorFramework把收到的watcher注册请求都注册给zookeeper，zookeeper服务端通知客户端watcher，然后curator在PathChildrenCache的watcher再去拉取数据；")]),e._v(" "),a("p",[e._v("这两个watcher注册的地方都是创建者模式builder pattern的fluent API流畅连写：\nclient.getChildren().usingWatcher(childrenWatcher).inBackground(callback).forPath(path);\nclient.getData().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);")]),e._v(" "),a("p",[e._v("下面就以dataWatcher这个来说明：")]),e._v(" "),a("p",[e._v("注意这里的getData()是调用的curatorFramework的，所以实际是拿到dataBuilder，对应的实现类是getDataBuilderImpl，然后最后是落脚在forPath，实际就是调用了\ngetDataBuilderImpl的forPath方法，我们就看下这个的forPath方法：")]),e._v(" "),a("p",[e._v("可以看到，有前台和后台执行两种模式，前台执行很直接，调用zookeeper的getdata，\n继续看后台执行的模式，而后台跑则调用curatorFramework的processBackgroundOperation：\n此时CuratorEvent==null，则isInitialExecution==true,所以只会调用performBackgroundOperation，然后最终是调用接口BackgroundOperation.performBackgroundOperation,\n即最终调用回该接口的引用getDataBuilderImpl的performBackgroundOperation，")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v(" if ( watching.isWatched() )\n{\n\tclient.getZooKeeper().getData(operationAndData.getData(), true, callback, backgrounding.getContext());\n}\nelse\n{\n\tclient.getZooKeeper().getData(operationAndData.getData(), watching.getWatcher(), callback, backgrounding.getContext());\n}\n")])])]),a("p",[e._v("真香，可以看到最终肯定还是调用zookeeper client的getdata，然后注意到其定义的callback里面组装了一个CuratorEvent")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("CuratorEvent event = new CuratorEventImpl(client, CuratorEventType.GET_DATA, rc, path, null, ctx, stat, data, null, null, null);\n                    client.processBackgroundOperation(operationAndData, event);\n")])])]),a("p",[e._v("然后看到其callback里面再次调用curatorFramework的processBackgroundOperation，这一次event！=null了，所以走到下面的")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("if ( operationAndData.getCallback() != null )\n{\n\tsendToBackgroundCallback(operationAndData, event);\n\tbreak;\n}\n\nprocessEvent(event);\n")])])]),a("p",[e._v("这个callback是啥，回过头查一下就知道这个是一开始在PathChildrenCache里面注册的:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("void getDataAndStat(final String fullPath) throws Exception\n    {\n        BackgroundCallback callback = new BackgroundCallback()\n        {\n            @Override\n            public void processResult(CuratorFramework client, CuratorEvent event) throws Exception\n            {\n                applyNewData(fullPath, event.getResultCode(), event.getStat(), cacheData ? event.getData() : null);\n            }\n        };\n\n        if ( USE_EXISTS && !cacheData )\n        {\n            client.checkExists().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);\n        }\n        else\n        {\n            // always use getData() instead of exists() to avoid leaving unneeded watchers which is a type of resource leak\n            if ( dataIsCompressed && cacheData )\n            {\n                client.getData().decompressed().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);\n            }\n            else\n            {\n                client.getData().usingWatcher(dataWatcher).inBackground(callback).forPath(fullPath);\n            }\n        }\n    }\n")])])]),a("p",[e._v("回到前面，所以整个意思是调用zookeeper client接口获取的data要封装成curatorEvent再调用回PathChildrenCache的callback，callback调用applyNewData：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("if ( previousData == null ) // i.e. new\n{\n\tofferOperation(new EventOperation(this, new PathChildrenCacheEvent(PathChildrenCacheEvent.Type.CHILD_ADDED, data)));\n}\nelse if ( previousData.getStat().getVersion() != stat.getVersion() )\n{\n\tofferOperation(new EventOperation(this, new PathChildrenCacheEvent(PathChildrenCacheEvent.Type.CHILD_UPDATED, data)));\n}\n")])])]),a("p",[e._v("可以看到这里封装了PathChidrenCacheEvent，再最终回调一开始开头注册好的监听方法\nlistener.childEvent(client, event);\n然后看到前面CuratorFramework还调用了processEvent，继续查到里面是调用CuratorListener，\n我们事先并没有注册任何CuratorListener，而是调用的PathChildrenCacheListener，所以这个processEvent这里没有起到任何作用；")]),e._v(" "),a("h2",{attrs:{id:"深入解读"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#深入解读"}},[e._v("#")]),e._v(" 深入解读")]),e._v(" "),a("p",[e._v("https://cwiki.apache.org/confluence/display/ZOOKEEPER/ZooKeeperPresentations\nSometimes developers mistakenly assume one other guarantee that ZooKeeper does not in fact make. This is: * Simultaneously Consistent Cross-Client Views* : ZooKeeper does not guarantee that at every instance in time, two different clients will have identical views of ZooKeeper data. Due to factors like network delays, one client may perform an update before another client gets notified of the change. Consider the scenario of two clients, A and B. If client A sets the value of a znode /a from 0 to 1, then tells client B to read /a, client B may read the old value of 0, depending on which server it is connected to. If it is important that Client A and Client B read the same value, Client B should should call the sync() method from the ZooKeeper API method before it performs its read. So, ZooKeeper by itself doesn't guarantee that changes occur synchronously across all servers, but ZooKeeper primitives can be used to construct higher level functions that provide useful client synchronization. (For more information, see the ZooKeeper Recipes. [tbd:..]).")]),e._v(" "),a("p",[e._v("CAP理论，zookeeper是CP模型，保证"),a("a",{attrs:{href:"https://stackoverflow.com/questions/37399722/why-is-this-output-wrong-sequential-consistency",target:"_blank",rel:"noopener noreferrer"}},[e._v("sequential consistency"),a("OutboundLink")],1),e._v("，\n比eventual consistency强一些，但是不是strong consistency，因为我们前面说了，zookeeper是采用推拉模式，\n所以每个客户端看的的view都可能由于网络的原因不一样，\n"),a("a",{attrs:{href:"https://stackoverflow.com/questions/35387774/is-zookeeper-always-consistent-in-terms-of-cap-theorem",target:"_blank",rel:"noopener noreferrer"}},[e._v("Zookeeper is not A, and can't drop P. So it's called CP apparently. In terms of CAP theorem, \"C\" actually means linearizability.But, Zookeeper has Sequential Consistency - Updates from a client will be applied in the order that they were sent."),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("然后又由于zookeeper是基于CP模型，所以有人提出：\nzookeeper 的 CP 模型不适合注册中心\nhttps://segmentfault.com/a/1190000021356988")]),e._v(" "),a("p",[e._v("丢失watcher的原因：")]),e._v(" "),a("p",[e._v('//连续修改会‘丢失’nodeChanged event的原因是，每次获取到nodechanged之后curator的nodecache实际上还要再次重设watch，因为watch是一次性的；\n//客户端set 111 , 服务端处理set\n//客户端注册watch，服务端注册watch\n//客户端set 222， 服务端处理set，服务端刚才的watch刚注册好\n//客户端注册watch，服务端通知client端变化\n//客户端set 333， 服务端处理set\n//客户端收到变化通知打印，然后还要去服务端拉取，此时最新值是333\n//但是实际上setDAta应该都是成功的，因为zookeeper是顺序处理\nclient.setData().forPath(nodePath, "111".getBytes());\nclient.setData().forPath(nodePath, "222".getBytes());')]),e._v(" "),a("p",[e._v("所以要用对zookeeper还是要学习下其他产品，比如：\n"),a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=MzA4Nzc4MjI4MQ==&mid=2652403267&idx=1&sn=9c79bde74e86cf10ac85ec7d4b53a4dc&chksm=8bd8f0a5bcaf79b3026777f9d7a564df56ef5086b13f502410204592ad45022682fba326682f&token=1143895172&lang=zh_CN#rd",target:"_blank",rel:"noopener noreferrer"}},[e._v("kafka 中 zookeeper 具体是做什么的？"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("ref：\nhttps://www.cnblogs.com/duanxz/p/3783266.html")]),e._v(" "),a("p",[e._v('Zookeeper集群"脑裂"问题 - 运维总结 https://www.cnblogs.com/kevingrace/p/12433503.html')]),e._v(" "),a("disqus")],1)}),[],!1,null,null,null);t.default=n.exports}}]);