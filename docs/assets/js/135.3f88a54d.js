(window.webpackJsonp=window.webpackJsonp||[]).push([[135],{341:function(t,e,a){"use strict";a.r(e);var s=a(0),r=Object(s.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[a("a",{attrs:{href:"/docs/software"}},[t._v("回目录")]),t._v("  《Gitlab Server》")]),t._v(" "),a("h2",{attrs:{id:"_1-architecture"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-architecture"}},[t._v("#")]),t._v(" 1. Architecture")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/development/architecture.html")]),t._v(" "),a("p",[t._v("https://about.gitlab.com/handbook/engineering/infrastructure/production/architecture/#service-architecture")]),t._v(" "),a("p",[t._v("https://juejin.im/post/5cf67d355188255508118def")]),t._v(" "),a("p",[t._v("完整文档")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/README.html#installation-and-configuration-using-omnibus-package")]),t._v(" "),a("p",[a("img",{attrs:{src:"/docs/docs_image/software/project_manage/git/gitlab01.png",alt:""}})]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('sudo gitlab-ctl status\nrun: alertmanager: (pid 16828) 499486s; run: log: (pid 10270) 584166s\nrun: gitaly: (pid 15594) 499829s; run: log: (pid 9538) 584281s\nrun: gitlab-exporter: (pid 15618) 499829s; run: log: (pid 10090) 584184s\nrun: gitlab-workhorse: (pid 15624) 499828s; run: log: (pid 9929) 584207s\nrun: grafana: (pid 17718) 498697s; run: log: (pid 10420) 584117s\nrun: logrotate: (pid 9004) 2937s; run: log: (pid 10015) 584196s\nrun: nginx: (pid 15677) 499827s; run: log: (pid 9980) 584200s\nrun: node-exporter: (pid 15689) 499827s; run: log: (pid 10050) 584190s\nrun: postgres-exporter: (pid 15696) 499826s; run: log: (pid 10299) 584160s\nrun: postgresql: (pid 15789) 499823s; run: log: (pid 9636) 584274s\nrun: prometheus: (pid 15805) 499823s; run: log: (pid 10224) 584170s\nrun: puma: (pid 16874) 499480s; run: log: (pid 9832) 584220s\nrun: redis: (pid 15829) 499822s; run: log: (pid 9405) 584287s\nrun: redis-exporter: (pid 15834) 499822s; run: log: (pid 10179) 584178s\nrun: sidekiq: (pid 16818) 499486s; run: log: (pid 9864) 584214s\n\n[root@sgkc2-cicd-v02 liuyue]# netstat -anp|grep "15789"\nunix  2      [ ACC ]     STREAM     LISTENING     1264397  15789/postgres       /var/opt/gitlab/postgresql/.s.PGSQL.5432\n\n一个是Active Internet connections，称为有源TCP连接，其中"Recv-Q"和"Send-Q"指%0A的是接收队列和发送队列。这些数字一般都应该是0。如果不是则表示软件包正在队列中堆积。这种情况只能在非常少的情况见到。\n\n另一个是Active UNIX domain sockets，称为有源Unix域套接口(和网络套接字一样，但是只能用于本机通信，性能可以提高一倍)。\nProto显示连接使用的协议,RefCnt表示连接到本套接口上的进程号,Types显示套接口的类型,State显示套接口当前的状态,Path表示连接到套接口的其它进程使用的路径名。\nhttps://blog.csdn.net/u012598668/java/article/details/40080245\n')])])]),a("p",[t._v("接入层")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("Nginx：静态 web 服务器")])]),t._v(" "),a("li",[a("p",[t._v("gitlab-shell：负责处理ssh请求,用于处理 Git 命令和修改 authorized keys 列表")])]),t._v(" "),a("li",[a("p",[t._v("gitlab-workhorse: 负责处理http/https请求,轻量级的反向代理服务器, gitlab workhorse对于本地静态文件请求（例如浏览器请求的html、js、css文件）会自己处理掉，对于纯git操作请求会转发给gitaly，对于其他动态请求会转发给unicorn处理")])]),t._v(" "),a("li",[a("p",[t._v("unicorn：An HTTP server for Rack applications，GitLab Rails 应用是托管在这个服务器上面的，相当于java里面的tomcat，是一个开源项目")]),t._v(" "),a("p",[t._v("unicorn就是gitlab的主server程序，它会调用其他各个组件完成复杂的动态请求处理\nhttps://blog.csdn.net/gg_18826075157/java/article/details/107117595")])]),t._v(" "),a("li",[a("p",[t._v("logrotate：日志文件管理工具")])]),t._v(" "),a("li",[a("p",[t._v("sidekiq：用于在后台执行队列任务（异步执行）")])])]),t._v(" "),a("p",[t._v("底层存储：")]),t._v(" "),a("ul",[a("li",[t._v("PostgreSQL：类似于mysql，存储业务数据，比如有哪些项目组，某个项目组下有哪些项目，某项目下哪些人有权限等等")]),t._v(" "),a("li",[t._v("redis：用于缓存热点数据以及存储异步任务，sidekiq这组件会定期拉取分发异步任务给worker执行")]),t._v(" "),a("li",[t._v("gitaly：存储底层代码文件，提供rpc接口对外提供git操作服务")])]),t._v(" "),a("p",[t._v("*-exporter+grafana+prometheus: 监控")]),t._v(" "),a("h3",{attrs:{id:"_1-1-http-https-over-nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-http-https-over-nginx"}},[t._v("#")]),t._v(" 1.1 http/https over nginx:")]),t._v(" "),a("p",[t._v("git request: http://172.26.101.133:8088/root/test-gitaly-cluster.git")]),t._v(" "),a("p",[t._v("user/admin dashboard request: http://172.26.101.133:8088/root/test-gitaly-cluster")]),t._v(" "),a("p",[t._v("grafana request: http://172.26.101.133:8088/-/grafana/?orgId=1")]),t._v(" "),a("p",[t._v("sudo vim /var/opt/gitlab/nginx/conf/nginx.conf")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("upstream gitlab-workhorse {\n    server unix:/var/opt/gitlab/gitlab-workhorse/socket;\n  }\n\n  include /var/opt/gitlab/nginx/conf/gitlab-http.conf;\n")])])]),a("p",[t._v("这个upstream名字是gitlab-workhorse，对应是转发到的地方，这里可以看到是一个unix socket；")]),t._v(" "),a("p",[t._v("再来看include的这个配置文件：")]),t._v(" "),a("p",[t._v("sudo vim /var/opt/gitlab/nginx/conf/gitlab-http.conf")]),t._v(" "),a("p",[t._v("8088是我们在/etc/gitlab/gitlab.rb中reconfigure的外部访问端口，")]),t._v(" "),a("p",[t._v("可以看到proxy_pass将路由匹配到了"),a("code",[t._v("http://<upstream name>")]),t._v("也就是"),a("code",[t._v("http://gitlab-workhorse")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("server {\n  listen *:8088;\n\n\n  server_name 172.26.101.134;\n  \nlocation / {\n    proxy_cache off;\n    proxy_pass  http://gitlab-workhorse;\n  }\n\n  location /assets {\n    proxy_cache gitlab;\n    proxy_pass  http://gitlab-workhorse;\n  }\n  \n location ~ ^/(404|500|502)(-custom)?\\.html$ {//特别匹配这么几个错误页面\n    root /opt/gitlab/embedded/service/gitlab-rails/public;\n    internal; //限制为内部用户\n  }\n  \n location ~ (.git/git-receive-pack$|.git/info/refs?service=git-receive-pack$|.git/gitlab-lfs/objects|.git/info/lfs/objects/batch$) {\n    proxy_cache off;\n    proxy_pass http://gitlab-workhorse;\n    proxy_request_buffering off;\n  }\n  location /-/grafana/ {\n    proxy_pass http://localhost:3000/;\n  }\n")])])]),a("p",[t._v("可以看到不管是什么请求（除了grafana和那几个特定的静态页面）都是转给gitlab-workhorse来处理，")]),t._v(" "),a("p",[t._v("https://juejin.im/post/5cf680f86fb9a07ed5248cda")]),t._v(" "),a("p",[t._v("最后再来查查gitlab-workhorse，如下可以看到是监听的正是前面upstream转发的那个/var/opt/gitlab/gitlab-workhorse/socket")]),t._v(" "),a("p",[t._v("然后authBackend对应8080端口，这个可以参考")]),t._v(" "),a("blockquote",[a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('https://gitlab.com/gitlab-org/gitlab-workhorse/blob/master/README.md\n\n-authBackend string\n   Authentication/authorization backend (default "http://localhost:8080")\n')])])])]),t._v(" "),a("p",[t._v("估计应该是API接口")]),t._v(" "),a("p",[t._v("documentRoot前端的对应目录是/opt/gitlab/embedded/service/gitlab-rails/public")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('[root@sgkc2-cicd-v01 liuyue]# ps -lef | grep "rail"\n4 S root      5033 22189  0  80   0 - 28203 pipe_w 14:52 pts/1    00:00:00 grep --color=auto rail\n4 S git       6848  6504  0  80   0 - 166286 ep_pol Jun29 ?       00:10:55 /opt/gitlab/embedded/bin/gitlab-workhorse -listenNetwork unix -listenUmask 0 -listenAddr /var/opt/gitlab/gitlab-workhorse/socket -authBackend http://localhost:8080 -authSocket /var/opt/gitlab/gitlab-rails/sockets/gitlab.socket -documentRoot /opt/gitlab/embedded/service/gitlab-rails/public -pprofListenAddr  -prometheusListenAddr localhost:9229 -secretPath /opt/gitlab/embedded/service/gitlab-rails/.gitlab_workhorse_secret -logFormat json -config config.toml\n4 S git       7038  6502  0  80   0 - 257481 poll_s Jun29 ?       00:09:25 puma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]\n4 S git       7056  6503  0  80   0 - 32362 poll_s Jun29 ?        00:00:23 ruby /opt/gitlab/embedded/service/gitlab-rails/bin/sidekiq-cluster -e production -r /opt/gitlab/embedded/service/gitlab-rails -m 50 --timeout 25 *\n')])])]),a("p",[t._v("8080这个端口是哪个服务呢")]),t._v(" "),a("p",[t._v("根据 https://docs.gitlab.com/ee/development/architecture.html 架构图，可以看到8080是指向unicorn")]),t._v(" "),a("p",[t._v("但是查一下，可以看到是puma：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('netstat -anp|grep :8080\ntcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      7038/puma 4.3.3.git\n\nps -lef|grep "puma"\n4 S root      6502  6498  0  80   0 -  1058 poll_s Jun29 ?        00:00:00 runsv puma\n4 S root      6517  6502  0  80   0 -  1094 poll_s Jun29 ?        00:00:00 svlogd -tt /var/log/gitlab/puma\n4 S git       6845  6508  4  80   0 - 173898 poll_s Jun29 ?       15:54:47 puma 4.3.3.gitlab.2 (tcp://localhost:9168) [gitlab-exporter]\n4 S git       7038  6502  0  80   0 - 257481 poll_s Jun29 ?       00:09:26 puma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]\n')])])]),a("p",[t._v("https://docs.gitlab.com/ee/administration/operations/unicorn.html#unicorn")]),t._v(" "),a("blockquote",[a("p",[a("strong",[t._v("Note:")]),t._v(" Starting with GitLab 13.0, Puma is the default web server used in GitLab all-in-one package based installations as well as GitLab Helm chart deployments.")]),t._v(" "),a("p",[t._v("GitLab uses "),a("a",{attrs:{href:"https://yhbt.net/unicorn/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Unicorn"),a("OutboundLink")],1),t._v(", a pre-forking Ruby web server, to handle web requests (web browsers and Git HTTP clients). Unicorn is a daemon written in Ruby and C that can load and run a Ruby on Rails application; in our case the Rails application is GitLab Community Edition or GitLab Enterprise Edition.")])]),t._v(" "),a("p",[t._v("unicorn是一个开源项目，当unicorn不再满足需求时才引入了puma和workhorse")]),t._v(" "),a("p",[t._v("https://juejin.im/post/5cf6832c51882520724c84ff")]),t._v(" "),a("h3",{attrs:{id:"_1-2-ssh-over-gitlab-shell"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-ssh-over-gitlab-shell"}},[t._v("#")]),t._v(" 1.2 ssh over gitlab-shell")]),t._v(" "),a("p",[t._v("git@172.26.101.133:root/test-gitaly-cluster.git")]),t._v(" "),a("p",[t._v("注意安装gitlab后，会创建很多用户")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("vim /etc/passwd\ngitlab-www:x:996:993::/var/opt/gitlab/nginx:/bin/false\ngit:x:995:992::/var/opt/gitlab:/bin/sh\ngitlab-redis:x:994:991::/var/opt/gitlab/redis:/bin/false\ngitlab-psql:x:993:990::/var/opt/gitlab/postgresql:/bin/sh\ngitlab-prometheus:x:992:989::/var/opt/gitlab/prometheus:/bin/sh\n")])])]),a("p",[t._v("注意到git用户的home是/var/opt/gitlab，然后从/var/opt/gitlab/gitlab-shell/config.yml可以获取到配置")]),t._v(" "),a("p",[t._v("auth_file: /var/opt/gitlab/.ssh/authorized_keys，打开可以看到")]),t._v(" "),a("p",[a("code",[t._v('command="/opt/gitlab/embedded/service/gitlab-shell/bin/gitlab-shell key-1"')])]),t._v(" "),a("p",[t._v("原理就是一句话：ssh可以执行命令 https://research.kudelskisecurity.com/2013/05/14/restrict-ssh-logins-to-a-single-command/")]),t._v(" "),a("p",[t._v("http://williamherry.com/blog/2015/07/19/from-git-push-to-commit-show-on-page/")]),t._v(" "),a("p",[t._v("https://juejin.im/post/5cf686b85188253cec305fa7")]),t._v(" "),a("p",[t._v("my internal sharing talk:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("I'll give a overview about what we have and how git server works\nI believe everyone should be already familiar with git,\nGit is a distributed version-control system for tracking changes in source code during software development.\nit enables us to collaborate more effiently especially when working remotely on the software project,\n\n//and by integrating with other automation tools like jenkins and others, you can have the ability to Continuous Integration and Continuous Deployment;\nactually for some of the git server implementations like gitlab, we notice that it already has built in CICD Solutions, \nbut we haven't expolore that portion yet, today we'll only cover the basic usage;\n\nalthough most of us are familiar with git, but probably limited to the git client, whether it's git commands or gui tools, \nnow let's talk about how git server side looks like;\n\nat the start, we set up a standalone git lab server, you can see it is comprised of a lot services, some of the non important services are not listed here;\nwhen the users make a git pull or push through http or ssh, it will go to nginx or gitlab shell respectively, if the git request goes through http request, \ngitlab workhorse will redirect it to unicorn, other request like access to the dashboard or grafana monitor will handled by workhorse itself,\nintially there is only unicorn, and then gitlab introduced workhorse to share the load of unicorn, \nunicorn is an open source project, it's a web server in ruby, analogy to tomcat in java;\n\nredis is for cache, postgresql is for the application data storing, sidekiq is for backgroud job, it may be related to the CICD futionality;\n\nthe most crital system is gitaly, it's for the git repository storage\n\nas we have very limited internal users, for the high availability concerns, the first thing we need to do is make sure there is no single point of failure\nfor the gitaly storage, based on the documentation, we come out with this gitaly cluster;\n\nit has a praefect as router between gitlab server and gitaly nodes;\n")])])]),a("h2",{attrs:{id:"_2-install-安装-手动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-install-安装-手动"}},[t._v("#")]),t._v(" 2. Install 安装(手动)")]),t._v(" "),a("p",[t._v("https://git-scm.com/book/en/v2/Git-on-the-Server-GitLab")]),t._v(" "),a("p",[t._v("ce版本源码：https://gitlab.com/gitlab-org/gitlab-foss/-/tree/master")]),t._v(" "),a("p",[t._v("官方安装文档：https://about.gitlab.com/install/#centos-7")]),t._v(" "),a("p",[t._v("下面采用离线安装 https://docs.gitlab.com/omnibus/manual_install.html")]),t._v(" "),a("h3",{attrs:{id:"_1-0-硬件准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-0-硬件准备"}},[t._v("#")]),t._v(" 1.0 硬件准备")]),t._v(" "),a("p",[t._v("一台Praefect Server（存储空间可以给最低没关系）和三台gitaly server（git高可用的核心服务器，要求high CPU, high memory, fast storage）")]),t._v(" "),a("p",[t._v("挂载磁盘大小需要注意，因为gitlab会写入一些数据到 /var/opt/gitlab，所以如果/var单独挂载需要注意")]),t._v(" "),a("h3",{attrs:{id:"_1-1-dependency"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-dependency"}},[t._v("#")]),t._v(" 1.1 dependency")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# open HTTP, HTTPS and SSH access in the system firewall.\n\nsudo yum install -y curl policycoreutils-python openssh-server\nsudo systemctl enable sshd\nsudo systemctl start sshd\nsudo firewall-cmd --permanent --add-service=http\nsudo firewall-cmd --permanent --add-service=https\nsudo systemctl reload firewalld\n\n# install Postfix to send notification emails.\n# If you want to use another solution to send emails please skip this step and configure an external SMTP server after GitLab has been installed.\n# 此处我已经忽略，奇怪的是我并没有安装，但是后面却发现postfix不知何时已经运行了，估计是gitlab自己搞的\nsudo yum install postfix\nsudo systemctl enable postfix\nsudo systemctl start postfix\n")])])]),a("h3",{attrs:{id:"_1-2-rpm安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-rpm安装"}},[t._v("#")]),t._v(" 1.2 rpm安装")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('# GitLab Community Edition\n# Debian/Ubuntu\ndpkg -i gitlab-ce-<version>.deb\n\n# CentOS/RHEL\nrpm -Uvh gitlab-ce-<version>.rpm\n\n下载 https://packages.gitlab.com/gitlab/gitlab-ce\n\nsudo mv gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm /opt/\n\nrpm -ivh gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm \n\nfor firstime install use -i or -U, for upgrade use -U\n\n总结：\ncd /opt/\nrpm -ivh gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm \nvim /etc/gitlab/gitlab.rb (change external_url="http://172.26.101.133:8088")\nsudo gitlab-ctl reconfigure\nfirewall-cmd --zone=public --add-port=8088/tcp --permanent\nfirewall-cmd --reload\n\nafter all this:\naccess from your browser\nhttp://172.26.101.133:8088\n\nit will ask for changing password, default username: admin@example.com\n\n')])])]),a("p",[t._v("启动：")]),t._v(" "),a("p",[t._v("sudo gitlab-ctl reconfigure")]),t._v(" "),a("p",[t._v("安装后路径：")]),t._v(" "),a("p",[t._v("/var/opt/gitlab/")]),t._v(" "),a("p",[t._v("/var/opt/gitlab/nginx/conf/gitlab-http.conf")]),t._v(" "),a("p",[t._v("log路径：也是排查错误的路径")]),t._v(" "),a("p",[t._v("/var/log/gitlab/")]),t._v(" "),a("h3",{attrs:{id:"_1-3-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-configuration"}},[t._v("#")]),t._v(" 1.3 Configuration")]),t._v(" "),a("p",[t._v("https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md")]),t._v(" "),a("h4",{attrs:{id:"_1-3-1-前端gitlab-server-url和api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1-前端gitlab-server-url和api"}},[t._v("#")]),t._v(" 1.3.1 前端gitlab-server url和api")]),t._v(" "),a("p",[t._v("/etc/gitlab/gitlab.rb")]),t._v(" "),a("p",[t._v('​\tchange external_url="http://172.26.101.133:8088" 这个端口会写入到/var/opt/gitlab/nginx/conf/gitlab-http.conf')]),t._v(" "),a("p",[t._v("sudo gitlab-ctl reconfigure")]),t._v(" "),a("p",[t._v("注意，刚开始我用了8080，"),a("s",[t._v("刚好跟内置的nginx冲突")]),t._v("，是跟gitlab-puma-worker冲突，")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sudo netstat -anp|grep :8080\n\nsudo ps -lef|grep 18251\n\npuma 4.3.3.gitlab.2 (unix:///var/opt/gitlab/gitlab-rails/sockets/gitlab.socket,tcp://127.0.0.1:8080) [gitlab-puma-worker]\n\n")])])]),a("p",[t._v("所以访问出现502 Whoops, GitLab is taking too much time to respond.")]),t._v(" "),a("p",[t._v("只需要换一个端口即可，端口也要开通：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("firewall-cmd --zone=public --add-port=8088/tcp --permanent\nfirewall-cmd --reload\nfirewall-cmd --list-all\nfirewall-cmd --list-ports\n")])])]),a("p",[a("strong",[t._v("这个reconfigure会将配置进行“分发”，所以后面所有修改配置都要注意优先修改gitlab.rb，而不是直接改具体各个服务的配置：")])]),t._v(" "),a("p",[t._v("比如端口和ip赋值给：")]),t._v(" "),a("p",[t._v("/var/opt/gitlab/nginx/conf/gitlab-http.conf（模板/opt/gitlab/embedded/conf/nginx.conf ?）")]),t._v(" "),a("p",[t._v("/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml（模板：/opt/gitlab/embedded/service/gitlab-rails/config/gitlab.yml.exmaple）")]),t._v(" "),a("p",[t._v("说回到 前端http://172.26.101.133:8088")]),t._v(" "),a("p",[t._v("默认用户名root/ admin@example.com 可以从log中获取：")]),t._v(" "),a("p",[t._v('sudo grep -nr "admin" /var/log/gitlab/')]),t._v(" "),a("p",[t._v("​\t/var/log/gitlab/gitlab-rails/application.log")]),t._v(" "),a("p",[t._v("监控前端（从nginx配置获取）：")]),t._v(" "),a("p",[t._v("172.26.101.134:8088/-/grafana/login")]),t._v(" "),a("p",[t._v("注意这个8088也将会是Gitaly集群的internal_api_url")]),t._v(" "),a("p",[t._v("/opt/gitlab/embedded/service/gitlab-shell/config.yml")]),t._v(" "),a("p",[a("s",[t._v("注意此处要手动修改gitlab_url，不知为何reconfigure没有生效到这里")]),t._v(" 应该不需要修改，默认就是8080，对应puma-worker的端口")]),t._v(" "),a("p",[t._v("auth_key?")]),t._v(" "),a("h4",{attrs:{id:"_1-3-2-监控grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2-监控grafana"}},[t._v("#")]),t._v(" 1.3.2 监控grafana")]),t._v(" "),a("p",[t._v("第一种基本登录")]),t._v(" "),a("p",[t._v("​\tgrafana['disable_login_form'] = false")]),t._v(" "),a("p",[t._v("​\tgitlab-ctl set-grafana-password")]),t._v(" "),a("p",[t._v("第二种方法：通过gitlab server第三方登录")]),t._v(" "),a("p",[t._v("首先login配置")]),t._v(" "),a("p",[t._v("172.26.101.134:8088/-/grafana/login")]),t._v(" "),a("p",[t._v("http://172.26.101.134:8088/oauth/authorize?access_type=online&client_id=a797f89033dee951dac900905d7b447191f743bcd9afa3a970be4a6864ee0661&redirect_uri=http%3A%2F%2F172.26.101.134%3A8088%2F-%2Fgrafana%2Flogin%2Fgitlab&response_type=code&scope=api&state=o2t3bzD7ek3TPoIPHqDVaLc_HSInTqdBK9IlS2dHhnc%3D")]),t._v(" "),a("p",[t._v("?# gitlab The redirect URI included is not valid.")]),t._v(" "),a("p",[t._v("https://grafana.com/docs/grafana/latest/auth/gitlab/")]),t._v(" "),a("p",[t._v("配置：")]),t._v(" "),a("p",[t._v("回到gitlab前端的管理员area， Applications->Add")]),t._v(" "),a("p",[t._v("callback url: http://172.26.101.134:8088/-/grafana/login/gitlab")]),t._v(" "),a("p",[t._v("将clientid和secret配置到：/var/opt/gitlab/grafana/grafana.ini")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[auth.gitlab]\nclient_id\nclient_secret\nroot_url = http://172.26.101.134:8088/-/grafana\nauth_url = http://172.26.101.134:8088/oauth/authorize\ntoken_url = http://172.26.101.134:8088/oauth/token\napi_url = http://172.26.101.134:8088/api/v4\n")])])]),a("p",[t._v("gitlab-ctl restart grafana")]),t._v(" "),a("p",[a("strong",[t._v("监控其他节点")])]),t._v(" "),a("p",[t._v("这个是在安装了Gitaly cluster之后的配置")]),t._v(" "),a("p",[t._v("9090 prometheus")]),t._v(" "),a("p",[t._v("9100 node_exporter")]),t._v(" "),a("p",[t._v("这两个都是可以看到metrics:")]),t._v(" "),a("p",[t._v("curl 127.0.0.1:9090/metrics -s | head")]),t._v(" "),a("p",[t._v("curl 127.0.0.1:9100/metrics -s | head")]),t._v(" "),a("p",[t._v("应该只有prometheus自带UI:")]),t._v(" "),a("p",[t._v("http://172.26.101.133:9090/graph")]),t._v(" "),a("p",[t._v("但是浏览器无法打开，netstat发现9090只监听本地端口，所以要修改")]),t._v(" "),a("p",[t._v("grep :9090 /var/opt/* -r")]),t._v(" "),a("p",[t._v("找到/var/opt/gitlab/prometheus/prometheus.yml和/var/opt/gitlab/gitlab-rails/etc/gitlab.yml")]),t._v(" "),a("p",[t._v("但是还是建议去/etc/gitlab/gitlab.rb里面去修改：")]),t._v(" "),a("p",[t._v("prometheus['listen_address'] = 'localhost:9090'")]),t._v(" "),a("p",[t._v("最后可以打开了prometheus ui，")]),t._v(" "),a("p",[t._v("测试dashboard：Gitaly，先修改variable")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('label_values(up{job="gitaly"}, instance)\n改成\nlabel_values(gitlab_build_info{job="praefect-gitaly"}, instance)\n果然可以看到其他三个instance\n')])])]),a("p",[t._v("然后继续修改dashboard页面内部的metrics，比如Gitaly的cpu查询一下，")]),t._v(" "),a("p",[t._v('rate(process_cpu_seconds_total{job="gitaly"}[1m])')]),t._v(" "),a("p",[t._v("发现只有一条localhost记录，再来查查node exporter配置：")]),t._v(" "),a("p",[t._v("grep :9100 /var/opt/* -r\n/var/opt/gitlab/prometheus/prometheus.yml:    - localhost:9100")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("- job_name: node\n  static_configs:\n  - targets:\n    - localhost:9100\n")])])]),a("p",[t._v("果然这个是问题所在，并没有去监听Gitaly cluster 上面的9100")]),t._v(" "),a("p",[t._v("但是正确的做法仍然是不要直接修改，应该去修改/etc/gitlab/gitlab.rb")]),t._v(" "),a("p",[t._v("突然想到我们在创建gitaly cluster的时候其实修改过，刚好在这个prometheus.yml里面验证下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("- job_name: praefect-gitaly\n  static_configs:\n  - targets:\n    - 172.26.101.136:9236\n    - 172.26.101.137:9236\n    - 172.26.101.138:9236\n")])])]),a("p",[t._v("果然是有，我们依样画葫芦，可以同样修改上面的node")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v(" {                                          \n   'job_name' => 'praefect-gitaly-nodes',   \n   'static_configs' => [                    \n     'targets' => [                         \n       '172.26.101.136:9100', # gitaly-1    \n       '172.26.101.137:9100', # gitaly-2    \n       '172.26.101.138:9100', # gitaly-3    \n     ]                                      \n   ]                                        \n }                                          \n")])])]),a("p",[t._v("但是还不够，还要确认Gitaly的9100端口对gitlab server可见，但是发现实际上Gitaly上面并没有开启9100端口，意思是node_exporter并没有启动，怀疑是gitlab程序会默认根据gitaly['enable'] = true来disable掉node_exporter,所以我尝试主动去开启node_exporter:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("################################################################################\n## Prometheus Node Exporter\n##! Docs: https://docs.gitlab.com/ee/administration/monitoring/prometheus/node_exporter.html\n################################################################################\n\nnode_exporter['enable'] = true\n# node_exporter['home'] = '/var/opt/gitlab/node-exporter'\n# node_exporter['log_directory'] = '/var/log/gitlab/node-exporter'\n# node_exporter['flags'] = {\n#   'collector.textfile.directory' => \"/var/opt/gitlab/node-exporter/textfile_collector\"\n# }\n# node_exporter['env_directory'] = '/opt/gitlab/etc/node-exporter/env'\n# node_exporter['env'] = {\n#   'SSL_CERT_DIR' => \"/opt/gitlab/embedded/ssl/certs/\"\n# }\n\n##! Advanced settings. Should be changed only if absolutely needed.\nnode_exporter['listen_address'] = '0.0.0.0:9100'\n")])])]),a("p",[t._v("刚好同时将node_exporter监听也改掉")]),t._v(" "),a("p",[t._v("firewall-cmd --zone=public --add-port=9100/tcp --permanent")]),t._v(" "),a("p",[t._v("firewall-cmd --reload")]),t._v(" "),a("p",[t._v("回到gitlab-server，在http://172.26.101.133:9090/graph")]),t._v(" "),a("p",[t._v('rate(process_cpu_seconds_total{job="praefect-gitaly-nodes"}[1m])')]),t._v(" "),a("p",[t._v("果然看到了三个instance的metrics（注意重启服务后要多等一会）")]),t._v(" "),a("p",[t._v('最后试着保存dashboard，居然弹出错误“ Cannot save provisioned dashboard"')]),t._v(" "),a("p",[t._v("https://grafana.com/docs/grafana/latest/administration/provisioning/#dashboards")]),t._v(" "),a("p",[t._v("vim /var/opt/gitlab/grafana/provisioning/dashboards/gitlab_dashboards.yml")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('---\napiVersion: 1\nproviders:\n- name: GitLab Omnibus\n  orgId: 1\n  folder: GitLab Omnibus\n  type: file\n  disableDeletion: true\n  updateIntervalSeconds: 600\n  options:\n    path: "/opt/gitlab/embedded/service/grafana-dashboards"\n')])])]),a("p",[t._v("继而找到")]),t._v(" "),a("p",[t._v("vim /opt/gitlab/embedded/service/grafana-dashboards/gitaly.json")]),t._v(" "),a("h4",{attrs:{id:"_1-3-3-邮箱"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-3-邮箱"}},[t._v("#")]),t._v(" 1.3.3 邮箱")]),t._v(" "),a("p",[t._v("前面跳过了邮箱配置，这里采用external mail server gmail，但是奇怪的是postfix自动运行")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/settings/smtp.html")]),t._v(" "),a("p",[a("strong",[t._v("Use smtp instead of sendmail/postfix.")])]),t._v(" "),a("p",[t._v("注意要更改gitlab_rails['smtp_设置，不要改错")]),t._v(" "),a("p",[t._v("测试：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Look at the ActionMailer `delivery_method` to make sure it matches what you intended. If you configured SMTP, it should say `:smtp`. If you’re using Sendmail, it should say `:sendmail`:\n\nActionMailer::Base.delivery_method\n\ngitlab-rails console\nNotify.test_email('lyhistory@gmail.com', 'test gitlab', 'test').deliver_now\nActionMailer::Base.smtp_settings\n\n")])])]),a("h4",{attrs:{id:"_1-3-4-postgresql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-4-postgresql"}},[t._v("#")]),t._v(" 1.3.4 postgresql")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/settings/database.html#connecting-to-the-bundled-postgresql-database")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/troubleshooting/postgresql.html#postgresql")]),t._v(" "),a("p",[t._v("/var/opt/gitlab/postgresql/data/postgresql.conf")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sudo gitlab-rails dbconsole\n\nsudo gitlab-psql -d gitlabhq_production\n")])])]),a("p",[t._v("plsql cmds")]),t._v(" "),a("p",[t._v("https://www.postgresql.org/docs/12/app-psql.html")]),t._v(" "),a("p",[t._v("注意下面这种方式是无法连接的，因为gitlab本机内部不是用tcp协议，而是用Unix域套接口")]),t._v(" "),a("p",[t._v("/opt/gitlab/embedded/bin/psql -U postgres -d gitlabhq_production -h <POSTGRESQL_SERVER_ADDRESS>")]),t._v(" "),a("h4",{attrs:{id:"_1-3-5-gitaly"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-5-gitaly"}},[t._v("#")]),t._v(" 1.3.5 gitaly")]),t._v(" "),a("p",[t._v("vim /var/opt/gitlab/gitaly/config.toml")]),t._v(" "),a("p",[t._v("可以清晰的看到 /var/opt/gitlab/git-data/repositories 这个就是git最终存储的位置")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("socket_path = '/var/opt/gitlab/gitaly/gitaly.socket'\n\ninternal_socket_dir = '/var/opt/gitlab/gitaly/internal_sockets'\nbin_dir = '/opt/gitlab/embedded/bin'\n\n# Optional: export metrics via Prometheus\nprometheus_listen_addr = 'localhost:9236'\n\n[[storage]]\nname = 'defau://www.postgresql.org/docs/12/app-psql.htmlt'\npath = '/var/opt/gitlab/git-data/repositories'\n\n[logging]\nformat = 'json'\ndir = '/var/log/gitlab/gitaly'\n\n[auth]\n\n[git]\n\n[gitaly-ruby]\ndir = \"/opt/gitlab/embedded/service/gitaly-ruby\"\nrugged_git_config_search_path = \"/opt/gitlab/embedded/etc\"\n\n[gitlab-shell]\ndir = \"/opt/gitlab/embedded/service/gitlab-shell\"\ngitlab_url = 'http://127.0.0.1:8080'\n")])])]),a("h4",{attrs:{id:"_1-3-6-日志logrotate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-6-日志logrotate"}},[t._v("#")]),t._v(" 1.3.6 日志logrotate")]),t._v(" "),a("p",[t._v("/var/opt/gitlab/logrotate/logrotate.conf")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("include /var/opt/gitlab/logrotate/logrotate.d/nginx\ninclude /var/opt/gitlab/logrotate/logrotate.d/puma\ninclude /var/opt/gitlab/logrotate/logrotate.d/actioncable\ninclude /var/opt/gitlab/logrotate/logrotate.d/unicorn\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-rails\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-shell\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-workhorse\ninclude /var/opt/gitlab/logrotate/logrotate.d/gitlab-pages\n")])])]),a("h4",{attrs:{id:"_1-3-7-ssl-ssh"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-7-ssl-ssh"}},[t._v("#")]),t._v(" 1.3.7 SSL & SSH")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/settings/ssl.html")]),t._v(" "),a("p",[t._v("刚开始想用let's ecrypt，发现")]),t._v(" "),a("p",[t._v("https://certbot.eff.org/lets-encrypt/centosrhel7-nginx")]),t._v(" "),a("p",[t._v("这自动更新得联网啊，而且我连个域名都没有，直接是ip访问")]),t._v(" "),a("p",[t._v("还是用自签吧，但是又发现有坑："),a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/troubleshooting/ssl.html#unable-to-perform-git-operations-due-to-an-internal-or-self-signed-certificate",target:"_blank",rel:"noopener noreferrer"}},[t._v("Unable to perform Git operations due to an internal or self-signed certificate"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("大概意思是，自签没问题，但是git客户端无法验证自签证书，要么得一个个git客户端安装一遍，要么disable ssl verify，总归是坑")]),t._v(" "),a("p",[t._v("ssh")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/gitlab-basics/create-your-ssh-keys.html#create-and-add-your-ssh-key-pair")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('ssh-keygen -t ed25519 -C "<comment>"\n')])])]),a("h3",{attrs:{id:"_1-4-商业版"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-商业版"}},[t._v("#")]),t._v(" 1.4 商业版")]),t._v(" "),a("p",[t._v("[https://docs.gitlab.com/ee/user/admin_area/license.html#:~:text=Add%20your%20license%20at%20install,and%20filename%20for%20the%20license.](https://docs.gitlab.com/ee/user/admin_area/license.html#:~:text=Add your license at install,and filename for the license.)")]),t._v(" "),a("p",[t._v("https://packages.gitlab.com/gitlab/gitlab-ee")]),t._v(" "),a("h2",{attrs:{id:"_3-high-availability"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-high-availability"}},[t._v("#")]),t._v(" 3. High Availability")]),t._v(" "),a("p",[t._v("总体上说，")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("CE版本")]),t._v(" "),a("p",[t._v("结合gitlab服务端架构，随便搜一下可以看到都是抄来抄去的同类文章https://www.cnblogs.com/wangshuyang/p/10946099.html")]),t._v(" "),a("p",[t._v("网上大多建议装两个单机版（all in one），前面用Virtual IP或floating IP，然后两个单机通过NFS共享磁盘，由于NFS即将被移除，其他思路就是DRBD或者rsync整个磁盘同步，所以这个方案实际是主备（冷备），每次只是开一个机器，当挂掉之后，可以启动备用")]),t._v(" "),a("p",[t._v("https://www.digitalocean.com/community/tutorials/how-to-set-up-highly-available-web-servers-with-keepalived-and-floating-ips-on-ubuntu-14-04")])]),t._v(" "),a("li",[a("p",[t._v("EE版本")]),t._v(" "),a("p",[t._v("采用主主（热备）")]),t._v(" "),a("p",[t._v("切分成两大部分，gitlab-server和Gitaly cluster，Gitaly cluster本身就是集群模式，gitlab-server需要借助load Balancer搞成ha，比如借助haproxy，然后多个gitlab-server节点之间共享Application database和Gitaly cluster；")]),t._v(" "),a("p",[t._v("gitlab-sever跟Gitaly cluster之间是通过Praefect连接，Praefect本身只是路由，所以可以做成多节点，加一个loadBalancer；")]),t._v(" "),a("p",[t._v("注意loadBalancer本身也是可以做成多节点的，参考haproxy的文章；")])])]),t._v(" "),a("blockquote",[a("p",[t._v("gitlab内部可以做给个部分的ha，比如")]),t._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/postgresql/replication_and_failover.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Configure the database"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/high_availability/redis.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Configure Redis"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/high_availability/nfs.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Configure NFS"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/high_availability/gitlab.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Configure the GitLab application servers"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("不过需要注意的是，NFS在新版已经deprecated并且会被删除")]),t._v(" "),a("p",[t._v("high_availability['mountpoint']")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/high_availability/gitlab.html")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/high_availability/nfs.html")]),t._v(" "),a("p",[a("strong",[t._v("Caution:")]),t._v(" From GitLab 13.0, using NFS for Git repositories is deprecated. In GitLab 14.0, support for NFS for Git repositories is scheduled to be removed. Upgrade to "),a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/gitaly/praefect.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Gitaly Cluster"),a("OutboundLink")],1),t._v(" as soon as possible.")]),t._v(" "),a("p",[t._v("可以看到官方已经不推荐了")])]),t._v(" "),a("h3",{attrs:{id:"_3-1-gitlay-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-gitlay-cluster"}},[t._v("#")]),t._v(" 3.1 gitlay cluster")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/gitaly/praefect.html")]),t._v(" "),a("ul",[a("li",[t._v("1 load balancer")]),t._v(" "),a("li",[t._v("1 PostgreSQL server (PostgreSQL 11 or newer)")]),t._v(" "),a("li",[t._v("3 Praefect nodes")]),t._v(" "),a("li",[t._v("3 Gitaly nodes (1 primary, 2 secondary)")])]),t._v(" "),a("h4",{attrs:{id:"_3-1-1-postgresql-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-1-postgresql-server"}},[t._v("#")]),t._v(" 3.1.1 postgresql server:")]),t._v(" "),a("p",[t._v("https://www.postgresql.org/download/linux/redhat/")]),t._v(" "),a("p",[t._v("https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-libs.html")]),t._v(" "),a("p",[t._v("find direct rpm download:")]),t._v(" "),a("p",[t._v("https://yum.postgresql.org/rpmchart/")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("postgresql12"),a("OutboundLink")],1),t._v(" - PostgreSQL client programs and libraries")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-contrib.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("postgresql12-contrib"),a("OutboundLink")],1),t._v(" - Contributed source and binaries distributed with PostgreSQL")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-libs.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("postgresql12-libs"),a("OutboundLink")],1),t._v(" - The shared libraries required for any PostgreSQL clients")]),t._v(" "),a("li",[a("a",{attrs:{href:"https://yum.postgresql.org/12/redhat/rhel-7-x86_64/repoview/postgresql12-server.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("postgresql12-server"),a("OutboundLink")],1),t._v(" - The programs needed to create and run a PostgreSQL server")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v(' ## 安装postgresql：：\n \n 40  cd /opt/\n   43  sudo mkdir postgresql\n   44  mv ~/postgresql12-* postgresql/\n   45  sudo mv ~/postgresql12-* postgresql/\n   47  cd postgresql/\n   50  sudo yum localinstall postgresql12-libs-12.3-5PGDG.rhel7.x86_64.rpm\n   52  sudo yum localinstall postgresql12-12.3-5PGDG.rhel7.x86_64.rpm\n   53  sudo yum localinstall postgresql12-server-12.3-5PGDG.rhel7.x86_64.rpm\n   54  sudo yum localinstall postgresql12-contrib-12.3-5PGDG.rhel7.x86_64.rpm\n   55  ll /usr/\n   56  /usr/pgsql-12/bin/postgresql-12-setup initdb\n   57  sudo /usr/pgsql-12/bin/postgresql-12-setup initdb\n   58  sudo systemctl enable postgresql-12\n   59  sudo systemctl start postgresql-12\n   \n   [liuyue@sgkc2-cicd-v02 ~]$ sudo ps -lef|grep "postgre"\n4 S postgres   987     1  0  80   0 - 99348 poll_s 16:59 ?        00:00:00 /usr/pgsql-12/bin/postmaster -D /var/lib/pgsql/12/data/\n1 S postgres   989   987  0  80   0 - 62944 ep_pol 16:59 ?        00:00:00 postgres: logger\n1 S postgres   991   987  0  80   0 - 99348 ep_pol 16:59 ?        00:00:00 postgres: checkpointer\n1 S postgres   992   987  0  80   0 - 99381 ep_pol 16:59 ?        00:00:00 postgres: background writer\n1 S postgres   993   987  0  80   0 - 99348 ep_pol 16:59 ?        00:00:00 postgres: walwriter\n1 S postgres   994   987  0  80   0 - 99486 ep_pol 16:59 ?        00:00:00 postgres: autovacuum launcher\n1 S postgres   995   987  0  80   0 - 62943 ep_pol 16:59 ?        00:00:00 postgres: stats collector\n1 S postgres   996   987  0  80   0 - 99486 ep_pol 16:59 ?        00:00:00 postgres: logical replication launcher\n\n')])])]),a("p",[t._v("下一步 为Praefect创建数据库")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("刚开始想着从Praefect服务器直接连过来，发现失败\n\n# the database template1 is used because it is created by default on all PostgreSQL servers.\n/opt/gitlab/embedded/bin/psql -U postgres -d template1 -h POSTGRESQL_SERVER_ADDRESS\n\n")])])]),a("p",[t._v("登录失败！ 需要修改监听端口和登录的方式，具体参考《database/postgresql》的设置说明")]),t._v(" "),a("p",[t._v("另外如果有防火墙还要开端口")]),t._v(" "),a("p",[t._v("firewall-cmd --permanent --add-port=5432/tcp")]),t._v(" "),a("p",[t._v("firewall-cmd --reload")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("su - postgres\n\npsql\ncreate user gitlabuser password 'gitlab';\nCREATE ROLE praefect WITH LOGIN CREATEDB PASSWORD 'PRAEFECT_SQL_PASSWORD';\nALTER ROLE praefect with PASSWORD 'test';\n然后再从Praefect服务器用新创建的用户连过来\n/opt/gitlab/embedded/bin/psql -U praefect -d template1 -h 172.26.101.134\n\n> CREATE DATABASE praefect_production WITH ENCODING=UTF8;\n By creating the database while connected as the praefect user, we are confident they have access.\n\n\ntemplate1=> \\du\n                                   List of roles\n Role name |                         Attributes                         | Member of\n-----------+------------------------------------------------------------+-----------\n postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | {}\n praefect  | Create DB                                                  | {}\n \ntemplate1=> CREATE DATABASE praefect_production WITH ENCODING=UTF8;\nCREATE DATABASE\ntemplate1=> \\l\n                                       List of databases\n        Name         |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges\n---------------------+----------+----------+-------------+-------------+-----------------------\n postgres            | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |\n praefect_production | praefect | UTF8     | en_US.UTF-8 | en_US.UTF-8 |\n template0           | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +\n                     |          |          |             |             | postgres=CTc/postgres\n template1           | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +\n                     |          |          |             |             | postgres=CTc/postgres\n(4 rows)\ntemplate1-> use tempalte1\ntemplate1-> \\dt\nDid not find any relations.\ntemplate1-> use template0\ntemplate1-> \\dt\nDid not find any relations.\ntemplate1-> use postgres\ntemplate1-> \\dt\nDid not find any relations.\ntemplate1-> use praefect_production\ntemplate1-> \\dt\nDid not find any relations.\n\n!!!\n我发现后面我连了Praefect过来，同样全部为空，难道一台Praefect并没有用到这个db？？？\n!!!\n我错了，跟mysql语法不同！！！ Postgresql是用 \\c praefect_production; 切换数据库！！！\n\n/opt/gitlab/embedded/bin/psql -U praefect -d praefect_production -h <POSTGRESQL_SERVER_ADDRESS>\n\n# create database gitlabdb with owner gitlab;\n# alter database gitlabdb set search_path to sgc2,public;\n# alter user gitlab set search_path to sgc2,public;\n\n# create schema sgc2backup;\n# create user arch password 'gitlab';\n# alter user arch set search_path to sgc2backup;\n# alter schema sgc2backup owner to arch;\n\n# grant connect on database gitlabdb to arch;\n# grant usage, create on schema sgc2backup to arch;\n\n# GRANT USAGE ON SCHEMA sgc2backup TO gitlab;\n# grant select on all tables in schema sgc2backup to gitlab;\n# revoke insert,update,delete on all tables in schema sgc2backup from gitlab;\n\n# GRANT USAGE ON SCHEMA sgc2 TO arch;\n# grant select on all tables in schema sgc2 to arch;\n# revoke insert,update,delete on all tables in schema sgc2 from arch;\n\n")])])]),a("p",[t._v("卸载：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("rpm -e postgresql-server\t\nrpm -e postgresql-contrib\t\nrpm -e postgresql\t\nrpm -e postgresql-libs\n")])])]),a("h4",{attrs:{id:"_3-1-2-gitaly-nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-2-gitaly-nodes"}},[t._v("#")]),t._v(" 3.1.2 Gitaly Nodes")]),t._v(" "),a("p",[t._v("这次采用了yum localinstall 没有采用rpm -ivh 不知道后续再用rpm -uvh升级是否有问题")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Installing:.......\n\nThank you for installing GitLab!\nGitLab was unable to detect a valid hostname for your instance.\nPlease configure a URL for your GitLab instance by setting `external_url`\nconfiguration in /etc/gitlab/gitlab.rb file.\nThen, you can start your GitLab instance by running the following command:\n  sudo gitlab-ctl reconfigure\n\nFor a comprehensive list of configuration options please see the Omnibus GitLab readme\nhttps://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md\n.....                                                                                             8/8\n\nInstalled:\n  gitlab-ce.x86_64 0:13.0.7-ce.0.el7\n\nDependency Installed:\n  audit-libs-python.x86_64 0:2.8.5-4.el7     checkpolicy.x86_64 0:2.5-8.el7        libcgroup.x86_64 0:0.41-21.el7     libsemanage-python.x86_64 0:2.5-14.el7     policycoreutils-python.x86_64 0:2.5-34.el7\n  python-IPy.noarch 0:0.75-6.el7             setools-libs.x86_64 0:3.3.8-4.el7\n\nComplete!\n")])])]),a("p",[t._v("gitaly['listen_addr'] = '0.0.0.0:8075'")]),t._v(" "),a("p",[t._v("gitaly['auth_token'] = 'PRAEFECT_INTERNAL_TOKEN'\t对应 praefect")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("praefect['virtual_storages'] = {\n  'storage-1' => {\n    'gitaly-1' => {\n      'address' => 'tcp://GITALY_HOST:8075',\n      'token'   => 'PRAEFECT_INTERNAL_TOKEN',\n      'primary' => true\n    },\n    'gitaly-2' => {\n      'address' => 'tcp://GITALY_HOST:8075',\n      'token'   => 'PRAEFECT_INTERNAL_TOKEN'\n    },\n    'gitaly-3' => {\n      'address' => 'tcp://GITALY_HOST:8075',\n      'token'   => 'PRAEFECT_INTERNAL_TOKEN'\n    }\n  }\n}\n")])])]),a("p",[t._v("下面这两个是git push需要回调的")]),t._v(" "),a("p",[t._v("gitlab_shell['secret_token'] = 'GITLAB_SHELL_SECRET_TOKEN' 这个是对应gitlab server配置的同样的token")]),t._v(" "),a("p",[t._v("# Don't forget to copy "),a("code",[t._v("/etc/gitlab/gitlab-secrets.json")]),t._v(" from Gitaly client to Gitaly server. （？这句话是因为什么，是不是跟gitlab_shell['secret_token'] 不同的验证方式，公私钥验证？）")]),t._v(" "),a("p",[t._v("gitlab_rails['internal_api_url'] = '172.26.101.133:8088' 对应gitlab server API，")]),t._v(" "),a("p",[t._v("internal_api_url 会在gitlab-ctl reconfigure的时候被赋值到/opt/gitlab/embedded/service/gitlab-shell/config.yml以及")]),t._v(" "),a("p",[t._v("/var/opt/gitlab/gitlab-shell/config.yml，注意我发现gitlab server上的这个配置文件内容却是8080端口，可能对外统一都是8088，然后对内是8080")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('# Url to gitlab instance. Used for api calls. May but need not end with a slash.\ngitlab_url: "http://127.0.0.1:8080"\n')])])]),a("p",[t._v("就是对应的gitlab server上面的puma web服务（unicorn）")]),t._v(" "),a("h4",{attrs:{id:"_3-1-3-测试连通性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-3-测试连通性"}},[t._v("#")]),t._v(" 3.1.3 测试连通性")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("postgresql server open port 5432 to praefect server;\n​\ton praefect server: sudo -u git /opt/gitlab/embedded/bin/praefect -config /var/opt/gitlab/praefect/config.toml sql-ping\n/opt/gitlab/embedded/bin/psql -U praefect -d template1 -h 172.26.101.134\n\npraefect server open port 2305 and 9652 to gitlab server;\n​\ton gitlab server: gitlab-rake gitlab:gitaly:check\n sudo gitlab-rake gitlab:check SANITIZE=true\n\ngitlab server open api 8080? to gitaly server;\n​\ton gitaly nodes: \n/opt/gitlab/embedded/service/gitlab-shell/bin/check -config /opt/gitlab/embedded/service/gitlab-shell/config.yml\nor\n/opt/gitlab/embedded/bin/gitaly-hooks check /var/opt/gitlab/gitaly/config.toml\n\n\ngitaly server open 9236 to gitlab server;\t\n\ngitaly server open 8075 to praefect server; \n​\ton praefect server: sudo /opt/gitlab/embedded/bin/praefect -config /var/opt/gitlab/praefect/config.toml dial-nodes\n\nprometheus_listen_addr\nPraefect的9652 和 Gitaly的9236：\ngrafana打开explorer，输入gitlab_build_info 结果中可以看到localhost的gitlab server，Praefect，以及三个Gitaly，如果看不到，就说明端口没有开启或者防火墙挡住\n")])])]),a("p",[t._v("通信TOKEN")]),t._v(" "),a("p",[t._v("可以用"),a("code",[t._v("tool: openssl rand -base64 32")]),t._v(" 生成")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("GITLAB_SHELL_SECRET_TOKEN: this is used by Git hooks to make callback HTTP API requests to GitLab when accepting a Git push. This secret is shared with GitLab Shell for legacy reasons.\n\nPRAEFECT_EXTERNAL_TOKEN: repositories hosted on your Praefect cluster can only be accessed by Gitaly clients that carry this token.\n\nPRAEFECT_INTERNAL_TOKEN: this token is used for replication traffic inside your Praefect cluster. This is distinct from PRAEFECT_EXTERNAL_TOKEN because Gitaly clients must not be able to access internal nodes of the Praefect cluster directly; that could lead to data loss.\n\nPRAEFECT_SQL_PASSWORD: this password is used by Praefect to connect to PostgreSQL.\n\n--------------------------------------------------------------------\n--- gitlab server:\n--------------------------------------------------------------------\ngit_data_dirs({\n  \"default\" => {\n    \"gitaly_address\" => \"tcp://<PRAEFECT IP>:2305\",\n    \"gitaly_token\" => 'PRAEFECT_EXTERNAL_TOKEN'\n  }\n})\n\ngitlab_shell['secret_token'] = 'GITLAB_SHELL_SECRET_TOKEN'\n\n--------------------------------------------------------------------\n--- praefect:\n--------------------------------------------------------------------\npraefect['auth_token'] = 'PRAEFECT_EXTERNAL_TOKEN'\n\n\npraefect['database_host'] = '<TRACKING POSTGRESQL DATABASE IP>'\npraefect['database_port'] = 5432\npraefect['database_user'] = 'praefect'\npraefect['database_password'] = 'PRAEFECT_SQL_PASSWORD'\npraefect['database_dbname'] = 'praefect_production'\n\n# Name of storage hash must match storage name in git_data_dirs on GitLab\n# server ('praefect') and in git_data_dirs on Gitaly nodes ('gitaly-1')\npraefect['virtual_storages'] = {\n  'default' => {\n    'gitaly-1' => {\n      'address' => 'tcp://<GITALY VM1 IP>:8075',\n      'token'   => 'PRAEFECT_INTERNAL_TOKEN',\n    },\n    'gitaly-2' => {\n      'address' => 'tcp://<GITALY VM2 IP>:8075',\n      'token'   => 'PRAEFECT_INTERNAL_TOKEN'\n    },\n    'gitaly-3' => {\n      'address' => 'tcp://<GITALY VM3 IP>:8075',\n      'token'   => 'PRAEFECT_INTERNAL_TOKEN'\n    }\n  }\n}\n--------------------------------------------------------------------\n--- gitaly:\n--------------------------------------------------------------------\ngitaly['auth_token'] = 'PRAEFECT_INTERNAL_TOKEN'\n\ngitlab_shell['secret_token'] = 'GITLAB_SHELL_SECRET_TOKEN'\n")])])]),a("h3",{attrs:{id:"_3-2-gitrail-server-multi-nodes"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-gitrail-server-multi-nodes"}},[t._v("#")]),t._v(" 3.2 gitrail-server multi-nodes")]),t._v(" "),a("h4",{attrs:{id:"官方方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#官方方案"}},[t._v("#")]),t._v(" 官方方案")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/geo/replication/multiple_servers.html#geo-for-multiple-nodes-premium-only")]),t._v(" "),a("p",[t._v("然后我顺着找到这个https://docs.gitlab.com/ee/administration/reference_architectures/index.html#traffic-load-balancer-starter-only")]),t._v(" "),a("blockquote",[a("p",[t._v("This requires separating out GitLab into multiple application nodes with an added "),a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/high_availability/load_balancer.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("load balancer"),a("OutboundLink")],1),t._v(". The load balancer will distribute traffic across GitLab application nodes. Meanwhile, each application node connects to a shared file server and database systems on the back end. This way, if one of the application servers fails, the workflow is not interrupted. "),a("a",{attrs:{href:"https://www.haproxy.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("HAProxy"),a("OutboundLink")],1),t._v(" is recommended as the load balancer.")]),t._v(" "),a("p",[t._v("Supported tiers: "),a("a",{attrs:{href:"https://about.gitlab.com/pricing/",target:"_blank",rel:"noopener noreferrer"}},[t._v("GitLab Starter, Premium, and Ultimate"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("可以看到这个是要付费后才支持的，主要就是如何配置share db；")]),t._v(" "),a("p",[t._v("还有几个疑问：redis不需要分离吗？ session存储在哪里，如何share？有几种可能：\n1.load Balancer可以有策略让一个用户整个session期间只连接固定一个Application server，所以不会有session共享问题\n2.session写到了db，按这里文档所说分离share db即可\n3.session写到redis，分离share redis即可（但是文档此处没有提redis）\n4.session写到Application memory，这个解决只能用方法1")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/high_availability/load_balancer.html#load-balancer-for-multi-node-gitlab")]),t._v(" "),a("p",[t._v("这个是在gitlab scope之外，采用外部的负载均衡，")]),t._v(" "),a("p",[t._v("跟gitlab沟通的结果发现，他们故意这种搞，就是为了卖他们的premium account所带的技术支持服务，")]),t._v(" "),a("p",[t._v("当然我推测了下，上面说的 shared file server应该是指Gitaly nodes，那么database system是指postgresql，然后我从gitlab server的config里面看到")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("### GitLab database settings\n###! Docs: https://docs.gitlab.com/omnibus/settings/database.html\n###! **Only needed if you use an external database.**\n# gitlab_rails['db_adapter'] = \"postgresql\"\n# gitlab_rails['db_encoding'] = \"unicode\"\n# gitlab_rails['db_collation'] = nil\n# gitlab_rails['db_database'] = \"gitlabhq_production\"\n# gitlab_rails['db_pool'] = 1\n# gitlab_rails['db_username'] = \"gitlab\"\n# gitlab_rails['db_password'] = nil\n# gitlab_rails['db_host'] = nil\n# gitlab_rails['db_port'] = 5432\n# gitlab_rails['db_socket'] = nil\n# gitlab_rails['db_sslmode'] = nil\n# gitlab_rails['db_sslcompression'] = 0\n# gitlab_rails['db_sslrootcert'] = nil\n# gitlab_rails['db_sslcert'] = nil\n# gitlab_rails['db_sslkey'] = nil\n# gitlab_rails['db_prepared_statements'] = false\n# gitlab_rails['db_statements_limit'] = 1000\n\n\n### GitLab Redis settings\n###! Connect to your own Redis instance\n###! Docs: https://docs.gitlab.com/omnibus/settings/redis.html\n\n#### Redis TCP connection\n# gitlab_rails['redis_host'] = \"127.0.0.1\"\n# gitlab_rails['redis_port'] = 6379\n# gitlab_rails['redis_ssl'] = false\n# gitlab_rails['redis_password'] = nil\n# gitlab_rails['redis_database'] = 0\n# gitlab_rails['redis_enable_client'] = true\n")])])]),a("p",[t._v("所以推测只需要按照如下文档建立一个外部db即可")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/settings/database.html")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/settings/database.html#using-a-non-packaged-postgresql-database-management-server")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/install/requirements.html#database")]),t._v(" "),a("p",[t._v("但是还有个问题，redis是不是也要剥离到外部？从配置文件看确实可以，但是这些弄下来需要的机器实在不少，而且也是难以维护，所3以我没有尝试；")]),t._v(" "),a("h4",{attrs:{id:"备份方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份方案"}},[t._v("#")]),t._v(" 备份方案")]),t._v(" "),a("p",[t._v("method 1： back & restore")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("uninstall...\ninstall same version as the source machine\nsystemctl start gitlab-runsvdir\nsudo gitlab-ctl reconfigure\nsudo gitlab-ctl start\nfrom source:\nsudo scp root@172.26.101.133:/var/opt/gitlab/backups/1600046306_2020_09_14_13.3.0-ee_gitlab_backup.tar /var/opt/gitlab/backups/\nsudo chown git.git /var/opt/gitlab/backups/1600046306_2020_09_14_13.3.0-ee_gitlab_backup.tar\n\nsudo gitlab-ctl stop unicorn\nsudo gitlab-ctl stop puma\nsudo gitlab-ctl stop sidekiq\n# Verify\nsudo gitlab-ctl status\n\n# This command will overwrite the contents of your GitLab database! \nsudo gitlab-backup restore BACKUP=/var/opt/gitlab/backups/1600046306_2020_09_14_13.3.0-ee_gitlab_backup.tar\nThe backup file 1600046306_2020_09_14_13.3.0-ee_gitlab_backup_gitlab_backup.tar does not exist!\n\nsudo gitlab-backup restore 不加参数居然是可以工作的，所以/var/opt/gitlab/backups下面只放一个tar\n\nrestore `/etc/gitlab/gitlab-secrets.json`\nsudo scp root@172.26.101.133:/etc/gitlab/config_backup/gitlab_config_1598345534_2020_08_25.tar /etc/gitlab/\nsudo mv /etc/gitlab /etc/gitlab.$(date +%s)\nsudo tar -xf gitlab_config_1598345534_2020_08_25.tar -C /\ntar: Removing leading `/' from member names 这句话不知道什么意思\n\nvim /etc/gitlab/gitlab.rb 修改external_url\nsudo gitlab-ctl reconfigure\nsudo gitlab-ctl restart\n注意执行上面一句的时候要等一会才开始执行下面的检查，否则会抛很多错误\nsudo gitlab-rake gitlab:check SANITIZE=true\n  \n开放相应的端口，并进行连通性检测\ngitlab server open api 8080? to gitaly server;\n\n修改Gitaly nodes的internal_api_url\n")])])]),a("p",[t._v("method 2：rsync")]),t._v(" "),a("p",[t._v("安装rsync实现自动增量同步到远端")]),t._v(" "),a("p",[t._v("参考《linux/rsync》")]),t._v(" "),a("p",[t._v("https://www.jianshu.com/p/bc45631aa561")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('------------------------------------------------\n--- 服务器端\n------------------------------------------------\nyum install rsync\n\nvim /etc/rsyncd.conf\n​```\n# /etc/rsyncd: configuration file for rsync daemon mode\n\n# See rsyncd.conf man page for more options.\n\n# configuration example:\n\nuid = root\ngid = root\nuse chroot = no\n#port = 973\n# max connections = 4\npid file = /var/run/rsyncd.pid\nlog file = /var/rsync/rsyncd.log\nsecrets file = /etc/rsync.password\n# exclude = lost+found/\n# transfer logging = yes\n# timeout = 900\n# ignore nonreadable = yes\n# dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2\n\n# [ftp]\n#        path = /home/ftp\n#        comment = ftp export area\n[gitlab_path1]\ncomment = "/opt/gitlab"\npath = /opt/gitlab\nauth users = root, rsync_backup\nread only = yes \nlist = yes \nhosts allow = <DEST IP>\nhosts deny = *\n[gitlab_path2]\ncomment = "/var/opt/gitlab"\npath = /var/opt/gitlab\nauth users = root, rsync_backup\nread only = yes\nlist = yes \nhosts allow = <DEST IP>\nhosts deny = *\n[gitlab_path3]\ncomment = "/etc/gitlab"\npath = /etc/gitlab\nauth users = root, rsync_backup\nread only = yes \nlist = yes \nhosts allow = <DEST IP>\nhosts deny = *\n[gitlab_path4]\ncomment = "/var/log/gitlab"\npath = /var/log/gitlab\nauth users = root, rsync_backup\nread only = yes \nlist = yes \nhosts allow = <DEST IP>\nhosts deny = *\n[gitlab_path5]\ncomment = "/run/gitlab"\npath = /run/gitlab\nauth users = root, rsync_backup\nread only = yes \nlist = yes \nhosts allow = <DEST IP>\nhosts deny = *\n​```\n\necho "rsync_backup:1" >/etc/rsync.password  \nchmod 600 /etc/rsync.password\n\nfirewall-cmd --permanent --add-port=873/tcp\nfirewall-cmd --reload\n\n------------------------------------------------\n--- 客户端\n------------------------------------------------\nyum install rsync\n\necho "1" >/etc/rsync.password  \nchmod 600 /etc/rsync.password\n\nvim /opt/gitlab_rsync.sh\n\nrsync -avz --delete rsync_backup@<SOURCE IP>::gitlab_path1 /opt/gitlab --password-file=/etc/rsync.password >/dev/null 2>&1\nrsync -avz --delete rsync_backup@<SOURCE IP>::gitlab_path2 /var/opt/gitlab --password-file=/etc/rsync.password >/dev/null 2>&1\nrsync -avz --delete rsync_backup@<SOURCE IP>::gitlab_path3 /etc/gitlab --password-file=/etc/rsync.password >/dev/null 2>&1\nrsync -avz --delete rsync_backup@<SOURCE IP>::gitlab_path4 /var/log/gitlab --password-file=/etc/rsync.password >/dev/null 2>&1\nrsync -avz --delete rsync_backup@<SOURCE IP>::gitlab_path5 /run/gitlab --password-file=/etc/rsync.password >/dev/null 2>&1\n\nchmod 755 /opt/gitlab_rsync.sh\n\necho "00 3 * * * root /opt/gitlab_rsync.sh" >> /etc/crontab\n\n')])])]),a("h3",{attrs:{id:"_3-3-postgresql-replication"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-postgresql-replication"}},[t._v("#")]),t._v(" 3.3 Postgresql Replication")]),t._v(" "),a("p",[t._v("GEO 这个不需要https://docs.gitlab.com/ee/administration/geo/replication/index.html")]),t._v(" "),a("p",[t._v("需要的是gitlab-server Application Database和Praefect tracking database")]),t._v(" "),a("h3",{attrs:{id:"_3-4-？？ha-roles"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-？？ha-roles"}},[t._v("#")]),t._v(" 3.4 ？？HA Roles")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/roles/README.html#")]),t._v(" "),a("p",[t._v("The majority of the following roles will only work on a GitLab Enterprise Edition, meaning a gitlab-ee Omnibus package. It will be mentioned next to each role.")]),t._v(" "),a("p",[t._v("没太搞懂，直接通过配置多个节点？ee才可以用")]),t._v(" "),a("p",[t._v("redis roles")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/roles/README.html#redis-server-roles")]),t._v(" "),a("h2",{attrs:{id:"_4-maintenance-维护"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-maintenance-维护"}},[t._v("#")]),t._v(" 4. Maintenance 维护")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/maintenance/README.html")]),t._v(" "),a("h3",{attrs:{id:"数据管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据管理"}},[t._v("#")]),t._v(" 数据管理")]),t._v(" "),a("h4",{attrs:{id:"gitlab-server-workhorse"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-server-workhorse"}},[t._v("#")]),t._v(" gitlab server(workhorse)")]),t._v(" "),a("h5",{attrs:{id:"gitlab-rails-dbconsole"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-rails-dbconsole"}},[t._v("#")]),t._v(" gitlab-rails dbconsole")]),t._v(" "),a("p",[t._v("gitlabhq_production=>\\dt")]),t._v(" "),a("h5",{attrs:{id:"gitlab-rails-console-users-and-products"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-rails-console-users-and-products"}},[t._v("#")]),t._v(" gitlab-rails console >> users and products")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/troubleshooting/navigating_gitlab_via_rails_console.html")]),t._v(" "),a("p",[t._v("密码默认8位")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("user=User.where(username: 'test1').first\nuser.password\nuser.password='12345678'\nuser.password_confirmation='12345678'\nuser.save\nEnqueued ActionMailer::DeliveryJob (Job ID: 1fd0a22c-6908-45bd-b0b1-35f4da4aad25) to Sidekiq(mailers) with arguments: \"DeviseMailer\", \"password_change\", \"deliver_now\", #<GlobalID:0x00007fd3a9a03370 @uri=#<URI::GID gid://gitlab/User/2>>\n=> true\n")])])]),a("p",[t._v("Access control")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/security/README.html#securing-your-gitlab-installation")]),t._v(" "),a("h4",{attrs:{id:"praefect-database"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#praefect-database"}},[t._v("#")]),t._v(" praefect database")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("su - postgres\n-bash-4.2$ psql\npostgres-# \\c praefect_production;\npraefect_production-# \\dt\n")])])]),a("h4",{attrs:{id:"gitaly-repository"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitaly-repository"}},[t._v("#")]),t._v(" gitaly repository")]),t._v(" "),a("p",[t._v("ls /var/opt/gitlab/git-data/repositories")]),t._v(" "),a("h3",{attrs:{id:"备份迁移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#备份迁移"}},[t._v("#")]),t._v(" 备份迁移")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/omnibus/settings/backups.html")]),t._v(" "),a("h4",{attrs:{id:"配置备份-backup-and-restore-omnibus-gitlab-configuration"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置备份-backup-and-restore-omnibus-gitlab-configuration"}},[t._v("#")]),t._v(" 配置备份 Backup and restore Omnibus GitLab configuration")]),t._v(" "),a("p",[t._v("It is recommended to keep a copy of "),a("code",[t._v("/etc/gitlab")]),t._v(", or at least of "),a("code",[t._v("/etc/gitlab/gitlab-secrets.json")]),t._v(", in a safe place. If you ever need to restore a GitLab application backup you need to also restore "),a("code",[t._v("gitlab-secrets.json")]),t._v(". If you do not, GitLab users who are using two-factor authentication will lose access to your GitLab server and ‘secure variables’ stored in GitLab CI will be lost.")]),t._v(" "),a("p",[t._v("Your machines SSH host keys are stored in a separate location at "),a("code",[t._v("/etc/ssh/")]),t._v(". Be sure to also "),a("a",{attrs:{href:"https://superuser.com/questions/532040/copy-ssh-keys-from-one-server-to-another-server/532079#532079",target:"_blank",rel:"noopener noreferrer"}},[t._v("backup and restore those keys"),a("OutboundLink")],1),t._v(" to avoid man-in-the-middle attack warnings if you have to perform a full machine restore.")]),t._v(" "),a("p",[t._v("do not store your GitLab application backups (Git repositories, SQL data) in the same place as your configuration backup ("),a("code",[t._v("/etc/gitlab")]),t._v("). The "),a("code",[t._v("gitlab-secrets.json")]),t._v(" file (and possibly also the "),a("code",[t._v("gitlab.rb")]),t._v(" file) contain database encryption keys to protect sensitive data in the SQL database:")]),t._v(" "),a("ul",[a("li",[t._v("GitLab two-factor authentication (2FA) user secrets (‘QR codes’)")]),t._v(" "),a("li",[t._v("GitLab CI ‘secure variables’")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("MANUAL BACKUP:\n`gitlab-ctl backup-etc`\nConfiguration backup archive complete: /etc/gitlab/config_backup/gitlab_config_1598345534_2020_08_25.tar\n\nAUTO BACKUP:\nsudo crontab -e -u root\nschedule the backup to run every morning after a weekday, Tuesday (day 2) through Saturday (day 6):\n15 04 * * 2-6  gitlab-ctl backup-etc && cd /etc/gitlab/config_backup && cp $(ls -t | head -n1) /secret/gitlab/backups/\n\nRESTORE:\n# Rename the existing /etc/gitlab, if any\nsudo mv /etc/gitlab /etc/gitlab.$(date +%s)\n# Change the example timestamp below for your configuration backup\nsudo tar -xf gitlab_config_1487687824_2017_02_21.tar -C /\nsudo gitlab-ctl reconfigure\n")])])]),a("h4",{attrs:{id:"creating-an-application-backup"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#creating-an-application-backup"}},[t._v("#")]),t._v(" Creating an application backup")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/raketasks/backup_restore.html")]),t._v(" "),a("p",[t._v("GitLab provides a simple command line interface to back up your whole instance. It backs up your:")]),t._v(" "),a("ul",[a("li",[t._v("Database")]),t._v(" "),a("li",[t._v("Attachments")]),t._v(" "),a("li",[t._v("Git repositories data")]),t._v(" "),a("li",[t._v("CI/CD job output logs")]),t._v(" "),a("li",[t._v("CI/CD job artifacts")]),t._v(" "),a("li",[t._v("LFS objects")]),t._v(" "),a("li",[t._v("Container Registry images")]),t._v(" "),a("li",[t._v("GitLab Pages content")])]),t._v(" "),a("p",[t._v("The "),a("a",{attrs:{href:"https://docs.gitlab.com/ee/raketasks/backup_restore.html#back-up-gitlab",target:"_blank",rel:"noopener noreferrer"}},[t._v("backup Rake task"),a("OutboundLink")],1),t._v(" GitLab provides does "),a("strong",[t._v("not")]),t._v(" store your configuration files. The primary reason for this is that your database contains encrypted information for two-factor authentication, the CI/CD ‘secure variables’, and so on. Storing encrypted information along with its key in the same place defeats the purpose of using encryption in the first place.")]),t._v(" "),a("p",[a("strong",[t._v("prerequisites：")])]),t._v(" "),a("p",[t._v("sudo yum install rsync")]),t._v(" "),a("p",[a("strong",[t._v("START")])]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("#手动\nsudo gitlab-backup create GZIP_RSYNCABLE=yes \nCreating backup archive: 1599013473_2020_09_02_13.3.0-ee_gitlab_backup.tar ... done\nUploading backup archive to remote storage  ... skipped\nDeleting tmp directories ... done\ndone\ndone\ndone\ndone\ndone\ndone\ndone\nDeleting old backups ... skipping\nWarning: Your gitlab.rb and gitlab-secrets.json files contain sensitive data\nand are not included in this backup. You will need these files to restore a backup.\nPlease back them up manually.\nBackup task is done.\n\n/var/opt/gitlab/backups/1599013473_2020_09_02_13.3.0-ee_gitlab_backup.tar\n\n#自动\nsudo su -\ncrontab -e\n0 2 * * * /opt/gitlab/bin/gitlab-backup GZIP_RSYNCABLE=yes create CRON=1\n")])])]),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("##STRATEGY:\ndefault streaming strategy:\nsudo gitlab-backup create\n\nsudo gitlab-backup create STRATEGY=copy\n\nTo make sure the generated archive is intelligently transferable by rsync, the GZIP_RSYNCABLE=yes option can be set. This will set the --rsyncable option to gzip：\nsudo gitlab-backup GZIP_RSYNCABLE=yes\n\n##STORE:\nBackup create will store a tar file in `/var/opt/gitlab/backups`.\n\nIf you want to store your GitLab backups in a different directory, add the following setting to `/etc/gitlab/gitlab.rb` and run `sudo gitlab-ctl reconfigure`:\ngitlab_rails['backup_path'] = '/mnt/backups'\n\n##SKIP:\ndb (database)\nuploads (attachments)\nrepositories (Git repositories data)\nbuilds (CI job output logs)\nartifacts (CI job artifacts)\nlfs (LFS objects)\nregistry (Container Registry images)\npages (Pages content)\n\nsudo gitlab-backup create SKIP=db,uploads\n\nIn some cases (for example, if the backup is picked up by other backup software) creating a .tar file might be wasted effort or even directly harmful, so you can skip this step by adding tar to the SKIP environment variable:\nsudo gitlab-backup create SKIP=tar\n\n##UPLOAD:\n\nUpload to Remote: Specifying a custom directory for backups:\nsudo gitlab-backup create DIRECTORY=daily\nsudo gitlab-backup create DIRECTORY=weekly\n\nUpload to Local mounted shares:\ngitlab_rails['backup_upload_connection'] = {\n  :provider => 'Local',\n  :local_root => '/mnt/backups'\n}\n\n# The directory inside the mounted folder to copy backups to\n# Use '.' to store them in the root directory\ngitlab_rails['backup_upload_remote_directory'] = 'gitlab_backups'\n\n##PERMISSION:\ngitlab_rails['backup_archive_permissions'] = 0644 # Makes the backup archives world-readable\n\n\n## Limit backup lifetime to 7 days - 604800 seconds\ngitlab_rails['backup_keep_time'] = 604800\n\n")])])]),a("p",[t._v("Daily Backup:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sudo su -\ncrontab -e\n\nto schedule the backup for everyday at 2 AM:\n0 2 * * * /opt/gitlab/bin/gitlab-backup create CRON=1\n")])])]),a("h4",{attrs:{id:"restore"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#restore"}},[t._v("#")]),t._v(" Restore:")]),t._v(" "),a("p",[a("strong",[t._v("prerequisites")])]),t._v(" "),a("p",[t._v("!!You can only restore a backup to "),a("strong",[t._v("exactly the same version and type (CE/EE)")]),t._v(" of GitLab that you created it on, for example CE 9.1.0!!")]),t._v(" "),a("p",[t._v("need to restore "),a("code",[t._v("/etc/gitlab/gitlab-secrets.json")]),t._v("This file contains the database encryption key, "),a("a",{attrs:{href:"https://docs.gitlab.com/ee/ci/variables/README.html#gitlab-cicd-environment-variables",target:"_blank",rel:"noopener noreferrer"}},[t._v("CI/CD variables"),a("OutboundLink")],1),t._v(", and variables used for "),a("a",{attrs:{href:"https://docs.gitlab.com/ee/user/profile/account/two_factor_authentication.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("two-factor authentication"),a("OutboundLink")],1),t._v(". If you fail to restore this encryption key file along with the application data backup, users with two-factor authentication enabled and GitLab Runners will lose access to your GitLab server.")]),t._v(" "),a("ul",[a("li",[t._v("You have run "),a("code",[t._v("sudo gitlab-ctl reconfigure")]),t._v(" at least once.")]),t._v(" "),a("li",[t._v("GitLab is running. If not, start it using "),a("code",[t._v("sudo gitlab-ctl start")]),t._v(".")])]),t._v(" "),a("p",[a("strong",[t._v("Note:")]),t._v(" There is currently a "),a("a",{attrs:{href:"https://gitlab.com/gitlab-org/omnibus-gitlab/-/issues/3470",target:"_blank",rel:"noopener noreferrer"}},[t._v("known issue"),a("OutboundLink")],1),t._v(" for restore not working with "),a("code",[t._v("pgbouncer")]),t._v(". In order to workaround the issue, the Rails node will need to bypass "),a("code",[t._v("pgbouncer")]),t._v(" and connect directly to the primary database node. This can be done by setting "),a("code",[t._v("gitlab_rails['db_host']")]),t._v(" and "),a("code",[t._v("gitlab_rails['port']")]),t._v(" to connect to the primary database node and "),a("a",{attrs:{href:"https://docs.gitlab.com/ee/administration/restart_gitlab.html#omnibus-gitlab-reconfigure",target:"_blank",rel:"noopener noreferrer"}},[t._v("reconfiguring GitLab"),a("OutboundLink")],1),t._v(".")]),t._v(" "),a("p",[a("strong",[t._v("START:")])]),t._v(" "),a("p",[t._v("make sure your backup tar file is in the backup directory described in the "),a("code",[t._v("gitlab.rb")]),t._v(" configuration "),a("code",[t._v("gitlab_rails['backup_path']")]),t._v(". The default is "),a("code",[t._v("/var/opt/gitlab/backups")]),t._v(". It needs to be owned by the "),a("code",[t._v("git")]),t._v(" user.")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sudo cp 11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar /var/opt/gitlab/backups/\nsudo chown git.git /var/opt/gitlab/backups/11493107454_2018_04_25_10.6.4-ce_gitlab_backup.tar\n")])])]),a("p",[t._v("Stop the processes that are connected to the database. Leave the rest of GitLab running:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sudo gitlab-ctl stop unicorn\nsudo gitlab-ctl stop puma\nsudo gitlab-ctl stop sidekiq\n# Verify\nsudo gitlab-ctl status\n")])])]),a("p",[t._v("Restore the backup, specifying the timestamp of the backup you wish to restore:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("# This command will overwrite the contents of your GitLab database! \nsudo gitlab-backup restore BACKUP=11493107454_2018_04_25_10.6.4-ce\n")])])]),a("p",[t._v("Next, restore "),a("code",[t._v("/etc/gitlab/gitlab-secrets.json")]),t._v(" if necessary as mentioned above.")]),t._v(" "),a("p",[t._v("Reconfigure, restart and check GitLab:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("sudo gitlab-ctl reconfigure\nsudo gitlab-ctl restart\nsudo gitlab-rake gitlab:check SANITIZE=true\n")])])]),a("h3",{attrs:{id:"服务停止-升级-卸载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务停止-升级-卸载"}},[t._v("#")]),t._v(" 服务停止/升级/卸载")]),t._v(" "),a("p",[t._v("gitlab-ctl stop的坑：如果刚好你还在某个console里面，stop虽然显示全部down，但是ps -e|grep gitlab以及ps -e|grep postgres还是会看到一堆服务，")]),t._v(" "),a("p",[a("s",[t._v("所以退出正在使用的所有gitlab console，再一次执行gitlab-ctl stop，实在不行进行kill -9或者gitlab-ctl kill "),a("service")],1)]),t._v(" "),a("p",[t._v("最终发现还需要关闭一个服务：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("systemctl disable gitlab-runsvdir\nsystemctl stop gitlab-runsvdir\n")])])]),a("p",[t._v("注意:升级之后,之前的备份就会失效,意思是无法用之前的backup restore,只能降级,所以升级之后建立尽快做备份")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("(optional)\ngitlab-ctl cleanse\n\n/root/gitlab-cleanse-2020-08-20T16:28/config_backup\n\n1、停止gitlab\ngitlab-ctl stop\n2、卸载gitlab（注意这里写的是gitlab-ce）\nrpm -e gitlab-ce\n#systemctl disable gitlab-runsvdir (如果不想重装)\nsystemctl stop gitlab-runsvdir\n3、查看gitlab进程\nps -lef | grep gitlab\n4、杀掉第一个进程（就是带有好多.............的进程）\n kill -9 18777\n杀掉后，在ps aux | grep gitlab确认一遍，还有没有gitlab的进程\n5、删除所有包含gitlab文件\nfind / -name gitlab | xargs rm -rf\nyum localinstall gitlab-ce-13.0.7-ce.0.el7.x86_64.rpm\nscp root@172.26.101.136:/etc/gitlab/gitlab.rb /etc/gitlab/\nvim /etc/gitlab/gitlab.rb\n# ruby_block[wait for praefect service socket] action run\nsystemctl start gitlab-runsvdir\ngitlab-ctl reconfigure\n")])])]),a("h2",{attrs:{id:"_5-内置服务替换探索"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-内置服务替换探索"}},[t._v("#")]),t._v(" 5. 内置服务替换探索")]),t._v(" "),a("p",[t._v("！！强烈不建议，因为会影响后续升级！！")]),t._v(" "),a("h3",{attrs:{id:"替换内置服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#替换内置服务"}},[t._v("#")]),t._v(" 替换内置服务")]),t._v(" "),a("p",[t._v("nginx")]),t._v(" "),a("p",[t._v("jianshu.com/p/123778a515ca")]),t._v(" "),a("p",[t._v("grafana")]),t._v(" "),a("p",[t._v("postgresql")]),t._v(" "),a("p",[t._v("反向代理")]),t._v(" "),a("p",[t._v("https://cloud.tencent.com/developer/article/1437220")]),t._v(" "),a("p",[t._v("配置排查参考：blog.csdn.net/weixin_43748870/article/details/86178042")]),t._v(" "),a("h2",{attrs:{id:"_6-troubleshooting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-troubleshooting"}},[t._v("#")]),t._v(" 6. Troubleshooting")]),t._v(" "),a("p",[t._v("常用工具")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("gitlab-ctl tail\n")])])]),a("h3",{attrs:{id:"创建project以及浏览已有project出现500"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建project以及浏览已有project出现500"}},[t._v("#")]),t._v(" 创建project以及浏览已有project出现500")]),t._v(" "),a("p",[t._v("经过排查，放弃，重新安装，但是问题依旧，")]),t._v(" "),a("p",[t._v("通过gitlab-ctl tail查log")]),t._v(" "),a("p",[t._v("首先观察gitlab server log")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('==> /var/log/gitlab/gitlab-rails/production_json.log <==\n{"method":"POST","path":"/projects","format":"html","controller":"ProjectsController","action":"create","status":500,"time":"2020-08-21T06:41:34.153Z","params":[{"key":"utf8","value":"✓"},{"key":"authenticity_token","value":"[FILTERED]"},{"key":"project","value":{"ci_cd_only":"false","name":"helloworld","namespace_id":"1","path":"helloworld","description":"[FILTERED]","visibility_level":"0"}}],"remote_ip":"10.30.30.94","user_id":1,"username":"root","ua":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36","queue_duration_s":0.010634,"correlation_id":"s6jJ3TyP8a1","meta.user":"root","meta.caller_id":"ProjectsController#create","gitaly_calls":2,"gitaly_duration_s":0.011436,"redis_calls":14,"redis_duration_s":0.003358,"cpu_s":0.71,"exception.class":"ActionView::Template::Error","exception.message":"7:permission denied","exception.backtrace":["lib/gitlab/gitaly_client.rb:192:in `execute\'","lib/gitlab/gitaly_client.rb:170:in `block in call\'","lib/gitlab/gitaly_client.rb:198:in `measure_timings\'","lib/gitlab/gitaly_client.rb:169:in `call\'","lib/gitlab/gitaly_client/ref_service.rb:42:in `default_branch_name\'","lib/gitlab/git/repository.rb:90:in `root_ref\'","app/models/repository.rb:509:in `root_ref\'","lib/gitlab/repository_cache_adapter.rb:84:in `block (2 levels) in cache_method_asymmetrically\'","lib/gitlab/repository_cache.rb:44:in `fetch_without_caching_false\'","lib/gitlab/repository_cache_adapter.rb:179:in `block (2 levels) in cache_method_output_asymmetrically\'","lib/gitlab/safe_request_store.rb:12:in `fetch\'","lib/gitlab/repository_cache.rb:25:in `fetch\'","lib/gitlab/repository_cache_adapter.rb:178:in `block in cache_method_output_asymmetrically\'","lib/gitlab/utils/strong_memoize.rb:30:in `strong_memoize\'","lib/gitlab/repository_cache_adapter.rb:192:in `block in memoize_method_output\'","lib/gitlab/repository_cache_adapter.rb:201:in `no_repository_fallback\'","lib/gitlab/repository_cache_adapter.rb:191:in `memoize_method_output\'","lib/gitlab/repository_cache_adapter.rb:177:in `cache_method_output_asymmetrically\'","lib/gitlab/repository_cache_adapter.rb:83:in `block in cache_method_asymmetrically\'","app/models/repository.rb:646:in `head_commit\'","app/models/repository.rb:657:in `tree\'","app/models/repository.rb:1010:in `file_on_head\'","app/models/repository.rb:561:in `block in avatar\'","lib/gitlab/gitaly_client.rb:335:in `allow_n_plus_1_calls\'","app/models/repository.rb:560:in `avatar\'","lib/gitlab/repository_cache_adapter.rb:21:in `block (2 levels) in cache_method\'","lib/gitlab/repository_cache.rb:25:in `fetch\'","lib/gitlab/repository_cache_adapter.rb:152:in `block in cache_method_output\'","lib/gitlab/utils/strong_memoize.rb:30:in `strong_memoize\'","lib/gitlab/repository_cache_adapter.rb:192:in `block in memoize_method_output\'","lib/gitlab/repository_cache_adapter.rb:201:in `no_repository_fallback\'","lib/gitlab/repository_cache_adapter.rb:191:in `memoize_method_output\'","lib/gitlab/repository_cache_adapter.rb:151:in `cache_method_output\'","lib/gitlab/repository_cache_adapter.rb:20:in `block in cache_method\'","app/models/project.rb:1308:in `avatar_in_git\'","app/models/project.rb:1312:in `avatar_url\'","app/models/concerns/avatarable.rb:24:in `avatar_url\'","app/helpers/page_layout_helper.rb:52:in `page_image\'","app/views/layouts/_head.html.haml:27","app/views/layouts/application.html.haml:6","app/controllers/application_controller.rb:132:in `render\'","app/controllers/projects_controller.rb:68:in `create\'","app/controllers/application_controller.rb:496:in `set_current_admin\'","lib/gitlab/session.rb:11:in `with_session\'","app/controllers/application_controller.rb:487:in `set_session_storage\'","app/controllers/application_controller.rb:481:in `set_locale\'","lib/gitlab/error_tracking.rb:48:in `with_context\'","app/controllers/application_controller.rb:546:in `sentry_context\'","app/controllers/application_controller.rb:474:in `block in set_current_context\'","lib/gitlab/application_context.rb:52:in `block in use\'","lib/gitlab/application_context.rb:52:in `use\'","lib/gitlab/application_context.rb:20:in `with_context\'","app/controllers/application_controller.rb:467:in `set_current_context\'"],"db_duration_s":0.07781,"view_duration_s":0.0,"duration_s":0.77791}\n')])])]),a("p",[t._v("可以看到gitaly-client的permission denied error")]),t._v(" "),a("p",[t._v("然后从Praefect测试到Gitaly nodes的连通性")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("2020/08/21 15:25:38 [tcp://172.26.101.137:8075]: checking health...\n2020/08/21 15:25:38 [tcp://172.26.101.138:8075]: dialed successfully!\n2020/08/21 15:25:38 [tcp://172.26.101.138:8075]: checking health...\n2020/08/21 15:25:38 [tcp://172.26.101.136:8075]: dialed successfully!\n2020/08/21 15:25:38 [tcp://172.26.101.136:8075]: checking health...\n2020/08/21 15:25:38 [tcp://172.26.101.138:8075]: ERROR: unable to request health check: rpc error: code = PermissionDenied desc = permission denied\n2020/08/21 15:25:38 [tcp://172.26.101.137:8075]: ERROR: unable to request health check: rpc error: code = PermissionDenied desc = permission denied\n2020/08/21 15:25:38 [tcp://172.26.101.136:8075]: ERROR: unable to request health check: rpc error: code = PermissionDenied desc = permission denied\nrpc error: code = PermissionDenied desc = permission denied\n")])])]),a("p",[t._v("查到说不是shared secret就是clock drift问题 https://gitlab.com/gitlab-org/gitaly/-/issues/1762")]),t._v(" "),a("p",[t._v("我确认了配置无误，所以应该是clock drift，")]),t._v(" "),a("p",[t._v("通过ntp配置")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("yum install ntp\nvim /etc/ntp.conf\nsystemctl start ntpd\nsystemctl enable ntpd\n")])])]),a("p",[t._v("同步之后再测试，终于可以了")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("WARN[0000] ignoring configured election strategy as failover is disabled  election_strategy=local pid=6972\n2020/08/21 17:02:07 [tcp://172.26.101.138:8075]: dialing...\n2020/08/21 17:02:07 [tcp://172.26.101.136:8075]: dialing...\n2020/08/21 17:02:07 [tcp://172.26.101.137:8075]: dialing...\n2020/08/21 17:02:07 [tcp://172.26.101.138:8075]: dialed successfully!\n2020/08/21 17:02:07 [tcp://172.26.101.138:8075]: checking health...\n2020/08/21 17:02:07 [tcp://172.26.101.136:8075]: dialed successfully!\n2020/08/21 17:02:07 [tcp://172.26.101.136:8075]: checking health...\n[root@sgkc2-cicd-proxy-v03 opt]# .101.137:8075]: dialed successfully!\n")])])]),a("p",[t._v("然后从前端访问测试，发现创建的时候报错503 not available，这又是啥，结果测试从gitlab server到Praefect的连通性，发现Praefect不通，最后发现Praefect忘记启动了！")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[root@sgkc2-cicd-v01 opt]# gitlab-rake gitlab:gitaly:check\nChecking Gitaly ...\n\nGitaly: ... default ... OK\n\nChecking Gitaly ... Finished\n")])])]),a("p",[t._v("总结：")]),t._v(" "),a("p",[t._v("一定要确保连通性！")]),t._v(" "),a("h3",{attrs:{id:"repository-migration问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#repository-migration问题"}},[t._v("#")]),t._v(" repository migration问题")]),t._v(" "),a("p",[t._v("由于安装Gitaly cluster之前已经创建了一个repository，所以需要migration，")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/administration/gitaly/praefect.html#migrating-existing-repositories-to-praefect")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('curl --request POST --header "Private-Token: <your_access_token>" --header "Content-Type: application/json" \\\n--data \'{"destination_storage_name":"praefect"}\' "https://gitlab.example.com/api/v4/projects/123/repository_storage_moves"\n')])])]),a("p",[t._v("这个token如何获取呢？")]),t._v(" "),a("p",[t._v("Admin头像->settings->Access Tokens，创建api权限获取token：测试")]),t._v(" "),a("p",[t._v("http://172.26.101.133/api/v4/projects?access_token=5L74k2hxQrKYdKNNG8Ne")]),t._v(" "),a("p",[t._v("api")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/api/README.html")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/api/api_resources.html")]),t._v(" "),a("p",[t._v("https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html")]),t._v(" "),a("h2",{attrs:{id:"appendix"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#appendix"}},[t._v("#")]),t._v(" Appendix")]),t._v(" "),a("p",[t._v("防火墙状态：")]),t._v(" "),a("p",[t._v("sudo firewall-cmd --list-all")]),t._v(" "),a("h3",{attrs:{id:"gitlab-ctl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ctl"}},[t._v("#")]),t._v(" gitlab-ctl")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[liuyue@sgkc2-cicd-v02 ~]$ gitlab-ctl help\nomnibus-ctl: command (subcommand)\ncheck-config\n  Check if there are any configuration in gitlab.rb that is removed in specified version\ndeploy-page\n  Put up the deploy page\ndiff-config\n  Compare the user configuration with package available configuration\nget-redis-master\n  Get connection details to Redis master\nprometheus-upgrade\n  Upgrade the Prometheus data to the latest supported version\nremove-accounts\n  Delete *all* users and groups used by this package\nreset-grafana\n  Reset Grafana instance to its initial state by removing the data directory\nset-grafana-password\n  Reset admin password for Grafana\nupgrade\n  Run migrations after a package upgrade\nGeneral Commands:\n  cleanse\n    Delete *all* gitlab data, and start from scratch.\n  help\n    Print this help message.\n  reconfigure\n    Reconfigure the application.\n  show-config\n    Show the configuration that would be generated by reconfigure.\n  uninstall\n    Kill all processes and uninstall the process supervisor (data will be preserved).\nService Management Commands:\n  graceful-kill\n    Attempt a graceful stop, then SIGKILL the entire process group.\n  hup\n    Send the services a HUP.\n  int\n    Send the services an INT.\n  kill\n    Send the services a KILL.\n  once\n    Start the services if they are down. Do not restart them if they stop.\n  restart\n    Stop the services if they are running, then start them again.\n  service-list\n    List all the services (enabled services appear with a *.)\n  start\n    Start services if they are down, and restart them if they stop.\n  status\n    Show the status of all the services.\n  stop\n    Stop the services, and do not restart them.\n  tail\n    Watch the service logs of all enabled services.\n  term\n    Send the services a TERM.\n  usr1\n    Send the services a USR1.\n  usr2\n    Send the services a USR2.\nBackup Commands:\n  backup-etc\n    Backup GitLab configuration [accepts directory path]\nLet's Encrypt Commands:\n  renew-le-certs\n    Renew the existing Let's Encrypt certificates\nDatabase Commands:\n  pg-password-md5\n    Generate MD5 Hash of user password in PostgreSQL format\n  pg-upgrade\n    Upgrade the PostgreSQL DB to the latest supported version\n  revert-pg-upgrade\n    Run this to revert to the previous version of the database\n  set-replication-password\n    Set database replication password\nContainer Registry Commands:\n  registry-garbage-collect\n    Run Container Registry garbage collection.\n")])])]),a("h3",{attrs:{id:"gitlab-rails"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-rails"}},[t._v("#")]),t._v(" gitlab-rails")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('[liuyue@sgkc2-cicd-v02 opt]$ sudo gitlab-rails help\n[sudo] password for liuyue:\nThe most common rails commands are:\n generate     Generate new code (short-cut alias: "g")\n console      Start the Rails console (short-cut alias: "c")\n server       Start the Rails server (short-cut alias: "s")\n test         Run tests except system tests (short-cut alias: "t")\n test:system  Run system tests\n dbconsole    Start a console for the database specified in config/database.yml\n              (short-cut alias: "db")\n\n new          Create a new Rails application. "rails new my_app" creates a\n              new application called MyApp in "./my_app"\n\n\nAll commands can be run with -h (or --help) for more information.\nIn addition to those commands, there are:\n\n--------------------------------------------------------------------------------\n GitLab:       13.0.7 (bcfbac449a7) FOSS\n GitLab Shell: 13.2.0\n PostgreSQL:   11.7\n--------------------------------------------------------------------------------\n  about\n  acts_as_taggable_on_engine:install:migrations\n  acts_as_taggable_on_engine:tag_names:collate_bin\n  acts_as_taggable_on_engine:tag_names:collate_ci\n  app:template\n  app:update\n  assets:clean[keep]\n  assets:clobber\n  assets:environment\n  assets:precompile                                              \nbrakeman                                                       \ncache:clear:redis                                              \ncache_digests:dependencies                                     \ncache_digests:nested_dependencies                              \nci:cleanup:builds                                              \nclean                                                          \nclobber                                                        \nconfig_lint                                                    \ncredentials:edit                                               \ncredentials:show                                               \ndanger_local                                                   \ndb:create                                                      \ndb:drop                                                        \ndb:environment:set                                             \ndb:fixtures:load                                               \ndb:load_config                                                 \ndb:migrate                                                     \ndb:migrate:status                                              \ndb:obsolete_ignored_columns                                    \ndb:prepare                                                     \ndb:rollback                                                    \ndb:schema:cache:clear                                          \ndb:schema:cache:dump                                           \ndb:schema:dump                                                 \ndb:schema:load                                                 \ndb:seed                                                        \ndb:seed:replant                                                \ndb:seed_fu                                                     \ndb:setup                                                       \ndb:structure:dump                                              \ndb:structure:load                                              \ndb:system:change                                               \ndb:version                                                     \ndestroy                                                        \ndev:cache                                                      \ndev:load                                                       \ndev:setup                                                      \ndowntime_check                                                 \nencrypted:edit                                                 \nencrypted:show                                                 \nfile_hooks:validate\n  gemojione:aliases\n  gemojione:install_assets\n  gettext:add_language[language]\n  gettext:find\n  gettext:lint\n  gettext:pack\n  gettext:po_to_json\n  gettext:regenerate\n  gettext:store_model_attributes\n  gitlab:app:check\n  gitlab:artifacts:check\n  gitlab:artifacts:migrate\n  gitlab:assets:clean\n  gitlab:assets:compile\n  gitlab:assets:compile_webpack_if_needed\n  gitlab:assets:fix_urls\n  gitlab:assets:purge\n  gitlab:assets:purge_modules\n  gitlab:assets:vendor\n  gitlab:backup:create\n  gitlab:backup:restore\n  gitlab:check\n  gitlab:cleanup:block_removed_ldap_users\n  gitlab:cleanup:moved\n  gitlab:cleanup:orphan_job_artifact_files\n  gitlab:cleanup:orphan_lfs_file_references\n  gitlab:cleanup:orphan_lfs_files\n  gitlab:cleanup:project_uploads\n  gitlab:cleanup:remote_upload_files\n  gitlab:cleanup:sessions:active_sessions_lookup_keys\n  gitlab:db:clean_structure_sql\n  gitlab:db:composite_primary_keys_add\n  gitlab:db:composite_primary_keys_drop\n  gitlab:db:configure\n  gitlab:db:downtime_check[ref]\n  gitlab:db:drop_tables\n  gitlab:db:mark_migration_complete[version]\n  gitlab:db:setup_ee\n   gitlab:env:info\n  gitlab:exclusive_lease:clear[scope]\n  gitlab:features:enable_rugged\n  gitlab:generate_sample_prometheus_data[environment_id]\n  gitlab:git:fsck\n  gitlab:gitaly:check\n  gitlab:gitaly:install[dir,storage_path,repo]\n  gitlab:gitlab_shell:check\n  gitlab:import:all_users_to_all_groups\n  gitlab:import:all_users_to_all_projects\n  gitlab:import:repos[import_path]\n  gitlab:import:user_to_groups[email]\n  gitlab:import:user_to_projects[email]\n  gitlab:import_export:bump_version\n  gitlab:import_export:data\n  gitlab:import_export:export[username,namespace_path,project_path,archive_path]\n  gitlab:import_export:import[username,namespace_path,project_path,archive_path]\n  gitlab:import_export:version\n  gitlab:incoming_email:check\n  gitlab:ldap:rename_provider[old_provider,new_provider]\n  gitlab:lfs:check\n  gitlab:lfs:migrate\n  gitlab:orphans:check\n  gitlab:orphans:check_namespaces\n  gitlab:orphans:check_repositories\n  gitlab:praefect:replicas[project_id]\n  gitlab:seed:group_seed[subgroups_depth,username]\n  gitlab:seed:issues[project_full_path,backfill_weeks,average_issues_per_week]\n  gitlab:setup\n  gitlab:shell:build_missing_projects\n  gitlab:shell:install[repo]\n  gitlab:shell:setup\n  gitlab:sidekiq:check\n  gitlab:snippets:list_non_migrated\n  gitlab:snippets:migrate[ids]\n  gitlab:snippets:migration_status\n  gitlab:storage:hashed_attachments\n  gitlab:storage:hashed_projects\n  gitlab:storage:legacy_attachments\n  gitlab:storage:legacy_projects\n  gitlab:storage:list_hashed_attachments\n  gitlab:storage:list_hashed_projects\n   gitlab:storage:list_legacy_attachments\n  gitlab:storage:list_legacy_projects\n  gitlab:storage:migrate_to_hashed\n  gitlab:storage:rollback_to_legacy\n  gitlab:tcp_check[host,port]\n  gitlab:test\n  gitlab:two_factor:disable_for_all_users\n  gitlab:two_factor:rotate_key:apply\n  gitlab:two_factor:rotate_key:rollback\n  gitlab:update_project_templates\n  gitlab:update_templates\n  gitlab:uploads:check\n  gitlab:uploads:migrate:all\n  gitlab:uploads:migrate[uploader_class,model_class,mounted_as]\n  gitlab:uploads:migrate_to_local:all\n  gitlab:uploads:migrate_to_local[uploader_class,model_class,mounted_as]\n  gitlab:uploads:sanitize:remove_exif[start_id,stop_id,dry_run,sleep_time,uploader,since]\n  gitlab:web_hook:add\n  gitlab:web_hook:list\n  gitlab:web_hook:rm\n  gitlab:workhorse:install[dir,repo]\n  gitlab:x509:update_signatures\n  grape:path_helpers\n  grape:routes\n  hipchat:send[message]\n  import:github[token,gitlab_username,project_path]\n  initializers\n  jira:generate_consumer_key\n  jira:generate_public_cert\n  log:clear\n  metrics:setup_common_metrics\n  middleware\n  migrate_iids\n  notes\n  postgresql_md5_hash\n  restart\n  routes\n  runner\n  secret\n  secrets:edit\n  secrets:setup\n  secrets:show\n  setup\n  stats\n  test:db\n  time:zones[country_or_offset]\n  tmp:clear\n  tmp:create\n  tokens:reset_all_email\n  tokens:reset_all_feed\n  version\n  webpack:compile\n  yarn\n  yarn:available\n  yarn:check\n  yarn:clobber\n  yarn:install\n  zeitwerk:check\n')])])])])}),[],!1,null,null,null);e.default=r.exports}}]);