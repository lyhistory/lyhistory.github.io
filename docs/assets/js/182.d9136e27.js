(window.webpackJsonp=window.webpackJsonp||[]).push([[182],{607:function(e,t,o){"use strict";o.r(t);var s=o(65),r=Object(s.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/index.html")]),e._v(" "),o("p",[e._v("Pgpool-II")]),e._v(" "),o("h2",{attrs:{id:"_1-knowledge-base"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-knowledge-base"}},[e._v("#")]),e._v(" 1.Knowledge base")]),e._v(" "),o("h3",{attrs:{id:"_1-1-what-is"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-what-is"}},[e._v("#")]),e._v(" 1.1 What is")]),e._v(" "),o("p",[e._v('Pgpool-II is a proxy server sitting between clients and PostgreSQL. Pgpool-II understands the wire level protocol used by PostgreSQL called "frontend and backend protocol". For more details of the protocol, see the PostgreSQL manual. No modified PostgreSQL is required to use Pgpool-II (more precisely, you will need a few extensions to use full functions of Pgpool-II). So Pgpool-II can cope with variety of PostgreSQL versions. In theory, even the earliest version of PostgreSQL can be used with Pgpool-II. Same thing can be said to client side. As long as it follows the protocol, Pgpool-II happily accept connections from it, no matter what kind of languages or drivers it uses.')]),e._v(" "),o("p",[e._v("Pgpool-II consists of multiple process. There is a "),o("strong",[e._v("main process")]),e._v(", which is the parent process of all other process. It is responsible for forking child process each of which accepts connections from clients. There are some "),o("strong",[e._v("worker process")]),e._v(" those are forked from the main process as well, which is responsible for detecting streaming replication delay. There is also a special process called "),o("strong",[e._v('"pcp process"')]),e._v(", which is solely used for management of Pgpool-II itself. Pgpool-II has a built-in high availability function called "),o("strong",[e._v('"watchdog"')]),e._v(". Watchdog consists of some process.")]),e._v(" "),o("p",[o("img",{attrs:{src:"/docs/docs_image/software/postgresql/pgpool-ii_architect.gif",alt:""}})]),e._v(" "),o("p",[e._v("It provides the following features:")]),e._v(" "),o("ul",[o("li",[o("p",[e._v("Connection Pooling\nPgpool-II maintains established connections to the PostgreSQL servers, and reuses them whenever a new connection with the same properties (i.e. user name, database, protocol version, and other connection parameters if any) comes in. It reduces the connection overhead, and improves system's overall throughput.")])]),e._v(" "),o("li",[o("p",[e._v("Load Balancing\nIf a database is replicated (because running in either replication mode or master/slave mode), performing a SELECT query on any server will return the same result. Pgpool-II takes advantage of the replication feature in order to reduce the load on each PostgreSQL server. It does that by distributing SELECT queries among available servers, improving the system's overall throughput. In an ideal scenario, read performance could improve proportionally to the number of PostgreSQL servers. Load balancing works best in a scenario where there are a lot of users executing many read-only queries at the same time.")])]),e._v(" "),o("li",[o("p",[e._v("Automated fail over\nIf one of the database servers goes down or becomes unreachable, Pgpool-II will detach it and will continue operations by using the rest of database servers. There are some sophisticated features that help the automated failover including timeouts and retries.")])]),e._v(" "),o("li",[o("p",[e._v("Online Recovery\nPgpool-II can perform online recovery of database node by executing one command. When the online recovery is used with the automated fail over, a detached node by fail over is possible to attach as standby node automatically. It is possible to synchronize and attach new PostgreSQL server too.")])]),e._v(" "),o("li",[o("p",[e._v("Replication\nPgpool-II can manage multiple PostgreSQL servers. Activating the replication feature makes it possible to create a real time backup on 2 or more PostgreSQL clusters, so that the service can continue without interruption if one of those clusters fails. Pgpool-II has built-in replication (native replication). However user can use external replication features including streaming replication of PostgreSQL.")])]),e._v(" "),o("li",[o("p",[e._v("Limiting Exceeding Connections\nThere is a limit on the maximum number of concurrent connections with PostgreSQL, and new connections are rejected when this number is reached. Raising this maximum number of connections, however, increases resource consumption and has a negative impact on overall system performance. Pgpool-II also has a limit on the maximum number of connections, but extra connections will be queued instead of returning an error immediately. However, you can configure to return an error when the connection limit is exceeded (4.1 or later).")])]),e._v(" "),o("li",[o("p",[e._v("Watchdog\nWatchdog can coordinate multiple Pgpool-II, create a robust cluster system and avoid the single point of failure or split brain. Watchdog can perform lifecheck against other pgpool-II nodes, to detect a fault of Pgpoll-II. If active Pgpool-II goes down, standby Pgpool-II can be promoted to active, and take over Virtual IP.")])]),e._v(" "),o("li",[o("p",[e._v("In Memory Query Cache\nIn memory query cache allows to save a pair of SELECT statement and its result. If an identical SELECTs comes in, Pgpool-II returns the value from cache. Since no SQL parsing nor access to PostgreSQL are involved, using in memory cache is extremely fast. On the other hand, it might be slower than the normal path in some cases, because it adds some overhead of storing cache data.")])])]),e._v(" "),o("h3",{attrs:{id:"_1-2-restrictions"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-restrictions"}},[e._v("#")]),e._v(" 1.2 Restrictions")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/restrictions.html")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/admin.html")]),e._v(" "),o("h3",{attrs:{id:"_1-3-installation-of-pgpool-ii"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-installation-of-pgpool-ii"}},[e._v("#")]),e._v(" 1.3 Installation of Pgpool-II")]),e._v(" "),o("p",[o("strong",[e._v("install from source or rpm")])]),e._v(" "),o("p",[e._v("build from source: https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/install-requirements.html")]),e._v(" "),o("p",[e._v("install from rpm:")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("yum install http://www.pgpool.net/yum/rpms/4.0/redhat/rhel-7-x86_64/pgpool-II-release-4.0-1.noarch.rpm\nyum install pgpool-II-pg11\n\nrpm direct download: https://yum.postgresql.org/rpmchart/\n\npg11 means PostgreSQL 11. Pgpool-II needs PostgreSQL's library and extensions directory. Since the directory paths are different in the particular PostgreSQL versions, You must choose appropriate RPM for your PostgreSQL rpm installation. We also assume you are using PostgreSQL community rpms. Optionally you can install:\nyum install pgpool-II-pg11-debuginfo\nwhich makes it easier to retrieve debugging symbols from the core or the backtrace. We recommend to install it. There is an optional package for developers.\nyum install pgpool-II-pg11-devel\nThis installs header files which developers are interested in\n\nOn all the PostgreSQL servers you need to install:\nyum install pgpool-II-pg11-extensions\n\nsystemctl enable pgpool.service\nsystemctl start pgpool.service \nsystemctl stop pgpool.service \n")])])]),o("p",[o("strong",[e._v("firewall")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("#allow to access port that Pgpool-II use.\nfirewall-cmd --permanent --zone=public --add-port=9999/tcp --add-port=9898/tcp --add-port=9000/tcp  --add-port=9694/tcp\nfirewall-cmd --permanent --zone=public --add-port=9999/udp --add-port=9898/udp --add-port=9000/udp  --add-port=9694/udp\nfirewall-cmd --reload\n\n#access to PostgreSQL\nfirewall-cmd --permanent --zone=public --add-service=postgresql\nfirewall-cmd --reload\n")])])]),o("p",[o("strong",[e._v("(optional) online recovery")]),e._v("\nhttps://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/install-pgpool-recovery.html")]),e._v(" "),o("p",[o("strong",[e._v("(optional) native replication mode")]),e._v("\nhttps://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/create-installlock-table.html")]),e._v(" "),o("p",[o("strong",[e._v("(optional) Compiling and installing documents")]),e._v("\nhttps://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/install-docs.html")]),e._v(" "),o("h3",{attrs:{id:"_1-4-configuration-server-setup-and-operation"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-configuration-server-setup-and-operation"}},[e._v("#")]),e._v(" 1.4 Configuration(Server Setup and Operation)")]),e._v(" "),o("ul",[o("li",[e._v("if installed from rpm: all the Pgpool-II configuration files live in "),o("strong",[e._v("/etc/pgpool-II")])]),e._v(" "),o("li",[e._v("if installed from source code: "),o("strong",[e._v("$prefix/etc/pgpool.conf by default")]),e._v(" (/usr/local/etc )")])]),e._v(" "),o("p",[o("strong",[e._v("create The Pgpool-II User Account")]),e._v("\nAs with any server daemon that is accessible to the outside world, it is advisable to run Pgpool-II under a separate user account. This user account should only own the data that is managed by the server, and should not be shared with other daemons. (For example, using the user nobody is a bad idea.) It is not advisable to install executables owned by this user because compromised systems could then modify their own binaries.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("useradd -m -d /home/pgpool pgpool\n\n")])])]),o("p",[o("strong",[e._v("Configuring pcp.conf")])]),e._v(" "),o("p",[e._v("Pgpool-II provides a interface for administrators to perform management operation, such as getting Pgpool-II status or terminating Pgpool-II processes remotely. pcp.conf is the user/password file used for authentication by this interface.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v(" $ pg_md5 your_password\n $ cp /etc/pgpool-II/pcp.conf.sample /etc/pgpool-II/pcp.conf\n username:[md5 encrypted password]\n\n")])])]),o("p",[o("strong",[e._v("Configuring Pgpool-II")])]),e._v(" "),o("p",[e._v("pgpool.conf is the main configuration file of Pgpool-II. You need to specify the path to the file when starting Pgpool-II using -f option.")]),e._v(" "),o("p",[e._v("There are four different running modes in Pgpool-II: streaming replication mode, logical replication mode, master slave mode (slony mode), native replication mode and raw mode. In any mode, Pgpool-II provides connection pooling, automatic fail over and online recovery.")]),e._v(" "),o("p",[e._v("pgpool.conf samples:")]),e._v(" "),o("table",[o("thead",[o("tr",[o("th",[e._v("Operation mode")]),e._v(" "),o("th",[e._v("Configuration file name")])])]),e._v(" "),o("tbody",[o("tr",[o("td",[e._v("Streaming replication mode")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("Replication mode")]),e._v(" "),o("td",[e._v("pgpool.conf.sample-replication")])]),e._v(" "),o("tr",[o("td",[e._v("Master slave mode")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("Raw mode")]),e._v(" "),o("td",[e._v("pgpool.conf.sample")])]),e._v(" "),o("tr",[o("td",[e._v("Logical replication mode")]),e._v(" "),o("td",[e._v("pgpool.conf.sample-logical")])])])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("cp /etc/pgpool-II/pgpool.conf.sample-stream /etc/pgpool-II/pgpool.conf\n")])])]),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.1/en/html/configuring-pgpool.html")]),e._v(" "),o("p",[o("strong",[e._v("Configuring backend information")]),e._v("\nFor Pgpool-II to recognize PostgreSQL backend servers, you need to configure backend* in pgpool.conf. For starters, at least backend_hostname and backend_port parameters are required to be set up to start Pgpool-II server.")]),e._v(" "),o("p",[e._v("/etc/pgpool-II/pgpool.conf")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.1/en/html/runtime-config-backend-settings.html")]),e._v(" "),o("h3",{attrs:{id:"_1-5-watchdog"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-5-watchdog"}},[e._v("#")]),e._v(" 1.5 Watchdog")]),e._v(" "),o("p",[e._v("Watchdog is a sub process of Pgpool-II to add high availability. Watchdog is used to resolve the single point of failure by coordinating multiple pgpool-II nodes.\nTo ensure the quorum mechanism properly works, the number of pgpool-II nodes must be odd in number and greater than or equal to 3.")]),e._v(" "),o("h4",{attrs:{id:"architecure-of-the-watchdog"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#architecure-of-the-watchdog"}},[e._v("#")]),e._v(" Architecure of the watchdog")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.1/en/html/tutorial-advanced-arch.html")]),e._v(" "),o("ul",[o("li",[e._v("Coordinating multiple Pgpool-II nodes\nAt the startup, if the watchdog is enabled, Pgpool-II node sync the status of all configured backend nodes from the master watchdog node. And if the node goes on to become a master node itself it initializes the backend status locally. When a backend node status changes by failover etc.., watchdog notifies the information to other Pgpool-II nodes and synchronizes them. When online recovery occurs, watchdog restricts client connections to other Pgpool-II nodes for avoiding inconsistency between backends.")])]),e._v(" "),o("p",[e._v("Watchdog also coordinates with all connected Pgpool-II nodes to ensure that failback, failover and follow_master commands must be executed only on one pgpool-II node.")]),e._v(" "),o("ul",[o("li",[o("p",[e._v('Life checking of other Pgpool-II nodes\nWatchdog lifecheck is the sub-component of watchdog to monitor the health of Pgpool-II nodes participating in the watchdog cluster to provide the high availability. Traditionally Pgpool-II watchdog provides two methods of remote node health checking. "heartbeat" and "query" mode.\nApart from remote node health checking watchdog lifecheck can also check the health of node it is installed on by monitoring the connection to upstream servers. If the monitoring fails, watchdog treats it as the local Pgpool-II node failure.')]),e._v(" "),o("ul",[o("li",[o("p",[e._v("In heartbeat mode, watchdog monitors other Pgpool-II processes by using heartbeat signal. Watchdog receives heartbeat signals sent by other Pgpool-II periodically. If there is no signal for a certain period, watchdog regards this as the failure of the Pgpool-II. For redundancy you can use multiple network connections for heartbeat exchange between Pgpool-II nodes. This is the default and recommended mode to be used for health checking.")])]),e._v(" "),o("li",[o("p",[e._v("In query mode, watchdog monitors Pgpool-II service rather than process. In this mode watchdog sends queries to other Pgpool-II and checks the response.")])]),e._v(" "),o("li",[o("p",[e._v("external mode is introduced by Pgpool-II V3.5. This mode basically disables the built in lifecheck of Pgpool-II watchdog and expects that the external system will inform the watchdog about health of local and all remote nodes participating in the watchdog cluster.")])])])]),e._v(" "),o("li",[o("p",[e._v("Consistency of configuration parameters on all Pgpool-II nodes\nAt startup watchdog verifies the Pgpool-II configuration of the local node for the consistency with the configurations on the master watchdog node and warns the user of any differences.")])]),e._v(" "),o("li",[o("p",[e._v("Changing active/standby state when certain fault is detected\nWhen a fault of Pgpool-II is detected, watchdog notifies the other watchdogs of it. If this is the active Pgpool-II, watchdogs decide the new active Pgpool-II by voting and change active/standby state.")])]),e._v(" "),o("li",[o("p",[e._v("Automatic virtual IP switching\nWhen a standby Pgpool-II server promotes to active, the new active server brings up virtual IP interface. Meanwhile, the previous active server brings down the virtual IP interface.")])]),e._v(" "),o("li",[o("p",[e._v("Automatic registration of a server as a standby in recovery\nWhen the broken server recovers or new server is attached, the watchdog process notifies this to the other watchdogs in the cluster along with the information of the new server, and the watchdog process receives information on the active server and other servers. Then, the attached server is registered as a standby.")])])]),e._v(" "),o("h4",{attrs:{id:"restrictions"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#restrictions"}},[e._v("#")]),e._v(" Restrictions")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.1/en/html/tutorial-watchdog-restrictions.html")]),e._v(" "),o("h4",{attrs:{id:"starting-stopping-watchdog"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#starting-stopping-watchdog"}},[e._v("#")]),e._v(" Starting/stopping watchdog")]),e._v(" "),o("p",[e._v("The watchdog process starts and stops automatically as sub-processes of the Pgpool-II, therefore there is no dedicated command to start and stop watchdog.")]),e._v(" "),o("p",[e._v('Watchdog controls the virtual IP interface, the commands executed by the watchdog for bringing up and bringing down the VIP require the root privileges. Pgpool-II requires the user running Pgpool-II to have root privileges when the watchdog is enabled along with virtual IP. This is however not good security practice to run the Pgpool-II as root user, the alternative and preferred way is to run the Pgpool-II as normal user and use either the custom commands for if_up_cmd, if_down_cmd, and arping_cmd using sudo or use setuid ("set user ID upon execution") on if_* commands')]),e._v(" "),o("p",[e._v("Lifecheck process is a sub-component of watchdog, its job is to monitor the health of Pgpool-II nodes participating in the watchdog cluster. The Lifecheck process is started automatically when the watchdog is configured to use the built-in life-checking, it starts after the watchdog main process initialization is complete. However lifecheck process only kicks in when all configured watchdog nodes join the cluster and becomes active. If some remote node fails before the Lifecheck become active that failure will not get caught by the lifecheck.")]),e._v(" "),o("h4",{attrs:{id:"integrating-external-lifecheck-with-watchdog"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#integrating-external-lifecheck-with-watchdog"}},[e._v("#")]),e._v(" Integrating external lifecheck with watchdog")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.1/en/html/tutorial-watchdog-integrating-external-lifecheck.html")]),e._v(" "),o("h3",{attrs:{id:"_1-6-server-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-server-configuration"}},[e._v("#")]),e._v(" 1.6 Server Configuration")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.1/en/html/runtime-config.html")]),e._v(" "),o("p",[o("strong",[e._v("Setting Parameters")])]),e._v(" "),o("p",[e._v("Connections and Authentication")]),e._v(" "),o("p",[e._v("Running mode")]),e._v(" "),o("p",[e._v("Backend Settings")]),e._v(" "),o("p",[e._v("Connection Pooling")]),e._v(" "),o("p",[e._v("Error Reporting and Logging")]),e._v(" "),o("p",[e._v("Load Balancing")]),e._v(" "),o("p",[e._v("Health Check")]),e._v(" "),o("p",[e._v("Failover and Failback")]),e._v(" "),o("p",[e._v("Online Recovery")]),e._v(" "),o("p",[e._v("Streaming Replication Check")]),e._v(" "),o("p",[e._v("In Memory Query Cache")]),e._v(" "),o("p",[e._v("Secure Sockect Layer (SSL)")]),e._v(" "),o("p",[e._v("Watchdog")]),e._v(" "),o("p",[e._v("Misc Configuration Parameters")]),e._v(" "),o("h3",{attrs:{id:"_1-6-client-authentication"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-6-client-authentication"}},[e._v("#")]),e._v(" 1.6 Client Authentication")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/client-authentication.html")]),e._v(" "),o("p",[e._v("The pool_hba.conf File")]),e._v(" "),o("p",[e._v("Authentication Methods")]),e._v(" "),o("p",[e._v("Using different methods for frontend and backend authentication")]),e._v(" "),o("p",[e._v("Using AES256 encrypted passwords in pool_passwd")]),e._v(" "),o("h3",{attrs:{id:"_1-7-performance-considerations"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_1-7-performance-considerations"}},[e._v("#")]),e._v(" 1.7 Performance Considerations")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/performance.html")]),e._v(" "),o("h2",{attrs:{id:"_2-pgpool-ii-watchdog-setup-example"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-pgpool-ii-watchdog-setup-example"}},[e._v("#")]),e._v(" 2. Pgpool-II + Watchdog Setup Example")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/example-configs.html")]),e._v(" "),o("h3",{attrs:{id:"_2-1-simple-two-nodes-replication"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-simple-two-nodes-replication"}},[e._v("#")]),e._v(" 2.1 Simple two Nodes Replication")]),e._v(" "),o("h4",{attrs:{id:"_2-1-1-installing-pgpool-ii"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-1-installing-pgpool-ii"}},[e._v("#")]),e._v(" 2.1.1 Installing Pgpool-II")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("$ ./configure\n$ make\n$ make install\n")])])]),o("p",[e._v("configure script collects your system information and use it for the compilation procedure. You can pass command line arguments to configure script to change the default behavior, such as the installation directory. Pgpool-II will be installed to "),o("strong",[e._v("/usr/local(if installed from rpm default path: /etc/pgpool-II/)")]),e._v(" directory by default.")]),e._v(" "),o("p",[e._v("make command compiles the source code, and make install will install the executables. You must have write permission on the installation directory.")]),e._v(" "),o("h4",{attrs:{id:"_2-1-2-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-2-configuration"}},[e._v("#")]),e._v(" 2.1.2 Configuration")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//Configuration Files\n$ cp /usr/local/etc/pgpool.conf.sample /usr/local/etc/pgpool.conf\n    listen_addresses = '*'\n    port = 9999\n\n//Configuring PCP Commands\n$ /usr/local/bin/pg_md5 postgres\n    e8a48653851e28c69d0506508fb27fc5\n$ cp /usr/local/etc/pcp.conf.sample /usr/local/etc/pcp.conf\n    postgres:e8a48653851e28c69d0506508fb27fc5\n    \n\n//Preparing Database Nodes\n$ vim /etc/pgpool-II/pgpool.conf\n    pcp_port = 9898\n    backend_hostname0 = 'localhost'\n    backend_port0 = 5432\n    backend_weight0 = 1\n    backend_hostname1 = 'localhost'\n    backend_port1 = 5433\n    backend_weight1 = 1\n    backend_hostname2 = 'localhost'\n    backend_port2 = 5434\n    backend_weight2 = 1\n\n")])])]),o("h4",{attrs:{id:"_2-1-3-starting-stopping-pgpool-ii"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-3-starting-stopping-pgpool-ii"}},[e._v("#")]),e._v(" 2.1.3 Starting/Stopping Pgpool-II")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("$ pgpool\nThe above command, however, prints no log messages because Pgpool-II detaches the terminal. If you want to show Pgpool-II log messages, you pass -n option to pgpool command so Pgpool-II is executed as non-daemon process, and the terminal will not be detached.\n$ pgpool -n &\nThe log messages are printed on the terminal, so it is recommended to use the following options.\n$ pgpool -n -d > /tmp/pgpool.log 2>&1 &\nto rotate log files:\n$ pgpool -n 2>&1 | /usr/local/apache2/bin/rotatelogs \\\n     -l -f /var/log/pgpool/pgpool.log.%A 86400 &\nTo delete old log files before rotation, you could use cron:\n55 23 * * * /usr/bin/find /var/log/pgpool -type f -mtime +5 -exec /bin/rm -f '{}' \\;\nPlease note that rotatelogs may exist as /usr/sbin/rotatelogs2 in some distributions. -f option generates a log file as soon as rotatelogs starts and is available in apache2 2.2.9 or greater. Also cronolog can be used.\n$ pgpool -n 2>&1 | /usr/sbin/cronolog \\\n     --hardlink=/var/log/pgsql/pgpool.log \\\n     '/var/log/pgsql/%Y-%m-%d-pgpool.log' &\n\n\n$ pgpool stop\nIf any client is still connected, Pgpool-II waits for it to disconnect, and then terminates itself. Run the following command instead if you want to shutdown Pgpool-II forcibly.\n$ pgpool -m fast stop\n\n")])])]),o("h4",{attrs:{id:"_2-1-4-configuring-replication"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-4-configuring-replication"}},[e._v("#")]),e._v(" 2.1.4 Configuring Replication")]),e._v(" "),o("p",[e._v("we'll use three database nodes,")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('$ vim /usr/local/etc/pgpool.conf\n//When replication_mode is on, Pgpool-II will send a copy of a received query to all the database nodes.\nreplication_mode = true\n//when load_balance_mode is set to true, Pgpool-II will distribute SELECT queries among the database nodes.\nload_balance_mode = true\n\n//restart pgpool\n\n//create a database to be replicated,\n//Use the createdb commands through Pgpool-II, and the database will be created on all the nodes.\n$ createdb -p 9999 bench_replication\n//initializes the database with pre-defined tables and data\n$ pgbench -i -p 9999 bench_replication\n\n//If, on all the nodes, the tables and data are created, replication is working correctly.\n$ for port in 5432 5433 5434; do\n     >     echo $port\n     >     for table_name in pgbench_branches pgbench_tellers pgbench_accounts pgbench_history; do\n     >         echo $table_name\n     >         psql -c "SELECT count(*) FROM $table_name" -p $port bench_replication\n     >     done\n     > done\n')])])]),o("h4",{attrs:{id:"_2-1-5-watchdog-configuration-example"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-5-watchdog-configuration-example"}},[e._v("#")]),e._v(" 2.1.5 Watchdog Configuration Example")]),e._v(" "),o("p",[e._v('What you need is 2 Linux boxes on which Pgpool-II is installed and a PostgreSQL on the same machine or in the other one. It is enough that 1 node for backend exists. You can use watchdog with Pgpool-II in any mode: replication mode, master/slave mode and raw mode.\nThis example uses use "osspc16" as an Active node and "osspc20" as a Standby node. "Someserver" means one of them.')]),e._v(" "),o("p",[o("strong",[e._v("Common Config for all Pgpool-II")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("$ vim /usr/local/etc/pgpool.conf\n\n//Enabling watchdog\nuse_watchdog = on\n\n//Configure Up stream servers\ntrusted_servers = ''\n# trusted server list which are used\n# to confirm network connection\n# (hostA,hostB,hostC,...)\n      \n//Watchdog Communication\nwd_port = 9000\n\n//Specify the IP address to be used as a virtual IP address in the delegate_IP\ndelegate_IP = '133.137.177.143'\n")])])]),o("p",[o("strong",[e._v("Individual Configurations for each Pgpool-II")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//FOR Active (osspc16) Server configurations\nother_pgpool_hostname0 = 'osspc20'\n# Host name or IP address to connect to for other pgpool 0\nother_pgpool_port0 = 9999\n# Port number for other pgpool 0\nother_wd_port0 = 9000\n# Port number for other watchdog 0\n\n//FOR Standby (osspc20) Server configurations\nother_pgpool_hostname0 = 'osspc16'\n# Host name or IP address to connect to for other pgpool 0\nother_pgpool_port0 = 9999\n# Port number for other pgpool 0\nother_wd_port0 = 9000\n# Port number for other watchdog 0\n\n")])])]),o("p",[o("strong",[e._v("First start the Pgpool-II on Active server.")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("[user@osspc16]$ su -\n[root@osspc16]# {installed_dir}/bin/pgpool -n -f {installed_dir}/etc/pgpool.conf > pgpool.log 2>&1\n\nLog messages will show that Pgpool-II has the virtual IP address and starts watchdog process:\n    LOG:  I am announcing my self as master/coordinator watchdog node\n     LOG:  I am the cluster leader node\n     DETAIL:  our declare coordinator message is accepted by all nodes\n     LOG:  I am the cluster leader node. Starting escalation process\n     LOG:  escalation process started with PID:59449\n     LOG:  watchdog process is initialized\n      LOG:  watchdog: escalation started\n      LOG:  I am the master watchdog node\n     DETAIL:  using the local backend node status\n\n")])])]),o("p",[o("strong",[e._v("Starting pgpool in Standby server (osspc20)")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('[user@osspc20]$ su -\n[root@osspc20]# {installed_dir}/bin/pgpool -n -f {installed_dir}/etc/pgpool.conf > pgpool.log 2>&1\n\nLog messages will show that Pgpool-II has joind the watchdog cluster as standby watchdog.\n    LOG:  watchdog cluster configured with 1 remote nodes\n     LOG:  watchdog remote node:0 on Linux_osspc16_9000:9000\n     LOG:  interface monitoring is disabled in watchdog\n     LOG:  IPC socket path: "/tmp/.s.PGPOOLWD_CMD.9000"\n     LOG:  watchdog node state changed from [DEAD] to [LOADING]\n     LOG:  new outbound connection to Linux_osspc16_9000:9000\n     LOG:  watchdog node state changed from [LOADING] to [INITIALIZING]\n     LOG:  watchdog node state changed from [INITIALIZING] to [STANDBY]\n           LOG:  successfully joined the watchdog cluster as standby node\n      DETAIL:  our join coordinator request is accepted by cluster leader node "Linux_osspc16_9000"\n      LOG:  watchdog process is initialized\n')])])]),o("p",[o("strong",[e._v("Try it out")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('//Confirm to ping to the virtual IP address.\n[user@someserver]$ ping 133.137.177.142\n\n//Confirm if the Active server which started at first has the virtual IP address.\n[root@osspc16]# ifconfig\n\n//Confirm if the Standby server which started not at first doesn\'t have the virtual IP address.\n[root@osspc20]# ifconfig\n\n//Try to connect PostgreSQL by "psql -h delegate_IP -p port".\n[user@someserver]$ psql -h 133.137.177.142 -p 9999 -l\n\n')])])]),o("p",[o("strong",[e._v("Switching virtual IP")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//Confirm how the Standby server works when the Active server can't provide its service. Stop Pgpool-II on the Active server.\n[root@osspc16]# {installed_dir}/bin/pgpool stop\nThen, the Standby server starts to use the virtual IP address\n\n")])])]),o("p",[o("strong",[e._v("More: Lifecheck")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("There are the parameters about watchdog's monitoring. Specify the interval to check wd_interval and the type of lifecheck wd_lifecheck_method. The hearbeat method specify the time to detect a fault wd_heartbeat_deadtime, the port number to receive wd_heartbeat_port, the interval to send wd_heartbeat_keepalive, the IP address or hostname of destination heartbeat_destination<emphasis>0</emphasis> and finally the destination port number heartbeat_destination_port<emphasis>0</emphasis>.\n\nwd_lifecheck_method = 'heartbeat'\n# Method of watchdog lifecheck ('heartbeat' or 'query' or 'external')\n# (change requires restart)\nwd_interval = 10\n# lifecheck interval (sec) > 0\nwd_heartbeat_port = 9694\n# Port number for receiving heartbeat signal\n# (change requires restart)\nwd_heartbeat_keepalive = 2\n# Interval time of sending heartbeat signal (sec)\n# (change requires restart)\nwd_heartbeat_deadtime = 30\n# Deadtime interval for heartbeat signal (sec)\n# (change requires restart)\nheartbeat_destination0 = 'host0_ip1'\n# Host name or IP address of destination 0\n# for sending heartbeat signal.\n# (change requires restart)\nheartbeat_destination_port0 = 9694\n# Port number of destination 0 for sending\n# heartbeat signal. Usually this is the\n# same as wd_heartbeat_port.\n# (change requires restart)\n\n")])])]),o("p",[o("strong",[e._v("More: Switching virtual IP address")])]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("There are the parameters for switching the virtual IP address. Specify switching commands if_up_cmd, if_down_cmd, the path to them if_cmd_path, the command executed after switching to send ARP request arping_cmd and the path to it arping_path.\n\nif_cmd_path = '/sbin'\n# path to the directory where if_up/down_cmd exists\nif_up_cmd = 'ip addr add $_IP_$/24 dev eth0 label eth0:0'\n# startup delegate IP command\nif_down_cmd = 'ip addr del $_IP_$/24 dev eth0'\n# shutdown delegate IP command\n\narping_path = '/usr/sbin'           # arping command path\n\narping_cmd = 'arping -U $_IP_$ -w 1'\n")])])]),o("h3",{attrs:{id:"_2-2-pgpool-ii-watchdog-setup-streaming-replication-mode"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-pgpool-ii-watchdog-setup-streaming-replication-mode"}},[e._v("#")]),e._v(" 2.2 Pgpool-II+ Watchdog Setup (Streaming replication mode)")]),e._v(" "),o("p",[e._v("In this example, we use 3 Pgpool-II servers to manage PostgreSQL servers to create a robust cluster system and avoid the single point of failure or split brain.")]),e._v(" "),o("p",[o("img",{attrs:{src:"/docs/docs_image/software/postgresql/pgpool-ii+watchdog_cluster_example.gif",alt:""}})]),e._v(" "),o("p",[o("strong",[e._v("REQUIREMENT:")]),e._v("\nWe assume that all the Pgpool-II servers and the PostgreSQL servers are in the same subnet.\nWe use 3 servers with CentOS 7.4. Let these servers be server1, server2, server3. We install PostgreSQL and Pgpool-II on each server.")]),e._v(" "),o("h4",{attrs:{id:"_2-2-1-stepup-postgresql-server-data-nodes"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-stepup-postgresql-server-data-nodes"}},[e._v("#")]),e._v(" 2.2.1 Stepup postgresql server (data nodes)")]),e._v(" "),o("h5",{attrs:{id:"_2-2-1-1-install-postgresql-by-using-postgresql-yum-repository"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-1-install-postgresql-by-using-postgresql-yum-repository"}},[e._v("#")]),e._v(" 2.2.1.1 Install PostgreSQL by using PostgreSQL YUM repository.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("# yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-centos11-11-2.noarch.rpm\n# yum install postgresql11 postgresql11-libs postgresql11-devel postgresql11-server\n\nmkdir -p /lyhistory/workspace/postgres\nchown -R postgres:postgres /lyhistory/workspace/postgres\nchmod 750 /lyhistory/workspace/postgres\n\nvi /lib/systemd/system/postgresql-12.service\n\tEnvironment=PGDATA=/lyhistory/workspace/postgres/data\n(default: /var/lib/pgsql/12/data/)\n\ncd /lyhistory/workspace/postgres\n/usr/pgsql-12/bin/postgresql-12-setup initdb\n\nsystemctl enable postgresql-12\n\nvi /lyhistory/workspace/postgres/data/pg_hba.conf \n# TYPE  DATABASE        USER            ADDRESS                 METHOD\n\n# \"local\" is for Unix domain socket connections only\nlocal   all             all                                     peer\n# IPv4 local connections:\nhost    all             all             127.0.0.1/32            ident\n# IPv6 local connections:\nhost    all             all             ::1/128                 ident\n# Allow replication connections from localhost, by a user with the\n# replication privilege.\nlocal   replication     all                                     peer\nhost    replication     all             127.0.0.1/32            ident\nhost    replication     all             ::1/128                 ident\nhost    all             all             172.16.0.0/16           md5\nhost    all             all             10.36.100.0/24          md5\nhost    all             all             192.168.0.0/16          md5\n\nvi data/postgresql.conf \n\tlisten_addresses = '*' \n\t\nsystemctl start postgresql-12\nvi data/log/postgresql-Fri.log \n\nsu - postgres \n")])])]),o("h5",{attrs:{id:"_2-2-1-2-set-up-postgresql-streaming-replication-on-the-primary-server"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-2-set-up-postgresql-streaming-replication-on-the-primary-server"}},[e._v("#")]),e._v(" 2.2.1.2 Set up PostgreSQL streaming replication on the primary server.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//First, we create the directory /var/lib/pgsql/archivedir to store WAL segments on all servers. In this example, only Primary node archives WAL locally.\n[all servers]# su - postgres\n[all servers]$ mkdir /var/lib/pgsql/archivedir\n\n//Then we edit the configuration file $PGDATA/postgresql.conf on ~~server1 (primary)~~ all servers as follows. Enable wal_log_hints to use pg_rewind. Since the Primary may become a Standby later, we set hot_standby = on.\n\nlisten_addresses = '*'\narchive_mode = on\narchive_command = 'cp \"%p\" \"/var/lib/pgsql/archivedir/%f\"'\nmax_wal_senders = 10\nmax_replication_slots = 10\nwal_level = replica\nhot_standby = on\nwal_log_hints = on\n\n")])])]),o("p",[e._v("We use the online recovery functionality of Pgpool-II to setup standby server after the primary server is started.")]),e._v(" "),o("h5",{attrs:{id:"_2-2-1-4-create-users"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-4-create-users"}},[e._v("#")]),e._v(" 2.2.1.4 create users")]),e._v(" "),o("p",[e._v("Because of the security reasons, we create a user repl solely used for replication purpose, and a user pgpool for streaming replication delay check and health check of Pgpool-II.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('[server1]# psql -U postgres -p 5432\npostgres=# SET password_encryption = \'scram-sha-256\';\npostgres=# CREATE ROLE pgpool WITH LOGIN;\npostgres=# CREATE ROLE repl WITH REPLICATION LOGIN;\npostgres=# \\password pgpool\npostgres=# \\password repl\npostgres=# \\password postgres\n\n//If you want to show "replication_state" and "replication_sync_state" column in SHOW POOL NODES command result, role pgpool needs to be PostgreSQL super user or or in pg_monitor group (Pgpool-II 4.1 or later). Grant pg_monitor to pgpool:\nGRANT pg_monitor TO pgpool;\n')])])]),o("h5",{attrs:{id:"_2-2-1-5-enable-scram-sha-256-authentication-method"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-5-enable-scram-sha-256-authentication-method"}},[e._v("#")]),e._v(" 2.2.1.5 enable scram-sha-256 authentication method")]),e._v(" "),o("p",[e._v("Assuming that all the Pgpool-II servers and the PostgreSQL servers are in the same subnet and edit pg_hba.conf to enable scram-sha-256 authentication method.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("vi /lyhistory/workspace/postgres/data/pg_hba.conf \nhost    all             all             samenet                 scram-sha-256\n     host    replication     all             samenet                 scram-sha-256\n")])])]),o("h5",{attrs:{id:"_2-2-1-6-passwordless-ssh"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-6-passwordless-ssh"}},[e._v("#")]),e._v(" 2.2.1.6 passwordless SSH")]),e._v(" "),o("p",[e._v("To use the automated failover and online recovery of Pgpool-II, the settings that allow passwordless SSH to all backend servers between Pgpool-II execution user (default root user) and postgres user and between postgres user and postgres user are necessary. Execute the following command on all servers to set up passwordless SSH. The generated key file name is id_rsa_pgpool.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("[all servers]# cd ~/.ssh\n[all servers]# ssh-keygen -t rsa -f id_rsa_pgpool\n[all servers]# ssh-copy-id -i id_rsa_pgpool.pub postgres@server1\n[all servers]# ssh-copy-id -i id_rsa_pgpool.pub postgres@server2\n[all servers]# ssh-copy-id -i id_rsa_pgpool.pub postgres@server3\n\n[all servers]# su - postgres\n[all servers]$ cd ~/.ssh\n[all servers]$ ssh-keygen -t rsa -f id_rsa_pgpool\n[all servers]$ ssh-copy-id -i id_rsa_pgpool.pub postgres@server1\n[all servers]$ ssh-copy-id -i id_rsa_pgpool.pub postgres@server2\n[all servers]$ ssh-copy-id -i id_rsa_pgpool.pub postgres@server3\n\ntest:\nssh postgres@serverX -i ~/.ssh/id_rsa_pgpool\n")])])]),o("h5",{attrs:{id:"_2-2-1-7-allow-repl-user-without-specifying-password-for-streaming-replication-and-online-recovery"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-7-allow-repl-user-without-specifying-password-for-streaming-replication-and-online-recovery"}},[e._v("#")]),e._v(" 2.2.1.7 allow repl user without specifying password for streaming replication and online recovery")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("[all servers]# su - postgres\n[all servers]$ vi /var/lib/pgsql/.pgpass\nserver1:5432:replication:repl:<repl user password>\nserver2:5432:replication:repl:<repl user passowrd>\nserver3:5432:replication:repl:<repl user passowrd>\nserver1:5432:postgres:postgres:<postgres user passowrd>\nserver2:5432:postgres:postgres:<postgres user passowrd>\nserver3:5432:postgres:postgres:<postgres user passowrd>\n[all servers]$ chmod 600  /var/lib/pgsql/.pgpass\n    \n")])])]),o("h5",{attrs:{id:"_2-2-1-8-firewall-for-postgres"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-8-firewall-for-postgres"}},[e._v("#")]),e._v(" 2.2.1.8 firewall for postgres")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("[all servers]# firewall-cmd --permanent --zone=public --add-service=postgresql\n[all servers]# firewall-cmd --reload\n")])])]),o("h5",{attrs:{id:"_2-2-1-9-summary"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-9-summary"}},[e._v("#")]),e._v(" 2.2.1.9 Summary")]),e._v(" "),o("table",[o("thead",[o("tr",[o("th",[o("strong",[e._v("Item")])]),e._v(" "),o("th",[o("strong",[e._v("Value")])]),e._v(" "),o("th",[o("strong",[e._v("Detail")])])])]),e._v(" "),o("tbody",[o("tr",[o("td",[e._v("PostgreSQL  Version")]),e._v(" "),o("td",[e._v("12.7")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("port")]),e._v(" "),o("td",[e._v("5432")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("$PGDATA")]),e._v(" "),o("td",[e._v("/lyhistory/workspace/postgres/data")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("Archive  mode")]),e._v(" "),o("td",[e._v("on")]),e._v(" "),o("td",[e._v("/var/lib/pgsql/archivedir")])]),e._v(" "),o("tr",[o("td",[e._v("Replication  Slots")]),e._v(" "),o("td",[e._v("Enable ?")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("Start  automatically")]),e._v(" "),o("td",[e._v("Disable")]),e._v(" "),o("td",[e._v("-")])])])]),e._v(" "),o("h4",{attrs:{id:"_2-2-2-setup-pgpool-ii-watchdog"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-setup-pgpool-ii-watchdog"}},[e._v("#")]),e._v(" 2.2.2 Setup Pgpool-II+Watchdog")]),e._v(" "),o("h5",{attrs:{id:"_2-2-2-1-install-pgpool-ii"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-1-install-pgpool-ii"}},[e._v("#")]),e._v(" 2.2.2.1 Install Pgpool-II")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("# yum install http://www.pgpool.net/yum/rpms/4.1/redhat/rhel-7-x86_64/pgpool-II-release-4.1-1.noarch.rpm\n# yum install pgpool-II-pg11-*\n")])])]),o("h5",{attrs:{id:"_2-2-2-2-pgpool-ii-configuration-common-settings"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-2-pgpool-ii-configuration-common-settings"}},[e._v("#")]),e._v(" 2.2.2.2 Pgpool-II Configuration - Common Settings")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("$ cp -p /etc/pgpool-II/pgpool.conf.sample-stream /etc/pgpool-II/pgpool.conf\n\nlisten_addresses = '*'\n#Specify replication delay check user and password\nsr_check_user = 'pgpool'\nsr_check_password = ''\n\n#Enable health check so that Pgpool-II performs failover\nhealth_check_period = 5\n# Health check period\n# Disabled (0) by default\nhealth_check_timeout = 30\n# Health check timeout\n# 0 means no timeout\nhealth_check_user = 'pgpool'\nhealth_check_password = ''\n\nhealth_check_max_retries = 3\n\n#Specify the PostgreSQL backend informations\n# - Backend Connection Settings -\n\nbackend_hostname0 = 'server1'\n# Host name or IP address to connect to for backend 0\nbackend_port0 = 5432\n# Port number for backend 0\nbackend_weight0 = 1\n# Weight for backend 0 (only in load balancing mode)\nbackend_data_directory0 = '/var/lib/pgsql/11/data'\n# Data directory for backend 0\nbackend_flag0 = 'ALLOW_TO_FAILOVER'\n# Controls various backend behavior\n# ALLOW_TO_FAILOVER or DISALLOW_TO_FAILOVER\nbackend_hostname1 = 'server2'\nbackend_port1 = 5432\nbackend_weight1 = 1\nbackend_data_directory1 = '/var/lib/pgsql/11/data'\nbackend_flag1 = 'ALLOW_TO_FAILOVER'\n\nbackend_hostname2 = 'server3'\nbackend_port2 = 5432\nbackend_weight2 = 1\nbackend_data_directory2 = '/var/lib/pgsql/11/data'\nbackend_flag2 = 'ALLOW_TO_FAILOVER'\n\n//To show \"replication_state\" and \"replication_sync_state\" column in SHOW POOL NODES command result, backend_application_name parameter is required\nbackend_application_name0 = 'server1'\n...\nbackend_application_name1 = 'server2'\n...\nbackend_application_name2 = 'server3'\n")])])]),o("h5",{attrs:{id:"_2-2-2-3-pgpool-ii-configuration-failover-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-3-pgpool-ii-configuration-failover-configuration"}},[e._v("#")]),e._v(" 2.2.2.3 Pgpool-II Configuration - Failover configuration")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("failover_command = '/etc/pgpool-II/failover.sh %d %h %p %D %m %H %M %P %r %R %N %S'\nfollow_master_command = '/etc/pgpool-II/follow_master.sh %d %h %p %D %m %M %H %P %r %R'\n\n\n$ cp /etc/pgpool-II/failover.sh.sample /etc/pgpool-II/failover.sh\n$ vi /etc/pgpool-II/follow_master.sh.sample  /etc/pgpool-II/follow_master.sh\n$ chmod +x /etc/pgpool-II/{failover.sh,follow_master.sh}\n")])])]),o("h5",{attrs:{id:"_2-2-2-4-pgpool-ii-configuration-online-recovery-configurations"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-4-pgpool-ii-configuration-online-recovery-configurations"}},[e._v("#")]),e._v(" 2.2.2.4 Pgpool-II Configuration - Online Recovery Configurations")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("$vim /etc/pgpool-II/pgpool.conf\n\nrecovery_user = 'postgres'\n# Online recovery user\nrecovery_password = ''\n# Online recovery password\n\nrecovery_1st_stage_command = 'recovery_1st_stage'\n\n[server1]# su - postgres\n[server1]$ vi /var/lib/pgsql/11/data/recovery_1st_stage\n[server1]$ vi /var/lib/pgsql/11/data/pgpool_remote_start\n[server1]$ chmod +x /var/lib/pgsql/11/data/{recovery_1st_stage,pgpool_remote_start}\n\n")])])]),o("p",[e._v("In order to use the online recovery functionality, the functions of pgpool_recovery, pgpool_remote_start, pgpool_switch_xlog are required, so we need install pgpool_recovery on template1 of PostgreSQL server server1.")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('[server1]# su - postgres\n[server1]$ psql template1 -c "CREATE EXTENSION pgpool_recovery"\n')])])]),o("h5",{attrs:{id:"_2-2-2-5-pgpool-ii-configuration-client-authentication-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-5-pgpool-ii-configuration-client-authentication-configuration"}},[e._v("#")]),e._v(" 2.2.2.5 Pgpool-II Configuration - Client Authentication Configuration")]),e._v(" "),o("p",[e._v("Because in the section Before Starting, we already set PostgreSQL authentication method to scram-sha-256, it is necessary to set a client authentication by Pgpool-II to connect to backend nodes")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("vim /etc/pgpool-II/pool_hba.conf\nenable_pool_hba = on\nhost    all         pgpool           0.0.0.0/0          scram-sha-256\nhost    all         postgres         0.0.0.0/0          scram-sha-256\n\n//The default password file name for authentication is pool_passwd. To use scram-sha-256 authentication, the decryption key to decrypt the passwords is required. We create the .pgpoolkey file in root user's home directory.\n[all servers]# echo 'some string' > ~/.pgpoolkey \n[all servers]# chmod 600 ~/.pgpoolkey\n\n//Execute command pg_enc -m -k /path/to/.pgpoolkey -u username -p to regist user name and AES encrypted password in file pool_passwd.\n[all servers]# pg_enc -m -k /root/.pgpoolkey -u pgpool -p\ndb password: [pgpool user's password]\n[all servers]# pg_enc -m -k /root/.pgpoolkey -u postgres -p\ndb password: [postgres user's passowrd]\n\n# cat /etc/pgpool-II/pool_passwd \npgpool:AESheq2ZMZjynddMWk5sKP/Rw==\npostgres:AESHs/pWL5rtXy2IwuzroHfqg==\n")])])]),o("h5",{attrs:{id:"_2-2-2-6-pgpool-ii-configuration-watchdog-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-6-pgpool-ii-configuration-watchdog-configuration"}},[e._v("#")]),e._v(" 2.2.2.6 Pgpool-II Configuration - Watchdog Configuration")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//Enable watchdog functionality on server1, server2, server3.\n   use_watchdog = on\n//Specify virtual IP address that accepts connections from clients on server1, server2, server3\n   delegate_IP = '192.168.137.150'\n//To bring up/down the virtual IP and send the ARP requests, we set if_up_cmd, if_down_cmd and arping_cmd. The network interface used in this example is \"enp0s8\". Since root privilege is required to execute if_up/down_cmd or arping_cmd command, use setuid on these command or allow Pgpool-II startup user, postgres user (Pgpool-II 4.1 or later) to run sudo command without a password. If installed from RPM, the postgres user has been configured to run ip/arping via sudo without a password.\nif_up_cmd = '/usr/bin/sudo /sbin/ip addr add $_IP_$/24 dev enp0s8 label enp0s8:0'\nif_down_cmd = '/usr/bin/sudo /sbin/ip addr del $_IP_$/24 dev enp0s8'\narping_cmd = '/usr/bin/sudo /usr/sbin/arping -U $_IP_$ -w 1 -I enp0s8'\n\n//Set if_cmd_path and arping_path according to the command path. If if_up/down_cmd or arping_cmd starts with \"/\", these parameters will be ignored.\nif_cmd_path = '/sbin'\narping_path = '/usr/sbin'\n   \n//Specify the hostname and port number of each Pgpool-II server.\nserver1\n\n      wd_hostname = 'server1'\n      wd_port = 9000\n     \nserver2\n\n      wd_hostname = 'server2'\n      wd_port = 9000\n     \nserver3\n\n      wd_hostname = 'server3'\n      wd_port = 9000\n\n//Specify the hostname, Pgpool-II port number, and watchdog port number of monitored Pgpool-II servers on each Pgpool-II server.\n\nserver1\n\n      # - Other pgpool Connection Settings -\n\n      other_pgpool_hostname0 = 'server2'\n      # Host name or IP address to connect to for other pgpool 0\n      # (change requires restart)\n      other_pgpool_port0 = 9999\n      # Port number for other pgpool 0\n      # (change requires restart)\n      other_wd_port0 = 9000\n      # Port number for other watchdog 0\n      # (change requires restart)\n      other_pgpool_hostname1 = 'server3'\n      other_pgpool_port1 = 9999\n      other_wd_port1 = 9000\n     \nserver2\n\n      # - Other pgpool Connection Settings -\n\n      other_pgpool_hostname0 = 'server1'\n      # Host name or IP address to connect to for other pgpool 0\n      # (change requires restart)\n      other_pgpool_port0 = 9999\n      # Port number for other pgpool 0\n      # (change requires restart)\n      other_wd_port0 = 9000\n      # Port number for other watchdog 0\n      # (change requires restart)\n      other_pgpool_hostname1 = 'server3'\n      other_pgpool_port1 = 9999\n      other_wd_port1 = 9000\n     \nserver3\n\n      # - Other pgpool Connection Settings -\n\n      other_pgpool_hostname0 = 'server1'\n      # Host name or IP address to connect to for other pgpool 0\n      # (change requires restart)\n      other_pgpool_port0 = 9999\n      # Port number for other pgpool 0\n      # (change requires restart)\n      other_wd_port0 = 9000\n      # Port number for other watchdog 0\n      # (change requires restart)\n      other_pgpool_hostname1 = 'server2'\n      other_pgpool_port1 = 9999\n      other_wd_port1 = 9000\n\n//Specify the hostname and port number of destination for sending heartbeat signal on server1, server2, server3.\nserver1\n\n      heartbeat_destination0 = 'server2'\n      # Host name or IP address of destination 0\n      # for sending heartbeat signal.\n      # (change requires restart)\n      heartbeat_destination_port0 = 9694\n      # Port number of destination 0 for sending\n      # heartbeat signal. Usually this is the\n      # same as wd_heartbeat_port.\n      # (change requires restart)\n      heartbeat_device0 = ''\n      # Name of NIC device (such like 'eth0')\n      # used for sending/receiving heartbeat\n      # signal to/from destination 0.\n      # This works only when this is not empty\n      # and pgpool has root privilege.\n      # (change requires restart)\n\n      heartbeat_destination1 = 'server3'\n      heartbeat_destination_port1 = 9694\n      heartbeat_device1 = ''\n     \nserver2\n\n      heartbeat_destination0 = 'server1'\n      # Host name or IP address of destination 0\n      # for sending heartbeat signal.\n      # (change requires restart)\n      heartbeat_destination_port0 = 9694\n      # Port number of destination 0 for sending\n      # heartbeat signal. Usually this is the\n      # same as wd_heartbeat_port.\n      # (change requires restart)\n      heartbeat_device0 = ''\n      # Name of NIC device (such like 'eth0')\n      # used for sending/receiving heartbeat\n      # signal to/from destination 0.\n      # This works only when this is not empty\n      # and pgpool has root privilege.\n      # (change requires restart)\n\n      heartbeat_destination1 = 'server3'\n      heartbeat_destination_port1 = 9694\n      heartbeat_device1 = ''\n     \nserver3\n\n      heartbeat_destination0 = 'server1'\n      # Host name or IP address of destination 0\n      # for sending heartbeat signal.\n      # (change requires restart)\n      heartbeat_destination_port0 = 9694\n      # Port number of destination 0 for sending\n      # heartbeat signal. Usually this is the\n      # same as wd_heartbeat_port.\n      # (change requires restart)\n      heartbeat_device0 = ''\n      # Name of NIC device (such like 'eth0')\n      # used for sending/receiving heartbeat\n      # signal to/from destination 0.\n      # This works only when this is not empty\n      # and pgpool has root privilege.\n      # (change requires restart)\n\n      heartbeat_destination1 = 'server2'\n      heartbeat_destination_port1 = 9694\n      heartbeat_device1 = ''\n     \n")])])]),o("h5",{attrs:{id:"_2-2-2-7-pgpool-ii-configuration-etc-sysconfig-pgpool-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-7-pgpool-ii-configuration-etc-sysconfig-pgpool-configuration"}},[e._v("#")]),e._v(" 2.2.2.7 Pgpool-II Configuration - /etc/sysconfig/pgpool Configuration")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('//If you want to ignore the pgpool_status file at startup of Pgpool-II, add "- D" to the start option OPTS to /etc/sysconfig/pgpool.\n[all servers]# vi /etc/sysconfig/pgpool \n    ...\n    OPTS=" -D -n"\n')])])]),o("h5",{attrs:{id:"_2-2-2-8-pgpool-ii-configuration-logging"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-8-pgpool-ii-configuration-logging"}},[e._v("#")]),e._v(" 2.2.2.8 Pgpool-II Configuration - Logging")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("log_destination = 'syslog'\n    # Where to log\n    # Valid values are combinations of stderr,\n    # and syslog. Default to stderr.\n\n    syslog_facility = 'LOCAL1'\n    # Syslog local facility. Default to LOCAL0\n   \n[all servers]# mkdir /var/log/pgpool-II\n    [all servers]# touch /var/log/pgpool-II/pgpool.log\n   \n[all servers]# vi /etc/rsyslog.conf\n    ...\n    *.info;mail.none;authpriv.none;cron.none;LOCAL1.none    /var/log/messages\n    LOCAL1.*                                                /var/log/pgpool-II/pgpool.log\n[all servers]# vi /etc/logrotate.d/syslog\n    ...\n    /var/log/messages\n    /var/log/pgpool-II/pgpool.log\n    /var/log/secure\n   \n[all servers]# systemctl restart rsyslog\n")])])]),o("h5",{attrs:{id:"_2-2-2-9-pgpool-ii-configuration-pcp-command-configuration"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-9-pgpool-ii-configuration-pcp-command-configuration"}},[e._v("#")]),e._v(" 2.2.2.9 Pgpool-II Configuration - PCP Command Configuration")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//Since user authentication is required to use the PCP command, specify user name and md5 encrypted password in pcp.conf. Here we create the encrypted password for pgpool user, and add \"username:encrypted password\" in /etc/pgpool-II/pcp.conf.\n[all servers]# echo 'pgpool:'`pg_md5 PCP passowrd` >> /etc/pgpool-II/pcp.conf\n")])])]),o("h5",{attrs:{id:"_2-2-2-10-pgpool-ii-configuration-pcppass"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-10-pgpool-ii-configuration-pcppass"}},[e._v("#")]),e._v(" 2.2.2.10 Pgpool-II Configuration - .pcppass")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//Since follow_master_command script has to execute PCP command without entering the password, we create .pcppass in the home directory of Pgpool-II startup user (root user). If doesn’t have root access, repeated same step under postgres user home directory (/var/lib/pgsql), make sure the permission is 600.\n\n[all servers]# echo 'localhost:9898:pgpool:pgpool' > ~/.pcppass\n[all servers]# chmod 600 ~/.pcppass\n")])])]),o("h5",{attrs:{id:"_2-2-2-11-firewall-for-pgpool-ii"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-11-firewall-for-pgpool-ii"}},[e._v("#")]),e._v(" 2.2.2.11 firewall for Pgpool-II")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("[all servers]# firewall-cmd --permanent --zone=public --add-port=9999/tcp --add-port=9898/tcp --add-port=9000/tcp  --add-port=9694/udp\n[all servers]# firewall-cmd --reload\n")])])]),o("h5",{attrs:{id:"_2-2-2-12-summary"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-12-summary"}},[e._v("#")]),e._v(" 2.2.2.12 Summary")]),e._v(" "),o("table",[o("thead",[o("tr",[o("th",[o("strong",[e._v("Item")])]),e._v(" "),o("th",[o("strong",[e._v("Value")])]),e._v(" "),o("th",[o("strong",[e._v("Detail")])])])]),e._v(" "),o("tbody",[o("tr",[o("td",[e._v("Pgpool-II  Version")]),e._v(" "),o("td",[e._v("4.1.1")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("port")]),e._v(" "),o("td",[e._v("9999")]),e._v(" "),o("td",[e._v("Pgpool-II  accepts connections")])]),e._v(" "),o("tr",[o("td",[e._v("9898")]),e._v(" "),o("td",[e._v("PCP  process accepts connections")]),e._v(" "),o("td")]),e._v(" "),o("tr",[o("td",[e._v("9000")]),e._v(" "),o("td",[e._v("watchdog  accepts connections")]),e._v(" "),o("td")]),e._v(" "),o("tr",[o("td",[e._v("9694")]),e._v(" "),o("td",[e._v("UDP  port for receiving Watchdog's heartbeat signal")]),e._v(" "),o("td")]),e._v(" "),o("tr",[o("td",[e._v("Config  file")]),e._v(" "),o("td",[e._v("/etc/pgpool-II/pgpool.conf")]),e._v(" "),o("td",[e._v("Pgpool-II  config file")])]),e._v(" "),o("tr",[o("td",[e._v("Pgpool-II  start user")]),e._v(" "),o("td",[e._v("postgres  (Pgpool-II 4.1 or later)")]),e._v(" "),o("td",[e._v("Pgpool-II  4.0 or before, the default startup user is root")])]),e._v(" "),o("tr",[o("td",[e._v("Running  mode")]),e._v(" "),o("td",[e._v("streaming  replication mode")]),e._v(" "),o("td",[e._v("-")])]),e._v(" "),o("tr",[o("td",[e._v("Watchdog")]),e._v(" "),o("td",[e._v("on")]),e._v(" "),o("td",[e._v("Life  check method: heartbeat")])]),e._v(" "),o("tr",[o("td",[e._v("Start  automatically")]),e._v(" "),o("td",[e._v("Disable")]),e._v(" "),o("td",[e._v("-")])])])]),e._v(" "),o("h4",{attrs:{id:"_2-2-3-assign-permission-and-set-env-path"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-3-assign-permission-and-set-env-path"}},[e._v("#")]),e._v(" 2.2.3 Assign Permission and set env path")]),e._v(" "),o("p",[e._v("chown –R postgres:postgres /var/lib/pgsql/12，")]),e._v(" "),o("p",[e._v("vim /var/lib/pgsql/.bash_profile\nPATH=$PATH:/usr/pgsql-12/bin\nexport PATH")]),e._v(" "),o("h4",{attrs:{id:"_2-2-4-starting-stopping-pgpool-ii"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-4-starting-stopping-pgpool-ii"}},[e._v("#")]),e._v(" 2.2.4 Starting/Stopping Pgpool-II")]),e._v(" "),o("p",[e._v("Before starting Pgpool-II, please start PostgreSQL servers first. Also, when stopping PostgreSQL, it is necessary to stop Pgpool-II first")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("//let's start Pgpool-II on server1, server2, server3\n # systemctl start pgpool.service\n")])])]),o("h4",{attrs:{id:"_2-2-5-set-up-postgresql-standby-server"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-5-set-up-postgresql-standby-server"}},[e._v("#")]),e._v(" 2.2.5 Set up PostgreSQL standby server")]),e._v(" "),o("p",[e._v("First, we should set up PostgreSQL standby server by using Pgpool-II online recovery functionality. Ensure that recovery_1st_stage and pgpool_remote_start scripts used by pcp_recovery_node command are in database cluster directory of PostgreSQL primary server (server1).")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('# pcp_recovery_node -h 192.168.137.150 -p 9898 -U pgpool -n 1\n    Password: \n    pcp_recovery_node -- Command Successful\n\n    # pcp_recovery_node -h 192.168.137.150 -p 9898 -U pgpool -n 2\n    Password: \n    pcp_recovery_node -- Command Successful\n\n//After executing pcp_recovery_node command, vertify that server2 and server3 are started as PostgreSQL standby server.\n# psql -h 192.168.137.150 -p 9999 -U pgpool postgres -c "show pool_nodes"\n    Password for user pgpool\n    node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | replication_state | replication_sync_state | last_status_change  \n    ---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+-------------------+------------------------+---------------------\n    0       | server1  | 5432 | up     | 0.333333  | primary | 0          | false             | 0                 |                   |                        | 2019-08-06 11:13:17\n    1       | server2  | 5432 | up     | 0.333333  | standby | 0          | true              | 0                 | streaming         | async                  | 2019-08-06 11:13:25\n    2       | server3  | 5432 | up     | 0.333333  | standby | 0          | false             | 0                 | streaming         | async                  | 2019-08-06 11:14:20\n    (3 rows)\n')])])]),o("h4",{attrs:{id:"_2-2-6-switching-active-standby-watchdog"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-6-switching-active-standby-watchdog"}},[e._v("#")]),e._v(" 2.2.6 Switching active/standby watchdog")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('//Confirm the watchdog status by using pcp_watchdog_info. The Pgpool-II server which is started first run as MASTER.\n  # pcp_watchdog_info -h 192.168.137.150 -p 9898 -U pgpool\n    Password: \n    3 YES server1:9999 Linux server1 server1\n\n    server1:9999 Linux server1 server1 9999 9000 4 MASTER  #The Pgpool-II server started first becames "MASTER".\n    server2:9999 Linux server2 server2 9999 9000 7 STANDBY #run as standby\n    server3:9999 Linux server3 server3 9999 9000 7 STANDBY #run as standby\n\n//Stop active server server1, then server2 or server3 will be promoted to active server. To stop server1, we can stop Pgpool-II service or shutdown the whole system. Here, we stop Pgpool-II service.\n[server1]# systemctl stop pgpool.service\n\n    # pcp_watchdog_info -p 9898 -h 192.168.137.150 -U pgpool\n    Password: \n    3 YES server2:9999 Linux server2 server2\n\n    server2:9999 Linux server2 server2 9999 9000 4 MASTER     #server2 is promoted to MASTER\n    server1:9999 Linux server1 server1 9999 9000 10 SHUTDOWN  #server1 is stopped\n    server3:9999 Linux server3 server3 9999 9000 7 STANDBY    #server3 runs as STANDBY\n//Start Pgpool-II (server1) which we have stopped again, and vertify that server1 runs as a standby.\n[server1]# systemctl start pgpool.service\n\n    [server1]# pcp_watchdog_info -p 9898 -h 192.168.137.150 -U pgpool\n    Password: \n    3 YES server2:9999 Linux server2 server2\n\n    server2:9999 Linux server2 server2 9999 9000 4 MASTER\n    server1:9999 Linux server1 server1 9999 9000 7 STANDBY\n    server3:9999 Linux server3 server3 9999 9000 7 STANDBY\n\n')])])]),o("h4",{attrs:{id:"_2-2-7-failover"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-7-failover"}},[e._v("#")]),e._v(" 2.2.7 Failover")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('//First, use psql to connect to PostgreSQL via virtual IP, and verify the backend informations.\n# psql -h 192.168.137.150 -p 9999 -U pgpool postgres -c "show pool_nodes"\n    Password for user pgpool:\n    node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | replication_state | replication_sync_state | last_status_change  \n    ---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+-------------------+------------------------+---------------------\n    0       | server1  | 5432 | up     | 0.333333  | primary | 0          | false             | 0                 |                   |                        | 2019-08-06 11:13:17\n    1       | server2  | 5432 | up     | 0.333333  | standby | 0          | true              | 0                 | streaming         | async                  | 2019-08-06 11:13:25\n    2       | server3  | 5432 | up     | 0.333333  | standby | 0          | false             | 0                 | streaming         | async                  | 2019-08-06 11:14:20\n    (3 rows)\n\n//Next, stop primary PostgreSQL server server1, and verify automatic failover.\n\n    [server1]$ pg_ctl -D /var/lib/pgsql/11/data -m immediate stop\n//After stopping PostgreSQL on server1, failover occurs and PostgreSQL on server2 becomes new primary DB.\n\n    # psql -h 192.168.137.150 -p 9999 -U pgpool postgres -c "show pool_nodes"\n    Password for user pgpool:\n    node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | replication_state | replication_sync_state | last_status_change  \n    ---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+-------------------+------------------------+---------------------\n    0       | server1  | 5432 | down   | 0.333333  | standby | 0          | false             | 0                 |                   |                        | 2019-08-06 11:36:03\n    1       | server2  | 5432 | up     | 0.333333  | primary | 0          | true              | 0                 |                   |                        | 2019-08-06 11:36:03\n    2       | server3  | 5432 | up     | 0.333333  | standby | 0          | false             | 0                 | streaming         | async                  | 2019-08-06 11:36:15\n    (3 rows)\n//server3 is running as standby of new primary server2.\n\n    [server3]# psql -h server3 -p 5432 -U pgpool postgres -c "select pg_is_in_recovery()"\n    pg_is_in_recovery \n    -------------------\n    t\n\n    [server2]# psql -h server2 -p 5432 -U pgpool postgres -c "select pg_is_in_recovery()"\n    pg_is_in_recovery \n    -------------------\n    f\n\n    [server2]# psql -h server2 -p 5432 -U pgpool postgres -c "select * from pg_stat_replication" -x\n    -[ RECORD 1 ]----+------------------------------\n    pid              | 11059\n    usesysid         | 16392\n    usename          | repl\n    application_name | server3\n    client_addr      | 192.168.137.103\n    client_hostname  | \n    client_port      | 48694\n    backend_start    | 2019-08-06 11:36:07.479161+09\n    backend_xmin     | \n    state            | streaming\n    sent_lsn         | 0/75000148\n    write_lsn        | 0/75000148\n    flush_lsn        | 0/75000148\n    replay_lsn       | 0/75000148\n    write_lag        | \n    flush_lag        | \n    replay_lag       | \n    sync_priority    | 0\n    sync_state       | async\n    reply_time       | 2019-08-06 11:42:59.823961+09\n')])])]),o("h4",{attrs:{id:"_2-2-8-online-recovery"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-8-online-recovery"}},[e._v("#")]),e._v(" 2.2.8 Online Recovery")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('//Here, we use Pgpool-II online recovery functionality to restore server1 (old primary server) as a standby. Before restoring the old primary server, please ensure that recovery_1st_stage and pgpool_remote_start scripts exist in database cluster directory of current primary server server2.\n  # pcp_recovery_node -h 192.168.137.150 -p 9898 -U pgpool -n 0\n    Password: \n    pcp_recovery_node -- Command Successful\n//Then verify that server1 is started as a standby.\n\n    # psql -h 192.168.137.150 -p 9999 -U pgpool postgres -c "show pool_nodes"\n    Password for user pgpool:\n    node_id | hostname | port | status | lb_weight |  role   | select_cnt | load_balance_node | replication_delay | replication_state | replication_sync_state | last_status_change  \n    ---------+----------+------+--------+-----------+---------+------------+-------------------+-------------------+-------------------+------------------------+---------------------\n    0       | server1  | 5432 | up     | 0.333333  | standby | 0          | false             | 0                 | streaming         | async                  | 2019-08-06 11:48:05\n    1       | server2  | 5432 | up     | 0.333333  | primary | 0          | false             | 0                 |                   |                        | 2019-08-06 11:36:03\n    2       | server3  | 5432 | up     | 0.333333  | standby | 0          | true              | 0                 | streaming         | async                  | 2019-08-06 11:36:15\n    (3 rows)\n')])])]),o("h2",{attrs:{id:"pgpool-setup-streaming-replication-mode"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#pgpool-setup-streaming-replication-mode"}},[e._v("#")]),e._v(" pgpool_setup (Streaming replication mode)")]),e._v(" "),o("p",[e._v("https://www.pgpool.net/docs/pgpool-II-4.1.0/en/html/tutorial.html")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("pgpool_setup\n\n")])])]),o("h2",{attrs:{id:"manage-pgpool-ii"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#manage-pgpool-ii"}},[e._v("#")]),e._v(" Manage PgPool-II")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v('\npsql -h <VirtualIP> -p 9999 -U pgpool postgres -c "show pool_nodes"\npcp_watchdog_info -p 9898 -h <Virtual IP> -U pgpool\n\npgbench \n\npg_ctl \n\npcp_recovery_node \n\n\n\n')])])]),o("h2",{attrs:{id:"troubleshooting"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[e._v("#")]),e._v(" Troubleshooting")]),e._v(" "),o("h3",{attrs:{id:"pcp-recovery-node-error"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#pcp-recovery-node-error"}},[e._v("#")]),e._v(" pcp_recovery_node error")]),e._v(" "),o("h4",{attrs:{id:"error-executing-recovery"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#error-executing-recovery"}},[e._v("#")]),e._v(" ERROR: executing recovery")]),e._v(" "),o("div",{staticClass:"language- extra-class"},[o("pre",{pre:!0,attrs:{class:"language-text"}},[o("code",[e._v("pcp_recovery_node \n\nERROR: executing recovery, execution of command failed at \"1st stage\"\nDETAIL: command:\"recovery_1st_stage\"\n\nvi /lyhistory/workspace/postgres/data/log/postgresql-Mon.log\n\n2022-06-27 12:00:21.267 +08 [9557] LOG:  database system is ready to accept connections\nsh: /lyhistory/workspace/postgres/data/recovery_1st_stage: /bin/bash^M: bad interpreter: No such file or directory\n2022-06-27 12:02:53.154 +08 [9825] ERROR:  pgpool_recovery failed\n2022-06-27 12:02:53.154 +08 [9825] STATEMENT:  SELECT pgpool_recovery('recovery_1st_stage', 'sghc1_prod_nss_alpha_v02', '/lyhistory/workspace/postgres/data', '5432', 1, '5432')\nsh: /lyhistory/workspace/postgres/data/recovery_1st_stage: /bin/bash^M: bad interpreter: No such file or directory\n\n\ndos2unix recovery_1st_stage\n")])])]),o("h4",{attrs:{id:"error-executing-remote-start-failed-with-error-error-pgpool-remote-start-failed"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#error-executing-remote-start-failed-with-error-error-pgpool-remote-start-failed"}},[e._v("#")]),e._v(' ERROR:  executing remote start failed with error: "ERROR:  pgpool_remote_start failed')]),e._v(" "),o("p",[e._v("奇怪，再试一次就可以成功 just retry one more time")]),e._v(" "),o("h3",{attrs:{id:"failover-failed"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#failover-failed"}},[e._v("#")]),e._v(" Failover failed")]),e._v(" "),o("p",[e._v("vm1 master vm2&vm3 是slave\n杀掉vm1的postgres，vm2成为master，但是vm3也down掉（但是5432仍然在监听，systemctl status是dead状态）")]),e._v(" "),o("p",[e._v("https://stackoverflow.com/questions/72259918/pgpool-failover")])])}),[],!1,null,null,null);t.default=r.exports}}]);