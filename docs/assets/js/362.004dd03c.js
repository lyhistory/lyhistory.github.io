(window.webpackJsonp=window.webpackJsonp||[]).push([[362],{795:function(e,t,a){"use strict";a.r(t);var n=a(65),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("p",[e._v("The SSL protocol runs above the TCP/IP and below higher-level protocols such as HTTP. It uses TCP/IP on behalf of the higher-level protocols.")]),e._v(" "),a("p",[e._v("The TLS handshake happens after the TCP handshake. For the TCP or for the transport layer, everything in the TLS handshake is just application data. Once the TCP handshake is completed the TLS layer will initiate the TLS handshake.")]),e._v(" "),a("p",[e._v("https secure http")]),e._v(" "),a("p",[e._v("wss secure websocket")]),e._v(" "),a("p",[e._v("refer to 《network.md/tls》")]),e._v(" "),a("h2",{attrs:{id:"ssl-tls-certificate-证书类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssl-tls-certificate-证书类型"}},[e._v("#")]),e._v(" SSL/TLS Certificate 证书类型")]),e._v(" "),a("p",[e._v("工具：keytool openssl")]),e._v(" "),a("p",[e._v("证书可以单纯只是包含ca认证的证书链（CA的签名）或自签名，以及公钥，也可以同时包含私钥，私钥当然可以独立于证书生成单独存储；")]),e._v(" "),a("p",[e._v("带密码：spring boot mvc程序，这样好处是双重保护，因为需要同时需要密码和私钥才可以")]),e._v(" "),a("p",[e._v("不带密码：ngnix，私钥或者是含有私钥的证书一定要控制读取权限")]),e._v(" "),a("p",[e._v("按照生成方式分为：")]),e._v(" "),a("h3",{attrs:{id:"self-sgined-certificate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#self-sgined-certificate"}},[e._v("#")]),e._v(" self-sgined certificate")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('------------------------------------------------------------\n--- use openssl 不带密码\n------------------------------------------------------------\nsudo mkdir /etc/ssl/privatekey\nsudo chmod 700 /etc/ssl/privatekey\nsudo openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout /etc/ssl/privatekey/nginx-selfsigned.key -out /etc/ssl/certs/nginx-selfsigned.crt\n\nvim nginx-selfsigned.crt\n\t-----BEGIN CERTIFICATE-----\n\t-----END CERTIFICATE-----\n\nvim /etc/ssl/privatekey/nginx-selfsigned.key\n\t-----BEGIN PRIVATE KEY-----\n\t-----END PRIVATE KEY-----\n\nopenssl x509 -in nginx-selfsigned.crt -text -noout\nkeytool -printcert -file /etc/ssl/certs/nginx-selfsigned.crt\n\n检查crt跟private key是否匹配：\nopenssl x509 -noout -modulus -in test.crt | openssl md5\nopenssl rsa -noout -modulus -in test.key | openssl md5\n两者输出的 Modulus 应该一致（RSA素数乘积，用来生成key pair）\n------------------------------------------------------------\n--- use keytool 带密码\n------------------------------------------------------------\n-- Generate a Java keystore and key pair\nkeytool -genkey -alias mydomain -keyalg RSA -keystore keystore.jks  -keysize 2048\n-- Generate a certificate signing request (CSR) for an existing Java keystore\nkeytool -certreq -alias mydomain -keystore keystore.jks -file mydomain.csr\n-- Import a root or intermediate CA certificate to an existing Java keystore\nkeytool -import -trustcacerts -alias root -file Thawte.crt -keystore keystore.jks\n-- Import a signed primary certificate to an existing Java keystore\nkeytool -import -trustcacerts -alias mydomain -file mydomain.crt -keystore keystore.jks\n-- Generate a keystore and self-signed certificate\nkeytool -genkey -keyalg RSA -alias selfsigned -keystore keystore.jks -storepass password -validity 360 -keysize 2048\n-- Export a certificate from a keystore\nkeytool -export -alias selfsigned -file selfsigned.crt -keystore keystore.jks\n\nkeytool -genkey -alias secure_netty -keysize 2048 -validity 365 -keyalg RSA -dname "CN=localhost" -keypass 123456 -storepass 123456 -keystore selfsigned.jks\nkeytool -export -alias secure_netty -keystore selfsigned.jks -storepass 123456 -file selfsigned.cer\n\n\nkeytool -genkey -alias secure_tomcat -keysize 1024 -validity 365 -keyalg RSA -keypass 123456 -storepass 123456 -keystore selfsigned.keystore \nkeytool -list -v -keystore selfsigned.keystore\n\t打印信息包含 Entry type: PrivateKeyEntry\nkeytool -export -alias secure_tomcat -keystore selfsigned.keystore -file selfsigned.cer\n\nexample:\njava import self-signed certificate\nkeytool.exe -import -trustcacerts -keystore ../lib/security/cacerts  -storepass changeit -noprompt -alias myownaliasformysystem -file "\\saved-certs\\ca.cert"\nhttps://stackoverflow.com/questions/11617210/how-to-properly-import-a-selfsigned-certificate-into-java-keystore-that-is-avail\n\ntomcat:\nhttps://support.microfocus.com/kb/doc.php?id=7022204\n')])])]),a("h3",{attrs:{id:"三方免费证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三方免费证书"}},[e._v("#")]),e._v(" 三方免费证书")]),e._v(" "),a("h4",{attrs:{id:"let-s-encrypt"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#let-s-encrypt"}},[e._v("#")]),e._v(" let's encrypt")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('//自动化工具\nwget https://dl.eff.org/certbot-auto\nchmod a+x certbot-auto\n./certbot-auto certonly --standalone -d  www.demoProject.com   # www.demoProject.com为你想要配置https的域名\nls /etc/letsencrypt/live/\n\n//证书定时自动更新\ncrontab -e    #编辑crontab\n30 2 * * 1 /root/certbot-auto renew --pre-hook "systemctl stop nginx" --post-hook "systemctl start nginx" >> /var/log/le-renew.log 2>&1 &\nroot/certbot-auto renew --pre-hook "systemctl stop nginx" --post-hook "systemctl start nginx"\n\n')])])]),a("h4",{attrs:{id:"cloudflare-dns解析提供商免费证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cloudflare-dns解析提供商免费证书"}},[e._v("#")]),e._v(" cloudflare dns解析提供商免费证书")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://www.cloudflare.com/learning/dns/dns-over-tls/",target:"_blank",rel:"noopener noreferrer"}},[e._v("cloudflare比较特殊，它提供给了所谓 dns over tls，添加网站到cloudflare并且替换域名商的dns解析为cloudflare之后，dns的解析会被云朵点亮代表收到cloudflare保护"),a("OutboundLink")],1),e._v("；\n"),a("a",{attrs:{href:"#%E6%A1%88%E4%BE%8B-use-case-2-client-cdn-server"}},[e._v("然后cloudflare提供了几种加密模式，具体参考下面")])]),e._v(" "),a("h2",{attrs:{id:"supporting-https"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#supporting-https"}},[e._v("#")]),e._v(" Supporting https")]),e._v(" "),a("h3",{attrs:{id:"browser"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#browser"}},[e._v("#")]),e._v(" browser")]),e._v(" "),a("p",[e._v("浏览器自然是全面支持https的，不过不同浏览器的特性不同，比如")]),e._v(" "),a("p",[e._v("chrome是采用了操作系统本身的CA证书链，")]),e._v(" "),a("p",[e._v("而firefox是有完整自己的一套证书，所以对于渗透测试者来说，firefox是首选，因为不需要改变操作系统本身的证书，只需要安装给firefox本身就行了，当然firefox还有个特性是支持proxy，chrome还得装插件才行；")]),e._v(" "),a("p",[e._v("注意：如果是自签证书，浏览器会提示，可以手动信任，之后就可以正常访问，但是下面的js http client则不同")]),e._v(" "),a("p",[e._v("访问后端的时候需要注意cors也就是same origin的问题，比如reactjs项目本地测试默认开启nodejs服务：http://localhost:3000，这样访问后端服务，如果后端服务没有设置allow origin，因为后端服务端口一般不会刚好是3000，如果是其他端口，即使也是localhost服务，因为端口不同，不属于same origin，无法请求")]),e._v(" "),a("h3",{attrs:{id:"js-http-client"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#js-http-client"}},[e._v("#")]),e._v(" js http client")]),e._v(" "),a("p",[e._v("注意：跟上面不同的是，这里是没有用户交互的，而是js代码自动请求到后端，如果是自签证书，浏览器是不信任的，解决办法就是想办法手动从浏览器地址栏访问一次后端，然后手动加信任，之后应该就可以了，或者另外一种方式是")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("import axios from 'axios'\nimport https from 'https'\nconst result = await axios.post(\n    `https://${url}/login`,\n    body,\n    {\n      httpsAgent: new https.Agent({\n        rejectUnauthorized: false\n      })\n    }\n  )\n")])])]),a("p",[e._v("这样会完全忽略证书验证，不太好，所以更好的方法是：")]),e._v(" "),a("p",[e._v("https://stackoverflow.com/questions/51363855/how-to-configure-axios-to-use-ssl-certificate")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("const httpsAgent = new https.Agent({ ca: MY_CA_BUNDLE });\n")])])]),a("h3",{attrs:{id:"nginx"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx"}},[e._v("#")]),e._v(" nginx")]),e._v(" "),a("p",[e._v("refer to 《buildingblock/nginx.md》")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("\nnginx.conf:\n server {\n        listen       80;\n        listen 443 ssl;\n        listen [::]:443 ssl;\n        server_name  localhost;\n\n        ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;\n        ssl_certificate_key /etc/ssl/privatekey/nginx-selfsigned.key;\n        ssl_dhparam /etc/ssl/certs/dhparam.pem;\n")])])]),a("h3",{attrs:{id:"jdk-java-client"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jdk-java-client"}},[e._v("#")]),e._v(" jdk java client")]),e._v(" "),a("p",[e._v("Cacerts are default Trust store provided by every JVM vendor. We will see this cacerts file under JRE/lib/security folder.")]),e._v(" "),a("p",[e._v("如果不导入证书输出错误：\ntrustAnchors parameter must be non-empty\nor\njavax.net.ssl.SSLHandshakeException: java.security.cert.CertificateException: No name matching found")]),e._v(" "),a("p",[e._v("keystore 默认密码 changeit")]),e._v(" "),a("p",[e._v("查看/验证")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('C:\\Program Files\\Java\\jdk1.8.0_231\\bin\n\nC:\\Program Files\\Java\\jdk1.8.0_231\\jre\\lib\\security\\cacerts\n\n\nC:\\WINDOWS\\system32>keytool.exe -list -v -keystore "C:\\Program Files\\Java\\jdk1.8.0_231\\jre\\lib\\security\\cacerts"\nEnter keystore password:\nKeystore type: JKS\nKeystore provider: SUN\n\nYour keystore contains XX entries\n\nAlias name: verisignclass2g2ca [jdk]\nCreation date: 25 Aug 2016\nEntry type: trustedCertEntry\n\nOwner: OU=VeriSign Trust Network, OU="(c) 1998 VeriSign, Inc. - For authorized use only", OU=Class 2 Public Primary Certification Authority - G2, O="VeriSign, Inc.", C=US\nIssuer: OU=VeriSign Trust Network, OU="(c) 1998 VeriSign, Inc. - For authorized use only", OU=Class 2 Public Primary Certification Authority - G2, O="VeriSign, Inc.", C=US\nSerial number: b92f60cc889fa17a4609b85b706c8aaf\nValid from: Mon May 18 08:00:00 SRET 1998 until: Wed Aug 02 07:59:59 SRET 2028\nCertificate fingerprints:\nSignature algorithm name: SHA1withRSA\nSubject Public Key Algorithm: 1024-bit RSA key\nVersion: 1\n\n\n*******************************************\n*******************************************\n\n\nAlias name: test-selfsigned\nCreation date: 25 Oct 2022\nEntry type: trustedCertEntry\n\nOwner: CN=test.local, OU=LYHISTORY, O=LYHISTORY, L=SG, ST=SG, C=SG\nIssuer: CN=test.local, OU=LYHISTORY, O=LYHISTORY, L=SG, ST=SG, C=SG\nSerial number: c79bfcff9e2a5aa77fd103e685f650a825346b9\nValid from: Tue Oct 18 10:50:58 SRET 2022 until: Fri Oct 15 10:50:58 SRET 2032\nCertificate fingerprints:\n         \nSignature algorithm name: SHA256withRSA\nSubject Public Key Algorithm: 2048-bit RSA key\nVersion: 3\n\n')])])]),a("p",[e._v("导入")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('C:\\Program Files\\Java\\jdk1.8.0_231\\bin>keytool.exe -importcert -file test-selfsigned.crt -keystore "C:\\Program Files\\Java\\jdk1.8.0_231\\jre\\lib\\security\\cacerts" -alias "test-selfsigned"\nEnter keystore password:\nOwner: CN=test.local, OU=LYHISTORY, O=LYHISTORY, L=SG, ST=SG, C=SG\nIssuer: CN=test.local, OU=LYHISTORY, O=LYHISTORY, L=SG, ST=SG, C=SG\nSerial number: c79bfcff9e2a5aa77fd103e685f650a825346b9\nValid from: Tue Oct 18 10:50:58 SGT 2022 until: Fri Oct 15 10:50:58 SGT 2032\nCertificate fingerprints:\n\nSignature algorithm name: SHA256withRSA\nSubject Public Key Algorithm: 2048-bit RSA key\nVersion: 3\n\nExtensions:\n\nTrust this certificate? [no]:  yes\nCertificate was added to keystore\n\n')])])]),a("h3",{attrs:{id:"springboot-mvc"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#springboot-mvc"}},[e._v("#")]),e._v(" springboot mvc")]),e._v(" "),a("p",[e._v("首先MVC有自己的端口比如10001，内置的tomcat默认的http端口是8080，")]),e._v(" "),a("p",[e._v("所有请求到spring mvc这个后台的都是通过 http://IP:10001 过来的，然后内部再交由tomcat 8080端口处理，")]),e._v(" "),a("p",[e._v("如果设置https比如8443，如下：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('yml：\n#debug: true\nserver:\n  servlet:\n    context-path: /test\n  port:\n    10001\n  ssl:\n    key-store: selfsigned.keystore\n    key-store-password: 123456\n    keyStoreType: JKS\n    keyAlias: secure_tomcat\n    \n@EnableAsync\n@SpringBootApplication\npublic class Application {\n    public static void main(String[] args) {\n        SpringApplication.run(Application.class, args);\n    }\n\n    @Bean\n    public RestTemplate restTemplate() {\n        return new RestTemplate();\n    }\n\n    /**\n     * http重定向到https\n     * @return\n     */\n    @Bean\n    public TomcatServletWebServerFactory servletContainer() {\n        TomcatServletWebServerFactory tomcat = new TomcatServletWebServerFactory() {\n            @Override\n            protected void postProcessContext(Context context) {\n                SecurityConstraint constraint = new SecurityConstraint();\n                constraint.setUserConstraint("CONFIDENTIAL");\n                SecurityCollection collection = new SecurityCollection();\n                collection.addPattern("/*");\n                constraint.addCollection(collection);\n                context.addConstraint(constraint);\n            }\n        };\n        //这里tomcat.getPort拿到的就是8080\n        tomcat.addAdditionalTomcatConnectors(httpConnector(tomcat.getPort()));\n        return tomcat;\n    }\n\n    @Bean\n    public Connector httpConnector(int port) {\n        Connector connector = new Connector("org.apache.coyote.http11.Http11NioProtocol");\n        connector.setScheme("http");\n        //Connector监听的http的端口号\n        connector.setPort(port);\n        connector.setSecure(false);\n        //监听到http的端口号后转向到的https的端口号\n        connector.setRedirectPort(8443);\n        return connector;\n    }\n}\n\n')])])]),a("p",[e._v("注意到上面server本身就监听10001（应该是内置tomcat监听），然后为了https，需要创建tomcatfatory又出现一个http端口8080，为什么不可以直接扩展或override postProcessContext方法，可能是跟整个spring mvc的生命周期启动过程相关：")]),e._v(" "),a("p",[e._v("https://zhuanlan.zhihu.com/p/81807865")]),e._v(" "),a("h3",{attrs:{id:"netty"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#netty"}},[e._v("#")]),e._v(" netty")]),e._v(" "),a("p",[e._v("https://blog.csdn.net/invadersf/article/details/80337380")]),e._v(" "),a("p",[e._v("https://www.cnblogs.com/zhjh256/p/6488668.html")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('import io.netty.handler.ssl.SslHandler;\npublic class SslChannelInitializer extends ChannelInitializer<Channel> {\n    private final SslContext context;\n\n    public SslChannelInitializer(SslContext context) { \n        this.context = context;\n    }\n\n    @Override\n    protected void initChannel(Channel ch) throws Exception {\n        SSLEngine engine = context.newEngine(ch.alloc());\n        engine.setUseClientMode(false);\n        ch.pipeline().addFirst("ssl", new SslHandler(engine));\n        ChannelPipeline pipeline = ch.pipeline(); \n        pipeline.addLast("frameDecoder", new LengthFieldBasedFrameDecoder(Integer.MAX_VALUE, 0, 4, 0, 4));  \n        pipeline.addLast("frameEncoder", new LengthFieldPrepender(4));                \n        pipeline.addLast("decoder", new StringDecoder(Charset.forName("UTF-8")));  \n        pipeline.addLast("encoder", new StringEncoder(Charset.forName("UTF-8")));  \n        pipeline.addLast("spiderServerBusiHandler", new SpiderServerBusiHandler());\n    }\n}\n\nbossGroup = new NioEventLoopGroup(1);\nworkerGroup = new NioEventLoopGroup(WORKER_GROUP_SIZE);\nchannelClass = NioServerSocketChannel.class;\nlogger.info("workerGroup size:" + WORKER_GROUP_SIZE);\nlogger.info("preparing to start spider server...");\nb.group(bossGroup, workerGroup);  \nb.channel(channelClass);\nKeyManagerFactory keyManagerFactory = null;\nKeyStore keyStore = KeyStore.getInstance("JKS");\nkeyStore.load(new FileInputStream("selfsigned.jks"), "sNetty".toCharArray());\nkeyManagerFactory = KeyManagerFactory.getInstance("SunX509");\nkeyManagerFactory.init(keyStore,"123456".toCharArray());\nSslContext sslContext = SslContextBuilder.forServer(keyManagerFactory).build();\nb.childHandler(new SslChannelInitializer(sslContext)); \n')])])]),a("h2",{attrs:{id:"案例-use-case-1-client-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#案例-use-case-1-client-server"}},[e._v("#")]),e._v(" 案例 Use Case 1: client-server")]),e._v(" "),a("p",[e._v("这里的client就是浏览器或手机端，")]),e._v(" "),a("p",[e._v("这里的server指的是前后端代码集成一起的后端服务，")]),e._v(" "),a("p",[e._v("比较直白，只有两方参与，浏览器不需要什么设置，后端服务如果是self host则需要其本身实现https，比如spring mvc，如果不是self host，而是host在比如nginx或iis中，则需要对nginx或iis配置https支持即可；")]),e._v(" "),a("h2",{attrs:{id:"案例-use-case-2-client-cdn-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#案例-use-case-2-client-cdn-server"}},[e._v("#")]),e._v(" 案例 Use Case 2: client-cdn-server")]),e._v(" "),a("p",[e._v("example: 网站使用cloudflare的证书")]),e._v(" "),a("p",[e._v("Cloudflare 提供几种模式 Encryption modes：")]),e._v(" "),a("ul",[a("li",[e._v("flexible\nallows HTTPS connections between your visitor and Cloudflare, but all connections between Cloudflare and your origin are made through HTTP. As a result, an SSL certificate is not required on your origin.\n这种模式 server端无需配置tls")]),e._v(" "),a("li",[e._v("full\nCloudflare allows HTTPS connections between your visitor and Cloudflare and makes connections to the origin using the scheme requested by the visitor. If your visitor uses http, then Cloudflare connects to the origin using plaintext HTTP and vice versa.\n这种模式 server端可以配置\n"),a("ul",[a("li",[e._v("self-signed 自签证书")]),e._v(" "),a("li",[e._v("Cloudflare Origin CA,"),a("a",{attrs:{href:"https://community.cloudflare.com/t/https-certificate-not-trusted/3610/11",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cloudflare Origin Certificate 是一个只被 Cloudflare 信任的证书，不被浏览器所信任，所以使用「Cloudflare Origin Certificate」就必须在前面使用 Cloudflare 添加 DNS 记录时将云朵点亮，即 ☁ Proxied。如果不点亮云朵，您的网站将无法安全访问，同时代理也会无法正常连接。"),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("or purchased from a Certificate Authority)")])])]),e._v(" "),a("li",[e._v("full(strict)\nCloudflare does everything in Full mode but also enforces more stringent requirements for origin certificates.\n这种模式server端需要使用cloudflare认可的证书：\n"),a("ul",[a("li",[e._v("Issued by a "),a("a",{attrs:{href:"https://github.com/cloudflare/cfssl_trust",target:"_blank",rel:"noopener noreferrer"}},[e._v("publicly trusted certificate authority "),a("OutboundLink")],1)]),e._v(" "),a("li",[e._v("or "),a("a",{attrs:{href:"https://developers.cloudflare.com/ssl/origin-configuration/origin-ca/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Cloudflare’s Origin CA, The “Cloudflare Origin Certificate” is a certificate that is only trusted by Cloudflare, not by browsers."),a("OutboundLink")],1)])])])]),e._v(" "),a("h3",{attrs:{id:"配置例子-client-cloudflare-server-full-strict模式并开启authenticated-origin-pulls"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置例子-client-cloudflare-server-full-strict模式并开启authenticated-origin-pulls"}},[e._v("#")]),e._v(" 配置例子：client->cloudflare->server, full strict模式并开启authenticated origin pulls")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("Cloudflare’s Origin CA生成：\ncloudflare管理页面=>SSL/TLS=>Origin Server点击生成证书；\n保存证书至 /etc/ssl/cloudflare_cert.pem\n保存key至 /etc/ssl/cloudflare_key.pem")])]),e._v(" "),a("li",[a("p",[e._v("SSL/TLS 加密模式改为 Full (strict)")])]),e._v(" "),a("li",[a("p",[e._v("Edge Certificates=>Minimum TLS Version」改为「TLS 1.2」")])]),e._v(" "),a("li",[a("p",[e._v("Enable authenticated origin pulls\n如果在 Nginx 服务器上设置了「Authenticated Origin Pulls」，就可以确保它只接受来自 Cloudflare 服务器的请求，防止任何其他人直接连接到 Nginx 服务器,\ncloudflare管理页面=>SSL/TLS=>Origin Server,打开「Authenticated Origin Pulls」 。")]),e._v(" "),a("p",[e._v("然后"),a("a",{attrs:{href:"https://developers.cloudflare.com/ssl/origin-configuration/authenticated-origin-pull/set-up/zone-level/",target:"_blank",rel:"noopener noreferrer"}},[e._v("访问该页面"),a("OutboundLink")],1),e._v(",可以找到下载client证书链接:\n"),a("a",{attrs:{href:"https://developers.cloudflare.com/ssl/static/authenticated_origin_pull_ca.pem",target:"_blank",rel:"noopener noreferrer"}},[e._v("download authenticated_origin_pull_ca.pem"),a("OutboundLink")],1),e._v("\n将证书 authenticated_origin_pull_ca.pem 的内容写入到服务器的 /etc/ssl/cloudflare_client.crt 中")])]),e._v(" "),a("li",[a("p",[e._v("nginx 配置:")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('server {\n   listen 443 ssl http2;\n   listen [::]:443 ssl http2;\n\n   ssl_certificate /etc/ssl/cert.pem;\n   ssl_certificate_key /etc/ssl/key.pem;\n   ssl_client_certificate /etc/ssl/cloudflare_client.crt;\n   ssl_verify_client on;\n   ssl_session_timeout 1d;\n   ssl_session_cache shared:MozSSL:10m;  # about 40000 sessions\n   ssl_session_tickets off;\n\n   # intermediate configuration\n   ssl_protocols TLSv1.2 TLSv1.3;\n   ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;\n   ssl_prefer_server_ciphers off;\n\n   # HSTS (ngx_http_headers_module is required) (63072000 seconds)\n   add_header Strict-Transport-Security "max-age=63072000" always;\n')])])])])]),e._v(" "),a("h2",{attrs:{id:"案例-use-case-2-separated-frontend-backend前后端分离"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#案例-use-case-2-separated-frontend-backend前后端分离"}},[e._v("#")]),e._v(" 案例 Use Case 2: separated frontend/backend前后端分离")]),e._v(" "),a("p",[e._v("举例前后端分离项目：\n1.(user interact ) browser request nginx for frontend resource\ncreate self-signed cert and config nignx, so browser will talk to nginx through https (unsafe warning will be alert as it's self signed)")]),e._v(" "),a("p",[e._v("2.(no user interact) js codes will make http call to backend service to retrieve data through nginx, nginx forward http request to backend service\nbackend service has to implement and support https, and nginx also have to act as a https client to handshake with the backend service")]),e._v(" "),a("p",[e._v("3.(no user interact) js codes will connect to websocket server directly")]),e._v(" "),a("p",[e._v("假设前端项目用的是create-reactjs-app脚手架，npm run start会开启一个nodejs服务，如下")]),e._v(" "),a("p",[a("img",{attrs:{src:"/docs/docs_image/software/network/ssl_local_env01.png",alt:""}})]),e._v(" "),a("p",[e._v("这种情况下显然是不可行的，首先：")]),e._v(" "),a("p",[e._v("1.默认情况下，origin是https://127.0.0.1:3000，axios http client请求的host是 https://127.0.0.1:10001 ，会被same origin policy阻挡，")]),e._v(" "),a("p",[e._v("注意如果是"),a("code",[e._v("<img src=https://127.0.0.1:3000/verifycode")]),e._v(" 这种图片src的验证码是不会被block住的，因为img link script等标签不会受制于same origin policy")]),e._v(" "),a("p",[e._v("2.浏览器用户互动的部分请求到的host是nodejs，而非用户互动的axios请求到的host是spring mvc，因为开发环境肯定都是自签证书，即使给nodejs设置好了自签证书，浏览器第一次会提醒用户不安全，用户选择继续访问后浏览器则记住该证书，但是axios请求的是spring mvc程序的证书，跟nodejs一般是不同的，这种情况下就会有问题")]),e._v(" "),a("p",[e._v("1的一个解决办法是通过设置chrome浏览器，允许其跨域： https://segmentfault.com/a/1190000021711445")]),e._v(" "),a("p",[e._v("2的一个解决方法是nodejs跟spring mvc用相同的证书，或者手动给浏览器安装证书：https://qastack.cn/superuser/27268/how-do-i-disable-the-warning-chrome-gives-if-a-security-certificate-is-not-trusted")]),e._v(" "),a("p",[e._v("但是其实更完美的解决方法是加一个nginx，nginx作为proxy转发两者的流量到nodejs和springmvc，这样浏览器本身和其中的js代码axios http client只需要跟nginx进行handshake即可，而且origin和host都是test.local，不存在跨域问题，参考下面这张图：")]),e._v(" "),a("p",[a("img",{attrs:{src:"/docs/docs_image/software/network/ssl_local_env02.png",alt:""}})]),e._v(" "),a("p",[e._v("注意，关于websocket有两点：")]),e._v(" "),a("ol",[a("li",[a("p",[e._v("如果网站使用了https，默认必须使用wss，ws会被浏览器block住，另外注意到，这里前端跟nginx之间是使用wss的，nginx跟真正的服务端仍然是明文ws通信，这个很正常，本来nginx就是反向代理，客户端不需要直接跟被代理的服务端连接，所以实际上同理后端的服务也可以只用http跟nginx通信；")])]),e._v(" "),a("li",[a("p",[e._v("如果是本地测试 127.0.0.1，特别要小心，如图域名使用test.local会出现问题：provisional headers are shown")]),e._v(" "),a("p",[e._v("解决办法是，nginx将server_name改为localhost即可")])])]),e._v(" "),a("p",[e._v("而最终部署到服务器上则会简化，因为就不需要nodejs开发环境了：")]),e._v(" "),a("p",[a("img",{attrs:{src:"/docs/docs_image/software/network/ssl_product_env.png",alt:""}})]),e._v(" "),a("p",[e._v("测试完https后，想回去测试http，chrome经常会强制使用https，解决办法：")]),e._v(" "),a("p",[e._v("https://superuser.com/questions/565409/how-to-stop-an-automatic-redirect-from-http-to-https-in-chrome")]),e._v(" "),a("ol",[a("li",[e._v("Go to "),a("code",[e._v("chrome://net-internals/#hsts")]),e._v(". Enter "),a("em",[e._v("3rdrevolution.com")]),e._v(" under "),a("strong",[e._v("Delete domain security policies")]),e._v(" and press the Delete button.")]),e._v(" "),a("li",[e._v("Now go to "),a("code",[e._v("chrome://settings/clearBrowserData")]),e._v(", tick the box "),a("em",[e._v("Cached images and files")]),e._v(" and press click the button "),a("em",[e._v("Clear data")]),e._v(".")])]),e._v(" "),a("h2",{attrs:{id:"troubleshooting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[e._v("#")]),e._v(" Troubleshooting")]),e._v(" "),a("h3",{attrs:{id:"查看服务器支持的tls版本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看服务器支持的tls版本"}},[e._v("#")]),e._v(" 查看服务器支持的TLS版本")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("nmap -p 443 --script ssl-enum-ciphers <TARGET>\n\nopenssl s_client -host api.compass-ft.com -port 443\n")])])]),a("h3",{attrs:{id:"查看服务器支持的cipher-suite"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看服务器支持的cipher-suite"}},[e._v("#")]),e._v(" 查看服务器支持的cipher suite")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("To get a list of all cipher suites supported by your installation of OpenSSL, use the openssl command with the ciphers subcommand as follows:\n$ openssl ciphers -v 'ALL:COMPLEMENTOFALL'\nto only list suites that are defined as belonging to the HIGH group, use the following command:\n$ openssl ciphers -v 'HIGH'\n\n\nhttps://www.keyfactor.com/blog/cipher-suites-explained/\nTLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384\nKey Exchange - Authentication - Cipher(algorithm, strength, mode) - Hash or MAC\n")])])]),a("h3",{attrs:{id:"net-err-cert-common-name-invalid"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#net-err-cert-common-name-invalid"}},[e._v("#")]),e._v(" NET::ERR_CERT_COMMON_NAME_INVALID")]),e._v(" "),a("p",[e._v("如果是设置，基本就是域名跟证书不一致，比如证书中的：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("openssl x509 -noout -text -in test.crt\nSubject: CN = *.test.com\nnginx配置的server_name就需要是其子域名\n")])])]),a("p",[e._v("如果是访问其他网站遇到，可能是dns解析问题：")]),e._v(" "),a("p",[e._v("https://blog.csdn.net/zerooffdate/article/details/80513730")]),e._v(" "),a("h3",{attrs:{id:"ssl-ctx-use-privatekey-failed"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssl-ctx-use-privatekey-failed"}},[e._v("#")]),e._v(" SSL_CTX_use_PrivateKey failed")]),e._v(" "),a("p",[e._v("emerg] SSL_CTX_use_PrivateKey failed (SSL: error:0B080074:x509 certificate routines:X509_check_private_key:key values mismatch)")]),e._v(" "),a("p",[e._v("私钥和证书不匹配，验证")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("openssl x509 -noout -modulus -in certificate.crt | openssl md5\nopenssl rsa -noout -modulus -in privateKey.key | openssl md5\n")])])]),a("h3",{attrs:{id:"服务端cert过期导致handshake请求失败"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务端cert过期导致handshake请求失败"}},[e._v("#")]),e._v(" 服务端cert过期导致Handshake请求失败")]),e._v(" "),a("p",[e._v("sprintboot访问一个https的api遇到问题：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("2022-01-25 16:18:05.175 ^[[31mERROR^[[m ^[[35m30604GG^[[m [scheduling-1] ^[[36mc.a.m.f.u.HttpClientUtil^[[m : Get Exception Remote host closed connection during handshake\n\njavax.net.ssl.SSLHandshakeException: Remote host closed connection during handshake\n        at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:980)\n        at sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:1363)\n        at sun.security.ssl.SSLSocketImpl.writeRecord(SSLSocketImpl.java:735)\n        at sun.security.ssl.AppOutputStream.write(AppOutputStream.java:123)\n        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)\n        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)\n        at org.apache.commons.httpclient.HttpConnection.flushRequestOutputStream(HttpConnection.java:828)\n        at org.apache.commons.httpclient.HttpMethodBase.writeRequest(HttpMethodBase.java:2116)\n        at org.apache.commons.httpclient.HttpMethodBase.execute(HttpMethodBase.java:1096)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeWithRetry(HttpMethodDirector.java:398)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeMethod(HttpMethodDirector.java:171)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:397)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:323)\n        at com.lyhistory.middleware.test.util.HttpClientUtil.sendGet(HttpClientUtil.java:64)\n        at com.lyhistory.middleware.test.service.impl.CompassftServiceImpl.sendRequest(CompassftServiceImpl.java:25)\n        at com.lyhistory.middleware.test.job.CompassftJob.crawlData(CompassftJob.java:33)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:497)\n        at org.springframework.scheduling.support.ScheduledMethodRunnable.run(ScheduledMethodRunnable.java:84)\n        at org.springframework.scheduling.support.DelegatingErrorHandlingRunnable.run(DelegatingErrorHandlingRunnable.java:54)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.io.EOFException: SSL peer shut down incorrectly\n        at sun.security.ssl.InputRecord.read(InputRecord.java:505)\n        at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:961)\n        ... 28 more\n")])])]),a("p",[e._v("但是此前在另外一台服务器上测试没有问题，确定了浏览器访问该api没有问题，然后在这台机器上curl一下")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#curl https://api.compass-ft.com/v1/indexes/CCRTBTC/history?access_token=\ncurl: (60) The certificate issuer's certificate has expired.  Check your system date and time.\nMore details here: http://curl.haxx.se/docs/sslcerts.html\n\ncurl performs SSL certificate verification by default, using a \"bundle\"\n of Certificate Authority (CA) public keys (CA certs). If the default\n bundle file isn't adequate, you can specify an alternate file\n using the --cacert option.\nIf this HTTPS server uses a certificate signed by a CA represented in\n the bundle, the certificate verification probably failed due to a\n problem with the certificate (it might be expired, or the name might\n not match the domain name in the URL).\nIf you'd like to turn off curl's verification of the certificate, use\n the -k (or --insecure) option.\n")])])]),a("p",[e._v("说是证书过期，浏览器查看一下果然过期了几天，可能是浏览器不会那么频繁的验证，在此前另外一台装好的机器上curl没问题，估计是首次访问才验证，后续就验证了或者定期检查，")]),e._v(" "),a("p",[e._v("通知api提供商，提供商迅速更新了证书，浏览器看了下，确实更新了，postman也能访问，但是这台机器上仍然无法访问，curl也是一样的提示，")]),e._v(" "),a("p",[e._v("根据curl的提示查看")]),e._v(" "),a("p",[e._v("https://curl.se/docs/sslcerts.html")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("openssl s_client -showcerts -servername server -connect server:443 > cacert.pem")])]),e._v(" "),a("li",[e._v('type "quit", followed by the "ENTER" key')]),e._v(" "),a("li",[e._v('The certificate will have "BEGIN CERTIFICATE" and "END CERTIFICATE" markers.')]),e._v(" "),a("li",[e._v('If you want to see the data in the certificate, you can do: "openssl x509 -inform PEM -in certfile -text -out certdata" where certfile is the cert you extracted from logfile. Look in certdata.')])]),e._v(" "),a("p",[e._v("结合这个帖子 https://stackoverflow.com/questions/24992976/openssl-telling-certificate-has-expired-when-it-has-not")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("openssl s_client -showcerts -servername api.compass-ft.com -connect api.compass-ft.com:443\nCONNECTED(00000003)\ndepth=3 O = Digital Signature Trust Co., CN = DST Root CA X3\nverify error:num=10:certificate has expired\nnotAfter=Sep 30 14:01:15 2021 GMT\nverify return:0\n---\nCertificate chain\n 0 s:/CN=api.compass-ft.com\n   i:/C=US/O=Let's Encrypt/CN=R3\n-----BEGIN CERTIFICATE-----\n\n#openssl s_client -servername api.compass-ft.com -connect api.compass-ft.com:443\nCONNECTED(00000003)\ndepth=3 O = Digital Signature Trust Co., CN = DST Root CA X3\nverify error:num=10:certificate has expired\nnotAfter=Sep 30 14:01:15 2021 GMT\nverify return:0\n---\nCertificate chain\n 0 s:/CN=api.compass-ft.com\n   i:/C=US/O=Let's Encrypt/CN=R3\n 1 s:/C=US/O=Let's Encrypt/CN=R3\n   i:/C=US/O=Internet Security Research Group/CN=ISRG Root X1\n 2 s:/C=US/O=Internet Security Research Group/CN=ISRG Root X1\n   i:/O=Digital Signature Trust Co./CN=DST Root CA X3\n---\nServer certificate\n-----BEGIN CERTIFICATE-----\n\nopenssl s_client -servername api.compass-ft.com -connect api.compass-ft.com:443 2>/dev/null | openssl x509 -noout -dates\n")])])]),a("p",[e._v("又从浏览器观察了这三级的证书链，都是正常的，所以怀疑是os上的根证书链中哪个可能过期了但一直没更新！")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("]#find / -type d -name \"certs\"\n/etc/pki/CA/certs\n/etc/pki/tls/certs\n/etc/openldap/certs\n\n#openssl x509 -in ca-bundle.crt -text\n\nopenssl x509 -enddate -noout -in\n\n\n#curl -v https://api.compass-ft.com/v1/indexes/\n* About to connect() to api.compass-ft.com port 443 (#0)\n*   Trying 54.216.252.255...\n* Connected to api.compass-ft.com (54.216.252.255) port 443 (#0)\n* Initializing NSS with certpath: sql:/etc/pki/nssdb\n*   CAfile: /etc/pki/tls/certs/ca-bundle.crt\n  CApath: none\n* Server certificate:\n*       subject: CN=api.compass-ft.com\n*       start date: Dec 09 23:25:14 2021 GMT\n*       expire date: Mar 09 23:25:13 2022 GMT\n*       common name: api.compass-ft.com\n*       issuer: CN=R3,O=Let's Encrypt,C=US\n* NSS error -8162 (SEC_ERROR_EXPIRED_ISSUER_CERTIFICATE)\n* The certificate issuer's certificate has expired.  Check your system date and time.\n* Closing connection 0\ncurl: (60) The certificate issuer's certificate has expired.  Check your system date and time.\nMore details here: http://curl.haxx.se/docs/sslcerts.html\n\ncurl performs SSL certificate verification by default, using a \"bundle\"\n of Certificate Authority (CA) public keys (CA certs). If the default\n bundle file isn't adequate, you can specify an alternate file\n using the --cacert option.\nIf this HTTPS server uses a certificate signed by a CA represented in\n the bundle, the certificate verification probably failed due to a\n problem with the certificate (it might be expired, or the name might\n not match the domain name in the URL).\nIf you'd like to turn off curl's verification of the certificate, use\n the -k (or --insecure) option.\n\n")])])]),a("p",[e._v("搜索得知：")]),e._v(" "),a("p",[a("em",[e._v("For TLS certificates issued by Let’s Encrypt, the root certificate (DST Root CA X3) in the default chain expires on")]),e._v(" ***September 30, 2021***"),a("em",[e._v(".")])]),e._v(" "),a("p",[e._v("https://blog.devgenius.io/rhel-centos-7-fix-for-lets-encrypt-change-8af2de587fe4")]),e._v(" "),a("p",[e._v("插曲：开始还一度怀疑是不是os支持的tls Protocol跟api服务商支持的不同")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("openssl ciphers -v | awk '{print $2}' | sort | uniq\n")])])]),a("h3",{attrs:{id:"jdk版本bug导致handshake失败"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jdk版本bug导致handshake失败"}},[e._v("#")]),e._v(" jdk版本bug导致Handshake失败")]),e._v(" "),a("p",[e._v("跟前面一样dev上可以，生产上失败，错误输出也一样")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("2022-01-27 17:45:29.928 ^[[31mERROR^[[m ^[[35m25521GG^[[m [scheduling-1] ^[[36mc.a.m.f.u.HttpClientUtil^[[m : Get Exception Remote host closed connection during handshake\n\njavax.net.ssl.SSLHandshakeException: Remote host closed connection during handshake\n        at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:980)\n        at sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:1363)\n        at sun.security.ssl.SSLSocketImpl.writeRecord(SSLSocketImpl.java:735)\n        at sun.security.ssl.AppOutputStream.write(AppOutputStream.java:123)\n        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)\n        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)\n        at org.apache.commons.httpclient.HttpConnection.flushRequestOutputStream(HttpConnection.java:828)\n        at org.apache.commons.httpclient.HttpMethodBase.writeRequest(HttpMethodBase.java:2116)\n        at org.apache.commons.httpclient.HttpMethodBase.execute(HttpMethodBase.java:1096)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeWithRetry(HttpMethodDirector.java:398)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeMethod(HttpMethodDirector.java:171)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:397)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:323)\n        at com.lyhistory.middleware.test.util.HttpClientUtil.sendGet(HttpClientUtil.java:64)\n        at com.lyhistory.middleware.test.service.impl.CompassftServiceImpl.sendRequest(CompassftServiceImpl.java:25)\n        at com.lyhistory.middleware.test.job.CompassftJob.crawlData(CompassftJob.java:33)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:497)\n        at org.springframework.scheduling.support.ScheduledMethodRunnable.run(ScheduledMethodRunnable.java:84)\n        at org.springframework.scheduling.support.DelegatingErrorHandlingRunnable.run(DelegatingErrorHandlingRunnable.java:54)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.io.EOFException: SSL peer shut down incorrectly\n        at sun.security.ssl.InputRecord.read(InputRecord.java:505)\n        at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:961)\n        ... 28 more\n\n")])])]),a("p",[e._v("通过这个帖子的提示https://stackoverflow.com/questions/21245796/javax-net-ssl-sslhandshakeexception-remote-host-closed-connection-during-handsh")]),e._v(" "),a("h4",{attrs:{id:"进行debug输出更详细的handshake握手内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进行debug输出更详细的handshake握手内容"}},[e._v("#")]),e._v(" 进行debug输出更详细的handshake握手内容")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[root@sgtcs-mdw-v02 test-datasource]# java -jar -Djavax.net.debug=all test-datasource.jar\n2022-01-28 09:11:49,757 main INFO Log4j appears to be running in a Servlet environment, but there's no log4j-web module available. If you want better web container support, please add the log4j-web JAR to your web archive or server lib directory.\n2022-01-28 09:11:49,766 main INFO jar:file:/opt/test-datasource/test-datasource.jar!/BOOT-INF/classes!/log4j2.yml does not support dynamic reconfiguration\n\n  .   ____          _            __ _ _\n /\\\\ / ___'_ __ _ _(_)_ __  __ _ \\ \\ \\ \\\n( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\\n \\\\/  ___)| |_)| | | | | || (_| |  ) ) ) )\n  '  |____| .__|_| |_|_| |_\\__, | / / / /\n =========|_|==============|___/=/_/_/_/\n :: Spring Boot ::                (v2.4.5)\n\n2022-01-28 09:11:49.871  INFO 23127GG [kground-preinit] o.h.v.i.u.Version : HV000001: Hibernate Validator 6.1.7.Final\n2022-01-28 09:11:49.918  INFO 23127GG [main] o.s.b.StartupInfoLogger : Starting testMain v0.0.1-SNAPSHOT using Java 1.8.0_40 on sgtcs-mdw-v02 with PID 23127 (/opt/test-datasource/test-datasource.jar started by root in /opt/test-datasource)\n2022-01-28 09:11:49.926  INFO 23127GG [main] o.s.b.SpringApplication : The following profiles are active: datasource\n2022-01-28 09:11:51.084  INFO 23127GG [main] o.s.b.w.e.t.TomcatWebServer : Tomcat initialized with port(s): 10999 (http)\n2022-01-28 09:11:51.109  INFO 23127GG [main] o.a.j.l.DirectJDKLog : Initializing ProtocolHandler [\"http-nio-10999\"]\n2022-01-28 09:11:51.110  INFO 23127GG [main] o.a.j.l.DirectJDKLog : Starting service [Tomcat]\n2022-01-28 09:11:51.110  INFO 23127GG [main] o.a.j.l.DirectJDKLog : Starting Servlet engine: [Apache Tomcat/9.0.45]\n2022-01-28 09:11:51.170  INFO 23127GG [main] o.a.j.l.DirectJDKLog : Initializing Spring embedded WebApplicationContext\n2022-01-28 09:11:51.171  INFO 23127GG [main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1197 ms\n2022-01-28 09:11:51.658  INFO 23127GG [main] o.s.s.c.ExecutorConfigurationSupport : Initializing ExecutorService 'applicationTaskExecutor'\n2022-01-28 09:11:51.853  INFO 23127GG [main] o.s.s.c.ExecutorConfigurationSupport : Initializing ExecutorService 'taskScheduler'\n2022-01-28 09:11:51.884  INFO 23127GG [main] o.a.j.l.DirectJDKLog : Starting ProtocolHandler [\"http-nio-10999\"]\n2022-01-28 09:11:51.907  INFO 23127GG [main] o.s.b.w.e.t.TomcatWebServer : Tomcat started on port(s): 10999 (http) with context path '/middleware'\n2022-01-28 09:11:51.922  INFO 23127GG [scheduling-1] c.a.m.f.j.CompassftJob : CompassftJob crawlData, start time is 09:11:51\n2022-01-28 09:11:51.924  INFO 23127GG [main] o.s.b.StartupInfoLogger : Started testMain in 2.449 seconds (JVM running for 3.494)\nkeyStore is :\nkeyStore type is : jks\nkeyStore provider is :\ninit keystore\ninit keymanager of type SunX509\ntrustStore is: /apps/3rd-party/java-se-8u40-ri/jre/lib/security/cacerts\ntrustStore type is : jks\ntrustStore provider is :\ninit truststore\ntrigger seeding of SecureRandom\ndone seeding SecureRandom\nIgnoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_GCM_SHA384\nIgnoring unavailable cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA\nIgnoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\nIgnoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA\nIgnoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\nIgnoring unavailable cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA256\nIgnoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA\nIgnoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\nIgnoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384\nIgnoring unavailable cipher suite: TLS_RSA_WITH_AES_256_GCM_SHA384\nIgnoring unavailable cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384\nIgnoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384\nIgnoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA\nIgnoring unavailable cipher suite: TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\nIgnoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384\nIgnoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA256\nIgnoring unavailable cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA\nIgnoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA256\nIgnoring unavailable cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA\nIgnoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA\nIgnoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\nAllow unsafe renegotiation: false\nAllow legacy hello messages: true\nIs initial handshake: true\nIs secure renegotiation: false\nscheduling-1, setSoTimeout(0) called\nscheduling-1, setSoTimeout(60000) called\nIgnoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_RSA_WITH_AES_128_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_128_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 for TLSv1.1\n%% No cached client session\n*** ClientHello, TLSv1.2\nRandomCookie:  GMT: 1626554840 bytes = { 233, 246, 57, 123, 111, 81, 50, 152, 19, 185, 227, 133, 240, 86, 55, 133, 151, 4, 29, 231, 232, 156, 23, 144, 11, 15, 125, 61 }\nSession ID:  {}\nCipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]\nCompression Methods:  { 0 }\nExtension elliptic_curves, curve names: {secp256r1, sect163k1, sect163r2, secp192r1, secp224r1, sect233k1, sect233r1, sect283k1, sect283r1, secp384r1, sect409k1, sect409r1, secp521r1, sect571k1, sect571r1, secp160k1, secp160r1, secp160r2, sect163r1, secp192k1, sect193r1, sect193r2, secp224k1, sect239k1, secp256k1}\nExtension ec_point_formats, formats: [uncompressed]\nExtension signature_algorithms, signature_algorithms: SHA512withECDSA, SHA512withRSA, SHA384withECDSA, SHA384withRSA, SHA256withECDSA, SHA256withRSA, SHA224withECDSA, SHA224withRSA, SHA1withECDSA, SHA1withRSA, SHA1withDSA, MD5withRSA\n***\n[write] MD5 and SHA1 hashes:  len = 207\n0000: 01 00 00 CB 03 03 61 F3   42 D8 E9 F6 39 7B 6F 51  ......a.B...9.oQ\n0010: 32 98 13 B9 E3 85 F0 56   37 85 97 04 1D E7 E8 9C  2......V7.......\n0020: 17 90 0B 0F 7D 3D 00 00   46 C0 23 C0 27 00 3C C0  .....=..F.#.'.<.\n0030: 25 C0 29 00 67 00 40 C0   09 C0 13 00 2F C0 04 C0  %.).g.@...../...\n0040: 0E 00 33 00 32 C0 2B C0   2F 00 9C C0 2D C0 31 00  ..3.2.+./...-.1.\n0050: 9E 00 A2 C0 08 C0 12 00   0A C0 03 C0 0D 00 16 00  ................\n0060: 13 C0 07 C0 11 00 05 C0   02 C0 0C 00 04 00 FF 01  ................\n0070: 00 00 5C 00 0A 00 34 00   32 00 17 00 01 00 03 00  ..\\...4.2.......\n0080: 13 00 15 00 06 00 07 00   09 00 0A 00 18 00 0B 00  ................\n0090: 0C 00 19 00 0D 00 0E 00   0F 00 10 00 11 00 02 00  ................\n00A0: 12 00 04 00 05 00 14 00   08 00 16 00 0B 00 02 01  ................\n00B0: 00 00 0D 00 1A 00 18 06   03 06 01 05 03 05 01 04  ................\n00C0: 03 04 01 03 03 03 01 02   03 02 01 02 02 01 01     ...............\nscheduling-1, WRITE: TLSv1.2 Handshake, length = 207\n[Raw write]: length = 212\n0000: 16 03 03 00 CF 01 00 00   CB 03 03 61 F3 42 D8 E9  ...........a.B..\n0010: F6 39 7B 6F 51 32 98 13   B9 E3 85 F0 56 37 85 97  .9.oQ2......V7..\n0020: 04 1D E7 E8 9C 17 90 0B   0F 7D 3D 00 00 46 C0 23  ..........=..F.#\n0030: C0 27 00 3C C0 25 C0 29   00 67 00 40 C0 09 C0 13  .'.<.%.).g.@....\n0040: 00 2F C0 04 C0 0E 00 33   00 32 C0 2B C0 2F 00 9C  ./.....3.2.+./..\n0050: C0 2D C0 31 00 9E 00 A2   C0 08 C0 12 00 0A C0 03  .-.1............\n0060: C0 0D 00 16 00 13 C0 07   C0 11 00 05 C0 02 C0 0C  ................\n0070: 00 04 00 FF 01 00 00 5C   00 0A 00 34 00 32 00 17  .......\\...4.2..\n0080: 00 01 00 03 00 13 00 15   00 06 00 07 00 09 00 0A  ................\n0090: 00 18 00 0B 00 0C 00 19   00 0D 00 0E 00 0F 00 10  ................\n00A0: 00 11 00 02 00 12 00 04   00 05 00 14 00 08 00 16  ................\n00B0: 00 0B 00 02 01 00 00 0D   00 1A 00 18 06 03 06 01  ................\n00C0: 05 03 05 01 04 03 04 01   03 03 03 01 02 03 02 01  ................\n00D0: 02 02 01 01                                        ....\nscheduling-1, received EOFException: error\nscheduling-1, handling exception: javax.net.ssl.SSLHandshakeException: Remote host closed connection during handshake\nscheduling-1, SEND TLSv1.2 ALERT:  fatal, description = handshake_failure\nscheduling-1, WRITE: TLSv1.2 Alert, length = 2\n[Raw write]: length = 7\n0000: 15 03 03 00 02 02 28                               ......(\nscheduling-1, called closeSocket()\nscheduling-1, called close()\nscheduling-1, called closeInternal(true)\nscheduling-1, called close()\nscheduling-1, called closeInternal(true)\nscheduling-1, called close()\nscheduling-1, called closeInternal(true)\n2022-01-28 09:11:52.563 ERROR 23127GG [scheduling-1] c.a.m.f.u.HttpClientUtil : Get Exception Remote host closed connection during handshake\n\njavax.net.ssl.SSLHandshakeException: Remote host closed connection during handshake\n        at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:980)\n        at sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:1363)\n        at sun.security.ssl.SSLSocketImpl.writeRecord(SSLSocketImpl.java:735)\n        at sun.security.ssl.AppOutputStream.write(AppOutputStream.java:123)\n        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82)\n        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140)\n        at org.apache.commons.httpclient.HttpConnection.flushRequestOutputStream(HttpConnection.java:828)\n        at org.apache.commons.httpclient.HttpMethodBase.writeRequest(HttpMethodBase.java:2116)\n        at org.apache.commons.httpclient.HttpMethodBase.execute(HttpMethodBase.java:1096)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeWithRetry(HttpMethodDirector.java:398)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeMethod(HttpMethodDirector.java:171)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:397)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:323)\n        at com.lyhistory.middleware.test.util.HttpClientUtil.sendGet(HttpClientUtil.java:64)\n        at com.lyhistory.middleware.test.service.impl.CompassftServiceImpl.sendRequest(CompassftServiceImpl.java:25)\n        at com.lyhistory.middleware.test.job.CompassftJob.crawlData(CompassftJob.java:33)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:497)\n        at org.springframework.scheduling.support.ScheduledMethodRunnable.run(ScheduledMethodRunnable.java:84)\n        at org.springframework.scheduling.support.DelegatingErrorHandlingRunnable.run(DelegatingErrorHandlingRunnable.java:54)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:308)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:180)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:294)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.io.EOFException: SSL peer shut down incorrectly\n        at sun.security.ssl.InputRecord.read(InputRecord.java:505)\n        at sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:961)\n        ... 28 more\n\n2022-01-28 09:11:52.565  WARN 23127GG [scheduling-1] c.a.m.f.s.i.CompassftServiceImpl : Failed http request to https://api.compass-ft.com/v1/indexes/CCRTBTC/history?access_token=\n2022-01-28 09:11:52.565  INFO 23127GG [scheduling-1] c.a.m.f.j.CompassftJob : CompassftJob crawlData, end time is 09:11:52\n^C2022-01-28 09:11:57.032  INFO 23127GG [extShutdownHook] o.s.s.c.ExecutorConfigurationSupport : Shutting down ExecutorService 'taskScheduler'\n2022-01-28 09:11:57.033  INFO 23127GG [extShutdownHook] o.s.s.c.ExecutorConfigurationSupport : Shutting down ExecutorService 'applicationTaskExecutor'\n2022-01-28 09:11:57.034  INFO 23127GG [extShutdownHook] c.a.d.p.DruidDataSource : {dataSource-0} closing ...\n\n")])])]),a("h4",{attrs:{id:"对比下dev环境成功的输出"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对比下dev环境成功的输出"}},[e._v("#")]),e._v(" 对比下dev环境成功的输出")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("[root@os-node3 test-datasource]# java -jar -Djavax.net.debug=all test-datasource.jar\n2022-01-28 10:45:45,321 main INFO Log4j appears to be running in a Servlet environment, but there's no log4j-web module available. If you want better web container support, please add the log4j-web JAR to your web archive or server lib directory.\n2022-01-28 10:45:45,337 main INFO jar:file:/opt/test-datasource/test-datasource.jar!/BOOT-INF/classes!/log4j2.yml does not support dynamic reconfiguration\n\n  .   ____          _            __ _ _\n /\\\\ / ___'_ __ _ _(_)_ __  __ _ \\ \\ \\ \\\n( ( )\\___ | '_ | '_| | '_ \\/ _` | \\ \\ \\ \\\n \\\\/  ___)| |_)| | | | | || (_| |  ) ) ) )\n  '  |____| .__|_| |_|_| |_\\__, | / / / /\n =========|_|==============|___/=/_/_/_/\n :: Spring Boot ::                (v2.4.5)\n\n2022-01-28 10:45:45.398  INFO 7939GG [kground-preinit] o.h.v.i.u.Version : HV000001: Hibernate Validator 6.1.7.Final\n2022-01-28 10:45:45.449  INFO 7939GG [main] o.s.b.StartupInfoLogger : Starting testMain v0.0.1-SNAPSHOT using Java 1.8.0_191 on os-node3 with PID 7939 (/opt/test-datasource/test-datasource.jar started by root in /opt/test-datasource)\n2022-01-28 10:45:45.453  INFO 7939GG [main] o.s.b.SpringApplication : The following profiles are active: datasource\n2022-01-28 10:45:46.738  INFO 7939GG [main] o.s.b.w.e.t.TomcatWebServer : Tomcat initialized with port(s): 10999 (http)\n2022-01-28 10:45:46.759  INFO 7939GG [main] o.a.j.l.DirectJDKLog : Initializing ProtocolHandler [\"http-nio-10999\"]\n2022-01-28 10:45:46.759  INFO 7939GG [main] o.a.j.l.DirectJDKLog : Starting service [Tomcat]\n2022-01-28 10:45:46.760  INFO 7939GG [main] o.a.j.l.DirectJDKLog : Starting Servlet engine: [Apache Tomcat/9.0.45]\n2022-01-28 10:45:46.814  INFO 7939GG [main] o.a.j.l.DirectJDKLog : Initializing Spring embedded WebApplicationContext\n2022-01-28 10:45:46.815  INFO 7939GG [main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1311 ms\n2022-01-28 10:45:47.171  INFO 7939GG [main] o.s.s.c.ExecutorConfigurationSupport : Initializing ExecutorService 'applicationTaskExecutor'\n2022-01-28 10:45:47.355  INFO 7939GG [main] o.s.s.c.ExecutorConfigurationSupport : Initializing ExecutorService 'taskScheduler'\n2022-01-28 10:45:47.383  INFO 7939GG [main] o.a.j.l.DirectJDKLog : Starting ProtocolHandler [\"http-nio-10999\"]\n2022-01-28 10:45:47.402  INFO 7939GG [main] o.s.b.w.e.t.TomcatWebServer : Tomcat started on port(s): 10999 (http) with context path '/middleware'\n2022-01-28 10:45:47.414  INFO 7939GG [scheduling-1] c.a.m.f.j.CompassftJob : CompassftJob crawlData, start time is 10:45:47\n2022-01-28 10:45:47.417  INFO 7939GG [main] o.s.b.StartupInfoLogger : Started testMain in 2.496 seconds (JVM running for 8.733)\n\nadding as trusted cert:\n  ....................\n\nkeyStore is : \nkeyStore type is : jks\nkeyStore provider is : \ninit keystore\ninit keymanager of type SunX509\ntrigger seeding of SecureRandom\ndone seeding SecureRandom\nAllow unsafe renegotiation: false\nAllow legacy hello messages: true\nIs initial handshake: true\nIs secure renegotiation: false\nscheduling-1, setSoTimeout(0) called\nscheduling-1, setSoTimeout(60000) called\nIgnoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384 for TLSv1\nIgnoring unsupported cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384 for TLSv1\nIgnoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA256 for TLSv1\nIgnoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_RSA_WITH_AES_256_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_DHE_RSA_WITH_AES_256_CBC_SHA256 for TLSv1.1\nIgnoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_256_CBC_SHA256 for TLSv1.1\n%% No cached client session\nupdate handshake state: client_hello[1]\nupcoming handshake states: server_hello[2]\n*** ClientHello, TLSv1.2\nRandomCookie:  GMT: 1626560475 bytes = { 112, 239, 236, 239, 122, 212, 244, 10, 144, 127, 175, 230, 81, 156, 57, 128, 83, 111, 76, 99, 217, 111, 179, 84, 241, 81, 103, 94 }\nSession ID:  {}\nCipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_RSA_WITH_AES_256_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384, TLS_DHE_RSA_WITH_AES_256_CBC_SHA256, TLS_DHE_DSS_WITH_AES_256_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_DSS_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384, TLS_DHE_RSA_WITH_AES_256_GCM_SHA384, TLS_DHE_DSS_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]\nCompression Methods:  { 0 }\nExtension elliptic_curves, curve names: {secp256r1, secp384r1, secp521r1}\nExtension ec_point_formats, formats: [uncompressed]\nExtension signature_algorithms, signature_algorithms: SHA512withECDSA, SHA512withRSA, SHA384withECDSA, SHA384withRSA, SHA256withECDSA, SHA256withRSA, SHA256withDSA, SHA224withECDSA, SHA224withRSA, SHA224withDSA, SHA1withECDSA, SHA1withRSA, SHA1withDSA\nExtension extended_master_secret\nExtension server_name, server_name: [type=host_name (0), value=api.compass-ft.com]\n***\n[write] MD5 and SHA1 hashes:  len = 212\n0000: 01 00 00 D0 03 03 61 F3   58 DB 70 EF EC EF 7A D4  ......a.X.p...z.\n0010: F4 0A 90 7F AF E6 51 9C   39 80 53 6F 4C 63 D9 6F  ......Q.9.SoLc.o\n0020: B3 54 F1 51 67 5E 00 00   56 C0 24 C0 28 00 3D C0  .T.Qg^..V.$.(.=.\n0030: 26 C0 2A 00 6B 00 6A C0   0A C0 14 00 35 C0 05 C0  &.*.k.j.....5...\n0040: 0F 00 39 00 38 C0 23 C0   27 00 3C C0 25 C0 29 00  ..9.8.#.'.<.%.).\n0050: 67 00 40 C0 09 C0 13 00   2F C0 04 C0 0E 00 33 00  g.@...../.....3.\n0060: 32 C0 2C C0 2B C0 30 00   9D C0 2E C0 32 00 9F 00  2.,.+.0.....2...\n0070: A3 C0 2F 00 9C C0 2D C0   31 00 9E 00 A2 00 FF 01  ../...-.1.......\n0080: 00 00 51 00 0A 00 08 00   06 00 17 00 18 00 19 00  ..Q.............\n0090: 0B 00 02 01 00 00 0D 00   1C 00 1A 06 03 06 01 05  ................\n00A0: 03 05 01 04 03 04 01 04   02 03 03 03 01 03 02 02  ................\n00B0: 03 02 01 02 02 00 17 00   00 00 00 00 17 00 15 00  ................\n00C0: 00 12 61 70 69 2E 63 6F   6D 70 61 73 73 2D 66 74  ..api.compass-ft\n00D0: 2E 63 6F 6D                                        .com\nscheduling-1, WRITE: TLSv1.2 Handshake, length = 212\n[Raw write]: length = 217\n0000: 16 03 03 00 D4 01 00 00   D0 03 03 61 F3 58 DB 70  ...........a.X.p\n0010: EF EC EF 7A D4 F4 0A 90   7F AF E6 51 9C 39 80 53  ...z.......Q.9.S\n0020: 6F 4C 63 D9 6F B3 54 F1   51 67 5E 00 00 56 C0 24  oLc.o.T.Qg^..V.$\n0030: C0 28 00 3D C0 26 C0 2A   00 6B 00 6A C0 0A C0 14  .(.=.&.*.k.j....\n0040: 00 35 C0 05 C0 0F 00 39   00 38 C0 23 C0 27 00 3C  .5.....9.8.#.'.<\n0050: C0 25 C0 29 00 67 00 40   C0 09 C0 13 00 2F C0 04  .%.).g.@...../..\n0060: C0 0E 00 33 00 32 C0 2C   C0 2B C0 30 00 9D C0 2E  ...3.2.,.+.0....\n0070: C0 32 00 9F 00 A3 C0 2F   00 9C C0 2D C0 31 00 9E  .2...../...-.1..\n0080: 00 A2 00 FF 01 00 00 51   00 0A 00 08 00 06 00 17  .......Q........\n0090: 00 18 00 19 00 0B 00 02   01 00 00 0D 00 1C 00 1A  ................\n00A0: 06 03 06 01 05 03 05 01   04 03 04 01 04 02 03 03  ................\n00B0: 03 01 03 02 02 03 02 01   02 02 00 17 00 00 00 00  ................\n00C0: 00 17 00 15 00 00 12 61   70 69 2E 63 6F 6D 70 61  .......api.compa\n00D0: 73 73 2D 66 74 2E 63 6F   6D                       ss-ft.com\n[Raw read]: length = 5\n0000: 16 03 03 00 37                                     ....7\n[Raw read]: length = 55\n0000: 02 00 00 33 03 03 94 62   C2 45 AD 7F 63 B8 F6 7C  ...3...b.E..c...\n0010: D4 D5 7A A7 89 AE AB FD   F0 82 F9 22 21 15 44 4F  ..z........\"!.DO\n0020: 57 4E 47 52 44 01 00 C0   2F 00 00 0B FF 01 00 01  WNGRD.../.......\n0030: 00 00 0B 00 02 01 00                               .......\nscheduling-1, READ: TLSv1.2 Handshake, length = 55\ncheck handshake state: server_hello[2]\n*** ServerHello, TLSv1.2\nRandomCookie:  GMT: -1805532603 bytes = { 173, 127, 99, 184, 246, 124, 212, 213, 122, 167, 137, 174, 171, 253, 240, 130, 249, 34, 33, 21, 68, 79, 87, 78, 71, 82, 68, 1 }\nSession ID:  {}\n")])])]),a("h4",{attrs:{id:"注意到"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意到"}},[e._v("#")]),e._v(" 注意到")]),e._v(" "),a("p",[e._v("生产上（失败）：")]),e._v(" "),a("p",[e._v("trustStore is: /apps/3rd-party/java-se-8u40-ri/jre/lib/security/cacerts")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]\n")])])]),a("p",[e._v("dev上（成功）：")]),e._v(" "),a("p",[e._v("trustStore is: /etc/pki/java/cacerts")]),e._v(" "),a("p",[e._v("ignore的都是 ***128-SHA")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("Cipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_RSA_WITH_AES_256_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA384, TLS_DHE_RSA_WITH_AES_256_CBC_SHA256, TLS_DHE_DSS_WITH_AES_256_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDH_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_RSA_WITH_AES_256_CBC_SHA, TLS_DHE_DSS_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384, TLS_DHE_RSA_WITH_AES_256_GCM_SHA384, TLS_DHE_DSS_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]\nCompression Methods:  { 0 }\n")])])]),a("h4",{attrs:{id:"查看一下服务器支持的tls版本类型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看一下服务器支持的tls版本类型"}},[e._v("#")]),e._v(" 查看一下服务器支持的TLS版本类型：")]),e._v(" "),a("p",[e._v("https://stackoverflow.com/questions/28908835/ssl-peer-shut-down-incorrectly-in-java")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("> nmap -p 443 --script ssl-enum-ciphers api.compass-ft.com\n\nStarting Nmap 7.91 ( https://nmap.org ) at 2022-01-28 09:05 Malay Peninsula Standard Time\n\nNmap scan report for api.compass-ft.com (108.128.72.146)\nHost is up (0.23s latency).\nOther addresses for api.compass-ft.com (not scanned): 54.73.26.109 54.216.252.255\nrDNS record for 108.128.72.146: ec2-108-128-72-146.eu-west-1.compute.amazonaws.com\n\nPORT    STATE SERVICE\n443/tcp open  https\n| ssl-enum-ciphers: \n|   TLSv1.2: \n|     ciphers: \n|       TLS_RSA_WITH_AES_128_GCM_SHA256 (rsa 2048) - A\n|       TLS_RSA_WITH_AES_256_GCM_SHA384 (rsa 2048) - A\n|     compressors: \n|       NULL\n|     cipher preference: server\n|     warnings: \n|       Forward Secrecy not supported by any cipher\n|_  least strength: A\n\nNmap done: 1 IP address (1 host up) scanned in 10.33 seconds\n\n\n")])])]),a("p",[e._v("貌似支持128和256")]),e._v(" "),a("h4",{attrs:{id:"dev上用的java跟生产上的不同"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dev上用的java跟生产上的不同"}},[e._v("#")]),e._v(" dev上用的java跟生产上的不同")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('生产：\n# java -version\nopenjdk version "1.8.0_40"\nOpenJDK Runtime Environment (build 1.8.0_40-b25)\nOpenJDK 64-Bit Server VM (build 25.40-b25, mixed mode)\n\ndev:\n# java -version\nopenjdk version "1.8.0_191"\nOpenJDK Runtime Environment (build 1.8.0_191-b12)\nOpenJDK 64-Bit Server VM (build 25.191-b12, mixed mode)\n')])])]),a("p",[e._v("也没有很大差别，不过安装方式不同，可以看到前面输出两者使用的truststore不同，")]),e._v(" "),a("p",[e._v("dev用的是os的 trustStore is: /etc/pki/java/cacerts")]),e._v(" "),a("p",[e._v("生产用的是jre自己的 trustStore is: /apps/3rd-party/java-se-8u40-ri/jre/lib/security/cacerts")]),e._v(" "),a("p",[e._v("试着用openjdk的cacerts请求一下，居然可以")]),e._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[e._v("   \n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),e._v("root"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[e._v("@sgtcs")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("mdw"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("v02 test"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("datasource"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v("# curl "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("v "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("--")]),e._v("capath "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("opt"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("rd"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("party"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("se"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),e._v("u40"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ri"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("jre"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("lib"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("security"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("cacerts https"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("compass"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("com"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("v1"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("indexes"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("CCRTBTC"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("history"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v("access_token"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("About")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("to")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[e._v("connect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("to")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[e._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("compass")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("com port "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("443")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("#"),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("   "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Trying")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("54.73")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v(".26")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v(".109")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Connected")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("to")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[e._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("compass")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("com "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("54.73")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v(".26")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v(".109")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" port "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("443")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("#"),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Initializing")]),e._v(" NSS "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("with")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[e._v("certpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" sql"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("etc"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("pki"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("nssdb\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" warning"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" CURLOPT_CAPATH not a directory "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("opt"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("rd"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("party"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("se"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),e._v("u40"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ri"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("jre"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("lib"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("security"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("cacerts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("   "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("CAfile")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("etc"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("pki"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("tls"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("certs"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("ca"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("bundle"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("crt\n  "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("CApath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("opt"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("3")]),e._v("rd"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("party"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("java"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("se"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("8")]),e._v("u40"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ri"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("jre"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("lib"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("security"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("cacerts\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" SSL connection using TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Server")]),e._v(" certificate"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("       subject"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" CN"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("compass"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("com\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("       start date"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Dec")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("09")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("23")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("25")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("14")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2021")]),e._v(" GMT\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("       expire date"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Mar")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("09")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("23")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("25")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("13")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("2022")]),e._v(" GMT\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("       common name"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("compass"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("com\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),e._v("       issuer"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" CN"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("R3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("O")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Let")]),e._v("'s "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Encrypt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("C")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("US\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" GET "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("v1"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("indexes"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("CCRTBTC"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),e._v("history"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("?")]),e._v("access_token"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" HTTP"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("1.1")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("User")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Agent")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" curl"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v("7.29")]),a("span",{pre:!0,attrs:{class:"token number"}},[e._v(".0")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" api"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("compass"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),e._v("ft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("com\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("Accept")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("*")]),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("/*\n\n\n")])])])]),a("p",[e._v("反过来用系统的ca给java程序试一下\n#java -jar -Djavax.net.debug=all -Djavax.net.ssl.trustStore=/etc/pki/java/cacerts test-datasource.jar\n仍然是不行")]),e._v(" "),a("p",[a("strong",[e._v("然后想到在dev上用生产的jdk版本试试，确实能够重现出错误！")])]),e._v(" "),a("p",[e._v("openjdk-8u40-b25-linux-x64-10_feb_2015.tar.gz\nopenjdk-8u41-b04-linux-x64-14_jan_2020.tar.gz\n这两个版本都有问题，可能是这个版本的jdk底层实现的tls handshake采用的cipher suite已经过时了;")]),e._v(" "),a("p",[e._v("结合之前VAPT漏洞扫描遇到过的一个tls hardening的问题，我觉着也有可能：\n因为这个版本的jdk刚好优先使用了os所支持的某些比较不安全的cipher suite，然后compassft服务端对这些不安全的算法进行了屏蔽，所以另一种可能的解决办法是对os进行tls hardening可能可以解决这个问题")]),e._v(" "),a("h4",{attrs:{id:"java-security"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#java-security"}},[e._v("#")]),e._v(" java.security")]),e._v(" "),a("p",[e._v("想到是否可以通过更改java security配置来修复这个问题：")]),e._v(" "),a("p",[e._v("Additional information on Oracle's JDK and JRE Cryptographic Algorithms\nhttps://java.com/en/configure_crypto.html")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('[root@sgtcs-mdw-v02 java-se-8u40-ri]# grep -r -l "cipher" ./*\n./jre/lib/security/java.security\n./jre/lib/rt.jar\n./jre/lib/jsse.jar\n./jre/lib/management/management.properties\n./jre/lib/amd64/server/libjvm.so\n./lib/ct.sym\n./man/ja_JP.UTF-8/man1/keytool.1\n./man/man1/keytool.1\n./sample/jmx/jmx-scandir/src/etc/management.properties\n\n')])])]),a("p",[e._v("参照dev上面的java.security配置，更改了生产，")]),e._v(" "),a("p",[e._v("也试了jvm参数 java -jar -Djavax.net.debug=all -Djdk.tls.client.cipherSuites=TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384 test-datasource.jar")]),e._v(" "),a("p",[e._v("不过没有解决，两种可能：")]),e._v(" "),a("p",[e._v("一种可能是有些配置只是对当前的程序是server端有效，而我现在是client端；")]),e._v(" "),a("p",[e._v("另一种可能是jdk处理握手的代码有hardcode https://github.com/AdoptOpenJDK/openjdk-jdk8u/blob/master/jdk/src/share/classes/sun/security/ssl/CipherSuite.java")]),e._v(" "),a("h4",{attrs:{id:"jdk9也不行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jdk9也不行"}},[e._v("#")]),e._v(" jdk9也不行")]),e._v(" "),a("p",[e._v("JDK 9好像握手能够进行多几步了，但是居然爆了另外一个错误：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("System property jdk.tls.client.cipherSuites is set to 'null'\nSystem property jdk.tls.server.cipherSuites is set to 'null'\n\nscheduling-1, handling exception: java.lang.RuntimeException: Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty\n%% Invalidated:  [Session-5, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256]\nscheduling-1, SEND TLSv1.2 ALERT:  fatal, description = internal_error\nscheduling-1, WRITE: TLSv1.2 Alert, length = 2\n[Raw write]: length = 7\n0000: 15 03 03 00 02 02 50                               ......P\nscheduling-1, called closeSocket()\nscheduling-1, called close()\nscheduling-1, called closeInternal(true)\nscheduling-1, called closeSocket()\nscheduling-1, called close()\nscheduling-1, called closeInternal(true)\nscheduling-1, called close()\nscheduling-1, called closeInternal(true)\n2022-01-31 12:05:52.181 ERROR 21924GG [scheduling-1] c.a.m.f.u.HttpClientUtil : Get Exception java.lang.RuntimeException: Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty\n\njavax.net.ssl.SSLException: java.lang.RuntimeException: Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty\n        at java.base/sun.security.ssl.Alerts.getSSLException(Alerts.java:214)\n        at java.base/sun.security.ssl.SSLSocketImpl.fatal(SSLSocketImpl.java:1969)\n        at java.base/sun.security.ssl.SSLSocketImpl.fatal(SSLSocketImpl.java:1921)\n        at java.base/sun.security.ssl.SSLSocketImpl.handleException(SSLSocketImpl.java:1904)\n        at java.base/sun.security.ssl.SSLSocketImpl.handleException(SSLSocketImpl.java:1830)\n        at java.base/sun.security.ssl.AppOutputStream.write(AppOutputStream.java:71)\n        at java.base/java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:81)\n        at java.base/java.io.BufferedOutputStream.flush(BufferedOutputStream.java:142)\n        at org.apache.commons.httpclient.HttpConnection.flushRequestOutputStream(HttpConnection.java:828)\n        at org.apache.commons.httpclient.HttpMethodBase.writeRequest(HttpMethodBase.java:2116)\n        at org.apache.commons.httpclient.HttpMethodBase.execute(HttpMethodBase.java:1096)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeWithRetry(HttpMethodDirector.java:398)\n        at org.apache.commons.httpclient.HttpMethodDirector.executeMethod(HttpMethodDirector.java:171)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:397)\n        at org.apache.commons.httpclient.HttpClient.executeMethod(HttpClient.java:323)\n        at com.lyhistory.middleware.test.util.HttpClientUtil.sendGet(HttpClientUtil.java:64)\n        at com.lyhistory.middleware.test.service.impl.CompassftServiceImpl.sendRequest(CompassftServiceImpl.java:25)\n        at com.lyhistory.middleware.test.job.CompassftJob.crawlData(CompassftJob.java:33)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:564)\n        at org.springframework.scheduling.support.ScheduledMethodRunnable.run(ScheduledMethodRunnable.java:84)\n        at org.springframework.scheduling.support.DelegatingErrorHandlingRunnable.run(DelegatingErrorHandlingRunnable.java:54)\n        at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:514)\n        at java.base/java.util.concurrent.FutureTask.runAndReset(FutureTask.java:305)\n        at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:300)\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1167)\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:641)\n        at java.base/java.lang.Thread.run(Thread.java:844)\nCaused by: java.lang.RuntimeException: Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty\n        at java.base/sun.security.validator.PKIXValidator.<init>(PKIXValidator.java:89)\n        at java.base/sun.security.validator.Validator.getInstance(Validator.java:181)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.getValidator(X509TrustManagerImpl.java:330)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.checkTrustedInit(X509TrustManagerImpl.java:180)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.checkTrusted(X509TrustManagerImpl.java:192)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.checkServerTrusted(X509TrustManagerImpl.java:133)\n        at java.base/sun.security.ssl.ClientHandshaker.checkServerCerts(ClientHandshaker.java:1825)\n        at java.base/sun.security.ssl.ClientHandshaker.serverCertificate(ClientHandshaker.java:1655)\n        at java.base/sun.security.ssl.ClientHandshaker.processMessage(ClientHandshaker.java:260)\n        at java.base/sun.security.ssl.Handshaker.processLoop(Handshaker.java:1086)\n        at java.base/sun.security.ssl.Handshaker.processRecord(Handshaker.java:1020)\n        at java.base/sun.security.ssl.SSLSocketImpl.processInputRecord(SSLSocketImpl.java:1137)\n        at java.base/sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:1074)\n        at java.base/sun.security.ssl.SSLSocketImpl.readRecord(SSLSocketImpl.java:973)\n        at java.base/sun.security.ssl.SSLSocketImpl.performInitialHandshake(SSLSocketImpl.java:1402)\n        at java.base/sun.security.ssl.SSLSocketImpl.writeRecord(SSLSocketImpl.java:733)\n        at java.base/sun.security.ssl.AppOutputStream.write(AppOutputStream.java:67)\n        ... 24 more\nCaused by: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty\n        at java.base/java.security.cert.PKIXParameters.setTrustAnchors(PKIXParameters.java:200)\n        at java.base/java.security.cert.PKIXParameters.<init>(PKIXParameters.java:120)\n        at java.base/java.security.cert.PKIXBuilderParameters.<init>(PKIXBuilderParameters.java:104)\n        at java.base/sun.security.validator.PKIXValidator.<init>(PKIXValidator.java:86)\n        ... 40 more\n\n")])])]),a("p",[e._v("中间还找到类似的bug https://bugs.openjdk.java.net/browse/JDK-8266562")]),e._v(" "),a("p",[e._v("可以看到有的bug同时出现在多个版本，所以高版本的某个小版本可能并没有低版本的fix，")]),e._v(" "),a("h4",{attrs:{id:"openjdk8-update"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#openjdk8-update"}},[e._v("#")]),e._v(" openjdk8 update")]),e._v(" "),a("p",[e._v("所以继续找openjdk8u191，没找到，只找到Oracle和redhat编译的，试了下Oracle的果然没问题")]),e._v(" "),a("p",[e._v("https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html")]),e._v(" "),a("p",[e._v("https://www.oracle.com/java/technologies/javase/8u191-relnotes.html")]),e._v(" "),a("p",[e._v("https://developers.redhat.com/products/openjdk/download")]),e._v(" "),a("p",[e._v("最后找到openjdk的8u系列的版本：")]),e._v(" "),a("p",[e._v('openjdk build 1.8.0_191-b12\nopenjdk site=> left panel click "java 8 update"=> click "wiki"\nhttps://openjdk.java.net/projects/jdk8u/\n=》\nhttps://wiki.openjdk.java.net/display/jdk8u\nNote:')]),e._v(" "),a("p",[e._v("http://hg.openjdk.java.net/jdk8u/jdk8u/ 滚动到下面看到 Added tag jdk8u191-b12 for changeset 6432b2dd408cjdk8u191-b26")]),e._v(" "),a("p",[e._v("虽然没有8u191的release，测试了8u的最高版本8u312b07，果然成功了！")]),e._v(" "),a("p",[e._v("没有尝试的可能方案：")]),e._v(" "),a("p",[e._v('HttpClient如何指定CipherSuites https://ask.csdn.net/questions/189433\nen.setEnabledCipherSuites(new String[]{"TLS_RSA_WITH_AES_128_CBC_SHA"});')]),e._v(" "),a("h4",{attrs:{id:"解决之后研究原因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决之后研究原因"}},[e._v("#")]),e._v(" 解决之后研究原因")]),e._v(" "),a("p",[e._v("https://bugs.openjdk.java.net/browse/JDK-8144544?jql=text%20~%20%22%5C%22Remote%20host%20closed%20connection%20during%20handshake%5C%22%22")]),e._v(" "),a("p",[e._v("https://bugs.openjdk.java.net/browse/JDK-8144544")]),e._v(" "),a("p",[e._v("看来这个比较像，有可能是interoperability issue")]),e._v(" "),a("blockquote",[a("p",[e._v("Check for alternate AES providers. If there's a bad provider, the peer could easily result in a bad padding.")]),e._v(" "),a("p",[e._v("The submitter's environment may have been using IBM JDK and trying to use Oracle's keymanager SunX509 implementation. No further updates. Closing out as not an issue.")])]),e._v(" "),a("p",[e._v("openjdk ibm padding EOFException handshake")]),e._v(" "),a("p",[e._v("https://www.ibm.com/support/pages/apar/IV37231")]),e._v(" "),a("blockquote",[a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('The problem happens because the size of the "PreMaster Secret"\ngenerated from ECDH KeyAgreement in IBMJCE provider\ndid not match openssl\'s counterpart for some of the EC curves.\n')])])])]),e._v(" "),a("p",[e._v("https://wiki.openjdk.java.net/display/jdk8u")]),e._v(" "),a("p",[e._v("下载代码，确实有很多相关的修复")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v('git clone https://github.com/openjdk/jdk8u\ncd jdk8u/\ngit status\ngit tag\ngit checkout jdk8u40-b25\ngit checkout jdk8u191-b12\ngit log -S"receiveChangeCipherSpec"\ngit log -S"receiveChangeCipherSpec"\ngit show b9d40c7d6cfa8f221bf1973821b97210e6f3a5be\ngit log -S"provider"\nGIT SHOW b380264de3d82ceb291401dae06e9c605e36ebd0\ngit show b380264de3d82ceb291401dae06e9c605e36ebd0\ngit log -S"padding"\ngit log -S"ECDH"\ngit log -S"EC curve"\n')])])]),a("h3",{attrs:{id:"跟上一个问题本质一样-unexpected-error-java-security-invalidalgorithmparameterexception-the-trustanchors-parameter-must-be-non-empty"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#跟上一个问题本质一样-unexpected-error-java-security-invalidalgorithmparameterexception-the-trustanchors-parameter-must-be-non-empty"}},[e._v("#")]),e._v(" 跟上一个问题本质一样：Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty")]),e._v(" "),a("p",[e._v("maven 报错：\n[ERROR] Plugin org.apache.maven.plugins:maven-clean-plugin:2.5 or one of its dependencies could not be resolved: Failed to read artifact descriptor for org.apache.maven.plugins:maven-clean-plugin:jar:2.5: Could not transfer artifact org.apache.maven.plugins:maven-clean-plugin:pom:2.5 from/to central (https://repo.maven.apache.org/maven2): java.lang.RuntimeException: Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty")]),e._v(" "),a("p",[e._v("刚开始怀疑是ca找不到，所以指定了path：")]),e._v(" "),a("p",[a("code",[e._v('mvn clean install -Djavax.net.ssl.trustStore="%JAVA_HOME%/jre/lib/security/cacerts"')])]),e._v(" "),a("p",[e._v("一样报错")]),e._v(" "),a("p",[e._v("执行：\n"),a("code",[e._v("keytool -printcert -sslserver https://repo.maven.apache.org/maven2")])]),e._v(" "),a("p",[e._v("报错：keytool error: java.lang.Exception: No certificate from the SSL server")]),e._v(" "),a("p",[e._v("然后就以为仅仅是没有安装好cert(后来发现上面命令写错，应该是 "),a("code",[e._v("keytool -printcert -sslserver repo.maven.apache.org:443/maven2")]),e._v(")，所以用openssl下载")]),e._v(" "),a("p",[a("code",[e._v("openssl s_client -showcerts -connect https://repo.maven.apache.org/maven2")]),e._v("\n报错：getservbyname failure，原来是命令写错了，不能用url，因为")]),e._v(" "),a("blockquote",[a("p",[e._v("As SSL is an TCP-level protocol rather than HTTP, strip the protocol and path from the -connect to make that command work:\n改正：\n"),a("code",[e._v("openssl s_client -showcerts -connect repo.maven.apache.org:443/maven2")]),e._v("\n继续报错：\nLoading 'screen' into random state - done\nCONNECTED(000003B8)\n36464:error:1407742E:SSL routines:SSL23_GET_SERVER_HELLO:tlsv1 alert protocol version:.\\ssl\\s23_clnt.c:596:")])]),e._v(" "),a("p",[e._v("看到tlsv1，很陈旧了，怪不得不行")]),e._v(" "),a("blockquote",[a("p",[e._v("Java releases < JDK 8\nAs noted in this blog post by Oracle, TLSv1 was used by default for JDK releases prior to JDK 8. JDK 8 changed this behavior and defaults to TLSv1.2. Any client (ex. JGit is one such popular client) that runs on older versions of the JDK is affected. This can be addressed by updating to JDK >= 8 or explicitly opting in to TLSv1.2 in JDK 7 (look at the https.protocols JSSE tuning parameter). Unfortunately, versions of the JDK <= 6 do not support TLSv1.2. We advise users of JDK <= 6 to upgrade to a newer version of the JDK.")])]),e._v(" "),a("p",[e._v("maven或者maven作为java工具使用的jdk到底是什么tls版本呢，这才想起可以用debug模式嘛！")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v(">mvn clean -Djavax.net.debug=ssl:handshake:verbose\n[INFO] Scanning for projects...\n[INFO]\n[INFO] --------------------< ngs.apex.com:ngs-kafka-redis >--------------------\n[INFO] Building ngs-kafka-redis 1.0-SNAPSHOT\n[INFO] --------------------------------[ jar ]---------------------------------\nkeyStore is :\nkeyStore type is : jks\nkeyStore provider is :\ninit keystore\ninit keymanager of type SunX509\ntrustStore is: C:\\Program Files\\Java\\openjdk-8u42-b03-windows-i586-14_jul_2022\\java-se-8u42-ri\\jre\\lib\\security\\cacerts\ntrustStore type is : jks\ntrustStore provider is :\ninit truststore\ntrigger seeding of SecureRandom\ndone seeding SecureRandom\nDownloading from central: https://repo.maven.apache.org/maven2/org/apache/maven/plugins/maven-clean-plugin/2.5/maven-clean-plugin-2.5.pom\nIgnoring unavailable cipher suite: TLS_DHE_DSS_WITH_AES_256_GCM_SHA384\n...........................\nIgnoring unavailable cipher suite: TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\nAllow unsafe renegotiation: false\nAllow legacy hello messages: true\nIs initial handshake: true\nIs secure renegotiation: false\nIgnoring unsupported cipher suite: TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256 for TLSv1\n...........................\nIgnoring unsupported cipher suite: TLS_DHE_DSS_WITH_AES_128_CBC_SHA256 for TLSv1.1\n%% No cached client session\n*** ClientHello, TLSv1.2\nRandomCookie:  GMT: 1698637036 bytes = { 209, 36, 180, 104, 123, 125, 185, 208, 135, 243, 5, 246, 5, 4, 149, 203, 38, 227, 243, 114, 209, 160, 154, 44, 98, 64, 216, 237 }\nSession ID:  {}\nCipher Suites: [TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_RSA_WITH_AES_128_CBC_SHA256, TLS_DHE_DSS_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA, TLS_ECDH_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDH_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDH_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_RSA_WITH_AES_128_GCM_SHA256, TLS_DHE_DSS_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_ECDSA_WITH_3DES_EDE_CBC_SHA, TLS_ECDH_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, TLS_ECDHE_ECDSA_WITH_RC4_128_SHA, TLS_ECDHE_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_SHA, TLS_ECDH_ECDSA_WITH_RC4_128_SHA, TLS_ECDH_RSA_WITH_RC4_128_SHA, SSL_RSA_WITH_RC4_128_MD5, TLS_EMPTY_RENEGOTIATION_INFO_SCSV]\nCompression Methods:  { 0 }\nExtension elliptic_curves, curve names: {secp256r1, sect163k1, sect163r2, secp192r1, secp224r1, sect233k1, sect233r1, sect283k1, sect283r1, secp384r1, sect409k1, sect409r1, secp521r1, sect571k1, sect571r1, secp160k1, secp160r1, secp160r2, sect163r1, secp192k1, sect193r1, sect193r2, secp224k1, sect239k1, secp256k1}\nExtension ec_point_formats, formats: [uncompressed]\nExtension signature_algorithms, signature_algorithms: SHA512withECDSA, SHA512withRSA, SHA384withECDSA, SHA384withRSA, SHA256withECDSA, SHA256withRSA, SHA224withECDSA, SHA224withRSA, SHA1withECDSA, SHA1withRSA, SHA1withDSA, MD5withRSA\nExtension server_name, server_name: [type=host_name (0), value=repo.maven.apache.org]\n***\nmain, WRITE: TLSv1.2 Handshake, length = 237\nmain, READ: TLSv1.2 Handshake, length = 91\n*** ServerHello, TLSv1.2\nRandomCookie:  GMT: 1698637036 bytes = { 11, 26, 138, 205, 219, 12, 47, 76, 81, 250, 116, 198, 4, 121, 217, 252, 16, 77, 103, 11, 173, 27, 249, 11, 188, 241, 110, 114 }\nSession ID:  {243, 233, 42, 175, 111, 215, 73, 173, 200, 132, 149, 173, 131, 151, 65, 120, 8, 240, 32, 245, 220, 99, 53, 59, 216, 248, 138, 37, 220, 224, 226, 29}\nCipher Suite: TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\nCompression Method: 0\nExtension server_name, server_name:\nExtension renegotiation_info, renegotiated_connection: <empty>\nExtension ec_point_formats, formats: [uncompressed]\n***\n%% Initialized:  [Session-1, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256]\n** TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256\nmain, READ: TLSv1.2 Handshake, length = 2831\n*** Certificate chain\nchain [0] = [\n[\n  Version: V3\n  Subject: CN=repo.maven.apache.org\n  Signature Algorithm: SHA256withRSA, OID = 1.2.840.113549.1.1.11\n\n  Key:  Sun RSA public key, 2048 bits\n  params: null\n  modulus: 28795882934893170709623103651489185786975131948609576963107688434511348310799802656845161034643210777058995329074431904764998037079985935160874251932529088221962175039191746870936504441381816177009381056896033366380084462000778878049779150489872742696438528007493098911402774939286666937972636658579084418254399343610870831413603481932550983328398869983159007061407084769194187816409958865599623151601605308929809745759759171345763173435175230826903492910465231908482466346877446616723920841555903920739078053322860422933292965497520565842570224994296029712905922877471944410263027535162063433759545525713408812439991\n  public exponent: 65537\n  Validity: [From: Thu Mar 16 01:45:12 SGT 2023,\n               To: Tue Apr 16 01:45:11 SGT 2024]\n  Issuer: CN=GlobalSign Atlas R3 DV TLS CA 2023 Q1, O=GlobalSign nv-sa, C=BE\n  SerialNumber: [    01035f98 55d9b4b4 33feec3b 9fd3dc3b]\n\nCertificate Extensions: 10\n[1]: ObjectId: 1.3.6.1.4.1.11129.2.4.2 Criticality=false\nExtension unknown: DER encoded OCTET string =\n0000: 04 82 01 6C 04 82 01 68   01 66 00 75 00 76 FF 88  ...l...h.f.u.v..\n0010: 3F 0A B6 FB 95 51 C2 61   CC F5 87 BA 34 B4 A4 CD  ?....Q.a....4...\n0020: BB 29 DC 68 42 0A 9F E6   67 4C 5A 3A 74 00 00 01  .).hB...gLZ:t...\n0030: 86 E6 60 3F 62 00 00 04   03 00 46 30 44 02 20 37  ..`?b.....F0D. 7\n0040: 23 0A 06 44 D3 43 E8 1A   8B 51 8E DB DB 79 EA 42  #..D.C...Q...y.B\n0050: ED 01 D4 3E 55 B5 13 EA   4A C1 0D A2 7A 2D 95 02  ...>U...J...z-..\n0060: 20 26 7B 0D 1C A8 AE 90   F9 F6 31 15 68 85 3D C9   &........1.h.=.\n0070: CE EB 50 06 F0 5E 02 B3   84 7C 60 9A D8 D6 8A 53  ..P..^....`....S\n0080: 26 00 76 00 3B 53 77 75   3E 2D B9 80 4E 8B 30 5B  &.v.;Swu>-..N.0[\n0090: 06 FE 40 3B 67 D8 4F C3   F4 C7 BD 00 0D 2D 72 6F  ..@;g.O......-ro\n00A0: E1 FA D4 17 00 00 01 86   E6 60 3F 88 00 00 04 03  .........`?.....\n00B0: 00 47 30 45 02 21 00 C8   5A BE DF A4 5F 1A 20 36  .G0E.!..Z..._. 6\n00C0: 72 99 5A C8 55 7C 68 82   B5 C1 26 11 20 C1 CE 66  r.Z.U.h...&. ..f\n00D0: D6 EC F7 30 73 D8 0E 02   20 35 95 17 8A DE F9 37  ...0s... 5.....7\n00E0: 20 54 57 A4 13 3B EA 4A   F7 3F 0B C3 E7 B1 0F 95   TW..;.J.?......\n00F0: B2 70 61 42 D5 9B 35 C9   1B 00 75 00 DA B6 BF 6B  .paB..5...u....k\n0100: 3F B5 B6 22 9F 9B C2 BB   5C 6B E8 70 91 71 6C BB  ?..\"....\\k.p.ql.\n0110: 51 84 85 34 BD A4 3D 30   48 D7 FB AB 00 00 01 86  Q..4..=0H.......\n0120: E6 60 3F D0 00 00 04 03   00 46 30 44 02 20 58 4D  .`?......F0D. XM\n0130: FA 1B 6A 97 8E FA CA CE   13 8B 74 B8 28 AA 24 7F  ..j.......t.(.$.\n0140: 6B B3 E1 F4 6B 1C B2 27   8A A3 F3 05 45 68 02 20  k...k..'....Eh.\n0150: 05 B7 90 28 E1 7D FF CF   43 59 10 64 E6 14 64 CD  ...(....CY.d..d.\n0160: 03 2D E4 2F 2C 76 24 78   19 07 D7 B2 03 40 E1 57  .-./,v$x.....@.W\n\n\n[2]: ObjectId: 1.3.6.1.5.5.7.1.1 Criticality=false\nAuthorityInfoAccess [\n  [\n   accessMethod: ocsp\n   accessLocation: URIName: http://ocsp.globalsign.com/ca/gsatlasr3dvtlsca2023q1\n,\n   accessMethod: caIssuers\n   accessLocation: URIName: http://secure.globalsign.com/cacert/gsatlasr3dvtlsca2023q1.crt\n]\n]\n\n[3]: ObjectId: 2.5.29.35 Criticality=false\nAuthorityKeyIdentifier [\nKeyIdentifier [\n0000: 4A EE A2 47 63 43 3B 3E   78 F3 B4 61 83 72 88 7A  J..GcC;>x..a.r.z\n0010: 9D E4 BD B7                                        ....\n]\n]\n\n[4]: ObjectId: 2.5.29.19 Criticality=true\nBasicConstraints:[\n  CA:false\n  PathLen: undefined\n]\n\n[5]: ObjectId: 2.5.29.31 Criticality=false\nCRLDistributionPoints [\n  [DistributionPoint:\n     [URIName: http://crl.globalsign.com/ca/gsatlasr3dvtlsca2023q1.crl]\n]]\n\n[6]: ObjectId: 2.5.29.32 Criticality=false\nCertificatePolicies [\n  [CertificatePolicyId: [2.23.140.1.2.1]\n[]  ]\n  [CertificatePolicyId: [1.3.6.1.4.1.4146.10.1.3]\n[PolicyQualifierInfo: [\n  qualifierID: 1.3.6.1.5.5.7.2.1\n  qualifier: 0000: 16 26 68 74 74 70 73 3A   2F 2F 77 77 77 2E 67 6C  .&https://www.gl\n0010: 6F 62 61 6C 73 69 67 6E   2E 63 6F 6D 2F 72 65 70  obalsign.com/rep\n0020: 6F 73 69 74 6F 72 79 2F                            ository/\n\n]]  ]\n]\n\n[7]: ObjectId: 2.5.29.37 Criticality=false\nExtendedKeyUsages [\n  serverAuth\n  clientAuth\n]\n\n[8]: ObjectId: 2.5.29.15 Criticality=true\nKeyUsage [\n  DigitalSignature\n  Key_Encipherment\n]\n\n[9]: ObjectId: 2.5.29.17 Criticality=false\nSubjectAlternativeName [\n  DNSName: repo.maven.apache.org\n]\n\n[10]: ObjectId: 2.5.29.14 Criticality=false\nSubjectKeyIdentifier [\nKeyIdentifier [\n0000: A2 41 82 30 FD 20 1E AD   6E C5 F5 60 C5 49 DA 6B  .A.0. ..n..`.I.k\n0010: 65 F1 03 E7                                        e...\n]\n]\n\n]\n  Algorithm: [SHA256withRSA]\n  Signature:\n0000: 04 25 62 42 2D 7D D5 DD   6F 15 12 7F B0 6E 56 9A  .%bB-...o....nV.\n0010: 17 9E 75 E7 E9 19 69 BC   42 69 09 36 10 B4 BA DB  ..u...i.Bi.6....\n0020: EE A3 4B 70 FB 45 69 05   9C BB CB D4 48 87 BB D0  ..Kp.Ei.....H...\n0030: 45 B4 36 F9 66 EC C6 D8   72 16 CA 6A 10 99 18 3C  E.6.f...r..j...<\n0040: EC 68 53 C3 55 DC C7 1C   AF 35 8E D0 FB AF 3E 4E  .hS.U....5....>N\n0050: EB A8 22 68 84 7B D9 29   E6 DB 3A E1 2F E4 FC 7B  ..\"h...)..:./...\n0060: A1 DB AC C1 B3 1C 4D 18   2D FA A4 21 F4 FB 46 4B  ......M.-..!..FK\n0070: D0 1F 5E F9 B9 C5 C6 9E   57 9B 18 C9 CF B5 47 04  ..^.....W.....G.\n0080: 57 89 0B 7D 7C C3 D7 B3   D7 FF F2 DF F8 D2 93 CB  W...............\n0090: 68 EC FE D3 91 AF C6 4C   D3 5C 44 D2 14 2F 41 C7  h......L.\\D../A.\n00A0: F6 26 C8 CA FE F2 03 10   D6 82 98 86 27 92 C8 8D  .&..........'...\n00B0: 47 FC 15 88 26 91 E1 E9   05 6B E5 BE A3 1B A5 45  G...&....k.....E\n00C0: FE 89 44 B0 FF 72 9A 8A   16 29 E4 6C 3B 58 A2 B6  ..D..r...).l;X..\n00D0: BD 52 E3 5C A2 F0 B7 88   46 4C 13 43 79 E3 20 FF  .R.\\....FL.Cy. .\n00E0: 30 4F A4 21 65 86 BC AE   55 48 EC 49 C9 7C BC 0F  0O.!e...UH.I....\n00F0: CF A5 51 89 61 CE 3B 77   2D 12 AB EE 53 E2 24 D0  ..Q.a.;w-...S.$.\n\n]\nchain [1] = [\n[\n  Version: V3\n  Subject: CN=GlobalSign Atlas R3 DV TLS CA 2023 Q1, O=GlobalSign nv-sa, C=BE\n  Signature Algorithm: SHA256withRSA, OID = 1.2.840.113549.1.1.11\n\n  Key:  Sun RSA public key, 2048 bits\n  params: null\n  modulus: 22941182395348209119228249726660887858982599495232930369943940778119370598005314768543184682686715394486071593426418166888450349001350102649337188343001416419398052557334306738847492388373635574320259007569262959914518081798822155847737418641363799800748857854899290714685301338337310532066938363767866421215369791882818989684086341799298031628895579924634179196014833310804027217895253579752528603133597659946455003267832674856984788115576493236293338336856286111413325485730798313857421555414130349520016887608182648469835491249743188502481439641920200126892980772957171158548827169732281195247623293620193847883027\n  public exponent: 65537\n  Validity: [From: Wed Oct 12 11:48:28 SGT 2022,\n               To: Sat Oct 12 08:00:00 SGT 2024]\n  Issuer: CN=GlobalSign, O=GlobalSign, OU=GlobalSign Root CA - R3\n  SerialNumber: [    7d4d424a 0bd1ed1a 3512a8e2 4955356c]\n\nCertificate Extensions: 8\n[1]: ObjectId: 1.3.6.1.5.5.7.1.1 Criticality=false\nAuthorityInfoAccess [\n  [\n   accessMethod: ocsp\n   accessLocation: URIName: http://ocsp2.globalsign.com/rootr3\n,\n   accessMethod: caIssuers\n   accessLocation: URIName: http://secure.globalsign.com/cacert/root-r3.crt\n]\n]\n\n[2]: ObjectId: 2.5.29.35 Criticality=false\nAuthorityKeyIdentifier [\nKeyIdentifier [\n0000: 8F F0 4B 7F A8 2E 45 24   AE 4D 50 FA 63 9A 8B DE  ..K...E$.MP.c...\n0010: E2 DD 1B BC                                        ....\n]\n]\n\n[3]: ObjectId: 2.5.29.19 Criticality=true\nBasicConstraints:[\n  CA:true\n  PathLen:0\n]\n\n[4]: ObjectId: 2.5.29.31 Criticality=false\nCRLDistributionPoints [\n  [DistributionPoint:\n     [URIName: http://crl.globalsign.com/root-r3.crl]\n]]\n\n[5]: ObjectId: 2.5.29.32 Criticality=false\nCertificatePolicies [\n  [CertificatePolicyId: [2.23.140.1.2.1]\n[]  ]\n  [CertificatePolicyId: [1.3.6.1.4.1.4146.10.1.3]\n[]  ]\n]\n\n[6]: ObjectId: 2.5.29.37 Criticality=false\nExtendedKeyUsages [\n  serverAuth\n  clientAuth\n]\n\n[7]: ObjectId: 2.5.29.15 Criticality=true\nKeyUsage [\n  DigitalSignature\n  Key_CertSign\n  Crl_Sign\n]\n\n[8]: ObjectId: 2.5.29.14 Criticality=false\nSubjectKeyIdentifier [\nKeyIdentifier [\n0000: 4A EE A2 47 63 43 3B 3E   78 F3 B4 61 83 72 88 7A  J..GcC;>x..a.r.z\n0010: 9D E4 BD B7                                        ....\n]\n]\n\n]\n  Algorithm: [SHA256withRSA]\n  Signature:\n0000: 8A D1 05 04 09 3F 63 E0   66 75 4F 73 B0 58 FF E5  .....?c.fuOs.X..\n0010: D1 EB 74 C8 D4 EE DB 3B   51 9F 2F 01 D5 20 F8 85  ..t....;Q./.. ..\n0020: 5F 43 9F BC F7 16 D5 C3   44 39 F2 A0 0B 2F D8 34  _C......D9.../.4\n0030: CD E5 E5 E0 C2 B3 0A DA   7D 10 65 BC 83 91 B2 54  ..........e....T\n0040: 6B 10 06 7E 3A 4D 1C 78   09 FD 8A 3C BB E2 6C A6  k...:M.x...<..l.\n0050: D0 C3 46 E7 48 6B 12 36   C4 E8 28 19 15 58 92 1D  ..F.Hk.6..(..X..\n0060: 17 37 31 38 E7 CD F4 71   80 B0 8E 7A 9E 1E 83 0F  .718...q...z....\n0070: 7C 27 F4 DE D8 61 86 6F   2A C4 39 46 A4 FF 25 31  .'...a.o*.9F..%1\n0080: B2 80 24 81 02 2C C1 03   62 9E 13 19 93 60 39 A2  ..$..,..b....`9.\n0090: 98 E7 14 01 BF 75 86 4C   61 04 95 AC B6 2B E4 53  .....u.La....+.S\n00A0: 6D B5 B4 21 8E 6D D6 81   46 1B 50 F5 BC 3C 27 77  m..!.m..F.P..<'w\n00B0: 98 D5 93 DA F9 19 09 66   55 2C A6 DF 02 21 11 B3  .......fU,...!..\n00C0: D7 95 E7 06 2C DA F4 0E   E0 43 24 A3 1B 88 97 FB  ....,....C$.....\n00D0: FF FD 3B 8F 61 A3 6E 24   33 93 37 AD 06 82 D0 02  ..;.a.n$3.7.....\n00E0: 0A 45 80 3A 42 00 91 C6   A0 B1 5C BE B1 1E 80 AF  .E.:B.....\\.....\n00F0: F5 6D CC D9 6C 8C 2D C7   39 7B 6D 3B AC B9 96 1A  .m..l.-.9.m;....\n\n]\n***\nmain, handling exception: java.lang.RuntimeException: Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty\n%% Invalidated:  [Session-1, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256]\nmain, SEND TLSv1.2 ALERT:  fatal, description = internal_error\nmain, WRITE: TLSv1.2 Alert, length = 2\nmain, called closeSocket()\n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD FAILURE\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  3.273 s\n[INFO] Finished at: 2023-10-30T11:41:33+08:00\n[INFO] ------------------------------------------------------------------------\n[ERROR] Plugin org.apache.maven.plugins:maven-clean-plugin:2.5 or one of its dependencies could not be resolved: Failed to read artifact descriptor for org.apache.maven.plugins:maven-clean-plugin:jar:2.5: Could not transfer artifact org.apache.maven.plugins:maven-clean-plugin:pom:2.5 from/to central (https://repo.maven.apache.org/maven2): java.lang.RuntimeException: Unexpected error: java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty -> [Help 1]\n[ERROR]\n[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.\n[ERROR] Re-run Maven using the -X switch to enable full debug logging.\n[ERROR]\n[ERROR] For more information about the errors and possible solutions, please read the following articles:\n[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/PluginResolutionException\n")])])]),a("p",[a("a",{attrs:{href:"#openjdk8-update"}},[e._v("这不就是跟前面一样的问题了")]),e._v("，果断升级openjdk")]),e._v(" "),a("h4",{attrs:{id:"根源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#根源"}},[e._v("#")]),e._v(" 根源")]),e._v(" "),a("p",[e._v("lib/security/cacerts内某个root证书过期")]),e._v(" "),a("blockquote",[a("p",[e._v("I manage manually my jdk and was getting this error with openjdk-8. I replaced the cacerts with the one of the openjdk-11 and it worked just fine. If you try this, make sure to backup your cacerts first.")])]),e._v(" "),a("p",[e._v("另一种方法绕过：\nmvn clean -Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true")]),e._v(" "),a("h3",{attrs:{id:"outdated-tls1-0-win10-打不开应用商店-microsoft-store"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#outdated-tls1-0-win10-打不开应用商店-microsoft-store"}},[e._v("#")]),e._v(" outdated TLS1.0 - win10 打不开应用商店 Microsoft store")]),e._v(" "),a("p",[e._v("用“win + R”打开运行， 输入 inetcpl.cpl 打开Internet属性（或从IE浏览器设置打开），点击高级选项， 找到并勾选 TLS 1.2，取消勾选TLS 1.0")]),e._v(" "),a("h3",{attrs:{id:"certificateexception-no-subject-alternative-names-present"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#certificateexception-no-subject-alternative-names-present"}},[e._v("#")]),e._v(" CertificateException: No subject alternative names present")]),e._v(" "),a("p",[e._v("When the server certificate is having Subject Alternative Names (SAN), the requesting home name must match with one of the SANs. If the server’s SSL certificate does not have SANs, then the requesting home name must match with the Common Name (CN) of the certificate.\nhttps://stackoverflow.com/questions/29157861/java-certificateexception-no-subject-alternative-names-matching-ip-address")]),e._v(" "),a("h3",{attrs:{id:"一些有意思的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一些有意思的问题"}},[e._v("#")]),e._v(" 一些有意思的问题")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://developer.aliyun.com/article/574642",target:"_blank",rel:"noopener noreferrer"}},[e._v("Netty SSL性能调优"),a("OutboundLink")],1),e._v("\nOPENSSL 知多少？ https://mp.weixin.qq.com/s/QW-uO4OzSRtSkpI4LjGUQw\n用jmeter通过ssl验证访问https https://cloud.tencent.com/developer/article/1199237?from=15425\n解决 HTTPS 证书失效菜刀连不上 https://cloud.tencent.com/developer/article/1399952?from=15425\nHow can I disable a TLS cipher for only some protocols using JVM Config? https://stackoverflow.com/questions/52779312/java-how-can-i-disable-a-tls-cipher-for-only-some-protocols-using-jvm-config?rq=1")]),e._v(" "),a("p",[e._v("Comparative study of TLS Cipher Suite supported by Java 8\nhttps://linuxtut.com/en/877120a7dfa9e4a0e1e3/")]),e._v(" "),a("disqus")],1)}),[],!1,null,null,null);t.default=s.exports}}]);