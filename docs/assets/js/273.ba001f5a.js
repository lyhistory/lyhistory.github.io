(window.webpackJsonp=window.webpackJsonp||[]).push([[273],{697:function(e,t,n){"use strict";n.r(t);var s=n(65),o=Object(s.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h2",{attrs:{id:"basics"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#basics"}},[e._v("#")]),e._v(" Basics")]),e._v(" "),n("h3",{attrs:{id:"ttfb"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ttfb"}},[e._v("#")]),e._v(" TTFB")]),e._v(" "),n("p",[e._v("time to first byte\nhttps://web.dev/ttfb/")]),e._v(" "),n("p",[n("img",{attrs:{src:"/docs/docs_image/software/programming/web/network_request_phase.png",alt:""}})]),e._v(" "),n("h2",{attrs:{id:"web容器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#web容器"}},[e._v("#")]),e._v(" web容器：")]),e._v(" "),n("p",[e._v("tomcat")]),e._v(" "),n("p",[e._v("apache")]),e._v(" "),n("p",[e._v("iis")]),e._v(" "),n("p",[e._v("nginx")]),e._v(" "),n("p",[e._v("phpstudy")]),e._v(" "),n("h2",{attrs:{id:"工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#工具"}},[e._v("#")]),e._v(" 工具")]),e._v(" "),n("h3",{attrs:{id:"html"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#html"}},[e._v("#")]),e._v(" html")]),e._v(" "),n("p",[e._v("inspect on disappering element，有些元素是鼠标mouse hover才显示，所以直接用开发者工具inspect是不行的，\n需要在相关的parent上面右键设置一个Break on->subtree modifications")]),e._v(" "),n("h3",{attrs:{id:"network"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#network"}},[e._v("#")]),e._v(" network")]),e._v(" "),n("p",[e._v("network-> right click on requests -> Copy -> Copy as Curl(bash)")]),e._v(" "),n("p",[e._v("chrome:\nchrome://net-export/\nhttps://netlog-viewer.appspot.com/#sockets\nhttps://chromium.googlesource.com/chromium/src/+/HEAD/net/docs/crash-course-in-net-internals.md\nhttps://zhuanlan.zhihu.com/p/266622278")]),e._v(" "),n("p",[e._v("firefox:\nweb developer tool->performance->recording\nhttps://firefox-source-docs.mozilla.org/networking/http/logging.html\nabout:networking#logging")]),e._v(" "),n("p",[e._v("When Mozilla’s built-in logging capabilities aren’t good enough, and you need a full-fledged packet tracing tool, two free products are "),n("a",{attrs:{href:"https://www.wireshark.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("Wireshark"),n("OutboundLink")],1),e._v(" and "),n("a",{attrs:{href:"https://github.com/jpr5/ngrep/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ngrep"),n("OutboundLink")],1)]),e._v(" "),n("h2",{attrs:{id:"troubleshooting"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[e._v("#")]),e._v(" Troubleshooting")]),e._v(" "),n("h3",{attrs:{id:"performance-issue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#performance-issue"}},[e._v("#")]),e._v(" Performance issue")]),e._v(" "),n("h4",{attrs:{id:"website-calling-another-api-server"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#website-calling-another-api-server"}},[e._v("#")]),e._v(" website calling another api server")]),e._v(" "),n("p",[e._v("表现为：网站页面显示从api获取的数据很慢，内网访问ttfb半分钟，外网访问直接timeout")]),e._v(" "),n("p",[e._v("分别从网站服务器和api服务器本身测试，不是网站服务器和api服务器之间的网络问题，确实是api服务器的问题：\ntime_starttransfer - time_appconnect is practically the same as Time To First Byte (TTFB)")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('vim curl-format.txt\n{\\n\n"time_redirect": %{time_redirect},\\n\n"time_namelookup": %{time_namelookup},\\n\n"time_connect": %{time_connect},\\n\n"time_appconnect": %{time_appconnect},\\n\n"time_pretransfer": %{time_pretransfer},\\n\n"time_starttransfer": %{time_starttransfer},\\n\n"time_total": %{time_total},\\n\n"size_request": %{size_request},\\n\n"size_upload": %{size_upload},\\n\n"size_download": %{size_download},\\n\n"size_header": %{size_header}\\n\n}\n\n    \ncurl -v -w "@curl-format.txt" -H "Connection: close" http://X.X.X.X/api/call\n')])])]),n("h3",{attrs:{id:"_301-auto-redirect-x-redirect-by"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_301-auto-redirect-x-redirect-by"}},[e._v("#")]),e._v(" 301 auto redirect - X-Redirect-By")]),e._v(" "),n("p",[e._v("事件：dev.site.com 总是自动跳转到www.site.com")]),e._v(" "),n("p",[e._v('初步整个服务器上grep -r -l "www.site.com" / 没有结果')]),e._v(" "),n("p",[e._v("1.通过nslookup查看了cname，确定没有cname重定向")]),e._v(" "),n("p",[e._v("2.查看了apache配置")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("vim /etc/httpd/conf/httpd.conf \nvim /etc/httpd/conf.d/demo_http.conf \nvim /etc/httpd/conf.d/demo_https.conf\n")])])]),n("p",[e._v("确定没有重定向，唯一的重定向是http里面有到https的重定向，不过测试的时候完全可以直接访问\nhttps://dev.site.com 来排除http重定向的问题，依然自动跳转")]),e._v(" "),n("p",[e._v("3.怀疑是代码问题，此站点使用的是WordPress代码，备份删除整站代码，创建 index.html: hello world，")]),e._v(" "),n("p",[e._v("发现访问https://dev.site.com/index.html不跳转，访问https://dev.site.com依然跳转，")]),e._v(" "),n("p",[e._v("刚开始我因此排除了是代码问题，其实301跳转有缓存，此时的跳转是")]),e._v(" "),n("p",[e._v("后来才发现network里面这个301 Moved Permanently 是from disk cache！！！")]),e._v(" "),n("p",[e._v("清理缓存后（或者浏览器开发者工具，直接勾选Disable cache更容易），再访问https://dev.site.com，发现response如下：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("\nHTTP/1.1 301 Moved Permanently\nDate: Thu, 28 Oct 2021 07:31:15 GMT\nServer: Apache\nX-Redirect-By: Polylang\nLocation: https://www.xxx.com/\nX-Content-Type-Options: nosniff\nX-XSS-Protection: 1; mode=block\nContent-Length: 0\nKeep-Alive: timeout=5, max=100\nConnection: Keep-Alive\nContent-Type: text/html; charset=UTF-8\n\n")])])]),n("p",[e._v("注意到X-Redirect-By: Polylang，就是这个鬼，wordpress一个插件，最后查明原因是，dev的db配置成了生产的，所以估计这个polylang就使用了生产的域名！")]),e._v(" "),n("h3",{attrs:{id:"auto-follow-redirection-3xx"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#auto-follow-redirection-3xx"}},[e._v("#")]),e._v(" Auto follow redirection (3xx)")]),e._v(" "),n("p",[e._v("起因：")]),e._v(" "),n("p",[e._v("一个java程序使用spring web client RestTemplate 访问华为云上的elb url:\nhttp://api.lyhistory.com/api/v1/testit/\n，华为云上配置elb的策略是自动转到https即\nhttps://api.lyhistory.com/api/v1/testit/")]),e._v(" "),n("p",[e._v("程序报错：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("2022-10-14 18:45:58.891 ERROR 1540GG [scheduling-1] c.q.c.m.s.i.xxx : Failed to query xxx. Error:Could not extract response: no suitable HttpMessageConverter found for response type [class com.lyhistory.testmodel] and content type [text/html]\n\n")])])]),n("h4",{attrs:{id:"调查"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#调查"}},[e._v("#")]),e._v(" 调查：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('\n正常应该是返回json，而不是text/html\n\ncurl一下试试\n\ncurl --header "Authorization: XXXXXX" http://api.lyhistory.com/api/v1/testit/\n\n返回  301 Moved Permanently\n\n加上auto follow redirection：\ncurl -L --header "Authorization: XXXXXX" http://api.lyhistory.com/api/v1/testit/\n则返回正常！\n\n\n使用hackbar测试华为云看看chrome network的请求长啥样\n\nget\n\n1st request:\n>\nGET /api/v1/testit/ HTTP/1.1\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.115 Safari/537.36\n\n<\nHTTP/1.1 307 Internal Redirect\nLocation: https://api.lyhistory.com/api/v1/testit/\nCross-Origin-Resource-Policy: Cross-Origin\nNon-Authoritative-Reason: HSTS\n\n\n2nd request:\n>\nGET /api/v1/testit/ HTTP/1.1\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nAccept-Encoding: gzip, deflate, br\nAccept-Language: en-US,en;q=0.9\nConnection: keep-alive\nHost: api.lyhistory.com\nIf-None-Match: W/"1ff-0SzbxxK5OAa9GvtZs8XPKShpiHo"\nSec-Fetch-Dest: document\nSec-Fetch-Mode: navigate\nSec-Fetch-Site: cross-site\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/102.0.5005.115 Safari/537.36\nauthorization: XXXXXX\nsec-ch-ua: " Not A;Brand";v="99", "Chromium";v="102", "Google Chrome";v="102"\nsec-ch-ua-mobile: ?0\nsec-ch-ua-platform: "Windows"\n\n<\nHTTP/1.1 200 OK\nDate: Fri, 14 Oct 2022 10:37:49 GMT\nContent-Type: application/json; charset=utf-8\nContent-Length: 511\nConnection: keep-alive\nAccess-Control-Allow-Origin: *\nX-RateLimit-Limit: 360\nX-RateLimit-Remaining: 359\nX-RateLimit-Reset: 1665759419\nContent-Security-Policy: default-src \'self\';base-uri \'self\';block-all-mixed-content;font-src \'self\' https: data:;frame-ancestors \'self\';img-src \'self\' data:;object-src \'none\';script-src \'self\';script-src-attr \'none\';style-src \'self\' https: \'unsafe-inline\';upgrade-insecure-requests\nX-DNS-Prefetch-Control: off\nExpect-CT: max-age=0\nX-Frame-Options: SAMEORIGIN\nStrict-Transport-Security: max-age=15552000; includeSubDomains\nX-Download-Options: noopen\nX-Content-Type-Options: nosniff\nX-Permitted-Cross-Domain-Policies: none\nReferrer-Policy: no-referrer\nX-XSS-Protection: 0\nETag: W/"1ff-gghi4jHEutMe/7viD10y38cnRdU"\nServer: elb\n\n')])])]),n("p",[e._v("学习：HSTS 307 internal redirect:\nThe HTTP 307 Internal Redirect response is a variant of the 307 Temporary Redirect status code. It’s not defined by the HTTP standard and is just a local browser implementation.\n302 to 307:https://rtfm.co.ua/en/http-redirects-post-and-get-requests-and-lost-data/\nhttps://www.nginx.com/blog/http-strict-transport-security-hsts-and-nginx/\nhttps://kinsta.com/knowledgebase/307-redirect/#understanding-http-307-internal-redirect-for-httpsonly-sites\nSpring的RestTemplate自动重定向，如何拿到重定向后的地址？ https://blog.csdn.net/m0_37657841/article/details/107391699")]),e._v(" "),n("p",[e._v("看起来华为云elb http to https跳转没有问题，只要正常follow redirect就可以，看来我们的java程序RestTemplate应该是没有自动follow redirect所以得到了第一次返回的redirection的html响应结果，")]),e._v(" "),n("h4",{attrs:{id:"验证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证"}},[e._v("#")]),e._v(" 验证：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('刚开始使用\njava -Djavax.net.debug=all jarfile \n但是奇怪并没有额外输出http connection的信息？\n\n只好用strace抓一下\nstrace -o strace.out -s 4096 -e trace=network -f -p <PID>\n\n\n11937 accept(30,  <unfinished ...>\n11938 socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 38\n11938 connect(38, {sa_family=AF_INET, sin_port=htons(80), sin_addr=inet_addr("x.x.x.x")}, 16) = 0\n11938 getsockname(38, {sa_family=AF_INET, sin_port=htons(42404), sin_addr=inet_addr("10.20.1.101")}, [16]) = 0\n11938 setsockopt(38, SOL_TCP, TCP_NODELAY, [1], 4) = 0\n11938 sendto(38, "GET /api/v1/testit/ HTTP/1.1\\r\\nAccept: application/json, application/*+json\\r\\nAuthorization: XXXXXX\\r\\nUser-Agent: Java/1.8.0_40\\r\\nHost: api.lyhistory.com\\r\\nConnection: keep-alive\\r\\n\\r\\n", 215, 0, NULL, 0) = 215\n11938 recvfrom(38, "HTTP/1.1 301 Moved Permanently\\r\\nDate: Fri, 14 Oct 2022 01:40:00 GMT\\r\\nContent-Type: text/html\\r\\nContent-Length: 134\\r\\nConnection: keep-alive\\r\\nLocation: https://api.lyhistory.com:443/api/v1/testit/\\r\\nServer: elb\\r\\n\\r\\n<html>\\r\\n<head><title>301 Moved Permanently</title></head>\\r\\n<body>\\r\\n<center><h1>301 Moved Permanently</h1></center>\\r\\n</body>\\r\\n</html>\\r\\n", 8192, 0, NULL, NULL) = 360\n14483 +++ exited with 0 +++\n\n果然是 301 Moved Permanently\n')])])]),n("h4",{attrs:{id:"重现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#重现"}},[e._v("#")]),e._v(" 重现：")]),e._v(" "),n("p",[e._v("本地暂时没法访问云上资源，直接本地用nginx模拟：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('\nserver {\n        listen       80;\n        server_name  test.local;\n        return 307 https://$host$request_uri;\n    }\nserver {\n\t\tunderscores_in_headers on;\n\t\t#listen       80;\n        listen 443 ssl;\n        server_name  test.local;\n\n\t\tadd_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;\n\t\tadd_header Access-Control-Allow-Headers Authorization;\n\t\t\n        ssl_certificate clear-selfsigned.crt;\n        ssl_certificate_key clear-selfsigned.key;\n\t\t\n        location /test{\n\t\t\tdefault_type application/json;\n\t\t\treturn 200 \'{"success":"true","error":"hello world"}\';\n\t\t}\n}\n\n使用hackerbar对比一下华为云elb：\nget http://test.local/test\n\n1st request:\n>\nGET /test HTTP/1.1\nHost: test.local\nConnection: keep-alive\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nAccept-Encoding: gzip, deflate\nAccept-Language: en-US,en;q=0.9\ntest: 111222333\nauthorization: B873PGZRZK4MVWGVKZ8HQHMTB92K\n\n<\nHTTP/1.1 307 Temporary Redirect\nServer: nginx/1.17.6\nDate: Fri, 14 Oct 2022 10:33:54 GMT\nContent-Type: text/html\nContent-Length: 171\nConnection: keep-alive\nLocation: https://test.local/test\n\n2nd request:\n>\nGET /test HTTP/1.1\nHost: test.local\nConnection: keep-alive\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\nSec-Fetch-Site: cross-site\nSec-Fetch-Mode: navigate\nSec-Fetch-Dest: document\nsec-ch-ua: " Not A;Brand";v="99", "Chromium";v="90", "Google Chrome";v="90"\nsec-ch-ua-mobile: ?0\nAccept-Encoding: gzip, deflate, br\nAccept-Language: en-US,en;q=0.9\n\n<\nHTTP/1.1 200 OK\nServer: nginx/1.17.6\nDate: Fri, 14 Oct 2022 10:33:54 GMT\nContent-Type: application/json\nContent-Length: 40\nConnection: keep-alive\nStrict-Transport-Security: max-age=31536000; includeSubDomains\nAccess-Control-Allow-Headers: Authorization\n\n\n')])])]),n("p",[e._v("然后本地启动java程序，可以重现出那个错误！")]),e._v(" "),n("p",[e._v("但是调试过程，发现 RestTempate默认的factory本身就是默认 auto follow redirect")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("public boolean getInstanceFollowRedirects() {\n         return instanceFollowRedirects;\n     }\ninstanceFollowRedirects=true\n")])])]),n("p",[e._v("那为什么没有跳转呢，其实重现的时候，只要一步步调试就可以看到这个code\nsun.net.www.protocol.http.HttpURLConnection")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("if (!this.url.getProtocol().equalsIgnoreCase(var3.getProtocol())) {\n/* 2625 */                      return false;\n/*      */ \n/*      */                   }\n")])])]),n("p",[e._v("对比了当前协议和跳转的协议，不同就直接返回！")]),e._v(" "),n("h4",{attrs:{id:"根源-root-cause"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#根源-root-cause"}},[e._v("#")]),e._v(" 根源 root cause：")]),e._v(" "),n("p",[e._v("\"After discussion among Java Networking engineers, it is felt that we shouldn't automatically follow redirect from one protocol to another, for instance, from http to https and vise versa, doing so may have serious security consequences. Thus the fix is to return the server responses for redirect. Check response code and Location header field value for redirect information. It's the application's responsibility to follow the redirect.\"\n-- https://bugs.openjdk.org/browse/JDK-8190312\n-- https://stackoverflow.com/questions/1884230/httpurlconnection-doesnt-follow-redirect-from-http-to-https")]),e._v(" "),n("p",[e._v("调查中还发现nginx模拟的时候第二次请求的authorization header自动被抹掉了，debug Rest Template才发现这段代码\nsun.net.www.protocol.http.HttpURLConnection")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('if (!this.isUserProxyAuth) {\n/* 1686 */                         this.requests.remove("Proxy-Authorization");\n/*      */                      }\n')])])]),n("p",[e._v("nginx redirect 跳转不能带原有的header（安全问题），只能走反向代理才可以\nhttps://segmentfault.com/q/1010000011377374\nhttps://www.reddit.com/r/nginx/comments/ox1vfb/missing_headers_after_redirect/")]),e._v(" "),n("h3",{attrs:{id:"wordpress-upload-failed-empty-response"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#wordpress-upload-failed-empty-response"}},[e._v("#")]),e._v(" wordpress upload failed empty response")]),e._v(" "),n("p",[e._v("描述：")]),e._v(" "),n("p",[e._v("wordpress media上传，"),n("strong",[e._v("开发环境")]),e._v("没有问题，"),n("strong",[e._v("生产production")]),e._v("上却失败，大小3m也不是很大，")]),e._v(" "),n("p",[e._v("/wp-admin/async-upload.php")]),e._v(" "),n("h4",{attrs:{id:"初步观察"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#初步观察"}},[e._v("#")]),e._v(" 初步观察")]),e._v(" "),n("h5",{attrs:{id:"firefox下面"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#firefox下面"}},[e._v("#")]),e._v(" firefox下面：")]),e._v(" "),n("p",[e._v("Queued: 21.50 s\tStarted: 1.60 m\tinDownloaded: 2.88 min\nRequest Timing\nBlocked:\n1.25 min\nDNS Resolution:\n0 ms\nConnecting:\n64 ms\nTLS Setup:\n69 ms\nSending:\n1.27 min\nWaiting:\n0 ms\nReceiving:\n0 ms")]),e._v(" "),n("p",[e._v("可以发现Blocked时间很长（后面才知道是因为经过waf过滤才导致的）\nhttps://developer.mozilla.org/en-US/docs/Tools/Network_Monitor/request_details#Timings\nBlocked解释：\nTime spent in a queue waiting for a network connection.")]),e._v(" "),n("p",[e._v("The browser imposes a limit on the number of simultaneous connections that can be made to a single server. In Firefox this defaults to 6, but can be changed using the network.http.max-persistent-connections-per-server preference. If all connections are in use, the browser can't download more resources until a connection is released.")]),e._v(" "),n("p",[e._v("http://kb.mozillazine.org/Network.http.max-persistent-connections-per-server")]),e._v(" "),n("p",[e._v("http://kb.mozillazine.org/Editing_configuration")]),e._v(" "),n("p",[e._v("修改（先不要随便修改）：访问 about:config 搜索 Network.http.max-persistent-connections-per-server")]),e._v(" "),n("h5",{attrs:{id:"chrome"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#chrome"}},[e._v("#")]),e._v(" chrome：")]),e._v(" "),n("p",[e._v("跟firefox稍有不同，\n首先在status一列可以看到 (failed) net::ERR_EMPTY_RESPONSE 在network timing里面看到 stalled")]),e._v(" "),n("p",[e._v("搜索这两个关键词无果：")]),e._v(" "),n("p",[e._v("https://stackoverflow.com/questions/66036116/wordpress-err-empty-response-on-long-content")]),e._v(" "),n("p",[e._v("https://stackoverflow.com/questions/27740692/request-stalled-for-a-long-time-occasionally-in-chrome")]),e._v(" "),n("p",[e._v("注意力回到timing解释")]),e._v(" "),n("p",[e._v("https://developer.chrome.com/docs/devtools/network/reference/#timing-explanation")]),e._v(" "),n("p",[e._v("Queueing. The browser queues requests when:\nThere are higher priority requests.\nThere are already six TCP connections open for this origin, which is the limit. Applies to HTTP/1.0 and HTTP/1.1 only.\nThe browser is briefly allocating space in the disk cache\nStalled. The request could be stalled for any of the reasons described in Queueing.\n这里也提到了6个TCP连接的限制")]),e._v(" "),n("p",[e._v("Firefox和chrome都可以在network列名上右键添加 Protocol，从而确认确实是HTTP1.1，然后chrome还可以添加 connection id")]),e._v(" "),n("p",[e._v("下面这个解释很有帮助")]),e._v(" "),n("blockquote",[n("p",[n("em",[e._v("Note 2: If a TCP handshake was needed for a HTTP request, you'll see an orange bar in the DevTools waterfall and, if you hover over it, you'll see \"Initial connection\" - this tells you how long the handshake took in milliseconds. TCP connections may be reused across tabs and windows so watch out -- you might see an ID for the first time but it may not have a TCP handshake! This likely because you visited the page previously and opened a connection with that host. It may also be because Chrome prefetched a resource from the host -- Chrome prefetches a favicon for example when you type an address in the bar.")])]),e._v(" "),n("p",[e._v("https://stackoverflow.com/questions/34184994/chrome-developer-tools-connection-id")])]),e._v(" "),n("p",[e._v("下面可以排除前面 https://stackoverflow.com/questions/27740692/request-stalled-for-a-long-time-occasionally-in-chrome")]),e._v(" "),n("p",[e._v("提到的 "),n("strong",[e._v("persistent TCP connection")]),e._v("的原因")]),e._v(" "),n("p",[e._v("chrome://net-export/")]),e._v(" "),n("p",[e._v("https://netlog-viewer.appspot.com/#import")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('t=35069 [st=    0] +REQUEST_ALIVE  [dt=34115]\n                    --\x3e priority = "MEDIUM"\n                    --\x3e traffic_annotation = 101845102\n                    --\x3e url = "https://www.xxx.com/wp-admin/async-upload.php"\nt=35069 [st=    0]    DELEGATE_INFO  [dt=108]\n                      --\x3e delegate_blocked_by = "Opening Files"\nt=35177 [st=  108]    NETWORK_DELEGATE_BEFORE_URL_REQUEST  [dt=0]\nt=35177 [st=  108]   +URL_REQUEST_START_JOB  [dt=34006]\n                      --\x3e initiator = "https://www.xxx.com"\n                      --\x3e load_flags = 2 (BYPASS_CACHE)\n                      --\x3e method = "POST"\n                      --\x3e network_isolation_key = "https://xxx.com https://xxx.com"\n                      --\x3e privacy_mode = "disabled"\n                      --\x3e request_type = "other"\n                      --\x3e site_for_cookies = "SiteForCookies: {site=https://xxx.com; schemefully_same=true}"\n                      --\x3e upload_id = "0"\n                      --\x3e url = "https://www.xxx.com/wp-admin/async-upload.php"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      COOKIE_INCLUSION_STATUS\n                        --\x3e operation = "send"\n                        --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=35177 [st=  108]      NETWORK_DELEGATE_BEFORE_START_TRANSACTION  [dt=0]\nt=35177 [st=  108]      HTTP_CACHE_GET_BACKEND  [dt=0]\n建立连接HTTP_STREAM_JOB_CONTROLLER和HTTP_STREAM_JOB\nt=35177 [st=  108]     +HTTP_STREAM_REQUEST  [dt=3]\nt=35177 [st=  108]        HTTP_STREAM_JOB_CONTROLLER_BOUND\n                          --\x3e source_dependency = 1174836 (HTTP_STREAM_JOB_CONTROLLER)\nt=35180 [st=  111]        HTTP_STREAM_REQUEST_BOUND_TO_JOB\n                          --\x3e source_dependency = 1174837 (HTTP_STREAM_JOB)\nt=35180 [st=  111]     -HTTP_STREAM_REQUEST\nt=35181 [st=  112]      UPLOAD_DATA_STREAM_INIT  [dt=0]\n                        --\x3e is_chunked = false\n                        --\x3e net_error = 0 (?)\n                        --\x3e total_size = 3505027\nt=35181 [st=  112]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=6769]\nt=35181 [st=  112]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS\n                          --\x3e POST /wp-admin/async-upload.php HTTP/1.1\n                              Host: www.xxx.com\n                              Connection: keep-alive\n                              Content-Length: 3505027\n                              Pragma: no-cache\n                              Cache-Control: no-cache\n                              sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="90", "Google Chrome";v="90"\n                              sec-ch-ua-mobile: ?0\n                              User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36\n                              Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryZinpNBEkQJmJWpBq\n                              Accept: */*\n                              Origin: https://www.xxx.com\n                              Sec-Fetch-Site: same-origin\n                              Sec-Fetch-Mode: cors\n                              Sec-Fetch-Dest: empty\n                              Referer: https://www.xxx.com/wp-admin/upload.php\n                              Accept-Encoding: gzip, deflate, br\n                              Accept-Language: en-US,en;q=0.9\n                              Cookie: [717 bytes were stripped]\nt=35181 [st=  112]        HTTP_TRANSACTION_SEND_REQUEST_BODY\n                          --\x3e did_merge = false\n                          --\x3e is_chunked = false\n                          --\x3e length = 3505027\n开始上传                          \nt=35181 [st=  112]        UPLOAD_DATA_STREAM_READ  [dt=0]\n                          --\x3e current_position = 0\nt=35182 [st=  113]        UPLOAD_DATA_STREAM_READ  [dt=0]\n                          --\x3e current_position = 16384\n..............\nt=41949 [st= 6880]        UPLOAD_DATA_STREAM_READ  [dt=1]\n                          --\x3e current_position = 3505027\n上传失败 net_error = -100，但是注意此时current_position = 3505027===length = 3505027\n耗时\nt = 41950-35181=6769\nst = 6881-112=6769\n大概6秒\nt=41950 [st= 6881]     -HTTP_TRANSACTION_SEND_REQUEST\nt=41950 [st= 6881]     +HTTP_TRANSACTION_READ_HEADERS  [dt=10169]\nt=41950 [st= 6881]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=10168]\n                          --\x3e net_error = -100 (ERR_CONNECTION_CLOSED)\nt=52118 [st=17049]        HTTP_TRANSACTION_RESTART_AFTER_ERROR\n                          --\x3e net_error = -100 (ERR_CONNECTION_CLOSED)\nchrome发起重试                          \nt=52119 [st=17050]     -HTTP_TRANSACTION_READ_HEADERS\nt=52119 [st=17050]     +HTTP_STREAM_REQUEST  [dt=399]\n建立连接HTTP_STREAM_JOB_CONTROLLER和HTTP_STREAM_JOB\nt=52119 [st=17050]        HTTP_STREAM_JOB_CONTROLLER_BOUND\n                          --\x3e source_dependency = 1174847 (HTTP_STREAM_JOB_CONTROLLER)\nt=52518 [st=17449]        HTTP_STREAM_REQUEST_BOUND_TO_JOB\n                          --\x3e source_dependency = 1174848 (HTTP_STREAM_JOB)\nt=52518 [st=17449]     -HTTP_STREAM_REQUEST\nt=52518 [st=17449]      UPLOAD_DATA_STREAM_INIT  [dt=0]\n                        --\x3e is_chunked = false\n                        --\x3e net_error = 0 (?)\n                        --\x3e total_size = 3505027\nt=52518 [st=17449]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=6530]\nt=52518 [st=17449]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS\n                          --\x3e POST /wp-admin/async-upload.php HTTP/1.1\n                              Host: www.xxx.com\n                              Connection: keep-alive\n                              Content-Length: 3505027\n                              Pragma: no-cache\n                              Cache-Control: no-cache\n                              sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="90", "Google Chrome";v="90"\n                              sec-ch-ua-mobile: ?0\n                              User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36\n                              Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryZinpNBEkQJmJWpBq\n                              Accept: */*\n                              Origin: https://www.xxx.com\n                              Sec-Fetch-Site: same-origin\n                              Sec-Fetch-Mode: cors\n                              Sec-Fetch-Dest: empty\n                              Referer: https://www.xxx.com/wp-admin/upload.php\n                              Accept-Encoding: gzip, deflate, br\n                              Accept-Language: en-US,en;q=0.9\n                              Cookie: [717 bytes were stripped]\nt=52518 [st=17449]        HTTP_TRANSACTION_SEND_REQUEST_BODY\n                          --\x3e did_merge = false\n                          --\x3e is_chunked = false\n                          --\x3e length = 3505027\nt=52518 [st=17449]        UPLOAD_DATA_STREAM_READ  [dt=0]\n                          --\x3e current_position = 0\n..............\n又是上传完了但是另外一个错误 net_error = -324\nt=59048 [st=23979]        UPLOAD_DATA_STREAM_READ  [dt=0]\n                          --\x3e current_position = 3505027\nt=59048 [st=23979]     -HTTP_TRANSACTION_SEND_REQUEST\nt=59048 [st=23979]     +HTTP_TRANSACTION_READ_HEADERS  [dt=10135]\nt=59048 [st=23979]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=10135]\n                          --\x3e net_error = -324 (ERR_EMPTY_RESPONSE)\nt=69183 [st=34114]     -HTTP_TRANSACTION_READ_HEADERS\n                        --\x3e net_error = -324 (ERR_EMPTY_RESPONSE)\nt=69183 [st=34114]   -URL_REQUEST_START_JOB\n                      --\x3e net_error = -324 (ERR_EMPTY_RESPONSE)\nt=69183 [st=34114]    URL_REQUEST_DELEGATE_RESPONSE_STARTED  [dt=0]\nt=69184 [st=34115] -REQUEST_ALIVE\n                    --\x3e net_error = -324 (ERR_EMPTY_RESPONSE)\n                    \n看下：HTTP_STREAM_JOB_CONTROLLER和HTTP_STREAM_JOB     \n初次是\nt=35177 [st=  108]        HTTP_STREAM_JOB_CONTROLLER_BOUND\n                          --\x3e source_dependency = 1174836 (HTTP_STREAM_JOB_CONTROLLER)\nt=35180 [st=  111]        HTTP_STREAM_REQUEST_BOUND_TO_JOB\n                          --\x3e source_dependency = 1174837 (HTTP_STREAM_JOB)\n1174836：\n1174836: HTTP_STREAM_JOB_CONTROLLER\nhttps://www.xxx.com/wp-admin/async-upload.php\nStart Time: 2021-11-29 17:25:53.321\n\nt=35177 [st=0] +HTTP_STREAM_JOB_CONTROLLER  [dt=4]\n                --\x3e is_preconnect = false\n                --\x3e url = "https://www.xxx.com/wp-admin/async-upload.php"\nt=35177 [st=0]    HTTP_STREAM_JOB_CONTROLLER_BOUND\n                  --\x3e source_dependency = 1174835 (URL_REQUEST)\nt=35177 [st=0]   +PROXY_RESOLUTION_SERVICE  [dt=3]\nt=35178 [st=1]     +HOST_RESOLVER_IMPL_REQUEST  [dt=0]\n                    --\x3e allow_cached_response = true\n                    --\x3e dns_query_type = 1\n                    --\x3e host = "www.xxx.com:0"\n                    --\x3e is_speculative = false\n                    --\x3e network_isolation_key = "null null"\nt=35178 [st=1]        HOST_RESOLVER_IMPL_CACHE_HIT\n                      --\x3e addresses = ["18.140.49.179","203.205.159.22","150.109.90.80","54.254.71.41","54.254.112.6","13.251.21.164"]\n                      --\x3e expiration = "13282651581632397"\nt=35178 [st=1]        HOST_RESOLVER_IMPL_CACHE_HIT\n                      --\x3e addresses = ["18.140.49.179","203.205.159.22","150.109.90.80","54.254.71.41","54.254.112.6","13.251.21.164"]\n                      --\x3e expiration = "13282651581632397"\nt=35178 [st=1]     -HOST_RESOLVER_IMPL_REQUEST\nt=35180 [st=3]      PROXY_RESOLUTION_SERVICE_RESOLVED_PROXY_LIST\n                    --\x3e pac_string = "PROXY 172.16.101.100:8080"\nt=35180 [st=3]   -PROXY_RESOLUTION_SERVICE\nt=35180 [st=3]    HTTP_STREAM_JOB_CONTROLLER_PROXY_SERVER_RESOLVED\n                  --\x3e proxy_server = "PROXY 172.16.101.100:8080"\nt=35180 [st=3]    HTTP_STREAM_REQUEST_STARTED_JOB\n                  --\x3e source_dependency = 1174837 (HTTP_STREAM_JOB)\nt=35181 [st=4] -HTTP_STREAM_JOB_CONTROLLER\n\n1174837: HTTP_STREAM_JOB\nhttps://www.xxx.com/\nStart Time: 2021-11-29 17:25:53.324\n\nt=35180 [st=0] +HTTP_STREAM_JOB  [dt=0]\n                --\x3e expect_spdy = false\n                --\x3e original_url = "https://www.xxx.com/"\n                --\x3e priority = "MEDIUM"\n                --\x3e source_dependency = 1174836 (HTTP_STREAM_JOB_CONTROLLER)\n                --\x3e url = "https://www.xxx.com/"\n                --\x3e using_quic = false\nt=35180 [st=0]    HTTP_STREAM_JOB_WAITING  [dt=0]\n                  --\x3e should_wait = false\nt=35180 [st=0]   +HTTP_STREAM_JOB_INIT_CONNECTION  [dt=0]\nt=35180 [st=0]      TCP_CLIENT_SOCKET_POOL_REQUESTED_SOCKET\n                    --\x3e group_id = "ssl/www.xxx.com:443"\nt=35180 [st=0]     +SOCKET_POOL  [dt=0]\nt=35180 [st=0]        SOCKET_POOL_REUSED_AN_EXISTING_SOCKET\t#重用persistent TCP connection，所以就排除了最初查到的原因\n                      --\x3e idle_ms = 30348\nt=35180 [st=0]        SOCKET_POOL_BOUND_TO_SOCKET\n                      --\x3e source_dependency = 1174753 (SOCKET)\t#注意这里的SOCKET 1174753就是对应的前面说的connectionID\nt=35180 [st=0]     -SOCKET_POOL\nt=35180 [st=0]   -HTTP_STREAM_JOB_INIT_CONNECTION\nt=35180 [st=0]    HTTP_STREAM_REQUEST_PROTO\n                  --\x3e proto = "http/1.1"\nt=35180 [st=0]    HTTP_STREAM_JOB_BOUND_TO_REQUEST\n                  --\x3e source_dependency = 1174835 (URL_REQUEST)\nt=35180 [st=0] -HTTP_STREAM_JO\n                          \n')])])]),n("p",[e._v("对比，正常的上传")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('1208145: URL_REQUEST\nhttps://xxxx.com/wp-admin/async-upload.php\nStart Time: 2021-11-30 14:27:56.488\n\nt=5339 [st=   0] +REQUEST_ALIVE  [dt=1320]\n                  --\x3e priority = "MEDIUM"\n                  --\x3e traffic_annotation = 101845102\n                  --\x3e url = "https://xxxx.com/wp-admin/async-upload.php"\nt=5339 [st=   0]    DELEGATE_INFO  [dt=140]\n                    --\x3e delegate_blocked_by = "Opening Files"\nt=5479 [st= 140]    NETWORK_DELEGATE_BEFORE_URL_REQUEST  [dt=0]\nt=5479 [st= 140]   +URL_REQUEST_START_JOB  [dt=1179]\n                    --\x3e initiator = "https://www.xxx.com"\n                    --\x3e load_flags = 2 (BYPASS_CACHE)\n                    --\x3e method = "POST"\n                    --\x3e network_isolation_key = "https://xxx.com https://xxx.com"\n                    --\x3e privacy_mode = "disabled"\n                    --\x3e request_type = "other"\n                    --\x3e site_for_cookies = "SiteForCookies: {site=https://xxx.com; schemefully_same=true}"\n                    --\x3e upload_id = "0"\n                    --\x3e url = "https://www.xxx.com/wp-admin/async-upload.php"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=5479 [st= 140]      NETWORK_DELEGATE_BEFORE_START_TRANSACTION  [dt=0]\nt=5479 [st= 140]      HTTP_CACHE_GET_BACKEND  [dt=0]\nt=5479 [st= 140]     +HTTP_STREAM_REQUEST  [dt=3]\nt=5479 [st= 140]        HTTP_STREAM_JOB_CONTROLLER_BOUND\n                        --\x3e source_dependency = 1208146 (HTTP_STREAM_JOB_CONTROLLER)\nt=5482 [st= 143]        HTTP_STREAM_REQUEST_BOUND_TO_JOB\n                        --\x3e source_dependency = 1208147 (HTTP_STREAM_JOB)\nt=5482 [st= 143]     -HTTP_STREAM_REQUEST\nt=5482 [st= 143]      UPLOAD_DATA_STREAM_INIT  [dt=0]\n                      --\x3e is_chunked = false\n                      --\x3e net_error = 0 (?)\n                      --\x3e total_size = 4792\nt=5482 [st= 143]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=1]\nt=5482 [st= 143]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS\n                        --\x3e POST /wp-admin/async-upload.php HTTP/1.1\n                            Host: www.xxx.com\n                            Connection: keep-alive\n                            Content-Length: 4792\n                            Pragma: no-cache\n                            Cache-Control: no-cache\n                            sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="90", "Google Chrome";v="90"\n                            sec-ch-ua-mobile: ?0\n                            User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36\n                            Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryHCDeoH2gO9wCcNFe\n                            Accept: */*\n                            Origin: https://www.xxx.com\n                            Sec-Fetch-Site: same-origin\n                            Sec-Fetch-Mode: cors\n                            Sec-Fetch-Dest: empty\n                            Referer: https://www.xxx.com/wp-admin/upload.php\n                            Accept-Encoding: gzip, deflate, br\n                            Accept-Language: en-US,en;q=0.9\n                            Cookie: [717 bytes were stripped]\nt=5483 [st= 144]        HTTP_TRANSACTION_SEND_REQUEST_BODY\n                        --\x3e did_merge = false\n                        --\x3e is_chunked = false\n                        --\x3e length = 4792\nt=5483 [st= 144]        UPLOAD_DATA_STREAM_READ  [dt=0]\n                        --\x3e current_position = 0\nt=5483 [st= 144]        UPLOAD_DATA_STREAM_READ  [dt=0]\n                        --\x3e current_position = 4792\nt=5483 [st= 144]     -HTTP_TRANSACTION_SEND_REQUEST\nt=5483 [st= 144]     +HTTP_TRANSACTION_READ_HEADERS  [dt=1175]\nt=5483 [st= 144]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=1175]\nt=6658 [st=1319]        HTTP_TRANSACTION_READ_RESPONSE_HEADERS\n                        --\x3e HTTP/1.1 200 OK\n                            Server: nginx\n                            Date: Tue, 30 Nov 2021 06:27:57 GMT\n                            Content-Type: text/plain; charset=UTF-8\n                            Expires: Wed, 11 Jan 1984 05:00:00 GMT\n                            X-Frame-Options: SAMEORIGIN\n                            Referrer-Policy: strict-origin-when-cross-origin\n                            X-Content-Type-Options: nosniff\n                            X-WP-Upload-Attachment-ID: 3447\n                            X-XSS-Protection: 1; mode=block\n                            Strict-Transport-Security: max-age=31536000; includeSubDomains;\n                            X-Cache-Lookup: Cache Miss\n                            Content-Encoding: gzip\n                            Cache-Control: must-revalidate, no-cache, max-age=0\n                            Transfer-Encoding: chunked\n                            X-NWS-LOG-UUID: 7691670333191889\n                            Connection: keep-alive\n                            X-Cache-Lookup: Cache Miss\nt=6658 [st=1319]     -HTTP_TRANSACTION_READ_HEADERS\nt=6658 [st=1319]      NETWORK_DELEGATE_HEADERS_RECEIVED  [dt=0]\nt=6658 [st=1319]      URL_REQUEST_FILTERS_SET\n                      --\x3e filters = "GZIP"\nt=6658 [st=1319]   -URL_REQUEST_START_JOB\nt=6658 [st=1319]    URL_REQUEST_DELEGATE_RESPONSE_STARTED  [dt=0]\nt=6658 [st=1319]    HTTP_TRANSACTION_READ_BODY  [dt=0]\nt=6658 [st=1319]    URL_REQUEST_JOB_BYTES_READ\n                    --\x3e byte_count = 845\nt=6658 [st=1319]    URL_REQUEST_JOB_FILTERED_BYTES_READ\n                    --\x3e byte_count = 1868\nt=6659 [st=1320]    HTTP_TRANSACTION_READ_BODY  [dt=0]\nt=6659 [st=1320] -REQUEST_ALIVE\n')])])]),n("p",[e._v("问题的核心在于为什么明明已经上传完成（current_position = 3505027===length = 3505027），但是")]),e._v(" "),n("p",[e._v("HTTP_STREAM_PARSER_READ_HEADERS net_error = -100 (ERR_CONNECTION_CLOSED)")]),e._v(" "),n("p",[e._v("为什么服务端会关掉？")]),e._v(" "),n("p",[e._v("想起来再抓一下dev环境的netlog，发现dev上速度确实快一点，")]),e._v(" "),n("p",[e._v("测试了  vim /etc/httpd/conf/httpd.conf\tTimeout 以及 vim /etc/opt/rh/rh-php72/php.ini max_execution_time，把这些时间放到3秒都没有问题，前面测试3M文件上传大概6到10秒")]),e._v(" "),n("p",[e._v("并且检查了 /.htaccess 都没有问题")]),e._v(" "),n("p",[e._v("再查查其他timeout： 搜索apache httpd http connection closed timeout")]),e._v(" "),n("p",[e._v("https://httpd.apache.org/docs/2.4/mod/core.html")]),e._v(" "),n("p",[e._v("https://www.oreilly.com/library/view/http-the-definitive/1565925092/ch04s07.html")]),e._v(" "),n("p",[e._v("换个关键词吧，毕竟是大文件引起的，测试小图标确实上传没问题，搜索 large file ERR_CONNECTION_CLOSED")]),e._v(" "),n("p",[e._v("https://stackoverflow.com/questions/53736912/neterr-connection-reset-when-large-file-takes-longer-than-a-minute")]),e._v(" "),n("p",[e._v("但是这个答案总感觉有点不太对")]),e._v(" "),n("div",{staticClass:"language-php extra-class"},[n("pre",{pre:!0,attrs:{class:"language-php"}},[n("code",[e._v("RequestReadTimeout header"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("20")]),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("40")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" MinRate"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("500")]),e._v(" body"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("20")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" MinRate"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("500")]),e._v("\nhttps"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("//httpd.apache.org/docs/current/mod/mod_reqtimeout.html")]),e._v("\n")])])]),n("p",[e._v("然后看到另外一个人的回答是因为 ProxyTimeout，回到netlog-viewer：")]),e._v(" "),n("p",[e._v("https://netlog-viewer.appspot.com/#sockets")]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("Name")]),e._v(" "),n("th",[e._v("Handed Out")]),e._v(" "),n("th",[e._v("Idle")]),e._v(" "),n("th",[e._v("Connecting")]),e._v(" "),n("th",[e._v("Max")]),e._v(" "),n("th",[e._v("Max Per Group")]),e._v(" "),n("th",[e._v("Generation")])])]),e._v(" "),n("tbody",[n("tr",[n("td",[e._v("direct:// (transport_socket_pool)")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://netlog-viewer.appspot.com/#events&q=id:1208669,1208667,1208111,1208329",target:"_blank",rel:"noopener noreferrer"}},[e._v("4"),n("OutboundLink")],1)]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("256")]),e._v(" "),n("td",[e._v("6")]),e._v(" "),n("td",[e._v("undefined")])]),e._v(" "),n("tr",[n("td",[e._v("172.16.101.100:8080 (http_proxy_socket_pool)")]),e._v(" "),n("td",[e._v("1")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://netlog-viewer.appspot.com/#events&q=id:1203134,1205602,1208691",target:"_blank",rel:"noopener noreferrer"}},[e._v("3"),n("OutboundLink")],1)]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("32")]),e._v(" "),n("td",[e._v("6")]),e._v(" "),n("td",[e._v("undefined")])]),e._v(" "),n("tr",[n("td",[e._v("127.0.0.1:8888 (http_proxy_socket_pool)")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("32")]),e._v(" "),n("td",[e._v("6")]),e._v(" "),n("td",[e._v("undefined")])])])]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("direct:// (transport_socket_pool)")]),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th")])]),e._v(" "),n("tbody",[n("tr",[n("td",[e._v("Name")]),e._v(" "),n("td",[e._v("Pending")]),e._v(" "),n("td",[e._v("Top Priority")]),e._v(" "),n("td",[e._v("Active")]),e._v(" "),n("td",[e._v("Idle")]),e._v(" "),n("td",[e._v("Connect Jobs")]),e._v(" "),n("td",[e._v("Backup Timer")]),e._v(" "),n("td",[e._v("Stalled")])]),e._v(" "),n("tr",[n("td",[e._v("ssl/dev.xxx.com:443")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("-")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://netlog-viewer.appspot.com/#events&q=id:1208669,1208667",target:"_blank",rel:"noopener noreferrer"}},[e._v("2"),n("OutboundLink")],1)]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("stopped")]),e._v(" "),n("td",[e._v("false")])]),e._v(" "),n("tr",[n("td",[e._v("ssl/hrs.lyhistory.com:443")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("-")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://netlog-viewer.appspot.com/#events&q=id:1208111,1208329",target:"_blank",rel:"noopener noreferrer"}},[e._v("2"),n("OutboundLink")],1)]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("stopped")]),e._v(" "),n("td",[e._v("false")])])])]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("172.16.101.100:8080 (http_proxy_socket_pool)")]),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th"),e._v(" "),n("th")])]),e._v(" "),n("tbody",[n("tr",[n("td",[e._v("Name")]),e._v(" "),n("td",[e._v("Pending")]),e._v(" "),n("td",[e._v("Top Priority")]),e._v(" "),n("td",[e._v("Active")]),e._v(" "),n("td",[e._v("Idle")]),e._v(" "),n("td",[e._v("Connect Jobs")]),e._v(" "),n("td",[e._v("Backup Timer")]),e._v(" "),n("td",[e._v("Stalled")])]),e._v(" "),n("tr",[n("td",[e._v("pm/ssl/sdk.split.io:443")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("-")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://netlog-viewer.appspot.com/#events&q=id:1203134",target:"_blank",rel:"noopener noreferrer"}},[e._v("1"),n("OutboundLink")],1)]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("stopped")]),e._v(" "),n("td",[e._v("false")])]),e._v(" "),n("tr",[n("td",[e._v("ssl/d27xxe7juh1us6.cloudfront.net:443")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("-")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://netlog-viewer.appspot.com/#events&q=id:1205602",target:"_blank",rel:"noopener noreferrer"}},[e._v("1"),n("OutboundLink")],1)]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("stopped")]),e._v(" "),n("td",[e._v("false")])]),e._v(" "),n("tr",[n("td",[e._v("ssl/www.xxx.com:443")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("-")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://netlog-viewer.appspot.com/#events&q=id:1208691",target:"_blank",rel:"noopener noreferrer"}},[e._v("1"),n("OutboundLink")],1)]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("stopped")]),e._v(" "),n("td",[e._v("false")])]),e._v(" "),n("tr",[n("td",[e._v("ssl/www.google.com:443")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("-")]),e._v(" "),n("td",[e._v("1")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("0")]),e._v(" "),n("td",[e._v("stopped")]),e._v(" "),n("td",[e._v("false")])])])]),e._v(" "),n("p",[e._v("可以看到，dev.xxx.com是直接访问的，而www.xxx.com是通过proxy，所以是不是因为这个proxy的原因")]),e._v(" "),n("h4",{attrs:{id:"问题梳理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题梳理"}},[e._v("#")]),e._v(" 问题梳理")]),e._v(" "),n("p",[e._v("首先，chrome使用了机器本身设定的proxy，我是公司电脑，连vpn访问网站会经过默认的 proxy server，就是前面的 172.16.101.100，")]),e._v(" "),n("p",[e._v("firefox可以设定proxy，然后想起来最初使用firefox测试的时候，设置的是no-proxy，")]),e._v(" "),n("p",[e._v("经过一番查找，firefox貌似没有类似chrome的net log viewer，只有个")]),e._v(" "),n("p",[e._v("https://firefox-source-docs.mozilla.org/networking/http/logging.html\nabout:networking#logging")]),e._v(" "),n("p",[e._v("然后发现web developer tool下面有个performance capture，用了下，发现")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Status:\nResponse received\nURL:\nhttps://www.xxx.com/wp-admin/async-upload.php\nPriority:\nNormal(0)\nThread:\nWeb Content (3/9)\nURL:\nhttps://www.xxx.com/wp-admin/upload.php (id: 42949673009)\nWaiting for socket thread:\n42,476ms\nDNS request:\n0.27ms\nAfter DNS request:\n1.2ms\nTCP connection:\n22,389ms\nAfter TCP connection:\n13ms\nEstablishing TLS session:\n311ms\nWaiting for HTTP request:\n1,549ms\nHTTP request and waiting for response:\n14,964ms\nHTTP response:\n15,294ms\nWaiting to transmit the response:\n32ms\n")])])]),n("p",[e._v("Response received显然是不对的，不过下面Waiting for socket thread:42,476ms和TCP connection:22,389ms加起来都超过一分钟了，在about:networking#dns可以看到www.xxx.com解析到了一堆ip，经过询问infra，同事说是waf public ip，所以原来是waf导致了tcp connection超时，")]),e._v(" "),n("p",[e._v("怪不得跟chrome的时间有点不同，chrome至少可以看到在重用reuse tcp socket connection的时候是很快的，那么就自然要确认下，重新设置firefox auto detect proxy，即使用跟chrome一样的机器的proxy，结果如下：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Status:\nResponse received\nURL:\nhttps://www.xxx.com/wp-admin/async-upload.php\nPriority:\nNormal(0)\nThread:\nWeb Content (1/8)\nURL:\nhttps://www.xxx.com/wp-admin/upload.php (id: 42949673012)\nWaiting for socket thread:\n44ms\nHTTP request and waiting for response:\n13,371ms\nHTTP response:\n15,701ms\nWaiting to transmit the response:\n4.3ms\n")])])]),n("p",[e._v("先走了proxy，等待socket时间变短了，可能是reuse也不用重新建立tcp连接握手了，不过等待http reponse的时间很长，估计超时了（超过proxy服务器的timeout时长），至少这次跟chrome表现一样了；")]),e._v(" "),n("p",[e._v("最后自然是重新设置no-proxy，绕过proxy然后绕过waf（设置hosts直接指向web服务器的ip），果然上传成功！")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("Status:\nResponse received\nURL:\nhttps://www.xxx.com/wp-admin/async-upload.php\nPriority:\nNormal(0)\nMIME type:\ntext/plain\nRequested bytes:\n2,259B\nThread:\nWeb Content (1/8)\nURL:\nhttps://www.xxx.com/wp-admin/upload.php (id: 42949673015)\nWaiting for socket thread:\n98ms\nDNS request:\n0.29ms\nAfter DNS request:\n1.3ms\nTCP connection:\n121ms\nAfter TCP connection:\n3.5ms\nEstablishing TLS session:\n114ms\nWaiting for HTTP request:\n21ms\nHTTP request and waiting for response:\n18,930ms\nHTTP response:\n0.67ms\nWaiting to transmit the response:\n4.1ms\n")])])]),n("p",[e._v("https://stackoverflow.com/questions/27740692/request-stalled-for-a-long-time-occasionally-in-chrome/70180892#70180892")]),e._v(" "),n("p",[e._v("https://stackoverflow.com/questions/53736912/neterr-connection-reset-when-large-file-takes-longer-than-a-minute/70180666#70180666")]),e._v(" "),n("h3",{attrs:{id:"websocket-issues"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#websocket-issues"}},[e._v("#")]),e._v(" websocket issues")]),e._v(" "),n("h4",{attrs:{id:"websocket-connection-issue"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#websocket-connection-issue"}},[e._v("#")]),e._v(" websocket connection issue")]),e._v(" "),n("p",[e._v("这次遇到的问题：")]),e._v(" "),n("p",[e._v("firefox访问没有问题（浏览器连接服务器的nginx并转发到websocket端口），本地vscode debug（连接本地nginx，nginx转发到服务器上的websocket服务端）")]),e._v(" "),n("p",[e._v("原因跟上面wordpress large file upload failed一样都是因为公司机器chrome使用了proxy")]),e._v(" "),n("p",[e._v("通常websocket连接不成功大概率是client端或者服务端的问题，所以刚开始浪费了不少时间查看服务端的情况以及websocket client端代码，其实可以直接在dev tools里面执行代码片段进行调试")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("// Create WebSocket connection.\nconst socket = new WebSocket('ws://localhost:8080');\n\n// Connection opened\nsocket.addEventListener('open', function (event) {\n    socket.send('Hello Server!'); // normally should be subscribe example send('{\"oper\":\"subscribe\",\"topic\":\"TOPIC NAME\"}');\n});\n\n// Listen for messages\nsocket.addEventListener('message', function (event) {\n    console.log('Message from server ', event.data);\n});\n\n")])])]),n("p",[e._v("观察到，chrome下偶尔成功，多数时间失败，上chrome终极大杀器 netlog viewer，\nchrome://net-export\nhttps://netlog-viewer.appspot.com\n发现跟前面一样的原因；")]),e._v(" "),n("p",[e._v("后来才有人反馈firefox可以，才意识到firefox默认proxy设置成了blank，chrome不使用插件的情况下默认是系统的proxy")]),e._v(" "),n("h4",{attrs:{id:"websocket-301"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#websocket-301"}},[e._v("#")]),e._v(" websocket 301")]),e._v(" "),n("p",[e._v("nginx config:")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('  location /websocket/ {\n            proxy_pass http://127.0.0.1:10001/websocket;\n            proxy_set_header Upgrade $http_upgrade;\n            proxy_set_header Connection "Upgrade";\n            proxy_set_header X-Real-IP $remote_addr;\n                        proxy_read_timeout 600s;\n        }\n\n')])])]),n("p",[e._v("请求")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('Request URL: ws://X.X.X.X/websocket\nRequest Method: GET\n\n结果\n"GET /websocket HTTP/1.1" 301 169 "\n')])])]),n("p",[e._v("测试：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('# curl --include \\\n>      --no-buffer \\\n>      --header "Connection: Upgrade" \\\n>      --header "Upgrade: websocket" \\\n>      --header "Host: example.com:80" \\\n>      --header "Origin: http://X.X.X.X" \\\n>      --header "Sec-WebSocket-Key: wRPCh4fPSMIpX7yMcpgABA==" \\\n>      --header "Sec-WebSocket-Version: 13" \\\n>      "http://X.X.X.X/websocket"\nHTTP/1.1 301 Moved Permanently\nServer: nginx/1.22.0\nDate: Mon, 12 Sep 2022 09:37:18 GMT\nContent-Type: text/html\nContent-Length: 169\nLocation: http://example.com/websocket/\nConnection: keep-alive\n\n<html>\n<head><title>301 Moved Permanently</title></head>\n<body>\n<center><h1>301 Moved Permanently</h1></center>\n<hr><center>nginx/1.22.0</center>\n</body>\n</html>\n\n\n[root@sghc1-prod-acs-app-v01 ~]# curl --include \\\n>      --no-buffer \\\n>      --header "Connection: Upgrade" \\\n>      --header "Upgrade: websocket" \\\n>      --header "Host: example.com:80" \\\n>      --header "Origin: http://X.X.X.X" \\\n>      --header "Sec-WebSocket-Key: wRPCh4fPSMIpX7yMcpgABA==" \\\n>      --header "Sec-WebSocket-Version: 13" \\\n>      "http://X.X.X.X/websocket/"\nHTTP/1.1 101 Switching Protocols\nServer: nginx/1.22.0\nDate: Mon, 12 Sep 2022 09:36:48 GMT\nConnection: upgrade\nupgrade: websocket\nsec-websocket-accept: NwKFJc0S/lPR4qpqWC7LzZ7CQj4=\n\n▒l{"code":0,"message":"welcome!","sessionId":"1a1050ad-bbb6-4ccd-bfce-a84688e6017d","success":true}\n')])])]),n("p",[e._v("区别就在最后的 ending slash /")]),e._v(" "),n("p",[e._v("所以修改nginx配置")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("location /websocket/ \n=>\nlocation /websocket\n")])])]),n("p",[e._v("https://nginx.org/en/CHANGES-1.22")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("    *) Bugfix: special characters were not escaped during automatic redirect\n       with appended trailing slash.\n")])])]),n("h4",{attrs:{id:"webscoket-failed-switch-protocol-lost-upgrade-header"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#webscoket-failed-switch-protocol-lost-upgrade-header"}},[e._v("#")]),e._v(" webscoket failed switch Protocol/lost upgrade header")]),e._v(" "),n("p",[n("strong",[e._v("描述：")])]),e._v(" "),n("p",[e._v("华为云上配置：\n浏览器/App => CDN或高防等代理 => Web应用防火墙 => 源站服务器")]),e._v(" "),n("p",[e._v("websocket服务位于源站服务器，通过nginx反向代理，nginx配置 debug：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('location /test/wsPublicMessage {\n    if ( $http_upgrade = \'\' ){\n        add_header debug $http_x_forwarded_for;\n        return 465;\n        }\n        proxy_pass http://XXX ;\n        #proxy_redirect off;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n\n\ncurl -k https://xxx/test/wsPublicMessage -vv -H "Sec-WebSocket-Version: 13" -H "Connection: Upgrade" -H "Upgrade: websocket" -H "Sec-WebSocket-Key: csoXmf407963ymLeVKMqDw=="\n')])])]),n("p",[e._v("发现从公网访问，到达nginx的时候 http_upgrade为空，\n但是直接修改本地hosts文件域名指向源站服务器则没有问题，说明问题出在中间的CDN或高防等代理或者Web应用防火墙")]),e._v(" "),n("p",[n("strong",[e._v("调查：")]),e._v("\n修改域名的cname指向Web应用防火墙，绕过cdn，问题解决")]),e._v(" "),n("p",[n("strong",[e._v("原因：")]),e._v("\n华为云cdn服务限制：")]),e._v(" "),n("blockquote",[n("p",[e._v("域名服务范围为中国大陆境外或全球时：\n支持HTTP、HTTPS协议；不支持其他协议，如FTP、TCP、UDP、WebSocket、WSS等协议。")])]),e._v(" "),n("h3",{attrs:{id:"nginx-location-proxy-pass-404"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#nginx-location-proxy-pass-404"}},[e._v("#")]),e._v(" nginx location proxy_pass 404")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("server {\n\t\tlisten       80;\n        location /test {\n            proxy_pass http://127.0.0.1:10001;\n            proxy_redirect    off;\n            proxy_set_header  Host $host;\n            proxy_set_header  X-real-ip $remote_addr;\n            proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;\n        }\n")])])]),n("p",[e._v("刚开始一直怀疑是nginx问题，结果发现10001对应的java服务挂了，开启debug模式发现问题：\njava -Djavax.net.debug=all -jar teset.jar\n原来是一个字体引起的\njava: symbol lookup error: /lib64/libfontconfig.so.1: undefined symbol: FT_Get_Advance")]),e._v(" "),n("p",[e._v("$ ll /usr/lib64/libfontconfig.so.1\nlrwxrwxrwx. 1 root root 23 Jun 15 17:05 /usr/lib64/libfontconfig.so.1 -> libfontconfig.so.1.11.1")]),e._v(" "),n("p",[e._v("nm -D /usr/lib64/libfontconfig.so.1 | grep FT_Get_Advance")]),e._v(" "),n("p",[e._v("$ nm -D /usr/lib64/libfontconfig.so.1 | grep FT_Get_Advance\nU FT_Get_Advance")]),e._v(" "),n("p",[e._v("第一次尝试：\nmv /usr/lib64/libfreetype.so.6 /usr/lib64/libfreetype.so.6_renamed")]),e._v(" "),n("p",[e._v("2022-06-17 19:50:55.845 ERROR 26353GG [io-10001-exec-2] c.q.f.w.a.CommonExceptionHandler : InternalException: Handler dispatch failed; nested exception is java.lang.UnsatisfiedLinkError: /opt/3rd-party/openjdk-8u312-b07/jre/lib/amd64/libfontmanager.so: libfreetype.so.6: cannot open shared object file: No such file or directory")]),e._v(" "),n("p",[e._v("org.springframework.web.util.NestedServletException: Handler dispatch failed; nested exception is java.lang.UnsatisfiedLinkError: /opt/3rd-party/openjdk-8u312-b07/jre/lib/amd64/libfontmanager.so: libfreetype.so.6: cannot open shared object file: No such file or directory\nat org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1075)\nat org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:962)\nat org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006)\nat org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:898)\nat javax.servlet.http.HttpServlet.service(HttpServlet.java:626)\nat org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)\nat javax.servlet.http.HttpServlet.service(HttpServlet.java:733)")]),e._v(" "),n("p",[e._v("第二次(solved)：\nhttps://www.bookstack.cn/read/WeBASE-1.2.4-zh/96bb971c90544168.md")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("yum -y install gcc\nyum -y install gcc-c++\n")])])]),n("h3",{attrs:{id:"clientabortexception-broken-pipe"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#clientabortexception-broken-pipe"}},[e._v("#")]),e._v(" ClientAbortException - Broken pipe")]),e._v(" "),n("p",[e._v("前端=》nginx=》后端服务")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('后端异常：\norg.apache.catalina.connector.ClientAbortException: java.io.IOException: Broken pipe\n\nnginx日志：\n\n10.34.100.15 - - [17/Aug/2022:20:39:05 +0800] "POST /test HTTP/1.1" 499 0 "https://test.com/test" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36"\n10.34.100.15 - - [17/Aug/2022:20:39:06 +0800] "POST /test HTTP/1.1" 200 12176 "https://test.com/test" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/98.0.4758.102 Safari/537.36"\n\n可以看到pattern是一直有两个同一个时间的日志，一个是 499 一个是200，499代表client端也就是浏览器关闭了请求，而服务端还在往buffer写返回，所以抛错\n')])])]),n("p",[e._v("经调查发现前端页面渲染的两个组件内部有重复的api调用")]),e._v(" "),n("h3",{attrs:{id:"clientabortexception-connection-reset-by-peer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#clientabortexception-connection-reset-by-peer"}},[e._v("#")]),e._v(" ClientAbortException - Connection reset by peer")]),e._v(" "),n("p",[e._v("frontend=>nginx=>java program")]),e._v(" "),n("p",[e._v("这个是java program的报错，所以peer不是nginx就是frontend(browser);")]),e._v(" "),n("p",[e._v("发现nginx里面有很多同一秒内的相同请求，并且都是200，只是size不太一样，好像出问题的size少了一些，大概推测是java program返回了200 ok，然后写response的时候client断了，所以没有写完；")]),e._v(" "),n("p",[e._v("有人问我，会不会是突然用户关闭了tab或者浏览器呢，我的回答是浏览器没那么弱鸡：")]),e._v(" "),n("blockquote",[n("p",[e._v("modern browser should follow the standard http tcp protocol: 3 way handshake to establish connection and 4 way handshake to close the connection,\nwhen user try to shutdown browser, it's the browser's responsibility to properly close the connections in the standard way, otherwise will cause the website servers lots of broken connections which is abnormal and irresponsible behavior\nso most of the time the developers no need to worry about how browsers handle the connections when users close the tabs or switch between pages, but how the web pages  behave themselves is the developers responsibility to handle\n如果我说错了请纠正我")])]),e._v(" "),n("p",[e._v("https://blog.csdn.net/qq_28204635/article/details/124060991")]),e._v(" "),n("p",[e._v("所以问题还是出在nginx里面日志发现的同一秒的重复请求，正常测试会发现，极短时间内重复请求，浏览器一般都会cancel掉前一次的请求，但是是不是偶尔浏览器处理的慢一点就导致请求已经在response的时候才中断；")]),e._v(" "),n("p",[e._v("最后确实发现前端代码的问题，在切换内部菜单的时候，不可见的页面A并没有被销毁，A页面上的一个定时poll一直在跑，然后其他页面又可以增加页面A作为子页面，这种情况下，不可见的A和增加的子页面A同时在跑两个定时的poll请求")]),e._v(" "),n("h4",{attrs:{id:"延伸-前面是服务端报错-还有客户端报错的场景-client-side-reset-by-peer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#延伸-前面是服务端报错-还有客户端报错的场景-client-side-reset-by-peer"}},[e._v("#")]),e._v(" 延伸：前面是服务端报错，还有客户端报错的场景 client side reset by peer")]),e._v(" "),n("p",[e._v("HTTP 1.1 introduced the concept of persistent connections, enabling a client to reuse the same connection for multiple requests to a server. Instead of closing the connection immediately after receiving a response, the connection remains open, allowing subsequent requests to benefit from reduced latency and improved performance. This persistence is achieved by keeping the TCP connection alive.")]),e._v(" "),n("p",[e._v("Connection Closure and Non-Idempotent Requests:\nIn certain scenarios, a server may close the persistent connection unexpectedly, resulting in errors for the client. It is important to understand that non-idempotent requests, such as POST and PATCH, should not be retried when the connection is closed.")]),e._v(" "),n("p",[e._v("Idempotent requests are those that produce the same outcome regardless of how many times they are repeated. On the other hand, non-idempotent requests have the potential to cause side effects on the server with each execution. POST, for example, is commonly used to create new records, and multiple executions would result in the creation of multiple records.")]),e._v(" "),n("p",[e._v("Handling Connection Closure:\nWhen a connection is closed, the client cannot be certain whether the request was successfully executed by the server. Hence, according to RFC 7230, which defines the HTTP 1.1 protocol, it is considered unsafe for the client to automatically retry non-idempotent requests such as POST. The client should instead treat the connection closure as a definitive response from the server and proceed accordingly.")]),e._v(" "),n("p",[e._v('A request method is considered "idempotent" if the intended effect on the server of multiple identical requests with that method is the same as the effect for a single request RFC 7230 4.2.2')]),e._v(" "),n("p",[e._v("Automatic retrying of non-idempotent requests could lead to unintended consequences, such as duplicate records being created on the server. Since the client cannot be certain whether the original request was processed by the server before the connection was closed, retrying the request would violate the idempotent nature of the operation.")]),e._v(" "),n("p",[e._v("My solution:")]),e._v(" "),n("p",[e._v("Disable persistent connection on the client side\nReduce connection timeout on the client side to be less than server’s")]),e._v(" "),n("p",[e._v("https://dev.to/thanhphuchuynh/understanding-connection-reset-by-peer-in-golang-a-troubleshooting-guide-41pf")]),e._v(" "),n("h4",{attrs:{id:"延伸2-fix-server-reset-by-peer"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#延伸2-fix-server-reset-by-peer"}},[e._v("#")]),e._v(" 延伸2：fix server: reset by peer")]),e._v(" "),n("p",[e._v("跟浏览器类似，这个也是 fix client的问题，")]),e._v(" "),n("p",[e._v("fix client=>ipsec=>huawei elb load balancer=>fix server")]),e._v(" "),n("p",[e._v("刚好huawei elb有个连接监控图，其中并发连接数（concurrency connections）显示发生问题前后连接数最低为2，发生问题的几秒后连接数增长到3并迅速回到2，说明是有一个 fix client可能突然crash并restart了，造成之前的连接处于 half close状态，加上重连，所以瞬间出现3个连接，然后服务器端关闭了这个连接，所以回到两个连接的状态；")]),e._v(" "),n("h3",{attrs:{id:"请求大量数据时返回截断中断-net-err-incomplete-chunked-encoding"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#请求大量数据时返回截断中断-net-err-incomplete-chunked-encoding"}},[e._v("#")]),e._v(" 请求大量数据时返回截断中断 net::ERR_INCOMPLETE_CHUNKED_ENCODING")]),e._v(" "),n("p",[e._v("请求 size=100没问题\nhttps://api.lyhistory.com/hismin?size=100&datatype=7&instrumentid=BTCP&startday=20221020&starttime=19:35")]),e._v(" "),n("p",[e._v("请求 size=1000返回被截断\nhttps://api.lyhistory.com/hismin?size=1000&datatype=7&instrumentid=BTCP&startday=20221020&starttime=19:35")]),e._v(" "),n("p",[e._v("具体错误：")]),e._v(" "),n("ul",[n("li",[e._v("chrome显示：net::ERR_INCOMPLETE_CHUNKED_ENCODING")]),e._v(" "),n("li",[e._v("firefox：SyntaxError: JSON.parse: end of data after property value in object at line 3606 column 23 of the JSON data")])]),e._v(" "),n("h4",{attrs:{id:"浏览器-》cdn-》waf地址池-》防火墙-只开放访问给waf地址池-》elb-elb-公网地址eip-nat-内网elb-ip-》源服务器-nginx反向代理-proxy-pass-to-upstream"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器-》cdn-》waf地址池-》防火墙-只开放访问给waf地址池-》elb-elb-公网地址eip-nat-内网elb-ip-》源服务器-nginx反向代理-proxy-pass-to-upstream"}},[e._v("#")]),e._v(" 浏览器=》cdn=》waf地址池=》防火墙（只开放访问给waf地址池）=》elb(elb 公网地址eip=>NAT=>内网elb ip)=》源服务器(nginx反向代理->proxy_pass to upstream)，")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('453138: URL_REQUEST\nhttps://api.lyhistory.com/hismin?size=1000&datatype=7&instrumentid=BTCP&startday=20221020&starttime=19:35\nStart Time: 2022-10-21 08:53:14.450\n\nt=23755 [st=  0] +REQUEST_ALIVE  [dt=760]\n                  --\x3e priority = "HIGHEST"\n                  --\x3e traffic_annotation = 63171670\n                  --\x3e url = "https://api.lyhistory.com/hismin?size=1000&datatype=7&instrumentid=BTCP&startday=20221020&starttime=19:35"\nt=23755 [st=  0]    NETWORK_DELEGATE_BEFORE_URL_REQUEST  [dt=0]\nt=23755 [st=  0]   +URL_REQUEST_START_JOB  [dt=759]\n                    --\x3e initiator = "chrome-extension://ginpbkfigcoaokgflihfhhmglmbchinc"\n                    --\x3e load_flags = 65794 (BYPASS_CACHE | CAN_USE_RESTRICTED_PREFETCH | MAIN_FRAME_DEPRECATED)\n                    --\x3e method = "GET"\n                    --\x3e network_isolation_key = "https://lyhistory.com https://lyhistory.com"\n                    --\x3e privacy_mode = "disabled"\n                    --\x3e request_type = "main frame"\n                    --\x3e site_for_cookies = "SiteForCookies: {site=https://lyhistory.com; schemefully_same=true}"\n                    --\x3e url = "https://api.lyhistory.com/hismin?size=1000&datatype=7&instrumentid=BTCP&startday=20221020&starttime=19:35"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, EXCLUDE_NOT_ON_PATH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "EXCLUDE_DOMAIN_MISMATCH, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=23755 [st=  0]      COOKIE_INCLUSION_STATUS\n                      --\x3e operation = "send"\n                      --\x3e status = "INCLUDE, DO_NOT_WARN"\nt=23755 [st=  0]      NETWORK_DELEGATE_BEFORE_START_TRANSACTION  [dt=6]\nt=23761 [st=  6]      HTTP_CACHE_GET_BACKEND  [dt=0]\nt=23761 [st=  6]      HTTP_CACHE_DOOM_ENTRY  [dt=0]\n                      --\x3e net_error = -2 (ERR_FAILED)\nt=23761 [st=  6]      HTTP_CACHE_CREATE_ENTRY  [dt=0]\nt=23761 [st=  6]      HTTP_CACHE_ADD_TO_ENTRY  [dt=0]\nt=23761 [st=  6]     +HTTP_STREAM_REQUEST  [dt=442]\nt=23761 [st=  6]        HTTP_STREAM_JOB_CONTROLLER_BOUND\n                        --\x3e source_dependency = 453146 (HTTP_STREAM_JOB_CONTROLLER)\nt=24203 [st=448]        HTTP_STREAM_REQUEST_BOUND_TO_JOB\n                        --\x3e source_dependency = 453147 (HTTP_STREAM_JOB)\nt=24203 [st=448]     -HTTP_STREAM_REQUEST\nt=24203 [st=448]     +HTTP_TRANSACTION_SEND_REQUEST  [dt=0]\nt=24203 [st=448]        HTTP_TRANSACTION_SEND_REQUEST_HEADERS\n                        --\x3e GET /hismin?size=1000&datatype=7&instrumentid=BTCP&startday=20221020&starttime=19:35 HTTP/1.1\n                            Host: api.lyhistory.com\n                            Connection: keep-alive\n                            Pragma: no-cache\n                            Cache-Control: no-cache\n                            sec-ch-ua: " Not A;Brand";v="99", "Chromium";v="90", "Google Chrome";v="90"\n                            sec-ch-ua-mobile: ?0\n                            Upgrade-Insecure-Requests: 1\n                            User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36\n                            Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\n                            Sec-Fetch-Site: cross-site\n                            Sec-Fetch-Mode: navigate\n                            Sec-Fetch-Dest: document\n                            Accept-Encoding: gzip, deflate, br\n                            Accept-Language: en-US,en;q=0.9\n                            Cookie: [161 bytes were stripped]\nt=24203 [st=448]     -HTTP_TRANSACTION_SEND_REQUEST\nt=24203 [st=448]     +HTTP_TRANSACTION_READ_HEADERS  [dt=311]\nt=24203 [st=448]        HTTP_STREAM_PARSER_READ_HEADERS  [dt=311]\nt=24514 [st=759]        HTTP_TRANSACTION_READ_RESPONSE_HEADERS\n                        --\x3e HTTP/1.1 200 OK\n                            Date: Fri, 21 Oct 2022 00:53:15 GMT\n                            Content-Type: application/json; charset=utf-8\n                            Transfer-Encoding: chunked\n                            Connection: keep-alive\n                            Server: CloudWAF\n                            Content-Encoding: gzip\n                            via: EA-SGP-EDGE1-CACHE5[90],EA-SGP-EDGE1-CACHE5[ovl,89],EA-MAS-cyberjaya-GLOBAL1-CACHE1[ovl,69]\nt=24514 [st=759]     -HTTP_TRANSACTION_READ_HEADERS\nt=24514 [st=759]      HTTP_CACHE_WRITE_INFO  [dt=0]\nt=24514 [st=759]      HTTP_CACHE_WRITE_DATA  [dt=0]\nt=24514 [st=759]      HTTP_CACHE_WRITE_INFO  [dt=0]\nt=24514 [st=759]      NETWORK_DELEGATE_HEADERS_RECEIVED  [dt=0]\nt=24514 [st=759]      URL_REQUEST_FILTERS_SET\n                      --\x3e filters = "GZIP"\nt=24514 [st=759]   -URL_REQUEST_START_JOB\nt=24514 [st=759]    URL_REQUEST_DELEGATE_RESPONSE_STARTED  [dt=1]\nt=24515 [st=760]    HTTP_TRANSACTION_READ_BODY  [dt=0]\nt=24515 [st=760]    URL_REQUEST_JOB_BYTES_READ\n                    --\x3e byte_count = 3086\nt=24515 [st=760]    URL_REQUEST_JOB_FILTERED_BYTES_READ\n                    --\x3e byte_count = 65536\nt=24515 [st=760]    URL_REQUEST_JOB_FILTERED_BYTES_READ\n                    --\x3e byte_count = 16211\nt=24515 [st=760]    HTTP_TRANSACTION_READ_BODY  [dt=0]\n                    --\x3e net_error = -355 (ERR_INCOMPLETE_CHUNKED_ENCODING)\nt=24515 [st=760]    FAILED\n                    --\x3e net_error = -355 (ERR_INCOMPLETE_CHUNKED_ENCODING)\nt=24515 [st=760] -REQUEST_ALIVE\n                  --\x3e net_error = -355 (ERR_INCOMPLETE_CHUNKED_ENCODING)\n')])])]),n("h4",{attrs:{id:"浏览器-》源服务器-nginx反向代理-proxy-pass-to-upstream"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#浏览器-》源服务器-nginx反向代理-proxy-pass-to-upstream"}},[e._v("#")]),e._v(" 浏览器=》源服务器(nginx反向代理->proxy_pass to upstream)")]),e._v(" "),n("p",[e._v("200 但是 chrome network status: (failed)net::ERR_CONTENT_LENGTH_MISMATCH")]),e._v(" "),n("p",[e._v("curl测试：")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("1curl: (18) transfer closed with 235509 bytes remaining to read\n")])])]),n("h4",{attrs:{id:"根源-root-cause-2"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#根源-root-cause-2"}},[e._v("#")]),e._v(" 根源 root cause")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('tail -f vi /usr/local/nginx/logs/error.log\n\n2022/10/21 14:20:25 [crit] 15692#0: *357 open() "/usr/local/nginx/proxy_temp/1/05/0000000051" failed (13: Permission denied) while reading upstream, client: 172.31.252.99, server: api.lyhistory.com, request: "POST /hismin HTTP/1.1", upstream: "http://127.0.0.1:8085/hismin", host: "172.31.252.69"\n\n# ps -ef|grep nginx\nroot     15690     1  0 Oct20 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx\nnobody   15691 15690  0 Oct20 ?        00:00:00 nginx: worker process\nnobody   15692 15690  0 Oct20 ?        00:00:00 nginx: worker process\nnobody   15693 15690  0 Oct20 ?        00:00:00 nginx: worker process\nnobody   15694 15690  0 Oct20 ?        00:00:00 nginx: worker process\n\n发现master是root权限，worker是nobody，莫非是：\n请求size=100的时候 master就可以搞定，1000的时候要拉worker过来干活结果发现没有权限\n（从之前的请求可以看到response Content-Length: 317256, 317256/1024=309KB,肯定upstream返回的数据量是超过了nginx某些默认的缓冲区大小，所以要写入临时文件中）\n\n实际proxy_temp nobody有权限\ndrwx------. 12 nobody root   96 Oct 21 15:08 proxy_temp\n\n发现nobody没有/usr/local/nginx这个路径的权限\n修复：chmod a+rx nginx\n\n')])])]),n("disqus")],1)}),[],!1,null,null,null);t.default=o.exports}}]);