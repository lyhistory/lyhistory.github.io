(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{279:function(e,t,s){"use strict";s.r(t);var a=s(0),r=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("p",[s("a",{attrs:{href:"/docs/software"}},[e._v("回目录")]),e._v("  《分布式缓存redis》")]),e._v(" "),s("h2",{attrs:{id:"_1-安装使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装使用"}},[e._v("#")]),e._v(" 1. 安装使用")]),e._v(" "),s("p",[e._v("https://redis.io/topics/quickstart")]),e._v(" "),s("h3",{attrs:{id:"_1-1-简单安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-简单安装"}},[e._v("#")]),e._v(" 1.1 简单安装")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("wget http://download.redis.io/redis-stable.tar.gz\ntar xvzf redis-stable.tar.gz\ncd redis-stable\nmake\nmake test\nsudo cp src/redis-server /usr/local/bin/\nsudo cp src/redis-cli /usr/local/bin/\n")])])]),s("h3",{attrs:{id:"_1-2-生产环境安装（推荐）"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-生产环境安装（推荐）"}},[e._v("#")]),e._v(" 1.2 生产环境安装（推荐）")]),e._v(" "),s("blockquote",[s("p",[e._v("Installing Redis more properly\nRunning Redis from the command line is fine just to hack a bit with it or for development. However at some point you'll have some actual application to run on a real server. For this kind of usage you have two different choices:")]),e._v(" "),s("ul",[s("li",[e._v("Run Redis using screen.")]),e._v(" "),s("li",[e._v("Install Redis in your Linux box in a proper way using an init script, so that after a restart everything will start again properly.\nA proper install using an init script is strongly suggested. The following instructions can be used to perform a proper installation using the init script shipped with Redis 2.4 in a Debian or Ubuntu based distribution.")])]),e._v(" "),s("p",[e._v("We assume you already copied redis-server and redis-cli executables under /usr/local/bin.")]),e._v(" "),s("ul",[s("li",[e._v("Create a directory in which to store your Redis config files and your data:\nsudo mkdir /etc/redis\nsudo mkdir /var/redis")]),e._v(" "),s("li",[e._v("Copy the init script that you'll find in the Redis distribution under the utils directory into /etc/init.d. We suggest calling it with the name of the port where you are running this instance of Redis. For example:\nsudo cp utils/redis_init_script /etc/init.d/redis_6379")]),e._v(" "),s("li",[e._v("Edit the init script.\nsudo vi /etc/init.d/redis_6379\n...\nhttps://redis.io/topics/quickstart")])])]),e._v(" "),s("h3",{attrs:{id:"_1-3-单节点启动-single-node"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-单节点启动-single-node"}},[e._v("#")]),e._v(" 1.3 单节点启动 Single node")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("redis-server\nOr start with config\nredis-server redis.conf\n")])])]),s("h3",{attrs:{id:"_1-4-集群启动-cluster-mode"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-集群启动-cluster-mode"}},[e._v("#")]),e._v(" 1.4 集群启动 Cluster Mode")]),e._v(" "),s("p",[e._v("Redis cluster tutorial https://redis.io/topics/cluster-tutorial\nConfig:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('daemonize yes  #后台运行模式\nlogfile “redis_6379_log”\npidfile /home/web/redis/var/run/redis_6379.pid  #修改pid文件\ndir /home/web/redis/data/ #指定本地数据库存放目录\nport 6379  #端口\ndbfilename dump_6379.rdb #数据文件\nappendfilename "appendonly_6379.aof"\ncluster-enabled yes #打开注释，启动cluster模式\ncluster-config-file nodes-6379.conf #打开注释，启动cluster模式\n# Cluster node timeout is the amount of milliseconds a node must be unreachable\n# for it to be considered in failure state.\n# Most other internal time limits are multiple of the node timeout.\ncluster-node-timeout 15000 #打开注释，启动cluster模式\n')])])]),s("p",[e._v("参考最低配置：https://redis.io/topics/cluster-tutorial\n"),s("em",[e._v("Note that the minimal cluster that works as expected requires to contain at least three master nodes.")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("redis-server conf/redis6379.conf\nredis-server conf/redis6380.conf\nredis-server conf/redis6381.conf\nredis-cli --cluster create <HOSTIP1>:6379 <HOSTIP1>:6380 <HOSTIP1>:6381 \\\n<HOSTIP2>:6379 <HOSTIP2>:6380 <HOSTIP2>:6381 \\\n<HOSTIP3>:6379 <HOSTIP3>:6380 <HOSTIP3>:6381 \\\n--cluster-replicas 2\n")])])]),s("p",[e._v("控制脚本：")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('REDIS_HOME=/opt/redis-5.0.5\npushd ${REDIS_HOME} &>/dev/null\n\nwhile [ "${1:0:1}" == "-" ]; do\n  case $1 in\n    --start)\n      echo "Starting redis nodes..."\n      redis-server conf/redis6379.conf\n      redis-server conf/redis6380.conf\n      redis-server conf/redis6381.conf\n      ;;\n    --kill)\n      echo "Stopping redis nodes..."\n      redis-cli -p 6379 shutdown\n      redis-cli -p 6380 shutdown\n      redis-cli -p 6381 shutdown\n          ;;\n    *)\n      echo "usage: --start|--kill"\n      exit 1\n      ;;\n  esac\n  shift\ndone\n\n')])])]),s("h2",{attrs:{id:"_2-集群管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-集群管理"}},[e._v("#")]),e._v(" 2. 集群管理")]),e._v(" "),s("h3",{attrs:{id:"_2-1-commands-gui"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-commands-gui"}},[e._v("#")]),e._v(" 2.1 Commands&GUI")]),e._v(" "),s("p",[e._v("https://redis.io/topics/rediscli")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("redis-cli --cluster help\n//连接\nredis-cli -c -h <HOSTIP> -p <PORT>\n\tcluster help\n\tcluster info\n\tcluster nodes\n\tcluster slots\n\treplicate NODEID\n\tcluster failover (on slave node)\n\t\tkeys * (Check empty)\n\t\tflushdb/flushall (on master nodes)\n\t\tcluster reset(soft/hard, chang slave to an empty ‘standalone’ master)\n\t\tSlaveof no one (change slave to master, cannot execute in cluster mode)\n\tSlave host port (change slave to replicate another master, cannot execute in cluster mode)\n//检查\t\nredis-cli --cluster check <HOSTIP>:<PORT>\n//修复\nredis-cli --cluster fix <HOSTIP>:<PORT>\nredis-cli -h <HOSTIP> -p <PORT> cluster meet <TARGETHOSTIP> <TARGETPORT>\nredis-cli cluster forget <NODEID> (cannot perform on itself or it’s slave)\nredis-cli --cluster del-node <HOSTIP>:<PORT> <NODEID>\n//add-node默认是empty master，也可以加参数指定为slave ()\nredis-cli --cluster add-node <HOSTIP>:<PORT> <ANOTHER HOSTIP>:<PORT> --cluster-slave --cluster-master-id <NODEID>\n\nredis-cli -p 7002 shutdown\nredis-cli -p 7002 debug segfault\n\nredis-cli --cluster reshard <ANYHOSTIP>:<ANYPORT> --cluster-yes\nredis-cli --cluster rebalance --cluster-threshold 1 <ANYHOSTIP>:<ANYPORT>\n\nclient list\nredis-cli INFO|grep db\nredis-cli INFO|grep db|wc -l\nredis-cli INFO keyspace\n\n--More:\nDatabase\nhttps://stackoverflow.com/questions/50534492/redis-how-to-get-current-database-name\nhttps://redis.io/commands/client-list\n\nredis implement stored procedure \nhttps://redis.io/commands/eval\n\n")])])]),s("p",[s("strong",[e._v("GUI:")]),e._v("\nuse colon as separator https://redisdesktop.com/\nDbeaver support nosql but only for enterprise edition\nOptionally we can choose fastoredis https://fastoredis.com/anonim_users_downloads")]),e._v(" "),s("h3",{attrs:{id:"_2-2-理论基础-theory"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-理论基础-theory"}},[e._v("#")]),e._v(" 2.2 理论基础 Theory")]),e._v(" "),s("p",[e._v("学习redis源码过程笔记、问题记录，通过代码阅读熟悉分布式NOSQL数据库redis cluster集群功能、主从复制，节点扩容、槽位迁移、failover故障切换、一致性选举完整分析，对理解redis源码很有帮助  https://github.com/daniel416/Reading-and-comprehense-redis/")]),e._v(" "),s("p",[e._v("https://redis.io/topics/cluster-spec")]),e._v(" "),s("p",[e._v("An introduction to Redis data types and abstractions https://redis.io/topics/data-types-intro")]),e._v(" "),s("p",[s("strong",[e._v("TCP PORTS:")]),e._v("\nEvery Redis Cluster node requires two TCP connections open. The normal Redis TCP port used to serve clients, for example 6379, plus the port obtained by adding 10000 to the data port, so 16379 in the example.")]),e._v(" "),s("p",[s("strong",[e._v("DATA SHARDING:")]),e._v("\n16384 slots, hash slot 哈希槽位,why ? https://cloud.tencent.com/developer/article/1042654\n16384这个数字也不是作者随意指定的，Redis集群内部使用位图（bit map）来标志一个slot是否被占用，为了减少集群之间信息交换的大小，信息的大小被固定为2048字节\n2048 bytes = 2^11 * 8 bit= 2^14 bit= 16384\n14 out of 16 CRC16 output bits are used (this is why there is a modulo 16384 operation in the formula above).")]),e._v(" "),s("p",[e._v("Hash tag and multiple key operations\nthis{foo}key and another{foo}key are guaranteed to be in the same hash slot, and can be used together in a command with multiple keys as arguments\nredis集群不支持模糊匹配partial match，想要模糊匹配只能对一个个server或database操作，不可以整体cluster操作，不过hash tag可以潜在解决这个问题")]),e._v(" "),s("p",[s("strong",[e._v("ConfigEpoch and current epoch")]),e._v("\nThis mechanism in Redis Cluster is called last failover wins.\nWhen a slave fails over its master, it obtains a configuration epoch which is guaranteed to be greater than the one of its master (and more generally greater than any other configuration epoch generated previously). For example node B, which is a slave of A, may failover B with configuration epoch of 4. It will start to send heartbeat packets (the first time mass-broadcasting cluster-wide) and because of the following second rule, receivers will update their hash slot tables")]),e._v(" "),s("p",[e._v("The same happens during reshardings. When a node importing a hash slot completes the import operation, its configuration epoch is incremented to make sure the change will be propagated throughout the cluster.")]),e._v(" "),s("blockquote",[s("p",[e._v("Practical example of configuration epoch usefulness during partitions\nThis section illustrates how the epoch concept is used to make the slave promotion process more resistant to partitions.")])]),e._v(" "),s("blockquote",[s("ul",[s("li",[e._v("A master is no longer reachable indefinitely. The master has three slaves A, B, C.")]),e._v(" "),s("li",[e._v("Slave A wins the election and is promoted to master.")]),e._v(" "),s("li",[e._v("A network partition makes A not available for the majority of the cluster.")]),e._v(" "),s("li",[e._v("Slave B wins the election and is promoted as master.")]),e._v(" "),s("li",[e._v("A partition makes B not available for the majority of the cluster.")]),e._v(" "),s("li",[e._v("The previous partition is fixed, and A is available again.\nAt this point B is down and A is available again with a role of master (actually UPDATE messages would reconfigure it promptly, but here we assume all UPDATE messages were lost). At the same time, slave C will try to get elected in order to fail over B. This is what happens:")])])]),e._v(" "),s("blockquote",[s("p",[e._v("1.C will try to get elected and will succeed, since for the majority of masters its master is actually down. It will obtain a new incremental configEpoch.\n2.A will not be able to claim to be the master for its hash slots, because the other nodes already have the same hash slots associated with a higher configuration epoch (the one of B) compared to the one published by A.\n3.So, all the nodes will upgrade their table to assign the hash slots to C, and the cluster will continue its operations.\nhttps://redis.io/topics/cluster-spec")])]),e._v(" "),s("p",[s("strong",[e._v("CONSISTENCY GUARANTEE:")]),e._v("\nRedis Cluster is not able to guarantee strong consistency. In practical terms this means that under certain conditions it is possible that Redis Cluster will lose writes that were acknowledged by the system to the client.\nTradeoff between Synchronous write and Performance")]),e._v(" "),s("p",[e._v("Redis Sentinel vs Redis Cluster:\nhttps://redislabs.com/redis-features/high-availability")]),e._v(" "),s("h3",{attrs:{id:"_2-3-自动方式管理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-自动方式管理"}},[e._v("#")]),e._v(" 2.3 自动方式管理")]),e._v(" "),s("p",[s("strong",[e._v("1.Replicas migration")])]),e._v(" "),s("p",[e._v("redis.conf:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('\n# Cluster replicas are able to migrate to orphaned masters, that are masters\n# that are left without working replicas. This improves the cluster ability\n# to resist to failures as otherwise an orphaned master can\'t be failed over\n# in case of failure if it has no working replicas.\n#\n# Replicas migrate to orphaned masters only if there are still at least a\n# given number of other working replicas for their old master. This number\n# is the "migration barrier". A migration barrier of 1 means that a replica\n# will migrate only if there is at least 1 other working replica for its master\n# and so forth. It usually reflects the number of replicas you want for every\n# master in your cluster.\n#\n# Default is 1 (replicas migrate only if their masters remain with at least\n# one replica). To disable migration just set it to a very large value.\n# A value of 0 can be set but is useful only for debugging and dangerous\n# in production.\n#\ncluster-migration-barrier 1\n\n\n')])])]),s("p",[s("strong",[e._v("2.consider use failover whenever make changes to master nodes")])]),e._v(" "),s("ol",[s("li",[e._v("Remove master node (one option is reshard the data to the other master nodes and then remove, An alternative to remove a master node is to perform a manual failover of it over one of its slaves and remove the node after it turned into a slave of the new master.)")]),e._v(" "),s("li",[e._v("Before shutdown")]),e._v(" "),s("li",[e._v("Upgrade master node (failover to its slave node first before upgrading, upgrade when it becomes a slave node)")])]),e._v(" "),s("p",[e._v("Use failover rather than manual allocate replica using “REPLICATE "),s("NODEID",[e._v("”")])],1),e._v(" "),s("blockquote",[s("p",[e._v("1.The replica tells the master to stop processing queries from clients.\n2.The master replies to the replica with the current replication offset.\n3.The replica waits for the replication offset to match on its side, to make sure it processed all the data from the master before it continues.\n4.The replica starts a failover, obtains a new configuration epoch from the majority of the masters, and broadcasts the new configuration.\n5.The old master receives the configuration update: unblocks its clients and starts replying with redirection messages so that they'll continue the chat with the new master.\nhttps://redis.io/commands/cluster-failover")])]),e._v(" "),s("p",[s("strong",[e._v("3.migration between clusters")]),e._v("\nThere is an alternative way to import data from external instances to a Redis Cluster, which is to use the "),s("code",[e._v("redis-cli --cluster import")]),e._v(" command.")]),e._v(" "),s("h3",{attrs:{id:"_2-4-手动方式管理-manual-way-not-recommend"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-手动方式管理-manual-way-not-recommend"}},[e._v("#")]),e._v(" 2.4 手动方式管理 Manual way (not recommend)")]),e._v(" "),s("p",[e._v("以下完全是我个人实验的总结：")]),e._v(" "),s("p",[e._v("如果主从都是在集群模式下（cluster-enable=yes），那么是无法使用非集群模式的命令，比如slaveof/replicaof\n"),s("strong",[e._v("1.del-node/add-node")]),e._v("\ndel-node如果是slave十分不推荐，因为启动时依然会记得其他节点，虽然可以forget大部分节点，但是无法forget它的master，所以再add-node会有问题，所以此时只能采用meet\nDel-node如果是master，首先要将master做reshard转移到其他master nodes，然后将其对应的slave nodes全部replicate其他的master nodes，以防重启master后，slave nodes仍然记得该master node")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("redis-cli --cluster del-node <HOSTIP>:<PORT> <NODEID>\nRedis-server conf/redis6379.conf\nadd-node默认是master，也可以加参数指定为slave\nredis-cli --cluster add-node <NEW HOSTIP>:<PORT> <ANY EXIST HOSTIP>:<PORT> --cluster-slave --cluster-master-id \n")])])]),s("p",[s("strong",[e._v("2.slaveof/replicaof")])]),e._v(" "),s("p",[e._v("注意再cluster集群模式下，是不可以手动分配的，可以更改slave配置，cluster-enabled=no然后再尝试")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("Slaveof no one (change slave to master)\nSlave host port (change slave to replicate another master)\n")])])]),s("p",[s("strong",[e._v("3.reset and meet")]),e._v("\nAfter reset, node become a standalone master node, and then execute meet")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("$redis-cli -p 6379\n127.0.0.1:6379> flushall\n127.0.0.1:6379> cluster reset\n127.0.0.1:6379> exit\nredis-cli -h <HOSTIP> -p <PORT> cluster meet <TARGETHOSTIP> <TARGETPORT>\n")])])]),s("p",[s("strong",[e._v("4. Final step: reshard or rebalance")])]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("redis-cli --cluster reshard <HOSTIP>:<PORT> --cluster-yes\nredis-cli --cluster rebalance --cluster-threshold 1 <HOSTIP>:<PORT>\n")])])]),s("p",[e._v("**5. allocate slave for master")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("成功尝试：\ncluster replicate <NODEID>\n\n失败尝试：\nredis-cli --cluster del-node <HOSTIP>:<PORT> <NODEID>\nredis-cli cluster forget <NODEID>\nredis-cli --cluster add-node <HOSTIP>:<PORT> <ANY EXIST HOSTIP>:<PORT> --cluster-slave --cluster-master-id <MASTER NODEID>\nhttps://www.jianshu.com/p/ff173ae6e478\n失败原因：Failed because cannot forget itself and it’s master!\n")])])]),s("h3",{attrs:{id:"_2-5-日常维护"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-5-日常维护"}},[e._v("#")]),e._v(" 2.5 日常维护")]),e._v(" "),s("p",[e._v("Read https://redis.io/topics/admin\nhttp://antirez.com/news/96")]),e._v(" "),s("blockquote",[s("p",[e._v("Securing Redis\n1.Make sure the port Redis uses to listen for connections (by default 6379 and additionally 16379 if you run Redis in cluster mode, plus 26379 for Sentinel) is firewalled, so that it is not possible to contact Redis from the outside world.\n2.Use a configuration file where the bind directive is set in order to guarantee that Redis listens on only the network interfaces you are using. For example only the loopback interface (127.0.0.1) if you are accessing Redis just locally from the same computer, and so forth.\n3.Use the requirepass option in order to add an additional layer of security so that clients will require to authenticate using the AUTH command.\n4.Use spiped or another SSL tunneling software in order to encrypt traffic between Redis servers and Redis clients if your environment requires encryption.")])]),e._v(" "),s("blockquote",[s("p",[e._v('Disabling of specific commands\nIt is possible to disable commands in Redis or to rename them into an unguessable name, so that normal clients are limited to a specified set of commands.\nFor instance, a virtualized server provider may offer a managed Redis instance service. In this context, normal users should probably not be able to call the Redis CONFIG command to alter the configuration of the instance, but the systems that provide and remove instances should be able to do so.\nIn this case, it is possible to either rename or completely shadow commands from the command table. This feature is available as a statement that can be used inside the redis.conf configuration file. For example:\nrename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52\nIn the above example, the CONFIG command was renamed into an unguessable name. It is also possible to completely disable it (or any other command) by renaming it to the empty string, like in the following example:\nrename-command CONFIG ""\nhttps://redis.io/topics/security')])]),e._v(" "),s("p",[s("strong",[e._v("Upgrade")]),e._v("\nIf you are using Redis Sentinel or Redis Cluster, the simplest way in order to upgrade to newer versions, is to upgrade a slave after the other, then perform a manual fail-over in order to promote one of the upgraded replicas as master, and finally promote the last slave.")]),e._v(" "),s("p",[s("strong",[e._v("Monitor")]),e._v("\nredis-cli memory doctor\nredis-cli latency doctor")]),e._v(" "),s("p",[e._v("Monitor:\nhttps://redis.io/commands/MONITOR")]),e._v(" "),s("h2",{attrs:{id:"_3-redis操作和系统集成-integration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-redis操作和系统集成-integration"}},[e._v("#")]),e._v(" 3. Redis操作和系统集成 Integration")]),e._v(" "),s("h3",{attrs:{id:"_3-0-redis基本数据操作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-0-redis基本数据操作"}},[e._v("#")]),e._v(" 3.0 Redis基本数据操作")]),e._v(" "),s("p",[e._v("https://redis.io/topics/data-types")]),e._v(" "),s("p",[e._v("https://redis.io/topics/data-types-intro")]),e._v(" "),s("table",[s("thead",[s("tr",[s("th",[e._v("数据类型")]),e._v(" "),s("th"),e._v(" "),s("th",[e._v("特性")]),e._v(" "),s("th",[e._v("场景")])])]),e._v(" "),s("tbody",[s("tr",[s("td",[e._v("String(字符串)")]),e._v(" "),s("td",[e._v("二进制安全 "),s("br"),e._v("Strings are the most basic kind of Redis value. Redis Strings are binary safe, this means that a Redis string can contain any kind of data, for instance a JPEG image or a serialized Ruby object."),s("br"),e._v("最大存储512M")]),e._v(" "),s("td"),e._v(" "),s("td",[e._v("将复杂对象序列化后存储，下面的hash只能存放key-value键值对的object")])]),e._v(" "),s("tr",[s("td",[e._v("Hash(字典)")]),e._v(" "),s("td",[e._v("键值对集合,即编程语言中的Map类型"),s("br"),e._v("完美代表对象：the perfect data type to represent objects (e.g. A User with a number of fields like name, surname, age, and so forth)"),s("br"),e._v("节省空间（内存？）：A hash with a few fields (where few means up to one hundred or so) is stored in a way that takes very little space, so you can store millions of objects in a small Redis instance."),s("br"),e._v("Every hash can store up to 2^32 - 1 field-value pairs (more than 4 billion).")]),e._v(" "),s("td",[e._v("适合存储对象,并且可以像数据库中update一个属性一样只修改某一项属性值(Memcached中需要取出整个字符串反序列化成对象修改完再序列化存回去)")]),e._v(" "),s("td",[e._v("HMSET user:1000 username antirez password P1pp0 age 34 "),s("br"),e._v("HGETALL user:1000 "),s("br"),e._v("HSET user:1000 password 12345")])]),e._v(" "),s("tr",[s("td",[e._v("List(列表)")]),e._v(" "),s("td",[e._v("链表(双向链表？)"),s("br"),e._v("Redis Lists are simply lists of strings(如果是list of object，object可以序列化为string存储), sorted by insertion order."),s("br"),e._v("The max length of a list is 2^32 - 1 elements (4294967295, more than 4 billion of elements per list).")]),e._v(" "),s("td",[e._v("增删快,提供了操作某一段元素的API")]),e._v(" "),s("td",[e._v("1,最新消息排行等功能(比如朋友圈的时间线) "),s("br"),e._v("2,消息队列")])]),e._v(" "),s("tr",[s("td",[e._v("Set(集合)")]),e._v(" "),s("td",[e._v("哈希表实现,元素不重复"),s("br"),e._v("The max number of members in a set is 2^32 - 1 (4294967295, more than 4 billion of members per set).")]),e._v(" "),s("td",[e._v("1、添加、删除,查找的复杂度都是O(1) 2、为集合提供了求交集、并集、差集等操作")]),e._v(" "),s("td",[e._v("1、共同好友"),s("br"),e._v(" 2、利用唯一性,统计访问网站的所有独立ip "),s("br"),e._v("3、好友推荐时,根据tag求交集,大于某个阈值就可以推荐")])]),e._v(" "),s("tr",[s("td",[e._v("Sorted Set(有序集合)")]),e._v(" "),s("td",[e._v("将Set中的元素增加一个权重参数score,元素按score有序排列")]),e._v(" "),s("td",[e._v("数据插入集合时,已经进行天然排序")]),e._v(" "),s("td",[e._v("1、排行榜"),s("br"),e._v(" 2、带权重的消息队列")])]),e._v(" "),s("tr",[s("td",[e._v("Bitmaps")]),e._v(" "),s("td"),e._v(" "),s("td"),e._v(" "),s("td")]),e._v(" "),s("tr",[s("td",[e._v("HyperLogLogs")]),e._v(" "),s("td"),e._v(" "),s("td"),e._v(" "),s("td")])])]),e._v(" "),s("p",[e._v("我在stackoverflow上面的相关解答：")]),e._v(" "),s("p",[e._v("https://stackoverflow.com/questions/46062283/what-is-the-difference-between-the-key-and-hash-key-parameters-used-in-a-redis-p/65406450#65406450")]),e._v(" "),s("blockquote",[s("p",[e._v("basically in your scenario:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("your key is: userid:store:multi_select_choices\nyour hashkey is: userid\nand your options objects serialized into jsonRedisValue\n")])])]),s("p",[e._v("in this case, you don't need to use:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("redisTemplate.opsForHash().put(key, hashKey, jsonRedisValue)\n")])])]),s("p",[e._v("instead you should use:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("redisTemplate.opsForValue().put(key, jsonRedisValue)\n")])])]),s("p",[e._v("here is a very good example for you to understand the scenario where opsForHash making sense:")]),e._v(" "),s("p",[e._v("first you must understand that hashes in redis is perfect representation for objects, so you don't need to serialize the object, but just store the object in the format of multiple key-value pairs, like for a userid=1000, the object has properties: username/password/age, you can simply store it on redis like this:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('redisTemplate.opsForHash().put("userid:1000", "username", "Liu Yue")\nredisTemplate.opsForHash().put("userid:1000", "password", "123456")\nredisTemplate.opsForHash().put("userid:1000", "age", "32")\n')])])]),s("p",[e._v("later on if you want to change the password, just do this:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('redisTemplate.opsForHash().put("userid:1000", "password", "654321")\n')])])]),s("p",[e._v("and the corresponding cmd using redis-cli:")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v('HMSET userid:1000 username \'Liu Yue\' password \'123456\' age 32\nHGETALL userid:1000\n1) "username"\n2) "Liu Yue"\n3) "password"\n4) "123456"\n5) "age"\n6) "32"\nHSET userid:1000 password \'654321\'\nHGETALL userid:1000\n1) "username"\n2) "Liu Yue"\n3) "password"\n4) "654321"\n5) "age"\n6) "32"\n')])])]),s("p",[e._v("I haven't explore too much the fundamental of how it implement hashes operation, but I think the difference between key and hashkey is quite obvious based on the documentation, key is just like the other redis key, normal string, hashkey is for the purpose of optimize the storage of the mutliple key-value pairs, so I guess there must be some kind of hash algorithm behind to ensure optimal memory storage and faster query and update.")]),e._v(" "),s("p",[e._v("and it's well documented here:")]),e._v(" "),s("p",[e._v("https://redis.io/topics/data-types")]),e._v(" "),s("p",[e._v("https://redis.io/topics/data-types-intro")])]),e._v(" "),s("h3",{attrs:{id:"_3-1-stackexchange-redis"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-stackexchange-redis"}},[e._v("#")]),e._v(" 3.1 StackExchange.Redis")]),e._v(" "),s("p",[e._v("Driver for .net: StackExchange.Redis 1.2https://github.com/StackExchange/StackExchange.Redis\nfor partial matching\nWhere are KEYS, SCAN, FLUSHDB etc? https://github.com/StackExchange/StackExchange.Redis/blob/41f427bb5ed8c23d0992a1411d0c92667b133d8e/docs/KeysScan.md")]),e._v(" "),s("h3",{attrs:{id:"_3-2-python"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-python"}},[e._v("#")]),e._v(" 3.2 Python")]),e._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("pip install --trusted-host pypi.org --trusted-host files.pythonhosted.org redis-py-cluster\n from rediscluster import StrictRedisCluster\n rc = StrictRedisCluster(startup_nodes=redis_nodes, decode_responses=True)\n\n>>> rc.smembers(\"bitcoin:stg_testnet:1514360\")\n>>> set([u'812853c7fe8bfa3f7d625895b3270245861f974f6ff19f8ce21317b5378be41e'])\n>>> https://github.com/Grokzen/redis-py-cluster/blob/unstable/tests/test_commands.py\n")])])]),s("h3",{attrs:{id:"_3-3-spring-boot-integration"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-spring-boot-integration"}},[e._v("#")]),e._v(" 3.3 Spring boot integration")]),e._v(" "),s("p",[e._v("spring-boot-starter-data-redis 依赖于spring-data-redis")]),e._v(" "),s("p",[e._v("spring-boot-starter-data-redis 使用：https://zhuanlan.zhihu.com/p/80325707")]),e._v(" "),s("p",[e._v("spring-data-redis 解析 https://juejin.im/post/5bac97606fb9a05cd8492e48")]),e._v(" "),s("p",[e._v("**序列化：**核心包是org.springframework.data.redis.serializer，想要自定义自己的序列化，实现RedisSerializer即可，默认有2种实现JdkSerializationRedisSerializer和StringRedisSerializer，RedisTemplate默认使用JdkSerializationRedisSerializer")]),e._v(" "),s("p",[s("strong",[e._v("RedisTemplate操作：")])]),e._v(" "),s("p",[e._v("opsForValue")]),e._v(" "),s("p",[e._v("opsForHash")]),e._v(" "),s("p",[e._v("opsForList")]),e._v(" "),s("p",[e._v("opsForSet")]),e._v(" "),s("p",[e._v("opsForZSet")]),e._v(" "),s("h2",{attrs:{id:"troubleshooting"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#troubleshooting"}},[e._v("#")]),e._v(" Troubleshooting")]),e._v(" "),s("p",[e._v("1.org.springframework.data.redis.RedisSystemException: Redis exception; nested exception is io.lettuce.core.RedisException: io.lettuce.core.RedisConnectionException: DENIED Redis is running in protected mode because protected mode is enabled, no bind address was specified, no authentication password is requested to clients. In this mode connections are only accepted from the loopback interface. If you want to connect from external computers to Redis you may adopt one of the following solutions: 1) Just disable protected mode sending the command 'CONFIG SET protected-mode no' from the loopback interface by connecting to Redis from the same host the server is running, however MAKE SURE Redis is not publicly accessible from internet if you do so. Use CONFIG REWRITE to make this change permanent. 2) Alternatively you can just disable the protected mode by editing the Redis configuration file, and setting the protected mode option to 'no', and then restarting the server. 3) If you started the server manually just for testing, restart it with the '--protected-mode no' option. 4) Setup a bind address or an authentication password. NOTE: You only need to do one of the above things in order for the server to start accepting connections from the outside.")]),e._v(" "),s("p",[e._v("SOLUTION: redis-server redis.conf")]),e._v(" "),s("p",[e._v("2.\"Unable to connect to Redis; nested exception is io.lettuce.core.RedisException: Cannot retrieve initial cluster partitions from initial URIs [RedisURI [host='192.168.56.101', port=6379]]\",\ntelnet result:")]),e._v(" "),s("p",[e._v("SOLUTION:\nCONFIG SET protected-mode no\nCONFIG REWRITE")]),e._v(" "),s("p",[e._v("3.ERR Protocol error: invalid bulk length")]),e._v(" "),s("p",[e._v("https://github.com/xetorthio/jedis/issues/1034\nhttps://stackoverflow.com/questions/6752894/predis-protocol-error-invalid-bulk-length")]),e._v(" "),s("p",[e._v("4.Timeout issue\nLine 15222: 2018-05-16 18:23:43,536 [32] DEBUG LaxinoV2Plugin - [Debug      ]Exception :\nTimeout performing GET USERREPORT:SSSLZ:LZ:20658216:2bc1af86-d47c-45b8-b552-2d0b1f2078e5, inst: 1, mgr: ExecuteSelect, err: never, queue: 4750554, qu: 0, qs: 4750554, qc: 0, wr: 0, wq: 0, in: 65536, ar: 0,\nclientName: TW-SSS-UGS, serverEndpoint: 10.22.103.166:6379, keyHashSlot: 5897, IOCP: (Busy=0,Free=1000,Min=2,Max=1000), WORKER: (Busy=1,Free=32766,Min=2,Max=32767),\nLocal-CPU: 37.95% (Please take a look at this article for some common client-side issues that can cause timeouts:")]),e._v(" "),s("p",[e._v("https://github.com/StackExchange/StackExchange.Redis/tree/master/Docs/Timeouts.md")]),e._v(" "),s("p",[e._v("5.[ERR] Node XXXX:6379 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0")]),e._v(" "),s("p",[e._v("$redis-cli -p 6379\n127.0.0.1:6379> flushall\nOK\n127.0.0.1:6379> cluster reset\nOK\n127.0.0.1:6379> exit")]),e._v(" "),s("ol",{attrs:{start:"6"}},[s("li",[e._v("issue raised by above ‘cluster rest’, the node become a standalone node, forgot other nodes!!!!")])]),e._v(" "),s("p",[e._v("redis-cli --cluster help\nredis-cli --cluster add-node "),s("HOSTIP",[e._v(":"),s("PORT",[s("ANY",{attrs:{EXIST:"",HOSTIP:""}},[e._v(":"),s("PORT",[e._v(" --cluster-slave\nRedis [ERR] Nodes don’t agree about configuration!\nhttps://hzkeung.com/2018/02/25/redis-trib-check\nredis-cli --cluster check "),s("HOSTIP",[e._v(":"),s("PORT",[e._v("\nredis-cli -h "),s("ANY",{attrs:{EXIST:"",HOSTIP:""}},[e._v(" -p "),s("PORT",[e._v(" cluster meet "),s("HOSTIP",[s("PORT")],1)],1)],1)],1)],1)],1)],1)],1)],1)],1),e._v(" "),s("ol",{attrs:{start:"7"}},[s("li",[e._v("promote slave node to master")])]),e._v(" "),s("p",[e._v("simply delete it and then meet or re-add it")]),e._v(" "),s("p",[e._v("redis-cli --cluster del-node "),s("HOSTIP",[e._v(":"),s("PORT",[s("NODEID")],1)],1)],1),e._v(" "),s("blockquote",[s("blockquote",[s("blockquote",[s("p",[e._v("Removing node xxxx from cluster xxxxx:6379\nSending CLUSTER FORGET messages to the cluster...\nSHUTDOWN the node.\nredis-cli -h "),s("ANY",{attrs:{EXIST:"",HOSTIP:""}},[e._v(" -p 6379 cluster meet "),s("NEW",{attrs:{HOSTIP:""}},[s("PORT",[e._v("\nredis-cli --cluster add-node "),s("NEW",{attrs:{HOSTIP:""}},[e._v(":"),s("PORT",[s("ANY",{attrs:{EXIST:"",HOSTIP:""}},[e._v(":"),s("PORT",[e._v("\nredis-cli --cluster rebalance "),s("NEW",{attrs:{HOSTIP:""}},[e._v(":"),s("PORT")],1)],1)],1)],1)],1)],1)],1)],1)],1)])])]),e._v(" "),s("ol",{attrs:{start:"8"}},[s("li",[e._v("failed delete node")])]),e._v(" "),s("p",[e._v("Solv: meet then delete\n$redis-cli --cluster del-node "),s("HOSTIP",[e._v(":"),s("PORT",[s("NODEID")],1)],1)],1),e._v(" "),s("blockquote",[s("blockquote",[s("blockquote",[s("p",[e._v("Removing node XXXXXXX from cluster XXXXX:6379\nSending CLUSTER FORGET messages to the cluster...\nNode XXXXX:6381 replied with error:\nERR Unknown node XXXXXXXX")])])])]),e._v(" "),s("p",[e._v("redis-cli -h "),s("ANY",{attrs:{EXIST:"",HOSTIP:""}},[e._v(" -p "),s("PORT",[e._v(" cluster meet "),s("HOSTIP",[s("PORT")],1)],1)],1)],1),e._v(" "),s("h2",{attrs:{id:"深度探索"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#深度探索"}},[e._v("#")]),e._v(" 深度探索")]),e._v(" "),s("h3",{attrs:{id:"内存优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内存优化"}},[e._v("#")]),e._v(" 内存优化")]),e._v(" "),s("p",[e._v("redis的opsForHash带来的内存空间优化 https://my.oschina.net/u/2382040/blog/2236871")]),e._v(" "),s("h3",{attrs:{id:"数据倾斜"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据倾斜"}},[e._v("#")]),e._v(" 数据倾斜")]),e._v(" "),s("p",[e._v("https://cloud.tencent.com/developer/article/1676492")]),e._v(" "),s("p",[e._v("big key")]),e._v(" "),s("p",[e._v("Scanning for big keys\nredis-cli --bigkeys")]),e._v(" "),s("p",[e._v("https://programming.vip/docs/ali-yun-redis-big-key-search-tool.html")]),e._v(" "),s("h3",{attrs:{id:"线程安全"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#线程安全"}},[e._v("#")]),e._v(" 线程安全")]),e._v(" "),s("p",[e._v("单线程，考虑是否原子操作")]),e._v(" "),s("p",[e._v("Get 判断")]),e._v(" "),s("p",[e._v("（时间窗口）")]),e._v(" "),s("p",[e._v("Set （多线程覆盖）")]),e._v(" "),s("p",[e._v("Setnx")]),e._v(" "),s("p",[e._v("谈谈Redis的SETNX https://huoding.com/2015/09/14/463")]),e._v(" "),s("p",[e._v("https://redis.io/commands/setnx")]),e._v(" "),s("p",[e._v("https://github.com/StackExchange/StackExchange.Redis/blob/86b983496d3307903ce9bc2a3c7f207de42a0dea/StackExchange.Redis/StackExchange/Redis/RedisDatabase.cs")])])}),[],!1,null,null,null);t.default=r.exports}}]);