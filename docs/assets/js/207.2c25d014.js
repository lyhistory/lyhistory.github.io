(window.webpackJsonp=window.webpackJsonp||[]).push([[207],{636:function(t,e,a){"use strict";a.r(e);var n=a(65),s=Object(n.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[a("a",{attrs:{href:"/docs/software"}},[t._v("回目录")]),t._v("  《玩转mybatis》")]),t._v(" "),a("p",[t._v("ORM - Object–relational mapping BY Mybatis")]),t._v(" "),a("p",[t._v("三种方式教你玩转mybatis的各种姿势，再也不怕各种config注解错误！")]),t._v(" "),a("p",[t._v("首先还是引用官方mybatis有什么好处吧：")]),t._v(" "),a("blockquote",[a("p",[t._v("MyBatis is an open source, lightweight, persistence framework. It is an alternative to JDBC and Hibernate. It automates the mapping between SQL databases and objects in Java, .NET, and Ruby on Rails. The mappings are decoupled from the application logic by packaging the SQL statements in XML configuration files.\nIt abstracts almost all of the JDBC code, and reduces the burden of setting of parameters manually and retrieving the results. It provides a simple API to interact with the database. It also provides support for custom SQL, stored procedures and advanced mappings.\nIt was formerly known as IBATIS, which was started by Clinton Begin in 2002. MyBatis 3 is the latest version. It is a total makeover of IBATIS.\nA significant difference between MyBatis and other persistence frameworks is that MyBatis emphasizes the use of SQL, while other frameworks such as Hibernate typically uses a custom query language i.e. the Hibernate Query Language (HQL) or Enterprise JavaBeans Query Language (EJB QL).")])]),t._v(" "),a("blockquote",[a("p",[t._v("MYBATIS offers the following advantages −\nSupports stored procedures − MyBatis encapsulates SQL in the form of stored procedures so that business logic can be kept out of the database, and the application is more portable and easier to deploy and test.\nSupports inline SQL − No pre-compiler is needed, and you can have the full access to all of the features of SQL.\nSupports dynamic SQL − MyBatis provides features for dynamic building SQL queries based on parameters.\nSupports O/RM − MyBatis supports many of the same features as an O/RM tool, such as lazy loading, join fetching, caching, runtime code generation, and inheritance.")])]),t._v(" "),a("p",[t._v("以下所有code均在私人repository: https://github.com/lyhistory/learn_coding/tree/master/java/Components/mybatis-demo")]),t._v(" "),a("h2",{attrs:{id:"_1-最基本的使用方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-最基本的使用方法"}},[t._v("#")]),t._v(" 1. 最基本的使用方法")]),t._v(" "),a("p",[t._v("https://mybatis.org/mybatis-3/getting-started.html\nhttps://www.tutorialspoint.com/mybatis/index.htm")]),t._v(" "),a("p",[t._v("** step 1. 依赖**")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("<dependency>\n\t<groupId>org.mybatis</groupId>\n\t<artifactId>mybatis</artifactId>\n\t<version>3.4.5</version>\n</dependency>\n<dependency>\n\t<groupId>mysql</groupId>\n\t<artifactId>mysql-connector-java</artifactId>\n\t<version>8.0.15</version>\n</dependency>\n")])])]),a("p",[t._v("** step 2. 配置config datasource and config mapper**")]),t._v(" "),a("p",[t._v("mybatis-config.xml:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('<?xml version="1.0" encoding="UTF-8" ?>\n<!DOCTYPE configuration\n  PUBLIC "-//mybatis.org//DTD Config 3.0//EN"\n  "http://mybatis.org/dtd/mybatis-3-config.dtd">\n<configuration>\n  <environments default="development">\n    <environment id="development">\n      <transactionManager type="JDBC"/>\n      <dataSource type="POOLED">\n        <property name="driver" value="com.mysql.cj.jdbc.Driver"/>\n        <property name="url" value="jdbc:mysql://127.0.0.1/test?characterEncoding=utf-8&amp;autoReconnect=true&amp;useSSL=false&amp;serverTimezone=Singapore"/>\n        <property name="username" value="dbuser"/>\n        <property name="password" value="password"/>\n      </dataSource>\n    </environment>\n  </environments>\n  <mappers>\n    <mapper resource="mybatis/mapping/StudentMapper.xml"/>\n  </mappers>\n</configuration>\t\n')])])]),a("p",[t._v("StudentMapper.xml")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('<?xml version = "1.0" encoding = "UTF-8"?>\n\n<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">\n\t\n<mapper namespace = "com.lyhistory.mybatis.StudentMapper">\n\n   <insert id = "insert" parameterType = "com.lyhistory.mybatis.table.StudentTable" useGeneratedKeys="true">\n   \t  <selectKey resultType="int" keyProperty="id" order="AFTER">\n            SELECT LAST_INSERT_ID()\n      </selectKey>\n      INSERT INTO student (NAME, BRANCH, PERCENTAGE, PHONE, EMAIL ) VALUES (#{name}, #{branch}, #{percentage}, #{phone}, #{email})\n   </insert>\n    \t\n</mapper>\n')])])]),a("p",[t._v("mapper.xml:注意Mapped Statements类型不要用错，比如mapper namespace, parameterType，resultMaps")]),t._v(" "),a("blockquote",[a("p",[t._v("Mapper XML is an important file in MyBatis, which contains a set of statements to configure various SQL statements such as select, insert, update, and delete. These statements are known as Mapped Statements or Mapped SQL Statements.")])]),t._v(" "),a("p",[t._v("** step 3. 调用 **")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('Reader reader = Resources.getResourceAsReader("mybatis/config/mybatis-config.xml");\n\t\tSqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(reader);\n\t\tSqlSession session = sqlSessionFactory.openSession();\n\nStudentTable student = new StudentTable("LY", "LYHISTORY.COM", 80, 88888888, "LYHISTORY@gmail.com");\n\nsession.insert("com.lyhistory.mybatis.StudentMapper.insert", student);\nSystem.out.println("record inserted successfully"); session.commit();\nsession.close();\n')])])]),a("h2",{attrs:{id:"_2-集成springboot"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-集成springboot"}},[t._v("#")]),t._v(" 2.集成Springboot")]),t._v(" "),a("p",[t._v("基本有两种方式：使用mybatis-spring或者用mybatis-spring-boot-starter，\n前者需要自定义mybatis config和scanner，后者starter已经都做好了，基本只需要配置，如果需要自定义需要严格按照文档来，不然会出现各种问题；")]),t._v(" "),a("p",[t._v("先创建一个spring boot程序，首先添加依赖")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("\x3c!-- integrate with spring boot --\x3e\n<dependency>\n\t<groupId>org.springframework.boot</groupId>\n\t<artifactId>spring-boot-starter-web</artifactId>\n\t<version>2.1.4.RELEASE</version>\n</dependency>\n\n<dependency>\n\t<groupId>com.alibaba</groupId>\n\t<artifactId>druid</artifactId>\n\t<version>1.1.10</version>\n</dependency>\n")])])]),a("p",[t._v("然后删除mybatis-config.xml里面的配置-mapper及db Connection，因为我们要采用auto mapper，并且用jdbc或者mybatis-starter的auto config spring.datasource的方式读取db配置；")]),t._v(" "),a("h3",{attrs:{id:"_2-1-使用mybatis-spring"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-使用mybatis-spring"}},[t._v("#")]),t._v(" 2.1 使用mybatis-spring")]),t._v(" "),a("p",[t._v("添加依赖：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("\x3c!--Method 1 Mybatis Spring --\x3e\n<dependency>\n\t<groupId>org.mybatis</groupId>\n\t<artifactId>mybatis</artifactId>\n\t<version>3.4.5</version>\n</dependency>\n<dependency>\n\t<groupId>org.mybatis</groupId>\n\t<artifactId>mybatis-spring</artifactId>\n\t<version>1.3.1</version>\n</dependency>\n")])])]),a("p",[t._v("application.properties:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("spring.datasource.driverClassName=com.mysql.cj.jdbc.Driver\nspring.datasource.url=jdbc:mysql://127.0.0.1/test?characterEncoding=utf-8&autoReconnect=true&useSSL=false&serverTimezone=Singapore\nspring.datasource.username=user\nspring.datasource.password=password\n")])])]),a("p",[t._v("自定义MyBatisConfiguration")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('@Configuration\npublic class MyBatisConfiguration { \n\t@Value("${spring.datasource.driverClassName}")\n    private String jdbcDriverClassName;\n\t\n\t@Value("${spring.datasource.url}")\n    private String jdbcUrl;\n\n    @Value("${spring.datasource.username}")\n    private String jdbcUsername;\n\n    @Value("${spring.datasource.password}")\n    private String jdbcPassword;\n    \n\t@Bean(name = "dataSource",destroyMethod = "close")\n    public DataSource dataSource() {\n    \tDruidDataSource datasource = new DruidDataSource();\n    \tdatasource.setDriverClassName(jdbcDriverClassName);\n    \tdatasource.setUrl(jdbcUrl);\n    \tdatasource.setUsername(jdbcUsername);\n    \tdatasource.setPassword(jdbcPassword);\n    \tdatasource.setMaxActive(20);\n    \tdatasource.setMinIdle(5);\n        return datasource;\n    }\n\t\n\t@Bean(name = {"sqlSessionFactory"})\n\t@ConditionalOnMissingBean(name = {"sqlSessionFactory"})\n\tpublic SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {\n\t\t\t\n\t\tSqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean();\n\t\tsqlSessionFactoryBean.setDataSource(dataSource);\n\t\tsqlSessionFactoryBean.setTypeAliasesPackage("com.lyhistory.mybatis.table");\n\t\tsqlSessionFactoryBean.setConfigLocation(new ClassPathResource("mybatis/config/mybatis-config.xml"));\n\t\tsqlSessionFactoryBean.setMapperLocations(\n\t\t\t\t(new PathMatchingResourcePatternResolver()).getResources("classpath*:mybatis/mapping/*_spring.xml"));\n\t\treturn sqlSessionFactoryBean.getObject();\n\t}\n}\n')])])]),a("p",[t._v("然后自定义MapperScanner")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('@Configuration\n@AutoConfigureAfter(MyBatisConfiguration.class)\npublic class MyBatisMapperScannerConfig {\n\n\t@Bean(name = "MapperScannerConfigurer")\n\tpublic MapperScannerConfigurer mapperScannerConfigurer() {\n\t\tMapperScannerConfigurer mapperScannerConfigurer = new MapperScannerConfigurer();\n\t\tmapperScannerConfigurer.setSqlSessionFactoryBeanName("sqlSessionFactory");\n\t\tmapperScannerConfigurer.setBasePackage("com.lyhistory.mybatis.springboot.mybatis_spring");\n\t\treturn mapperScannerConfigurer;\n\t}\n}\n')])])]),a("p",[t._v('发现无法读取\n@Value("${spring.datasource.driverClassName}")\nprivate String jdbcDriverClassName;')]),t._v(" "),a("p",[t._v("所以需要resolve config spring.datasource.* in application.properties，添加jdbc starter依赖,\n不然因为我们配置了application.properties或者ymal的spring.datasource，会引起报错 Spring Security : java.lang.ClassNotFoundException: org.springframework.dao.support.DaoSupport\n不得不感叹spring boot太智能了！")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("<dependency>\n\t<groupId>org.springframework.boot</groupId>\n\t<artifactId>spring-boot-starter-jdbc</artifactId>\n\t<version>2.1.4.RELEASE</version>\n</dependency>\n")])])]),a("p",[t._v("这个jdbc starter用org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration和DataSourceProperties来从配置文件读取装配spring.datasource")]),t._v(" "),a("p",[t._v("StudentMapper.xml跟前面类似，只是因为我们改成了@Mapper interface，所以xml里面的mapper namespace相应改下即可")]),t._v(" "),a("h3",{attrs:{id:"_2-2-使用mybatis-starter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-使用mybatis-starter"}},[t._v("#")]),t._v(" 2.2 使用mybatis starter")]),t._v(" "),a("p",[t._v("offical intruction: http://mybatis.org/spring-boot-starter/mybatis-spring-boot-autoconfigure/")]),t._v(" "),a("p",[t._v("添加依赖：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("<dependency>\n\t<groupId>org.mybatis.spring.boot</groupId>\n\t<artifactId>mybatis-spring-boot-starter</artifactId>\n\t<version>2.1.1</version>\n</dependency>\n")])])]),a("p",[t._v("而且可以删除前面的jdbc依赖，因为这个starter已经引入了spring-boot-starter-jdbc")]),t._v(" "),a("p",[t._v("application.properties:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("mybatis.mapper-locations=classpath*:mybatis/mapping/*_starter.xml\n")])])]),a("p",[t._v("StudentMapper.xml跟前面类似")]),t._v(" "),a("p",[t._v("默认不需要自定义mybatis mapper config和scanner，因为mybatis starter已经默认在autoconfigure实现了，全在org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration里面，\n顺便学习下人家的依赖顺序定义")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("@org.springframework.context.annotation.Configuration\n@ConditionalOnClass({ SqlSessionFactory.class, SqlSessionFactoryBean.class })\n@ConditionalOnBean(DataSource.class)\n@EnableConfigurationProperties(MybatisProperties.class)\n@AutoConfigureAfter(DataSourceAutoConfiguration.class)\npublic class MybatisAutoConfiguration {\n")])])]),a("p",[t._v("可以看到是先等待@AutoConfigureAfter(DataSourceAutoConfiguration.class)，DataSourceAutoConfiguration就是jdbc根据配置初始化的类；")]),t._v(" "),a("h2",{attrs:{id:"_3-troubleshooting"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-troubleshooting"}},[t._v("#")]),t._v(" 3.troubleshooting")]),t._v(" "),a("p",[t._v("?# mybatis java.lang.NullPointerException: nullat java.util.concurrent.ConcurrentHashMap.putVal(C")]),t._v(" "),a("p",[t._v("solved：极有可能是连不上db")]),t._v(" "),a("p",[t._v("?# Autowired的Mapper是null:")]),t._v(" "),a("p",[t._v("solved： 创建restController，在service中autowired，原因：")]),t._v(" "),a("blockquote",[a("p",[t._v("在SpringMVC框架中，我们经常要使用@Autowired注解注入Service或者Mapper接口，我们也知道，在controller层中注入service接口，在service层中注入其它的service接口或者mapper接口都是可以的，但是如果我们要在我们自己封装的Utils工具类中或者非controller普通类中使用@Autowired注解注入Service或者Mapper接口，直接注入是不可能的，因为Utils使用了静态的方法，我们是无法直接使用非静态接口的，当我们遇到这样的问题，我们就要想办法解决了。\nhttps://blog.csdn.net/qiulingxin/article/details/78068314")])]),t._v(" "),a("p",[t._v("?# The @ConfigurationProperties annotation injects null values when decorates a @Bean method in a @Configuration class\nhttps://github.com/micronaut-projects/micronaut-spring/issues/19\nhttps://www.bbsmax.com/A/B0zqgpZr5v/")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("ref：")]),t._v(" "),a("p",[t._v("The Multiple DataSource Demo for MyBatis Spring Boot"),a("br"),t._v("\nhttps://github.com/kazuki43zoo/mybatis-spring-boot-multi-ds-demo\nhttps://github.com/mybatis/spring-boot-starter/issues/78")]),t._v(" "),a("p",[t._v("spring(boot) mybatis整合\nhttps://www.cnblogs.com/liliqiang/articles/8723490.html")]),t._v(" "),a("p",[t._v("SpringBoot整合mybatis的mybatis-spring的配置方式\nhttps://my.oschina.net/bianxin/blog/1602958")]),t._v(" "),a("p",[t._v("@ConfigurationProperties 注解使用姿势，这一篇就够了\nhttps://www.cnblogs.com/jimoer/p/11374229.html")]),t._v(" "),a("p",[t._v("Resolving “Failed to Configure a DataSource” Error")]),t._v(" "),a("p",[t._v("By design, Spring Boot auto-configuration tries to configure the beans automatically based on the dependencies added to the classpath.\nhttps://www.baeldung.com/spring-boot-failed-to-configure-data-source")]),t._v(" "),a("p",[t._v("Guide to @ConfigurationProperties in Spring Boot\nhttps://www.baeldung.com/configuration-properties-in-spring-boot")]),t._v(" "),a("p",[t._v("SpringBoot中DataSource配置@ConfigurationProperties注解的坑\nhttps://www.jianshu.com/p/8ebf0b51538d")]),t._v(" "),a("disqus")],1)}),[],!1,null,null,null);e.default=s.exports}}]);