<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>计算机基础教程</title>
    <meta name="description" content="软件开发教程，白帽黑客入门教程，区块链入门教程，物联网，大数据">
    
    
    <link rel="preload" href="/docs/assets/css/0.styles.89d6372f.css" as="style"><link rel="preload" href="/docs/assets/js/app.8a2be1ce.js" as="script"><link rel="preload" href="/docs/assets/js/2.dc5756d7.js" as="script"><link rel="preload" href="/docs/assets/js/41.dbe85fea.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.2d7387f5.js"><link rel="prefetch" href="/docs/assets/js/100.cafeb0a6.js"><link rel="prefetch" href="/docs/assets/js/101.24f272af.js"><link rel="prefetch" href="/docs/assets/js/102.52bf251a.js"><link rel="prefetch" href="/docs/assets/js/103.98c00803.js"><link rel="prefetch" href="/docs/assets/js/104.b8fde009.js"><link rel="prefetch" href="/docs/assets/js/105.376f32a8.js"><link rel="prefetch" href="/docs/assets/js/106.5387a83e.js"><link rel="prefetch" href="/docs/assets/js/107.ee901bdb.js"><link rel="prefetch" href="/docs/assets/js/108.c13215f7.js"><link rel="prefetch" href="/docs/assets/js/109.0bd91806.js"><link rel="prefetch" href="/docs/assets/js/11.11c6c11c.js"><link rel="prefetch" href="/docs/assets/js/110.b1a9786b.js"><link rel="prefetch" href="/docs/assets/js/111.713d6966.js"><link rel="prefetch" href="/docs/assets/js/112.277df4a9.js"><link rel="prefetch" href="/docs/assets/js/113.7d39aae5.js"><link rel="prefetch" href="/docs/assets/js/114.d0ce2748.js"><link rel="prefetch" href="/docs/assets/js/115.7e353c61.js"><link rel="prefetch" href="/docs/assets/js/116.42c79d3b.js"><link rel="prefetch" href="/docs/assets/js/117.d711c0d9.js"><link rel="prefetch" href="/docs/assets/js/118.6a3d4e81.js"><link rel="prefetch" href="/docs/assets/js/119.1a9ca0c1.js"><link rel="prefetch" href="/docs/assets/js/12.a87e6cd9.js"><link rel="prefetch" href="/docs/assets/js/120.b6490544.js"><link rel="prefetch" href="/docs/assets/js/13.248682a4.js"><link rel="prefetch" href="/docs/assets/js/14.5d393d7e.js"><link rel="prefetch" href="/docs/assets/js/15.02814607.js"><link rel="prefetch" href="/docs/assets/js/16.fb20a517.js"><link rel="prefetch" href="/docs/assets/js/17.f578ebfd.js"><link rel="prefetch" href="/docs/assets/js/18.95b82826.js"><link rel="prefetch" href="/docs/assets/js/19.aa21d858.js"><link rel="prefetch" href="/docs/assets/js/20.cef445dc.js"><link rel="prefetch" href="/docs/assets/js/21.2eefc97b.js"><link rel="prefetch" href="/docs/assets/js/22.42b6a1fa.js"><link rel="prefetch" href="/docs/assets/js/23.2b527ccb.js"><link rel="prefetch" href="/docs/assets/js/24.538b7237.js"><link rel="prefetch" href="/docs/assets/js/25.1c131461.js"><link rel="prefetch" href="/docs/assets/js/26.2b25e66e.js"><link rel="prefetch" href="/docs/assets/js/27.197729bd.js"><link rel="prefetch" href="/docs/assets/js/28.730772b9.js"><link rel="prefetch" href="/docs/assets/js/29.c5f11217.js"><link rel="prefetch" href="/docs/assets/js/3.014ba758.js"><link rel="prefetch" href="/docs/assets/js/30.6eed025d.js"><link rel="prefetch" href="/docs/assets/js/31.21aa052e.js"><link rel="prefetch" href="/docs/assets/js/32.432a7e13.js"><link rel="prefetch" href="/docs/assets/js/33.e5457a16.js"><link rel="prefetch" href="/docs/assets/js/34.a3f8a897.js"><link rel="prefetch" href="/docs/assets/js/35.0304c0de.js"><link rel="prefetch" href="/docs/assets/js/36.58673bf5.js"><link rel="prefetch" href="/docs/assets/js/37.64103d47.js"><link rel="prefetch" href="/docs/assets/js/38.27dd35cc.js"><link rel="prefetch" href="/docs/assets/js/39.aedf8603.js"><link rel="prefetch" href="/docs/assets/js/4.7d1e56e0.js"><link rel="prefetch" href="/docs/assets/js/40.5b5cb1e2.js"><link rel="prefetch" href="/docs/assets/js/42.d59af01c.js"><link rel="prefetch" href="/docs/assets/js/43.a8c540fd.js"><link rel="prefetch" href="/docs/assets/js/44.5dac34ca.js"><link rel="prefetch" href="/docs/assets/js/45.8b7f5443.js"><link rel="prefetch" href="/docs/assets/js/46.be655593.js"><link rel="prefetch" href="/docs/assets/js/47.834756aa.js"><link rel="prefetch" href="/docs/assets/js/48.70a8d91d.js"><link rel="prefetch" href="/docs/assets/js/49.80cc9ef9.js"><link rel="prefetch" href="/docs/assets/js/5.540a7edc.js"><link rel="prefetch" href="/docs/assets/js/50.94f97a0f.js"><link rel="prefetch" href="/docs/assets/js/51.dff24a08.js"><link rel="prefetch" href="/docs/assets/js/52.34470a16.js"><link rel="prefetch" href="/docs/assets/js/53.8e23d14d.js"><link rel="prefetch" href="/docs/assets/js/54.af5a5aa0.js"><link rel="prefetch" href="/docs/assets/js/55.7fedc1ff.js"><link rel="prefetch" href="/docs/assets/js/56.50976042.js"><link rel="prefetch" href="/docs/assets/js/57.396d2fe3.js"><link rel="prefetch" href="/docs/assets/js/58.fac54dc7.js"><link rel="prefetch" href="/docs/assets/js/59.7b812681.js"><link rel="prefetch" href="/docs/assets/js/6.1b27be8a.js"><link rel="prefetch" href="/docs/assets/js/60.eb948815.js"><link rel="prefetch" href="/docs/assets/js/61.4480a52f.js"><link rel="prefetch" href="/docs/assets/js/62.992e101e.js"><link rel="prefetch" href="/docs/assets/js/63.ab236f9e.js"><link rel="prefetch" href="/docs/assets/js/64.4518c98f.js"><link rel="prefetch" href="/docs/assets/js/65.aea246c3.js"><link rel="prefetch" href="/docs/assets/js/66.5eca3804.js"><link rel="prefetch" href="/docs/assets/js/67.428ecd21.js"><link rel="prefetch" href="/docs/assets/js/68.fc06821a.js"><link rel="prefetch" href="/docs/assets/js/69.07b4717b.js"><link rel="prefetch" href="/docs/assets/js/7.e41d4d76.js"><link rel="prefetch" href="/docs/assets/js/70.8c26b0f1.js"><link rel="prefetch" href="/docs/assets/js/71.08d1ac4f.js"><link rel="prefetch" href="/docs/assets/js/72.95ba2971.js"><link rel="prefetch" href="/docs/assets/js/73.080b6938.js"><link rel="prefetch" href="/docs/assets/js/74.dbf408f9.js"><link rel="prefetch" href="/docs/assets/js/75.e9cb2338.js"><link rel="prefetch" href="/docs/assets/js/76.3ce4460f.js"><link rel="prefetch" href="/docs/assets/js/77.aae7d6a7.js"><link rel="prefetch" href="/docs/assets/js/78.5bea9782.js"><link rel="prefetch" href="/docs/assets/js/79.1162980b.js"><link rel="prefetch" href="/docs/assets/js/8.6487e249.js"><link rel="prefetch" href="/docs/assets/js/80.b0424f86.js"><link rel="prefetch" href="/docs/assets/js/81.deb02172.js"><link rel="prefetch" href="/docs/assets/js/82.68e73ce0.js"><link rel="prefetch" href="/docs/assets/js/83.c7f46dc4.js"><link rel="prefetch" href="/docs/assets/js/84.aa3d539c.js"><link rel="prefetch" href="/docs/assets/js/85.8c9ca428.js"><link rel="prefetch" href="/docs/assets/js/86.a77faa33.js"><link rel="prefetch" href="/docs/assets/js/87.8a20dca3.js"><link rel="prefetch" href="/docs/assets/js/88.62b80301.js"><link rel="prefetch" href="/docs/assets/js/89.7fdec892.js"><link rel="prefetch" href="/docs/assets/js/9.465f1c60.js"><link rel="prefetch" href="/docs/assets/js/90.58ccf92f.js"><link rel="prefetch" href="/docs/assets/js/91.2925281f.js"><link rel="prefetch" href="/docs/assets/js/92.d780bd79.js"><link rel="prefetch" href="/docs/assets/js/93.d75d7c6f.js"><link rel="prefetch" href="/docs/assets/js/94.4bff2050.js"><link rel="prefetch" href="/docs/assets/js/95.fbf6c370.js"><link rel="prefetch" href="/docs/assets/js/96.0310b663.js"><link rel="prefetch" href="/docs/assets/js/97.004bf55e.js"><link rel="prefetch" href="/docs/assets/js/98.4453df6e.js"><link rel="prefetch" href="/docs/assets/js/99.386ee850.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.89d6372f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><!----> <span class="site-name">计算机基础教程</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">机器指令</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link">软件基础</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link router-link-active">白帽黑客</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">区块链</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">机器指令</a></div><div class="nav-item"><a href="/docs/software/" class="nav-link">软件基础</a></div><div class="nav-item"><a href="/docs/coder2hacker/" class="nav-link router-link-active">白帽黑客</a></div><div class="nav-item"><a href="/docs/blockchain/" class="nav-link">区块链</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/software/" class="sidebar-link">软件基础</a></li><li><a href="/docs/coder2hacker/" class="sidebar-link">黑客入门</a></li><li><a href="/docs/blockchain/" class="sidebar-link">区块链入门</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>who are you talking to ?</p> <p>client和server如何互相确认</p> <p>两个问题，client怎么知道自己是跟目标server通信，比如gmail服务器而不是黑客服务器；
server怎么知道是这个用户在跟自己通信而不是</p> <p>1.ssh
ssh连接server，第一次连接时会有fingerprint提示信息，一般我们都忽略这个提示，yes记住fingerprint，
如果第一次就是黑客劫持的对话那就没办法了，第一次之后就可以放心，因为client已经记住了server的fingerprint，不会被黑客欺骗；</p> <p>server怎么记住client呢，我们将client端自签名的证书扔到server上，一般是.ssh目录</p> <p>2.web app
http明文不安全；
https通信是http建立在tls上，最新的tls1.3，client会validate server：通过验证CA证书，
如果黑客获取了合法的CA或者通过手段将自己的自签名证书安装到用户电脑，就可以进行中间人攻击；</p> <p>我们进行流量抓取和监听采用的方法就是自签名证书，挂代理的方式；
同理一般公司都会自签证书，安装到每台机器上，这样就可以监控每台电脑的流量；</p> <p>这些是正常的监控，但是怎么避免被黑客采用了类似手段进行监控呢，跟ssh中fingerprint类似思想，引入key pinning:</p> <ul><li>public key pinning
recommend, never change</li> <li>certificate pinning
not recommend, may expire</li> <li>subject public key info pinning<div class="language- extra-class"><pre class="language-text"><code>example in https://en.wikipedia.org/wiki/X.509
Subject Public Key Info:
        Public Key Algorithm: id-ecPublicKey
            Public-Key: (256 bit)
        pub: 
                00:c9:22:69:31:8a:d6:6c:ea:da:c3:7f:2c:ac:a5:
                af:c0:02:ea:81:cb:65:b9:fd:0c:6d:46:5b:c9:1e:
                9d:3b:ef
            ASN1 OID: prime256v1
            NIST CURVE: P-256
			
</code></pre></div><blockquote><p>HPKP is a Trust on First Use (TOFU) technique. The first time a web server tells a client via a special HTTP header which public keys belong to it, the client stores this information for a given period of time. When the client visits the server again, it expects at least one certificate in the certificate chain to contain a public key whose fingerprint is already known via HPKP. If the server delivers an unknown public key, the client should present a warning to the user.
https://developer.mozilla.org/en-US/docs/Web/HTTP/Public_Key_Pinning</p></blockquote></li></ul> <p>第一次访问会返回response header携带public key或者subject public key info，一般都是一年才过期，client浏览器会记住对应的domain和public key信息，
这样第一次（除外）之后，如果发生黑客劫持，黑客只要无法提供已经记录的public key信息（当然是需要签名的），或者说无法提供certificate chain上面的任何一个public key信息，
则浏览器会拒绝或者warning；
坏处是万一管理员配错了一次key，浏览器会记住一年，除了手动去清理（普通用户无法做到），没有办法revoke，这就有个问题：
Problem: hostile pinning
If the unthinkable — server compromise! — happens, the attacker could set a new pin set for their own server. The attacker could:
● Lock clients into the attacker’s server
● Deny service to the site, long-term
In many cases, though, server compromise enables so many extreme losses that hostile pinning pales in comparison.
解决方案是这个http based key pinning header被Deprecated</p> <p>还有个有意思的问题，如果一个https网站，用户访问的时候不小心输入了http的连接，一般服务器端会301 redirect，这样就产生了安全问题，称为https strip，具体不再赘述，
由这个问题引入了HSTS header，第一次访问（除外）之后都会在client浏览器端做307 internal redirect，直接将http加上s；</p> <blockquote><p>Most users don’t specify the protocol in URLs typed into the address bar, so if you request www.netsparker.com (or just netsparker.com), the browser will assume the default HTTP protocol and send an HTTP request to http://www.netsparker.com. Because the Netsparker site uses HSTS to enforce HTTPS-only communication, it responds with a redirect to the HTTPS site (301 response code) and includes the Strict-Transport-Security response header to indicate that only the HTTPS version of the site will be served.
NTP Attacks on HSTS
For the present, HSTS is a fairly robust way of enforcing HTTPS connections. The only practical approach to compromising HSTS is based on attacks against the Network Time Protocol (NTP) that attempt to manipulate system time by faking time values from NTP servers. This allows attackers to fool the browser into expiring HSTS entries and allowing insecure HTTP connections. Note that this is not a problem intrinsic to HSTS – NTP vulnerabilities can also be used for attacks against other security technologies and protocols, including SSL/TLS, Kerberos and Active Directory.
https://www.netsparker.com/blog/web-security/http-strict-transport-security-hsts/</p></blockquote> <p>hsts还引入了“super” cookie的问题，注意跟https://en.wikipedia.org/wiki/HTTP_cookie#Supercookie 这个不一样，</p> <blockquote><p>Why &quot;super&quot;?
First, it's much harder to get rid of compared to regular cookie: most of modern browsers provide user with no interface to manage HSTS storage. Second, in some browsers (mostly in Chromium-based) HSTS cookie will remain even when site is accessed in &quot;private mode&quot;. Third, Safari iOS and OS X, when connected to iCloud, share and sync HSTS storage across devices, so being marked on one machine user becomes trackable on all his devices. See below for details.
http://hsts.nevkontakte.com/
先讲解下通常的cookie，我们从浏览器的cookie删除就删除了，
下一次访问，server会给一个新的cookie，通常的广告tracking也基本都是，比如访问 a.com，嵌入的三方广告商ad.com会设置一个cookie（因为网站主主动嵌入，所以广告商会给网站主一个id），只要用户不手动清除，之后用户访问b.com刚好同样嵌入了ad.com广告，
此时ad.com就可以读取之前设置的cookie，如果有值，ad.com后台就可以通过cookie值和分配给这些网站主的id来确认这个用户访问过比如很多编程相关的网站，所以就可以定制推送编程广告；</p></blockquote> <p>hsts “super” cookie工作原理</p> <blockquote><p>a website might contain multiple single-pixel beacons, each requested over HTTP from a different subdomain controlled by the attacker. By specifying or omitting HSTS headers in specific replies, the attacker can store a potentially unique pattern in the browser’s HSTS database, in effect assigning a fingerprint. When the browser visits the site again, it will attempt to use HTTPS to load the beacons that initially had the HSTS header in replies, and plain HTTP for the remaining ones. By reading this pattern, the attacker can identify and track the returning browser. No cookies are used, and fingerprinting works across multiple sessions and regardless of incognito mode, so these identifiers have been dubbed “supercookies”.
https://www.netsparker.com/blog/web-security/http-strict-transport-security-hsts/
意思是一个恶意网站可以abuse hsts，比如用户<strong>第一次</strong>访问evil.com，evil.com会做几件事情：
1）生成一个8位unique id给用户，比如0000 0001，0代表http，1代表https，
2）根据这个id对应返回给用户一个html页面包含8个资源：</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>	0bit.evil.com/test.css
	1bit.evil.com/test.css
	....
	7bit.evil.com/test.css
	
0bit对应0000 0001的1，其他对应这些0，访问0bit.evil.com/test.css则header返回Strict-Transport-Security: &quot;max-age=31536000&quot;, forcing all further requests to that subdomain to be sent over HTTPS；
访问1bit.evil.com/test.css等则是Strict-Transport-Security: &quot;max-age=0&quot;, allowing further requests to that subdomain to be sent over plain HTTP.

</code></pre></div><p>即使我们不写入任何cookie给这个用户，等到下一次用户再来访问evil.com，我们仍然知道这个用户是0000 0001，how？
很容易，evil.com通过请求这个8个资源是http(0)还是https(1)就可以重组0000 0001，从而定位用户；
https://security.stackexchange.com/questions/79518/what-are-hsts-super-cookies/79522</p> <p>然后想办法将evil.com嵌入到其他网站，比如通过论坛群聊窗口等，当然了也可以通过分析evil.com的来源refer url来给用户画像；</p> <p>上面都是说client通常是浏览器怎么确保server身份，那么server怎么确认client的身份呢，从https或者tls的角度，server不care！
因为这是通信协议，不care很正常，但是应用层通常是需要根据业务需求对用户进行authenticate然后才能authorize，
authenticate则通常是通过cookie和session的方式进行维护用户对话状态，这就引入了csrf，xssi，xss等攻击方式</p> <p>3.desktop software and app</p> <p>app和server之间可以通过https通信也可以通过其他协议通信，大致的攻防策略跟上面类似；</p> <p>不同的是：</p> <p>app我们开发之后是安装在用户端的，所以很自然的我们可以将前面说的key pinning公钥信息直接写死到app安装包里面，
app packaged and shipped with baked in public key, so it can verify the information from server;</p> <p>然后对于ios app，需要开发者签名，并且提交到apple，申请让apple签名，类似于CA的工作原理，这样才可以跟外界通信；</p> <p>然后对于桌面软件也是类似，分几种情况说明：</p> <p>1）桌面软件表现为跟浏览器类似的行为，走http通过internet去跟外界部署的比如某个web server通信，这样是默认允许的，一般操作系统默认80开启；</p> <p>2）但是如果反过来incoming connection，比如桌面软件自己开启了一个http server是比较危险的，具体参照我之前讲到的zoom漏洞案例分析，比如在本机监听某个端口（当然肯定是非80端口），
如果不指定127.0.0.1，则默认绑定所有网卡（有时候是只绑定ipv6），这样局域网内任意机器都可以访问，当然默认防火墙会屏蔽掉外部连接过来的流量When bound to all interfaces, incoming connections are usually still blocked by the operating system firewall；
如果需要从外部连接一般需要加防火墙设置，可以手动或者当你安装软件的时候，软件会自动设置（一般会问同意或者弹出admin权限请求“Windows firewall has blocked some features of this app”，一般没人去看）；
如果是mac电脑，跟ios app一样，还需要申请apple的签名才能加入防火墙白名单！；
经过这些设置，外界（软件的服务器端）就可以跟安装在用户电脑的应用发起通信了，当然软件内部肯定也要一份白名单来限制不要任意ip都能连过来！</p> <p>而我说软件在本地开启http server比较危险是因为，不管你设置没设置防火墙，黑客都无所谓，因为黑客可以这样做：
当用户访问黑客站点时，站点上内嵌的指向localhost http server的请求，因为这是相当于本机内部请求，如果软件没写好，请求是会被执行的，具体的攻防涉及到same origin/preflight request/dns rebinding等，
参考zoom案例分析，所以没事不要搞一个可以从普通浏览器就唤醒的http server（用户无察觉），可以搞一个其他协议的server，比如注册一个zoom://，浏览器不会直接执行而是去提醒用户唤醒软件，这样用户就会察觉！</p> <p>4.IOT设备</p> <p>跟前面都不同的是，很多IOT设备运行的操作系统都是极简化的，基本都没有防火墙，意味着可以直接从internet连上去！</p> <p>扩展：
流量加密 vpn</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/docs/assets/js/app.8a2be1ce.js" defer></script><script src="/docs/assets/js/2.dc5756d7.js" defer></script><script src="/docs/assets/js/41.dbe85fea.js" defer></script>
  </body>
</html>
